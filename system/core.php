<?php $_stopwatch=microtime(); define('E2_VERSION',3445); define('E2_RELEASE','2.9a'); define('E2_EDITION',1); define('E2_UA_STRING','E2 (v'. E2_VERSION .'; Aegea)'); define('E2_MINIMUM_PHP','5.4'); define('E2_MINIMUM_MYSQL',4.1); define('BUILDER_OBFUSCATE',1); define('BUILDER_FLATTEN',1); define('E2_NEW_FILES_RIGHTS',0777); define('E2_JSON_STYLE',JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE); define('E2_RUN_ID',chr(rand(65,90))); define('HSC_ENC','UTF-8'); define('SECONDS_IN_A_MINUTE',60); define('SECONDS_IN_AN_HOUR',3600); define('SECONDS_IN_A_DAY',86400); define('SECONDS_IN_A_MONTH',2592000); define('SECONDS_IN_A_YEAR',31536000); if(version_compare(PHP_VERSION,E2_MINIMUM_PHP) < 0){ die ('PHP version must be '. E2_MINIMUM_PHP .' or later, you are running '. PHP_VERSION); } setlocale(LC_CTYPE,'ru_RU.UTF'); mb_internal_encoding('UTF-8'); if(function_exists('date_default_timezone_set')) { date_default_timezone_set('GMT'); } error_reporting(E_ALL); if(is_file('superconfig.php')) { include 'superconfig.php'; } $_protocol=( !empty ($_SERVER['HTTPS']) && $_SERVER['HTTPS']!=='off' or $_SERVER['SERVER_PORT']==443 or isset ($_SERVER['HTTP_X_FORWARDED_PROTO']) && $_SERVER['HTTP_X_FORWARDED_PROTO']=='https' or isset ($_SERVER['HTTP_X_HTTPS']) && ($_SERVER['HTTP_X_HTTPS']) ) ? 'https':'http'; if(is_file('force-https')) { $_protocol='https'; } $da57c1=substr( $_SERVER['PHP_SELF'],0,strpos($_SERVER['PHP_SELF'],'/index.php') ); list ($z57de2, ) = explode(':',$_SERVER['HTTP_HOST']); $full_blog_url=$_protocol. '://'. $z57de2.$da57c1; $_user_folder_name=str_replace('/','--',$z57de2.$da57c1); if(substr($_user_folder_name,0,4)=='www.'){ $_user_folder_name=substr($_user_folder_name,4); } if(is_file('multiuser')) { if (@array_key_exists($_user_folder_name,$_superconfig['rewrites'])) { $_user_folder_name=$_superconfig['rewrites'][$_user_folder_name]; } define('USER_FOLDER','users/'. $_user_folder_name .'/'); } else { define('USER_FOLDER', (string) @$__E2_FOLDER_PREFIX__.'user/'); } if(@$_superconfig['store_files_by_users']) { define('MEDIA_ROOT_FOLDER',USER_FOLDER .'files/'); } else { define('MEDIA_ROOT_FOLDER',''); } define('EXTRAS_FOLDER',USER_FOLDER.'extras/'); define('BACKUP_FOLDER',USER_FOLDER.'backup/'); define('CACHES_FOLDER',USER_FOLDER.'caches/'); define('USER_LIBRARY_FOLDER',USER_FOLDER.'library/'); define('LOG_FOLDER',USER_FOLDER.'logs/'); define('PICTURES_FOLDER','pictures/'); define('THUMBNAILS_FOLDER','pictures/thumbs/'); define('AVATARS_FOLDER','pictures/avatars/'); define('AUDIO_FOLDER','audio/'); define('TEMPLATES_FOLDER','themes/'); define('SYSTEM_FOLDER','system/'); define('SCRIPTS_FOLDER','system/js/'); define('SYSTEM_LIBRARY_FOLDER','system/library/'); define('SYSTEM_TEMPLATE_FOLDER','system/theme/'); define('DEFAULT_USERPIC_FILENAME','system/theme/images/userpic.svg'); define('DEFAULT_USERPIC_PLACEHOLDER_FILENAME','system/theme/images/userpic-placeholder.svg'); define('AUDIO_ICON_IMAGE','system/theme/images/audio.svg'); define('AUDIO_ICON_WIDTH',64); define('AUDIO_ICON_HEIGHT',64); define('LANGUAGES_FOLDER','system/languages/'); define('DEFAULTS_FOLDER','system/default/'); define('MTMPL_FOLDER','system/default/mail/'); define('DEFAULT_TEMPLATE','plain'); @include DEFAULTS_FOLDER. 'config.php'; $_default_config=$_config; @include USER_FOLDER. 'config.php'; $_config=array_merge($_default_config,$_config); define('E2E_STRANGE_ERROR',10); define('E2E_USER_ERROR',20); define('E2E_PERMISSIONS_ERROR',30); define('E2E_DATABASE_ERROR',40); define('E2E_MESSAGE',100); define('E2E_DIAGNOSTICS_MESSAGE',110); define('DEFAULT_ITEMS_PER_PAGE',10); define('MAX_ITEMS_PER_PAGE',100); define('FP_NO_ID_OR_NEW', -1); define('FP_INSERT_ERROR', -10); define('FP_UPDATE_ERROR', -11); define('FP_EMPTY_FIELD', -20); define('FP_TITLE_OR_TEXT_EMPTY', -21); define('FP_NOT_COMMENTABLE', -30); define('FP_COMMENT_DOUBLE_POST', -101); define('FP_COMMENT_TOO_LONG', -102); define('FP_COMMENT_SPAM_SUSPECT', -103); define('NOTE_COMMENTABLE_NOW', -1); define('NOTE_COMMENTABLE_NOW_CONDITIONALLY', -2); define('ENTITY_TYPE_UNSPECIFIED',''); define('ENTITY_TYPE_NOTE','n'); define('ENTITY_TYPE_TAG','t'); define('THUMB_WIDTH',200); define('THUMB_HEIGHT',160); define('THUMB_JPG_QUALITY',90); define('SCALED_IMAGE_JPG_QUALITY',80); define('USERPIC_WIDTH',80); define('USERPIC_HEIGHT',80); define('USERPIC_JPG_QUALITY',95); define('RESOURCES_ALL',0); define('RESOURCES_LOCAL',1); error_reporting(E_ALL); $_fp_error=false; if(strstr(__FILE__,'all.php')) { define('BUILT',0); } else { define('BUILT',1); } function e2_go_to($y56790=''){ global$_protocol,$errors,$z57de2,$da57c1; @session_start(); $_SESSION['errors']=$errors; if(substr($y56790,0,strlen($_protocol)+3)!=$_protocol .'://'){ header('Location: '. $_protocol .'://'. $z57de2.$da57c1 .'/'. $y56790); } else { header('Location: '. $y56790); } flush(); return true; } function x4930(){ $r469bb=$_SERVER['HTTP_REFERER']; return e2_go_to($r469bb); } function y4924($y56790){ if($_SERVER['HTTP_REFERER'])$y56790=$_SERVER['HTTP_REFERER']; return e2_go_to($y56790); } function p8c3b($pb2145=''){ $f9dd4e=substr_count($_SERVER['HTTP_HOST'],'.'); $f2cb9d=@str_repeat('_',$f9dd4e).$pb2145; return $f2cb9d; } function ec64a($pb2145,$b2063c='',$tb0b70=true){ $acd91e=$tb0b70? (time()+3600*24*365) : (0); $iad5f8=$_SERVER['HTTP_HOST']; $he9c6c=substr_count($iad5f8,'.'); if ($he9c6c < 3)$iad5f8=str_repeat('.',3-$he9c6c).$iad5f8; $f9dd4e=setcookie(p8c3b($pb2145),$b2063c,$acd91e,'/'); } function o163d($w183d6,$bb45cf,$scadc8=''){ if(trim($bb45cf)!=''){ $bb45cf=explode($w183d6,$bb45cf); foreach ($bb45cf as $d865c0 => $c8ce4b)$bb45cf[$d865c0]=trim($c8ce4b); foreach ($bb45cf as $d865c0 => $c8ce4b) if ($c8ce4b=='') unset ($bb45cf[$d865c0]); $r7b774=array_unique($bb45cf); if ('sort'==$scadc8)sort($r7b774); return $r7b774; } else return array (); } function ge1e7($ocdaee,$action,$t4a202){ if (!is_array($ocdaee))$ocdaee=array(); if($action=='add'){ $ocdaee=array_unique(array_merge($ocdaee,$t4a202)); } if($action=='remove'){ unset ($ocdaee[array_search($t4a202,$ocdaee)]); } if (!is_array($ocdaee))$ocdaee=array(); return $ocdaee; } function wbb8d($bb45cf){ $b5269f=@$_SERVER['HTTP_USER_AGENT'] or $b5269f=''; $s8f0c7=strstr($b5269f,'iPhone') || strstr($b5269f,'iPad'); $l8bf10=strstr($b5269f,'Macintosh'); if ($s8f0c7) return ''; if ($bb45cf=='submit'){ if ($l8bf10){ return '&#x2303; &#x21a9;'; } else { return 'Ctrl + Enter'; } } if ($bb45cf=='livesave'){ if ($l8bf10){ return '&#x2318; S'; } else { return 'Ctrl + S'; } } if ($bb45cf=='navigation'){ if ($l8bf10){ return '&#x2325;'; } else { return 'Ctrl'; } } if ($bb45cf=='navigation-later'){ if ($l8bf10){ return '&#x2325; &uarr;'; } else { return 'Ctrl + &uarr;'; } } if ($bb45cf=='navigation-earlier'){ if ($l8bf10){ return '&#x2325; &darr;'; } else { return 'Ctrl + &darr;'; } } } function f7b91($j1cb25){ $j1cb25=str_replace('<','&lt;',$j1cb25); $j1cb25=str_replace('>','&gt;',$j1cb25); return $j1cb25; } function zc4b6($j1cb25){ $j1cb25=str_replace('"','&quot;',$j1cb25); return $j1cb25; } function bd056($b2063c,$b5d6db){ return str_replace('.',',',round($b2063c,$b5d6db)); } function e2_stripslashes_array($rf1f71){ return is_array($rf1f71)?array_map('e2_stripslashes_array',$rf1f71):stripslashes($rf1f71); } function dabdd(){ if(get_magic_quotes_runtime()) { set_magic_quotes_runtime(0); } if(get_magic_quotes_gpc()) { $_GET=e2_stripslashes_array($_GET); $_POST=e2_stripslashes_array($_POST); $_COOKIE=e2_stripslashes_array($_COOKIE); $_REQUEST=e2_stripslashes_array($_REQUEST); } } function m0786($c957b5){ return sprintf('%u',ip2long($c957b5)); } function h7c85($wb1bc2){ return long2ip(sprintf('%d',$wb1bc2)); } function e2_decline_for_number($j1cb25,$wb1bc2=null){ $x2f713=$j1cb25; if ($wb1bc2===null){ $wb1bc2=substr($j1cb25,0,strpos($j1cb25,' ')); $x2f713=substr($j1cb25,strpos($j1cb25,' ')+1); } $wf07c9=strpos($x2f713,'('); $k46901=strpos($x2f713,')'); if ($k46901 > $wf07c9)$a22b9f=substr($x2f713,$wf07c9,$k46901-$wf07c9+1); $u93da6=explode(',',trim(@$a22b9f,'()')); if(count($u93da6)==2)array_unshift($u93da6,''); $pc78bd=array (2,0,1,1,1,2,2,2,2,2); if ($wb1bc2%100 > 10 and $wb1bc2%100 < 20)$xcd14c=2; else $xcd14c=$pc78bd[$wb1bc2%10]; $nef3e3=$u93da6[$xcd14c]; $j1cb25=str_replace($a22b9f,$nef3e3,$j1cb25); if(strstr($j1cb25,'(') and strstr($j1cb25,')')) { return e2_decline_for_number($j1cb25,$wb1bc2); } else { return $j1cb25; } } function fc5a6($uf2ce1){ $o87e9e=glob($uf2ce1,GLOB_NOSORT); if(is_array($o87e9e)) { foreach ($o87e9e as $n435ed){ @unlink($n435ed); } } } function r74dc($d73600){ $o87e9e=glob($d73600 .'*',GLOB_NOSORT); if(is_array($o87e9e)) { foreach ($o87e9e as $n435ed){ if(basename($n435ed)!='.' and basename($n435ed)!='..'){ if(is_dir($n435ed)) { if (r74dc($n435ed .'/')) { if (!rmdir($n435ed)) { return false; } } else { return false; } } else { @unlink($n435ed); } } } return true; } else { return false; } } function naf42($wd6fe1){ $wd6fe1=trim($wd6fe1,'/'); $wd6fe1=explode('/',$wd6fe1); $d73600=''; foreach ($wd6fe1 as $s83878){ $d73600=$d73600.$s83878; if (!is_dir($d73600)) { if (@mkdir($d73600)) { @chmod($d73600,E2_NEW_FILES_RIGHTS); } else { return false; } } $d73600=$d73600.'/'; } return true; } function p4d36($wd6fe1){ return preg_replace('/\/([^\/]+?)\/\.\./','',$wd6fe1); } function uce9b($bb45cf){ $icee6f=get_html_translation_table(HTML_ENTITIES); $icee6f=array_flip($icee6f); return strtr($bb45cf,$icee6f); } function f7f78($k32c11=NULL){ if(NULL==$k32c11)$k32c11=microtime(); list ($h6021b,$g74459)=explode(' ',$k32c11); return ((float)$h6021b + (float)$g74459); } function m74e0(){ global$settings; if (!isset ($settings))$settings=array(); $cfa816=array(); if(is_file(USER_FOLDER.'settings.json')) { $cfa816=json_decode(file_get_contents(USER_FOLDER.'settings.json'),true); $h098f6=13; } elseif(is_file(USER_FOLDER.'settings.psa')) { $cfa816=unserialize(file_get_contents(USER_FOLDER.'settings.psa')); } if (!is_array($cfa816))$cfa816=array(); $settings=array_merge($settings,$cfa816); if ( !is_numeric(@$settings['appearance']['notes_per_page']) or @$settings['appearance']['notes_per_page'] < 1 ){ $settings['appearance']['notes_per_page']=DEFAULT_ITEMS_PER_PAGE; } if ( @$settings['appearance']['notes_per_page'] > MAX_ITEMS_PER_PAGE ){ $settings['appearance']['notes_per_page']=MAX_ITEMS_PER_PAGE; } if ( !array_key_exists('comments',$settings) or !array_key_exists('default_on', @$settings['comments']) ) { $settings['comments']['default_on']=false; } return true; } function e2m_settings(){ global$settings,$_template,$_strings; $af3e33=array(); $g5e107=@$settings['language']? $settings['language']:DEFAULT_LANGUAGE; foreach(glob(LANGUAGES_FOLDER. '*.php') as $n435ed){ $g5b54c=substr(basename($n435ed),0,2); $h98bf7=file_get_contents($n435ed); if(preg_match( '/^ *\/\/ *display_name *\= *(.*?) *$/ismu',$h98bf7,$o9c28d )) { $mc2657=$o9c28d[1]; } else { $mc2657=$g5b54c; } $af3e33[$g5b54c] = array ( 'selected?' => (bool) ($g5e107==$g5b54c), 'display-name' => $mc2657, ); } $f2cb9d['title']=$_strings['pt--settings']; $f2cb9d['heading']=$_strings['pt--settings']; $f2cb9d['form']='form-preferences'; $f2cb9d['form-preferences'] = array ( 'blog-title-default' => htmlspecialchars($_strings['e2--default-blog-title'],ENT_COMPAT,HSC_ENC), 'blog-title' => htmlspecialchars(o6f51(),ENT_COMPAT,HSC_ENC), 'blog-description' => htmlspecialchars(@$settings['description'],ENT_COMPAT,HSC_ENC), 'blog-author-default' => htmlspecialchars($_strings['e2--default-blog-author'],ENT_COMPAT,HSC_ENC), 'blog-author' => htmlspecialchars(@$settings['author'],ENT_COMPAT,HSC_ENC), 'languages' => $af3e33, 'language' => $g5e107, 'form-action' => i83c8('e2s_settings_save'), 'notes-per-page' => $settings['appearance']['notes_per_page'], 'email-notify?' => (bool) @$settings['notifications']['new_comments'], 'email' => htmlspecialchars(@$settings['user']['email'],ENT_NOQUOTES,HSC_ENC), 'comments-default-on?' => (bool) @$settings['comments']['default_on'], 'comments-require-gip?' => (bool) @$settings['comments']['require_gip'], 'comments-fresh-only?' => (bool) @$settings['comments']['fresh_only'], 'show-sharing-buttons?' => (bool)$settings['appearance']['show_sharing_buttons'], 'includes-google-analytics?' => false, 'includes-yandex-metrika?' => false, 'template-name' => $_template['name'], 'templates' => q94dd(), 'submit-text' => $_strings['fb--save-changes'], 'space-usage' => vaf64(cd10e(),true), ); if(E2_EDITION){ $f2cb9d['form-preferences']['includes-google-analytics?']=true; $f2cb9d['form-preferences']['google-analytics'] = ( htmlspecialchars( @$settings['embed']['google-analytics'],ENT_COMPAT,HSC_ENC ) ); $f2cb9d['form-preferences']['includes-yandex-metrika?']=true; $f2cb9d['form-preferences']['yandex-metrika'] = ( htmlspecialchars( @$settings['embed']['yandex-metrika'],ENT_COMPAT,HSC_ENC ) ); } return $f2cb9d; } function e2s_settings_save(){ global$settings,$_strings; if($_SERVER['REQUEST_METHOD']!='POST') return e2_go_to(i83c8('e2m_settings')); $v05df2=$r67daf=''; if(array_key_exists('blog-title',$_POST)) { $v05df2=trim($_POST['blog-title']); } if(array_key_exists('blog-description',$_POST)) { $r67daf=trim($_POST['blog-description']); } if(array_key_exists('blog-author',$_POST)) { $v02bd9=trim($_POST['blog-author']); } if(array_key_exists('language',$_POST)) $z8512a=$_POST['language']; if(array_key_exists('email',$_POST)) $a0c83f=trim($_POST['email']); $e0c2bd=(int)$_POST['notes-per-page']; $settings['site_title']=$v05df2; $settings['site_title']=o6f51(); $settings['description']=$r67daf; $settings['author']=$v02bd9; $settings['user']['email']=$a0c83f; $settings['notifications']['new_comments'] = isset ($_POST['email-notify']); if(array_key_exists('template',$_POST)) { $settings['template']=trim($_POST['template']); } $settings['comments']['default_on'] = isset ($_POST['comments-default-on']); $settings['comments']['require_gip'] = isset ($_POST['comments-require-gip']); if ( $settings['language']!=$z8512a or $settings['appearance']['notes_per_page']!=$e0c2bd or $settings['appearance']['show_sharing_buttons'] != isset ($_POST['show-sharing-buttons']) or $settings['comments']['fresh_only'] != isset ($_POST['comments-fresh-only']) ) { @unlink(CACHE_FILENAME_FRONTPAGE); @unlink(CACHE_FILENAME_FRONTPAGE_AUTHOR); $settings['language']=$z8512a; $settings['appearance']['notes_per_page']=$e0c2bd; $settings['appearance']['show_sharing_buttons'] = isset ($_POST['show-sharing-buttons']); $settings['comments']['fresh_only'] = isset ($_POST['comments-fresh-only']); } if(E2_EDITION){ if(array_key_exists('google-analytics',$_POST)) { $settings['embed']['google-analytics']=trim($_POST['google-analytics']); } if(array_key_exists('yandex-metrika',$_POST)) { $settings['embed']['yandex-metrika']=trim($_POST['yandex-metrika']); } } fc5a6(CACHE_FILENAMES_NOTES_COMMENTS); if (!@s6e52(USER_FOLDER.'settings.json',json_encode($settings,E2_JSON_STYLE))) { o8a40($_strings['er--settings-not-saved'],E2E_PERMISSIONS_ERROR); e2_go_to(i83c8('e2m_settings')); die; } e2_go_to(i83c8('e2m_frontpage', array ('page' => 1))); die; } function e2m_database(){ global$settings,$_strings,$_superconfig; if (@$_superconfig['disallow_db_config']) { return e2_error404_mode(); } $f2cb9d['title']=$_strings['pt--database']; $f2cb9d['heading']=$_strings['pt--database']; $f2cb9d['form']='form-database'; $f2cb9d['form-database'] = array ( 'form-action' => i83c8('e2s_database_save'), 'db-server' => htmlspecialchars(@$settings['db']['server']? $settings['db']['server']:'localhost'), 'db-user' => htmlspecialchars(@$settings['db']['user_name']? $settings['db']['user_name']:'root'), 'db-password' => htmlspecialchars(aee85(@$settings['db']['passw'])), 'db-database' => htmlspecialchars(@$settings['db']['name']), 'submit-text' => $_strings['fb--connect-to-this-db'], ); return $f2cb9d; } function e2s_database_save(){ global$settings,$_db,$_superconfig,$_strings,$_config; if($_SERVER['REQUEST_METHOD']!='POST') return e2_go_to(i83c8('e2m_database')); if (@$_superconfig['disallow_db_config']) { return e2_error404_mode(); } $x0ba44=z55fd(); if ($x0ba44=='bingo-data-exists'){ $settings['db']['server'] = @$_POST['db-server']; $settings['db']['user_name'] = @$_POST['db-user']; $settings['db']['passw']=g1305(@$_POST['db-password']); $settings['db']['name'] = @$_POST['db-database']; if (!@s6e52(USER_FOLDER.'settings.json',json_encode($settings,E2_JSON_STYLE))) { o8a40($_strings['er--settings-not-saved'],E2E_PERMISSIONS_ERROR); e2_go_to(i83c8('e2m_database')); die; } e2_drop_all_kinds_of_cache(); pbb8d(); if (!$_config['retain_search_indexes_on_db_switch']) { $hddece=b476c(); try { $hddece -> erase(); } catch (\S2\Rose\Exception\RuntimeException $e){ if(Log::$ned2b5)__log('Rose not available'); } s198f(); } rcc38(i83c8('e2s_bsi_step')); e2_go_to(i83c8('e2m_settings')); } else { o8a40($_strings['er--double-check-db-params']); e2_go_to(i83c8('e2m_database')); } die; } function sda67(){ return class_exists('ZipArchive'); } function e2m_get_backup(){ if (sda67()) { $jfbade=new ZipArchive(); $o979eb=BACKUP_FOLDER .'backup.zip'; if ($jfbade -> open($o979eb,ZIPARCHIVE::CREATE)) { @ $jfbade -> addEmptyDir('backup'); @ $jfbade -> addEmptyDir('backup/db'); @ $jfbade -> addFile(USER_FOLDER.'userpic@2x.jpg','backup/files/userpic@2x.jpg'); @ $jfbade -> addFile(USER_FOLDER.'userpic@2x.png','backup/files/userpic@2x.png'); foreach(glob(BACKUP_FOLDER .'backup-*.sql') as $m8c7dd); $jfbade -> addFile($m8c7dd,'backup/db/'. basename($m8c7dd)); $jfbade -> close(); } if(is_file($o979eb)) { header('Content-Type: application/zip'); header('Content-Disposition: attachment; filename="backup.zip"'); readfile($o979eb); unlink($o979eb); } else { die ('Cannot get backup'); } die; } else { die ('Cannot get backup'); } } if(substr(@$_SERVER['HTTP_ACCEPT_LANGUAGE'],0,2)=='ru'){ define('DEFAULT_LANGUAGE','ru'); } else { define('DEFAULT_LANGUAGE','en'); } function e2l_get_string($gfa206,$o8d777){ global$_strings; $eb0689=$_strings[$gfa206]; if(preg_match_all('/\$\[(.+?)\]/u',$eb0689,$o9c28d,PREG_SET_ORDER)) { foreach ($o9c28d as $ve3cc9){ $pb2145=$ve3cc9[1]; $bf2ffc=''; if(strstr($pb2145,'.')) list ($pb2145,$bf2ffc)=explode('.',$pb2145,2); if(array_key_exists($pb2145,$o8d777)) { if ($bf2ffc){ $eb0689=str_replace($ve3cc9[0],e2l__format_value($bf2ffc,$o8d777[$pb2145],$gfa206),$eb0689); } else { $eb0689=str_replace($ve3cc9[0],$o8d777[$pb2145],$eb0689); } } } } return $eb0689; } function e2l_transliterate($bb45cf){ $ae358e=array(); if(is_file(DEFAULTS_FOLDER.'translit.txt')) { $ae358e=file(DEFAULTS_FOLDER.'translit.txt'); } $md98a0=$e01b6e=''; foreach ($ae358e as $d865c0 => $j6438c){ if (!($d865c0%2))$md98a0.=rtrim($j6438c) .' '; else $e01b6e.=rtrim($j6438c) .' '; if ($d865c0%2){ while (mb_strlen($e01b6e) < mb_strlen($md98a0))$e01b6e.=' '; while (mb_strlen($e01b6e) > mb_strlen($md98a0))$md98a0.=' '; } } $s60ae1=''; $lde2e7=-1; for ($d865c0=0; $d865c0 < mb_strlen($md98a0); ++ $d865c0){ $a4a8a0=mb_substr($md98a0,$d865c0,1); if ($a4a8a0!=' '){ $s60ae1.=$a4a8a0; if ($lde2e7 == -1)$lde2e7=$d865c0; } elseif ($s60ae1){ $m52ac1=trim(mb_substr($e01b6e,$lde2e7,mb_strpos($e01b6e,' ',$lde2e7+1)-$lde2e7)); $a33c9b=array ($s60ae1,$m52ac1); $wce83f[mb_strlen($s60ae1)][] = $a33c9b; $s60ae1=''; $lde2e7=-1; } } $s1d78d=array(); for ($d865c0=count($wce83f); $d865c0 > 0; -- $d865c0){ foreach ($wce83f[$d865c0] as $a33c9b)$s1d78d[$a33c9b[0]] = $a33c9b[1]; } return strtr($bb45cf,$s1d78d); } function e2l__format_value($bf2ffc,$b2063c,$gfa206){ list ($bf2ffc,$x3ad73)=explode('.',$bf2ffc,2); $te6875='e2lstr_'. $bf2ffc; if(function_exists($te6875)) { return call_user_func($te6875,$b2063c,$x3ad73,$gfa206); } else { return $b2063c; } return $b2063c; } function lfc91(){ global$_lang,$settings; if(is_file($v2d354=LANGUAGES_FOLDER.$settings['language'] .'.php')) { $_lang=$settings['language']; include $v2d354; } elseif(is_file($v2d354=LANGUAGES_FOLDER.DEFAULT_LANGUAGE .'.php')) { $_lang=DEFAULT_LANGUAGE; include $v2d354; } else { die ('Language file missing: '. $v2d354); } return e2l_load_strings(); } define('LOG_FILE',LOG_FOLDER.'main.log'); define('LOG_DEBUG_FILE',LOG_FOLDER.'debug.log'); class Log { public static $ned2b5=false; public static $p34a72=false; } function d372b(){ global$_config; if ( $_config['write_log'] and ($_config['write_log_create'] or is_file(LOG_FILE)) ) { Log::$ned2b5=true; Log::$p34a72=true; } else { Log::$ned2b5=false; Log::$p34a72=false; } if (!Log::$ned2b5) return; @naf42(LOG_FOLDER); if($_config['write_log_reset']) { @file_put_contents(LOG_FILE,''); @chmod(LOG_FILE,E2_NEW_FILES_RIGHTS); } if (@$_config['write_log_limit'] and is_file(LOG_FILE)) { $xbc7b3=@stat(LOG_FILE); $xbc7b3=$xbc7b3['size']; if ($xbc7b3 > $_config['write_log_limit']) { @rename(LOG_FILE,LOG_FILE .'.bak'); @chmod(LOG_FILE .'.bak',E2_NEW_FILES_RIGHTS); @file_put_contents(LOG_FILE,''); } } __log('────────────────────────────────────────────────────────────────────────────────'); } function l714a($n22af6=false) { static $p197b1=false; if ($n22af6===false) return $p197b1; if ($n22af6==='') return $p197b1=false; $n435ed=str_replace( '$',gmdate('Y-m-d-\a\t-H-i-s'),$n22af6 ); return $p197b1= $n435ed; } function __log($j1cb25){ static $c12a05; global$_stopwatch; $jd8367=l714a(); $l605ac=''; $yaf240=str_pad(round(f7f78()-$_stopwatch,5),10,' ',STR_PAD_RIGHT); if ($j1cb25[0]=='}'){ -- $c12a05; if ($c12a05 < 0)$c12a05=0; } $m8e13f=( E2_RUN_ID .' '. $l605ac .''. $yaf240 .' '. str_repeat(' ',$c12a05*2). $j1cb25."\n" ); if ($j1cb25[strlen($j1cb25)-1]=='{'){ ++ $c12a05; } $t15d61=FILE_APPEND; if(Log::$p34a72){ @file_put_contents(LOG_FILE,$m8e13f,$t15d61); @chmod(LOG_FILE,E2_NEW_FILES_RIGHTS); } if ($jd8367!==false){ $n435ed=LOG_FOLDER.$jd8367 .'.log'; @file_put_contents($n435ed,$m8e13f,$t15d61); @chmod($jd8367,E2_NEW_FILES_RIGHTS); } if ($j1cb25[0]=='#'){ @naf42(dirname(LOG_DEBUG_FILE). '/'); @file_put_contents(LOG_DEBUG_FILE,$m8e13f,$t15d61); @chmod(LOG_DEBUG_FILE,E2_NEW_FILES_RIGHTS); } } function zce80($s6bf76){ file_put_contents( USER_FOLDER .'ctree.php', "<?php\r\n\r\n". var_export($s6bf76,true). "\r\n\r\n?>php" ); } function o8a40($r67daf,$type=E2E_STRANGE_ERROR){ global$errors,$settings, $_config, $_strings, $_diagnose; if (!isset ($errors))$errors=[]; $w1897a=(!ge852()+1 <= (int)$_config['show_call_stack']); if ($r67daf){ if ($r67daf[0]!='<')$r67daf='<p>'.$r67daf .'</p>'; $xcd1dd=array ( 'description' => $r67daf, 'type' => $type, ); if ( $type==E2E_STRANGE_ERROR and $w1897a and function_exists('debug_backtrace') ) { $xcd1dd['backtrace']=debug_backtrace(); } $errors[] = $xcd1dd; } if($type==E2E_PERMISSIONS_ERROR){ $_diagnose['need?']=true; ec64a('diagnose','1'); } return true; } function i8739(){ global$errors,$a1c0b7,$_strings,$_diagnose; $g7287a=pea70(); if(count($g7287a)==0){ ec64a('diagnose',''); unset($_COOKIE['diagnose']); $_diagnose['need?']=false; $_diagnose['ok?']=true; return true; } else { $d6e2ba=''; $d6e2ba.='<p>'. $_strings['gs--enable-write-permissions-for-the-following'] .'</p>'; $d6e2ba.='<ul>'; foreach ($g7287a as $c8fa14){ if ($c8fa14=='.')$c8fa14=''; $d6e2ba.='<li><tt>.../'. $c8fa14 .'</tt></li>'; if(Log::$ned2b5)__log('Diagnostics: cannot write <'. $c8fa14 .'>'); } $d6e2ba.='</ul>'; $xcd1dd=array ( 'title' => $_strings['et--fix-permissions-on-server'], 'description' => $d6e2ba, 'type' => E2E_DIAGNOSTICS_MESSAGE, 'class' => 'serious', ); $errors[] = $xcd1dd; $_diagnose['ok?']=false; return false; } } function ge1c4($wc1336,$r67daf,$f1407f,$kc2d4b,$g4f62c){ global$errors; if(0==error_reporting() or ($wc1336 & 8)) return; $f1407f=str_replace(__DIR__,'',$f1407f); o8a40($f1407f .', line '. $kc2d4b .'<br />Error '. $wc1336 .': '. $r67daf); $errors[count($errors)-1]['phpcode']=$wc1336; } function z0955(){ global$errors,$settings,$_config; if (!isset ($errors))$errors=[]; @session_start(); if(is_array(@$_SESSION['errors'])) { $ae1671=array_merge(@$_SESSION['errors'],$errors); } else { $ae1671=$errors; } $w1897a=(!ge852()+1 <= (int)$_config['show_call_stack']); if (@$_config['store_backtrace'] and $w1897a and $ae1671!=NULL){ @s6e52('backtrace.psa',serialize($ae1671)); } else { @unlink('backtrace.psa'); } if (isset ($_SESSION['errors'])) unset($_SESSION['errors']); $f2cb9d=array(); $bb8735=false; if(count($ae1671) > 0){ foreach ($ae1671 as $d865c0 => $g08a44){ if ($g08a44['type']==E2E_STRANGE_ERROR){ $g08a44['class']='serious'; $bb8735=true; if ($w1897a){ $g08a44['backtrace']=q2616($g08a44['backtrace']); } } if ($g08a44['type']==E2E_MESSAGE){ $g08a44['class']='info'; } $ae1671[$d865c0]=$g08a44; } $f2cb9d['each']=$ae1671; if ( $bb8735 and @$_config['store_backtrace'] and $w1897a and is_file('debug.php') ) { $f2cb9d['debug-link']='debug.php'; } } return $f2cb9d; } function b4006(){ $errors=z0955(); foreach($errors['each'] as $lcb5e1){ echo '<p>'. $lcb5e1['description'] .'</p>'; } die; } function q2616($q69206){ global $da57c1; if (!is_array($q69206)) return 'No backtrace info'; $q69206=array_reverse($q69206); $q69206=array_splice($q69206,0,count($q69206)-1); $ae1671='<p style="background: #fea; padding: .25em .5em; line-height: 1em; overflow: hidden">'; foreach ($q69206 as $d865c0 => $ae358e){ $e195df=@$ae358e['args'] or $e195df=array(); $na956a=array(); foreach ($e195df as $q5919c){ $na956a[] = var_export($q5919c,true); } $m8c7dd=@$ae358e['file']; $m8c7dd=str_replace($_SERVER['DOCUMENT_ROOT'],'',$m8c7dd); $j6438c=(@$ae358e['line']? (' #'. $ae358e['line']) : '?'); $ae1671.='<div style="margin: .25em 0 .5em '. $d865c0*3 .'em">'; $ae1671.='<span style="float: right; color: #666"> '. $m8c7dd.$j6438c .'</span>'; $ae1671.='<tt><b>'. @$ae358e['function'] .' (</b>'; if(count($na956a)) { $ueb84a=str_replace("array (\n)",'array ()',$na956a); $ueb84a=implode(', ',$ueb84a); if(0){ $ueb84a=highlight_string('<?'. $ueb84a .'?'.'>',true); $ueb84a=substr($ueb84a,77, -28); } $ueb84a=str_replace('&nbsp;',' ',$ueb84a); $ueb84a=nl2br($ueb84a); $ae1671.='<div style="margin: 0 0 0 1.12em">'. $ueb84a .'</div>'; } $ae1671.='<b>)</b> &rarr;</tt></div>'; } $ae1671.='</p>'; return $ae1671; } class AeException extends \Exception {} class AeMySQLException extends AeException {} class AeMySQLNotFoundException extends AeMySQLException {} class AeMySQLTooOldException extends AeMySQLException {} class AeMySQLCannotConnectException extends AeMySQLException {} class AeMySQLConnectTimeoutException extends AeMySQLCannotConnectException {} class AeMySQLAccessDeniedException extends AeMySQLCannotConnectException {} class AeMySQLQueryException extends AeMySQLException {} class AeMySQLCorruptedUpdateRecordCallException extends AeMySQLException {} class AeModelUnknownTableException extends AeException {} class AeOlbaException extends AeException {} class AeOlbaTemplateMissingException extends AeOlbaException {} function yd0c8($r42552,$v44fb5=false){ $n5ee24=substr(__DIR__,0,strrpos(__DIR__,'/')); $d04a75=[]; foreach(array_reverse($r42552 -> getTrace()) as $v447b7){ $zb25b3['where']=str_replace( $n5ee24 .'/','',$v447b7['file'] ) .':'. $v447b7['line']; $e97346=[]; foreach ($v447b7['args'] as $q61dd8){ $e97346[] = htmlspecialchars( str_replace("\n","\n  ",var_export($q61dd8,true)), ENT_NOQUOTES,HSC_ENC ); } $d5eaa0=''; if(count($e97346)) { $d5eaa0=("\n". '  '. implode($e97346,",\n  "). "\n" ); } $zb25b3['call']=$v447b7['function'] .' ('. $d5eaa0 .')'; $d04a75[] = $zb25b3; } if ((string)$r42552 -> getMessage()!==''){ $b70261.='Could not '. $r42552 -> getMessage() ."\n"; } $b70261.="\n";; $b70261 .= ( get_class($r42552) .' in '. str_replace( $n5ee24 .'/','',$r42552 -> getFile() ) .':'. $r42552 -> getLine(). "\n" ); if ($r42552 -> getCode()) { $b70261.='Code: '. $r42552 -> getCode() ."\n"; } $f98594=''; $d865c0=1; foreach ($d04a75 as $j6438c){ $f98594.=$d865c0++ .'. '. $j6438c['where'] .' '. $j6438c['call']. "\n"; if (!$v44fb5)$f98594.="\n";; } $b70261.="\n";; if ($v44fb5){ $f98594=preg_replace('/^.*?$/smu','│            $0',$f98594); $b70261.='┌─'. "\n"; $b70261.=$f98594; $b70261.='└─'; } else { $b70261.=$f98594; } return $b70261; } function c12f6($r42552,$z78e73=''){ global$_config; if(__DEV)o8a40('<pre>'. yd0c8($r42552) .'</pre>'); if($_config['log_errors']) { Log::$ned2b5=true; if(Log::$ned2b5)l714a('error-$'); } if(Log::$ned2b5)__log('Exception caught: '. yd0c8($r42552,true)); if(Log::$ned2b5)l714a(''); if ((string)$z78e73!==''){ if(Log::$ned2b5)__log($z78e73); } } function b4aff($r42552){ global$_config,$content,$da57c1; $content['title']=':-('; if(__DEV)$content['exception-string']=yd0c8($r42552); if($_config['log_errors']) { Log::$ned2b5=true; if(Log::$ned2b5)l714a('error-$'); } if(Log::$ned2b5)__log('Panic: '. yd0c8($r42552,true)); $f2cb9d=n166b('panic',true); if(Log::$ned2b5)__log(':-('); echo $f2cb9d; die; } function oaefe($r42552){ b4aff($r42552); } $_url_map=array ( '@build' => 'e2://e2s_build', '@sync' => 'e2://e2s_sync', '@dump' => 'e2://e2s_dump', '@bsi' => 'e2://e2s_bsi_status', '@bsi/drop' => 'e2://e2s_bsi_drop', '@bsi/step' => 'e2://e2s_bsi_step', '@migrate' => 'e2://e2s_migrate', '@retrieve:url' => 'e2://e2s_retrieve', '@instantiate:version' => 'e2://e2s_instantiate', '@notify' => 'e2://e2s_notify', '@info' => 'e2://e2m_info', '@ajax/::' => 'e2://e2j_::', '@actions/::' => 'e2://e2s_::', '' => 'e2://e2m_frontpage?page=1', ':page' => 'e2://e2m_frontpage', 'rss' => 'e2://e2m_rss', 'json' => 'e2://e2m_json', 'sitemap.xml' => 'e2://e2m_sitemap_xml', ':year' => 'e2://e2m_year', ':year/:month' => 'e2://e2m_month', ':year/:month/:day' => 'e2://e2m_day', 'all' => 'e2://e2m_everything', ':note' => 'e2://e2m_note', ':note/edit' => 'e2://e2m_note_edit?is_published=1', ':note/favourite' => 'e2://e2m_note_flag_favourite?is_published=1&value=1', ':note/unfavourite' => 'e2://e2m_note_flag_favourite?is_published=1&value=0', ':note/show' => 'e2://e2m_note_flag?is_published=1&flag=IsVisible&value=1', ':note/hide' => 'e2://e2m_note_flag?is_published=1&flag=IsVisible&value=0', ':note/discuss' => 'e2://e2m_note_flag?is_published=1&flag=IsCommentable&value=1', ':note/quiet' => 'e2://e2m_note_flag?is_published=1&flag=IsCommentable&value=0', ':note/withdraw' => 'e2://e2m_note_withdraw?is_published=1', ':note/json' => 'e2://e2m_note_json', ':note/broadcast' => 'e2://e2m_note_broadcast', ':note/read' => 'e2://e2m_note_read', ':note/delete' => 'e2://e2m_note_delete?is_published=1', ':note/format/:formatter' => 'e2://e2m_note_use_formatter?is_published=1', ':note/:unsubscr' => 'e2://e2m_unsubscribe?is_published=1', ':note/:comnum' => 'e2://e2m_comment', ':note/:comnum/edit' => 'e2://e2m_comment_edit', ':note/:comnum/important' => 'e2://e2m_comment_flag_ajax?flag=IsFavourite&value=1', ':note/:comnum/usual' => 'e2://e2m_comment_flag_ajax?flag=IsFavourite&value=0', ':note/:comnum/replace' => 'e2://e2m_comment_flag_ajax?flag=IsVisible&value=1', ':note/:comnum/remove' => 'e2://e2m_comment_flag_ajax?flag=IsVisible&value=0', ':note/:comnum/spam' => 'e2://e2m_comment_flag?flag=IsSpamSuspect&value=1', ':note/:comnum/good' => 'e2://e2m_comment_flag?flag=IsSpamSuspect&value=0', ':note/:comnum/wipe' => 'e2://e2m_comment_delete', ':note/:comnum/reply/edit' => 'e2://e2m_comment_reply', ':note/:comnum/reply/important' => 'e2://e2m_comment_flag_ajax?flag=IsReplyFavourite&value=1', ':note/:comnum/reply/usual' => 'e2://e2m_comment_flag_ajax?flag=IsReplyFavourite&value=0', ':note/:comnum/reply/replace' => 'e2://e2m_comment_flag_ajax?flag=IsReplyVisible&value=1', ':note/:comnum/reply/remove' => 'e2://e2m_comment_flag_ajax?flag=IsReplyVisible&value=0', ':note/:comnum/reply/delete' => 'e2://e2m_comment_reply_delete', 'drafts' => 'e2://e2m_drafts', 'drafts/:draft' => 'e2://e2m_draft', 'drafts/:draft/edit' => 'e2://e2m_note_edit?is_published=0', 'drafts/:draft/show' => 'e2://e2m_note_flag?is_published=0&flag=IsVisible&value=1', 'drafts/:draft/hide' => 'e2://e2m_note_flag?is_published=0&flag=IsVisible&value=0', 'drafts/:draft/delete' => 'e2://e2m_note_delete?is_published=0', 'drafts/:draft/format/:formatter' => 'e2://e2m_note_use_formatter?is_published=0', 'drafts/:draft/:preview' => 'e2://e2m_draft_preview', 'sources' => 'e2://e2m_sources', 'sources/:source/trust' => 'e2://e2m_source_trust', 'sources/:source/premoderate' => 'e2://e2m_source_premoderate', 'sources/:source/ban' => 'e2://e2m_source_ban', 'sources/:source/forget' => 'e2://e2m_source_forget', 'tags' => 'e2://e2m_tags', 'tags/:tag' => 'e2://e2m_tag?page=1', 'tags/:tag/:page' => 'e2://e2m_tag', 'tags/:tag/rss' => 'e2://e2m_tag_rss', 'tags/:tag/json' => 'e2://e2m_tag_json', 'tags/:tag/edit' => 'e2://e2m_tag_edit', 'tags/:tag/delete' => 'e2://e2m_tag_delete', 'tags/:tag/pin' => 'e2://e2m_tag_flag_ajax?flag=IsFavourite&value=1', 'tags/:tag/unpin' => 'e2://e2m_tag_flag_ajax?flag=IsFavourite&value=0', 'untagged' => 'e2://e2m_untagged', 'hot' => 'e2://e2m_most_commented', 'selected' => 'e2://e2m_favourites?page=1', 'selected/:page' => 'e2://e2m_favourites', 'found' => 'e2://e2m_found&query=', 'found/:query' => 'e2://e2m_found', 'new' => 'e2://e2m_write', 'install' => 'e2://e2m_install', 'settings' => 'e2://e2m_settings', 'settings/name' => 'e2://e2m_name_and_author', 'settings/database' => 'e2://e2m_database', 'settings/password' => 'e2://e2m_password?recovery-key=', 'settings/password-reset' => 'e2://e2m_password_reset', 'settings/password/:reset' => 'e2://e2m_password', 'settings/timezone' => 'e2://e2m_timezone', 'settings/sessions' => 'e2://e2m_sessions', 'settings/theme-preview' => 'e2://e2m_theme_preview?theme=', 'settings/theme-preview/:theme' => 'e2://e2m_theme_preview', 'settings/get-backup' => 'e2://e2m_get_backup', 'sign-in' => 'e2://e2m_sign_in', 'sign-out' => 'e2://e2m_sign_out', 'sign-in/:provider' => 'e2://e2m_gip_sign_in', 'sign-out/:provider' => 'e2://e2m_gip_sign_out', 'sign-in-done/:provider' => 'e2://e2m_gip_sign_in_callback', ); $_url_chunks=array ( '\:page' => 'page\-(?P<page>\d+)', '\:year' => '(?P<year>\d{4})', '\:month' => '(?P<month>\d{1,2})', '\:day' => '(?P<day>\d{1,2})', '\:note' => array ( 'all\/(?P<alias>[-a-zA-Z0-9]+)', '(?P<year>\d{4})\/(?P<month>\d{1,2})\/(?P<day>\d{1,2})\/(?P<day_number>\d+)', ), '\:draft' => array ( '(?P<oalias2>[-a-zA-Z0-9]+)\/(?P<draft2>\d+)', '(?P<oalias>[-a-zA-Z0-9]+)', '-\/(?P<draft>\d+)', ), '\:comnum' => 'comment\-(?P<comment_number>[0-9]+)', '\:file' => '(?P<file>.*?)', '\:tag' => '(?P<tag_alias>[-a-zA-Z0-9]+)', '\:query' => '(?P<query>.*?)', '\:provider' => '(?P<provider>.*?)', '\:version' => '\:(?P<version>\d+)', '\:source' => '\:(?P<source>.*?)', '\:picture' => '\:(?P<picture>.*?)', '\:unsubscr' => 'unsubscribe\:(?P<unsubscribe_email>.+?)\:(?P<unsubscribe_key>[0-9a-f]{32})', '\:reset' => 'reset\:(?P<recovery_key>[0-9a-f]{40})', '\:formatter' => '(?P<formatter>.*?)', '\:alias' => '(?P<newalias>[-a-zA-Z0-9]+)', '\:preview' => 'preview\:(?P<preview_key>[0-9a-f]{32})', '\:theme' => '(?P<theme>[-a-zA-Z0-9]+)', '\:source' => '(?P<source>\d+)', '\:url' => '\:(?P<url>[a-zA-Z0-9]+\=)', ); $_url_autoredirects=array ( '/^favo(?:u?)rites(\~.+)?$/i' => 'selected\\1', '/^favo(?:u?)rites\/(.+)/i' => 'selected/\\1', '/^keywords$/i' => 'tags', '/^keywords\/(.*)/i' => 'tags/\\1', '/^everything$/i' => 'all', '/^search\/(.+)/i' => 'found/\\1', '/^(\d{4}\/\d{1,2}\/\d{1,2}\/\d+)\/comments(\/?)$/i' => '\\1', '/^\~(\d+)/i' => 'page-\\1', '/\/?\~(\d+)/i' => '/page-\\1', ); function ub6b0($x572d4){ global$_url_autoredirects,$da57c1; $x572d4=preg_replace(array_keys($_url_autoredirects),array_values($_url_autoredirects),$x572d4); if(preg_match('/^([0-9]+)[.-]([0-9]+)[.-]([0-9]+)(.*)/',$x572d4,$o9c28d)) { if(2==strlen($o9c28d[3]))$o9c28d[3]='20'.$o9c28d[3]; return ($o9c28d[3].'/'.$o9c28d[2].'/'.$o9c28d[1].$o9c28d[4]); } if(preg_match('/^tags\-rss\/(.*?)\/?$/',$x572d4,$o9c28d)) { $xe4d23=substr($o9c28d[1],strrpos($o9c28d[1],'/')+1); return ('tags/'. $xe4d23.'/rss/'); } return $x572d4; } function l7059(){ static $p6b2de=false; global$__synthetic_urls,$_config,$_superconfig; if ($p6b2de) return; $__synthetic_urls=false; if($_config['url_composition']=='auto'){ if(function_exists('apache_get_modules')) { if(in_array('mod_rewrite',apache_get_modules())) { $__synthetic_urls=true; } } } if($_config['url_composition']=='synthetic'){ $__synthetic_urls=true; } if (@$_superconfig['url_composition']=='synthetic'){ $__synthetic_urls=true; } if (@$_superconfig['url_composition']=='real'){ $__synthetic_urls=false; } $p6b2de=true; } function i83c8($fc48ba,$parameters=array ()) { global$_url_map,$_url_chunks,$_config,$__synthetic_urls,$_protocol,$z57de2,$da57c1; $cc2bd7=array_flip($_url_map); if ( @$_config['preferred_domain_name'] and $_SERVER['HTTP_HOST']!=$_config['preferred_domain_name'] ) { $z57de2=$_config['preferred_domain_name']; } $x572d4=$_protocol .'://'. $z57de2.$da57c1 .'/'; $t9c464='e2://'. $fc48ba; if(array_key_exists('page',$parameters)) { $l71860=$parameters['page']; } else { $l71860=1; } if($parameters){ $t9c464.='?'; $y1c61f=array(); $i21711=array(); foreach($parameters as $v3c6e0 => $b2063c){ if ($v3c6e0=='*note'){ $i21711[] = $v3c6e0; $y1c61f[] = e2urls__expand_tricky_parameters_for_note_($b2063c); } if ($v3c6e0=='*tags'){ $i21711[] = $v3c6e0; $y1c61f[] = e2urls__expand_tricky_parameters_for_tags_($b2063c); } if ($v3c6e0=='*tag'){ $i21711[] = $v3c6e0; $y1c61f[] = e2urls__expand_tricky_parameters_for_tags_(array ($b2063c)); } } foreach ($i21711 as $v3c6e0) unset($parameters[$v3c6e0]); foreach ($y1c61f as $e58e2a){ $parameters=array_merge($parameters,$e58e2a); } foreach($parameters as $v3c6e0 => $b2063c){ if (@$v3c6e0[0]!='_'){ $t9c464.=$v3c6e0 .'='. urlencode($b2063c) .'&'; } } $t9c464=substr($t9c464,0, -1); } if(array_key_exists($t9c464,$cc2bd7)) { if ($cc2bd7[$t9c464]!=='')$x572d4.=$cc2bd7[$t9c464] .'/'; return $x572d4; } else { $e44907=false; foreach ($cc2bd7 as $f45ea8 => $t9ea44){ $jb7365=$f45ea8; $jb7365=preg_quote($jb7365,'/'); $ted015=parse_url($f45ea8); $y2f532=$ted015['host']; $eebe09=parse_url($t9c464); if(strstr($f45ea8,'::')) { $gffd6b=$eebe09['scheme'] .'://'. $eebe09['host']; $jb7365=str_replace('\:\:','(.*)',$jb7365); $jb7365='/^'. $jb7365 .'$/s'; if(preg_match($jb7365,$gffd6b,$o9c28d)) { $wd6fe1=str_replace('::',$o9c28d[1],$t9ea44); $wd6fe1=str_replace('_','-',$wd6fe1); $f1b1cc=$eebe09['query']; if($__synthetic_urls and $f1b1cc){ $x572d4.=$wd6fe1 .'/?'. $f1b1cc; } elseif($__synthetic_urls){ $x572d4.=$wd6fe1 .'/'; } elseif ($f1b1cc){ $x572d4.='?go='. $wd6fe1 .'/&'. $f1b1cc; } else { $x572d4.='?go='. $wd6fe1 .'/'; } return $x572d4; } } $v54435=false; if ($fc48ba===$y2f532){ $e44907=true; if ($ted015['query']) { $g22c38=explode('&',$ted015['query']); foreach ($g22c38 as $j8822b){ list ($v3c6e0,$b2063c)=explode('=',$j8822b); $b2063c=urldecode($b2063c); $v3c6e0=str_replace('_','-',$v3c6e0); if ( array_key_exists($v3c6e0,$parameters) and $parameters[$v3c6e0]!=$b2063c ){ $v54435=true; break; } } } if (!$v54435){ if(preg_match_all('/\:[\-a-z]+/i',$t9ea44,$o9c28d)) { foreach ($o9c28d[0] as $ufc413){ $kb0f75=$_url_chunks['\\'. $ufc413]; if (!is_array($kb0f75)) { $kb0f75=array ($kb0f75); } $s05f62=$kb0f75[0]; foreach ($kb0f75 as $s05f62){ $deab03='/\(\?P\<(.*?)\>.*?\)/'; $i4274e=true; if (@preg_match_all($deab03,$s05f62,$o9c28d)) { $o9c28d=$o9c28d[1]; $i4274e=true; for ($d865c0=0; $d865c0 < count($o9c28d); ++ $d865c0){ if ( !array_key_exists(str_replace("_","-",$o9c28d[$d865c0]), $parameters) or $parameters[str_replace("_","-",$o9c28d[$d865c0])] === '' ){ $i4274e=false; break; } } } if (!$i4274e) continue; $gf9e1e=@preg_replace_callback( $deab03, function ($o9c28d) use ($parameters){ return$parameters[str_replace("_","-",$o9c28d[1])]; }, $s05f62 ); $gf9e1e=stripslashes($gf9e1e); $uc5d91=str_replace($ufc413,$gf9e1e,$t9ea44); break; } $t9ea44=$uc5d91; } } $g15214=array(); if ($t9ea44){ if($__synthetic_urls){ $x572d4.=$t9ea44 .'/'; } else { $g15214[] = 'go='. $t9ea44 .'/'; } } foreach($_GET as $c8ce4b => $i9e366) if(in_array($c8ce4b, array ('result','themeless'))) { $g15214[] = $c8ce4b . ($i9e366? ('='. urlencode($i9e366)) : ''); } if(count($g15214)) { $x572d4.='?'. implode('&',$g15214); } return $x572d4; } } } if ($e44907){ return $x572d4; } else { die ('Cannot compose url for candy '. $fc48ba); } } } function mb7e9($x572d4=null){ global$_url_map,$_url_chunks,$_config,$_current_url,$__synthetic_urls,$_protocol,$z57de2,$da57c1; if ($x572d4===null) $x572d4=urldecode($_GET['go']); if(Log::$ned2b5)__log('Resolve "'. $x572d4 .'"'); l7059(); $l196c2=$x572d4; $x572d4=trim($x572d4,'/'); $x572d4=ub6b0($x572d4); $parameters=array(); foreach($_url_map as $i12a24 => $f45ea8){ $jd532d=$i12a24; $jd532d=preg_quote($jd532d,'/'); if(strstr($i12a24,'::')) { $jd532d=str_replace('\:\:','(.*)',$jd532d); $jd532d='/^'. $jd532d .'$/s'; if(preg_match($jd532d,$x572d4,$o9c28d)) { $d53b9e=str_replace('-','_',$o9c28d[1]); $t9c464=str_replace('::',$d53b9e,$f45ea8); } } elseif(strstr($i12a24,':')) { $o1e380=array(); foreach($_url_chunks as $c8ce4b => $i9e366){ if(is_array($i9e366)) { $o1e380[$c8ce4b]='(?:(?:'. implode(')|(?:',$i9e366) .'))'; } else { $o1e380[$c8ce4b]=$i9e366; } } $jd532d=str_replace( array_keys($o1e380), array_values($o1e380), $jd532d ); $jd532d='/^'. $jd532d .'$/s'; if(preg_match($jd532d,$x572d4,$o9c28d)) { $t9c464=$f45ea8; foreach ($o9c28d as $v3c6e0 => $b2063c) if (!is_numeric($v3c6e0)) { $v3c6e0=str_replace('_','-',$v3c6e0); $parameters[$v3c6e0]=$b2063c; } } } else { if ($i12a24==$x572d4){ $t9c464=$f45ea8; break; } } } $ffafdd=(bool)$t9c464; if (!$t9c464)$t9c464='e2://e2m_404'; $eebe09=parse_url($t9c464); $fc48ba=$eebe09['host']; if ($eebe09['query']) { $g22c38=explode('&',$eebe09['query']); foreach ($g22c38 as $j8822b){ list ($v3c6e0,$b2063c)=explode('=',$j8822b); $b2063c=urldecode($b2063c); $v3c6e0=str_replace('_','-',$v3c6e0); $parameters[$v3c6e0]=$b2063c; } } $f2cb9d=false; $parameters=e2urls__consolidate_tricky_parameters_($parameters); if ($ffafdd){ if($_config['force_canonical_urls']) { $b95d32=i83c8($fc48ba,$parameters); list ($za4c3a,$nab96c)=explode('?',$_SERVER['REQUEST_URI'],2); $ka37bf=$_protocol .'://'.$_SERVER['HTTP_HOST'].$za4c3a; $s5d6ba=$_protocol .'://'.$_SERVER['HTTP_HOST'].urldecode($za4c3a); $nab96c=explode('&',$nab96c); foreach ($nab96c as $u6c0d0){ list ($j5c5e7, ) = explode('=',$u6c0d0); if ($j5c5e7=='go'){ $ka37bf.='?'. $u6c0d0; $s5d6ba.='?'. urldecode($u6c0d0); } } $_current_url=$ka37bf; if ($ka37bf!=$b95d32 and $s5d6ba!=$b95d32){ e2_go_to($b95d32); } } if(is_callable($fc48ba)) { $f2cb9d=array ($fc48ba,$parameters); } else { $f2cb9d=array (null, array ()); } } else { $f2cb9d=array (null, array ()); } foreach($_GET as $v3c6e0 => $b2063c){ if ($v3c6e0!=='go')$f2cb9d[1][$v3c6e0]=$b2063c; } if(Log::$ned2b5){ if(count($f2cb9d[1]) > 0){ $qf8cea=print_r($f2cb9d[1],true); $qf8cea=substr($qf8cea,8, -2); $qf8cea='    '. trim($qf8cea); $qf8cea=preg_replace('/^.*?$/smu','         $0',$qf8cea); $qf8cea=' with parameters:'."\r\n". $qf8cea; } __log( 'Resolved to candy "'. $f2cb9d[0] .'"'. $qf8cea ); } return $f2cb9d; } function e2urls__expand_tricky_parameters_for_note_($b39a37){ global $da57c1,$_config,$_e2_day_numbers_by_note_id; if (!isset ($b39a37['IsPublished'])) { return array (); } if (!$b39a37['IsPublished']) { if ($b39a37['OriginalAlias']===''){ $parameters['draft']=$b39a37['ID']; } elseif(e2_draft_alias_use_count($b39a37['OriginalAlias']) == 1){ $parameters['oalias']=$b39a37['OriginalAlias']; } else { $parameters['draft2']=$b39a37['ID']; $parameters['oalias2']=$b39a37['OriginalAlias']; } $parameters['is-published']=0; return$parameters; } $parameters['is-published']=1; $ub80bb=$b39a37['ID']; $o96b8c=$b39a37['Stamp']; $wb2c6c=d0923($b39a37); if (!isset ($b39a37['__noalias!'])) { if (isset ($b39a37['alias'])) { $parameters['alias']=$b39a37['alias']; } else { $parameters['alias']=e2_active_alias_for_page_(ENTITY_TYPE_NOTE,$b39a37['ID']); if($parameters['alias']=='') unset($parameters['alias']); } } if(array_key_exists('alias',$parameters)) return$parameters; list ($x41529,$r6f8f5,$u8277e)=explode('/', e5a2f('Y/m/d',$o96b8c,$wb2c6c) ); $parameters['year']=$x41529; $parameters['month']=$r6f8f5; $parameters['day']=$u8277e; if (isset ($b39a37['day_number'])) { $parameters['day-number']=$b39a37['day_number']; } elseif (isset ($_e2_day_numbers_by_note_id[$b39a37['ID']])) { $parameters['day-number']=$_e2_day_numbers_by_note_id[$b39a37['ID']]; } else { list ($zd9d0f, ) = g5273($x41529,$r6f8f5,$u8277e); a0738( "SELECT `ID`, `Stamp`, `Offset`, `IsDST` ". "FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished` = 1 AND (`Stamp` BETWEEN " .$zd9d0f. " AND " .$o96b8c. ") ". "ORDER BY `Stamp`", 'get all notes that could be on this date even in different timezones for legacy url resolution' ); $result=z0d6b(); $wb1bc2=1; foreach($result as $c65afd){ if ( $x41529.'/'.$r6f8f5.'/'.$u8277e == e5a2f('Y/m/d',$c65afd['Stamp'],d0923($c65afd)) ) { if ($c65afd['ID']==$ub80bb){ $c444bc=1; break; } $wb1bc2 ++; } } if (@$c444bc!=1){ header('HTTP/1.1 503 Service Unavailable'); die ('Candidates enumeration failed.'); } $parameters['day-number']=$wb1bc2; $_e2_day_numbers_by_note_id[$b39a37['ID']] = $wb1bc2; } return$parameters; } function e2urls__expand_tricky_parameters_for_tags_($x0dff3){ $b9299d=array(); $parameters=array(); foreach ($x0dff3 as $nb19ad){ $v72487=''; if (!isset ($nb19ad['__noalias!'])) { if (isset ($nb19ad['tag-alias'])) { $v72487=$nb19ad['tag-alias']; } else { $v72487=e2_active_alias_for_page_(ENTITY_TYPE_TAG,$nb19ad['ID']); } } $b9299d[] = $v72487? $v72487:$nb19ad['OriginalAlias']; } if(count($x0dff3)) { $parameters['tag-alias']=implode(',',$b9299d); } return$parameters; } function e2urls__consolidate_tricky_parameters_($parameters){ if ( (string) @$parameters['alias']!=='' or ( (string) @$parameters['year']!=='' and (string) @$parameters['month']!=='' and (string) @$parameters['day']!=='' and (string) @$parameters['day-number']!=='' ) ) { if ($raad65=e2_published_noterec_with_parameters_($parameters)) { $parameters['*note']=$raad65; } } if ( (string) @$parameters['oalias']!=='' or (string) @$parameters['draft']!=='' or (string) @$parameters['oalias2']!=='' or (string) @$parameters['draft2']!=='' ){ if ($raad65=e2_noterec_with_parameters_($parameters)) { $parameters['*note']=$raad65; } } if ( (string) @$parameters['tag-alias']!=='' ){ $parameters['*tags']=e2_tagrecs_with_parameters_($parameters); if(count($parameters['*tags']) == 1){ $parameters['*tag']=$parameters['*tags'][0]; } } return$parameters; } function w3aa5($f9dd4e){ global$_e2utf8__unformat_htmlentity_neasden; if($_e2utf8__unformat_htmlentity_neasden){ return $f9dd4e; } else { return '((html '. $f9dd4e .'))'; } } function oedd9($ze98a6,$u98df3=false){ $e80a41=''; $hf5a8e=strlen($ze98a6); for ($d865c0=0; $d865c0 < 256; ++ $d865c0){ $wf3d13[$d865c0]=0; $q0fc3c=$d865c0; while ($q0fc3c & 0x00000080){ $q0fc3c <<= 1; ++ $wf3d13[$d865c0]; } } for ($d865c0=0xd090; $d865c0 <= 0xd0bf; $d865c0++)$i84a26[$d865c0]=chr(($d865c0 & 0x000000ff)+48); for ($d865c0=0xd180; $d865c0 <= 0xd18f; $d865c0++)$i84a26[$d865c0]=chr(($d865c0 & 0x000000ff)+112); $i84a26[0xd081]="\xa8"; $i84a26[0xd191]="\xb8"; $i84a26[0xc299]="\x99"; $i84a26[0xc2a9]="\xa9"; $i84a26[0xc2ae]="\xae"; $i84a26[0xc2ab]="\xab"; $i84a26[0xc2bb]="\xbb"; $i84a26[0xc2a0]="\xa0"; $d865c0=0; while ($d865c0 < $hf5a8e){ $iac558=$ze98a6{$d865c0}; $ac267c=ord($iac558); if ($wf3d13[$ac267c]==0){ $e80a41.=$iac558; ++ $d865c0; } elseif ($wf3d13[$ac267c]==2){ $a06214=$i84a26[($ac267c << 8) | ord($ze98a6{$d865c0+1})]; $e80a41 .= ($a06214!=null)? $a06214 : ( $u98df3? (w3aa5( qebe5(substr($ze98a6,$d865c0,2)) )) : '?' ); $d865c0+=2; } else { $jdfbc9=substr($ze98a6,$d865c0,$wf3d13[$ac267c]); if ($jdfbc9=="\xe2\x84\x96")$e80a41.="\xb9"; elseif ($jdfbc9=="\xe2\x80\x93")$e80a41.="\x96"; elseif ($jdfbc9=="\xe2\x80\x94")$e80a41.="\x97"; elseif ($jdfbc9=="\xe2\x80\x98")$e80a41.="\x91"; elseif ($jdfbc9=="\xe2\x80\x99")$e80a41.="\x92"; elseif ($jdfbc9=="\xe2\x80\x9a")$e80a41.="\x82"; elseif ($jdfbc9=="\xe2\x80\x9c")$e80a41.="\x93"; elseif ($jdfbc9=="\xe2\x80\x9d")$e80a41.="\x94"; elseif ($jdfbc9=="\xe2\x80\x9e")$e80a41.="\x84"; elseif ($jdfbc9=="\xe2\x80\xa6")$e80a41.="\x85"; elseif ($jdfbc9=="\xe2\x80\xb9")$e80a41.="\x8b"; elseif ($jdfbc9=="\xe2\x80\xba")$e80a41.="\x9b"; elseif ($jdfbc9=="\xe2\x82\xac")$e80a41.="\x88"; elseif ($jdfbc9=="\xe2\x84\xa2")$e80a41.="\x99"; else $e80a41.=$u98df3? (w3aa5( qebe5($jdfbc9) )) : '?'; $d865c0+=$wf3d13[$ac267c]; } } return $e80a41; } function qebe5($a4a8a0){ $acc411=''; $hf5a8e=strlen($a4a8a0); for ($d865c0=0; $d865c0 < $hf5a8e; ++ $d865c0){ $acc411.=preg_replace('/^1*0/','',decbin(ord($a4a8a0{$d865c0}))); } return '&#'. bindec($acc411) .';'; } function xfd97($a341be) { $f2cb9d=$a341be; $f2cb9d=preg_replace_callback('/([\x80-\xFF])/','e2_utf_from_windows_1251_char',$f2cb9d); return $f2cb9d; } function e2_utf_from_windows_1251_char($a4a8a0){ list (, $a4a8a0)=$a4a8a0; if ($a4a8a0=="\xa8") return "\xd0\x81"; if ($a4a8a0=="\xb8") return "\xd1\x91"; if ($a4a8a0 >= "\xc0" && $a4a8a0 <= "\xef") return "\xd0".chr(ord($a4a8a0)-48); if ($a4a8a0 >= "\xf0") return "\xd1".chr(ord($a4a8a0)-112); if ($a4a8a0=="\x85") return "\xe2\x80\xa6"; if ($a4a8a0=="\x96") return "\xe2\x80\x93"; if ($a4a8a0=="\x97") return "\xe2\x80\x94"; if ($a4a8a0=="\xab") return "\xc2\xab"; if ($a4a8a0=="\xbb") return "\xc2\xbb"; if ($a4a8a0=="\x91") return "\xe2\x80\x98"; if ($a4a8a0=="\x92") return "\xe2\x80\x99"; if ($a4a8a0=="\x93") return "\xe2\x80\x9c"; if ($a4a8a0=="\x94") return "\xe2\x80\x9d"; if ($a4a8a0=="\x84") return "\xe2\x80\x9e"; if ($a4a8a0=="\x99") return "\xe2\x84\xa2"; if ($a4a8a0=="\xb9") return "\xe2\x84\x96"; if ($a4a8a0=="\xa0") return "\xc2\xa0"; return '?'; }; function e2_utf8_version_of_array_($rf1f71){ foreach ($rf1f71 as $c8ce4b => $i9e366){ if (!array_key_exists($c8ce4b.'.u?',$rf1f71)) { if(is_string($rf1f71[$c8ce4b])) { $rf1f71[$c8ce4b]=xfd97($rf1f71[$c8ce4b]); } elseif(is_array($rf1f71[$c8ce4b])) { $rf1f71[$c8ce4b]=e2_utf8_version_of_array_($rf1f71[$c8ce4b]); } } } return $rf1f71; } function d869e($r6f8f5){ return mb_convert_encoding($r6f8f5[0],'HTML-ENTITIES','UTF-8'); } function jff7c($a341be,$v22019=false){ if ($v22019){ return preg_replace_callback( '/[\x{10000}-\x{fffff}]/u','e2_question_long_utf8_chars_helper',$a341be ); } else { return preg_replace('/[\x{10000}-\x{fffff}]/u','?',$a341be); } } function e2img_filename_by_processing( $ifce75,$y1c925, $a26635,$scff96,$wd6663 ){ global$_config; if(Log::$ned2b5)__log('Process image: "'. $ifce75 .'" -> "'. $y1c925 .'"'); if (!is_file($ifce75)) return false; if (!ub6c5($ifce75)) { if(Log::$ned2b5)__log('Process image: SVG, no processing'); return $ifce75; } if(is_file($y1c925) and !c4f9d($ifce75,$y1c925)) { if(Log::$ned2b5)__log('Process image: Already exists'); return $y1c925; } if (!extension_loaded('gd')) return false; $g7ae08=pathinfo($y1c925); if (!@naf42($g7ae08['dirname'])) { if(Log::$ned2b5)__log( 'Process image: Can’t create directory <'. $g7ae08['dirname'] .'>' ); return false; } if(Log::$ned2b5)__log('Process image: Detecting image type'); $type=e2img__type_of_file($ifce75); if (!$type) return false; $w94ba2='imagecreatefrom'. $type; if (!function_exists($w94ba2)) return false; if(Log::$ned2b5)__log('Process image: Opening original image ('. $w94ba2 .')'); $i1ccee=call_user_func($w94ba2,$ifce75); if (!$i1ccee) return false; if ($e89918=e2img__orientation_of_file($ifce75)) { if(Log::$ned2b5)__log('Process image: Needs orientation fix'); $i1ccee=e2img__res_rotate($i1ccee, -$e89918); } $u6af77=[imagesx($i1ccee),imagesy($i1ccee)]; $wb3e38=$u6af77; $eac50f=[0,0,0,0]; if ($scff96==CROP_SQUARE){ if(Log::$ned2b5)__log('Process image: Needs crop'); list ($wb3e38,$eac50f) = ( e2img__crop_metrics_to_square($wb3e38) ); } $wb3e38=e2img__fit_metrics_to_constraints( $wb3e38,$a26635 ); if ( $e89918===0 and $wb3e38===$u6af77 ){ if(Log::$ned2b5)__log('Process image: No changes necessary, leaving original'); return $ifce75; } if(Log::$ned2b5)__log(var_export($wb3e38,true)); if(Log::$ned2b5)__log(var_export($eac50f,true)); $z26ea7=e2img__create_copy_resampled( $i1ccee, $wb3e38, $eac50f, $type ); imagejpeg($z26ea7,$y1c925,$wd6663); if (!is_file($y1c925)) { if(Log::$ned2b5)__log('Process image: File not created by imagejpeg'); return false; } chmod($y1c925,$_config['uploaded_files_mode']); if(Log::$ned2b5)__log('Process image: Done'); return $y1c925; } function e2img__create_copy_resampled( $i1ccee,$wb3e38,$eac50f,$type ){ list ($vd4d55,$g455ce)=$wb3e38; list ($h98453,$w2aaef,$xb40c7,$n0a71b)=$eac50f; $z26ea7=imagecreatetruecolor($vd4d55,$g455ce); if($type==='png'){ imagefill($z26ea7,0,0,imagecolorallocate($z26ea7,255,255,255)); imagealphablending($z26ea7,true); } $j2097d=imagesx($i1ccee); $n97874=imagesy($i1ccee); imagecopyresampled( $z26ea7, $i1ccee, 0,0, 0+$h98453,0+$w2aaef, $vd4d55,$g455ce, $j2097d-$xb40c7,$n97874-$n0a71b ); imageinterlace($z26ea7,1); return $z26ea7; } function e2img__type_of_file($n435ed){ $jcaf9b=@getimagesize($n435ed); if (!$jcaf9b or $jcaf9b[2] > 3) return false; if ($jcaf9b[2]==IMAGETYPE_GIF) return 'gif'; if ($jcaf9b[2]==IMAGETYPE_JPEG) return 'jpeg'; if ($jcaf9b[2]==IMAGETYPE_PNG) return 'png'; return false; } function e2img__orientation_of_file($n435ed){ if (!function_exists('exif_read_data')) return 0; if (($o9beff=@exif_read_data($n435ed)) === false) return 0; if ($o9beff['Orientation']==3) return -180; if ($o9beff['Orientation']==6) return -270; if ($o9beff['Orientation']==8) return -90; return 0; } function e2img__res_rotate($j9b207,$e89918){ $h65370=imagerotate($j9b207,$e89918,0); if ($h65370!==false){ imagedestroy($j9b207); $j9b207=$h65370; } return $j9b207; } function e2img__fit_metrics_to_constraints( $k0b73d,$a26635 ){ if ($a26635===false)$a26635=[0,0]; list ($heaae2,$ab435e)=$k0b73d; list ($pdb99b,$y4278c)=$a26635; $o8e7bb=[1]; if ($pdb99b)$o8e7bb[] = $pdb99b/$heaae2; if ($y4278c)$o8e7bb[] = $y4278c/$ab435e; $w0cb47=min($o8e7bb); if ($w0cb47 < 1){ $heaae2=round($heaae2*$w0cb47); $ab435e=round($ab435e*$w0cb47); } return [$heaae2,$ab435e]; } function e2img__crop_metrics_to_square($k0b73d){ $w81188=$lb2835=$n4505c=$be6dec=0; list ($heaae2,$ab435e)=$k0b73d; if ($heaae2 > $ab435e){ $n4505c=$heaae2-$ab435e; $w81188=floor($n4505c/2); $ab435e=$heaae2; } elseif ($heaae2 < $ab435e){ $be6dec=$ab435e-$heaae2; $lb2835=floor($n4505c/2); $heaae2=$ab435e; } $eac50f=[$w81188,$lb2835,$n4505c,$be6dec]; $d27e5c=[$heaae2,$ab435e]; return [$d27e5c,$eac50f]; } $_folders_written=array ( '.', USER_FOLDER, CACHES_FOLDER, BACKUP_FOLDER, MEDIA_ROOT_FOLDER.PICTURES_FOLDER, MEDIA_ROOT_FOLDER.THUMBNAILS_FOLDER, MEDIA_ROOT_FOLDER.PICTURES_FOLDER .'remote/', MEDIA_ROOT_FOLDER.THUMBNAILS_FOLDER .'remote/', MEDIA_ROOT_FOLDER.AUDIO_FOLDER, MEDIA_ROOT_FOLDER.AVATARS_FOLDER, ); $_files_written=array ( USER_FOLDER.'password-hash.psa', USER_FOLDER.'password-wait.psa', USER_FOLDER.'last-comment.psa', USER_FOLDER.'new-uploads.psa', USER_FOLDER.'settings.json', USER_FOLDER.'indexing.psa', USER_FOLDER.'auth.psa', USER_FOLDER.'log.txt', ); define('CROP_NONE',0); define('CROP_SQUARE',1); define('PROVIDE_DATA_SPAWN',10); define('PROVIDE_DATA_NOW',20); function pea70(){ global$_folders_written,$_files_written; clearstatcache(); $i10ae9=array(); foreach($_folders_written as $c8fa14){ if(is_dir($c8fa14) and !is_writable($c8fa14)) { $i10ae9[] = $c8fa14; } } foreach($_files_written as $c8fa14){ if(is_file($c8fa14) and !is_writable($c8fa14)) { $i10ae9[] = $c8fa14; } } return $i10ae9; } function s6e52($m8c7dd,$bb45cf){ @naf42(dirname($m8c7dd)); if (!@file_put_contents($m8c7dd,$bb45cf,LOCK_EX)) { return false; } @chmod($m8c7dd,E2_NEW_FILES_RIGHTS); return true; } function b1cae($b954eb){ if(preg_match('/^https?\:\/\//iu',$b954eb)) { $v6efa1=$b954eb; $v6efa1=preg_replace('/^https?\:\/\//iu','',$v6efa1); $v6efa1=str_replace('/','--',$v6efa1); $v6efa1=MEDIA_ROOT_FOLDER.THUMBNAILS_FOLDER.$v6efa1; } else { $v6efa1=MEDIA_ROOT_FOLDER.THUMBNAILS_FOLDER.$b954eb; } $v6efa1=e2files__add_ext_prefix($v6efa1,'thumb@2x'); return $v6efa1; } function j6e61($b954eb){ if(preg_match('/^https?\:\/\//iu',$b954eb)) { $aaf721=$b954eb; } else { $aaf721=MEDIA_ROOT_FOLDER.PICTURES_FOLDER.$b954eb; } $v6efa1=e2img_filename_by_processing( $aaf721, b1cae($b954eb), [THUMB_WIDTH,THUMB_HEIGHT], CROP_NONE, THUMB_JPG_QUALITY ); if ($v6efa1===false) return false; $hf5a8e=strlen(MEDIA_ROOT_FOLDER); if(substr($v6efa1,0,$hf5a8e)==MEDIA_ROOT_FOLDER){ $u85133=substr($v6efa1,$hf5a8e); } return $u85133; } function u30f2($aaf721){ $p8743c=pathinfo($aaf721); $oabf77=$p8743c['extension']; return (in_array(strtolower($oabf77), array ('jpg','jpeg','gif','png','svg'))); } function ub6c5($aaf721){ $p8743c=pathinfo($aaf721); $oabf77=$p8743c['extension']; return (in_array(strtolower($oabf77), array ('jpg','jpeg','gif','png'))); } function qef67($aaf721){ $p8743c=pathinfo($aaf721); $oabf77=$p8743c['extension']; if ($oabf77=='png') return IMAGETYPE_PNG; if ($oabf77=='gif') return IMAGETYPE_GIF; if ($oabf77=='jpg' or $oabf77=='jpeg') return IMAGETYPE_JPEG; } function z19a4($n435ed){ if (ub6c5($n435ed)) { list ($heaae2,$ab435e)=getimagesize($n435ed); } else { $ge2da9=simplexml_load_string(file_get_contents($n435ed)); if ($ge2da9){ $wd0a5e=$ge2da9->attributes(); list ($heaae2,$ab435e) = array ((string)$wd0a5e -> width, (string)$wd0a5e -> height); } else { return false; } } if(substr($n435ed,strrpos($n435ed,'.')-3,3)=='@2x'){ $heaae2=(int)floor($heaae2/2); $ab435e=(int)floor($ab435e/2); } return array ($heaae2,$ab435e); } function e2s_retrieve($parameters){ $k36cd3=urldecode(base64_decode($parameters['url'])); if(Log::$ned2b5)__log('Retrieve: '. $k36cd3); e1066($k36cd3,PROVIDE_DATA_NOW); } function bbcd0($v447b7){ global$full_blog_url; $d78f08=parse_url($v447b7); if (isset ($d78f08['scheme'])) { if (u30f2($d78f08['path'])) { return array ( 'type' => 'remote-image', 'is-local?' => false, ); } elseif ($d78f08['host']=='www.youtube.com'){ $ub80bb=basename($d78f08['path']); $h15ba8='remote/youtube-'. $ub80bb .'-cover.jpg'; return array ( 'type' => 'online-video', 'is-local?' => false, 'video-service' => 'youtube', 'video-id' => $ub80bb, 'local-cover-name' => $h15ba8, 'local-cover-href' => $full_blog_url .'/'. PICTURES_FOLDER.$h15ba8, 'local-full-filename' => MEDIA_ROOT_FOLDER.PICTURES_FOLDER.$h15ba8, 'local-full-failname' => MEDIA_ROOT_FOLDER.PICTURES_FOLDER.$h15ba8.'.failed', ); } elseif ($d78f08['host']=='player.vimeo.com'){ $ub80bb=basename($d78f08['path']); $h15ba8='remote/vimeo-'. $ub80bb .'-cover.jpg'; return array ( 'type' => 'online-video', 'is-local?' => false, 'video-service' => 'vimeo', 'video-id' => $ub80bb, 'local-cover-name' => $h15ba8, 'local-cover-href' => $full_blog_url .'/'. PICTURES_FOLDER.$h15ba8, 'local-full-filename' => MEDIA_ROOT_FOLDER.PICTURES_FOLDER.$h15ba8, 'local-full-failname' => MEDIA_ROOT_FOLDER.PICTURES_FOLDER.$h15ba8.'.failed', ); } } else { if (u30f2($d78f08['path'])) { return array ( 'type' => 'local-image', 'is-local?' => true, 'local-href' => $full_blog_url .'/'. PICTURES_FOLDER.$d78f08['path'], 'local-full-filename' => MEDIA_ROOT_FOLDER.PICTURES_FOLDER.$d78f08['path'] ); } else { return array ( 'type' => 'local-non-image', 'is-local?' => true, ); } } } function e1066($v447b7,$xdb88a){ $e1c149=bbcd0($v447b7); if ($e1c149['type']=='remote-image'){ } elseif ($e1c149['type']=='online-video'){ if(is_file($e1c149['local-full-filename'])) { if(Log::$ned2b5)__log('Already exists: '. $e1c149['local-full-filename']); } elseif(is_file($e1c149['local-full-failname'])) { if(Log::$ned2b5)__log('Already tried and failed: '. $e1c149['local-full-filename']); } else { if(Log::$ned2b5)__log($v447b7.' is missing a cover, retrieving'); if ($xdb88a==PROVIDE_DATA_SPAWN){ rcc38(i83c8('e2s_retrieve', array ( 'url' => urlencode(base64_encode($v447b7)), ))); } if ($xdb88a==PROVIDE_DATA_NOW){ if ($e1c149['video-service']=='youtube') { $r5f89d=array ( 'maxresdefault','hqdefault','mqdefault','sddefault','default' ); foreach ($r5f89d as $xd7d16){ $x572d4='http://img.youtube.com/vi/'. $e1c149['video-id'] .'/'. $xd7d16 .'.jpg'; if(Log::$ned2b5)__log('Getting '.$x572d4 .' as '. $e1c149['local-full-filename']); $j6c43d=file_get_contents($x572d4); if ($j6c43d!==false) break; } } if ($e1c149['video-service']=='vimeo') { $uc4a72=unserialize( file_get_contents('http://vimeo.com/api/v2/video/'. $e1c149['video-id'] .'.php') ); if (isset ($uc4a72[0]['thumbnail_large'])) { $j6c43d=file_get_contents($uc4a72[0]['thumbnail_large']); } } if ($j6c43d!==false){ s6e52($e1c149['local-full-filename'],$j6c43d); } else { s6e52($e1c149['local-full-failname'],''); } } } if ($xdb88a==PROVIDE_DATA_NOW){ if(is_file($e1c149['local-full-filename'])) { j6e61($e1c149['local-cover-name']); } } } elseif ($e1c149['type']=='local-image'){ if(Log::$ned2b5)__log($v447b7.' is a local image'); j6e61($v447b7); } elseif ($e1c149['type']=='local-non-image'){ if(Log::$ned2b5)__log($v447b7.' is a local non-image'); } } function b6be4($i10ae9){ if (!is_array($i10ae9)) return; if(Log::$ned2b5)__log('Provide data for resources {'); foreach ($i10ae9 as $v447b7){ e1066($v447b7,PROVIDE_DATA_SPAWN); } if(Log::$ned2b5)__log('}'); } function zf898($o89111,$jdffc4,$te449c){ $i5128f=g1722($o89111,$jdffc4); $p55b55=array_merge($i5128f,$te449c); $p55b55=array_reverse($p55b55); $p55b55=array_unique($p55b55); $p55b55=array_reverse($p55b55); return d2e82($p55b55,RESOURCES_LOCAL); } function wfc4d($kd430b,$g2bfe4){ $o84841=array(); if(is_array($g2bfe4['meta']['resources-detected'])) { $te449c=$g2bfe4['meta']['resources-detected']; $o84841=hdc5a($te449c); } $n16137=@unserialize( $kd430b['Uploads'] ) or $n16137=array(); $m08204=array_diff($o84841,$n16137); if(count($m08204) > 0){ n2cf0('note',$kd430b['ID'],'add',$m08204); } return $m08204; } function hdc5a($ld7f81){ $i10ae9=array(); foreach ($ld7f81 as $t1993e){ $e1c149=bbcd0($t1993e); if ($e1c149['is-local?'])$i10ae9[] = $t1993e; } return $i10ae9; } function d2e82($p55b55,$k8b7af=RESOURCES_ALL){ global$full_blog_url; $eef067=array(); $k59b51=array(); if (!is_array($p55b55)) return $k59b51; b6be4($p55b55); foreach ($p55b55 as $i96ab4){ $e1c149=bbcd0($i96ab4); if ($k8b7af==RESOURCES_LOCAL and !$e1c149['is-local?']) continue; if ($e1c149['type']=='remote-image'){ } elseif ($e1c149['type']=='online-video'){ if ($c742c4=j6e61($e1c149['local-cover-name'])) { $size=z19a4(MEDIA_ROOT_FOLDER.$c742c4); list ($heaae2,$ab435e)=$size; if (!in_array($i96ab4,$eef067)) { $eef067[] = $i96ab4; $k59b51[] = array ( 'original-filename' => $i96ab4, 'href' => $full_blog_url .'/'. $c742c4, 'width' => $heaae2, 'height' => $ab435e, ); } } } elseif ($e1c149['type']=='local-image'){ if ($c742c4=j6e61($i96ab4)) { $size=z19a4(MEDIA_ROOT_FOLDER.$c742c4); list ($heaae2,$ab435e)=$size; if (!$heaae2)$heaae2=THUMB_WIDTH/2; if (!$ab435e)$ab435e=THUMB_HEIGHT/2; if (!in_array($i96ab4,$eef067)) { $eef067[] = $i96ab4; $k59b51[] = array ( 'original-filename' => $i96ab4, 'href' => $full_blog_url .'/'. $c742c4, 'width' => $heaae2, 'height' => $ab435e, ); } } } elseif ($e1c149['type']=='local-non-image'){ if(is_file(MEDIA_ROOT_FOLDER.AUDIO_FOLDER.$i96ab4)) { if (!in_array($i96ab4,$eef067)) { $eef067[] = $i96ab4; $k59b51[] = array ( 'original-filename' => $i96ab4, 'href' => $full_blog_url .'/'. AUDIO_ICON_IMAGE, 'width' => AUDIO_ICON_WIDTH, 'height' => AUDIO_ICON_HEIGHT, ); } } } } return $k59b51; } function sdbcc($o89111,$jdffc4,$p55b55){ global$full_blog_url; $i10ae9=array(); if(is_array($p55b55)) { $i10ae9=e2files__list_og_images_for_resources_($p55b55); } $i5128f=g1722($o89111,$jdffc4); if(is_array($i5128f)) { foreach ($i5128f as $c8ce4b => $i9e366){ if(is_file(MEDIA_ROOT_FOLDER.PICTURES_FOLDER.$i9e366)) { $i5128f[$c8ce4b]=$full_blog_url .'/'. PICTURES_FOLDER.$i9e366; } else { unset ($i5128f[$c8ce4b]); } } $i10ae9=array_merge($i5128f,$i10ae9); } $i10ae9=array_reverse($i10ae9); $i10ae9=array_unique($i10ae9); $i10ae9=array_reverse($i10ae9); return $i10ae9; } function e2files__list_og_images_for_resources_($p55b55){ $k59b51=array(); b6be4($p55b55); foreach ($p55b55 as $i96ab4){ $e1c149=bbcd0($i96ab4); if ($e1c149['type']=='remote-image'){ } elseif ($e1c149['type']=='online-video'){ if(is_file($e1c149['local-full-filename'])) { $k59b51[] = $e1c149['local-cover-href']; } } elseif ($e1c149['type']=='local-image'){ if(is_file($e1c149['local-full-filename'])) { $k59b51[] = $e1c149['local-href']; } } elseif ($e1c149['type']=='local-non-image'){ } } return $k59b51; } function b9c0a($eb0689,$l12e09){ if(preg_match('//u',$eb0689))$eb0689=oedd9($eb0689,false); if ($l12e09=='image'){ $a85114=MEDIA_ROOT_FOLDER.PICTURES_FOLDER; } elseif ($l12e09=='audio'){ $a85114=MEDIA_ROOT_FOLDER.AUDIO_FOLDER; } else { return false; } $o96704=''; for ($d865c0=0; $d865c0 < strlen($eb0689); $d865c0++) { if ($eb0689[$d865c0]=='?'){ $o96704.=''; } elseif ($eb0689[$d865c0]==' '){ $o96704.='-'; } elseif(ord($eb0689[$d865c0]) <= 127){ $o96704.=$eb0689[$d865c0]; } } if ($o96704=='')$o96704=$l12e09; if ($o96704[0]=='.')$o96704=$l12e09.$o96704; return $o96704; } function pf0fb($v76ee3){ global$_config; if(Log::$ned2b5)__log('Count references for upload <'. $v76ee3 .'>'); $b7cd94=$qbe270=$i6ae44=array(); if(is_file(USER_FOLDER.'new-uploads.psa')) { $b7cd94=@unserialize(file_get_contents(USER_FOLDER.'new-uploads.psa')); if (!is_array($b7cd94))$b7cd94=array(); } $z5a976='%'. str_replace('%','#%',$v76ee3) .'%'; a0738( "SELECT `ID`, `Text`, `FormatterID`, `Uploads` ". "FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `Text` LIKE '". $z5a976 ."' ESCAPE '#' ". "OR `Uploads` LIKE '". $z5a976 ."' ESCAPE '#'", 'get notes where uploads may be referenced' ); $result=z0d6b(); $qbe270=@unserialize($result[0]['Uploads']); if (!is_array($qbe270)) { foreach($result as $b39a37){ $g2bfe4=c154e( $b39a37['FormatterID'], @$b39a37['Text'],'full-rss' ); $qbe270=wfc4d($b39a37,$g2bfe4); } } a0738( "SELECT `ID`, `Description`, `Uploads` ". "FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `Description` LIKE '". $z5a976 ."' ESCAPE '#' ". "WHERE `Uploads` LIKE '". $z5a976 ."' ESCAPE '#'", 'get tags where uploads may be referenced' ); $result=z0d6b(); $i6ae44=@unserialize($result[0]['Uploads']); if (!is_array($i6ae44)) { foreach($result as $nb19ad){ $g2bfe4=sb7f1( @$nb19ad['Description'],'full-rss' ); $i6ae44=wfc4d($nb19ad,$g2bfe4); } } $i5128f=array_merge($b7cd94,$qbe270,$i6ae44); if(Log::$ned2b5)__log('References found in relevant entries: '. var_export($i5128f,true)); if(in_array($v76ee3,$i5128f)) { if(Log::$ned2b5)__log('Still referenced, do not delete file'); return true; } return false; } function g1722($zf5e63,$ub80bb){ global$_config; if ($zf5e63=='note' and $ub80bb=='new'){ if(is_file(USER_FOLDER.'new-uploads.psa')) { $i5128f=@unserialize(file_get_contents(USER_FOLDER.'new-uploads.psa')); } } elseif ($zf5e63=='note'){ a0738( "SELECT `Uploads` FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `ID`=". $ub80bb ); $result=z0d6b(); $i5128f=@unserialize($result[0]['Uploads']); } elseif ($zf5e63=='tag'){ a0738( "SELECT `Uploads` FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `ID`=". $ub80bb ); $result=z0d6b(); $i5128f=@unserialize($result[0]['Uploads']); } if (!is_array($i5128f))$i5128f=array(); return $i5128f; } function vcbba($zf5e63,$ub80bb,$i5128f){ global$_config; if ($zf5e63=='note' and $ub80bb=='new'){ if (!@s6e52(USER_FOLDER.'new-uploads.psa',serialize($i5128f))) { o8a40('ERROR',E2E_PERMISSIONS_ERROR); } } elseif ($zf5e63=='note'){ a0738( "UPDATE `". $_config['db_table_prefix']."Notes` ". "SET `Uploads`='". serialize($i5128f) ."' ". "WHERE `ID`=". $ub80bb ); } elseif ($zf5e63=='tag'){ a0738( "UPDATE `". $_config['db_table_prefix']."Keywords` ". "SET `Uploads`='". serialize($i5128f) ."' ". "WHERE `ID`=". $ub80bb ); } else { return false; } if (!is_array($i5128f))$i5128f=array(); return $i5128f; } function n2cf0($zf5e63,$ub80bb,$action,$t4a202){ global$_config; $i5128f=array(); if(Log::$ned2b5)__log('Register upload: <'. $zf5e63.', '. $ub80bb.', '. $action.', '. $t4a202 .'>'); $i5128f=g1722($zf5e63,$ub80bb); $i5128f=ge1e7($i5128f,$action,$t4a202); vcbba($zf5e63,$ub80bb,$i5128f); } function v2f83($j4b27b,$gde17f,$te449c){ $n16137=@unserialize($gde17f['Uploads']) or $n16137=array(); $d28a47=hdc5a($te449c); $i5128f=ge1e7($n16137,'add',$d28a47); $i5128f=serialize($i5128f); if ($i5128f!=$gde17f['Uploads']) { $gde17f['Uploads']=$i5128f; taa79($j4b27b,$gde17f); } } function e2j_file_upload($parameters=array ()) { global$_config,$full_blog_url; @naf42(MEDIA_ROOT_FOLDER.PICTURES_FOLDER); @chmod(MEDIA_ROOT_FOLDER.PICTURES_FOLDER,$_config['uploaded_files_mode']); @naf42(MEDIA_ROOT_FOLDER.AUDIO_FOLDER); @chmod(MEDIA_ROOT_FOLDER.AUDIO_FOLDER,$_config['uploaded_files_mode']); $gd1fc8=array(); $gd1fc8['success']=0; if(count($_FILES) > 0){ foreach($_FILES as $m8c7dd){ if (!$m8c7dd['error']) { if(Log::$ned2b5)__log('Ajax file upload: <'. $m8c7dd['name'].'>'); $gd1fc8['file-kind']='image'; $a85114=MEDIA_ROOT_FOLDER.PICTURES_FOLDER; if(substr($m8c7dd['name'],strrpos($m8c7dd['name'],'.')) == '.mp3'){ $gd1fc8['file-kind']='audio'; $a85114=MEDIA_ROOT_FOLDER.AUDIO_FOLDER; } $m77dce=( array_key_exists('overwrite',$_GET) and is_file($a85114.$m8c7dd['name']) ); $z6f4b5=false; $gd1fc8['overwrite'] = (int)$m77dce; if(Log::$ned2b5)__log('Ajax file upload: Overwrite is resolved to <'. (int)$m77dce.'>'); $o96704=b9c0a($m8c7dd['name'],$gd1fc8['file-kind']); if(Log::$ned2b5)__log('Ajax file upload: Safe name is <'. $o96704.'>'); if(is_file($a85114.$o96704)) { if(file_get_contents($a85114.$o96704)==file_get_contents($m8c7dd['tmp_name'])) { if(Log::$ned2b5)__log('Ajax file upload: Existing file is the same'); $z6f4b5=true; } elseif (!$m77dce){ $o96704=e2files__find_free_filename($a85114,$o96704); } } if (!$z6f4b5){ move_uploaded_file($m8c7dd['tmp_name'],$a85114.$o96704); @chmod($d9f57c,$_config['uploaded_files_mode']); } if(Log::$ned2b5)__log('Ajax file upload: File kind is <'. $gd1fc8['file-kind'].'>'); if ($gd1fc8['file-kind']=='image'){ $ua28be=e2files__find_free_filename_with_added_ext( MEDIA_ROOT_FOLDER.PICTURES_FOLDER, $o96704,'jpg' ); $jb1cee=MEDIA_ROOT_FOLDER.PICTURES_FOLDER.$o96704; $d093b5=MEDIA_ROOT_FOLDER.PICTURES_FOLDER.$ua28be; if(Log::$ned2b5)__log('Ajax file upload: Process uploaded image <'. $jb1cee.'>'. ' to possibly <'. $d093b5.'>'); $d093b5=e2img_filename_by_processing( $jb1cee, $d093b5, [ $_config['fit_uploaded_images'], $_config['fit_uploaded_images'], ], CROP_NONE, SCALED_IMAGE_JPG_QUALITY ); if (!c4f9d($d093b5,$jb1cee)) { @unlink($jb1cee); $o96704=$ua28be; } if ($m77dce){ @unlink(b1cae($o96704)); } if ($c742c4=j6e61($o96704)) { if(Log::$ned2b5)__log('Ajax file upload: thumbnail, done'); list ($heaae2,$ab435e)=z19a4(MEDIA_ROOT_FOLDER.$c742c4); $gd1fc8['success']=1; $gd1fc8['new-name']=$o96704; $gd1fc8['thumb']=$full_blog_url .'/'. $c742c4; $gd1fc8['width']=$heaae2; $gd1fc8['height']=$ab435e; n2cf0($parameters['entity'],$parameters['entity-id'],'add', array ($o96704)); } else { if(Log::$ned2b5)__log('Ajax file upload: couldn’t create thumbnail'); @unlink($a85114.$o96704); $gd1fc8['error']='could-not-create-thumbnail'; } } if ($gd1fc8['file-kind']=='audio'){ if(Log::$ned2b5)__log('Ajax file upload: audio, done'); $gd1fc8['success']=1; $gd1fc8['new-name']=$o96704; $gd1fc8['thumb']=AUDIO_ICON_IMAGE; $gd1fc8['width']=AUDIO_ICON_WIDTH; $gd1fc8['height']=AUDIO_ICON_HEIGHT; n2cf0($parameters['entity'],$parameters['entity-id'],'add', array ($o96704)); } } elseif(4!=$m8c7dd['error']) { if ($m8c7dd['error']==1){ $gd1fc8['error']='too-big'; } elseif ($m8c7dd['error']==2){ $gd1fc8['error']='too-big'; } elseif ($m8c7dd['error']==3){ $gd1fc8['error']='partial'; } else { $gd1fc8['error']=$m8c7dd['error']; } } } } else { if(Log::$ned2b5)__log('Ajax file upload error: no files'); $gd1fc8['error']='no-files'; } $gd1fc8=json_encode($gd1fc8); die ($gd1fc8); } function e2j_userpic_upload(){ global$_config; if(count($_FILES)==1){ $m8c7dd=array_pop($_FILES); if (!$m8c7dd['error']) { if(Log::$ned2b5)__log('Ajax userpic upload: <'. $m8c7dd['name'].'>'); $da93b8=pathinfo($m8c7dd['name']); $oabf77=strtolower($da93b8['extension']); if ($oabf77!='png')$oabf77='jpg'; $n435ed='userpic.original.'. $oabf77; move_uploaded_file($m8c7dd['tmp_name'],USER_FOLDER.$n435ed); @chmod(USER_FOLDER.$n435ed,$_config['uploaded_files_mode']); @unlink(USER_FOLDER.'userpic@2x.png'); @unlink(USER_FOLDER.'userpic@2x.jpg'); $wf1210=e2img_filename_by_processing( USER_FOLDER.$n435ed, USER_FOLDER .'userpic@2x.jpg', [USERPIC_WIDTH,USERPIC_HEIGHT], CROP_SQUARE, USERPIC_JPG_QUALITY ); @unlink(USER_FOLDER.$n435ed); if ($wf1210){ if(Log::$ned2b5)__log('Ajax userpic upload: userpic, done'); die ('image|'. $wf1210); } else { die ('image|'.DEFAULT_USERPIC_FILENAME); } } elseif(4!=$m8c7dd['error']) { if ($m8c7dd['error']==1){ die ('error|too-big'); } elseif ($m8c7dd['error']==2){ die ('error|too-big'); } elseif ($m8c7dd['error']==3){ die ('error|partial'); } else { die ('error|'. $m8c7dd['error']); } } } else { if(Log::$ned2b5)__log('Ajax userpic upload error: no or too many files'); die ('error|no-or-too-many-files'); } die ('error|uncatched-error'); } function e2j_file_remove($parameters){ $m8c7dd=$wf1210=''; if(array_key_exists('file',$_POST))$m8c7dd=$_POST['file']; n2cf0($parameters['entity'],$parameters['entity-id'],'remove',$m8c7dd); if (pf0fb($m8c7dd)) { die ('nothing'); } else { if(substr($m8c7dd,strrpos($m8c7dd,'.')) == '.mp3'){ @unlink(MEDIA_ROOT_FOLDER.AUDIO_FOLDER.$m8c7dd); die ('nothing'); } else { $wf1210=e2files__add_ext_prefix($m8c7dd,'thumb@2x'); if ($m8c7dd){ $wf6347=@unlink(MEDIA_ROOT_FOLDER.PICTURES_FOLDER.$m8c7dd); $c8f458=@unlink(MEDIA_ROOT_FOLDER.THUMBNAILS_FOLDER.$wf1210); die ('nothing'); } } } die ('error|no-filename-passed'); } function cd10e(){ global$_config; if (!$_config['files_total_size_limit']) return false; $j70a36=0; foreach(glob(MEDIA_ROOT_FOLDER.PICTURES_FOLDER .'/*') as $m8c7dd){ $f9dd4e=stat($m8c7dd); $j70a36+=$f9dd4e['size']; } foreach(glob(MEDIA_ROOT_FOLDER.AUDIO_FOLDER .'/*') as $m8c7dd){ $f9dd4e=stat($m8c7dd); $j70a36+=$f9dd4e['size']; } $ld515a=$_config['files_total_size_limit']; $n354f0=round($j70a36/$ld515a*100); if ($j70a36 > 0 and $n354f0==0)$n354f0=1; if ($j70a36 < $ld515a and $n354f0==100)$n354f0=99; return array ($j70a36,$ld515a,$n354f0); } function c4f9d($sbd198,$a3667f){ return strcasecmp($sbd198,$a3667f)===0; } function g1363($oc999b){ $p85faf=true; if (list ($j70a36,$ld515a,$n354f0)=$oc999b){ $p85faf=($ld515a-$j70a36) > 0; } return $p85faf; } function vaf64($oc999b,$mf9f90=false){ $zf3ecb=''; if (list ($j70a36,$ld515a,$n354f0)=$oc999b){ $oc999b=array ( 'used' => round($j70a36/1024/1024), 'total' => round($ld515a/1024/1024), 'percent' => $n354f0 ); if ($mf9f90 or ($ld515a-$j70a36) < 1024*1024*10){ if ($j70a36 < $ld515a){ $zf3ecb=e2l_get_string('gs--used',$oc999b); } else { $zf3ecb=e2l_get_string('gs--used-all',$oc999b); } } } return $zf3ecb; } function e2files__find_free_filename($a85114,$n435ed){ if (!is_file($a85114.$n435ed)) return $n435ed; $he12a7=e2files__extless($n435ed); $oabf77=substr($n435ed,strrpos($n435ed,'.')); $d865c0=0; while (is_file($a85114.$he12a7 .'-'. (++$d865c0).$oabf77)); $n435ed=$he12a7 .'-'. $d865c0.$oabf77; return $n435ed; } function e2files__add_ext_prefix($n435ed,$g3dbb8){ if ($g3dbb8){ $u80127=explode('/',$n435ed); $b954eb=array_pop($u80127); $t35b88=explode('.',$b954eb); if(count($t35b88) < 2)$t35b88[] = ''; $oabf77=array_pop($t35b88); $t35b88[] = $g3dbb8; if ($oabf77)$t35b88[] = $oabf77; $b954eb=implode('.',$t35b88); $u80127[] = $b954eb; $n435ed=implode('/',$u80127); } return $n435ed; } function e2files__extless($n435ed){ return substr($n435ed,0,strrpos($n435ed,'.')); } function e2files__find_free_filename_with_added_ext($a85114,$n435ed,$f3cedd){ $oabf77=pathinfo($n435ed,PATHINFO_EXTENSION); if (!strcasecmp($oabf77,$f3cedd)) return $n435ed; return e2files__find_free_filename($a85114,$n435ed .'.'. $f3cedd); } function e2_error404_mode(){ global$_config,$_strings; if($_config['try_redirect_to_all']) { $h4a7dc='all/'. urldecode($_GET['go']); mb7e9($h4a7dc); } header('HTTP/1.1 404 Not found'); $qe70c4['class']='404'; $qe70c4['heading']=$_strings['pt--page-not-found']; $qe70c4['title']=$_strings['pt--page-not-found']; return $qe70c4; } function a6f10($j1cb25){ include_once 'neasden/neasden.php'; $Nn=new Neasden; $Nn->profile_name='kavychki'; return$Nn->format($j1cb25); } function ec0c4($bf2ffc,$j1cb25,$u5c18e){ include_once 'neasden/neasden.php'; if ($j1cb25==='') return array (); if ($bf2ffc=='calliope'){ preg_match_all('/\(\(([^ ]*)( |\)\))/',$j1cb25,$o9c28d); return $o9c28d[1]; } elseif ($bf2ffc=='neasden'){ $Nn=new Neasden; $Nn->profile_name=$u5c18e; $Nn->format($j1cb25); return$Nn->resources_detected; } else { return array (); } } function c154e($bf2ffc,$j1cb25,$u5c18e){ include_once 'neasden/neasden.php'; if(Log::$ned2b5)__log('Format: format with formatter "'. $bf2ffc .'" in context "'. $u5c18e.'"'); if ($bf2ffc=='calliope'){ $j1cb25=oedd9($j1cb25); $j1cb25=k5599($j1cb25,$u5c18e); $meta=array(); $j1cb25=xfd97($j1cb25); $j1cb25='<div class="e2-text-calliope-formatted">'. a6f10($j1cb25) .'</div>'; } elseif ($bf2ffc=='neasden'){ $Nn=new Neasden; $Nn->profile_name=$u5c18e; $j1cb25=$Nn->format($j1cb25); $meta=array ( 'links-required' => $Nn->links_required, 'resources-detected' => $Nn->resources_detected ); } return array ( 'text-final' => $j1cb25, 'meta' => $meta, ); } function sb7f1($j1cb25,$u5c18e){ global$_config; return c154e($_config['default_formatter'],$j1cb25,$u5c18e); } function k5599($j1cb25,$u5c18e){ global$_config,$settings,$full_blog_url,$_template; @ (list ($u5c18e,$qe8fab)=explode('|',$u5c18e)); require_once 'calliope/WikiFormatter.php'; if ('full'==$u5c18e)$dad910=WF_FULL_MODE; elseif ('full-rss'==$u5c18e)$dad910=WF_FULL_MODE; elseif ('simple'==$u5c18e)$dad910=WF_SIMPLE_MODE; elseif ('simple-rss'==$u5c18e)$dad910=WF_SIMPLE_MODE; else return $j1cb25; $b0a1d3=new WikiFormatter(); $b0a1d3 -> replace=array ( '/' => 'i', '+' => 'small', '-' => 's', '*' => 'b', '^' => 'sup', 'v' => 'sub', '#' => 'tt', '!' => 'blockquote', ); $b0a1d3 -> settings=array ( 'hrefSize' => 100, 'localImgDir' => $full_blog_url .'/'. PICTURES_FOLDER, 'maxImgWidth' => $_template['max_image_width'], 'mode' => $dad910, 'enableShrinkLongHref' => 1, 'enableHr' => 0, 'enableBr' => 1, 'enableHeaders' => 1, 'headersStartWith' => 1, 'enableTables' => 1, 'simpleTableCSSClass' => 'e2-text-table', 'enableAutoAcronymEngine' => 0, 'enableAcronym' => 0, 'acronymBase' => '', 'enableList' => 1, 'mailSafe' => "<a href=\"\" onmouseover=\"this.href='mailto:'+{email}\">{icon}<script language=\"JavaScript\">document.write({name});</script></a>", 'ljUserTag' => '<a href="http://livejournal.com/users/{name}/">{name}</a>', 'fullVersionURL' => $qe8fab, 'enableTagIcons' => 0, 'outerUrlInNewWindow' => 0, 'lineBreak' => "\n", 'extLinkHrefPrefix' => '', ); $j1cb25=$b0a1d3 -> Wiki2HTML($j1cb25); return $j1cb25; } function rcc38($x572d4){ if(Log::$ned2b5)__log('Spawn: Curl '. $x572d4 .'...'); if(function_exists('curl_init')) { $bf6e57=curl_init(); $r80e25=!ini_get('open_basedir'); curl_setopt_array($bf6e57, array ( CURLOPT_URL => $x572d4, CURLOPT_CONNECTTIMEOUT => 300, CURLOPT_TIMEOUT => 1, CURLOPT_MAXREDIRS => 1, CURLOPT_COOKIE => ec3fb(), CURLOPT_SSL_VERIFYPEER => false, CURLOPT_FOLLOWLOCATION => $r80e25, CURLOPT_RETURNTRANSFER => true, CURLOPT_AUTOREFERER => true, CURLOPT_USERAGENT => E2_UA_STRING, )); $content=curl_exec($bf6e57); $c70106=curl_errno($bf6e57); $t809b1=curl_error($bf6e57); $x099fb=curl_getinfo($bf6e57); curl_close($bf6e57); if(Log::$ned2b5)__log('Spawn: Curl returns: ['. print_r($x099fb,true) .'] ['. $content .'], (errno='. $c70106 .', errstr='. $t809b1 .')...'); } else { if(Log::$ned2b5)__log('Spawn: Curl functions are not available'); } } function j5b68($wea59a){ global$_config; if (@$_config['broadcast_url'] and !$wea59a['IsExternal']) { if($_config['log_broadcast']) { Log::$ned2b5=true; if(Log::$ned2b5)l714a('broadcast'); } if(Log::$ned2b5)__log('Broadcast-async note: '. $wea59a['Title']); $x572d4=i83c8('e2m_note_broadcast', array ('*note' => $wea59a)); if(Log::$ned2b5)__log('Broadcast will spawn url: '. $x572d4); rcc38($x572d4); } } function m0d22($zcffbb){ global$_config; if (!$zcffbb) return false; $x572d4=$_config['broadcast_url']; $x572d4.='?src='. urlencode($zcffbb); if($_config['log_broadcast']) { Log::$ned2b5=true; if(Log::$ned2b5)l714a('broadcast'); } if(Log::$ned2b5)__log('Broadcast: Curl '. $x572d4 .'...'); if(function_exists('curl_init')) { $bf6e57=curl_init(); $r80e25=!ini_get('open_basedir'); curl_setopt_array($bf6e57, array ( CURLOPT_URL => $x572d4, CURLOPT_CONNECTTIMEOUT => 300, CURLOPT_TIMEOUT => 1, CURLOPT_MAXREDIRS => 1, CURLOPT_COOKIE => ec3fb(), CURLOPT_SSL_VERIFYPEER => false, CURLOPT_FOLLOWLOCATION => $r80e25, CURLOPT_RETURNTRANSFER => true, CURLOPT_AUTOREFERER => true, CURLOPT_USERAGENT => E2_UA_STRING, )); $content=curl_exec($bf6e57); $c70106=curl_errno($bf6e57); $t809b1=curl_error($bf6e57); $x099fb=curl_getinfo($bf6e57); curl_close($bf6e57); if(Log::$ned2b5)__log('Broadcast: Curl returns: ['. print_r($x099fb,true) .'] ['. $content .'], (errno='. $c70106 .', errstr='. $t809b1 .')...'); if ($c70106===0) return true; } else { if(Log::$ned2b5)__log('Spawn: Curl functions are not available'); } return false; } function neb3b($wea59a){ if (!$wea59a) return false; $zcffbb=i83c8('e2m_note_json', array ('*note' => $wea59a)); return m0d22($zcffbb); } function e2m_note_broadcast($parameters=array ()) { global$_config; if (@$_config['broadcast_url']) { if(array_key_exists('*note',$parameters)) { $zcffbb=i83c8('e2m_note_json', array ('*note' => $parameters['*note'])); } elseif(array_key_exists('alias',$parameters)) { $zcffbb=i83c8('e2m_note_json', array ('alias' => $parameters['alias'])); } if (m0d22($zcffbb)) { die ('Broadcasted.'); } } else { return e2_error404_mode(); } } function e2m_timezone(){ global$_strings,$settings; $fde2fd=array ( 'form-action' => i83c8('e2s_select_timezone'), 'submit-text' => $_strings['fb--select'], 'timezone-selector' => c9fe5($settings['timezone']['offset'],1), 'dst?' => $settings['timezone']['is_dst'], ); return array ( 'title' => $_strings['pt--default-timezone'], 'heading' => $_strings['pt--default-timezone'], 'form' => 'form-timezone', 'form-timezone' => $fde2fd, ); } function a4c37(){ global$_strings; $c5cacd=array ( -720 => '', -660 => '', -600 => '', -540 => '', -480 => $_strings['tt--zone-pt'], -420 => $_strings['tt--zone-mt'], -360 => $_strings['tt--zone-ct'], -300 => $_strings['tt--zone-et'], -240 => '', -210 => '', -180 => '', -120 => '', -60 => '', 0 => $_strings['tt--zone-gmt'], 60 => $_strings['tt--zone-cet'], 120 => $_strings['tt--zone-eet'], 180 => '', 210 => '', 240 => $_strings['tt--zone-msk'], 270 => '', 300 => '', 330 => '', 345 => '', 360 => $_strings['tt--zone-ekt'], 390 => '', 420 => '', 480 => '', 540 => '', 570 => '', 600 => '', 660 => '', 720 => '', 780 => '', 840 => '', ); return $c5cacd; } function d82a3($k7a86c){ $c5cacd=a4c37(); return @$c5cacd[(int)$k7a86c/SECONDS_IN_A_MINUTE]; } function z9515($k7a86c){ $l04b29='+'; if ($k7a86c < 0)$l04b29='&ndash;'; $t73cdd=str_pad((int) (abs($k7a86c)/3600),2,'0',STR_PAD_LEFT); $g640fd=str_pad(abs($k7a86c)/60 % 60,2,'0',STR_PAD_LEFT); return 'GMT'. $l04b29.$t73cdd .':'. $g640fd; } function c9fe5($x0743a,$d5784d=''){ global$_strings; $c5cacd=a4c37(); $f2cb9d=''; if (!$d5784d)$d5784d=count($c5cacd); $f2cb9d.='<select name="offset" size="'. $d5784d .'">'; foreach ($c5cacd as $k7a86c => $q83bce){ $tc03a8=''; if ($k7a86c*SECONDS_IN_A_MINUTE==$x0743a)$tc03a8=' selected="selected"'; $f2cb9d.='<option'. $tc03a8 .' value="'.$k7a86c.'">'; $l04b29=''; if ($k7a86c < 0)$l04b29='−'; if ($k7a86c > 0)$l04b29='+'; $t73cdd=(int) (abs($k7a86c*SECONDS_IN_A_MINUTE)/3600); $g640fd=(int) (abs($k7a86c*SECONDS_IN_A_MINUTE)/60 % 60); if ($t73cdd){ $f2cb9d .= ( $l04b29 .' '. $t73cdd .' '. $_strings['gs--timezone-offset-hours'] .' '. ($g640fd? ($g640fd .' '. $_strings['gs--timezone-offset-minutes']) : '') ); if ($q83bce){ $f2cb9d .= ' ('. $q83bce. ')'; } } else { $f2cb9d .= $q83bce; } $f2cb9d.='</option>'; } $f2cb9d.='</select>'; return $f2cb9d; } function e2s_select_timezone(){ global$settings,$_strings; if (@$_POST['offset'] >= -720 and @$_POST['offset'] <= 780){ $settings['timezone']['offset'] = @$_POST['offset']*SECONDS_IN_A_MINUTE; $settings['timezone']['is_dst'] = isset ($_POST['is_dst']); } if (!@s6e52(USER_FOLDER.'settings.json',json_encode($settings,E2_JSON_STYLE))) { o8a40($_strings['er--settings-not-saved'],E2E_PERMISSIONS_ERROR); e2_go_to(i83c8('e2m_timezone')); die; } e2_go_to(i83c8('e2m_settings')) and die (); } function d0923($raad65){ return array ( 'offset' => (int)$raad65['Offset'], 'is_dst' => (bool)$raad65['IsDST'], ); } function v3211(){ return array ( 'offset' => 0, 'is_dst' => false, ); } function w5c05(){ global$settings; return$settings['timezone']; } function r7770($wb2c6c,$xdf491){ if (@$wb2c6c['is_dst']) { $e30481=(int)date('I',$xdf491); $f6b7ea=date('Z',$xdf491)-$e30481*SECONDS_IN_AN_HOUR; $b3e61a=$wb2c6c['offset']; $c178ae=$b3e61a-$f6b7ea; $c75b02=date('I',$xdf491+$c178ae); return $c75b02; } else { return 0; } } function cb2bf($wb2c6c,$xdf491){ global$settings; if ($wb2c6c and is_array($wb2c6c)) { return ( $wb2c6c['offset'] + r7770($wb2c6c,$xdf491)*SECONDS_IN_AN_HOUR ); } } function r8afe($xdf491){ return cb2bf(w5c05(),$xdf491); } function e5a2f($q1ddcb,$t4a202,$wb2c6c){ return gmdate($q1ddcb,$t4a202+cb2bf($wb2c6c,$t4a202)); } function aa846($q1ddcb,$t4a202){ return e5a2f($q1ddcb,$t4a202,w5c05()); } function d66cd($x41529,$r6f8f5=false,$u8277e=false){ if(is_numeric($u8277e)) { $dea2b2=gmmktime(0,0,0,$r6f8f5,$u8277e,$x41529); $m7f021=gmmktime(0,0,0,$r6f8f5,$u8277e+1,$x41529)-1; } elseif(is_numeric($r6f8f5)) { $dea2b2=gmmktime(0,0,0,$r6f8f5,1,$x41529); $m7f021=gmmktime(0,0,0,$r6f8f5+1,1,$x41529)-1; } else { $dea2b2=gmmktime(0,0,0,1,1,$x41529); $m7f021=gmmktime(0,0,0,1,1,$x41529+1)-1; } return array ($dea2b2,$m7f021); } function v2143($wb2c6c,$x41529,$r6f8f5=false,$u8277e=false){ list ($dea2b2,$m7f021)=d66cd($x41529,$r6f8f5,$u8277e); $dea2b2 -= cb2bf($wb2c6c,$dea2b2); $m7f021 -= cb2bf($wb2c6c,$m7f021); return array ($dea2b2,$m7f021); } function uac5b($x41529,$r6f8f5=false,$u8277e=false){ return v2143(w5c05(),$x41529,$r6f8f5,$u8277e); } function g5273($x41529,$r6f8f5=false,$u8277e=false){ $z32038=13; $zda4f0=-12; $z32038+=1; $zda4f0 -= 1; list ($dea2b2,$m7f021)=d66cd($x41529,$r6f8f5,$u8277e); $dea2b2 -= $z32038*3600; $m7f021 -= $zda4f0*3600; return array ($dea2b2,$m7f021); } function ud17a($k7a86c){ if ((int) @$k7a86c > 0) return (string)'+'.abs(@$k7a86c); elseif ((int) @$k7a86c < 0) return (string)'-'.abs(@$k7a86c); else return ''; } function bd536($xdf491,$oa0f0b=''){ $i2ab64=r8afe($xdf491); $l04b29=($i2ab64 >= 0)?'+':'-'; $i2ab64=abs($i2ab64); $u03c7c=$i2ab64 % 60; $i2ab64 -= $u03c7c; $r6f8f5=$i2ab64 % 3600/60; $i2ab64 -= $r6f8f5*60; $l2510c=$i2ab64/3600; if ($l2510c < 10)$l2510c='0'.$l2510c; if ($r6f8f5 < 10)$r6f8f5='0'.$r6f8f5; return $l04b29.$l2510c.$oa0f0b.$r6f8f5; } function ea618($baa759){ global$settings; if(is_numeric($baa759)) { $result['offset']=SECONDS_IN_A_MINUTE*$baa759; $result['is_dst']=false; $yd8935=SECONDS_IN_A_MINUTE*$baa759-SECONDS_IN_AN_HOUR; $za6cfc=array ('offset' => $yd8935,'is_dst' => true); $za6cfc=(int)cb2bf($za6cfc,time()); if($result['offset']==$za6cfc){ $result['offset']=$yd8935; $result['is_dst']=true; } } else { if(array_key_exists('timezone',$settings)) { $result=$settings['timezone']; } else { $result['offset']=0; $result['is_dst']=false; } } return$result; } function a692f($o96b8c){ $l2510c=aa846('H',$o96b8c); if ($l2510c <= 4) return 4; elseif ($l2510c <= 10) return 1; elseif ($l2510c <= 16) return 2; elseif ($l2510c <= 22) return 3; else return 4; } function b7a0b($v0e524,$cb65f7=null){ global$_strings; if ($cb65f7===null)$cb65f7=w5c05(); $hdb42a=e5a2f('d.m.Y',$j97bc5,$cb65f7); $v33284=e5a2f('d.m.Y',$v0e524,$cb65f7); $med79a=SECONDS_IN_A_MINUTE; $g77cbc=SECONDS_IN_AN_HOUR; $j97bc5=time(); $q0b375=a692f($j97bc5); $n3dfda=a692f($v0e524); $g74459=$j97bc5-$v0e524; if ($g74459 < 0) return$_strings['tt--from-the-future']; if ($g74459 >= 0 and $g74459 < 54) return$_strings['tt--just-now']; if ($g74459 >= 54 and $g74459 < 108) return$_strings['tt--one-minute-ago']; $x7eccb=$g74459+12; $g7828e=floor($x7eccb/$med79a); if ($g74459 >= 108 and $g74459 < 54*$med79a) return e2l_get_string( 'tt--minutes-ago', array ('minutes' => $g7828e) ); if ($g74459 >= 54*$med79a and $g74459 < 108*$med79a) return$_strings['tt--one-hour-ago']; $x7eccb=$g74459+12*$med79a; $e6b497=floor($x7eccb/$g77cbc); if ($g74459 >= 108*$med79a and $g74459 < 4*$g77cbc) return e2l_get_string( 'tt--hours-ago', array ('hours' => $e6b497) ); $l07cc6=e5a2f('G:i',$v0e524,$cb65f7); if ($g74459 >= 4*$g77cbc and $q0b375 > $n3dfda and $hdb42a==$v33284){ return$_strings['tt--today']; } if ((($j97bc5-$v0e524) <= 7884000)) { return e2l_get_string( 'tt--date', array ( 'day' => e5a2f('j',$v0e524,$cb65f7), 'month' => e5a2f('m',$v0e524,$cb65f7), ) ); } return e5a2f('Y',$v0e524,$cb65f7); } function s9093($v0e524,$cb65f7=null){ global$_strings; $g74459=time()-$v0e524; if ($g74459 < 0) return ''; if ($g74459==0) return$_strings['tt--now']; $zb98b3=array ( array (1,'tt--seconds-short'), array (SECONDS_IN_A_MINUTE,'tt--minutes-short'), array (SECONDS_IN_AN_HOUR,'tt--hours-short'), array (SECONDS_IN_A_DAY,'tt--days-short'), array (SECONDS_IN_A_MONTH,'tt--months-short'), array (SECONDS_IN_A_YEAR,'tt--years-short'), array (SECONDS_IN_A_YEAR+SECONDS_IN_A_MONTH,''), ); for ($d865c0=0; $d865c0 < count($zb98b3); ++ $d865c0){ if ($g74459 >= $zb98b3[$d865c0][0] and $g74459 < $zb98b3[$d865c0+1][0]) { return e2l_get_string( $zb98b3[$d865c0][1], array ('value' => floor($g74459/$zb98b3[$d865c0][0])) ); } } if ($cb65f7===null)$cb65f7=w5c05(); return e5a2f('Y',$v0e524,$cb65f7); } $_model_contractions=array ( 'key' => "INT UNSIGNED AUTO_INCREMENT PRIMARY KEY", 'pkey' => "INT UNSIGNED DEFAULT '0' NOT NULL", 'int' => "INT DEFAULT '0' NOT NULL", 'uint' => "INT UNSIGNED DEFAULT '0' NOT NULL", 'time' => "INT UNSIGNED DEFAULT '0' NOT NULL", '0' => "TINYINT(1) DEFAULT '0' NOT NULL", '1' => "TINYINT(1) DEFAULT '1' NOT NULL", 'v1' => "VARCHAR(1) DEFAULT '' NOT NULL", 'v8' => "VARCHAR(8) DEFAULT '' NOT NULL", 'v15' => "VARCHAR(15) DEFAULT '' NOT NULL", 'v32' => "VARCHAR(32) DEFAULT '' NOT NULL", 'v64' => "VARCHAR(64) DEFAULT '' NOT NULL", 'fid' => "VARCHAR(32) DEFAULT '". $_config['default_formatter'] ."' NOT NULL", 'v255' => "VARCHAR(255) DEFAULT '' NOT NULL", 'text' => "MEDIUMTEXT", ); $_model=array ( 'Actions' => array ( array ('ID', 'key'), array ('EntityID', 'pkey'), array ('Stamp', 'time'), array ('ReadCount', 'int'), ), 'Aliases' => array ( array ('ID', 'key'), array ('EntityType', 'v1'), array ('EntityID', 'pkey'), array ('Alias', 'v64'), array ('Stamp', 'time'), ), 'Comments' => array ( array ('ID', 'key'), array ('NoteID', 'pkey'), array ('AuthorName', 'v255'), array ('AuthorEmail', 'v255'), array ('Text', 'text'), array ('Reply', 'text'), array ('IsVisible', '1'), array ('IsFavourite', '0'), array ('IsReplyVisible', '0'), array ('IsReplyFavourite', '0'), array ('IsAnswerAware', '1'), array ('IsSubscriber', '0'), array ('IsSpamSuspect', '0'), array ('IsNew', '0'), array ('Stamp', 'time'), array ('LastModified', 'time'), array ('ReplyStamp', 'time'), array ('ReplyLastModified', 'time'), array ('IP', 'v15'), array ('IsGIPUsed', '0'), array ('GIP', 'v15'), array ('GIPAuthorID', 'v64'), ), 'Keywords' => array ( array ('ID', 'key'), array ('Keyword', 'v255'), array ('OriginalAlias', 'v64'), array ('Description', 'text'), array ('Uploads', 'text'), array ('IsFavourite', '0'), ), 'Notes' => array ( array ('ID', 'key'), array ('Title', 'v255'), array ('Text', 'text'), array ('FormatterID', 'fid'), array ('OriginalAlias', 'v64'), array ('Uploads', 'text'), array ('IsPublished', '0'), array ('IsCommentable', '0'), array ('IsVisible', '1'), array ('IsFavourite', '0'), array ('Stamp', 'time'), array ('LastModified', 'time'), array ('Offset', 'int'), array ('IsDST', '0'), array ('IsIndexed', '0'), array ('IsExternal', '0'), array ('SourceID', 'pkey'), array ('SourceNoteID', 'pkey'), array ('SourceNoteURL', 'v255'), array ('SourceNoteJSONURL', 'v255'), array ('SourceNoteData', 'text'), ), 'NotesKeywords' => array ( array ('ID', 'key'), array ('NoteID', 'pkey'), array ('KeywordID', 'pkey'), ), 'GIPsSessions' => array ( array ('ID', 'key'), array ('GIP', 'v15'), array ('GIPAuthorID', 'v64'), array ('AuthorName', 'v255'), array ('AuthorEmail', 'v255'), array ('AuthorProfileLink', 'v255'), array ('SessionToken', 'v255'), array ('Stamp', 'time'), ), 'Sources' => array ( array ('ID', 'key'), array ('TrueID', 'pkey'), array ('Title', 'v255'), array ('AuthorName', 'v255'), array ('URL', 'v255'), array ('PictureURL', 'v255'), array ('IsWhiteListed', '0'), array ('IsTrusted', '0'), ), ); $_model_indexes=array ( 'Actions' => array ( "UNIQUE INDEX (`EntityID`, `Stamp`)", ), 'Aliases' => array ( "INDEX (`Alias`)", "INDEX (`EntityID`)", ), 'Comments' => array ( "INDEX (`NoteID`)", ), 'Keywords' => array (), 'GIPsSessions' => array ( "UNIQUE INDEX (`GIP`, `GIPAuthorID`)" ), 'Notes' => array ( "FULLTEXT (`Title`, `Text`)", "INDEX (`Stamp`)", "INDEX (`SourceID`)", "INDEX (`SourceNoteID`)", ), 'NotesKeywords' => array ( "INDEX (`NoteID`)", ), ); $_model_minimal_table_list=array ( 'Comments', 'Keywords', 'Notes', 'NotesKeywords', ); function e2_model_data_check($n11e0e){ global$_db,$_model,$_model_minimal_table_list,$_config; $d08cfc=false; $r35f9b=array(); $pac5c7='SHOW TABLES FROM `'. mysqli_real_escape_string($_db['link'],$n11e0e). '`'; $result=mysqli_query($_db['link'],$pac5c7); if($result){ while ($ef1965=mysqli_fetch_row($result)) { foreach(array_keys($_model) as $dd2ffa){ if(strcasecmp($ef1965[0],$_config['db_table_prefix'].$dd2ffa)===0){ $d08cfc=true; $r35f9b[] = $dd2ffa; } } } } $cd9a22=true; foreach(array_keys($_model) as $dd2ffa){ if (!in_array($dd2ffa,$r35f9b)) { $cd9a22=false; } } $g7ec6f=true; foreach($_model_minimal_table_list as $dd2ffa){ if (!in_array($dd2ffa,$r35f9b)) { $g7ec6f=false; } } return array ( 'occupied' => $d08cfc, 'complete' => $cd9a22, 'migrateable' => $g7ec6f, ); } function nb154($vcf1e8,$kee11c,$r5f4dc){ $a32e95=array(); if (($z2a304=mysqli_connect($vcf1e8,$kee11c,$r5f4dc)) !== false){ $result=mysqli_query($z2a304,"SHOW DATABASES"); while ($ef1965=mysqli_fetch_row($result)) { if ( mysqli_select_db($z2a304,$ef1965[0]) and !in_array($ef1965[0], array ('information_schema','mysql')) ) { $a32e95[] = $ef1965[0]; } } } return $a32e95; } function z55fd(){ global$_db,$_model,$_config; $x78940['server'] = @$_POST['db-server']; $x78940['user_name'] = @$_POST['db-user']; $x78940['passw'] = g1305(@$_POST['db-password']); $x78940['name'] = @$_POST['db-database']; $result=qb1ac('check database from HTTP post',$x78940); if($result!==true){ $result=$result['exception-name']; if($result==='AeMySQLConnectTimeoutException') return 'no-connect'; if($result==='AeMySQLAccessDeniedException') return 'server-responding'; if($result==='AeMySQLCannotConnectException') return 'no-connect'; if($result==='AeMySQLTooOldException') return 'server-responding'; if (!$x78940['name']) { $a32e95=nb154( $x78940['server'],$x78940['user_name'],$x78940['passw'] ); $x78940['name']=$a32e95[0]; } $result=qb1ac('check database from HTTP post',$x78940); } if($result!==true){ return 'server-lets-in'; } $kaae42=e2_model_data_check($x78940['name']); if ($kaae42['occupied'] and $kaae42['migrateable']) { return 'bingo-data-exists'; } elseif ($kaae42['occupied']) { return 'data-incomplete'; } else { return 'bingo'; } } function n4e1c($paab9e){ global$_config; a0738( "SHOW TABLES LIKE '". $_config['db_table_prefix'].$paab9e . "'" ); $j9b207=z0d6b(); return count($j9b207) > 0; } function p07e3($paab9e,$u851f5=null){ global$_config; if ($u851f5===null){ $u851f5=$_config['db_table_prefix']; } a0738( "SHOW TABLE STATUS LIKE '". $u851f5.$paab9e . "'" ); $result=z0d6b(); return$result?$result[0] : []; } function ff1ac($paab9e){ global$_model,$_model_contractions,$_model_indexes,$_config,$_db; if (!array_key_exists($paab9e,$_model)) throw new AeModelUnknownTableException(); if (n4e1c($paab9e)) return; $u851f5=$_config['db_table_prefix']; $r54ca8=array(); foreach($_model[$paab9e] as $o1afd3){ list ($eb0689,$type)=$o1afd3; $r54ca8[] = "`". $eb0689 ."` ". $_model_contractions[$type]; } a0738( "CREATE TABLE `". $u851f5.$paab9e ."` ". "(". implode(" ,",$r54ca8) .") ". "ENGINE=MyISAM DEFAULT CHARSET=". $_db['charset'] ); if(is_array(@$_model_indexes[$paab9e])) { foreach($_model_indexes[$paab9e] as $w6a992){ a0738( "ALTER TABLE `". $u851f5.$paab9e ."` ". "ADD ". $w6a992 ); } } } function x9943($paab9e,$gde17f,$cb512d='INSERT',$k07ccf=''){ global$_config,$_db; foreach ($gde17f as $c8ce4b => $i9e366){ $b10249=c7928($i9e366); if ($b10249[0]=='`'){ $gbcf11=$b10249; } else { $gbcf11="'". $b10249 ."'"; } $u8688e[$c8ce4b]=$gbcf11; } $xd05b6="`". implode("`, `",array_keys($u8688e)). "`"; $cf09cc=implode(", ",array_values($u8688e)); a0738( $cb512d ." INTO `". $_config['db_table_prefix'].$paab9e ."` ". "(".$xd05b6 .") VALUES (". $cf09cc .")". ($k07ccf? (' '. $k07ccf):'') ); $gde17f['ID']=mysqli_insert_id($_db['link']); return $gde17f; } function taa79($paab9e,$gde17f,$m7692d=false,$u0f543=false){ global$_config,$_e2_day_numbers_by_note_id; $_e2_day_numbers_by_note_id=[]; if(Log::$ned2b5)__log('Model: update record in table '. $paab9e .' {'); $g6a7f2=array(); foreach(e2model__soft_fields_for_table_($paab9e) as $k06e3d){ if(array_key_exists($k06e3d,$gde17f)) { $b10249=c7928($gde17f[$k06e3d]); if ($b10249[0]=='`'){ $gbcf11=$b10249; } else { $gbcf11="'". $b10249 ."'"; } $g6a7f2[] = '`'. $k06e3d .'`'."=". $gbcf11 .""; } } $fb5b39=array(); if(is_array($m7692d)) { foreach(e2model__soft_fields_for_table_($paab9e) as $k06e3d){ if(array_key_exists($k06e3d,$m7692d)) { $fb5b39[] = '`'. $k06e3d .'`'."='". c7928($m7692d[$k06e3d]) ."'"; } } } if(count($fb5b39)) { $y56790=implode(" AND ",$fb5b39); } else { if (!array_key_exists('ID',$gde17f) or !is_numeric($gde17f['ID'])) { if(Log::$ned2b5)__log('Error: e2_update_record must be called with an ID field in $record when updating single row'); return false; } $y56790="`ID`=". $gde17f['ID']; } if(count($g6a7f2) > 0){ $j91179=$u0f543? 'LOW_PRIORITY ':''; a0738( "UPDATE ". $j91179 ."`". $_config['db_table_prefix'].$paab9e ."` ". "SET ". implode(', ',$g6a7f2) ." WHERE ". $y56790 ); } if(Log::$ned2b5)__log('}'); return true; } function e2model__soft_fields_for_table_($paab9e){ global$_model; $f2cb9d=array(); if(array_key_exists($paab9e,$_model)) { foreach($_model[$paab9e] as $k06e3d){ if (!in_array($k06e3d[1], array ('key'))) { $f2cb9d[] = $k06e3d[0]; } } } return $f2cb9d; } function e2m_install(){ global$_strings,$_superconfig,$_files_written,$_diagnose; if(e2_get_instance()!==null)e2_go_to() and die; zdb82(DEFAULT_TEMPLATE); $f2cb9d=array(); if($_superconfig['disallow_installer']) { die ('Installer disabled by superconfig'); } if(Log::$ned2b5)__log('Installer: not installed, present user with form'); $pe26af=true; $kd77d5['server'] = @$_COOKIE[p8c3b('install_db_server')]; $kd77d5['user_name'] = @$_COOKIE[p8c3b('install_db_user_name')]; $kd77d5['passw']=aee85(@$_COOKIE[p8c3b('install_db_passw')]); $kd77d5['name'] = @$_COOKIE[p8c3b('install_db_name')]; if (!@isset ($_diagnose['ok?']))i8739(); if (!$_diagnose['ok?']) { if(Log::$ned2b5)__log('Installer: problems, tell user'); $pe26af=false; } $f2cb9d=[ 'title' => $_strings['pt--install'], 'heading' => $_strings['pt--install'], 'form-install' => [ 'form-action' => i83c8('e2s_install'), 'form-check-db-config-action' => i83c8('e2j_check_db_config'), 'form-list-databases-action' => i83c8('e2j_list_databases'), 'installation-possible?' => $pe26af, 'submit-text' => $_strings['fb--begin'], 'retry-text' => $_strings['fb--retry'], 'db-server' => htmlspecialchars(@$kd77d5['server']? $kd77d5['server']:'localhost'), 'db-user' => htmlspecialchars(@$kd77d5['user_name']? $kd77d5['user_name']:'root'), 'db-password' => '', 'db-database' => htmlspecialchars(@$kd77d5['name']), ] ]; return $f2cb9d; } function e2_get_instance(){ static $z7123a=null; if ($z7123a===null){ $z7123a=@unserialize( @file_get_contents(USER_FOLDER.'instance.psa') ) or $z7123a=null; } return $z7123a; } function e2_instantiate($a2af72){ static $z7123a=null; $z7123a=e2_get_instance(); $z7123a['version']=$a2af72; if (s6e52(USER_FOLDER. '/instance.psa',serialize($z7123a))) { return $z7123a; } else { die ('Cannot instantiate v'. $a2af72 .': probably permission denied'); } } function e2s_instantiate($parameters){ global$_strings; if(e2_get_instance()!==null){ die ('Remove the file "'. USER_FOLDER .'instance.psa" first'); } else { if(is_numeric($parameters['version'])) { if(e2_instantiate($parameters['version'])) { o8a40($_strings['gs--instantiated-version'] .' v'. $parameters['version'],E2E_MESSAGE); e2_go_to(i83c8('e2m_frontpage', array ('page' => 1))); die; } } } die ('Could not create instance of engine'); } function e2s_install(){ global$settings,$_strings,$_config,$wfd6b1,$_folders_written; if(e2_get_instance()!==null)e2_go_to() and die; if($_config['log_installs']) { Log::$ned2b5=true; if(Log::$ned2b5)l714a('install-$'); } e2_drop_all_kinds_of_cache(); $x78940['server'] = @$_POST['db-server']; $x78940['user_name'] = @$_POST['db-user']; $x78940['passw'] = g1305(@$_POST['db-password']); $x78940['name'] = @$_POST['db-database']; $result=qb1ac('check database during installation',$x78940); if($result!==true){ o8a40($result['error-string'],E2E_DATABASE_ERROR); e2_go_to(i83c8('e2m_install')); die; } $kaae42=e2_model_data_check($x78940['name']); $s0e88b=false; if ($kaae42['occupied'] and $kaae42['migrateable']) { if(Log::$ned2b5)__log('Installer: DB data exists and migrateable'); $s0e88b=true; } elseif ($kaae42['occupied']) { if(Log::$ned2b5)__log('Installer: DB data exists, but incomplete'); o8a40($_strings['er--db-data-incomplete'],E2E_DATABASE_ERROR); e2_go_to(i83c8('e2m_install')); die; } $wb2c6c=ea618(@$_POST['browser-offset']); foreach ($x78940 as $c8ce4b => $i9e366){ ec64a('install_db_' .$c8ce4b,$i9e366); } @session_start(); if (!array_key_exists('password',$_POST) or trim($_POST['password']) == ''){ o8a40($_strings['er--no-password-entered'],E2E_USER_ERROR); e2_go_to(i83c8('e2m_install')); die; } $s88162=trim($_POST['password']); $x2d6d8['sessions'] = array (array ( 'stamp' => time(), 'remote_ip' => $_SERVER['REMOTE_ADDR'], 'key_hash' => qe8ed(true), 'ua' => $_SERVER['HTTP_USER_AGENT'], )); $c444bc=true; if (!p1d21($x2d6d8)) { o8a40($_strings['er--cannot-write-auth-data'],E2E_PERMISSIONS_ERROR); $c444bc=false; } if (!@s6e52(USER_FOLDER.'password-hash.psa',serialize(d4c49($s88162)))) { o8a40($_strings['er--settings-not-saved'],E2E_PERMISSIONS_ERROR); $c444bc=false; } if (!$s0e88b){ $settings=array(); } $settings['db']=$x78940; $settings['timezone']=$wb2c6c; $settings['template']=DEFAULT_TEMPLATE; $settings['language']=DEFAULT_LANGUAGE; if (!@s6e52(USER_FOLDER.'settings.json',json_encode($settings,E2_JSON_STYLE))) { o8a40($_strings['er--settings-not-saved'],E2E_PERMISSIONS_ERROR); $c444bc=false; } if ($c444bc){ if(Log::$ned2b5)__log('Installer: force directories'); foreach($_folders_written as $p45684){ @naf42($p45684); } if ($s0e88b){ if(Log::$ned2b5)__log('Installer: No need to create DB; migrate'); try { pbb8d(); } catch (AeMySQLException $e){ c12f6($ae1671,'Could not migrate'); o8a40($_strings['er--double-check-db-params']); } } else { if(Log::$ned2b5)__log('Installer: Creating DB...'); ff1ac('Notes'); ff1ac('Comments'); ff1ac('Keywords'); ff1ac('NotesKeywords'); ff1ac('Aliases'); ff1ac('Actions'); ff1ac('Sources'); ff1ac('GIPsSessions'); } if(Log::$ned2b5)__log('Installer: Search index...'); $hddece=b476c(); try { $hddece -> erase(); } catch (\S2\Rose\Exception\RuntimeException $e){ if(Log::$ned2b5)__log('Installer: Rose not available'); } s198f(); if(Log::$ned2b5)__log('Installer: DB OK, instantiating...'); e2_instantiate(E2_VERSION); if(Log::$ned2b5)__log('Installer: Done'); if(Log::$ned2b5)__log('Installer: Complete'); rcc38(i83c8('e2s_bsi_step', array ())); e2_go_to(); die; } else { e2_go_to(i83c8('e2m_install')); die; } } function e2_make_sure_that_installed(){ global $z57de2,$da57c1,$_superconfig,$_config; $z7123a=e2_get_instance(); if(e2_get_instance()!==null){ if(E2_VERSION < $z7123a ['version']) { if (@$_config['dev_ignore_version_mismatch']) return; if(Log::$ned2b5)__log('Installer: cannot downdate'); header('HTTP/1.1 503 Service Unavailable'); die ('E2 does not support automatic downgrade.'); } elseif(E2_VERSION > $z7123a ['version']) { if(Log::$ned2b5)__log('Installer: need to update'); header('Location: http://'. $z57de2.$da57c1 .'/perform_update/'); header('Location: '. i83c8('e2s_update_perform')); die; } else { return; } } if(Log::$ned2b5)__log('Installer: not installed {'); if ((strpos($_SERVER['SERVER_SOFTWARE'],'Apache')===0)) { if(Log::$ned2b5)__log('Installer: running on Apache'); $xefe79=DEFAULTS_FOLDER.'default.htaccess'; $sd5c54=false; if (!is_file($xefe79)) { echo 'File not found: '.$xefe79. '. Please use the full E2 installation package.'; die; } if(is_file('.htaccess')) { if(Log::$ned2b5)__log('Installer: there is a .htaccess file in the installation directory'); $he6f97=file_get_contents($xefe79); $dc6680=file_get_contents('.htaccess'); if ($dc6680!=$he6f97){ $sd5c54=true; $g6a9d4=$md1813='.htaccess.old'; $a3c549=1; while (is_file($md1813)) { $md1813=$g6a9d4 .'.'. $a3c549 ++; } if(Log::$ned2b5)__log('Installer: existing .htaccess wrong, backing up as <'. $md1813 .'>'); if (!@rename('.htaccess',$md1813)) { if(Log::$ned2b5)__log('Installer: fuck'); echo 'Looks like you are using Apache and have put an incorrect ".htaccess" file in the installation directory. Additionally, the installer was not able to back up your existing ".htaccess" file in order to replace it with the correct one. Please use the full E2 installation package and grant write access on the installation target directory, all the files and subdirectories.'; die; } } } else { $sd5c54=true; } if ($sd5c54){ if(Log::$ned2b5)__log('Installer: writing a correct .htaccess file'); if (!@copy($xefe79,'.htaccess')) { if(Log::$ned2b5)__log('Installer: fuck'); echo 'The installer was not able to create a correct ".htaccess" file. Please grant write access on the installation target directory.'; die; } } } if($_superconfig['disallow_installer']) { die ('Not installed'); } else { $z601f0=i83c8('e2m_install'); if(Log::$ned2b5)__log('Installer: will need to install, going to '. $z601f0); if(Log::$ned2b5)__log('}'); e2_go_to($z601f0); die; } } function e2j_check_db_config(){ echo z55fd(); die; } function e2j_list_databases(){ $vcf1e8=$kee11c=$r5f4dc=''; if(array_key_exists('db-server',$_POST)) $vcf1e8= $_POST['db-server']; if(array_key_exists('db-user',$_POST)) $kee11c= $_POST['db-user']; if(array_key_exists('db-password',$_POST))$r5f4dc=$_POST['db-password']; $a32e95=nb154($vcf1e8,$kee11c,$r5f4dc); if ($a32e95) die (implode('|',$a32e95)); die; } function pbb8d(){ global$_db,$_config,$_model; $u851f5=$_config['db_table_prefix']; a0738('SET sql_quote_show_create=1'); if($_db['charset']==='utf8mb4'){ if(Log::$ned2b5)__log('Convert tables to utf8 or utf8mb4 {'); yb01c($u851f5); if(Log::$ned2b5)__log('}'); } else { if(Log::$ned2b5)__log('Convert tables to utf8 or utf8 {'); udb59($u851f5); if(Log::$ned2b5)__log('}'); } if(Log::$ned2b5)__log('Get existing table information {'); foreach(array_keys($_model) as $paab9e){ ff1ac($paab9e); try { a0738("SHOW CREATE TABLE `". $u851f5.$paab9e ."`"); $f4fded[$paab9e]=z0d6b(); $f4fded[$paab9e]=$f4fded[$paab9e][0]['Create Table']; } catch (AeMySQLException $e){ c12f6($ae1671); die ('Database table "'. $u851f5 .$paab9e .'" not accessible during migration. Check your database availability'); } a0738("SHOW INDEX FROM `". $u851f5.$paab9e ."`"); $n62699=z0d6b(); $x43eef=array(); foreach ($n62699 as $w6a992){ $w6a992=$w6a992['Key_name']; if(preg_match('/\_[0-9]+$/',$w6a992)) { $x43eef[] = 'DROP INDEX '. $w6a992; } } if(count($x43eef)) { $x43eef=implode(', ',array_unique($x43eef)); a0738( "ALTER TABLE  `". $u851f5.$paab9e ."` ". $x43eef ); } } if(Log::$ned2b5)__log('}'); if (!strstr($f4fded['Notes'],'`FormatterID`')) { a0738( "ALTER TABLE `". $u851f5."Notes` ". "ADD `FormatterID` VARCHAR( 32 ) DEFAULT 'calliope' NOT NULL AFTER `Text`" ); } if (!strstr($f4fded['Notes'],'`OriginalAlias`')) { a0738( "ALTER TABLE `". $u851f5."Notes` ". "CHANGE `URLName` `OriginalAlias` VARCHAR( 64 ) DEFAULT '' NOT NULL AFTER `FormatterID`" ); } if (!strstr($f4fded['Notes'],'KEY `Stamp` (`Stamp`)')) { a0738( "ALTER TABLE `". $u851f5."Notes` ". "ADD INDEX (`Stamp`);" ); } if(strstr($f4fded['Notes'],'`IP`')) { a0738( "ALTER TABLE `". $u851f5."Notes` ". "DROP `IP`" ); } a0738( "ALTER TABLE `". $u851f5."Notes` ". "CHANGE `Text` `Text` MEDIUMTEXT" ); if (!strstr($f4fded['Notes'],'`IsIndexed`')) { a0738( "ALTER TABLE `". $u851f5."Notes` ". "ADD `IsIndexed` TINYINT( 1 ) DEFAULT '0' NOT NULL AFTER `IsDST`" ); } if (!strstr($f4fded['Notes'],'`Uploads`')) { a0738( "ALTER TABLE `". $u851f5."Notes` ". "ADD `Uploads` MEDIUMTEXT AFTER `OriginalAlias`" ); } a0738( "ALTER TABLE `". $u851f5."Notes` ". "CHANGE `Uploads` `Uploads` MEDIUMTEXT" ); if (!strstr($f4fded['Notes'],'`IsExternal`')) { a0738( "ALTER TABLE `". $u851f5."Notes` ". "ADD `IsExternal` TINYINT(1) DEFAULT '0' NOT NULL AFTER `IsIndexed`" ); } if (!strstr($f4fded['Notes'],'`SourceID`')) { a0738( "ALTER TABLE `". $u851f5."Notes` ". "ADD `SourceID` INT UNSIGNED DEFAULT '0' NOT NULL AFTER `IsExternal`" ); } if (!strstr($f4fded['Notes'],'`SourceNoteID`')) { a0738( "ALTER TABLE `". $u851f5."Notes` ". "ADD `SourceNoteID` INT UNSIGNED DEFAULT '0' NOT NULL AFTER `SourceID`" ); } if (!strstr($f4fded['Notes'],'`SourceNoteURL`')) { a0738( "ALTER TABLE `". $u851f5."Notes` ". "ADD `SourceNoteURL` VARCHAR(255) DEFAULT '' NOT NULL AFTER `SourceNoteID`" ); } if (!strstr($f4fded['Notes'],'`SourceNoteData`')) { a0738( "ALTER TABLE `". $u851f5."Notes` ". "ADD `SourceNoteData` MEDIUMTEXT AFTER `SourceNoteURL`" ); } if (!strstr($f4fded['Notes'],'`SourceNoteJSONURL`')) { a0738( "ALTER TABLE `". $u851f5."Notes` ". "ADD `SourceNoteJSONURL` VARCHAR(255) DEFAULT '' NOT NULL AFTER `SourceNoteData`" ); } if(strstr($f4fded['Notes'],'`SourceMainImageURL`')) { a0738( "ALTER TABLE `". $u851f5."Notes` ". "DROP `SourceMainImageURL`" ); } if(strstr($f4fded['Notes'],'`IsIssue`')) { a0738( "ALTER TABLE `". $u851f5."Notes` ". "DROP `IsIssue`" ); } if (!strstr($f4fded['Notes'],'KEY `SourceID` (`SourceID`)')) { a0738( "ALTER TABLE `". $u851f5."Notes` ". "ADD INDEX (`SourceID`);" ); } if (!strstr($f4fded['Notes'],'KEY `SourceNoteID` (`SourceNoteID`)')) { a0738( "ALTER TABLE `". $u851f5."Notes` ". "ADD INDEX (`SourceNoteID`);" ); } if (!strstr($f4fded['Comments'],'KEY `NoteID` (`NoteID`)')) { a0738( "ALTER TABLE `". $u851f5."Comments` ". "ADD INDEX (`NoteID`);" ); } a0738( "ALTER TABLE `". $u851f5."Comments` ". "CHANGE `Text` `Text` MEDIUMTEXT" ); a0738( "ALTER TABLE `". $u851f5."Comments` ". "CHANGE `Reply` `Reply` MEDIUMTEXT" ); if (!strstr($f4fded['Comments'],'`IsGIPUsed`')) { a0738( "ALTER TABLE `". $u851f5."Comments` ". "ADD `IsGIPUsed` TINYINT(1) DEFAULT '0' NOT NULL AFTER `IP`" ); } if (!strstr($f4fded['Comments'],'`GIP`')) { a0738( "ALTER TABLE `". $u851f5."Comments` ". "ADD `GIP` VARCHAR(15) DEFAULT '' NOT NULL AFTER `IsGIPUsed`" ); } if (!strstr($f4fded['Comments'],'`GIPAuthorID`')) { a0738( "ALTER TABLE `". $u851f5."Comments` ". "ADD `GIPAuthorID` VARCHAR(64) DEFAULT '' NOT NULL AFTER `GIP`" ); } if(strstr($f4fded['Comments'],'`SocialType`')) { a0738( "ALTER TABLE `". $u851f5."Comments` ". "DROP `SocialType`" ); } if(strstr($f4fded['Comments'],'`SocialID`')) { a0738( "ALTER TABLE `". $u851f5."Comments` ". "DROP `SocialID`" ); } if (!strstr($f4fded['Keywords'],'`OriginalAlias`')) { a0738( "ALTER TABLE `". $u851f5."Keywords` ". "CHANGE `URLName` `OriginalAlias` VARCHAR( 64 ) DEFAULT '' NOT NULL AFTER `Keyword`" ); } a0738( "ALTER TABLE `". $u851f5."Keywords` ". "CHANGE `Description` `Description` MEDIUMTEXT" ); if (!strstr($f4fded['Keywords'],'`Uploads`')) { a0738( "ALTER TABLE `". $u851f5."Keywords` ". "ADD `Uploads` MEDIUMTEXT AFTER `Description`" ); } a0738( "ALTER TABLE `". $u851f5."Keywords` ". "CHANGE `Uploads` `Uploads` MEDIUMTEXT" ); if(strstr($f4fded['Keywords'],'`ParentKeywordID`')) { a0738( "ALTER TABLE `". $u851f5."Keywords` ". "DROP `ParentKeywordID`" ); } if (!strstr($f4fded['Aliases'],'KEY `Alias` (`Alias`)')) { a0738( "ALTER TABLE `". $u851f5."Aliases` ". "ADD INDEX (`Alias`);" ); } if (!strstr($f4fded['Aliases'],'KEY `EntityID` (`EntityID`)')) { a0738( "ALTER TABLE `". $u851f5."Aliases` ". "ADD INDEX (`EntityID`);" ); } if (!strstr($f4fded['Aliases'],'`EntityType`')) { a0738( "ALTER TABLE `". $u851f5."Aliases` ". "ADD `EntityType` VARCHAR( 1 ) DEFAULT '' NOT NULL AFTER `ID`" ); } a0738( "UPDATE `". $u851f5."Aliases` ". "SET `EntityType` = 'n' ". "WHERE `EntityType` = ''" ); if (!strstr($f4fded['Actions'],'`ReadCount`')) { a0738( "ALTER TABLE `". $u851f5."Actions` ". "ADD `ReadCount` INT DEFAULT '0' NOT NULL" ); } if(strstr($f4fded['Actions'],'`HitCount`')) { a0738( "ALTER TABLE `". $u851f5."Actions` ". "DROP `HitCount`" ); a0738( "DELETE FROM `". $u851f5."Actions` ". "WHERE `ReadCount` = 0" ); } if (!strstr($f4fded['GIPsSessions'],'`AuthorEmail`')) { a0738( "ALTER TABLE `". $u851f5."GIPsSessions` ". "ADD `AuthorEmail` VARCHAR(255) DEFAULT '' NOT NULL AFTER `AuthorName`" ); } if (!strstr($f4fded['GIPsSessions'],'`AuthorProfileLink`')) { a0738( "ALTER TABLE `". $u851f5."GIPsSessions` ". "ADD `AuthorProfileLink` VARCHAR(255) DEFAULT '' NOT NULL AFTER `AuthorEmail`" ); } if (!strstr($f4fded['Sources'],'`TrueID`')) { a0738( "ALTER TABLE `". $u851f5."Sources` ". "ADD `TrueID` INT UNSIGNED DEFAULT '0' NOT NULL AFTER `ID`" ); a0738( "UPDATE `". $u851f5."Sources` ". "SET `TrueID` = `ID`" ); } return true; } function udb59($u851f5){ global$_model; foreach(array_keys($_model) as $dd2ffa){ $e4b43b=p07e3($dd2ffa,$u851f5); if ($e4b43b){ $vd89e2=$e4b43b['Collation']; if ($vd89e2!='utf8_general_ci'){ if(Log::$ned2b5)__log('Migrate: Convert table '. $dd2ffa. ' to utf8'); a0738( "ALTER TABLE `". $u851f5.$dd2ffa ."` ". "CONVERT TO CHARACTER SET utf8 COLLATE utf8_general_ci" ); } } } } function e2mig__queries_to_recreate_indexes_for_table_($paab9e){ $qf78dd=$h4f12d=[]; $t7694f=( "SELECT s.column_name, s.table_name, s.index_name, s.non_unique ". "FROM information_schema.statistics s ". " JOIN information_schema.columns USING (table_name, table_schema, column_name) ". " JOIN information_schema.tables USING (table_name, table_schema) ". "WHERE s.table_schema = DATABASE() AND engine = 'InnoDB' ". " AND column_type like '%varchar%' AND table_name='".$paab9e."'" ); a0738($t7694f); foreach (z0d6b() as $ef1965){ $qf78dd[] = sprintf( "DROP INDEX %s ON %s", $ef1965['index_name'], $ef1965['table_name'] ); $h4f12d[] = sprintf( "CREATE %s INDEX %s ON %s(%s(191))", $ef1965['non_unique']?'':'UNIQUE', $ef1965['index_name'], $ef1965['table_name'], $ef1965['column_name'] ); } return array ($qf78dd,$h4f12d); } function yb01c($u851f5){ global$_model,$_db; $q752cb=pd372(); foreach ($q752cb as $c8ce4b => $i9e366){ $q752cb[$c8ce4b]=SEARCH_EXTRA_PREFIX. $i9e366; } $l0b95a=array_merge( array_keys($_model), array_values($q752cb) ); $qf78dd=$h4f12d=null; foreach ($l0b95a as $dd2ffa){ if(Log::$ned2b5)__log('Migrate: Convert table '. $dd2ffa. ' to utf8mb4?'); $e4b43b=p07e3($dd2ffa,$u851f5); if ($e4b43b){ $vd89e2=$e4b43b['Collation']; if(stripos($vd89e2,'utf8mb4')!==0){ list ( $qf78dd, $h4f12d )=e2mig__queries_to_recreate_indexes_for_table_($u851f5.$dd2ffa); if ($qf78dd!==null){ if(Log::$ned2b5){ __log('Migrate: Drop indexes of table '. $dd2ffa); } foreach ($qf78dd as $peaf65){ a0738($peaf65); } } if(Log::$ned2b5){ __log('Migrate: Convert table '. $dd2ffa. ' to UTF8MB4'); } a0738( "ALTER TABLE `". $u851f5.$dd2ffa ."` ". "CONVERT TO CHARACTER SET utf8mb4" ); if ($h4f12d!==null){ if(Log::$ned2b5){ __log('Migrate: Recreate indexes of table '.$dd2ffa); } foreach ($h4f12d as $j2464f){ a0738($j2464f); } } } } } } function e2s_migrate(){ pbb8d(); die ('Database migration finished.'); } function e2s_update_perform(){ global$_model,$settings,$_config,$_diagnose; $z7123a=e2_get_instance(); $md98a0=max((int) ($z7123a['version']), 2285); if ($z7123a['version']==E2_VERSION){ x4930(); die; } if($_config['log_updates']) { Log::$ned2b5=true; if(Log::$ned2b5)l714a('update-$'); } if(Log::$ned2b5)__log('Update from v'. $md98a0 .' to v'. E2_VERSION.' {'); if ($md98a0 < 2587){ fc5a6('caches/*'); rmdir('caches'); } if ($md98a0 < 2691){ $settings=e2_utf8_version_of_array_($settings); if (!@s6e52(USER_FOLDER.'settings.json',json_encode($settings,E2_JSON_STYLE))) { o8a40($_strings['er--cannot-save-data'],E2E_PERMISSIONS_ERROR); b4006(); } } if ($md98a0 < 2921){ $settings['template']='plain'; } if ($md98a0 < 3223){ $settings['v3223_rss_permalinks_before_stamp']=time(); } if ($md98a0 < 3354){ @rename('pictures/userpics/',AVATARS_FOLDER); @unlink(USER_FOLDER. 'password-reset.txt'); } @unlink(USER_FOLDER. 'last-update.psa'); @unlink(CACHES_FOLDER.'index.xml'); @naf42(CACHES_FOLDER); @naf42(BACKUP_FOLDER); @naf42(MEDIA_ROOT_FOLDER.PICTURES_FOLDER .'remote/'); @naf42(MEDIA_ROOT_FOLDER.THUMBNAILS_FOLDER .'remote/'); if (@$settings['template']=='')$settings['template']=DEFAULT_TEMPLATE; if (isset ($settings['appearance']['hot_frontpage'])) { unset($settings['appearance']['hot_frontpage']); } if (isset ($settings['db']['table_prefix'])) { if($settings['db']['table_prefix'] != @$_config['db_table_prefix']) { die ('You’ve been using a database with a table prefix “'. $settings['db']['table_prefix'] .'”. Now this should be set in the configuration. Please add the following line to the file user/config.php:<br /><br />$_config[\'db_table_prefix\'] = \''. $settings['db']['table_prefix'] .'\';<br /><br />Then refresh this page.'); } else { unset($settings['db']['table_prefix']); } } if (isset ($settings['comments']['on'])) { if (!$settings['comments']['on']) { try { a0738( "UPDATE LOW_PRIORITY `". $_config['db_table_prefix']."Notes` ". "SET `IsCommentable`=0" ); } catch (AeMySQLException $e){} } $settings['comments']['default_on'] = (bool)$settings['comments']['on']; unset($settings['comments']['on']); } if ( is_file(USER_FOLDER.'settings.json') and is_file(USER_FOLDER.'settings.psa') ) { @unlink(USER_FOLDER.'settings.psa'); } if (!@s6e52(USER_FOLDER.'settings.json',json_encode($settings,E2_JSON_STYLE))) { o8a40($_strings['er--cannot-save-data'],E2E_PERMISSIONS_ERROR); } e2_drop_all_kinds_of_cache(); pbb8d(); if ($md98a0 < 3386){ if (ga521()) { $hddece=b476c(); try { $hddece -> erase(); } catch (\S2\Rose\Exception\RuntimeException $e){ if(Log::$ned2b5)__log('Rose not available'); } } s198f(); } $_diagnose['need?']=true; ec64a('diagnose','1'); $z7123a=e2_instantiate(E2_VERSION); if(Log::$ned2b5)__log('}'); if (ge852()) { o8a40(e2l_get_string('gs--updated-successfully', array ( 'from' => 'v'. $md98a0, 'to' => 'v'. $z7123a['version'], )), E2E_MESSAGE); } e2_go_to(); die; } define('E2_MYSQL_CONNECT_TIMEOUT',1); function m985b(string $nfa48c='',$x78940=null){ static $u060d3=false; global$settings,$_db; if ($x78940===null)$x78940=$settings['db']; $cd51e8=mysqli_init(); $cd51e8 -> options(MYSQLI_OPT_CONNECT_TIMEOUT,E2_MYSQL_CONNECT_TIMEOUT); $h06aa6=@mysqli_real_connect( $cd51e8, 'p:'. $x78940['server'], $x78940['user_name'], aee85($x78940['passw']) ); if (!$h06aa6){ $c70106=mysqli_connect_errno(); if ($c70106==2002){ throw new AeMySQLConnectTimeoutException($nfa48c); } elseif ($c70106==1045){ $h06aa6=@mysqli_real_connect( $cd51e8, 'p:'. $x78940['server'], $x78940['user_name'], $x78940['passw'] ); if ($h06aa6){ $x78940['passw']=g1305($x78940['passw']); $settings['db']=$x78940; if(Log::$ned2b5)__log('Storing encrypted password'); @s6e52(USER_FOLDER.'settings.json',json_encode($settings,E2_JSON_STYLE)); } throw new AeMySQLAccessDeniedException($nfa48c); } else { throw new AeMySQLCannotConnectException($nfa48c); } } $_db['version']=mysqli_get_server_info($cd51e8); if(version_compare($_db['version'],E2_MINIMUM_MYSQL,'<')) { throw new AeMySQLTooOldException($nfa48c); } if (!@mysqli_select_db($cd51e8,$x78940['name'])) { throw new AeMySQLNotFoundException($nfa48c); } $_db['link']=$cd51e8; $_db['charset']=version_compare($_db['version'],'5.5.3','>=')?'utf8mb4':'utf8'; mysqli_query($cd51e8,'SET NAMES '. $_db['charset']); $u060d3=true; } function qb1ac(string $nfa48c='',$x78940=null){ global$_db,$_strings; try { m985b($nfa48c,$x78940); return true; } catch (AeMySQLConnectTimeoutException $e){ if(Log::$ned2b5)__log('ensure_try Caught: AeMySQLConnectTimeoutException'); return [ 'error-string' => e2l_get_string('er--db-connect-timeout', [ 'timeout' => E2_MYSQL_CONNECT_TIMEOUT, ]), 'exception-name' => 'AeMySQLConnectTimeoutException', ]; } catch (AeMySQLAccessDeniedException $e){ if(Log::$ned2b5)__log('ensure_try Caught: AeMySQLAccessDeniedException '. mysqli_connect_error() .' ('. mysqli_connect_errno() .')'); return [ 'error-string' => ( $_strings['er--cannot-connect-to-db']. ':<br />'. mysqli_connect_error() .' ('. mysqli_connect_errno() .')' ), 'exception-name' => 'AeMySQLAccessDeniedException', ]; } catch (AeMySQLCannotConnectException $e){ if(Log::$ned2b5)__log('ensure_try Caught: AeMySQLCannotConnectException '. mysqli_connect_error() .' ('. mysqli_connect_errno() .')'); return [ 'error-string' => ( $_strings['er--cannot-connect-to-db']. ':<br />'. mysqli_connect_error() .' ('. mysqli_connect_errno() .')' ), 'exception-name' => 'AeMySQLCannotConnectException', ]; } catch (AeMySQLTooOldException $e){ if(Log::$ned2b5)__log('ensure_try Caught: AeMySQLTooOldException'); return [ 'error-string' => e2l_get_string('er--mysql-version-too-old', [ 'v1' => $_db['version'], 'v2' => E2_MINIMUM_MYSQL, ]), 'exception-name' => 'AeMySQLTooOldException', ]; } catch (AeMySQLNotFoundException | AeMySQLException $e){ if(Log::$ned2b5)__log('ensure_try Caught: AeMySQLNotFoundException | AeMySQLException'); return [ 'error-string' => $_strings['er--cannot-find-db'] .' '. $x78940['name'], 'exception-name' => 'AeMySQLNotFoundException', ]; } } function a0738(string $f1b1cc,string $nfa48c='run some query'){ global $s11755,$_db,$_strings; @$s11755 ++; if(Log::$ned2b5) if ($nfa48c)__log('Will '. $nfa48c); if(Log::$ned2b5)__log('DB ['. $s11755 .']: '. $f1b1cc); m985b($nfa48c); $_db['result']=mysqli_query($_db['link'],$f1b1cc); if (!$_db['result']) { throw new AeMySQLQueryException($nfa48c ."\n\nMySQL says:\n". mysqli_error($_db['link'])); } } function z0d6b($type=MYSQLI_ASSOC){ global$_db; $f2cb9d=array(); while ($i0cc17=@mysqli_fetch_array($_db['result'],$type)) { foreach ($i0cc17 as $d865c0 => $m4921c){ if(is_string($m4921c)) { $i0cc17[$d865c0]=$m4921c; } } $f2cb9d[] = $i0cc17; } return $f2cb9d; } function c7928($bb45cf){ global$_db; m985b('escape string'); return mysqli_real_escape_string($_db['link'],$bb45cf); } function tb488(){ echo '<pre>'; echo 'Sifting backups...<br>'; $i10ae9=array(); foreach(glob(BACKUP_FOLDER. '*.sql') as $m8c7dd){ if(preg_match('/^backup\-(\d+)\-(\d+)\-(\d+)\-at\-(\d+)\-(\d+)\-(\d+)\.sql$/is',basename($m8c7dd),$o9c28d)) { list (, $x41529,$r6f8f5,$u8277e,$l2510c,$d865c0,$u03c7c)=$o9c28d; $o96b8c=gmmktime($l2510c,$d865c0,$u03c7c,$r6f8f5,$u8277e,$x41529); $i10ae9[$o96b8c]=$m8c7dd; } } if(count($i10ae9) > 3){ echo 'More than 3 backups, time to sift...<br>'; $n536a1=-1; $nf46c9=array (SECONDS_IN_A_MINUTE,SECONDS_IN_AN_HOUR,SECONDS_IN_A_DAY, -1); $d865c0=0; foreach(array_reverse($i10ae9,true) as $o96b8c => $m8c7dd){ echo '-> '. $m8c7dd .' ('. gmdate('r',$o96b8c) .')<br>'; if ($n536a1 == -1){ echo '   latest, leave<br>'; $n536a1=$o96b8c; } elseif ($nf46c9[$d865c0] == -1){ echo '   too old, remove<br>'; unlink($m8c7dd); } else { if ($n536a1-$o96b8c < $nf46c9[$d865c0]) { echo '   no need (not long ago), remove<br>'; unlink($m8c7dd); } else { $d865c0 ++; echo '   ok, leave, set interval to '. $nf46c9[$d865c0] .'<br>'; $n536a1=$o96b8c; } } } } else { echo 'No need to sift<br>'; } echo '</pre>'; return; } function e2s_dump(){ global$_model,$_db,$_config; try { m985b('make backup'); if($_db['link']) { $q68720=time() - (SECONDS_IN_A_DAY); $m9ab2e=array(); foreach(array_keys($_model) as $paab9e){ $m9ab2e[] = $_config['db_table_prefix'].$paab9e; } $l07cc6=time(); $n435ed=BACKUP_FOLDER .'backup-'.gmdate('Y-m-d-\a\t-H-i-s',$l07cc6).'.sql'; e2_backup( $_db['link'], $m9ab2e, $n435ed ); tb488(); die ('Backed up.'); } } catch (AeMySQLException $e){ c12f6($ae1671,'Could not do backup'); die ('Could not do backup.'); } } define('ALIAS_MAX_LENGTH',64); function e2ali__alias_from_title_($k36cd3){ global$_config; $h3e891=$k36cd3; if(array_key_exists('autoreplace_for_aliases',$_config)) { $h3e891=strtr( $h3e891, $_config['autoreplace_for_aliases'] ); } $h3e891=e2l_transliterate($h3e891); $h3e891=str_replace('\'','',$h3e891); $h3e891=str_replace('’','',$h3e891); $h3e891=str_replace(chr(146),'',$h3e891); $h17901=''; for ($d865c0=0; $d865c0 < strlen($h3e891); ++ $d865c0){ if ( (ord($h3e891[$d865c0]) >= 48 and ord($h3e891[$d865c0]) <= 57) or (ord($h3e891[$d865c0]) >= 65 and ord($h3e891[$d865c0]) <= 90) or (ord($h3e891[$d865c0]) >= 97 and ord($h3e891[$d865c0]) <= 122) or 0 ){ $h17901.=$h3e891[$d865c0]; } else { $h17901.='-'; } } $h17901=preg_replace('/\-+/','-',$h17901); $h17901=trim($h17901,'-'); $h17901=strtolower($h17901); if ($h17901=='-')$h17901=''; $h17901=substr($h17901,0,ALIAS_MAX_LENGTH); return $h17901; } function e2_aliasrec_of_alias_($v72487){ global$_config; if ((string)$v72487==='') return false; a0738( "SELECT * FROM `". $_config['db_table_prefix']."Aliases` ". "WHERE `Alias` = '". $v72487 ."' ". "ORDER BY `Stamp` LIMIT 1", 'get database record for alias "'. $v72487 .'"' ); $result=z0d6b(); if(count($result)==1){ return$result[0]; } else { return false; } } function e2_active_alias_for_page_($o89111,$jdffc4){ global$_config,$_e2_active_aliases; if ($jdffc4){ if ( is_array($_e2_active_aliases) and array_key_exists($o89111.$jdffc4,$_e2_active_aliases) ) { if(Log::$ned2b5)__log( 'Aliases: alias of entity "'. $o89111 .'" id "'. $jdffc4 .'" '. 'is livecached as "'. @$_e2_active_aliases[$o89111.$jdffc4] .'"' ); return @$_e2_active_aliases[$o89111.$jdffc4]; } else { a0738( "SELECT `Alias` ". "FROM `". $_config['db_table_prefix']."Aliases` ". "WHERE `EntityType` = '". $o89111 ."' ". "AND `EntityID` = ". $jdffc4 ." ". "ORDER BY `Stamp` DESC LIMIT 1", 'get alias record for entity "'. $o89111 .'" id '. $jdffc4.' to detect active alias' ); $result=z0d6b(); $v72487=$result[0]['Alias']; if (!$v72487 and $o89111==ENTITY_TYPE_TAG){ a0738( "SELECT OriginalAlias ". "FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE ID = '". ((int)$jdffc4)."'", 'get orginial alias for tag id '. $jdffc4.' to detect active alias' ); $result=z0d6b(); $v72487=$result[0]['OriginalAlias']; } $_e2_active_aliases[$o89111.$jdffc4]=$v72487; } if(Log::$ned2b5)__log('Got alias "'. @$_e2_active_aliases[$o89111.$jdffc4] .'"'); return @$_e2_active_aliases[$o89111.$jdffc4]; } } function qd712($t15d61,$o89111,$jdffc4,$k36cd3,$ffb873=1){ global$_e2_active_aliases; if(Log::$ned2b5)__log('Aliases: "'. $t15d61 .'" available alias for source "'. $k36cd3. '"'); if ($t15d61=='set' and (!$o89111 or !$jdffc4)) return false; $h17901=e2ali__alias_from_title_($k36cd3); if ($k36cd3!=='' and $h17901===''){ $h17901=(string)$ffb873; } elseif ($ffb873 > 1){ $d9f626='-'. $ffb873; $h17901=substr($h17901,0,ALIAS_MAX_LENGTH-strlen($d9f626)) . $d9f626; } if ($oc45dd=e2_aliasrec_of_alias_($h17901)) { $w6bae4=$oc45dd['EntityType']; $s1123c=$oc45dd['EntityID']; if ( (($jdffc4 and $s1123c==$jdffc4) and ($o89111 and $w6bae4==$o89111)) or $h17901!=e2_active_alias_for_page_($w6bae4,$s1123c) ) { if ($t15d61=='find'){ return $h17901; } if ($t15d61=='set'){ if(Log::$ned2b5)__log('Aliases: update alias timestamp'); taa79('Aliases', array ( 'ID' => $oc45dd['ID'], 'EntityType' => $o89111, 'EntityID' => $jdffc4, 'Alias' => $h17901, 'Stamp' => time(), )); return$_e2_active_aliases[$o89111.$jdffc4]=$h17901; } } else { return qd712($t15d61,$o89111,$jdffc4,$k36cd3,$ffb873+1); } } else { if ($o89111 and $jdffc4 and $h17901==''){ if(e2_active_alias_for_page_($o89111,$jdffc4)==''){ return ''; } } if(Log::$ned2b5)__log('Aliases: it’s an empty alias, and it was not being used for this entity'); if ( $o89111==ENTITY_TYPE_TAG and $od62e3=x8770($h17901) ) { if ($od62e3['ID']!=$jdffc4){ return qd712($t15d61,$o89111,$jdffc4,$k36cd3,$ffb873+1); } } if ($t15d61=='find'){ return $h17901; } if ($t15d61=='set'){ x9943('Aliases', array ( 'EntityType' => $o89111, 'EntityID' => $jdffc4, 'Alias' => $h17901, 'Stamp' => time(), )); return$_e2_active_aliases[$o89111.$jdffc4]=$h17901; } } return ''; } function e2m_note($parameters=array ()) { global $settings, $z57de2, $_config, $_superconfig, $_strings; if(Log::$ned2b5)__log('Note {'); $raad65=$parameters['*note']; if ($raad65==false){ return e2_error404_mode(); } if (!ab44b($raad65,ge852())) { return e2_error404_mode(); } $bd58c0=i83c8('e2m_note',$parameters); if(Log::$ned2b5)__log('Navigation {'); $cfcb08=tcca7($raad65,'prev'); $bd0cab=tcca7($raad65,'next'); if ($cfcb08){ $jb3b32['prev-href']=i83c8('e2m_note', array ('*note' => $cfcb08)); $jb3b32['prev-title']=a6f10(htmlspecialchars($cfcb08['Title'],ENT_NOQUOTES,HSC_ENC)); } if ($bd0cab){ $jb3b32['next-href']=i83c8('e2m_note', array ('*note' => $bd0cab)); $jb3b32['next-title']=a6f10(htmlspecialchars($bd0cab['Title'],ENT_NOQUOTES,HSC_ENC)); } $jb3b32['title']=$_strings['nm--posts']; $jb3b32['timeline?']=false; $jb3b32['this-title']=a6f10(htmlspecialchars($raad65['Title'],ENT_NOQUOTES,HSC_ENC)); if(Log::$ned2b5)__log('}'); if(Log::$ned2b5)__log('Packaging...'); $raad65['_']['_id']=$raad65['ID']; $raad65['_']['_ord']=0; $raad65['_']['_ord_max']=0; $h8e4cd=v6791($raad65); $ce35b1=''; $l33ff2=false; $p905f7=false; $l7bae4=array(); $ed09b4=''; if (ge852()) { $f83625=e2_note_cache_filename_with_id_($raad65['_']['_id'] .'-comments-author'); } else { $f83625=e2_note_cache_filename_with_id_($raad65['_']['_id'] .'-comments'); } $r1e8cc=null; if(CACHE_NOTES_COMMENTS and is_file($f83625)) { $r1e8cc=@unserialize(file_get_contents($f83625)); } if(Log::$ned2b5)__log('Comments {'); if(is_array($r1e8cc)) { if(Log::$ned2b5)__log('retrieve cached ctree'); $ce35b1=$r1e8cc; } else { if(Log::$ned2b5)__log('assemble ctree...'); $hc1fdc=y70a7($raad65['ID']); $fa5d49=array(); $y04c25=true; foreach ($hc1fdc as $c8ce4b => $o4032b){ if ($o4032b['IsVisible']) { $o4032b['_']['_id']=$o4032b['ID']; $o4032b['_']['_ord']=$c8ce4b; $o4032b['_']['_ord_max']=count($hc1fdc)-1; $e06d4c=n86f8( $raad65, $o4032b, $c8ce4b+1 ); if ($e06d4c['new?'] and $y04c25){ $e06d4c['first-new?']=true; $y04c25=false; } $fa5d49[] = $e06d4c; } } $ce35b1=$fa5d49; if(CACHE_NOTES_COMMENTS)s6e52($f83625,serialize($ce35b1)); } if(Log::$ned2b5)__log('} // Comments'); if (!@$_config['read_only'] and $h8e4cd['commentable-now?']) { $x80f02=d66aa($raad65); $x80f02['.comment-number']=count($ce35b1)+1; } if (ge852() and ob387($raad65,NOTE_COMMENTABLE_NOW_CONDITIONALLY)) { if ($raad65['IsCommentable']) { $l7bae4['href']=i83c8('e2m_note_flag', array ( '*note' => $raad65, 'flag' => 'IsCommentable', 'value' => 0, )); $l7bae4['text']=$_strings['bt--close-comments-to-post']; } else { $l7bae4['href']=i83c8('e2m_note_flag', array ( '*note' => $raad65, 'flag' => 'IsCommentable', 'value' => 1, )); $l7bae4['text']=$_strings['bt--open-comments-to-post']; } } if ( ge852() and array_key_exists('new-comments-count',$h8e4cd) and $h8e4cd['new-comments-count'] ) { if(Log::$ned2b5)__log('mark comments as not new'); e2_drop_caches_for_note_($i21158); taa79('Comments', array ('IsNew' => 0), array ('NoteID' => $raad65['_']['_id'])); } if(Log::$ned2b5)__log('more work...'); $qe70c4['title']=$raad65['Title']; $qe70c4['pages']=$jb3b32; $qe70c4['summary']=$h8e4cd['summary']; $qe70c4['notes'] = array ('only' => $h8e4cd); if ($ce35b1) $qe70c4['comments']['each']=$ce35b1; if ($l7bae4) $qe70c4['comments']['toggle']=$l7bae4; $qe70c4['comments']['count']=$h8e4cd['comments-count']; $qe70c4['comments']['count-text']=$h8e4cd['comments-count-text']; $qe70c4['comments']['new-count']=$h8e4cd['new-comments-count']; $qe70c4['comments']['new-count-text']=$h8e4cd['new-comments-count-text']; $qe70c4['comments']['commentable-now?']=$h8e4cd['commentable-now?']; if ($x80f02){ $qe70c4['form-comment']=$x80f02; } if(Log::$ned2b5)__log('} // Note'); return $qe70c4; } function e2m_note_read($parameters=array ()) { if(Log::$ned2b5)__log('Note read {'); $raad65=$parameters['*note']; $bff089=time(); $bff089=$bff089 - ($bff089 % SECONDS_IN_AN_HOUR); x9943( 'Actions', array ( 'EntityID' => $raad65['ID'], 'Stamp' => $bff089, 'ReadCount' => 1, ), 'INSERT LOW_PRIORITY', 'ON DUPLICATE KEY UPDATE `ReadCount` = `ReadCount` + 1' ); if(Log::$ned2b5)__log('}'); e2_go_to(i83c8('e2m_note',$parameters)); } function e2m_note_withdraw($parameters=array ()) { global$_strings; $wea59a=$parameters['*note']; if (!$wea59a) return e2_error404_mode(); $j22db1=i83c8('e2m_note_broadcast', array ('*note' => $wea59a)); $wea59a['IsPublished']=0; $wea59a['IsCommentable']=0; $wea59a['IsVisible']=1; $wea59a['Stamp']=time(); $wea59a['IP']=$_SERVER['REMOTE_ADDR']; if($parameters['alias']) { $wea59a['OriginalAlias']=$parameters['alias']; } else { $wea59a['OriginalAlias']=qd712( 'find',ENTITY_TYPE_NOTE,$wea59a['ID'],$wea59a['Title'] ); } e2_drop_caches_for_note_($wea59a['ID']); @unlink(CACHE_FILENAME_DRAFTS); @unlink(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); if ($wea59a['IsFavourite']) { @unlink(CACHE_FILENAME_FAVS); } taa79('Notes',$wea59a); v10fe($wea59a['ID']); rcc38($j22db1); qd712('set',ENTITY_TYPE_NOTE,$wea59a['ID'],''); e2_go_to(i83c8('e2m_draft', array ( 'draft' => $i21158, 'oalias' => $wea59a['OriginalAlias'], ))); } function e2m_note_delete($parameters=array()) { global$_strings; $wea59a=$parameters['*note']; if (!$wea59a) return e2_error404_mode(); $jf91b2=!$wea59a['IsPublished']; if ($jf91b2){ $w72bd7=e2l_get_string('gs--draft-will-be-deleted', array ( 'draft' => htmlspecialchars($wea59a['Title'],ENT_NOQUOTES,HSC_ENC), )); } else { $w72bd7=e2l_get_string('gs--post-will-be-deleted', array ( 'post' => htmlspecialchars($wea59a['Title'],ENT_NOQUOTES,HSC_ENC), )); } $dd5d3d=$jf91b2? $_strings['pt--draft-deletion']:$_strings['pt--post-deletion']; $s57529=array ( '.note-id' => $wea59a['ID'], '.is-draft' => (int)$jf91b2, 'note-title' => htmlspecialchars($wea59a['Title'],ENT_COMPAT,HSC_ENC), 'caution-text' => $w72bd7, 'form-action' => i83c8('e2s_note_delete'), 'submit-text' => $_strings['fb--delete'], 'draft?' => (int)$jf91b2, ); if ($wea59a['IsPublished']) { $s57529['withdraw-href']=i83c8( 'e2m_note_withdraw',$parameters ); } $f2cb9d=array ( 'title' => $dd5d3d. ': '. htmlspecialchars($wea59a['Title'],ENT_NOQUOTES,HSC_ENC), 'heading' => $dd5d3d, 'form' => 'form-note-delete', 'form-note-delete' => $s57529, ); return $f2cb9d; } function e2m_note_flag_favourite($parameters){ global$_config; $parameters['flag']='IsFavourite'; $i1fa03='error'; try { if (p7e6c($parameters)) { $b67142=$parameters; $b67142['value'] = !$parameters['value']; if($parameters['value']==1){ $i99859=i83c8('e2m_note_flag_favourite',$b67142); $i1fa03='on-rehref|'. $i99859; } else { $i99859=i83c8('e2m_note_flag_favourite',$b67142); $i1fa03='off-rehref|'. $i99859; } } } catch (AeMySQLException $e){ c12f6($ae1671,'Could not set favourite flag for note'); } if(array_key_exists('result',$_POST) and ($_POST['result']=='ajaxresult')) { die ($i1fa03); } else { e2_go_to(i83c8('e2m_note',$parameters)); die; } } function e2m_note_flag($parameters){ p7e6c($parameters); if(array_key_exists('draft',$parameters)) { e2_go_to(i83c8('e2m_draft',$parameters)); } else { e2_go_to(i83c8('e2m_note',$parameters)); } die; } function p7e6c($parameters){ $i21158=$parameters['*note']['ID']; if (!is_numeric($i21158)) { return e2_error404_mode(); } e2_drop_caches_for_note_($i21158); if($parameters['flag']=='IsFavourite'){ @unlink(CACHE_FILENAME_FAVS); } if($parameters['flag']=='IsVisible'){ y7996(); } taa79('Notes', array ( 'ID' => $i21158, $parameters['flag'] => (int) ($parameters['value']==1), )); try { $b39a37=v4627($i21158); j5b68($b39a37); } catch (AeMySQLException $e){ c12f6($ae1671,'Could not broadcast note flag change'); } return true; } function e2m_note_use_formatter($parameters){ $i21158=$parameters['*note']['ID']; if (!is_numeric($i21158)) { return e2_error404_mode(); } e2_drop_caches_for_note_($i21158); if (!$parameters['*note']['IsPublished']) { @unlink(CACHE_FILENAME_DRAFTS); } if(in_array($parameters['formatter'], array ('calliope','raw','neasden'))) { taa79('Notes', array ( 'ID' => $i21158, 'FormatterID' => $parameters['formatter'], )); echo 'formatter set to '. $parameters['formatter']; } else { echo 'unknown formatter'; } die; } function e2m_note_edit($parameters=array ()) { return d7dd3('edit',$parameters); } function d7dd3($x60cd8,$parameters=array ()) { global$full_blog_url,$_strings,$_config; $dd5d3d=$_strings['pt--new-post']; $lf74f5=$_strings['pt--new-post']; $i21158='new'; $q9763c=$_config['default_formatter']; if ($x60cd8=='edit'){ $wea59a=$parameters['*note']; if (!$wea59a) return e2_error404_mode(); if ($wea59a){ if ($wea59a['IsPublished']) { $lf74f5=$_strings['pt--edit-post']; $m3aa13=''; $v72487=$parameters['alias']; } else { $lf74f5=$_strings['pt--edit-draft']; $m3aa13=qd712( 'find',ENTITY_TYPE_NOTE,$wea59a['ID'],$wea59a['Title'] ); if (@$wea59a['OriginalAlias']) { $v72487=$wea59a['OriginalAlias']; } else { $v72487=$m3aa13; } } } $i21158=$wea59a['ID']; $q9763c=$wea59a['FormatterID']; $dd5d3d=$wea59a['Title']; } $r04868=kbb5b(); $v77b75=array(); if ($r04868!==null) foreach ($r04868 as $kd7df5){ $v77b75[] = $kd7df5['tag']; } $jd2e3e=array(); if ($x60cd8=='edit' and count($v77b75)) { $r04868=ja463($wea59a['ID']); foreach ($r04868 as $kd7df5){ $jd2e3e[] = htmlspecialchars($kd7df5['Keyword'],ENT_NOQUOTES,HSC_ENC); } } $ec93df=array(); foreach ($v77b75 as $kd7df5){ $afd2ef['name']=$kd7df5; $afd2ef['selected?']=in_array($kd7df5,$jd2e3e); $ec93df[] = $afd2ef; } $p9dbb8=''; $jd2e3e=implode(', ',$jd2e3e); if ($jd2e3e)$p9dbb8=$jd2e3e; if ($x60cd8=='write'){ $rc50d0=$_strings['fb--save-and-preview']; } if ($x60cd8=='edit'){ if(array_key_exists('draft',$parameters)) { $rc50d0=$_strings['fb--save-and-preview']; } else { $rc50d0=$_strings['fb--save-changes']; } } $te449c=array(); if ($x60cd8=='edit'){ $te449c=ec0c4( $wea59a['FormatterID'],$wea59a['Text'],'full' ); } $y75e1b=zf898( 'note',$i21158,$te449c ); if ($x60cd8=='edit'){ v2f83( 'Notes', $wea59a, $te449c ); } $o96b8c=min($wea59a['Stamp'],time()); if(E2_EDITION){ $o96b8c=$wea59a['Stamp']; } $oc999b=cd10e(); $f2cb9d['title']=$dd5d3d; $f2cb9d['heading']=$lf74f5; $f2cb9d['form']='form-note'; $f2cb9d['body-uploads-enabled?']=g1363($oc999b); $f2cb9d['form-note'] = array ( '.note-id' => $i21158, '.formatter-id' => $q9763c, '.from' => substr($_SERVER['HTTP_REFERER'],strlen($full_blog_url)+1), '.old-tags-hash' => md5($p9dbb8), '.action' => $x60cd8, 'form-action' => i83c8('e2s_note_process'), 'form-note-livesave-action' => i83c8('e2j_note_livesave'), 'form-file-upload-action' => i83c8('e2j_file_upload'), 'form-file-remove-action' => i83c8('e2j_file_remove'), 'create:edit?' => (bool) ($x60cd8=='write'), 'title' => htmlspecialchars($wea59a['Title'],ENT_COMPAT,HSC_ENC), 'tags' => $p9dbb8, 'tags-info' => $ec93df, 'text' => htmlspecialchars($wea59a['Text'],ENT_NOQUOTES,HSC_ENC), 'uploads' => $y75e1b, 'uploads-enabled?' => g1363($oc999b), 'all-tags' => $v77b75, 'stamp-formatted' => e5a2f('d.m.Y H:i:s',$o96b8c,d0923($wea59a)), 'time' => $wea59a['IsPublished']? array ((int)$o96b8c,d0923($wea59a)) : false, 'alias-autogenerated' => $m3aa13, 'alias' => $v72487, 'submit-text' => $rc50d0, 'space-usage' => vaf64($oc999b), ); if (!$p85faf){ } if ($x60cd8=='edit'){ $f2cb9d['related-delete-href']=i83c8( 'e2m_note_delete', array ('*note' => $wea59a) ); if (!array_key_exists('draft',$parameters)) { $wea59a['_']['_id']=$wea59a['ID']; $wea59a['_']['_ord']=0; $wea59a['_']['_ord_max']=0; $f2cb9d['form-note']['note']=v6791($wea59a); } } return $f2cb9d; } function e2m_write(){ return d7dd3('write'); } function e2s_note_process(){ global$_fp_error,$_strings; $i21158=va21e(); if (!$i21158){ if($_fp_error==FP_TITLE_OR_TEXT_EMPTY){ o8a40($_strings['er--post-must-have-title-and-text'],E2E_USER_ERROR); } elseif($_fp_error==FP_NO_ID_OR_NEW){ } else { o8a40($_strings['er--error-occurred']); } e2_go_to(i83c8('e2m_write')); die; } try { $raad65=v4627($i21158); if ($raad65['IsPublished']) { e2_go_to(i83c8('e2m_note', array ('*note' => $raad65))); } else { e2_go_to(i83c8('e2m_draft', array ('*note' => $raad65))); } } catch (AeMySQLException $e){ c12f6($ae1671,'Could not get note by ID'); e2_go_to(); } die; } function e2s_note_publish(){ global$_strings,$_config,$settings; $i21158=false; if(array_key_exists('note-id',$_POST)) { $i21158=$_POST['note-id']; $iaddfe=false; if(E2_EDITION){ if (@$_POST['submit-button']=='schedule'){ $iaddfe=@$_POST['stamp']; } } $wea59a=v4627($i21158); $j82b30=$wea59a['OriginalAlias']; $p098ae=$wea59a['Stamp']; $abb4fe=!$wea59a['IsExternal']; $wea59a['ID']=$i21158; $wea59a['IsVisible']=1; $wea59a['IsPublished']=1; $wea59a['IsCommentable'] = (int)$settings['comments']['default_on']; $wea59a['IsFavourite']=0; if(array_key_exists('browser-offset',$_POST)) { $wb2c6c=ea618(@$_POST['browser-offset']); } else { $wb2c6c=false; } if ($iaddfe and $o96b8c=q1630($iaddfe,$wb2c6c)) { $wea59a['Stamp']=$o96b8c; if(E2_EDITION){ if ($o96b8c > time())dd7aa($wea59a); } } elseif ($abb4fe){ $wea59a['Stamp']=time(); } else { $wea59a['Stamp']=$p098ae; } qd2e1($wea59a); if ($wb2c6c){ $wea59a['Offset'] = (int)$wb2c6c['offset']; $wea59a['IsDST'] = (int)$wb2c6c['is_dst']; } e2_drop_caches_for_note_($i21158); @unlink(CACHE_FILENAME_DRAFTS); @unlink(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); taa79('Notes',$wea59a); $v72487=''; if ($j82b30 or $j82b30==='0'){ $v72487=qd712('set',ENTITY_TYPE_NOTE,$i21158,$j82b30); $wea59a['OriginalAlias']=$v72487; } if ($v72487!=$j82b30){ taa79('Notes',$wea59a); } if (ab44b($wea59a)) { j5b68($wea59a); } e2_go_to(i83c8('e2m_note', array ('*note' => $wea59a))); die; } e2_go_to(); die; } function ie268($i21158,$b9a92d=-1){ global$_config; e2_drop_caches_for_note_($i21158); if ($b9a92d or $b9a92d === -1){ @unlink(CACHE_FILENAME_DRAFTS); @unlink(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); } if (!$b9a92d or $b9a92d === -1) { @unlink(CACHE_FILENAME_FAVS); } a0738( "DELETE FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `ID` = '". ((int)$i21158) ."'", 'delete note by ID' ); v10fe($i21158); a0738( "DELETE FROM `". $_config['db_table_prefix']."Aliases` ". "WHERE `EntityID`=". ((int)$i21158), 'delete aliases after deleting note' ); a0738( "DELETE FROM `". $_config['db_table_prefix']."NotesKeywords` ". "WHERE `NoteID`=". ((int)$i21158), 'delete tag bindings after deleting note' ); } function e2s_note_delete(){ global$_strings,$_config; $i21158=$_POST['note-id']; $b9a92d=(bool)$_POST['is-draft']; $wea59a=v4627($i21158); $j22db1=i83c8('e2m_note_broadcast', array ('*note' => $wea59a)); ie268($i21158,$b9a92d); rcc38($j22db1); if ($b9a92d){ e2_go_to(i83c8('e2m_drafts')); } else { e2_go_to(); } die; } function e2j_note_livesave(){ die (va21e('ajaxresult')); } function v6791($raad65,$r8698e=false){ global $settings, $_config, $_superconfig, $_candy, $_current_tag, $z57de2, $ee5564, $full_blog_url; if (!is_numeric($raad65['_']['_id'])) return false; $gda497=e2_note_cache_filename_with_id_($raad65['_']['_id']); $ne244c=null; if(CACHE_NOTES and is_file($gda497)) { $ne244c=@unserialize(file_get_contents($gda497)); } if(Log::$ned2b5)__log('Notes: package note <'. $raad65['_']['_id'] .'>...'); $qe919a=f7f78(); if(CACHE_NOTES and is_array($ne244c)) { if(Log::$ned2b5)__log('Notes: retrieve cached ctree'); $pc6827=$ne244c; } else { if(Log::$ned2b5)__log('Notes: assemle cacheable ctree...'); if(Log::$ned2b5)__log('Notes: formatter ID = '. $raad65['FormatterID']); $g2bfe4=c154e($raad65['FormatterID'], @$raad65['Text'],'full'); $pc6827['title'] = a6f10(htmlspecialchars($raad65['Title'],ENT_NOQUOTES,HSC_ENC)); $pc6827['text'] = $g2bfe4['text-final']; $pc6827['summary'] = y5421($pc6827['text']); $pc6827['format-info'] = $g2bfe4['meta']; $pc6827['time'] = array ((int)$raad65['Stamp'],d0923($raad65)); $pc6827['last-modified'] = array ((int)$raad65['LastModified'],d0923($raad65)); $pc6827['last-ip'] = $raad65['IP']; $pc6827['published?'] = (bool)$raad65['IsPublished']; $pc6827['commentable?'] = (bool) ($raad65['IsCommentable'] && $raad65['IsPublished']); $pc6827['favourite?'] = (bool) ($raad65['IsFavourite'] && $raad65['IsPublished']); $pc6827['visible?'] = ab44b($raad65); $pc6827['scheduled?'] = false; if(E2_EDITION){ $pc6827['scheduled?'] = (bool) ($raad65['IsPublished'] && ($raad65['Stamp'] > time())); } $yd972d=@$raad65['SourceNoteData']; $yd972d=@json_decode($yd972d,true); $pc6827['source-main-image-url'] = @$yd972d['og_images'][0]; if(is_array($g2bfe4['meta']['resources-detected'])) { b6be4($g2bfe4['meta']['resources-detected']); } if (!$pc6827['published?'])$pc6827['time']=$pc6827['last-modified']; $pc6827['og-images']=sdbcc( 'note',$raad65['_']['_id'], $pc6827['format-info']['resources-detected'] ); $x0dff3=ece23($raad65['ID']); $cd57ac=array(); foreach ($x0dff3 as $d865c0 => $nb19ad){ $pc6827['og-images']=array_merge( $pc6827['og-images'], sdbcc('tag',$nb19ad['ID'], array ()) ); $xe4d23['name']=htmlspecialchars($nb19ad['Keyword'],ENT_NOQUOTES,HSC_ENC); $xe4d23['href']=i83c8('e2m_tag', array ('*tag' => $nb19ad)); $cd57ac[] = $xe4d23; } $pc6827['tags']=$cd57ac; $p905f7=u254f($raad65['ID']); if ($pc6827['published?']) { $pc6827['comments-count']=$p905f7; } $ne244c=$pc6827; if(CACHE_NOTES) @s6e52($gda497,serialize($ne244c)); } if ($r8698e){ if(Log::$ned2b5)__log('Notes: short-track package for caching only'); if(Log::$ned2b5)__log('Notes: package note done in '. round(f7f78()-$qe919a,3)); return $pc6827; } if(Log::$ned2b5)__log('Notes: continue with the uncacheable, '. round(f7f78()-$qe919a,3) .' so far...'); $pc6827['commentable-now?']=ob387($raad65); if(array_key_exists('comments-count',$pc6827)) { $pc6827['comments-count-text']=e2l_get_string('gs--n-comments', array ( 'number' => $pc6827['comments-count'] )); } foreach ($pc6827['tags'] as $c8ce4b => $i9e366){ $pc6827['tags'][$c8ce4b]['current?'] = (bool) ($pc6827['tags'][$c8ce4b]['name']==$_current_tag); } $d2e88c=$raad65['IsPublished']?'e2m_note':'e2m_draft'; $pc6827['href']=i83c8($d2e88c, array ('*note' => $raad65)); if ($raad65['IsPublished']) { if ($raad65['OriginalAlias']) { $pc6827['href-original']=i83c8('e2m_note', array ('alias' => $raad65['OriginalAlias'])); } else { $e010d9=$raad65; $e010d9['__noalias!']=true; $pc6827['href-original']=i83c8('e2m_note', array ('*note' => $e010d9)); } } $pc6827=array_merge($pc6827,m1a48($raad65,true)); $pc6827['comments-link?'] = (bool) ( $raad65['IsPublished'] && (ob387($raad65) or ($pc6827['comments-count'] > 0)) && ('e2m_note'!=$_candy) ); if (ge852()) { $cfe9e2=e3ce7($raad65['ID']); $pc6827['new-comments-count']=$cfe9e2; $pc6827['new-comments-count-text']=e2l_get_string('gs--comments-n-new', array ( 'number' => $cfe9e2 )); if ($raad65['IsPublished']) { if ($raad65['IsFavourite']) { $pc6827['favourite-toggle-href']=i83c8( 'e2m_note_flag_favourite', array ('*note' => $raad65,'value' => 0) ); } else { $pc6827['favourite-toggle-href']=i83c8( 'e2m_note_flag_favourite', array ('*note' => $raad65,'value' => 1) ); } } if (!@$_config['read_only']) { $pc6827['edit-href']=i83c8( 'e2m_note_edit', array ('*note' => $raad65) ); $s9920c=$pc6827['edit-href']; } } if($settings['appearance']['show_sharing_buttons']) { $veb769=$_config['share_to']; $z21bdd='|twitter|facebook|gplus|vkontakte|telegram|linkedin|whatsapp|'; if (@$_config['share_to_twitter_via']) { $o8d777['twitter']['via']=$_config['share_to_twitter_via']; } if(count($pc6827['og-images']) > 0){ $c62933=$pc6827['og-images'][0]; $z21bdd.='pinterest|'; $o8d777['pinterest']['media']=$c62933; } $pc6827['shareable?']=false; foreach(explode(',',$veb769) as $n5a9d3){ $n5a9d3=trim($n5a9d3); if(strstr($z21bdd,'|'. $n5a9d3. '|')) { $pc6827['shareable?']=true; $pc6827['share-to'][$n5a9d3]['share?']=true; if ($o8d777[$n5a9d3]) { $pc6827['share-to'][$n5a9d3]['data']=$o8d777[$n5a9d3]; } } } } if(array_key_exists('_',$raad65))$pc6827['_']=$raad65['_']; if(Log::$ned2b5)__log('Notes: package note done in '. round(f7f78()-$qe919a,3)); return $pc6827; } function v4627($ub80bb){ global$_config; a0738( "SELECT * FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `ID` = '". $ub80bb ."'" ); $cfa816=z0d6b(); if(count($cfa816) > 0){ return $cfa816[0]; } else { return false; } } function tcca7($raad65,$vb4ca4,$h8f888=1){ global$_strings,$_config; $s7ffc4=($vb4ca4=='next')?'>':'<'; $m9b272=($vb4ca4=='next')?'':'DESC '; try { a0738( "SELECT * FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `IsPublished`=". $h8f888 ." ". "AND `Stamp` ". $s7ffc4 ." '". $raad65['Stamp'] ."' ". v6f32(ge852()). "ORDER BY STAMP ". $m9b272 . "LIMIT 1", 'get '. $vb4ca4 .' note' ); $cfa816=z0d6b(); if(count($cfa816) > 0) return $cfa816[0]; else return false; } catch (AeMySQLException $e){ c12f6($ae1671,'Could not get '. $vb4ca4 .' note'); return null; } } function ra2d8($rddf82){ global$_config; if(Log::$ned2b5)__log('Lastmodifieds for Local Copier'); if(CACHE_LASTMODIFIEDS and is_file(CACHE_FILENAME_LASTMODIFIEDS)) { $b84636=@unserialize(file_get_contents(CACHE_FILENAME_LASTMODIFIEDS)); if ($b84636['ids_csv']==$rddf82){ if(Log::$ned2b5)__log('Returned from cache'); return $b84636['lastmodifieds_json']; } } $y56790='WHERE `ID`='. str_replace(',',' OR `ID`=',$rddf82); $db7d96=array(); a0738( "SELECT `ID`, `LastModified` ". "FROM `". $_config['db_table_prefix']."Notes` ". $y56790, 'get lastmodifieds for Local Copier' ); if(Log::$ned2b5)__log('Requested from DB'); $result=z0d6b(); foreach($result as $c8ce4b => $i9e366){ $db7d96[(int)$i9e366['ID']] = (int)$i9e366['LastModified']; } $o08bb9=json_encode($db7d96); if ($o08bb9=='[]')$o08bb9='{}'; $b84636=array ( 'ids_csv' => $rddf82, 'lastmodifieds_json' => $o08bb9, ); if(CACHE_LASTMODIFIEDS){ s6e52(CACHE_FILENAME_LASTMODIFIEDS,serialize($b84636)); } return $o08bb9; } function nd864($o8d777){ global$settings,$l71860,$_strings; $t7694f=$o8d777['query']; if (isset ($o8d777['page']) and $o8d777['page'] < 1) return e2_error404_mode(); $sd7e5d=$settings['appearance']['notes_per_page']; $jb3b32=array(); $hfbb44=false; if (isset ($o8d777['page'])) { $l71860=$o8d777['page']; $t7694f.=' LIMIT '.($o8d777['page']-1)*$sd7e5d.', '.$sd7e5d; $w61e23=str_replace('SELECT *','SELECT count(*)',$o8d777['query']); if ( a0738( $w61e23, 'count notes by criteria' ) ) { $result=z0d6b(); $hfbb44=$result[0]['count(*)']; $eae0fe=ceil($hfbb44/$sd7e5d); if ($l71860 > $eae0fe and $l71860!=1){ return e2_error404_mode(); } $jb3b32['count']=$eae0fe; $jb3b32['this']=$l71860; $jb3b32['timeline?']=true; $jb3b32['earlier-title']=$_strings['gs--earlier']; $jb3b32['later-title']=$_strings['gs--later']; $o920fa=$o8d777['parameters']; if ($l71860 < $eae0fe){ $o920fa['page']=$l71860+1; $jb3b32['earlier-href']=i83c8($o8d777['candy'],$o920fa); } if ($l71860 > 1){ $o920fa['page']=$l71860-1; $jb3b32['later-href']=i83c8($o8d777['candy'],$o920fa); } } else { return array (); } } $e4358b=array(); if ( a0738( $t7694f, 'get notes by criteria' ) ) { $result=$ae5b87=z0d6b(); if (@$o8d777['query-returns-only-ids']) { $result=array(); $f15514=ge852(); foreach ($ae5b87 as $raad65){ $raad65=v4627($raad65['ID']); if ($raad65['IsPublished'] and ab44b($raad65,$f15514)) { $result[] = $raad65; } } } foreach($result as $c8ce4b => $raad65){ $raad65['_']['_id']=$raad65['ID']; $raad65['_']['_ord']=$c8ce4b; $raad65['_']['_ord_max']=count($result)-1; $e4358b[] = v6791($raad65); } } else { return array (); } $n05a16=$e4358b; if (!isset ($o8d777['show-all-notes']) or @$o8d777['show-all-notes']!=true){ $n05a16=array_slice($e4358b,0,$sd7e5d); } if ($hfbb44===false)$hfbb44=count($n05a16); if (!count($e4358b) and array_key_exists('nothing',$o8d777)) { $f2cb9d['nothing']=$o8d777['nothing']; } $lcd0fd=array ( 'class', 'superheading', 'heading', 'title', 'search-related-tag', ); foreach ($lcd0fd as $jf97bf){ if(array_key_exists($jf97bf,$o8d777)) { $f2cb9d[$jf97bf]=$o8d777[$jf97bf]; } } if ($hfbb44){ $b5cde2=e2l_get_string( 'pt--n-posts', array ('number' => $hfbb44) ); } else { $b5cde2=$_strings['pt--no-posts']; } if(array_key_exists('maximum-notes',$o8d777) and $hfbb44 >= $o8d777['maximum-notes']) { $b5cde2=$_strings['gs--many-posts']; } foreach (array ('title','heading','superheading') as $m4b24c){ if(strstr($o8d777[$m4b24c],'%total%')) { $f2cb9d[$m4b24c]=str_replace('%total%', $b5cde2,$o8d777[$m4b24c]); } } $f2cb9d['notes']=$n05a16; $f2cb9d['pages']=$jb3b32; return $f2cb9d; } function of9fb($x41529,$r6f8f5,$u8277e=false){ global$_config; list ($k7b314,$ca1f20)=g5273($x41529,$r6f8f5,$u8277e); a0738( "SELECT * FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished` AND (`Stamp` BETWEEN " .$k7b314. " AND " .$ca1f20. ") ". "ORDER BY Stamp", 'get all notes for the date '. $u8277e .'.'. $r6f8f5 .'.'. $x41529 ); $result=z0d6b(); $wb1bc2=1; $f2cb9d=array(); foreach($result as $c65afd){ if(is_numeric($u8277e)) { $x3f917=((int)$x41529) .'/'. ((int)$r6f8f5) .'/'. ((int)$u8277e) == e5a2f('Y/n/j',$c65afd['Stamp'],d0923($c65afd)); } elseif(is_numeric($r6f8f5)) { $x3f917=((int)$x41529) .'/'. ((int)$r6f8f5) == e5a2f('Y/n',$c65afd['Stamp'],d0923($c65afd)); } else { $x3f917=((int)$x41529) == e5a2f('Y',$c65afd['Stamp'],d0923($c65afd)); } if ($x3f917){ if(is_numeric($u8277e)) { $c65afd['day_number']=$wb1bc2; } $f2cb9d[] = $c65afd; $wb1bc2 ++; } } return $f2cb9d; } function e2_published_noterec_with_parameters_($parameters=array ()) { $b39a37=e2_noterec_with_parameters_($parameters); if ($b39a37['IsPublished']) return $b39a37; } function e2_noterec_with_parameters_($parameters=array ()) { global$_config; $raad65=false; $qb5445=false; if ((string) @$parameters['oalias']!=='')$qb5445=$parameters['oalias']; if ((string)$qb5445!==''){ a0738( "SELECT * FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `OriginalAlias` = '". $qb5445 ."' ". "AND `IsPublished` = 0", 'get note record by original alias' ); $raad65=z0d6b(); if(count($raad65)==1) { $raad65=@$raad65[0]; if ($raad65) return $raad65; } } $w67e85=false; if (@$parameters['draft']!=='') $w67e85=$parameters['draft']; if (@$parameters['draft2']!=='')$w67e85=$parameters['draft2']; if ($w67e85){ $raad65=v4627($w67e85); return $raad65; } if ((string) @$parameters['alias']!==''){ if ($oc45dd=e2_aliasrec_of_alias_(@$parameters['alias'])) { if ($oc45dd['EntityType']==ENTITY_TYPE_NOTE){ $raad65=v4627($oc45dd['EntityID']); if ($raad65['IsPublished']) return $raad65; } } } $xc2d18=of9fb($parameters['year'],$parameters['month'],$parameters['day']); if (@$xc2d18[$parameters['day-number']-1]) { return $xc2d18[$parameters['day-number']-1]; } } function ce56b($dd5d3d,$j1cb25,$wb2c6c,$xd19c2){ global$_config; ae2f1(); @unlink(CACHE_FILENAME_DRAFTS); @unlink(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); $b39a37=array ( 'Title' => $dd5d3d, 'Text' => $j1cb25, 'FormatterID' => $_config['default_formatter'], 'OriginalAlias' => qd712('find',ENTITY_TYPE_UNSPECIFIED,'',$dd5d3d), 'Uploads' => $xd19c2, 'Stamp' => (int)time(), 'LastModified' => (int)time(), ); if ($wb2c6c and is_array($wb2c6c)) { $b39a37['Offset'] = (int)$wb2c6c['offset']; $b39a37['IsDST'] = (int)$wb2c6c['is_dst']; } $b39a37=x9943('Notes',$b39a37); return $b39a37['ID']; } function q1630($vf2de2,$wb2c6c){ $yd17d3='/^ *(\d{1,2})\.(\d{1,2})\.(\d{2}|\d{4}) +(\d{1,2})\:(\d{1,2})\:(\d{1,2}) *$/'; if(preg_match($yd17d3,$vf2de2,$r6f8f5)) { $o96b8c=gmmktime($r6f8f5[4],$r6f8f5[5],$r6f8f5[6],$r6f8f5[2],$r6f8f5[1],$r6f8f5[3]); $o96b8c -= cb2bf($wb2c6c,$o96b8c); return $o96b8c; } else { return false; } } function va21e($r98ea6=''){ global$_fp_error,$_config,$_e2utf8__unformat_htmlentity_neasden,$_db; if(Log::$ned2b5)__log('Process note form'); try { $_fp_error=false; $i21158=$dd5d3d=$cd57ac=$j1cb25=$tb4960=''; if(array_key_exists('note-id',$_POST)) $i21158=$_POST['note-id']; if(array_key_exists('title',$_POST)) $dd5d3d=trim($_POST['title']); if(array_key_exists('tags',$_POST)) $cd57ac=$_POST['tags']; if(array_key_exists('text',$_POST)) $j1cb25=trim($_POST['text'],"\r\n"); if(array_key_exists('old-tags-hash',$_POST)) $tb4960=$_POST['old-tags-hash']; if(is_array($cd57ac))$cd57ac=implode(', ',$cd57ac); $cd57ac=trim($cd57ac); if ($i21158=='new'){ $_e2utf8__unformat_htmlentity_neasden=($_config['default_formatter']=='neasden'); } else { $_e2utf8__unformat_htmlentity_neasden=($_POST['formatter-id']=='neasden'); } $g1f22b=p07e3('Notes'); if(stripos($g1f22b['Collation'],'utf8mb4')!==0){ $dd5d3d=jff7c($dd5d3d); $cd57ac=jff7c($cd57ac); $j1cb25=jff7c($j1cb25,true); } $effa71=$j1cb25; $effa71=str_replace("\n",'\n'."\n",$effa71); $effa71=str_replace("\r",'\r'."\r",$effa71); $da6168=o163d(',',$cd57ac,'sort'); $cd57ac=implode(', ',$da6168); $t65f31=md5($cd57ac); if(array_key_exists('browser-offset',$_POST)) { $wb2c6c=ea618(@$_POST['browser-offset']); } else { $wb2c6c=false; } $c02b37=@$_POST['old-stamp']; $iaddfe=@$_POST['stamp']; $v72487=@$_POST['alias']; if ($i21158!='new'){ $t383b7=v4627($i21158); } else { $t383b7=array(); } if ($i21158){ if ((string)$dd5d3d!=='' and (string)$j1cb25!==''){ if ($i21158=='new'){ $xd19c2=''; if(is_file(USER_FOLDER.'new-uploads.psa')) { $xd19c2=@file_get_contents(USER_FOLDER.'new-uploads.psa'); } try { $i21158=ce56b($dd5d3d,$j1cb25,$wb2c6c,$xd19c2); @unlink(USER_FOLDER.'new-uploads.psa'); $v33dd5='e2m_draft'; $m5ce5d=array ( '*note' => v4627($i21158), ); $i1fa03='{'. '"status": "created", '. '"id": "'. $i21158 .'", '. '"note-url": "'. i83c8($v33dd5,$m5ce5d) .'", '. '"note-edit-url": "'. i83c8('e2m_note_edit',$m5ce5d) .'"'. '}'; $result=(int)$i21158; } catch (AeMySQLException $e){ c12f6($ae1671,'Could not insert note'); $i1fa03='{"status": "error", "message": "Cannot create record"}'; $result=false; } } else { e2_drop_caches_for_note_($i21158); if (!$t383b7['IsPublished']) { @unlink(CACHE_FILENAME_DRAFTS); @unlink(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); } $u71671=$t383b7; $u71671['ID']=$i21158; $u71671['Title']=$dd5d3d; $u71671['Text']=$j1cb25; $u71671['FormatterID']=$t383b7['FormatterID']; $u71671['LastModified']=time(); $u71671['IsIndexed']='1'; if ($c02b37!=$iaddfe){ if ($o96b8c=q1630($iaddfe,$wb2c6c)) { $u71671['Stamp']=min($o96b8c,time()); if(E2_EDITION){ $u71671['Stamp']=$o96b8c; if ($o96b8c > time())dd7aa($u71671); } } else { unset ($o96b8c); } } $h17901=$v72487; if ((string)$v72487!==''){ $ja7ff0=$v72487; } elseif (!$t383b7['IsPublished']) { $ja7ff0=$dd5d3d; } else { $ja7ff0=''; } if ($t383b7['IsPublished']) { $h17901=qd712( 'set',ENTITY_TYPE_NOTE,$i21158,$ja7ff0 ); $v33dd5='e2m_note'; $m5ce5d=array ( '*note' => $u71671, 'alias' => $h17901, ); } else { $m926c6=true; $h17901=qd712('find',ENTITY_TYPE_NOTE,$i21158,$ja7ff0); $u71671['OriginalAlias']=$h17901; $v33dd5='e2m_draft'; $m5ce5d=array ( '*note' => $u71671, 'alias' => $h17901, ); } $te449c=ec0c4( $u71671['FormatterID'],$u71671['Text'],'full' ); if(count($te449c) > 0){ b6be4($te449c); } try { taa79('Notes',$u71671); if ($u71671['IsPublished']) { qd2e1($u71671); j5b68($u71671); } $i1fa03='{'. '"status": "saved", '. '"new-alias": "'. $h17901 .'", '. '"note-url": "'. i83c8($v33dd5,$m5ce5d) .'", '. '"note-edit-url": "'. i83c8('e2m_note_edit',$m5ce5d) .'"'. '}'; $result=(int)$i21158; } catch (AeMySQLException $e){ c12f6($ae1671,'Could not update record'); $i1fa03='{"status": "error", "message": "Cannot update record ('. mysqli_error(). ')"}'; $result=false; } } if ($t65f31!=$tb4960){ v53f1(array ('NoteID' => $i21158)); foreach ($da6168 as $xe4d23){ $u70b77=q0188($xe4d23); if (!$u70b77){ $u70b77['ID']=o03de($xe4d23); } a0738( "INSERT INTO `". $_config['db_table_prefix']."NotesKeywords` ". "(`NoteID`, `KeywordID`) ". "VALUES (". ((int)$i21158) .", ". ((int)$u70b77['ID']). ")", 'add new tag bindings' ); } } if ( $r98ea6!='ajaxresult' and $result and $_POST['instant-publish']=='yes' ){ $_POST['note-id']=$i21158; e2s_note_publish(); } } else { $i1fa03='{"status":"error", "message": "Title or text is empty"}'; $_fp_error=FP_TITLE_OR_TEXT_EMPTY; $result=false; } } else { $i1fa03='{"status":"error", "message": "No note id/new specified"}'; $_fp_error=FP_NO_ID_OR_NEW; $result=false; } rcc38(i83c8('e2s_dump', array ())); } catch (AeMySQLException $e){ c12f6($ae1671); $i1fa03='{"status":"error", "message": "Database error"}'; $result=false; } if ($r98ea6=='ajaxresult') return $i1fa03; else return$result; } function i3456($m1653c,$w0604c){ global$_config; if (!($m1653c and $w0604c) and !ge852()) { if(Log::$ned2b5)__log('Error: e2_notes_count_generic called for invisible items unsecurely'); return null; } if (!is_bool($m1653c) or !is_bool($w0604c)) { if(Log::$ned2b5)__log ('Error: e2_notes_count_generic called with non-bool params'); return null; } if (!$m1653c and !$w0604c){ if(Log::$ned2b5)__log ('Error: e2_notes_count_generic called with nonsensical parameters'); return null; } $vd29bb=( CACHES_FOLDER . 'notes-count-p'. (int)$m1653c . ($m1653c ? ('v'. (int)$w0604c):'') . '.txt' ); $result=false; if(CACHE_NOTES_COUNTS and is_file($vd29bb)) { $result=@file_get_contents($vd29bb); } if(is_numeric($result) and $result > 0){ return$result; } else { $result=null; try { a0738( "SELECT COUNT(*) As NotesCount FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished`=". (int)$m1653c. " ". ($m1653c ? ( "AND `IsVisible`=". (int)$w0604c ):""), 'count notes with flags p'. (int)$m1653c . ($m1653c ? ('v'. (int)$w0604c):'') ); $result=z0d6b(); $result=$result[0]['NotesCount']; } catch (AeMySQLException $e){ c12f6($ae1671); if(Log::$ned2b5)__log('Could not count notes'); } if($result){ if(CACHE_NOTES_COUNTS)s6e52($vd29bb,$result); } return$result; } } function y5421($j1cb25){ $ka80da=$j1cb25; $ka80da=preg_match( '/^(\<\/div\>)?\<p( class\=\"lead\")?\>(.*)\<\/p\>$/m', $ka80da, $o9c28d ); $ka80da=$o9c28d[3]; if (!$ka80da)$ka80da=$j1cb25; $ka80da=str_replace(array ( '<p>','<blockquote>','<ul>','<ol>','<br />', ), "\n",$ka80da); $ka80da=trim(strip_tags($ka80da)); if(strpos($ka80da,"\n")!==false){ $ka80da=substr($ka80da,0,strpos($ka80da,"\n")); $ka80da=trim($ka80da,' :.()'."\n"); } if(preg_match('/^(.{100,}?)[:.!?()]|'."\n".'/s',$ka80da,$o9c28d)) { $ka80da=trim($o9c28d[0],' :.()'."\n"); } if(preg_match('/^(.{150,}?)[:.!?(),]/s',$ka80da,$o9c28d)) { $ka80da=trim($o9c28d[0],' :.()'."\n"); } if(preg_match('/^(.{200,}?)[:.!?(), ]/s',$ka80da,$o9c28d)) { $ka80da=trim($o9c28d[0],' :.()'."\n"); } if(in_array($ka80da[strlen($ka80da)-1], array (',',' '))) { $ka80da=trim($ka80da,', '). '...'; } if(mb_strlen($ka80da) > 250){ $ka80da=mb_substr($ka80da,0,250). '...'; } if ($ka80da[-1]==':')$ka80da=mb_substr($ka80da,0, -1); return $ka80da; } function ab44b($b39a37,$f15514=false){ if ($f15514) return true; return $b39a37['IsVisible'] and $b39a37['Stamp'] <= time(); } function v6f32($f15514=false){ if ($f15514){ return ''; } else { return 'AND (n.`IsVisible` = 1 AND n.`Stamp` <= '. time() .') '; } } function e2_populate_read_counts_in_notes_ctree_($o6b12c){ global$_config; $ec6b5b=array(); foreach ($o6b12c as $c8ce4b => $ne244c){ if (@$ne244c['_']['_id']) { $ec6b5b[] = "(`EntityID` = ". $ne244c['_']['_id'].")"; } } if(count($ec6b5b)) { $ec6b5b=implode(' OR ',$ec6b5b); try { a0738( "SELECT `EntityID`, SUM(`ReadCount`) ReadCount ". "FROM `". $_config['db_table_prefix']."Actions` ". "WHERE ". $ec6b5b ." ". "GROUP BY `EntityID`", 'get read counts to populate notes CTree' ); $cfa816=z0d6b(); foreach ($cfa816 as $a33c9b){ $l0980a[$a33c9b['EntityID']] = $a33c9b['ReadCount']; } foreach ($o6b12c as $c8ce4b => $ne244c){ $o6b12c[$c8ce4b]['read-count']=$l0980a[$ne244c['_']['_id']]; } } catch (AeMySQLException $e){ c12f6($ae1671); if(Log::$ned2b5)__log('Could not populate read counts in notes ctree'); } } return $o6b12c; } if(E2_EDITION){ function b2f04(){ $n435ed=USER_FOLDER.'scheduled.psa'; if (!is_file($n435ed)) return; if(Log::$ned2b5)__log('Check notes schedule'); $a638a6=(array) @unserialize(file_get_contents($n435ed)); $sbb7d9=array(); $a9b26a=array(); $a5a9d1=false; foreach ($a638a6 as $x3f670){ if(time() >= @$x3f670['stamp']) { if (!$a5a9d1)y7996(); $a5a9d1=true; if ($p7b13a[$x3f670['id']]) continue; $p7b13a[$x3f670['id']] = true; try { m0d22(i83c8( 'e2m_note_json', array ('*note' => v4627($x3f670['id'])) )); } catch (AeMySQLException $e){ c12f6($ae1671,'Could not broadcast a note published by schedule'); } } else { $sbb7d9[] = $x3f670; } } foreach ($sbb7d9 as $x3f670){ if (!@$p7b13a[$x3f670['id']]) { $a9b26a[] = $x3f670; } } if ($a5a9d1){ if(count($a9b26a)) { @s6e52($n435ed,serialize($a9b26a)); } else { @unlink($n435ed); } } } function dd7aa($wea59a){ $n435ed=USER_FOLDER.'scheduled.psa'; $a638a6=@unserialize(file_get_contents($n435ed)); if (!is_array($a638a6))$a638a6=array(); $a638a6[] = array ( 'id' => $wea59a['ID'], 'stamp' => $wea59a['Stamp'], ); @s6e52($n435ed,serialize($a638a6)); } } define('DRAFT_PREVIEW_LENGTH',100); function e2m_drafts(){ global$_strings,$_config; if(Log::$ned2b5)__log('Drafts list: Working...'); $eda48a=null; if(CACHE_DRAFTS and is_file(CACHE_FILENAME_DRAFTS)) { $eda48a=@unserialize(file_get_contents(CACHE_FILENAME_DRAFTS)); } if(CACHE_DRAFTS and is_array($eda48a)) { if(Log::$ned2b5)__log('Drafts list: Retrieve cached ctree'); } else { if(Log::$ned2b5)__log('Drafts list: Assemle cacheable ctree...'); $eda48a=array(); if(Log::$ned2b5)__log('Drafts list: Select'); $e3f2a5=''; if($_config['limit_drafts']) { $e3f2a5="LIMIT ". ((int)$_config['limit_drafts']); } a0738( "SELECT * FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished`=0 ". "ORDER BY `SourceID` DESC, `LastModified` DESC ". $e3f2a5, 'get drafts to display on Drafts page' ); $result=z0d6b(); $e4358b=array(); foreach($result as $c8ce4b => $b39a37){ $raad65=array(); $raad65['_']['_id']=$b39a37['ID']; $raad65['_']['_ord']=$c8ce4b; $raad65['_']['_ord_max']=count($result)-1; $raad65['href']=i83c8('e2m_draft', array ('*note' => $b39a37)); $raad65['title']=a6f10(htmlspecialchars($b39a37['Title'],ENT_NOQUOTES,HSC_ENC)); if (isset ($raad65['image-href'])) unset ($raad65['image-href']); $b39a37['_']['_id']=$b39a37['ID']; $b39a37['_']['_ord']=0; $b39a37['_']['_ord_max']=0; $h8e4cd=v6791($b39a37,true); $raad65['_']['_resources']=null; if ($b39a37['FormatterID']=='neasden'){ $raad65['_']['_resources']=$h8e4cd['format-info']['resources-detected']; } elseif ($b39a37['FormatterID']=='calliope'){ $raad65['_']['_resources']=ec0c4( $b39a37['FormatterID'],$b39a37['Text'],'full' ); } $raad65=array_merge($raad65,m1a48($b39a37,false)); $raad65['text-fragment']=strip_tags($h8e4cd['text']); $b2ab2d=false; if(mb_strlen($raad65['text-fragment']) > DRAFT_PREVIEW_LENGTH) { $b2ab2d=mb_strpos($raad65['text-fragment'],'.',DRAFT_PREVIEW_LENGTH); } if ($b2ab2d!==false){ $raad65['text-fragment']=mb_substr($raad65['text-fragment'],0,$b2ab2d+1); } $eda48a[] = $raad65; } if(CACHE_DRAFTS)s6e52(CACHE_FILENAME_DRAFTS,serialize($eda48a)); } if(Log::$ned2b5)__log('Drafts list: Put thumbnail without cache'); if ($eda48a){ foreach ($eda48a as $c8ce4b => $i9e366){ $eda48a[$c8ce4b]['thumbs']=d2e82(@$i9e366['_']['_resources']); } } if(Log::$ned2b5)__log('Drafts list: Done'); $f2cb9d=array ( 'title' => $_strings['pt--drafts'], 'heading' => $_strings['pt--drafts'], ); if(count($eda48a)) { $f2cb9d['drafts']=$eda48a; } else { $f2cb9d['nothing']=$_strings['gs--no-drafts']; } return $f2cb9d; } function e2m_draft($parameters=array ()) { global$_strings,$_config,$z57de2; $raad65=e2_noterec_with_parameters_($parameters); if (!$raad65){ $parameters['alias']=$parameters['oalias']; unset($parameters['oalias']); $raad65=e2_noterec_with_parameters_($parameters); if ($raad65){ $bd58c0=i83c8('e2m_note', array ('*note' => $raad65)); return e2_go_to($bd58c0); } } if (!$raad65) return e2_error404_mode(); $raad65['_']['_id']=$raad65['ID']; $raad65['_']['_ord']=0; $raad65['_']['_ord_max']=0; $h8e4cd=v6791($raad65); if(E2_EDITION){ $h8e4cd['preview-href']=i83c8( 'e2m_draft_preview', array ( '*note' => $raad65, 'preview-key' => e2drafts__preview_key($raad65) ) ); } $g45513=array ( '.note-id' => $raad65['ID'], 'form-action' => i83c8('e2s_note_publish'), 'submit-text' => $_strings['fb--publish-draft'], 'can-schedule?' => false, 'can-publish?' => !@$_config['read_only'], ); if(E2_EDITION){ $g45513['can-schedule?']=true; $g45513['stamp-formatted']=e5a2f( 'd.m.Y H:i:s',time(),d0923($raad65) ); $g45513['submit-schedule-text']=$_strings['fb--schedule-note']; } return array ( 'title' => $raad65['Title'].' ('. $_strings['wd--draft'] .')', 'notes' => array ('only' => $h8e4cd), 'form' => 'form-note-publish', 'form-note-publish' => $g45513, ); } function e2m_draft_preview($parameters=array ()) { if(E2_EDITION){ $raad65=e2_noterec_with_parameters_($parameters); $na2d26=e2drafts__preview_key($raad65); if($parameters['preview-key']==$na2d26){ $result=e2m_draft($parameters); unset($result ['notes']['only']['href']); unset($result ['form']); unset($result ['form-note-publish']); return$result; } } return e2_error404_mode(); } function e2_draft_alias_use_count($j176fe){ global$_config; if(Log::$ned2b5)__log('Drafts: find duplicate OriginalAliases...'); if(CACHE_DRAFTS_ALIAS_USE_COUNTS and is_file(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS)) { $qda552=@unserialize(file_get_contents(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS)); } if(CACHE_DRAFTS_ALIAS_USE_COUNTS and is_array($qda552)) { if(Log::$ned2b5)__log('Drafts: retrieve cached'); } else { if(Log::$ned2b5)__log('Drafts: assemle cacheable...'); $qda552=array(); a0738( "SELECT `OriginalAlias` FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished`=0 ". "ORDER BY `ID`", 'get original aliases of drafts to calculate use counts' ); $result=z0d6b(); $e4358b=array(); foreach($result as $c8ce4b => $b39a37){ @$qda552[$b39a37['OriginalAlias']] ++; } if(CACHE_DRAFTS_ALIAS_USE_COUNTS){ s6e52(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS,serialize($qda552)); } } return $qda552[$j176fe]; } function e2drafts__preview_key($raad65){ return md5($raad65['Text'].$raad65['LastModified']); } function i29a1(){ global$_strings,$_user_folder_name; $aeccd7='http://'. $_strings['e2--website-host'] .'/'; $s68966='('. $_strings['e2--release'] .' '. E2_RELEASE .', v'. E2_VERSION .')'; return [ 'built?' => BUILT, 'installed?' => (e2_get_instance()!==null), 'version' => 'v'. E2_VERSION, 'version-description' => $_strings['e2--vname-aegea'] .' '. $s68966, 'user-folder-name' => $_user_folder_name, 'cookie-prefix' => p8c3b(), 'href' => $aeccd7, 'about' => ( '<span title="E2 '.$s68966 .'">'. $_strings['e2--powered-by'] .' '. '<a href="'. $aeccd7 .'" class="nu"><u>'. $_strings['e2--vname-aegea'] .'</u> '. '<span class="e2-svgi">'. hf42c('aegea') .'</span></a></span>' ), ]; } function hc4da($fc48ba,$o6b12c,$t89650,$vcadc1,$me22d5){ global$full_blog_url,$content, $_config, $_candies_indexable, $_candies_indexable_conditionally, $_template, $_newsfeeds, $_current_url; $meta['base-href']=$full_blog_url. '/'; $meta['current-href']=$_current_url; $meta['stylesheets']=b37ca(); $meta['scripts']=e4753(); $meta['newsfeeds']=$_newsfeeds; $meta['favicon-type']='image/x-icon'; $meta['favicon-href']='favicon.ico'; $meta['navigation-links'] = [[ 'rel' => 'index', 'href' => i83c8('e2m_frontpage', ['page' => 1]), 'id' => 'link-index', ]]; if (!empty ($me22d5)) { foreach (['prev','next','earlier','later'] as $oc47d1){ if(array_key_exists($oc47d1 .'-href',$me22d5)) { $s7ffc4=$oc47d1; if ($oc47d1=='earlier')$s7ffc4='prev'; if ($oc47d1=='later')$s7ffc4='next'; $meta['navigation-links'][] = [ 'rel' => $s7ffc4, 'href' => $me22d5[$oc47d1 .'-href'], 'id' => 'link-'. $oc47d1, ]; } } } $h1e2ad='noindex, follow'; if (@$_config['index_follow_everything']) { $h1e2ad='index, follow'; } if(in_array($fc48ba,$_candies_indexable)) { $meta['robots']='index, follow'; } if(in_array($fc48ba,$_candies_indexable_conditionally)) { $meta['robots']=$h1e2ad; } $meta['viewport']=$_template['meta_viewport']; if(is_file(MEDIA_ROOT_FOLDER.'manifest.json')) { $meta['manifest-href']=$full_blog_url. '/manifest.json'; } $meta['og-images'] = array (); if(is_array($o6b12c['only']['og-images'])) { $meta['og-images']=$o6b12c['only']['og-images']; $meta['twitter-card']='summary_large_image'; } if(is_array($t89650['og-images'])) { $meta['og-images']=$t89650['og-images']; $meta['twitter-card']='summary_large_image'; } if (!count($meta['og-images'])) { $meta['og-images'] = array ($vcadc1['userpic-href']); $meta['twitter-card']='summary'; } return$meta; } function z5e47(){ global$_superconfig,$_config; $d34a31=[ 'new-note-href' => i83c8('e2m_write'), 'drafts-href' => i83c8('e2m_drafts'), 'drafts-count' => (int)i3456(false,true), 'settings-href' => i83c8('e2m_settings'), 'theme-preview-href' => i83c8('e2m_theme_preview', array ('theme' => '')), 'password-href' => i83c8('e2m_password', array ('recovery-key' => '')), 'database-href' => i83c8('e2m_database'), 'timezone-href' => i83c8('e2m_timezone'), 'sessions-href' => i83c8('e2m_sessions'), 'sign-out-href' => i83c8('e2m_sign_out'), ]; if (sda67()) { $d34a31['get-backup-href']=i83c8('e2m_get_backup'); } if (@$_config['read_only']) { unset ($d34a31['new-note-href']); unset ($d34a31['settings-href']); unset ($d34a31['timezone-href']); } if (@$_superconfig['disallow_themes_preview']) { unset ($d34a31['theme-preview-href']); } if (@$_superconfig['disallow_db_config']) { unset ($d34a31['database-href']); } list ($cfe9e2,$i85ee4,$y20699)=j2a6b(); if ($cfe9e2){ $d34a31['new-comments-count']=$cfe9e2; $d34a31['new-comments-href']=$y20699; } return $d34a31; } function e2m_tags(){ global$_strings; $f2cb9d['title']=$_strings['pt--tags']; $f2cb9d['heading']=$_strings['pt--tags']; $f2cb9d['tags']=ue531([]); $kcd342=kbb5b(true); if ($kcd342===null){ $f2cb9d['unavailable?']=true; } else { $f2cb9d['tags']['each']=$kcd342; if(count($cd57ac)==0){ $f2cb9d['nothing']=$_strings['gs--no-tags']; } } return $f2cb9d; } function e2m_tag($parameters=array ()) { global $settings, $_config, $_current_tag, $_strings, $l71860, $full_blog_url; if(Log::$ned2b5)__log('Tag {'); if(array_key_exists('*tags',$parameters)) { $e59aeb=$parameters['*tags']; } if (!$e59aeb[0]) return e2_error404_mode(); $kd7df5=$e59aeb[0]; $l7186e=$parameters['tag-alias']; if(count($e59aeb)==1){ $_current_tag=$kd7df5['Keyword']; } $l71860=$parameters['page']; $fc2b7b=$_config['db_table_prefix']; $sd7e5d=$settings['appearance']['notes_per_page']; foreach ($e59aeb as $i9e366) if ($i9e366){ $y56790[] = "nk.KeywordID=". $i9e366['ID']; } $y56790='('.implode(' OR ',$y56790).')'; $f15514=ge852(); $y56790.='AND IsPublished=1 '; $y56790.=v6f32($f15514); $c9b0c2=count($e59aeb); $k7a86c=($l71860-1)*$sd7e5d; $taa9f7=$sd7e5d; $pac5c7=( "SELECT SQL_CALC_FOUND_ROWS n.*, COUNT(*) ". "FROM `". $fc2b7b ."Notes` n ". "JOIN `". $fc2b7b ."NotesKeywords` nk ON nk.`NoteID` = n.`ID` ". "WHERE ". $y56790 . "GROUP BY n.ID ". "HAVING COUNT(*)>=". $c9b0c2 ." ". "ORDER BY n.`Stamp` DESC ". "LIMIT ". $k7a86c .", ". $taa9f7 ); a0738($pac5c7); $result=z0d6b(); a0738("SELECT FOUND_ROWS() AS cnt"); $t67363=z0d6b(); $hfbb44=$t67363 ? (int)$t67363[0]['cnt']:0; $jb3b32=array(); if ($hfbb44){ $eae0fe=ceil($hfbb44/$sd7e5d); $jb3b32['timeline?']=true; $jb3b32['count']=$eae0fe; $jb3b32['this']=$l71860; $jb3b32['earlier-title']=$_strings['gs--earlier']; $jb3b32['later-title']=$_strings['gs--later']; $o920fa=$parameters; if ($l71860 < $eae0fe){ $o920fa['page']=$l71860+1; $jb3b32['earlier-href']=i83c8('e2m_tag',$o920fa); } if ($l71860 > 1){ $o920fa['page']=$l71860-1; $jb3b32['later-href']=i83c8('e2m_tag',$o920fa); } } if ($hfbb44==0){ if (!$f15514){ return e2_error404_mode(); } if ($l71860!=1){ return e2_error404_mode(); } } foreach($result as $c8ce4b => $raad65){ $raad65['_']['_id']=$raad65['ID']; $raad65['_']['_ord']=$c8ce4b; $raad65['_']['_ord_max']=count($result)-1; $e4358b[] = v6791($raad65); } if ($c9b0c2==1){ if ($f15514){ $x97a59['edit-href']=i83c8( 'e2m_tag_edit', array ('tag-alias' => $l7186e) ); } if (''!=$kd7df5['Description']) { $g2bfe4=sb7f1($kd7df5['Description'],'full'); $r67daf=$g2bfe4['text-final']; $x97a59['description']=$r67daf; $x97a59['description-format-info']=$g2bfe4['meta']; r57ad(@$g2bfe4['meta']['links-required']); } $e3ad42=i83c8('e2m_tag_rss', array ('tag-alias' => $l7186e)); $s9d19f=i83c8('e2m_tag_json', array ('tag-alias' => $l7186e)); a3010( 'rss', o6f51() .': '. $kd7df5['Keyword'], $e3ad42 ); a3010( 'json', o6f51() .': '. $kd7df5['Keyword'], $s9d19f ); $x97a59['og-images']=sdbcc( 'tag',$kd7df5['ID'], $x97a59['description-format-info']['resources-detected'] ); } $y96963=( e2l_get_string('pt--n-posts', array ('number' => $hfbb44)). ' '. $_strings['gs--tagged'] ); $lf74f5=array(); foreach ($e59aeb as $i9e366){ $lf74f5[] = $i9e366['Keyword']; } $lf74f5=implode(', ',$lf74f5); $f2cb9d=array ( 'title' => o6f51() .': '. $lf74f5, 'superheading' => $y96963, 'heading' => $lf74f5, 'pages' => $jb3b32, 'notes' => $e4358b, 'tags' => ue531($parameters), ); if ($r67daf){ $f2cb9d['summary']=y5421($r67daf); } if(count($e59aeb)==1){ $f2cb9d['tag']=$x97a59; if (ge852()) { $f2cb9d['related-edit-href']=$x97a59['edit-href']; $f2cb9d['related-edit-title']=$_strings['tt--edit-tag']; } } if(Log::$ned2b5)__log('} // Tag'); return $f2cb9d; } function e2m_tag_edit($parameters=array()) { global$_strings; if(array_key_exists('*tag',$parameters)) { $kd7df5=$parameters['*tag']; } if (!$kd7df5) return e2_error404_mode(); $te449c=ec0c4( 'neasden',$kd7df5['Description'],'full' ); $y75e1b=zf898( 'tag',$kd7df5['ID'],$te449c ); v2f83( 'Keywords', $kd7df5, $te449c ); $oc999b=cd10e(); $xcd831=array ( '.tag-id' => $kd7df5['ID'], '.formatter-id' => 'neasden', 'form-action' => i83c8('e2s_tag_edit'), 'form-file-upload-action' => i83c8('e2j_file_upload'), 'form-file-remove-action' => i83c8('e2j_file_remove'), 'submit-text' => $_strings['fb--save-changes'], 'tag' => htmlspecialchars($kd7df5['Keyword'],ENT_COMPAT,HSC_ENC), 'urlname' => htmlspecialchars($parameters['tag-alias'],ENT_COMPAT,HSC_ENC), 'description' => htmlspecialchars($kd7df5['Description'],ENT_COMPAT,HSC_ENC), 'uploads' => $y75e1b, 'uploads-enabled?' => g1363($oc999b), 'favourite?' => (bool)$kd7df5['IsFavourite'], 'space-usage' => vaf64($oc999b), ); $xcd831['.cache-sensitive-hash']=md5( $xcd831['tag'] . $xcd831['uploads'] . $xcd831['urlname'] ); $f2cb9d=array ( 'body-uploads-enabled?' => g1363($oc999b), 'title' => $_strings['pt--tag-edit'] .': '. $kd7df5['Keyword'], 'heading' => $_strings['pt--tag-edit'], 'form' => 'form-tag', 'form-tag' => $xcd831, 'related-delete-href' => i83c8('e2m_tag_delete', array ('*tag' => $kd7df5)), ); return $f2cb9d; } function e2m_tag_flag_ajax($parameters){ try { a2e88($parameters); $b67142=$parameters; $b67142['value'] = !$parameters['value']; if($parameters['value']==1){ $i99859=i83c8('e2m_tag_flag_ajax',$b67142); $i1fa03='on-rehref|'. $i99859; } else { $i99859=i83c8('e2m_tag_flag_ajax',$b67142); $i1fa03='off-rehref|'. $i99859; } } catch (AeMySQLException $e){ c12f6($ae1671,'Could not set tag flag'); $i1fa03='error'; } if(array_key_exists('result',$_POST) and ($_POST['result']=='ajaxresult')) { die ($i1fa03); } else { e2_go_to(i83c8('e2m_tag',$parameters)); die; } } function a2e88($parameters){ if(array_key_exists('*tag',$parameters)) { $kd7df5=$parameters['*tag']; } if (!$kd7df5) return e2_error404_mode(); @unlink(CACHE_FILENAME_FAVTAGS); @unlink(CACHE_FILENAME_TAGS); @unlink(CACHE_FILENAME_TAGS_AUTHOR); taa79('Keywords', array ( 'ID' => $kd7df5['ID'], $parameters['flag'] => (int) ($parameters['value']==1), )); return true; } function e2m_tag_delete($parameters=array()) { global$_strings; if(array_key_exists('*tag',$parameters)) { $kd7df5=$parameters['*tag']; } if (!$kd7df5) return e2_error404_mode(); $necc14=array ( '.tag-id' => $kd7df5['ID'], 'caution-text' => e2l_get_string('gs--tag-will-be-deleted-notes-remain', array ( 'tag' => htmlspecialchars($kd7df5['Keyword'],ENT_COMPAT,HSC_ENC) )), 'tag' => htmlspecialchars($kd7df5['Keyword'],ENT_COMPAT,HSC_ENC), 'form-action' => i83c8('e2s_tag_delete'), 'submit-text' => $_strings['fb--delete'], ); $f2cb9d=array ( 'title' => $_strings['pt--tag-delete'] .': '. $kd7df5['Keyword'], 'heading' => $_strings['pt--tag-delete'], 'form' => 'form-tag-delete', 'form-tag-delete' => $necc14, ); return $f2cb9d; } function e2m_untagged(){ global$_strings,$_config; return nd864(array ( 'query' => "SELECT n.* FROM `". $_config['db_table_prefix']."Notes` n ". "LEFT OUTER JOIN `". $_config['db_table_prefix']."NotesKeywords` nk ". "ON nk.`NoteID` = n.`ID` ". "WHERE `IsPublished`=1 ". "AND nk.KeywordID IS NULL ". v6f32(ge852()). "ORDER BY n.`Stamp` DESC", 'title' => $_strings['pt--posts-without-tags'], 'heading' => $_strings['pt--posts-without-tags'], 'nothing' => $_strings['gs--no-posts-without-tags'], 'show-all-notes' => true, )); return $f2cb9d; } function e2s_tag_edit(){ global$_strings,$_config; $k76f09=$xe4d23=$r67daf=$ja7ff0=''; if(array_key_exists('tag-id',$_POST)) $k76f09=$_POST['tag-id']; if(array_key_exists('tag',$_POST)) $xe4d23=$_POST['tag']; if(array_key_exists('description',$_POST)) $r67daf=trim($_POST['description'],"\r\n"); if(array_key_exists('urlname',$_POST)) $ja7ff0=trim($_POST['urlname'],"\r\n"); if(array_key_exists('cache-sensitive-hash',$_POST)) { $z3c58b=$_POST['cache-sensitive-hash']; $nbb9a8=md5($xe4d23.$ja7ff0); } $xe4d23=jff7c($xe4d23); $r67daf=jff7c($r67daf); a0738( "SELECT * FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE ID = ".((int)$k76f09)."", 'get tag record to update' ); $m53e61=z0d6b(); if(count($m53e61)!=1) die; $nb19ad=$m53e61[0]; a0738( "SELECT * FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE Keyword = '". c7928($xe4d23) ."' ". "AND (ID != ".((int)$k76f09).")", 'make sure new tag name does not conflict with existing ones' ); $m53e61=z0d6b(); if(count($m53e61)==0){ if ($nbb9a8!=$z3c58b){ y7996(); } @unlink(CACHE_FILENAME_FAVTAGS); @unlink(CACHE_FILENAME_TAGS); @unlink(CACHE_FILENAME_TAGS_AUTHOR); $nb19ad['ID'] = ((int)$k76f09); $nb19ad['Keyword']=$xe4d23; $nb19ad['Description']=$r67daf; taa79('Keywords',$nb19ad); $h17901=qd712( 'set',ENTITY_TYPE_TAG,$nb19ad['ID'],$ja7ff0 ); e2_go_to(i83c8('e2m_tag', array ('tag-alias' => $h17901))); } else { o8a40($_strings['er--cannot-rename-tag'],E2E_USER_ERROR); x4930(); } die; } function e2s_tag_delete(){ global$_strings,$_config; $ub80bb=((int)$_POST['tag-id']); y7996(); @unlink(CACHE_FILENAME_FAVTAGS); @unlink(CACHE_FILENAME_TAGS); @unlink(CACHE_FILENAME_TAGS_AUTHOR); a0738( "DELETE FROM `". $_config['db_table_prefix']."Keywords` WHERE `ID`=". $ub80bb ); a0738( "DELETE FROM `". $_config['db_table_prefix']."NotesKeywords` WHERE `KeywordID`=". $ub80bb ); e2_go_to(i83c8('e2m_tags')); die; } function gaf16($u07f25){ global$_current_tag,$_config; $j9df9d=null; if(CACHE_FAVTAGS and is_file(CACHE_FILENAME_FAVTAGS)) { $j9df9d=@unserialize(file_get_contents(CACHE_FILENAME_FAVTAGS)); } if (!is_array($j9df9d)) { try { a0738( "SELECT * FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE IsFavourite = 1 ORDER BY `Keyword`", 'get favorite tags for tags menu' ); $z9cdff=z0d6b(); $j9df9d=array(); foreach ($z9cdff as $q04ff0){ $pc6827['tag']=htmlspecialchars($q04ff0['Keyword'],ENT_NOQUOTES,HSC_ENC); $pc6827['href']=i83c8( 'e2m_tag', array ('*tag' => $q04ff0) ); $j9df9d[] = $pc6827; } if(CACHE_FAVTAGS)s6e52(CACHE_FILENAME_FAVTAGS,serialize($j9df9d)); } catch (AeMySQLException $e){ c12f6($ae1671); if(Log::$ned2b5)__log('Count not get tags menu from database'); } } if (!is_array($j9df9d)) return null; $k8a4f1=false; foreach ($j9df9d as $c8ce4b => $i9e366){ $j9df9d[$c8ce4b]['current?'] = ( $j9df9d[$c8ce4b]['tag']==$_current_tag ); if ($j9df9d[$c8ce4b]['current?']) { $k8a4f1=true; $z08187=$u07f25; $z08187['flag']='IsFavourite'; $z08187['value']=0; if (ge852()) { $j9df9d[$c8ce4b]['pinnable?']=true; $j9df9d[$c8ce4b]['pinned?']=true; $j9df9d[$c8ce4b]['pinned-toggle-href'] = ( i83c8('e2m_tag_flag_ajax',$z08187) ); } } } if (ge852()) { if (!$k8a4f1 and array_key_exists('*tag',$u07f25)) { $ma55a9=$u07f25; $ma55a9['flag']='IsFavourite'; $ma55a9['value']=1; $dd5a7a=array ( 'tag' => htmlspecialchars($u07f25['*tag']['Keyword'],ENT_NOQUOTES,HSC_ENC), 'href' => i83c8('e2m_tag',$u07f25), 'current?' => true, 'pinnable?' => true, 'pinned?' => false, 'pinned-toggle-href' => i83c8('e2m_tag_flag_ajax',$ma55a9), ); $j9df9d[] = $dd5a7a; } } return $j9df9d; } function ece23($i21158,$parameters=''){ global$_config; $x0dff3=array(); a0738( "SELECT `". $_config['db_table_prefix']."Keywords`.* ". "FROM `". $_config['db_table_prefix']."Keywords`, ". "`". $_config['db_table_prefix']."NotesKeywords` ". "WHERE `". $_config['db_table_prefix']."NotesKeywords`.NoteID=". ((int)$i21158) ." ". "AND `". $_config['db_table_prefix']."Keywords`.ID=`". $_config['db_table_prefix']."NotesKeywords`.KeywordID ". "ORDER BY `Keyword`", 'get tag records for note by id' ); $x0dff3=z0d6b(); return $x0dff3; } function v53f1($oeaa60){ global$_config; $c316e8=array(); foreach (array ( 'ID', 'NoteID', 'KeywordID', ) as $k06e3d) if(array_key_exists($k06e3d,$oeaa60)) { $g6a7f2[] = '`'. $k06e3d .'`'."='". c7928($oeaa60[$k06e3d]) ."'"; if ($k06e3d=='ID')$w729d6='tagbinging-id'; if ($k06e3d=='NoteID')$w729d6='tagbinging-note-id'; if ($k06e3d=='KeywordID')$w729d6='tagbinging-tag-id'; $c316e8[$w729d6]=$oeaa60[$k06e3d]; } $f1b1cc=( "DELETE FROM `". $_config['db_table_prefix']."NotesKeywords` ". "WHERE ". implode(' AND ',$g6a7f2) ); a0738($f1b1cc); } function o03de($xe4d23){ @unlink(CACHE_FILENAME_TAGS); @unlink(CACHE_FILENAME_TAGS_AUTHOR); $nb19ad=array ( 'Keyword' => $xe4d23, 'OriginalAlias' => qd712('find',ENTITY_TYPE_UNSPECIFIED,'',$xe4d23), 'Description' => '', ); $nb19ad=x9943('Keywords',$nb19ad); $u419a1=qd712( 'set',ENTITY_TYPE_TAG,$nb19ad['ID'],$xe4d23 ); if ($u419a1!=$nb19ad['OriginalAlias']) { $nb19ad['OriginalAlias']=$u419a1; taa79('Keywords',$nb19ad); } return $nb19ad['ID']; } function ue531($parameters){ if (($a933dd=kbb5b()) === null) return []; $tc6ce7['each']=$a933dd; if(count($tc6ce7['each']) > 0){ $tc6ce7['href']=i83c8('e2m_tags'); } if (($pbd876=gaf16($parameters)) !== null){ $tc6ce7['menu-each']=$pbd876; } return $tc6ce7; } function kbb5b($de9dc9=false){ global$_config; $f15514=ge852(); $vd29bb=CACHE_FILENAME_TAGS; if ($f15514)$vd29bb=CACHE_FILENAME_TAGS_AUTHOR; if ($de9dc9){ $vd29bb=CACHE_FILENAME_TAGS_FULL; if ($f15514)$vd29bb=CACHE_FILENAME_TAGS_AUTHOR_FULL; } $t8da94=null; if(CACHE_TAGS and is_file($vd29bb)) { $t8da94=@unserialize(file_get_contents($vd29bb)); } if (!is_array($t8da94)) { try { a0738( "SELECT * FROM `". $_config['db_table_prefix']."Keywords` ". "ORDER BY `Keyword`", 'get all tags' ); $w35016=array(); foreach (z0d6b() as $nb19ad){ $xe4d23['tag']=htmlspecialchars($nb19ad['Keyword'],ENT_NOQUOTES,HSC_ENC); $xe4d23['favourite?'] = (bool)$nb19ad['IsFavourite']; $xe4d23['notes-count']=0; $xe4d23['last-used']=0; $xe4d23['freshness']=0; $xe4d23['weight']=0; if ($de9dc9){ $xe4d23['href']=i83c8('e2m_tag', array ('*tag' => $nb19ad)); } $w35016[$nb19ad['ID']] = $xe4d23; } a0738( "SELECT nk.KeywordID, COUNT(DISTINCT n.ID) as Count, max(n.Stamp) as LastUsed ". "FROM `". $_config['db_table_prefix']."NotesKeywords` nk, ". "`". $_config['db_table_prefix']."Notes` n ". "WHERE nk.NoteID = n.ID AND n.IsPublished ". v6f32($f15514). "GROUP BY nk.KeywordID", 'get tags ordering info' ); $b9fdd5=0; $m8f57c=0; $r06894=0; foreach (z0d6b() as $s28a42){ $pc6827 =& $w35016[$s28a42['KeywordID']]; $pc6827['notes-count']=$s28a42['Count']; if (@$pc6827['last-used'] < $s28a42['LastUsed']) { $pc6827['last-used']=$s28a42['LastUsed']; $m452b4=(time()-$pc6827['last-used']) / SECONDS_IN_A_YEAR; $pc6827['freshness']=pow(1/2,$m452b4); } $b9fdd5=max($b9fdd5,$pc6827['notes-count']); $m8f57c=max($m8f57c,$pc6827['freshness']); $r06894=max($r06894,$pc6827['notes-count']*$pc6827['freshness']); } $t8da94=array(); foreach ($w35016 as $d865c0 => $i9e366){ if (!$f15514 and $i9e366['notes-count']==0) continue; $z95e80=mb_strtolower($i9e366['tag']); $t8da94[$z95e80]=$i9e366; if ($m8f57c!=0){ $t8da94[$z95e80]['freshness']=$i9e366['freshness']/$m8f57c; } else { $t8da94[$z95e80]['freshness']=0; } if ($r06894!=0){ $t8da94[$z95e80]['weight'] = ( $i9e366['freshness']*$i9e366['notes-count']/$r06894 ); } else { $t8da94[$z95e80]['weight']=0; } if ($t8da94[$z95e80]['favourite?'])$t8da94[$z95e80]['weight']=1; } if(CACHE_TAGS)s6e52($vd29bb,serialize($t8da94)); } catch (AeMySQLException $e){ c12f6($ae1671); if(Log::$ned2b5)__log('Could not get tags from database'); } } return $t8da94; } function ja463($i21158){ global$_config; a0738( "SELECT `". $_config['db_table_prefix']."Keywords`.* ". "FROM `". $_config['db_table_prefix']."Keywords`, ". "`". $_config['db_table_prefix']."NotesKeywords` ". "WHERE `". $_config['db_table_prefix']."NotesKeywords`.NoteID=".((int)$i21158)." AND ". "`". $_config['db_table_prefix']."Keywords`.ID=". "`". $_config['db_table_prefix']."NotesKeywords`.KeywordID ". "ORDER BY `Keyword`", 'get tags array for note' ); return z0d6b(); } function q0188($kd7df5){ global$_config; a0738( "SELECT * FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `Keyword`='". c7928($kd7df5) ."'", 'get tag by name' ); $c8ce4b=z0d6b(); if (isset ($c8ce4b[0])) { return $c8ce4b[0]; } else { return null; } } function x8770($ud7ca3){ global$_config; a0738( "SELECT * FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `OriginalAlias`='".c7928($ud7ca3)."'", 'get tag by legacy urlname name' ); $cfa816=z0d6b(); if (isset ($cfa816[0])) { return $cfa816[0]; } else { return null; } } function p4e28($ub80bb){ global$_config; a0738( "SELECT * FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `ID`='".((int)$ub80bb)."'", 'get tag by id' ); $cfa816=z0d6b(); if (isset ($cfa816[0])) { return $cfa816[0]; } else { return null; } } function e2_tagrecs_with_parameters_($parameters){ $jbdcf3=array(); if (@$parameters['tag-alias'] or $parameters['tag-alias']==='0'){ $jbdcf3=explode(',',$parameters['tag-alias']); } $x0dff3=array(); foreach ($jbdcf3 as $ud7ca3) if ($ud7ca3 or $ud7ca3==='0'){ if ( $oc45dd=e2_aliasrec_of_alias_(@$ud7ca3) and ($oc45dd['EntityType']==ENTITY_TYPE_TAG) and ($nb19ad=p4e28($oc45dd['EntityID'])) ) { $x0dff3[] = $nb19ad; } else { if ($o3ee3f=x8770($ud7ca3)) { $x0dff3[] = $o3ee3f; } } } return $x0dff3; } function z2e04(){ global$full_blog_url; static $r0d5f1; $v3c6e0=s7874(); if (empty ($r0d5f1)) { $r0d5f1=md5($full_blog_url .'email'. $v3c6e0); } return $r0d5f1; } function kd8c5(){ global$full_blog_url; static $w05fa8; $v3c6e0=s7874(); if (empty ($w05fa8)) { $w05fa8=md5($full_blog_url .'nospam'. $v3c6e0.date('n-Y')); } return $w05fa8; } function ee7ec(){ global$full_blog_url; static $n6f410; $v3c6e0=s7874(); if(empty($n6f410)) { $n6f410=md5($full_blog_url .'nospam'. $v3c6e0.date('n-Y',strtotime('-1 month'))); } return $n6f410; } function r41f3($i21158){ global$full_blog_url; $v3c6e0=s7874(); return p8c3b('comment_'. md5($full_blog_url .'nospam_cookie'. $v3c6e0.$i21158)); } function i7c9d(){ global$full_blog_url; $b83647=$_SERVER['HTTP_USER_AGENT']; $v3c6e0=s7874(); return md5($full_blog_url .'nospam_cookie'. $v3c6e0.$b83647); } function ueb9a(){ if ( array_key_exists('email',$_POST) and $_POST['email']!=='' ) return true; $w05fa8=kd8c5(); $n6f410=ee7ec(); if ( !array_key_exists($w05fa8,$_POST) and !array_key_exists($n6f410,$_POST) ) return true; if ( ( array_key_exists($w05fa8,$_POST) and $_POST[$w05fa8]!=='' ) or ( array_key_exists($n6f410,$_POST) and $_POST[$n6f410]!=='' ) ) return true; if ( !array_key_exists('comment',$_POST) or (strlen($_POST['comment']) > 6) ) return true; return false; } function e2_cookie_data_is_spam_suspicios_for_note_id_($i21158){ if ( !array_key_exists(r41f3($i21158),$_COOKIE) or ($_COOKIE[r41f3($i21158)] !== i7c9d()) ) return true; return false; } function e2m_comment($parameters=array ()) { e2_go_to(i83c8('e2m_note',$parameters)); die; } function e2m_comment_edit($parameters=array ()) { return h4fb7('edit',$parameters); } function h4fb7($x60cd8,$parameters=array ()) { global$_config,$_strings,$full_blog_url; $dd5d3d=$lf74f5=$_strings['pt--new-comment']; $u69b97='new'; if ($x60cd8=='edit'){ $o4032b=e2_commentrec_with_parameters_($parameters); $rc50d0=$_strings['fb--save-changes']; $b39a37=$o4032b['noterec']; $dd5d3d=$lf74f5=$_strings['pt--edit-comment']; $c1aec6=n86f8($b39a37,$o4032b,$parameters['comment-number']); $u69b97=$oaca8d['ID']; if (!$o4032b){ return e2_error404_mode(); } $x80f02=array ( '.note-id' => $o4032b['NoteID'], '.comment-id' => $o4032b['ID'], '.comment-number' => $parameters['comment-number'], '.already-subscribed?' => false, '.gip' => $o4032b['GIP'], '.from' => substr($_SERVER['HTTP_REFERER'],strlen($full_blog_url)+1), 'create:edit?' => false, 'form-action' => i83c8('e2s_comment_process'), 'submit-text' => $rc50d0, 'show-subscribe?' => true, 'subscribe?' => (bool)$o4032b['IsSubscriber'], 'name' => htmlspecialchars($o4032b['AuthorName'],ENT_COMPAT,HSC_ENC), 'email' => htmlspecialchars($o4032b['AuthorEmail'],ENT_COMPAT,HSC_ENC), 'text' => htmlspecialchars($o4032b['Text'],ENT_COMPAT,HSC_ENC), 'email-field-name' => z2e04(), ); if (''!=trim($o4032b['IP'])) { $x80f02['ip']=$o4032b['IP']; $x80f02['ip-href']=$_config['whois_service'].$x80f02['ip']; } } $f2cb9d=array ( 'title' => $dd5d3d, 'heading' => $lf74f5, 'form' => 'form-comment', 'form-comment' => $x80f02, ); if (!empty ($c1aec6)) { $f2cb9d['comments'] = array ('each' => array ('only' => $c1aec6)); } return $f2cb9d; } function e2m_comment_reply($parameters=array ()) { global$_strings; $o4032b=e2_commentrec_with_parameters_($parameters); if (!$o4032b){ return e2_error404_mode(); } $b39a37=$o4032b['noterec']; $c1aec6=n86f8($b39a37,$o4032b,$parameters['comment-number']); $c1aec6['_']['_id']=$o4032b['ID']; $c1aec6['_']['_ord']=0; $c1aec6['_']['_ord_max']=0; $c1aec6['replying?'] = (bool)true; $q817c7=($o4032b['Reply']=='' or !$o4032b['IsReplyVisible']); $dd5d3d=$q817c7? $_strings['pt--reply-to-comment']:$_strings['pt--edit-reply-to-comment']; $f4dc70=array ( '.note-id' => $b39a37['ID'], '.comment-id' => $o4032b['ID'], '.reply-action' => $q817c7? 'new':'edit', 'form-action' => i83c8('e2s_comment_edit_reply'), 'submit-text' => $q817c7? $_strings['fb--publish']:$_strings['fb--save-changes'], 'create:edit?' => (bool) ($q817c7), 'reply-text' => htmlspecialchars($o4032b['Reply'],ENT_COMPAT,HSC_ENC), 'mail-back?' => (bool) ($q817c7), ); return array ( 'title' => $dd5d3d, 'heading' => $dd5d3d, 'comments' => array ('each' => array ('only' => $c1aec6)), 'form' => 'form-comment-reply', 'form-comment-reply' => $f4dc70, ); } function e2m_comment_delete($parameters=array ()) { global$_strings,$settings,$acbcce,$_config; $o4032b=e2_commentrec_with_parameters_($parameters); $i21158=$o4032b['NoteID']; if (!$o4032b){ return e2_error404_mode(); } e2_drop_caches_for_note_($i21158); @unlink(USER_FOLDER. '/last-comment.psa'); a0738( "DELETE FROM `". $_config['db_table_prefix']."Comments` ". "WHERE `ID` = '". ((int)$o4032b['ID']). "'" ); x4930(); die; } function e2m_comment_reply_delete($parameters=array ()) { global$_strings,$settings,$_config; $o4032b=e2_commentrec_with_parameters_($parameters); if (!$o4032b){ return e2_error404_mode(); } a0738( "UPDATE `". $_config['db_table_prefix']."Comments` SET ". "`Reply`='', ". "`IsReplyFavourite`='0' ". "WHERE `ID`=".((int)$o4032b['ID']) ); x4930(); die; } function e2m_unsubscribe($parameters){ global$_strings,$_config; $r70a17="ORDER BY `ID` DESC"; $b39a37=$parameters['*note']; $i21158=$b39a37['ID']; $a0c83f=$parameters['unsubscribe-email']; $m1bc29=$parameters['unsubscribe-key']; $a0c83f=str_replace(' ','+',$a0c83f); if ($i21158){ a0738( "SELECT `ID`, `Stamp` FROM `". $_config['db_table_prefix']."Comments` ". "WHERE `NoteID`=". $i21158 ." AND `IsSubscriber`=1 AND `AuthorEmail`='". $a0c83f ."' ". $r70a17, 'get subscriber’s comments ids' ); $result=z0d6b(); if(count($result) < 1) { $f2cb9d['unsubscribe']['success?']=false; $f2cb9d['unsubscribe']['error-message']=$_strings['gs--you-are-not-subscribed']; } else { $e06d4c=@$result[0]; $e97f69=md5($e06d4c['ID'].$e06d4c['Stamp'] .'x'); $e260ca=false; if ($m1bc29==$e97f69){ a0738( "UPDATE `". $_config['db_table_prefix']."Comments` ". "SET `IsSubscriber`=0 ". "WHERE `NoteID`=". $i21158 ." ". "AND `AuthorEmail` = '". c7928($a0c83f). "'", 'unsubscribe' ); $e260ca=true; $f2cb9d['unsubscribe']['success?']=true; $f2cb9d['unsubscribe']['note-title']=a6f10( htmlspecialchars($b39a37['Title'],ENT_COMPAT,HSC_ENC) ); $f2cb9d['unsubscribe']['note-href']=i83c8( 'e2m_note', array ('*note' => $b39a37) ); } if (!$e260ca){ $f2cb9d['unsubscribe']['success?']=false; $f2cb9d['unsubscribe']['error-message']=$_strings['gs--unsubscription-didnt-work']; } } } else { $f2cb9d['unsubscribe']['success?']=false; $f2cb9d['unsubscribe']['error-message']=$_strings['gs--post-not-found']; } return $f2cb9d; } function e2m_comment_flag($parameters){ n6e30($parameters); e2_go_to(i83c8('e2m_note',$parameters)); die; } function e2m_comment_flag_ajax($parameters){ try { n6e30($parameters); $b67142=$parameters; $b67142['value'] = !$parameters['value']; if($parameters['value']==1){ $i99859=i83c8('e2m_comment_flag_ajax',$b67142); $i1fa03='on-rehref|'. $i99859; } else { $i99859=i83c8('e2m_comment_flag_ajax',$b67142); $i1fa03='off-rehref|'. $i99859; } } catch (AeMySQLException $e){ c12f6($ae1671,'Could set comment flag'); $i1fa03='error'; } if(array_key_exists('result',$_POST) and ($_POST['result']=='ajaxresult')) { die ($i1fa03); } else { e2_go_to(i83c8('e2m_note',$parameters)); die; } } function n6e30($parameters){ $o4032b=e2_commentrec_with_parameters_($parameters); $i21158=$o4032b['NoteID']; if ($o4032b){ taa79('Comments', array ( 'ID' => $o4032b['ID'], $parameters['flag'] => (int) ($parameters['value']==1), )); e2_drop_caches_for_note_($i21158); } } function e2s_comment_process(){ global$_strings,$_fp_error; list ($i21158,$u69b97,$e9d090)=r1a90(); if(Log::$ned2b5)__log('Comments: processed, noteid <'. $i21158 .'>, commentid <'. $u69b97 .'>'); if (!$u69b97){ $e05c36=''; if($_fp_error==FP_NOT_COMMENTABLE){ o8a40($_strings['er--post-not-commentable'],E2E_USER_ERROR); } elseif($_fp_error==FP_EMPTY_FIELD){ o8a40($_strings['er--name-email-text-required'],E2E_USER_ERROR); } elseif($_fp_error==FP_COMMENT_TOO_LONG){ $qaa731=$_strings['gs--comment-too-long']; $e05c36=$_strings['gs--comment-too-long-description']; } elseif($_fp_error==FP_COMMENT_DOUBLE_POST){ $qaa731=$_strings['gs--comment-double-post']; $e05c36=$_strings['gs--comment-double-post-description']; } elseif($_fp_error==FP_COMMENT_SPAM_SUSPECT){ $qaa731=$_strings['gs--comment-spam-suspect']; $e05c36=$_strings['gs--comment-spam-suspect-description']; } else { o8a40($_strings['er--error-occurred'].' ('. $_fp_error .')'); } if ($e05c36){ $f2cb9d['title']=$qaa731; $f2cb9d['heading']=$qaa731; $f2cb9d['form']='form-unaccepted-comment'; $f2cb9d['form-unaccepted-comment'] = array ( 'reason' => $e05c36, 'text' => @htmlspecialchars($e9d090['text'],ENT_COMPAT,HSC_ENC), ); return $f2cb9d; } } if ($i21158){ e2_go_to(i83c8('e2m_note', array ('*note' => v4627($i21158)))); } else { e2_go_to(); } die; } function e2s_comment_edit_reply(){ global$_strings,$z57de2,$_config; $me84af=@$_POST['text']; if(trim($me84af)=='')$me84af=''; $i21158=@$_POST['note-id']; $raad65=v4627($i21158); $u69b97=@$_POST['comment-id']; $e06d4c=k0d27($u69b97); $z54eb6=isset ($_POST['mail-back']); $y54fa9=time(); if (@$_POST['reply-action']=='new'){ $oe0e30=time(); } @unlink(e2_note_cache_filename_with_id_($i21158 .'-comments')); @unlink(e2_note_cache_filename_with_id_($i21158 .'-comments-author')); if ($e06d4c){ a0738( "UPDATE `". $_config['db_table_prefix']."Comments` SET ". "`Reply`='". c7928($me84af) ."', ". ( isset ($oe0e30)? ( "`ReplyStamp`='". $oe0e30 ."', " ) : ( "" ) ). "`ReplyLastModified`='". $y54fa9 ."', ". "`IsReplyVisible`='1' ". "WHERE `ID`=".((int)$u69b97), 'update comment reply' ); $bd58c0=i83c8('e2m_note', array ('*note' => $raad65)); if ($z54eb6 and $me84af!=''){ $pc6827['comment-time'] = array ($e06d4c['Stamp'],w5c05()); $pc6827['commenter']=$e06d4c['AuthorName']; $pc6827['commenter-email']=$e06d4c['AuthorEmail']; $pc6827['comment-text']=$e06d4c['Text']; $pc6827['note-title']=a6f10($raad65['Title']); $pc6827['reply-time'] = array (time(),w5c05()); $pc6827['blog-author']=s2640(); $pc6827['note-href']=$bd58c0; $pc6827['comment-href']=$bd58c0; $pc6827['reply-text']=$me84af; if(1){ $jde7a3=g3e5c( 'comment-reply',$pc6827 ); $vb904c=e2l_get_string( 'em--comment-reply', $pc6827 ); $w77613=$e06d4c['AuthorEmail']; $e1a49b='From: '. oaed2(); xa41b($w77613,$vb904c,$jde7a3,$e1a49b); } if(1){ unset ($pc6827['commenter-email']); $e1a49b='From: '. oaed2(); foreach (pd225($raad65,$e06d4c['AuthorEmail']) as $d39c63){ $gba570=$d39c63['AuthorEmail']; $m6fd85=md5($d39c63['ID'].$d39c63['Stamp'].'x'); $pc6827['unsubscribe-href']=i83c8('e2m_unsubscribe', array ( '*note' => $raad65, 'unsubscribe-email' => $gba570, 'unsubscribe-key' => $m6fd85, ) ); $w77613=$gba570; $jde7a3=g3e5c('comment-reply-to-public',$pc6827); $vb904c=e2l_get_string( 'em--comment-reply-to-public-subject', $pc6827 ); xa41b($w77613,$vb904c,$jde7a3,$e1a49b); } } } e2_go_to($bd58c0); } else { x4930(); } die; } function n86f8($raad65,$e06d4c,$wb1bc2){ global$_config,$full_blog_url; if(Log::$ned2b5)__log('Package comment '. $e06d4c['ID'] .'...'); if ($raad65===null){ $raad65=v4627($e06d4c['NoteID']); } $pc6827['number']=$wb1bc2; $v7b397=!empty ($e06d4c['IsGIPUsed']); $pc6827['gip-used?']=$v7b397; $pc6827['gip']=$pc6827['gip-used?']?$e06d4c['GIP']:''; $pc6827['name']=htmlspecialchars($e06d4c['AuthorName'],ENT_NOQUOTES,HSC_ENC); $pc6827['userpic-href']=DEFAULT_USERPIC_FILENAME; if ($v7b397){ $o51c69=AVATARS_FOLDER.$e06d4c['GIP'] .'-'. $e06d4c['GIPAuthorID'] .'.jpg'; if(is_file(MEDIA_ROOT_FOLDER.$o51c69)) { $pc6827['userpic-href']=$full_blog_url .'/'. $o51c69; } } $pc6827['name-href']=''; if ( $v7b397 and $i020fc=e2_get_user_profile_url($e06d4c['GIP'],$e06d4c['AuthorProfileLink']) ) { $pc6827['name-href']=$i020fc; } if (ge852()) { $pc6827['email']=htmlspecialchars($e06d4c['AuthorEmail'],ENT_NOQUOTES,HSC_ENC); if (''!=trim($e06d4c['IP'])) { $pc6827['ip']=$e06d4c['IP']; $pc6827['ip-href']=$_config['whois_service'].$pc6827['ip']; } } $pc6827['author-name']=s2640(); $pc6827['important?'] = (bool)$e06d4c['IsFavourite']; $pc6827['reply-visible?'] = (bool) ($e06d4c['IsVisible'] && $e06d4c['IsReplyVisible']); $pc6827['reply-important?'] = (bool)$e06d4c['IsReplyFavourite']; $pc6827['spam-suspect?'] = (bool)$e06d4c['IsSpamSuspect']; $x10a7e=array ((int)$e06d4c['Stamp'],d0923($raad65)); $pc6827['time']=$x10a7e; $pc6827['last-modified']=$x10a7e; if ($e06d4c['LastModified']) $pc6827['last-modified'] = array ((int)$e06d4c['LastModified'],d0923($raad65)); if ($e06d4c['ReplyStamp']) $pc6827['reply-time'] = array ((int)$e06d4c['ReplyStamp'],d0923($raad65)); if ($e06d4c['ReplyLastModified']) $pc6827['reply-last-modified'] = array ((int)$e06d4c['ReplyLastModified'],d0923($raad65)); if (ge852()) { $pc6827['subscriber?'] = (bool)$e06d4c['IsSubscriber']; $pc6827['new?'] = (bool)$e06d4c['IsNew']; $pc6827['first-new?']=false; if (!@$_config['read_only']) { if ($e06d4c['IsFavourite']) { $pc6827['important-toggle-href']=i83c8( 'e2m_comment_flag_ajax', array ('*note' => $raad65,'comment-number' => $wb1bc2,'flag' => 'IsFavourite','value' => 0) ); } else { $pc6827['important-toggle-href']=i83c8( 'e2m_comment_flag_ajax', array ('*note' => $raad65,'comment-number' => $wb1bc2,'flag' => 'IsFavourite','value' => 1) ); } if ($e06d4c['IsReplyFavourite']) { $pc6827['reply-important-toggle-href']=i83c8( 'e2m_comment_flag_ajax', array ( '*note' => $raad65,'comment-number' => $wb1bc2,'flag' => 'IsReplyFavourite','value' => 0 ) ); } else { $pc6827['reply-important-toggle-href']=i83c8( 'e2m_comment_flag_ajax', array ( '*note' => $raad65,'comment-number' => $wb1bc2,'flag' => 'IsReplyFavourite','value' => 1 ) ); } $pc6827['edit-href']=i83c8( 'e2m_comment_edit', array ('*note' => $raad65,'comment-number' => $wb1bc2) ); $pc6827['removed-toggle-href']=i83c8( 'e2m_comment_flag_ajax', array ( '*note' => $raad65,'comment-number' => $wb1bc2, 'flag' => 'IsVisible','value' => !$e06d4c['IsVisible'] ) ); $pc6827['removed-reply-toggle-href']=i83c8( 'e2m_comment_flag_ajax', array ( '*note' => $raad65,'comment-number' => $wb1bc2, 'flag' => 'IsReplyVisible','value' => !$e06d4c['IsReplyVisible'] ) ); $ge36ef=i83c8( 'e2m_comment_reply', array ('*note' => $raad65,'comment-number' => $wb1bc2) ); if ($e06d4c['Reply']=='' or !$e06d4c['IsReplyVisible']) { $pc6827['reply-href']=$ge36ef; } else { $pc6827['edit-reply-href']=$ge36ef; } } } if(mb_strlen($e06d4c['Text']) > $_config['max_comment_length']) { $e06d4c['Text']=mb_substr($e06d4c['Text'],0,$_config['max_comment_length']); } $mb64b8=$raad65['FormatterID']==='raw'?'neasden':$raad65['FormatterID']; $g2bfe4=c154e($mb64b8,$e06d4c['Text'],'simple'); $pc6827['text']=$g2bfe4['text-final']; $pc6827['reply']=''; $pc6827['replying?'] = (bool)false; $pc6827['replied?'] = (bool) ( (trim($e06d4c['Reply']) != '') && ($e06d4c['IsReplyVisible']) ); if ((string)$e06d4c['Reply']!==''){ $g2bfe4=c154e($raad65['FormatterID'],$e06d4c['Reply'],'full'); $pc6827['reply']=$g2bfe4['text-final']; } if(array_key_exists('_',$e06d4c))$pc6827['_']=$e06d4c['_']; if(Log::$ned2b5)__log('Comments: done'); return $pc6827; } function k0d27($ub80bb){ global$_config; a0738( "SELECT * FROM `". $_config['db_table_prefix']."Comments` ". "WHERE `ID` = '". $ub80bb ."'" ); $cfa816=z0d6b(); if(count($cfa816) > 0){ return $cfa816[0]; } else { return false; } } function de5b6($w0604c){ e2_comment_set_flag('IsVisible',$w0604c); } function p3183($v0dd2c){ e2_comment_set_flag('IsReplyVisible',$v0dd2c); } function d66aa($wea59a){ global$_strings,$_config,$settings; $de3cb9=@$_COOKIE[p8c3b('commenter_name')]; $xf92ee=@$_COOKIE[p8c3b('commenter_email')]; $e3d682=@$_COOKIE[p8c3b('commenter_ph')]; $r92399=false; if ($xf92ee and $e3d682){ foreach (pd225($wea59a) as $d39c63){ $e97f69=md5($d39c63['ID'].$d39c63['Stamp'] .'x'); if ( $d39c63['AuthorEmail']==$xf92ee and $e3d682==$e97f69 ){ $r92399=true; break; } } } $rc50d0=$_strings['fb--submit']; $w05fa8=kd8c5(); $x80f02=array ( '.note-id' => $wea59a['ID'], '.comment-id' => 'new', '.already-subscribed?' => (bool)$r92399, 'cookie-name' => r41f3($wea59a['ID']), 'cookie-value' => i7c9d(), 'email-field-name' => z2e04(), 'nospam-field-name-part-1' => substr($w05fa8,0,4), 'nospam-field-name-part-2' => substr($w05fa8,4), 'create:edit?' => true, 'form-action' => i83c8('e2s_comment_process'), 'submit-text' => $rc50d0, 'show-subscribe?' => (bool) !$r92399, 'subscribe?' => (bool)$r92399, 'subscription-status' => $r92399? $_strings['gs--you-are-already-subscribed']:'', 'name' => htmlspecialchars($de3cb9,ENT_COMPAT,HSC_ENC), 'email' => htmlspecialchars($xf92ee,ENT_COMPAT,HSC_ENC), 'text' => htmlspecialchars($e06d4c['Text'],ENT_COMPAT,HSC_ENC), 'email-comments-enabled?' => empty ($settings['comments']['require_gip']), 'gips' => array (), ); $p73ce1=false; $iafda1=''; foreach(e2_list_gips() as $a48e15){ if (!is_file(SYSTEM_FOLDER .'gips/'. $a48e15 .'.json')) { continue; } $w2ce07=e2_is_logged_in($a48e15); $x80f02['gips'][$a48e15] = ( e2_get_gip_auth_url($a48e15) ); if ($w2ce07){ $p73ce1=true; $xa64f4=e2_get_gip_session($a48e15); $iafda1=$xa64f4['GIP']; $x80f02['name']=htmlspecialchars( $xa64f4['AuthorName'],ENT_COMPAT,HSC_ENC ); } } if (!$x80f02['email-comments-enabled?'] and !count($x80f02['gips'])) { return false; } $x80f02['email-comments-only?'] = (count($x80f02['gips']) === 0); $x80f02['logged-in?']=$p73ce1; $x80f02['logged-in-gip']=$iafda1; $x80f02['logout-url']=$p73ce1?i83c8('e2m_gip_sign_out', array('provider' => E2GIP::get_logout_key())) : ''; return $x80f02; } function e3ce7($i21158){ return db23e($i21158,'`IsNew` = 1'); } function u254f($i21158){ return db23e($i21158,'`IsVisible` = 1'); } function db23e($i21158,$y56790){ global$_config; if (!is_numeric($i21158)) return 0; $zbc751=0; a0738( "SELECT count(*) ". "FROM `". $_config['db_table_prefix']."Comments` ". "WHERE `NoteID`=". $i21158 ." ". "AND (". $y56790. ")", 'count comments' ); $result=z0d6b(); $result=(int)$result[0]['count(*)']; $zbc751=$result; return (int)$zbc751; } function j2a6b(){ global$_config; if(Log::$ned2b5)__log('Count new comments'); $we2942=0; $s7ec7e=''; $qe8fab=''; try { a0738( "SELECT `NoteID`, `Text` FROM `". $_config['db_table_prefix']."Comments` ". "WHERE `IsNew`=1 ORDER BY `Stamp`", 'count new comments for author menu' ); $result=z0d6b(); $we2942=count($result); if ($we2942){ $i21158=$result[0]['NoteID']; $qe8fab=i83c8( 'e2m_note', array ('*note' => v4627($i21158)) ); } } catch (AeMySQLException $e){ c12f6($ae1671); if(Log::$ned2b5)__log('Could not count new comments or provide link to the latest one'); } return array ((int)$we2942,$s7ec7e,$qe8fab); } function y70a7($i21158){ global$_config; if(Log::$ned2b5)__log('Comments: getting comments for note '. $i21158); a0738( "SELECT * FROM `". $_config['db_table_prefix']."Comments` ". "WHERE `NoteID`=". @$i21158." ". "ORDER BY `Stamp`", 'get comments including deleted' ); $result=z0d6b(); return$result; } function pd225($raad65,$nd1cc6=''){ global$_config; $r70a17="ORDER BY `ID` DESC"; $f2cb9d=$uaf67c=[]; a0738( "SELECT DISTINCT `ID`, `Text`, `IsSubscriber`, `AuthorName`, `AuthorEmail`, `Stamp` ". "FROM `". $_config['db_table_prefix']."Comments` ". "WHERE `NoteID`=". @$raad65['ID'] ." ". "AND `IsSubscriber`=1 ". "AND `AuthorEmail`!='". c7928($nd1cc6) ."' ". $r70a17, 'get subscribers by note' ); $result=z0d6b(); foreach($result as $d39c63){ if (!in_array($d39c63['AuthorEmail'],$uaf67c)) { $f2cb9d[] = $d39c63; } $uaf67c[] = $d39c63['AuthorEmail']; } return $f2cb9d; } function ob387($raad65,$x3f917=NOTE_COMMENTABLE_NOW){ global$settings,$_config; $ebdb20=true; if (@$settings['comments']['fresh_only']) if (isset ($_config['comment_freshness_days'])) if ($raad65['Stamp'] < time()-$_config['comment_freshness_days']*SECONDS_IN_A_DAY) $ebdb20=false; $qc770a=$raad65['IsCommentable']; if ($x3f917==NOTE_COMMENTABLE_NOW_CONDITIONALLY){ $qc770a=true; } return ( $raad65['IsPublished'] and ab44b($raad65) and $ebdb20 and $qc770a ); } function e2_commentrec_with_parameters_($parameters=array ()) { $b39a37=$parameters['*note']; $fa5d49=y70a7($b39a37['ID']); $o4032b=@$fa5d49[$parameters['comment-number']-1]; if ($o4032b){ $o4032b['noterec']=$b39a37; return $o4032b; } } function r1a90($r98ea6=''){ global$settings,$acbcce,$_config,$_fp_error; $_fp_error=false; $r0d5f1=z2e04(); $i21158=$u69b97=$eb0689=$a0c83f=$j1cb25=''; if(array_key_exists('note-id',$_POST)) $i21158=trim(@$_POST['note-id']); if(array_key_exists('comment-id',$_POST)) $u69b97=trim(@$_POST['comment-id']); if(array_key_exists('comment-number',$_POST)) $wb1bc2=trim(@$_POST['comment-number']); if(array_key_exists('name',$_POST)) $eb0689=trim(@$_POST['name']); if(array_key_exists($r0d5f1,$_POST)) $a0c83f=trim(@$_POST[$r0d5f1]); if(array_key_exists('text',$_POST)) $j1cb25=trim(@$_POST['text']); $me3a2d=p07e3('Comments'); if(stripos($me3a2d['Collation'],'utf8mb4')!==0){ $eb0689=jff7c($eb0689); $j1cb25=jff7c($j1cb25); } if ($u69b97=='new'){ $p396a4=e2_get_logged_gip_name(); if ($p396a4){ $xa64f4=e2_get_gip_session($p396a4); $eb0689=trim($xa64f4['AuthorName']); $a0c83f=''; $qdec42=$xa64f4['GIPAuthorID']; } } else { if(array_key_exists('gip',$_POST))$p396a4=trim(@$_POST['gip']); } $e07d3d=( (array_key_exists('already-subscribed',$_POST) and $_POST['already-subscribed']) or (array_key_exists('subscribe',$_POST) and $_POST['subscribe']) ); $n20612=time(); $e9d090['text']=$j1cb25; if ($u69b97=='new' and !$p396a4){ ec64a('commenter_name',$eb0689); ec64a('commenter_email',$a0c83f); } $f848b5=($u69b97=='new' and ( ueb9a() or e2_cookie_data_is_spam_suspicios_for_note_id_($i21158) )); $bc2b1a=1; $result=false; if (!is_numeric($i21158)) { $_fp_error=FP_NO_ID_OR_NEW; } elseif (!is_numeric($u69b97) and !($u69b97=='new')) { $_fp_error=FP_NO_ID_OR_NEW; } else { if ( $j1cb25=='' or ( !$p396a4 and ($eb0689=='' or $a0c83f=='') ) ) { $_fp_error=FP_EMPTY_FIELD; } if ($u69b97=='new'){ $c795f1=@unserialize(file_get_contents(USER_FOLDER. '/last-comment.psa')); if(md5($eb0689.$a0c83f.$j1cb25)==$c795f1['md5']) { $_fp_error=FP_COMMENT_DOUBLE_POST; } if ( isset ($_config['max_comment_length']) and strlen(@$_POST['text']) > ($_config['max_comment_length']) ){ $_fp_error=FP_COMMENT_TOO_LONG; } $b39a37=v4627($i21158); if ($u69b97=='new' and !ob387($b39a37)) { $_fp_error=FP_NOT_COMMENTABLE; } if ($f848b5){ $_fp_error=FP_COMMENT_SPAM_SUSPECT; } } } if (!$_fp_error){ e2_drop_caches_for_note_($i21158); if ($u69b97=='new'){ $o4032b=array ( 'NoteID' => (int)$i21158, 'AuthorName' => $eb0689, 'AuthorEmail' => $a0c83f, 'Text' => $j1cb25, 'Reply' => '', 'IsVisible' => 1, 'IsAnswerAware' => 1, 'IsSubscriber' => (int)$e07d3d, 'IsSpamSuspect' => (int)$f848b5, 'IsNew' => (int)$bc2b1a, 'Stamp' => (int)time(), 'LastModified' => (int)time(), 'IP' => c7928($_SERVER['REMOTE_ADDR']), 'IsGIPUsed' => intval(!empty ($p396a4) && !empty ($qdec42)), 'GIP' => !empty ($p396a4)?c7928($p396a4):'', 'GIPAuthorID' => !empty ($qdec42)?c7928($qdec42):'', ); try { $o4032b=x9943('Comments',$o4032b); $u69b97=$o4032b['ID']; $c795f1=array ( 'id' => $u69b97, 'md5' => md5($eb0689.$a0c83f.$j1cb25), ); @s6e52(USER_FOLDER. 'last-comment.psa',serialize($c795f1)); $result=(int)$u69b97; $b303ee=md5($o4032b['ID'].$o4032b['Stamp'].'x'); ec64a('commenter_ph',$b303ee); $raad65=v4627($i21158); $bd58c0=i83c8('e2m_note', array ('*note' => $raad65)); $pc6827['comment-time'] = array ($n20612,w5c05()); $pc6827['commenter']=$eb0689; $pc6827['commenter-email']=$a0c83f; $pc6827['comment-text']=$j1cb25; $pc6827['note-title']=$raad65['Title']; $pc6827['note-href']=$bd58c0; $pc6827['comment-href']=$bd58c0; $pc6827['comments-disable-href']=i83c8('e2m_note_flag', array ( '*note' => $raad65, 'flag' => 'IsCommentable', 'value' => 0 )); $pc6827['reply-href']=i83c8( 'e2m_comment_reply', array ( '*note' => $raad65, 'comment-number' => $wb1bc2 ) ); if (isset ($settings['user']['email']) and @$settings['notifications']['new_comments']) { $jde7a3=g3e5c( 'comment-new-to-author',$pc6827 ); $vb904c=e2l_get_string( 'em--comment-new-to-author-subject', $pc6827 ); $w77613=$settings['user']['email']; $e1a49b = 'From: '. oaed2() ."\r\n". 'Reply-to: '. $eb0689 .' <'. $a0c83f .">"; xa41b($w77613,$vb904c,$jde7a3,$e1a49b); } if (!$f848b5){ unset ($pc6827['commenter-email']); $e1a49b='From: '. oaed2(); foreach (pd225($raad65,$a0c83f) as $d39c63){ $gba570=$d39c63['AuthorEmail']; $m6fd85=md5($d39c63['ID'].$d39c63['Stamp'].'x'); $pc6827['unsubscribe-href']=i83c8('e2m_unsubscribe', array ( '*note' => $raad65, 'unsubscribe-email' => $gba570, 'unsubscribe-key' => $m6fd85 ) ); $w77613=$gba570; $jde7a3=g3e5c('comment-new-to-public',$pc6827); $vb904c=e2l_get_string( 'em--comment-new-to-public-subject', $pc6827 ); xa41b($w77613,$vb904c,$jde7a3,$e1a49b); } } } catch (AeMySQLException $e){ c12f6($ae1671,'Could not insert comment'); $_fp_error=FP_INSERT_ERROR; } } else { $bfd6f3=array ( 'ID' => $u69b97, 'Text' => $j1cb25, 'IsSubscriber' => ((int)$e07d3d), 'LastModified' => time(), ); if (!empty ($eb0689))$bfd6f3['AuthorName']=$eb0689; if (!empty ($a0c83f))$bfd6f3['AuthorEmail']=$a0c83f; try { taa79('Comments',$bfd6f3); $result=(int)$u69b97; } catch (AeMySQLException $e){ c12f6($ae1671,'Could not update comment'); $_fp_error=FP_UPDATE_ERROR; }; } } if ($r98ea6=='ajaxresult') return $i1fa03; else return array ((int)$i21158,$result,$e9d090); } function e2m_most_commented(){ global$settings,$_strings,$_config; $sa0acf=@$_GET['period']; if ($sa0acf=='')$sa0acf=$_config['hot_period']; $e632a2=time()-p35c3($sa0acf); return nd864(array ( 'query' => "SELECT `IsVisible`, `Stamp`, `NoteID` ID, count(*) quantity ". "FROM `". $_config['db_table_prefix']."Comments` c ". "WHERE (`Stamp` > ". $e632a2.") ". "AND c.`IsVisible` = 1 ". "GROUP BY ID ". "ORDER BY quantity ". "DESC ". "LIMIT ".$settings['appearance']['notes_per_page'], 'query-returns-only-ids' => 1, 'limit' => $settings['appearance']['notes_per_page'], 'title' => e2l_get_string('pt--most-commented', array ('period' => $sa0acf)), 'heading' => e2l_get_string('pt--most-commented', array ('period' => $sa0acf)), 'nothing' => $_strings['gs--no-such-notes'], )); } function e2m_favourites($parameters=array ()) { global$_config,$_strings; return nd864(array ( 'query' => "SELECT * FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `IsPublished`=1 AND `IsFavourite`=1 ". v6f32(ge852()). "ORDER BY `Stamp` DESC", 'page' => $parameters['page'], 'candy' => 'e2m_favourites', 'parameters' => $parameters, 'title' => $_strings['pt--favourites'], 'heading' => $_strings['pt--favourites'], 'nothing' => $_strings['gs--no-favourites'], )); } function p35c3($sa0acf){ if ('year'==$sa0acf) return SECONDS_IN_A_YEAR; elseif ('month'==$sa0acf) return SECONDS_IN_A_MONTH; elseif ('week'==$sa0acf) return SECONDS_IN_A_DAY*7; elseif ('day'==$sa0acf) return SECONDS_IN_A_DAY; else return PHP_INT_MAX; } function k8696($o8d777){ global$_current_url; if(Log::$ned2b5)__log('Arbitrary list ('. $o8d777['_log'] .') {'); $if4ac8=null; if ($o8d777['cache'] and is_file($o8d777['cache-filename'])) { $if4ac8=@unserialize(file_get_contents($o8d777['cache-filename'])); } $lf957e=true; if ($o8d777['cache-filename-expires']) { if ($o8d777['cache'] and is_file($o8d777['cache-filename-expires'])) { $l07cc6=time(); $a09bcb=(int) @file_get_contents($o8d777['cache-filename-expires']); if(Log::$ned2b5)__log('List expires '. date('r',$a09bcb) .', now '. date('r',$l07cc6)); $lf957e=($l07cc6 < $a09bcb); } } $qdbb0c=array(); if ($o8d777['cache'] and is_array($if4ac8) and $lf957e){ if(Log::$ned2b5)__log('Retrieve cached ctree'); $qdbb0c=$if4ac8; } else { if(Log::$ned2b5)__log('Assemle cacheable ctree...'); $e4358b=array(); try { a0738( $o8d777['query'], 'get "'. $o8d777['_log'] .'" list' ); $result=z0d6b(); foreach($result as $c8ce4b => $b39a37){ $b39a37=v4627($b39a37['ID']); if (ab44b($b39a37) and $b39a37['IsPublished']) { $raad65['_']['_id']=$b39a37['ID']; $raad65['_']['_ord']=$c8ce4b; $raad65['_']['_ord_max']=count($result)-1; $raad65['href']=i83c8('e2m_note', array ('*note' => $b39a37)); $raad65['time'] = array ($b39a37['Stamp'],d0923($b39a37)); $raad65['title']=a6f10(htmlspecialchars($b39a37['Title'],ENT_NOQUOTES,HSC_ENC)); $qdbb0c[] = $raad65; } } $if4ac8=$qdbb0c; if ($o8d777['cache']) { @s6e52($o8d777['cache-filename'],serialize($if4ac8)); if ($o8d777['cache-filename-expires']) { @s6e52($o8d777['cache-filename-expires'],time()+$o8d777['expires-after']); } } } catch (AeMySQLException $e){ c12f6($ae1671); if(Log::$ned2b5)__log('Could not get arbitrary list from database'); } } foreach ($qdbb0c as $c8ce4b => $i9e366){ $qdbb0c[$c8ce4b]['current?'] = ($qdbb0c[$c8ce4b]['href']==$_current_url); } if(Log::$ned2b5)__log('}'); return $qdbb0c; } function ze9f2(){ global$_config; $e632a2=time()-p35c3($_config['popular_period']); return k8696(array ( '_log' => 'most_read', 'cache' => CACHE_POPULAR, 'cache-filename' => CACHE_FILENAME_POPULAR, 'cache-filename-expires' => CACHE_FILENAME_POPULAR_EXPIRES, 'expires-after' => SECONDS_IN_A_DAY, 'query' => ( "SELECT n.`ID`, n.`Title`, n.`IsFavourite`, a.`EntityID`, SUM(a.`ReadCount`) ReadCount ". "FROM `". $_config['db_table_prefix']."Actions` a, ". "`". $_config['db_table_prefix']."Notes` n  ". "WHERE a.`Stamp` > ". $e632a2 ." ". v6f32(). "AND a.`EntityID` = n.`ID` ". "GROUP BY a.`EntityID` ". "ORDER BY `IsFavourite` DESC, ReadCount DESC ". "LIMIT 10" ), )); } function x7f52(){ global$_strings; $pe292c=[ 'title' => $_strings['nm--most-read'], ]; $pe292c['each']=ze9f2(); if(count($pe292c['each']) < 10) unset ($pe292c['each']); return $pe292c; } function e2m_password_reset(){ global$_strings,$_superconfig,$settings; if (!is_file(USER_FOLDER. 'password-reset.psa')) { $v3c6e0=d4c49(rand()); $x572d4=i83c8('e2m_password', array ('recovery-key' => $v3c6e0)); @s6e52(USER_FOLDER. 'password-reset.psa',$x572d4); } $f2cb9d['title']=$_strings['pt--password-reset']; $f2cb9d['heading']=$_strings['pt--password-reset']; $d5bef8=(bool) ($w77613=$settings['user']['email']); $f2cb9d['form']='form-password-reset-email'; $f2cb9d['form-password-reset-email'] = array ( 'form-action' => i83c8('e2s_password_reset_email'), 'show-controls?' => $d5bef8, 'submit-text' => $_strings['fb--send-link-by-email'], ); if (!@$_superconfig['user_has_no_access_to_files']) { $f2cb9d['form-password-reset-email']['reset-info']=$_strings['gs--password-reset-link-saved']; } elseif (!$d5bef8){ o8a40($_strings['er--cannot-reset-password']); } return $f2cb9d; } function e2s_password_reset_email(){ global$_strings,$settings; if($_SERVER['REQUEST_METHOD']!='POST') return e2_go_to(); if(array_key_exists('email',$_POST))$a0c83f=trim($_POST['email']); if (!$a0c83f){ o8a40($_strings['er--cannot-send-link-email-empty']); e2_go_to(i83c8('e2m_password_reset')); die; } $k22207=@file_get_contents(USER_FOLDER. 'password-reset.psa'); if(strlen($k22207)==0){ o8a40($_strings['er--error-occurred']); e2_go_to(i83c8('e2m_password_reset')); die; } if ($w77613=$settings['user']['email']) { if ($a0c83f==$w77613){ $jde7a3=g3e5c( 'password-reset', array ('reset-href' => $k22207) ); $vb904c=$_strings['em--password-reset-subject']; $e1a49b='From: '. oaed2(); xa41b($w77613,$vb904c,$jde7a3,$e1a49b); } o8a40($_strings['gs--password-reset-link-sent-maybe'],E2E_MESSAGE); e2_go_to(i83c8('e2m_password_reset')); die; } die; } function e2m_password($parameters){ global$settings,$_strings; $l2d832=false; $v3c6e0=''; if(array_key_exists('recovery-key',$parameters)) { $v3c6e0=$parameters['recovery-key']; $x572d4=i83c8('e2m_password', array ('recovery-key' => $v3c6e0)); $k22207=@file_get_contents(USER_FOLDER. 'password-reset.psa'); if(strlen($k22207) > 0){ $l2d832=($x572d4==$k22207); } } if (ge852() or $l2d832){ $f2cb9d['title']=$_strings['pt--password']; $f2cb9d['heading']=$_strings['pt--password-for-blog']; if ($l2d832){ $f2cb9d['title']=$_strings['pt--password-reset']; $f2cb9d['heading']=$_strings['pt--password-reset']; } $f2cb9d['form']='form-password'; $f2cb9d['form-password'] = array ( 'form-action' => i83c8('e2s_password_save'), '.recovery-key' => $v3c6e0, 'recovering?' => $l2d832, 'submit-text' => $_strings['fb--change'], ); return $f2cb9d; } else { e2_go_to(); } } function e2m_sessions(){ global$settings,$_strings; $x2d6d8=d7785(); $f2cb9d['title']=$_strings['pt--sessions']; $f2cb9d['heading']=$_strings['pt--sessions']; $f161bc=array(); $v3c6e0=$_COOKIE[p8c3b('key')]; foreach ($x2d6d8['sessions'] as $c8ce4b => $i9e366){ $f161bc[] = array ( 'current?' => d4c49($v3c6e0)===$i9e366['key_hash'], 'opened' => array ((int)$i9e366['stamp'],v3211()), 'ip-address' => $i9e366['remote_ip'], 'source' => ($i9e366['remote_ip']=='127.0.0.1')? $_strings['gs--locally']:$i9e366['remote_ip'], 'title' => icc31($i9e366['ua']), 'user-agent' => $i9e366['ua']? $i9e366['ua']:$_strings['gs--unknown'], ); } $f161bc=array_reverse($f161bc); $f2cb9d['sessions']['each']=$f161bc; if(count($f161bc) > 1){ $f2cb9d['form']='form-sessions'; $f2cb9d['form-sessions'] = array ( 'form-action' => i83c8('e2s_drop_other_sessions'), 'submit-text' => $_strings['fb--end-all-sessions-but-this'], ); } return $f2cb9d; } function e2m_sign_in(){ if (ge852()) { e2_go_to(i83c8('e2m_frontpage', array ('page' => 1))); } else { return array (); } } function e2m_sign_out(){ global$_strings; $x2d6d8=d7785(); $n48bb9=-1; if(array_key_exists('sessions',$x2d6d8) and is_array($x2d6d8['sessions'])) { foreach ($x2d6d8['sessions'] as $c8ce4b => $i9e366){ $v3c6e0=$_COOKIE[p8c3b('key')]; if (d4c49($v3c6e0)===$i9e366['key_hash']) { $n48bb9=$c8ce4b; break; } } } if ($n48bb9 > -1) unset ($x2d6d8['sessions'][$n48bb9]); if (!p1d21($x2d6d8)) { o8a40($_strings['er--cannot-write-auth-data'],E2E_PERMISSIONS_ERROR); } ec64a('key',''); e2_go_to(); die; } function e2s_password_save(){ global$settings,$_strings; $l2d832=false; $x0512f=trim($_POST['old-password']); if ($v3c6e0=trim($_POST['recovery-key'])) { $x572d4=i83c8('e2m_password', array ('recovery-key' => $v3c6e0)); $k22207=@file_get_contents(USER_FOLDER. 'password-reset.psa'); if(strlen($k22207) > 0){ $l2d832=($x572d4==$k22207); } } if (ga8cf($x0512f) or $l2d832){ $s88162=trim($_POST['new-password']); if ($s88162!=''){ if (@s6e52(USER_FOLDER. '/password-hash.psa',serialize(d4c49($s88162)))) { @unlink(USER_FOLDER. 'password-reset.psa'); o8a40($_strings['gs--password-changed'],E2E_MESSAGE); e2_go_to(); } else { o8a40($_strings['er--could-not-change-password'],E2E_PERMISSIONS_ERROR); e2_go_to(i83c8('e2m_password', array ('recovery-key' => ''))); } } else { o8a40($_strings['er--no-password-entered'],E2E_USER_ERROR); e2_go_to(i83c8('e2m_password', array ('recovery-key' => ''))); } } else { o8a40($_strings['er--wrong-password'],E2E_USER_ERROR); e2_go_to(i83c8('e2m_password', array ('recovery-key' => ''))); } die; } function e2s_sign_in_necessary(){ e2_go_to(i83c8('e2m_sign_in')); die; } function e2s_sign_in(){ global$_strings; $x2d6d8=d7785(); if($_SERVER['REQUEST_METHOD']=='POST'){ $r5f4dc=@$_POST['password']; $w6bc8e=@$_POST['is_public_pc']; } else { $r5f4dc=@$_GET['password']; $w6bc8e=false; } if (ga8cf($r5f4dc)) { @unlink(USER_FOLDER. 'password-reset.psa'); $v21d6f=array ( 'stamp' => time(), 'remote_ip' => $_SERVER['REMOTE_ADDR'], 'key_hash' => qe8ed($w6bc8e), 'ua' => $_SERVER['HTTP_USER_AGENT'], ); $x2d6d8['sessions'][] = $v21d6f; } elseif(strlen(trim($r5f4dc)) > 0){ qa711(); o8a40($_strings['er--wrong-password'],E2E_USER_ERROR); } if (!p1d21($x2d6d8)) { o8a40($_strings['er--cannot-write-auth-data'],E2E_PERMISSIONS_ERROR); e2_go_to(); die; } x4930(); die; } function e2s_drop_other_sessions(){ global$_strings; $x2d6d8=d7785(); foreach ($x2d6d8['sessions'] as $c8ce4b => $i9e366){ $v3c6e0=$_COOKIE[p8c3b('key')]; if (d4c49($v3c6e0)===$i9e366['key_hash']) { $v21d6f=$i9e366; break; } } $x2d6d8['sessions'] = array ($v21d6f); if (!p1d21($x2d6d8)) { o8a40($_strings['er--cannot-write-auth-data'],E2E_PERMISSIONS_ERROR); } x4930(); die; } function ga8cf($r5f4dc){ $h8e9a8=@unserialize(file_get_contents(USER_FOLDER. '/password-hash.psa')); return (d4c49($r5f4dc)===$h8e9a8 and trim($r5f4dc)!=''); } function qe8ed($m2a2a4=false){ global$settings; $v3c6e0=r2a24(); $b3f363=d4c49($v3c6e0); ec64a('key',$v3c6e0, !$m2a2a4); return $b3f363; } function ge852(){ global $a1c0b7,$settings,$_auth_sessions; if (isset ($a1c0b7)) return $a1c0b7; $a1c0b7=false; if (isset ($_COOKIE[p8c3b('key')])) { $v3c6e0=$_COOKIE[p8c3b('key')]; $x2d6d8=d7785(); $r0f83b=array(); if(array_key_exists('sessions',$x2d6d8) and is_array($x2d6d8['sessions'])) { foreach ($x2d6d8['sessions'] as $v21d6f){ $r0f83b[] = $v21d6f['key_hash']; } $_auth_sessions['count']=count($x2d6d8['sessions']); } if(1){ $a1c0b7=(bool)in_array(d4c49($v3c6e0),$r0f83b,true); } if (!$a1c0b7){ ec64a('key',''); } } return $a1c0b7; } function d4c49($d25d90){ if(function_exists('sha1')) { return sha1($d25d90); } else { return substr(md5($d25d90).md5(' '.$d25d90),0,40); } } function d7785(){ if(is_file(USER_FOLDER.'auth.psa')) { $x2d6d8=unserialize(@file_get_contents(USER_FOLDER.'auth.psa')); if ($x2d6d8) return $x2d6d8; } return array (); } function p1d21($x2d6d8){ return s6e52(USER_FOLDER.'auth.psa',serialize($x2d6d8)); } function ec3fb(){ if ($v3c6e0=$_COOKIE[p8c3b('key')]) { return p8c3b('key') .'='. $v3c6e0 .""; } } function yff2e(){ if ($v3c6e0=$_COOKIE[p8c3b('key')]) { return 'Cookie: '. p8c3b('key') .'='. $v3c6e0 ."\r\n"; } return "\r\n"; } function icc31($b5269f){ global$_strings; if(strstr($b5269f,'iPhone')) return$_strings['gs--ua-iphone']; if(strstr($b5269f,'iPad')) return$_strings['gs--ua-ipad']; if(strstr($b5269f,'Opera'))$f2cb9d=$_strings['gs--ua-opera']; if(strstr($b5269f,'Firefox'))$f2cb9d=$_strings['gs--ua-firefox']; if(strstr($b5269f,'Chrome'))$f2cb9d=$_strings['gs--ua-chrome']; if(strstr($b5269f,'Safari') and !strstr($b5269f,'Chrome'))$f2cb9d=$_strings['gs--ua-safari']; if (!$f2cb9d)$f2cb9d=$_strings['gs--ua-unknown']; if(strstr($b5269f,'Macintosh')) { if ($f2cb9d)$f2cb9d.=' '. $_strings['gs--ua-for-mac']; } return $f2cb9d; } function e2j_check_password(){ $h8e9a8=@unserialize(file_get_contents(USER_FOLDER. '/password-hash.psa')); $r5f4dc=''; if(array_key_exists('password',$_POST))$r5f4dc=$_POST['password']; qa711(); if (d4c49($r5f4dc)===$h8e9a8 and trim($r5f4dc)!=''){ die ('password-correct'); } die ('password-wrong'); } function r2a24(){ $vb04ec=''; $db8d1b='0123456789abcdef'; for ($d865c0=0; $d865c0 < 40; $d865c0++)$vb04ec.=$db8d1b[mt_rand(0,15)]; $vb04ec.=time(); $vb04ec=d4c49($vb04ec); return $vb04ec; } function qa711(){ if(is_file(USER_FOLDER. 'password-wait.psa')) { $gaf788=unserialize( file_get_contents(USER_FOLDER. '/password-wait.psa') ); if ($gaf788['delay'] < 5){ $gaf788['delay'] ++; } if(time()-$gaf788['time'] > SECONDS_IN_A_MINUTE){ $gaf788['delay']=0; } $gaf788['time']=time(); } else { $gaf788=array ( 'time' => time(), 'delay' => 5, ); } s6e52(USER_FOLDER.'password-wait.psa',serialize($gaf788)); sleep($gaf788['delay']); } function s7874(){ static $o34e51; if(empty($o34e51))$o34e51=md5('seсret'); return $o34e51; } function g1305($bb45cf){ $v3c6e0=s7874(); $a16ec1=strlen($v3c6e0); $x2db95=strlen($bb45cf); $f2cb9d=''; for ($d865c0=0; $d865c0 < $x2db95+rand(16,64); ++ $d865c0){ if ($d865c0 > $x2db95){ $b462e1=rand(0,127); } elseif ($d865c0==$x2db95){ $b462e1=0; } else { $b462e1=ord($bb45cf[$d865c0]); } $r18e1b=chr(($b462e1+ord($v3c6e0[$d865c0%$a16ec1])) % 256); $f2cb9d.=$r18e1b; } $f2cb9d=base64_encode($f2cb9d); return $f2cb9d; } function aee85($bb45cf){ $v3c6e0=s7874(); $a16ec1=strlen($v3c6e0); $bb45cf=base64_decode($bb45cf); $x2db95=strlen($bb45cf); $f2cb9d=''; for ($d865c0=0; $d865c0 < $x2db95; ++ $d865c0){ $od9468=(ord($bb45cf[$d865c0]) + 256-ord($v3c6e0[$d865c0%$a16ec1])) % 256; if ($od9468===0) break; $f2cb9d.=chr($od9468); } return $f2cb9d; } function t126f(){ global$settings; if (ge852()) { return []; } else { return [ 'form-action' => i83c8('e2s_sign_in'), 'form-check-password-action' => i83c8('e2j_check_password'), 'login-name' => @$settings['author'], 'public-pc?' => false, 'reset-href' => i83c8('e2m_password_reset'), ]; } } $_candies_installer=array ( 'e2s_build', 'e2m_info', 'e2m_install', 'e2j_check_db_config', 'e2j_list_databases', 'e2s_instantiate', 'e2s_install', 'e2s_update_perform', ); $_candies_public=array ( 'e2m_info', 'e2m_frontpage', 'e2m_rss', 'e2m_json', 'e2m_note', 'e2m_note_json', 'e2m_note_read', 'e2m_draft_preview', 'e2m_tags', 'e2m_tag', 'e2m_tag_rss', 'e2m_tag_json', 'e2m_favourites', 'e2m_most_commented', 'e2m_found', 'e2m_comments', 'e2m_everything', 'e2m_sitemap_xml', 'e2m_year', 'e2m_month', 'e2m_day', 'e2m_unsubscribe', 'e2m_theme_preview', 'e2m_password_reset', 'e2s_password_reset_email', 'e2m_password', 'e2s_password_save', 'e2s_sign_in', 'e2m_sign_out', 'e2m_gip_sign_in', 'e2m_gip_sign_in_callback', 'e2m_gip_sign_out', 'e2s_comment_process', 'e2s_search', 'e2s_bsi_step', 'e2j_check_password', 'e2s_notify', ); $_candies_to_disallow_in_read_only=array ( 'e2m_write', 'e2m_note_edit', 'e2s_note_process', 'e2s_note_publish', 'e2s_note_delete', 'e2m_note_flag_favourite', 'e2m_note_flag', 'e2m_comment_edit', 'e2m_comment_delete', 'e2m_comment_reply', 'e2m_comment_reply_delete', 'e2m_comment_flag', 'e2m_comment_flag_ajax', 'e2m_unsubscribe', 'e2s_comment_process', 'e2m_settings', 'e2m_timezone', ); $_candies_public=array_merge($_candies_public,$_candies_installer); $_candies_indexable=array ( 'e2m_note', ); $_candies_indexable_conditionally=array ( 'e2m_frontpage', 'e2m_tag', 'e2m_favourites', 'e2m_most_commented', 'e2m_found', 'e2m_tags', 'e2m_everything', ); $_candies_ajax=array ( 'e2j_check_db_config', 'e2j_list_databases', 'e2j_check_password', 'e2j_userpic_upload', 'e2j_file_upload', 'e2j_file_remove', 'e2j_note_livesave', 'e2m_note_flag_favourite', 'e2m_comment_flag_ajax', 'e2m_tag_flag_ajax', ); function u3020(){ global$settings,$_lang,$_config,$_strings,$da57c1; if(Log::$ned2b5)__log('Blog information'); $w126ac['author']=htmlspecialchars(s2640(),ENT_NOQUOTES,HSC_ENC); if(array_key_exists('description',$settings)) { $g2bfe4=sb7f1($settings['description'],'full'); $r67daf=$g2bfe4['text-final']; $w126ac['description']=$r67daf; $w126ac['description-format-info']=$g2bfe4['meta']; r57ad(@$g2bfe4['meta']['links-required']); } $w126ac['title']=htmlspecialchars(o6f51(),ENT_NOQUOTES,HSC_ENC); $w126ac['userpic-set?']=false; if ($w126ac['userpic-href']=k2461()) { $w126ac['userpic-changeable-href']=$w126ac['userpic-href']; $w126ac['userpic-set?']=true; } else { $w126ac['userpic-href']=DEFAULT_USERPIC_FILENAME; if (ge852()) { $w126ac['userpic-changeable-href']=DEFAULT_USERPIC_PLACEHOLDER_FILENAME; } } if (ge852()) { $w126ac['userpic-upload-action']=i83c8('e2j_userpic_upload'); } $w126ac['href']=i83c8('e2m_frontpage', array ('page' => 1)); $w126ac['rss-href']=i83c8('e2m_rss'); $w126ac['jsonfeed-href']=i83c8('e2m_json'); $w126ac['language']=$_lang; $w126ac['show-subscribe-button?']=false; if(E2_EDITION){ $w126ac['show-subscribe-button?']=true; } $j97bc5=array (time(),w5c05()); $k5f36b=aa846('Y',$j97bc5[0]); $w126ac['now']=$j97bc5; $saa103=$k5f36b; $v33b09=fcc02('start'); if(array_key_exists('stamp',$v33b09)) { $saa103=aa846('Y',$v33b09['stamp']); $w126ac['start-time'] = array ((int)$v33b09['stamp'],$v33b09['timezone']); } $pd0a87=false; $u40d73=i3456(true,true); if ($u40d73!==null){ if (ge852()) { $ia4f0c=i3456(true,false); if ($ia4f0c!==null){ $pd0a87=($u40d73+$ia4f0c==0); } } else { $pd0a87=($u40d73==0); } } $w126ac['notes-count'] = (int)$u40d73; $w126ac['virgin?']=$pd0a87; $i9fbfe=$_config['years_range_separator']? $_config['years_range_separator']:$_strings['gs--range-separator']; $w126ac['years-range']=$saa103 . (($saa103==$k5f36b)? '':($i9fbfe.$k5f36b)); if ($da57c1){ $w126ac['parent-site-href']=substr($da57c1, (int)strpos('/',$da57c1)); } return $w126ac; } function o6f51(){ global$settings,$_strings; if ( array_key_exists('site_title',$settings) and trim($settings['site_title']) != '' ){ return trim($settings['site_title']); } else { return$_strings['e2--default-blog-title']; } } function s2640(){ global$settings,$_strings; if ( array_key_exists('author',$settings) and trim($settings['author']) != '' ){ return trim($settings['author']); } else { return$_strings['e2--default-blog-author']; } } function k2461(){ global$full_blog_url; if(is_file(USER_FOLDER .'userpic@2x.png')) { return$full_blog_url .'/'. USER_FOLDER .'userpic@2x.png'; } elseif(is_file(USER_FOLDER .'userpic@2x.jpg')) { return$full_blog_url .'/'. USER_FOLDER .'userpic@2x.jpg'; } else { return false; } } function i6442(){ global$_config,$_stopwatch,$s11755; $pc8542=round(f7f78()-$_stopwatch,3); return [ 'show?' => ($_config['display_stat'] > (int) !ge852()), 'generation-time' => str_replace('.',',',$pc8542), 'peak-memory-mb' => str_replace('.',',',round((memory_get_peak_usage()/1024/1024)*100)/100), 'db-query-count' => (int) @$s11755, ]; } function e2m_info(){ global$settings,$_config,$z57de2,$da57c1,$_template; $rf1f71=array ( 'E2_VERSION' => E2_VERSION, 'E2_RELEASE' => E2_RELEASE, 'E2_UA_STRING' => E2_UA_STRING, '---', 'PHP_VERSION' => PHP_VERSION, '---', 'installed' => (e2_get_instance()!==null), 'server_name' => $z57de2, 'folder_on_server' => $da57c1, '---', 'default formatter' => $_config['default_formatter'], '---', 'theme' => $settings['template'], '---', 'Olba name' => $_template['name'], 'Olba max_image_width' => $_template['max_image_width'], 'Olba stack' => $_template['stack'], '---', 'Neasden' => substr(md5(file_get_contents('system/neasden/neasden.php')), 0,4), '---', ); echo '<pre>'; foreach ($rf1f71 as $c8ce4b => $i9e366){ if ($i9e366=='---'){ echo "\n"; continue; } echo str_pad($c8ce4b,24); echo '\''; print_r($i9e366); echo '\''; echo "\n"; } echo '</pre>'; die; } function e2s_notify(){ global$_config; if($_config['holborn']) { $r4de32=@$_GET['src']; if ($r4de32==''){ if(Log::$ned2b5)__log('Holborn: No src URL'); die; } $d466de=file_get_contents($r4de32); $d466de=z09a6($d466de); $te13b0=json_decode($d466de,true); if (!$te13b0){ if(Log::$ned2b5)__log('Holborn: No meaningful info from '. $r4de32 .' ('. json_last_error() .')'); if ($m13bc3=ldd69($r4de32)) { if(Log::$ned2b5)__log('Holborn: Delete note with ID '. $m13bc3['ID']); ie268($m13bc3['ID']); } die; } f927d($te13b0,$r4de32); } die; } function e2m_sources($parameters){ global$_config; $e8bef1=$_GET['ord']; if (!$e8bef1)$e8bef1='ID'; $e8bef1="`". c7928($e8bef1) ."`"; a0738( "SELECT *, REPLACE(REPLACE(REPLACE(`URL`, 'http://', ''), 'https://', ''), 'www.', '') AS _URLX ". "FROM `". $_config['db_table_prefix']."Sources` " . "ORDER BY ". $e8bef1 ); $result=z0d6b(); foreach($result as $v447b7){ $lc615c=$v447b7['ID']; if ($v447b7['ID']!=$v447b7['TrueID'])$lc615c.='<br />'. $v447b7['TrueID']; $k36cd3=array ( 'id' => $lc615c, 'userpic-href' => $v447b7['PictureURL'], 'href' => $v447b7['URL'], 'href-display' => str_replace('/','/<wbr>',$v447b7['URL']), 'href-filtered' => str_replace('/','/<wbr>',$v447b7['_URLX']), 'title' => $v447b7['Title'], 'author' => $v447b7['AuthorName'], 'true?' => $v447b7['ID']==$v447b7['TrueID'], 'whitelisted?' => $v447b7['IsWhiteListed'], 'trusted?' => $v447b7['IsTrusted'], ); if (!$v447b7['IsTrusted']) { $k36cd3['trust-url']=i83c8( 'e2m_source_trust', array ('source' => $v447b7['ID']) ); } if ($v447b7['IsTrusted']) { $k36cd3['premoderate-url']=i83c8( 'e2m_source_premoderate', array ('source' => $v447b7['ID']) ); } $k36cd3['ban-url']=i83c8( 'e2m_source_ban', array ('source' => $v447b7['ID']) ); $k36cd3['forget-url']=i83c8( 'e2m_source_forget', array ('source' => $v447b7['ID']) ); $qf2ab5[] = $k36cd3; } $f2cb9d=array ( 'title' => 'Sources', 'heading' => 'Sources', ); if(count($qf2ab5)) { $f2cb9d['sources']=$qf2ab5; } else { $f2cb9d['nothing']='No sources'; } return $f2cb9d; } function e2m_source_trust($parameters){ global$_config; $i0afd9=$parameters['source']; a0738( "UPDATE  ". $_config['db_table_prefix']."Sources ". "SET `IsWhitelisted`=1, `IsTrusted`=1 ". "WHERE `ID`=". $i0afd9, 'trust source' ); a0738( "UPDATE  ". $_config['db_table_prefix']."Notes ". "SET `IsPublished`=1 ". "WHERE `SourceID`=". $i0afd9, 'publish all notes from the just trusted source' ); s198f(); y7996(); @unlink(CACHE_FILENAME_DRAFTS); @unlink(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); e2_go_to(''); die; } function e2m_source_premoderate($parameters){ global$_config; $i0afd9=$parameters['source']; a0738( "UPDATE  ". $_config['db_table_prefix']."Sources ". "SET `IsTrusted`=0 ". "WHERE `ID`=". $i0afd9, 'distrust source, set to premoderation' ); y7996(); e2_go_to(''); die; } function e2m_source_ban($parameters){ global$_config; $i0afd9=$parameters['source']; a0738( "UPDATE  ". $_config['db_table_prefix']."Sources ". "SET `IsWhiteListed`=0, `IsTrusted`=0 ". "WHERE `ID`=". $i0afd9, 'ban source' ); a0738( "DELETE FROM  ". $_config['db_table_prefix']."Notes ". "WHERE `SourceID`=". $i0afd9, 'delete all notes from the just banned source' ); y7996(); @unlink(CACHE_FILENAME_DRAFTS); @unlink(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); e2_go_to(''); die; } function e2m_source_forget($parameters){ global$_config; $i0afd9=$parameters['source']; a0738( "DELETE FROM  ". $_config['db_table_prefix']."Sources ". "WHERE `ID`=". $i0afd9, 'forget source' ); a0738( "DELETE FROM  ". $_config['db_table_prefix']."Notes ". "WHERE `SourceID`=". $i0afd9, 'delete all notes from the just forgotten source' ); y7996(); @unlink(CACHE_FILENAME_DRAFTS); @unlink(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); e2_go_to(''); die; } function f927d($te13b0,$r4de32){ if(Log::$ned2b5)__log('Holborn: Note info == '. print_r($te13b0,true)); if (@$te13b0['items']) { if(Log::$ned2b5)__log('Holborn: JSON feed format'); $ma4a84=o10cd(array ( 'author' => $te13b0['author']['name'], 'title' => $te13b0['title'], 'href' => $te13b0['author']['url'], 'userpic-href' => $te13b0['author']['avatar'], )); if (!$ma4a84['IsWhiteListed']) return; if(preg_match('/\+(\d\d)\:(\d\d)/',$te13b0['items'][0]['date_published'],$o9c28d)) { $k7a86c=$o9c28d[1]*SECONDS_IN_AN_HOUR+$o9c28d[2]*SECONDS_IN_A_MINUTE; } $j929cf=@$te13b0['items'][0]['_e2_data'] or $j929cf=array(); $j929cf=json_encode($j929cf); $b39a37=array ( 'Title' => $te13b0['items'][0]['title'], 'Text' => $te13b0['items'][0]['content_html'], 'FormatterID' => 'raw', 'OriginalAlias' => '', 'Uploads' => '', 'Stamp' => strtotime($te13b0['items'][0]['date_published']), 'Offset' => (int)$k7a86c, 'IsDST' => 0, 'LastModified' => strtotime($te13b0['items'][0]['date_modified']), 'IsCommentable' => 0, 'IsPublished' => $ma4a84['IsTrusted'], 'IsExternal' => 1, 'SourceID' => $ma4a84['ID'], 'SourceNoteID' => $te13b0['items'][0]['id'], 'SourceNoteURL' => $te13b0['items'][0]['url'], 'SourceNoteJSONURL' => $r4de32, 'SourceNoteData' => $j929cf, ); $i21158=$te13b0['items'][0]['id']; } else { if(Log::$ned2b5)__log('Holborn: legacy custom format'); $n03396=@$te13b0['blog']; $ma4a84=o10cd($n03396); if (!$ma4a84['IsWhiteListed']) return; $j929cf=@$te13b0['note']['og-images'] or $j929cf=array(); $j929cf['og_images']=$j929cf; $j929cf=json_encode($j929cf); $b39a37=array ( 'Title' => $te13b0['note']['title'], 'Text' => $te13b0['note']['text'], 'FormatterID' => 'raw', 'OriginalAlias' => '', 'Uploads' => '', 'Stamp' => $te13b0['note']['time'][0], 'Offset' => (int)$te13b0['note']['time'][1]['offset'], 'IsDST' => (int)$te13b0['note']['time'][1]['is_dst'], 'LastModified' => $te13b0['note']['last-modified'][0], 'IsCommentable' => 0, 'IsPublished' => $ma4a84['IsTrusted'], 'IsExternal' => 1, 'SourceID' => $ma4a84['ID'], 'SourceNoteID' => $te13b0['note']['id'], 'SourceNoteURL' => $te13b0['note']['href'], 'SourceNoteJSONURL' => $r4de32, 'SourceNoteData' => $j929cf, ); $i21158=$te13b0['note']['id']; } if ( $m13bc3=mf25e($ma4a84['ID'],$i21158) ) { $b39a37['ID']=$m13bc3['ID']; taa79('Notes',$b39a37); } else { $b39a37=x9943('Notes',$b39a37); } qd2e1($b39a37); e2_drop_caches_for_note_($b39a37['ID']); @unlink(CACHE_FILENAME_DRAFTS); @unlink(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); } function ldd69($r4de32){ global$_config; a0738( "SELECT `ID` FROM ". $_config['db_table_prefix']."Notes ". "WHERE `SourceNoteJSONURL`='". $r4de32 ."' ". "LIMIT 1", 'get note ID by source JSON URL' ); $result=z0d6b(); return$result[0]; } function mf25e($i0afd9,$rbb971){ global$_config; a0738( "SELECT `ID` FROM ". $_config['db_table_prefix']."Notes ". "WHERE `SourceID`= '". $i0afd9 ."' ". "AND `SourceNoteID`= '". $rbb971 ."' ". "LIMIT 1", 'get note ID by source ID and source note ID' ); $result=z0d6b(); return$result[0]; } function z09a6($d466de){ for ($d865c0=0; $d865c0 <= 31; ++$d865c0){ $d466de=str_replace(chr($d865c0),'',$d466de); } $d466de=str_replace(chr(127),'',$d466de); if(0===strpos(bin2hex($d466de),'efbbbf')) { $d466de=substr($d466de,3); } return $d466de; } function o10cd($n03396){ global$_config; $d305c2=false; a0738( "SELECT * FROM ". $_config['db_table_prefix']."Sources ". "WHERE `URL`= '". $n03396['href'] ."' ". "LIMIT 1", 'get source record by the URL from blog info' ); $result=z0d6b(); if(count($result)) { $d305c2=$result[0]; if ($d305c2['ID']!=$d305c2['TrueID']) { a0738( "SELECT * FROM ". $_config['db_table_prefix']."Sources ". "WHERE `ID`= '". $d305c2['TrueID'] ."' ". "LIMIT 1", 'get true source record by using the TrueID of just found record' ); $result=z0d6b(); if(count($result)) { $d305c2=$result[0]; } } } $ma4a84=array ( 'Title' => $n03396['title'], 'AuthorName' => $n03396['author'], 'PictureURL' => $n03396['userpic-href'], ); if ($d305c2!==false){ if ( $d305c2['Title']!==$n03396['title'] or $d305c2['AuthorName']!==$n03396['author'] or $d305c2['PictureURL']!==$n03396['userpic-href'] ) { $ma4a84['ID']=$d305c2['ID']; taa79('Sources',$ma4a84); } return $d305c2; } else { $ma4a84['URL']=$n03396['href']; $ma4a84['IsWhiteListed']=1; $ma4a84['IsTrusted']=0; $ma4a84=x9943('Sources',$ma4a84); $ma4a84['TrueID']=$ma4a84['ID']; taa79('Sources',$ma4a84); return $ma4a84; } } function m1a48($b39a37,$r34d5a=false){ global$_config; $pc6827=array(); if (@$b39a37['IsExternal']) { if(array_key_exists('SourceID',$b39a37)) { a0738( "SELECT * FROM `". $_config['db_table_prefix']."Sources` ". "WHERE `ID` = '". $b39a37['SourceID'] ."'", 'get source by id' ); $cfa816=z0d6b(); $pc6827['source']=$cfa816[0]['Title']; $pc6827['source-id']=$b39a37['SourceID']; $pc6827['source-true-id']=$cfa816[0]['TrueID']; $pc6827['source-whitelisted?']=$cfa816[0]['IsWhiteListed']; $pc6827['source-trusted?']=$cfa816[0]['IsTrusted']; if (!$cfa816[0]['IsTrusted']) { $pc6827['source-trust-url']=i83c8( 'e2m_source_trust', array ('source' => $b39a37['SourceID']) ); } if ($cfa816[0]['IsTrusted']) { $pc6827['source-premoderate-url']=i83c8( 'e2m_source_premoderate', array ('source' => $b39a37['SourceID']) ); } $pc6827['source-ban-url']=i83c8( 'e2m_source_ban', array ('source' => $b39a37['SourceID']) ); $pc6827['source-forget-url']=i83c8( 'e2m_source_forget', array ('source' => $b39a37['SourceID']) ); $pc6827['author']=$cfa816[0]['AuthorName']; $pc6827['author-href']=$cfa816[0]['URL']; $pc6827['userpic-href']=$cfa816[0]['PictureURL']; } if ($r34d5a){ if(array_key_exists('SourceNoteURL',$b39a37) and @$b39a37['SourceNoteURL']!=''){ $pc6827['href']=$b39a37['SourceNoteURL']; $pc6827['href-original']=$b39a37['SourceNoteURL']; } } } return $pc6827; } function e2m_frontpage($parameters=array ()) { global$settings,$_config,$_strings; $l71860=$parameters['page']; $eae0fe=1; $sd7e5d=$settings['appearance']['notes_per_page']; $p06d2e=i3456(true,true); if ($p06d2e!==null){ if (ge852()) { $p90953=i3456(true,false); if ($p90953!==null)$p06d2e+=$p90953; } $eae0fe=ceil($p06d2e/$sd7e5d); } $vd29bb=CACHE_FILENAME_FRONTPAGE; if (ge852())$vd29bb=CACHE_FILENAME_FRONTPAGE_AUTHOR; if ($l71860 < 1) return e2_error404_mode(); if(CACHE_FRONTPAGE and $l71860==1 and is_file($vd29bb)) { $e4358b=@unserialize(file_get_contents($vd29bb)); } if(CACHE_FRONTPAGE and $l71860==1 and is_array($e4358b)) { } else { try { $result=s7573($l71860); $e4358b=array(); if(count($result) > 0){ foreach($result as $c8ce4b => $raad65){ $raad65['_']['_id']=$raad65['ID']; $raad65['_']['_title']=$raad65['Title']; $raad65['_']['_ord']=$c8ce4b; $raad65['_']['_ord_max']=count($result)-1; $ne244c=v6791($raad65); $e4358b[] = $ne244c; } } else { if ($l71860!=1) return e2_error404_mode(); } } catch (AeMySQLException $e){ c12f6($ae1671,'Could not get latest notes for page '. $l71860); return array ( 'unavailable?' => true, 'title' => htmlspecialchars(o6f51(),ENT_NOQUOTES,HSC_ENC), ); } if(CACHE_FRONTPAGE and $l71860==1)s6e52($vd29bb,serialize($e4358b)); } $jb3b32['timeline?']=true; $jb3b32['count']=$eae0fe; $jb3b32['this'] = (int)$l71860; if ($eae0fe > 1){ if ($l71860 < $eae0fe)$jb3b32['earlier-href']=i83c8('e2m_frontpage', array ('page' => $l71860+1)); if ($l71860 > 1)$jb3b32['later-href']=i83c8('e2m_frontpage', array ('page' => $l71860-1)); $jb3b32['earlier-title']=$_strings['gs--earlier']; $jb3b32['later-title']=$_strings['gs--later']; } $dd5d3d=o6f51(); return array ( 'frontpage?' => (bool) ($l71860==1), 'title' => $dd5d3d, 'notes' => $e4358b, 'pages' => $jb3b32, ); } function s7573($l71860=1){ global$settings,$_config; $c19ee4=($l71860-1)*$settings['appearance']['notes_per_page']; $taa9f7=$c19ee4 .', '. $settings['appearance']['notes_per_page']; a0738( "SELECT * FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `IsPublished`=1 ". v6f32(ge852()). "ORDER BY `Stamp` DESC ". "LIMIT ". $taa9f7, 'get latest notes for page '. $l71860 ); return z0d6b(); } function e2m_json($parameters=array ()) { list ($ob9076,$n20612)=mab26(); $d466de=json_encode($ob9076,E2_JSON_STYLE); u8ec5($d466de,$n20612,'json'); } function e2m_rss($parameters=array ()) { list ($ob9076,$n20612)=mab26(); $i8bb85=e2feeds__rss_using_jsonfeed_array_($ob9076); u8ec5($i8bb85,$n20612,'rss'); } function e2m_tag_json($parameters=array ()) { if(array_key_exists('*tag',$parameters)) { $nb19ad=$parameters['*tag']; } else { return e2_error404_mode(); } list ($ob9076,$n20612)=me229($nb19ad); $d466de=json_encode($ob9076,E2_JSON_STYLE); u8ec5($d466de,$n20612,'json'); } function e2m_tag_rss($parameters=array ()) { global$settings,$_config,$_strings; if(array_key_exists('*tag',$parameters)) { $nb19ad=$parameters['*tag']; } else { return e2_error404_mode(); } list ($ob9076,$n20612)=me229($nb19ad); $i8bb85=e2feeds__rss_using_jsonfeed_array_($ob9076); u8ec5($i8bb85,$n20612,'rss'); } function e2m_note_json($parameters=array ()) { global$settings,$_current_url; $b39a37=$parameters['*note']; if ($b39a37==false){ return e2_error404_mode(); } if (!ab44b($b39a37,ge852())) { return e2_error404_mode(); } $b39a37['_']['_id']=$b39a37['ID']; $n20612=$b39a37['Stamp']; $a7da21=e2_jsonfeed_item_array_from_noterec_($b39a37); $o0bf08=array ($a7da21); $ob9076=e2_jsonfeed_array_stub_from_jsonfeed_item_arrays_($o0bf08); $ob9076['title']=$settings['site_title']; $ob9076['home_page_url']=i83c8('e2m_frontpage', array ('page' => 1)); $ob9076['feed_url']=$_current_url; u8ec5(json_encode($ob9076,E2_JSON_STYLE),$n20612,'json'); } function e2_jsonfeed_array_stub_from_jsonfeed_item_arrays_($o0bf08){ return array ( 'version' => 'https://jsonfeed.org/version/1', 'title' => null, 'home_page_url' => null, 'feed_url' => null, 'icon' => k2461(), 'author' => array ( 'name' => s2640(), 'url' => i83c8('e2m_frontpage', array ('page' => 1)), 'avatar' => k2461(), ), 'items' => $o0bf08, '_e2_version' => E2_VERSION, '_e2_ua_string' => E2_UA_STRING, ); } function e2_jsonfeed_item_array_from_noterec_($b39a37){ global$settings; $b39a37['_']['_id']=$b39a37['ID']; $x572d4=i83c8('e2m_note', array ('*note' => $b39a37)); $m803d0=( aa846('Y-m-d\TH:i:s',$b39a37['Stamp']) . bd536($b39a37['Stamp'],':') ); $nade16=( aa846('Y-m-d\TH:i:s',$b39a37['LastModified']) . bd536($b39a37['LastModified'],':') ); $p316ec=( aa846('D, d M Y H:i:s ',$b39a37['Stamp']) . bd536($b39a37['Stamp']) ); $g2bfe4=c154e($b39a37['FormatterID'], @$b39a37['Text'],'full-rss'); $uad965=sdbcc( 'note',$b39a37['_']['_id'], $g2bfe4['meta']['resources-detected'] ); $qe70c4=array ( 'id' => (string)$b39a37['ID'], 'url' => $x572d4, 'title' => a6f10(htmlspecialchars($b39a37['Title'],ENT_NOQUOTES)), 'content_html' => $g2bfe4['text-final'], 'date_published' => $m803d0, 'date_modified' => $nade16, ); if ($b39a37['IsExternal']) { $n60d40=m1a48($b39a37,true); $qe70c4['url']=$n60d40['href']; $qe70c4['author'] = array ( 'name' => $n60d40['author'], 'url' => $n60d40['author-href'], 'avatar' => $n60d40['userpic-href'], ); } if(count($uad965) > 0){ $qe70c4['image']=$uad965[0]; } $qe70c4['_date_published_rfc2822']=$p316ec; if ($b39a37['Stamp'] < $settings['v3223_rss_permalinks_before_stamp']) { $qe70c4['_rss_guid_is_permalink']='true'; $qe70c4['_rss_guid']=$qe70c4['url']; } else { $qe70c4['_rss_guid_is_permalink']='false'; $qe70c4['_rss_guid'] = (string)$b39a37['ID']; } $qe70c4['_e2_data'] = array ( 'is_favourite' => (bool)$b39a37['IsFavourite'], 'links_required' => $g2bfe4['meta']['links-required'], 'og_images' => $uad965, ); return $qe70c4; } function a3010($j7a402,$dd5d3d,$qe8fab){ global$_newsfeeds; if (!isset ($_newsfeeds))$_newsfeeds=[]; $sfc0f6=''; if ($j7a402=='rss')$sfc0f6='application/rss+xml'; if ($j7a402=='json')$sfc0f6='application/json'; $_newsfeeds[] = [ 'type' => $sfc0f6, 'title' => htmlspecialchars($dd5d3d,ENT_NOQUOTES,HSC_ENC), 'href' => $qe8fab ]; } function zed63(){ global$_config; a0738( "SELECT * FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `IsPublished`=1 ". v6f32(). "ORDER BY `Stamp` DESC ". "LIMIT ". $_config['rss_items'], 'get recent public noterecs for RSS or JSONFeed' ); return z0d6b(); } function mab26(){ global$settings,$_current_url; $n20612=0; $o0bf08=array(); $ob9076=array(); $vd29bb=CACHE_FILENAME_FRONTPAGE_FEED; if(CACHE_FRONTPAGE_FEED and is_file($vd29bb)) { if(Log::$ned2b5)__log('Feed array (RSS, JSON): cached'); $ob9076=@unserialize(file_get_contents($vd29bb)); $n20612=filemtime($vd29bb); } else { if(Log::$ned2b5)__log('Feed array (RSS, JSON): not cached, will need to build'); $xc2d18=zed63(); foreach ($xc2d18 as $b39a37){ $o0bf08[] = e2_jsonfeed_item_array_from_noterec_($b39a37); $n20612=max($n20612,$b39a37['Stamp']); } $ob9076=e2_jsonfeed_array_stub_from_jsonfeed_item_arrays_($o0bf08); $ob9076['title']=$settings['site_title']; $ob9076['home_page_url']=i83c8('e2m_frontpage', array ('page' => 1)); $ob9076['feed_url']=$_current_url; if(CACHE_FRONTPAGE_FEED)s6e52($vd29bb,serialize($ob9076)); } return array ($ob9076,$n20612); } function me229($nb19ad){ global$settings,$_config,$_strings,$_current_url; $n20612=0; $o0bf08=array(); a0738( "SELECT n.* ". "FROM `". $_config['db_table_prefix']."Notes` n ". "INNER JOIN `". $_config['db_table_prefix']."NotesKeywords` nk ". "ON nk.`NoteID` = n.`ID` ". "WHERE (nk.`KeywordID` = ". $nb19ad['ID'] .") ". v6f32(ge852()). "ORDER BY n.`Stamp` DESC ". "LIMIT ". $_config['rss_items'], 'get tag noterecs for RSS or JSONFeed' ); $xc2d18=z0d6b(); foreach ($xc2d18 as $b39a37){ $o0bf08[] = e2_jsonfeed_item_array_from_noterec_($b39a37); $n20612=max($n20612,$b39a37['Stamp']); } $ob9076=e2_jsonfeed_array_stub_from_jsonfeed_item_arrays_($o0bf08); $ob9076['title'] = ( $settings['site_title'] .', '. $_strings['gs--posts-tagged'] .': '. $nb19ad['Keyword'] ); $ob9076['home_page_url']=i83c8('e2m_tag', array ('*tag' => $nb19ad)); $ob9076['feed_url']=$_current_url; return array ($ob9076,$n20612); } function e2feeds__rss_using_jsonfeed_array_($content){ $f92eac=DEFAULTS_FOLDER.'rss/rss.tmpl.php'; if(is_file($f92eac)) { ob_start(); include $f92eac; $i8bb85=ob_get_contents(); ob_end_clean(); } return $i8bb85; } function g99a9($i8bb85){ $i8bb85=str_replace("\x0",'',$i8bb85); for ($d865c0=0; $d865c0 < strlen($i8bb85); ++$d865c0){ if(ord($i8bb85[$d865c0]) < 32 and !in_array(ord($i8bb85[$d865c0]), array (10,13))) { $i8bb85[$d865c0]=''; } } return $i8bb85; } function u8ec5($t321c3,$n20612,$j7a402){ global$_config; $n69a10=gmdate('r',$n20612); $q1872a=md5($n20612); if ($j7a402=='rss'){ if (@$_config['dev_xml_as_text']) { header('Content-Type: text/plain'); } else { header('Content-type: application/xml; charset=utf-8'); } } elseif ($j7a402=='json'){ header('Content-Type: application/json'); } else { header('Content-Type: text/plain'); } header('Last-modified: '. $n69a10); header('Etag: '. $q1872a); header('Cache-Control: public'); header('Expires: '. date('r',$n20612+SECONDS_IN_A_DAY)); $p0c3cd=isset($_SERVER['HTTP_IF_MODIFIED_SINCE'])? stripslashes($_SERVER['HTTP_IF_MODIFIED_SINCE']) : false; $hc3522=isset($_SERVER['HTTP_IF_NONE_MATCH'])? stripslashes($_SERVER['HTTP_IF_NONE_MATCH']) : false; if ( !$p0c3cd && !$hc3522 or $hc3522 && $hc3522!=$q1872a or $p0c3cd && $p0c3cd!=$n69a10 ){ if ($j7a402=='rss'){ $i8bb85=g99a9($i8bb85); } echo $t321c3; } else { header('HTTP/1.1 304 Not Modified'); } die; } function e2m_year($parameters=array ()) { global$_strings,$_config; $c84cdc=$parameters['year']; $z09d6c=e2l_get_string('pt--nth-year', array ('year' => $c84cdc)); if (!a1665($c84cdc)) { return e2_error404_mode(); } $he6e7d=gmmktime(0,0,0,1,1,$c84cdc-1); $o029bd=gmmktime(0,0,0,1,1,$c84cdc+1); list ($z8aebd,$n5a7f3)=e2__fruitful_neighbours_with_ymd_($c84cdc); $da6d40='e2m_year'; if ($z8aebd){ $jb3b32['prev-href']=i83c8( $da6d40,e2__parameters_with_timestamp_($z8aebd) ); $jb3b32['prev-jump?'] = (bool) (gmdate('Y',$he6e7d)!=gmdate('Y',$z8aebd)); $jb3b32['prev-title']=gmdate('Y',$z8aebd); } if ($n5a7f3){ $jb3b32['next-href']=i83c8( $da6d40,e2__parameters_with_timestamp_($n5a7f3) ); $jb3b32['next-jump?'] = (bool) (gmdate('Y',$o029bd)!=gmdate('Y',$n5a7f3)); $jb3b32['next-title']=gmdate('Y',$n5a7f3); } $jb3b32['timeline?']=false; $jb3b32['this']=$c84cdc; $jb3b32['this-title']=$c84cdc; $kb2442=fcc02('start'); $e8dbc7=fcc02('end'); if ( $c84cdc==e5a2f('Y',$kb2442['stamp'],$kb2442['timezone']) ) { $ffa098=e5a2f('m',$kb2442['stamp'],$kb2442['timezone']); } else { $ffa098=1; } if ( $c84cdc==aa846('Y',time()) ) { $afd384=aa846('m',time()); } else { $afd384=12; } $d6eac3=e9737($c84cdc); for ($r7436f=1; $r7436f <= 12; ++ $r7436f){ $z7f769=gmmktime(0,0,0,$r7436f,1,$c84cdc); $qd039b[$r7436f] = array ( 'number' => $r7436f, 'start-time' => array ($z7f769,v3211()), 'href' => gmdate('Y/m/',$z7f769), 'real?' => $r7436f >= $ffa098 and $r7436f <= $afd384, 'fruitful?' => @in_array(gmdate('n',$z7f769),$d6eac3), ); } list ($k7b314,$ca1f20)=g5273($c84cdc); $f2cb9d=[ 'title' => $z09d6c, 'heading' => $z09d6c, 'pages' => $jb3b32, 'year' => (int)$c84cdc, 'year-months' => $qd039b, ]; a0738( "SELECT * FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `IsPublished` = 1 ". v6f32(ge852()). "AND `Stamp` BETWEEN ". $k7b314 ." ". "AND ". $ca1f20 ." ". "ORDER BY `Stamp`", 'get all notes for the year' ); $result=z0d6b(); $e4358b=z28df($result,$c84cdc); if(count($e4358b)) { $f2cb9d['notes-list']=$e4358b; } else { $f2cb9d['nothing']=$_strings['gs--no-such-notes']; } return $f2cb9d; } function e2m_month($parameters=array ()) { global$_strings,$_config; $c84cdc= $parameters['year']; $r7436f=$parameters['month']; $z09d6c=e2l_get_string( 'pt--nth-month-of-nth-year', array ('year' => $c84cdc,'month' => $r7436f) ); if (!a1665($c84cdc,$r7436f)) { return e2_error404_mode(); } $he6e7d=gmmktime(0,0,0,$r7436f-1,1,$c84cdc); $o029bd=gmmktime(0,0,0,$r7436f+1,1,$c84cdc); list ($z8aebd,$n5a7f3)=e2__fruitful_neighbours_with_ymd_($c84cdc,$r7436f); $da6d40='e2m_month'; if ($z8aebd){ $jb3b32['prev-href']=i83c8( $da6d40,e2__parameters_with_timestamp_($z8aebd) ); $jb3b32['prev-jump?'] = (bool) (gmdate('Y/m',$he6e7d)!=gmdate('Y/m',$z8aebd)); $jb3b32['prev-title']=e2l_get_string( 'gs--nth-month-of-nth-year', array ( 'year' => gmdate('Y',$z8aebd),'month' => gmdate('n',$z8aebd) ) ); } if ($n5a7f3){ $jb3b32['next-href']=i83c8( $da6d40,e2__parameters_with_timestamp_($n5a7f3) ); $jb3b32['next-jump?'] = (bool) (gmdate('Y/m',$o029bd)!=gmdate('Y/m',$n5a7f3)); $jb3b32['next-title']=e2l_get_string( 'gs--nth-month-of-nth-year', array ( 'year' => gmdate('Y',$n5a7f3),'month' => gmdate('n',$n5a7f3) ) ); } $jb3b32['timeline?']=false; $jb3b32['this-title']=$z09d6c; list ($k7b314,$ca1f20)=g5273($c84cdc,$r7436f); $f2cb9d=[ 'title' => $z09d6c, 'heading' => $z09d6c, 'pages' => $jb3b32, 'year' => (int)$c84cdc, 'month' => (int)$r7436f, 'month-days' => e2_pack_month_days_with_ymd_($c84cdc,$r7436f,false), ]; a0738( "SELECT * FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `IsPublished` = 1 ". v6f32(ge852()). "AND `Stamp` BETWEEN ". $k7b314 ." ". "AND ". $ca1f20 ." ". "ORDER BY `Stamp`", 'get all notes for the month' ); $result=z0d6b(); $e4358b=z28df($result,$c84cdc,$r7436f); if(count($e4358b)) { $f2cb9d['notes-list']=$e4358b; } else { $f2cb9d['nothing']=$_strings['gs--no-such-notes']; } return $f2cb9d; } function e2m_day($parameters=array ()) { global$_strings; $c84cdc= (int)$parameters['year']; $r7436f=(int)$parameters['month']; $r628b7= (int)$parameters['day']; if (!(a1665($c84cdc,$r7436f,$r628b7))) { return e2_error404_mode(); } $z09d6c=e2l_get_string( 'pt--nth-day-of-nth-month-of-nth-year', array ('year' => $c84cdc,'month' => $r7436f,'day' => $r628b7) ); $he6e7d=gmmktime(0,0,0,$r7436f,$r628b7-1,$c84cdc); $o029bd=gmmktime(0,0,0,$r7436f,$r628b7+1,$c84cdc); list ($z8aebd,$n5a7f3)=e2__fruitful_neighbours_with_ymd_($c84cdc,$r7436f,$r628b7); $da6d40='e2m_day'; if ($z8aebd){ $jb3b32['prev-href']=i83c8( $da6d40,e2__parameters_with_timestamp_($z8aebd) ); $jb3b32['prev-jump?'] = (bool) (gmdate('Y/m/d',$he6e7d)!=gmdate('Y/m/d',$z8aebd)); $jb3b32['prev-title']=e2l_get_string( 'gs--nth-day-of-nth-month-of-nth-year', array ( 'year' => gmdate('Y',$z8aebd),'month' => gmdate('n',$z8aebd),'day' => gmdate('j',$z8aebd), ) ); } if ($n5a7f3){ $jb3b32['next-href']=i83c8( $da6d40,e2__parameters_with_timestamp_($n5a7f3) ); $jb3b32['next-jump?'] = (bool) (gmdate('Y/m/d',$o029bd)!=gmdate('Y/m/d',$n5a7f3)); $jb3b32['next-title']=e2l_get_string( 'gs--nth-day-of-nth-month-of-nth-year', array ( 'year' => gmdate('Y',$n5a7f3),'month' => gmdate('n',$n5a7f3),'day' => gmdate('j',$n5a7f3), ) ); } $jb3b32['timeline?']=false; $jb3b32['this-title']=$z09d6c; $f2cb9d=[ 'title' => $z09d6c, 'heading' => $z09d6c, 'pages' => $jb3b32, 'month-days' => e2_pack_month_days_with_ymd_($c84cdc,$r7436f,$r628b7), ]; $result=of9fb($c84cdc,$r7436f,$r628b7); $result=array_reverse($result); $f15514=ge852(); foreach($result as $c8ce4b => $b39a37){ if (ab44b($b39a37,$f15514)) { $b39a37['_']['_id']=$b39a37['ID']; $b39a37['_']['_ord']=k; $b39a37['_']['_ord_max']=count($result)-1; $e4358b[] = v6791($b39a37); } } if(count($e4358b)) { $f2cb9d['notes']=$e4358b; } else { $f2cb9d['nothing']=$_strings['gs--no-such-notes']; } return $f2cb9d; } function k71d9(){ global$_config; $e4358b=null; if(CACHE_FULLLIST and is_file(CACHE_FILENAME_FULLLIST)) { $e4358b=@unserialize(file_get_contents(CACHE_FILENAME_FULLLIST)); if(Log::$ned2b5)__log('Retrieving full notes list from cache...'); } if (!is_array($e4358b)) { if(Log::$ned2b5)__log('Retrieving full notes list from database...'); a0738( "SELECT `ID`, `Title`, `Stamp`, `LastModified`, `Offset`, `IsDST`, ". "`IsFavourite`, `IsPublished`, `IsVisible`, `SourceNoteURL`, `OriginalAlias` ". "FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `IsPublished` = 1 ". v6f32(). "ORDER BY `Stamp`", 'get full notes list' ); $result=z0d6b(); $e4358b=z28df($result); if(CACHE_FULLLIST)s6e52(CACHE_FILENAME_FULLLIST,serialize($e4358b)); } return $e4358b; } function e2m_everything($parameters=array ()) { global$_strings; $e4358b=k71d9(); $t1f525=count($e4358b); $z09d6c=e2l_get_string('pt--n-posts', array ('number' => $t1f525)); $f2cb9d=[ 'title' => $z09d6c, 'heading' => $z09d6c, ]; if(count($e4358b)) { $f2cb9d['notes-list']=$e4358b; } else { $f2cb9d['nothing']=$_strings['gs--no-notes']; } return $f2cb9d; } function e2m_sitemap_xml($parameters=array ()) { global$_config; $e4358b=k71d9(); if (@$_config['dev_xml_as_text']) { header('Content-Type: text/plain'); } else { header('Content-type: application/xml; charset=utf-8'); } echo '<?xml version="1.0" encoding="UTF-8"?>'."\r\n"; echo '<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">'."\r\n"; if(count($e4358b)) { $n20612=@$e4358b[0]['last-modified']; echo '<url>'."\r\n"; echo '<loc>'. i83c8('e2m_frontpage', array ('page' => 1)) .'</loc>'."\r\n"; echo '<lastmod>'; echo e5a2f('Y-m-d',$n20612[0],$n20612[1]); echo '</lastmod>'."\r\n"; echo '<changefreq>hourly</changefreq>'; echo '</url>'."\r\n"; foreach ($e4358b as $raad65){ echo '<url>'."\r\n"; echo '<loc>'; echo $raad65['href']; echo '</loc>'."\r\n"; echo '<lastmod>'; echo e5a2f('Y-m-d',$raad65['last-modified'][0],$raad65['last-modified'][1]); echo '</lastmod>'."\r\n"; echo '</url>'."\r\n"; } } echo '</urlset>'."\r\n"; die; } function e2_pack_month_days_with_ymd_($c84cdc,$r7436f,$r628b7){ $aa6933=e5a2f('t',gmmktime(0,0,0,$r7436f,1,$c84cdc),v3211()); $kb2442=fcc02('start'); $e8dbc7=fcc02('end'); if ( $c84cdc .'/'. $r7436f == e5a2f('Y/n',$kb2442['stamp'],$kb2442['timezone']) ) { $m42eb4=e5a2f('d',$kb2442['stamp'],$kb2442['timezone']); } else { $m42eb4=1; } if ( $c84cdc .'/'. $r7436f == aa846('Y/n',time()) ) { $gd5f50=aa846('d',time()); } else { $gd5f50=$aa6933; } $ue4602=vae09($c84cdc,$r7436f); for ($d865c0=1; $d865c0 <= $aa6933; ++ $d865c0){ $z7f769=gmmktime(0,0,0,$r7436f,$d865c0,$c84cdc); $w271c1[$d865c0] = array ( 'number' => $d865c0, 'start-time' => array ($z7f769,v3211()), 'href' => gmdate('Y/m/d/',$z7f769), 'this?' => (bool) ($d865c0==$r628b7), 'real?' => $d865c0 >= $m42eb4 and $d865c0 <= $gd5f50, 'fruitful?' => @in_array(gmdate('d',$z7f769),$ue4602), ); } return $w271c1; } function a1665($c84cdc,$r7436f=false,$r628b7=false){ $kb2442=fcc02('start'); if ($kb2442===false){ return false; } $ic1f1e=e5a2f('Y',$kb2442['stamp'],$kb2442['timezone']); $yebeb3=aa846('Y',time()); if ($r7436f===false){ return (bool) ( $c84cdc >= $ic1f1e and $c84cdc <= $yebeb3 ); } else { $t782fc=e5a2f('n',$kb2442['stamp'],$kb2442['timezone']); $s13dd1=aa846('n',time()); if ($r628b7===false){ return (bool) ( $r7436f >= 1 and $r7436f <= 12 and ( ($c84cdc > $ic1f1e and $c84cdc < $yebeb3) or ($c84cdc==$ic1f1e and $r7436f >= $t782fc) or ($c84cdc==$yebeb3 and $r7436f <= $s13dd1) ) ); } else { $n7a9c0=e5a2f('j',$kb2442['stamp'],$kb2442['timezone']); $x23209=aa846('j',time()); if(1){ return (bool) ( checkdate($r7436f,$r628b7,$c84cdc) and ( ($c84cdc > $ic1f1e and $c84cdc < $yebeb3) or ($c84cdc==$ic1f1e and $r7436f > $t782fc) or ($c84cdc==$ic1f1e and $r7436f==$t782fc and $r628b7 >= $n7a9c0) or ($c84cdc==$yebeb3 and $r7436f < $s13dd1) or ($c84cdc==$yebeb3 and $r7436f==$s13dd1 and $r628b7 <= $x23209) ) ); } } } } function e2__fruitful_neighbours_with_ymd_($x41529,$r6f8f5=false,$u8277e=false){ global$_db,$_config; list ($b3d2fa,$w9468c)=g5273($x41529,$r6f8f5,$u8277e); $zada4b=SECONDS_IN_A_DAY; if ($u8277e===false)$zada4b=SECONDS_IN_A_MONTH; if ($r6f8f5===false)$zada4b=SECONDS_IN_A_YEAR; $bbf025=$p8dc98=null; a0738( "SELECT `Stamp`, `Offset`, `IsDST` ". "FROM `". $_config['db_table_prefix']. "Notes` n ". "WHERE `IsPublished`=1 ". "AND `Stamp` < '". ($w9468c-$zada4b) ."' ". v6f32(ge852()). "ORDER BY Stamp DESC", 'get previous fruitful neighbour with ymd' ); while ($j6438c=mysqli_fetch_array($_db['result'],MYSQLI_ASSOC)) { list ($c84cdc,$r7436f,$r628b7)=explode('/', e5a2f('Y/n/j',$j6438c['Stamp'],d0923($j6438c)) ); $u7474d=$x41529*10000 + ($r6f8f5? ($r6f8f5*100):0) + ($u8277e? $u8277e:0); $dbd8da=$c84cdc*10000 + ($r6f8f5? ($r7436f*100):0) + ($u8277e? $r628b7:0); if ($dbd8da < $u7474d){ $bbf025=gmmktime(0,0,0,$r7436f,$r628b7,$c84cdc); break; } } a0738( "SELECT `Stamp`, `Offset`, `IsDST` ". "FROM `". $_config['db_table_prefix']. "Notes` n ". "WHERE `IsPublished`=1 ". "AND `Stamp` > '". ($b3d2fa+$zada4b) ."' ". v6f32(ge852()). "ORDER BY Stamp", 'get next fruitful neighbour with ymd' ); while ($j6438c=mysqli_fetch_array($_db['result'],MYSQLI_ASSOC)) { list ($c84cdc,$r7436f,$r628b7)=explode('/', e5a2f('Y/n/j',$j6438c['Stamp'],d0923($j6438c)) ); $u7474d=$x41529*10000 + ($r6f8f5? ($r6f8f5*100):0) + ($u8277e? $u8277e:0); $dbd8da=$c84cdc*10000 + ($r6f8f5? ($r7436f*100):0) + ($u8277e? $r628b7:0); if ($dbd8da > $u7474d){ $p8dc98=gmmktime(0,0,0,$r7436f,$r628b7,$c84cdc); break; } } return [$bbf025,$p8dc98]; } function e2__parameters_with_timestamp_($o96b8c){ list ( $parameters['year'], $parameters['month'], $parameters['day'] ) = explode('/',gmdate('Y/m/d',$o96b8c)); return$parameters; } function z28df($xc2d18,$c84cdc=false,$r7436f=false){ $b229c3=0; $e4358b=array(); $mf09d8=''; $e4358b=array(); $xcc73f=array(); foreach ($xc2d18 as $c8ce4b => $b39a37){ $raad65['href'] = i83c8('e2m_note', array ('*note' => $b39a37)); $raad65['time'] = array ((int)min($b39a37['Stamp'],time()), d0923($b39a37)); $raad65['last-modified'] = array ((int)min($b39a37['LastModified'],time()), d0923($b39a37)); $raad65['favourite?'] = (bool) ($b39a37['IsFavourite'] && $b39a37['IsPublished']); $raad65['visible?'] = ab44b($b39a37); if(array_key_exists('SourceNoteURL',$b39a37) and @$b39a37['SourceNoteURL']!=''){ $raad65['href']=$b39a37['SourceNoteURL']; $raad65['href-original']=$b39a37['SourceNoteURL']; } if ( ($c84cdc and $r7436f and ( ((int)$c84cdc) .'/'. ((int)$r7436f) == e5a2f('Y/n',$b39a37['Stamp'],d0923($b39a37)) )) or ($c84cdc and !$r7436f and ( (int)$c84cdc == e5a2f('Y',$b39a37['Stamp'],d0923($b39a37)) )) or (!$c84cdc and !$r7436f) ) { array_unshift($e4358b,$raad65); array_unshift($xcc73f,str_replace("\n",' ',$b39a37['Title'])); } } $l789f1=implode("\n",$xcc73f); $l789f1=a6f10(htmlspecialchars($l789f1,ENT_NOQUOTES,HSC_ENC)); $xcc73f=explode("\n",$l789f1); foreach ($e4358b as $c8ce4b => $i9e366){ $e4358b[$c8ce4b]['title']=$xcc73f[$c8ce4b]; } return $e4358b; } function e9737($x41529){ global$_config; list ($f5a603,$qc2b31)=g5273($x41529); a0738( "SELECT `Stamp`, `Offset`, `IsDST` ". "FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `IsPublished`=1 ". "AND `Stamp` BETWEEN '". $f5a603. "' AND '". $qc2b31 ."' ". v6f32(ge852()), 'get all notes for the year '. $x41529 .' to list months with notes' ); $result=z0d6b(); $wda36c=array(); foreach($result as $c65afd){ if ( ((int)$x41529) == e5a2f('Y',$c65afd['Stamp'],d0923($c65afd)) ) { $wda36c[] = (int)e5a2f('n',$c65afd['Stamp'],d0923($c65afd)); } } $wda36c=@array_unique($wda36c); sort($wda36c); return $wda36c; } function vae09($x41529,$r6f8f5){ global$_config; list ($ifc6b2,$a10df4)=g5273($x41529,$r6f8f5); a0738( "SELECT `Stamp`, `Offset`, `IsDST` ". "FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `IsPublished`=1 ". "AND `Stamp` BETWEEN '". $ifc6b2 ."' AND '". $a10df4 ."' ". v6f32(ge852()), 'get all notes for the month '.$r6f8f5.' of the year '. $x41529 .' to list days with notes' ); $result=z0d6b(); $w44fde=array(); foreach($result as $c65afd){ if ( ((int)$x41529) .'/'. ((int)$r6f8f5) == e5a2f('Y/n',$c65afd['Stamp'],d0923($c65afd)) ) { $w44fde[] = (int)e5a2f('j',$c65afd['Stamp'],d0923($c65afd)); } } $w44fde=@array_unique($w44fde); sort($w44fde); return $w44fde; } function fcc02($i92c58){ global$_config; $k8b7af='p1'; if (!ge852()) { $k8b7af='p1v1'; } $vd29bb=CACHES_FOLDER.$i92c58 .'-stamp-'. $k8b7af .'.e2time.psa'; if(CACHE_EDGE_TIMEINFO and is_file($vd29bb)) { $f2cb9d=@unserialize(file_get_contents($vd29bb)); } if(is_array($f2cb9d)) { return $f2cb9d; } else { $f2cb9d=array ( 'stamp' => time(), 'timezone' => w5c05(), ); if ($i92c58=='start'){ a0738( "SELECT `Stamp`, `Offset`, `IsDST` ". "FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `IsPublished`=1 ". v6f32(ge852()). "ORDER BY `Stamp` LIMIT 1", 'get blog start timestamp' ); } elseif ($i92c58=='end'){ a0738( "SELECT `Stamp`, `Offset`, `IsDST` ". "FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `IsPublished`=1 ". v6f32(ge852()). "ORDER BY `Stamp` DESC LIMIT 1", 'get blog latest note timestamp' ); } $result=z0d6b(); if(count($result)) { $f2cb9d=array ( 'stamp' => $result[0]['Stamp'], 'timezone' => d0923($result[0]), ); if(CACHE_EDGE_TIMEINFO)s6e52($vd29bb,serialize($f2cb9d)); return $f2cb9d; } return $f2cb9d; } } define('CACHE',true); define('CACHE_NOTES',CACHE and true); define('CACHE_NOTES_COMMENTS',CACHE and true); define('CACHE_POPULAR',CACHE and true); define('CACHE_HOT',CACHE and true); define('CACHE_FAVS',CACHE and true); define('CACHE_TAGS',CACHE and true); define('CACHE_FAVTAGS',CACHE and true); define('CACHE_NOTES_COUNTS',CACHE and true); define('CACHE_EDGE_TIMEINFO',CACHE and true); define('CACHE_FRONTPAGE',CACHE and true); define('CACHE_FRONTPAGE_FEED',CACHE and true); define('CACHE_FULLLIST',CACHE and true); define('CACHE_DRAFTS',CACHE and true); define('CACHE_DRAFTS_ALIAS_USE_COUNTS',CACHE and true); define('CACHE_LASTMODIFIEDS',CACHE and true); define('CACHE_FILENAMES_NOTES',CACHES_FOLDER.'note-*.ctree.psa'); define('CACHE_FILENAMES_NOTES_COMMENTS', CACHES_FOLDER.'note-*-comments.ctree.psa' ); define('CACHE_FILENAMES_NOTES_COMMENTS_AUTHOR', CACHES_FOLDER.'note-*-comments-author.ctree.psa' ); define('CACHE_FILENAMES_NOTES_COUNTS',CACHES_FOLDER.'notes-count-*.txt'); define('CACHE_FILENAMES_EDGE_TIMEINFO',CACHES_FOLDER.'*.e2time.psa'); define('CACHE_FILENAME_POPULAR',CACHES_FOLDER.'popular.ctree.psa'); define('CACHE_FILENAME_POPULAR_EXPIRES',CACHES_FOLDER.'popular-expires.txt'); define('CACHE_FILENAME_HOT',CACHES_FOLDER.'hot.ctree.psa'); define('CACHE_FILENAME_HOT_EXPIRES',CACHES_FOLDER.'hot-expires.txt'); define('CACHE_FILENAME_FAVS',CACHES_FOLDER.'favourites.ctree.psa'); define('CACHE_FILENAME_TAGS',CACHES_FOLDER.'tags.ctree.psa'); define('CACHE_FILENAME_TAGS_FULL',CACHES_FOLDER.'tags-full.ctree.psa'); define('CACHE_FILENAME_TAGS_AUTHOR',CACHES_FOLDER.'tags-author.ctree.psa'); define('CACHE_FILENAME_TAGS_AUTHOR_FULL',CACHES_FOLDER.'tags-author-full.ctree.psa'); define('CACHE_FILENAME_FAVTAGS',CACHES_FOLDER.'favtags.ctree.psa'); define('CACHE_FILENAME_FRONTPAGE',CACHES_FOLDER.'frontpage.ctree.psa'); define('CACHE_FILENAME_FRONTPAGE_AUTHOR',CACHES_FOLDER.'frontpage-author.ctree.psa'); define('CACHE_FILENAME_FRONTPAGE_FEED',CACHES_FOLDER.'frontpage-feed.psa'); define('CACHE_FILENAME_FULLLIST',CACHES_FOLDER.'notes-list.ctree.psa'); define('CACHE_FILENAME_DRAFTS',CACHES_FOLDER.'drafts.psa'); define('CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS',CACHES_FOLDER.'drafts-auc.psa'); define('CACHE_FILENAME_LASTMODIFIEDS',CACHES_FOLDER.'last-modifieds-by-id.psa'); function e2s_sync(){ e2_drop_all_kinds_of_cache(); die ('All caches clean.'); } function e2_note_cache_filename_with_id_($ub80bb){ return str_replace('*',$ub80bb,CACHE_FILENAMES_NOTES); } function e2_drop_caches_for_note_($i21158){ if(is_numeric($i21158)) { if(Log::$ned2b5)__log('Caches: Drop caches for note id '. $i21158); @unlink(e2_note_cache_filename_with_id_($i21158)); @unlink(e2_note_cache_filename_with_id_($i21158 .'-comments')); @unlink(e2_note_cache_filename_with_id_($i21158 .'-comments-author')); } else { fc5a6(CACHE_FILENAMES_NOTES); fc5a6(CACHE_FILENAMES_NOTES_COMMENTS); fc5a6(CACHE_FILENAMES_NOTES_COMMENTS_AUTHOR); } ae2f1(); d22e7(); @unlink(CACHE_FILENAME_HOT); @unlink(CACHE_FILENAME_POPULAR); @unlink(CACHE_FILENAME_FRONTPAGE); @unlink(CACHE_FILENAME_FRONTPAGE_AUTHOR); @unlink(CACHE_FILENAME_FRONTPAGE_FEED); @unlink(CACHE_FILENAME_FULLLIST); @unlink(CACHE_FILENAME_TAGS); @unlink(CACHE_FILENAME_TAGS_AUTHOR); @unlink(CACHE_FILENAME_LASTMODIFIEDS); } function y7996(){ if(Log::$ned2b5)__log('Caches: Drop notes caches'); e2_drop_caches_for_note_(null); } function ae2f1(){ if(Log::$ned2b5)__log('Caches: Drop notes counts cache'); fc5a6(CACHE_FILENAMES_NOTES_COUNTS); } function d22e7(){ if(Log::$ned2b5)__log('Caches: Drop egde time info cache'); fc5a6(CACHE_FILENAMES_EDGE_TIMEINFO); } function e2_drop_all_kinds_of_cache(){ if(Log::$ned2b5)__log('Caches: Drop all kinds of caches'); fc5a6(CACHES_FOLDER.'*'); return true; } define('OLBA_SPECIAL_CHAR',"\x1"); define('OLBA_SPECIAL_SEQUENCE_LENGTH',6); function zdb82($e139c8=null){ global$_template,$_config,$settings; if ($e139c8===null)$e139c8=@$settings['template']; $k1b14d=false; $wa5fca=false; $l37c8a=false; $oaf10b=array(); $gd9ecb=$e139c8; if ($gd9ecb) while (1){ if(Log::$ned2b5)__log('Prepare theme "'. $gd9ecb .'"'); $a620f7=TEMPLATES_FOLDER.$gd9ecb .'/'; if ( !is_dir($a620f7) or !is_file($a620f7 .'/theme-info.php') ) { if(Log::$ned2b5)__log('Theme "'. $gd9ecb .'" not found, using default theme "'. DEFAULT_TEMPLATE .'"'); $gd9ecb=DEFAULT_TEMPLATE; $a620f7=TEMPLATES_FOLDER.$gd9ecb .'/'; } array_push($oaf10b,$a620f7); $p38226=include $a620f7 .'/theme-info.php'; $j4e502[$a620f7]=$p38226; if(array_key_exists('max_image_width',$p38226)) { if ($k1b14d===false){ $k1b14d=$p38226['max_image_width']; } } if(array_key_exists('meta_viewport',$p38226)) { if ($wa5fca===false){ $wa5fca=$p38226['meta_viewport']; } } if(array_key_exists('use_likely_light',$p38226)) { if ($l37c8a===false){ $l37c8a=$p38226['use_likely_light']; } } if(array_key_exists('based_on',$p38226)) { $gd9ecb=$p38226['based_on']; } else { break; } } $a620f7=SYSTEM_TEMPLATE_FOLDER; array_push($oaf10b,$a620f7); if ($k1b14d===false){ $k1b14d=$_config['max_image_width']; } $_template['name']=$e139c8; $_template['max_image_width']=$k1b14d; $_template['meta_viewport']=$wa5fca; $_template['use_likely_light']=$l37c8a; $_template['stack']=$oaf10b; $_template['infos']=$j4e502; }; function i53ee($bd436e){ global$content; ++ $_olba_includes; if(Log::$ned2b5)__log('Eat "'. $bd436e .'"'); include $bd436e; } function of671($w6a992){ return ( OLBA_SPECIAL_CHAR. str_pad($w6a992,OLBA_SPECIAL_SEQUENCE_LENGTH,'0',STR_PAD_LEFT). OLBA_SPECIAL_CHAR ); } function lab71($eb0689){ static $w6a992=0; zf1da($eb0689,'_olba_placeholders'); echo of671($w6a992 ++); } function f326f($t78e62){ global$_olba_placeholders; foreach($_olba_placeholders as $w6a992 => $b2063c){ $me068c=of671($w6a992); $v5e0bd=strpos($t78e62,$me068c); $ff5300=n166b($b2063c,true); if ($v5e0bd!==false){ $t78e62=substr_replace( $t78e62,$ff5300,$v5e0bd,strlen($me068c) ); } else { break; } } return $t78e62; } function f6a97($h52678){ if(is_dir(EXTRAS_FOLDER)) { $y71cae=EXTRAS_FOLDER.$h52678 .'.tmpl.php'; if(is_file($y71cae)) { i53ee($y71cae); } } return ''; } function n166b($h52678,$qe70c4=false){ global$_template,$_olba_includes; $y71cae='templates/'. $h52678 .'.tmpl.php'; if ($bd436e=e2o__usable_file_with_basename_($y71cae)) { if ($qe70c4){ ob_start(); } i53ee($bd436e); if ($qe70c4){ $f2cb9d=ob_get_contents(); ob_end_clean(); return $f2cb9d; } } else { ob_end_clean(); throw new AeOlbaTemplateMissingException('Missing: '. $y71cae); } } function ybc21(){ global$_config; if ( @$_config['raw_template_data'] or @$_config['raw_template_data_with_param'] and array_key_exists('raw',$_GET) ) { $b3f7d9='raw'; } else { $b3f7d9='main'; } return n166b($b3f7d9,true); } function ed4c1($c45ac4){ zf1da($c45ac4 .'.css','_olba_used_stylesheets'); } function id00a($b3205c){ zf1da($b3205c .'.js','_olba_used_scripts'); } function l16f0($ue8acc){ foreach (array (SYSTEM_LIBRARY_FOLDER,USER_LIBRARY_FOLDER) as $b71379){ foreach(glob($b71379.$ue8acc .'/*') as $m8c7dd){ $oabf77=pathinfo($m8c7dd,PATHINFO_EXTENSION); if ($oabf77=='js'){ zf1da($m8c7dd,'_olba_used_scripts'); } if ($oabf77=='css'){ zf1da($m8c7dd,'_olba_used_stylesheets'); } } } } function q94dd(){ global$_template,$_config,$settings; if ($je1260=@opendir(TEMPLATES_FOLDER)) { while (false !== ($a1f769=readdir($je1260))) { if(is_dir(TEMPLATES_FOLDER. $a1f769) and $a1f769!='.' and $a1f769!='..'){ if(is_file(TEMPLATES_FOLDER.$a1f769 .'/theme-info.php')) { $wccf6b[$a1f769]=TEMPLATES_FOLDER.$a1f769 .'/'; } } } closedir($je1260); } $i10ae9=array(); $k2e3a2=1000; foreach ($wccf6b as $eb0689 => $a85114){ $p38226=include $a85114 .'theme-info.php'; $mc2657=@$p38226['display_name']; if (!$mc2657) continue; if(is_array($mc2657)) { if(array_key_exists($settings['language'],$mc2657)) { $mc2657=$mc2657[$settings['language']]; } else { $mc2657=array_shift($mc2657); } } $w6a992=@$p38226['index'] or $w6a992=$k2e3a2 ++; $d62848=@$p38226['colors']; if (!$d62848)$d62848=array ( 'background' => 'transparent', 'headings' => 'rgba(128,128,128,.2)', 'text' => 'rgba(128,128,128,.2)', 'link' => 'rgba(128,128,128,.2)', ); $v16e25=(bool) ($eb0689==$_template['name']); if ($v16e25){ $gcd143=i83c8('e2m_theme_preview', array ('theme' => '')); } else { $gcd143=i83c8('e2m_theme_preview', array ('theme' => $eb0689)); } $i10ae9[$w6a992] = array ( 'name' => $eb0689, 'display-name' => $mc2657, 'colors' => $d62848, 'current?' => $v16e25, 'preview-url' => $gcd143, ); } ksort($i10ae9); return $i10ae9; } function g1492($n435ed){ return e2o__usable_file_with_basename_('images/'. $n435ed); } function hf42c($jb1197){ return file_get_contents(e2o__usable_file_with_basename_('images/'. $jb1197 .'.svg')); } function h576f($c45ac4){ global$_template; $b954eb='styles/'. $c45ac4 .'.css'; $p95aa1=array(); foreach($_template['stack'] as $a620f7){ if(is_file($n435ed=$a620f7.$b954eb)) { $p95aa1[] = $n435ed; } if ( array_key_exists('reset_styles',$_template['infos'][$a620f7]) and in_array($c45ac4,$_template['infos'][$a620f7]['reset_styles']) ) { break; } } $p95aa1=array_reverse($p95aa1); } function b37ca(){ global$_olba_used_stylesheets,$_template; if (!isset ($_olba_used_stylesheets)) return; $_olba_used_stylesheets=array_unique($_olba_used_stylesheets); $fc7f50=array(); foreach($_olba_used_stylesheets as $c45ac4){ if(is_file($c45ac4)) { $fc7f50[] = $c45ac4; continue; } if(is_file($n435ed=USER_FOLDER .'js/'. $c45ac4)) { $fc7f50[] = $n435ed; } $b954eb='styles/'. $c45ac4; $p95aa1=array(); foreach($_template['stack'] as $a620f7){ if(is_file($n435ed=$a620f7.$b954eb)) { $p95aa1[] = $n435ed; } if ( array_key_exists('reset_styles',$_template['infos'][$a620f7]) and in_array($c45ac4,$_template['infos'][$a620f7]['reset_styles']) ) { break; } } $p95aa1=array_reverse($p95aa1); $fc7f50=array_merge($fc7f50,$p95aa1); } if(E2_EDITION){ foreach($_template['stack'] as $a620f7){ if(array_key_exists('global_styles',$_template['infos'][$a620f7])) { $fc7f50[] = $_template['infos'][$a620f7]['global_styles']; } } } foreach ($fc7f50 as $c8ce4b => $i9e366){ $xbc7b3=stat($i9e366); $fc7f50[$c8ce4b].='?'. $xbc7b3['mtime']; } return $fc7f50; } function e4753(){ global$_olba_used_scripts; if (!isset ($_olba_used_scripts)) return; $_olba_used_scripts=array_unique($_olba_used_scripts); $pd6c58=array(); foreach($_olba_used_scripts as $b3205c){ if ( substr($b3205c,0,7)=='http://' or substr($b3205c,0,8)=='https://' or substr($b3205c,0,2)=='//' ){ $pd6c58[] = $b3205c; continue; } if(is_file($b3205c)) { $pd6c58[] = $b3205c; continue; } if(is_file($i9d679=USER_FOLDER .'js/'. $b3205c)) { $pd6c58[] = $i9d679; } $b954eb='js/'. $b3205c; if ($i9d679=e2o__usable_file_with_basename_($b954eb)) { $pd6c58[] = $i9d679; } } foreach ($pd6c58 as $c8ce4b => $i9e366){ $xbc7b3=stat($i9e366); if ($xbc7b3['mtime']) { $pd6c58[$c8ce4b].='?'. $xbc7b3['mtime']; } } return $pd6c58; } function r57ad($ab268d){ if (!is_array($ab268d)) return; foreach ($ab268d as $z2a304){ if(substr($z2a304, -3)=='.js'){ id00a(substr($z2a304,0, -3)); } if(substr($z2a304, -4)=='.css'){ ed4c1(substr($z2a304,0, -4)); } } } function zf1da($b2063c,$rf1f71){ if (!isset ($GLOBALS[$rf1f71])) { $GLOBALS[$rf1f71] = array ($b2063c); } else { $GLOBALS[$rf1f71][] = $b2063c; } } function e2o__usable_file_with_basename_($b954eb){ global$_template; if (!isset ($_template))zdb82(); foreach($_template['stack'] as $a620f7){ if(is_file($n435ed=$a620f7.$b954eb)) { return $n435ed; } } return ''; } function e2m_theme_preview($parameters){ global$_lang,$_strings,$_superconfig,$_template; if (@$_superconfig['disallow_themes_preview']) { return e2_error404_mode(); } if($parameters['theme']==$_template['name']) { e2_go_to(i83c8('e2m_theme_preview', array ('theme' => ''))); } if($parameters['theme']) { zdb82($parameters['theme']); } $k75725=$_lang; if (!is_file($m8c7dd='system/preview/'. $k75725 .'.php')) { $k75725=$_strings['--secondary-language']; $m8c7dd='system/preview/'. $k75725 .'.php'; } if (!is_file($m8c7dd='system/preview/'. $k75725 .'.php')) { $m8c7dd='system/preview/'. DEFAULT_LANGUAGE .'.php'; } $qe70c4=include $m8c7dd; return $qe70c4; } define('SEARCH_EXTRA_PREFIX','Rose'); define('SEARCH_LIMIT',20); define('SEARCH_SNIPPETS_LIMIT',20); define('SEARCH_USE_ROSE',1); define('SEARCH_USE_MYSQL',1); define('BSI_SELECT_PORTION',10); define('BSI_GIVE_UP_TIMEOUT',10); define('BSI_UNLOCK_TIMEOUT',10); use S2\Rose\Storage\Exception\EmptyIndexException; use S2\Rose\Storage\Database\PdoStorage; use S2\Rose\Stemmer\PorterStemmerRussian; use S2\Rose\Indexer; use S2\Rose\Entity\Indexable; use S2\Rose\Entity\Query; use S2\Rose\Finder; use S2\Rose\SnippetBuilder; function e2m_found($parameters=array ()) { global$_strings,$_config,$settings,$full_blog_url; $parameters['query']=trim($parameters['query']); $f1b1cc=$parameters['query']; if (!$f1b1cc){ return array ( 'title' => $_strings['pt--search-query-empty'], 'heading' => $_strings['pt--search'], 'nothing' => $_strings['gs--search-query-empty'], ); } $v11128=false; try { a0738( "SELECT * FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `Keyword`='". c7928($f1b1cc) ."'", 'get tags matching the search query' ); $cfa816=z0d6b(); if (isset ($cfa816[0]['ID'])) { $v11128=array ( 'href' => i83c8('e2m_tag', array ('*tag' => $cfa816[0])), 'name' => htmlspecialchars($f1b1cc,ENT_NOQUOTES,HSC_ENC), ); } } catch (AeMySQLException $e){ c12f6($ae1671,'Could not get tags matching the search query'); } $a4dd42=o163d(' ',$parameters['query']); if(SEARCH_USE_ROSE){ $vfce9c=new PorterStemmerRussian(); foreach ($a4dd42 as $c8ce4b => $i9e366){ $a4dd42[$c8ce4b]=$vfce9c -> stemWord($a4dd42[$c8ce4b]); } } $s8e830=array(); $q5d481=ge852(); if(SEARCH_USE_ROSE){ try { $hddece=b476c(); $a5b9bd=new Finder($hddece,$vfce9c); $a5b9bd -> setHighlightTemplate('<mark>%s</mark>'); $pf7de9=new Query($f1b1cc); $pf7de9 -> setLimit(SEARCH_LIMIT); $resultSet=$a5b9bd -> find($pf7de9); foreach($resultSet -> getFoundExternalIds() as $g0e684){ if ($g0e684[0]=='n'){ $i21158=substr($g0e684,1); $raad65=v4627($i21158); if ($raad65['IsFavourite']) { $resultSet->setRelevanceRatio($g0e684, @$_config['search_favourites_boost']); } } } $snippetBuilder=new SnippetBuilder($vfce9c); $snippetBuilder -> setSnippetLineSeparator(' · '); $snippetBuilder -> attachSnippets($resultSet, function (array $kbf516){ $result=array(); foreach(array_slice($kbf516,0,SEARCH_SNIPPETS_LIMIT) as $g0e684){ if ($g0e684[0]=='n'){ $i21158=substr($g0e684,1); $b39a37=@v4627($i21158); if ($b39a37){ $b39a37['_']['_id']=$i21158; $raad65=v6791($b39a37); $result[$g0e684]=$raad65['text']; } } } return$result; }); foreach($resultSet -> getItems() as $g0e684 => $v447b7){ if ($g0e684[0]=='n'){ $i21158=substr($g0e684,1); $raad65=v4627($i21158); $raad65['_']['_id']=$i21158; $raad65['_']['_srprovider']='rose'; $raad65['_']['_rose_relevance']=$v447b7 -> getRelevance(); $raad65['_']['_rose_title']=$v447b7 -> getHighlightedTitle($vfce9c); $raad65['_']['_rose_snippet']=$v447b7 -> getSnippet(); if ($raad65['IsPublished'] and ab44b($raad65,$q5d481)) { $s8e830[] = $raad65; } } } if (@$_config['dev_rose_info']) { $z1e441=print_r($resultSet -> getTrace(),true); } } catch (EmptyIndexException $e){ c12f6($ae1671,'Rose index is empty'); } catch (AeMySQLException $e){ c12f6($ae1671,'Could not do something with the database while working on Rose search results'); } } if(SEARCH_USE_MYSQL){ $t36a38=c7928(preg_quote($f1b1cc)); $deb31b=( "SELECT * FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `IsPublished`=1 AND MATCH (`Title`, `Text`) AGAINST ('". $t36a38 ."')". v6f32($q5d481). "LIMIT ". SEARCH_LIMIT ); try { a0738( $deb31b, 'search using MySQL fulltext search' ); $result=z0d6b(); foreach($result as $c8ce4b => $raad65){ $raad65['_']['_id']=$raad65['ID']; $raad65['_']['_srprovider']='mysql'; $s8e830[] = $raad65; } } catch (AeMySQLException $e){ c12f6($ae1671,'Could not search using MySQL fulltext search'); } } $qfbdf2=array(); $e4358b=array(); $d865c0=0; foreach ($s8e830 as $b39a37){ if (!in_array($b39a37['ID'],$qfbdf2)) { $raad65=v6791($b39a37); if (@$raad65['_']['_rose_title']) { $raad65['title']=$raad65['_']['_rose_title']; } else { $raad65['title']=m4c2d($raad65['title'],$a4dd42); } $raad65['title']=a6f10($raad65['title']); if (@$raad65['_']['_rose_snippet']) { $raad65['text']='<p>'. $raad65['_']['_rose_snippet'] .'</p>'; } else { $j1cb25=$raad65['text']; $j1cb25=preg_replace('/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/i','',$j1cb25); $j1cb25=preg_replace('/<style\b[^<]*(?:(?!<\/style>)<[^<]*)*<\/style>/i','',$j1cb25); $j1cb25=str_replace( array ( '<br>', '<br/>', '<br />', '</h1>', '</h2>', '</h3>', '</h4>', '</h5>', '</h6>', '</p>', '</pre>', '</blockquote>', '</li>', ), ' ', $j1cb25 ); $j1cb25=strip_tags($j1cb25); $vad7ba=array(); $w9cc49=preg_split('/[\\n\(\)\[\]]|[.:;?!](\s|$)/uis',$j1cb25); $x363b1=0; $s02db3=''; foreach ($w9cc49 as $kd866f){ $kd866f=trim($kd866f); if (!$kd866f) continue; if (!$s02db3)$s02db3=$kd866f; $y870c2=$kd866f; $y870c2=m4c2d($y870c2,$a4dd42); if ($y870c2!=$kd866f){ $vad7ba[] = d48d8($y870c2); $x363b1 ++; if ($x363b1 > 3) break; } } if(count($vad7ba)) { $raad65['text']='<p>'. implode(' · ',$vad7ba) .'</p>'; } else { $raad65['text']='<p>'. $s02db3 .'</p>'; } } $raad65['has-highlighed-thumbs?']=false; if ($p55b55=@$raad65['format-info']['resources-detected']) { $x750fa=d2e82($p55b55); foreach ($x750fa as $c8ce4b => $i9e366){ $x750fa[$c8ce4b]['highlighted?'] = ( strstr($i9e366['original-filename'],$f1b1cc)!==false ); if ($x750fa[$c8ce4b]['highlighted?']) { $raad65['has-highlighted-thumbs?']=true; } } $raad65['thumbs']=$x750fa; } $e4358b[] = $raad65; $qfbdf2[] = $b39a37['ID']; $d865c0 ++; if ($d865c0 >= SEARCH_LIMIT) break; } } $hfbb44=count($e4358b); if ($hfbb44){ $b5cde2=e2l_get_string( 'pt--n-posts', array ('number' => $hfbb44) ); } else { $b5cde2=$_strings['pt--no-posts']; $f2cb9d['nothing']=$_strings['gs--nothing-found']; } if ($d865c0 >= SEARCH_LIMIT){ $b5cde2=$_strings['gs--many-posts']; } if ($v11128){ $f2cb9d['search-related-tag']=$v11128; } $f2cb9d['notes']=$e4358b; $f2cb9d['pages'] = array (); $f2cb9d['title']=$b5cde2 .' '. $_strings['gs--found-for-query'] .': '. htmlspecialchars($f1b1cc,ENT_NOQUOTES,HSC_ENC); $f2cb9d['superheading']=$b5cde2 .' '. $_strings['gs--found-for-query']; $f2cb9d['heading']=$f1b1cc; if (@$z1e441){ $f2cb9d['rose-debug-info']=$z1e441; } return $f2cb9d; } function n5070($parameters){ if(Log::$ned2b5)__log('Search form'); $f1b1cc=trim((string) @$parameters['query']); return [ 'form-action' => i83c8('e2s_search'), 'query' => htmlspecialchars($f1b1cc,ENT_COMPAT,HSC_ENC), ]; } function e2s_search(){ $f1b1cc=@$_POST['query']; $f1b1cc=str_replace('?',urlencode('?'),$f1b1cc); $f1b1cc=str_replace('/',' ',$f1b1cc); $f1b1cc=trim($f1b1cc); $f1b1cc=str_replace(' ','+',$f1b1cc); e2_go_to(i83c8('e2m_found', array ('query' => $f1b1cc))); die; } function e2s_bsi_status(){ global$_db,$_config; echo '<pre>'; echo '/@bsi/step/ — Make one step of indexing<br />'; echo '/@bsi/drop/ — Drop indexes<br /><br />'; $ke1fab=@unserialize(file_get_contents(USER_FOLDER.'indexing.psa')); if (!is_array($ke1fab))$ke1fab=array ('spent' => '?'); $v34421=$de0d69=$od1647='?'; try { a0738( "SELECT count(*) c FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished`=1 ", 'count total published notes' ); $j9b207=z0d6b(); $v34421=$j9b207[0]['c']; a0738( "SELECT count(*) c FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsIndexed`=1 AND `IsPublished`=1 ", 'count indexed published notes' ); $j9b207=z0d6b(); $de0d69=$j9b207[0]['c']; $od1647=round($de0d69/$v34421*100); echo 'Indexed '. $de0d69 .' notes of '. $v34421 .' ('. $od1647 .'%)<br />'; echo 'Spent '. $ke1fab['spent'] .' s (or more)'; } catch (AeMySQLException $e){ c12f6($ae1671,'Could not count some notes'); echo 'DB unaccessible'; } die ('</pre>'); } function e2s_bsi_step(){ global$_db,$_config,$_strings; echo '<pre>'; if($_config['log_bsi']) { Log::$ned2b5=true; if(Log::$ned2b5)l714a('bsi'); } if(Log::$ned2b5)__log('BSI step'); if (!k3b97()) { if(Log::$ned2b5)__log('Not indexing'); die ('Not indexing</pre>'); } $ke1fab=@unserialize(file_get_contents(USER_FOLDER.'indexing.psa')); if (!is_array($ke1fab))$ke1fab=array ('spent' => '?'); if ( !isset ($ke1fab['lock']) or $ke1fab['lock'] < time() - (BSI_GIVE_UP_TIMEOUT+BSI_UNLOCK_TIMEOUT) ) { if (isset ($ke1fab['lock'])) { if(Log::$ned2b5)__log('Indexer: old lock is '. $ke1fab['lock']); echo 'Old lock is '. $ke1fab['lock'] .'<br />'; } else { echo 'No old lock<br />'; } $ke1fab['lock']=time(); if (!@s6e52(USER_FOLDER.'indexing.psa',serialize($ke1fab))) { if(Log::$ned2b5)__log('Indexer: can’t get a new lock'); die ('Can’t get a new lock<br />'); } if(Log::$ned2b5)__log('Indexer: new lock is '. $ke1fab['lock']); echo 'New lock is '. $ke1fab['lock'] .'<br /><br />'; try { $d865c0=0; $u680a2=0; $bce2fc=f7f78(); $l30d94=false; while ($u680a2 < BSI_GIVE_UP_TIMEOUT){ a0738( "SELECT * FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsIndexed`=0 AND `IsPublished`=1 ". "ORDER BY `Stamp` DESC ". "LIMIT ". BSI_SELECT_PORTION, 'get portion of unindexed notes for indexing' ); $j9b207=z0d6b(); if(count($j9b207)) { ++ $d865c0; if(Log::$ned2b5)__log('Indexer: portion '. $d865c0); echo 'Portion '. $d865c0 .'<br />'; foreach ($j9b207 as $wea59a){ if(Log::$ned2b5)__log('Indexer: indexing "'. $wea59a['Title'].'"'); echo 'Indexing: '. $wea59a['Title'] .'<br />'; $wea59a['IsIndexed']='1'; taa79('Notes',$wea59a); qd2e1($wea59a); if($_config['broadcast_on_indexing']) { neb3b($wea59a); } } $u680a2=round(f7f78()-$bce2fc,3); if(Log::$ned2b5)__log('Indexer: step done '. count($j9b207) .', spent '. $u680a2 .' ms so far'); echo 'Step done '. count($j9b207) .', spent '. $u680a2 .' ms so far<br /><br />'; if(Log::$ned2b5)__log($t78e62); } else { $l30d94=true; break; } } if ($l30d94){ if(Log::$ned2b5)__log('Indexer: indexing complete'); echo 'Indexing complete<br /><br />'; @unlink(USER_FOLDER.'indexing.psa'); } else { echo 'Time out<br />'; unset ($ke1fab['lock']); $ke1fab['done']=count($j9b207); if ($ke1fab['spent']!='?')$ke1fab['spent']+=$u680a2; @s6e52(USER_FOLDER.'indexing.psa',serialize($ke1fab)); } } catch (AeMySQLException $e){ c12f6($ae1671,'Could not index notes'); if(Log::$ned2b5)__log('Indexer: DB unaccessible'); echo 'DB unaccessible<br />'; } } else { if(Log::$ned2b5)__log('Indexer: locked'); echo 'Locked<br />'; } die ('</pre>'); } function e2s_bsi_drop(){ global$_db,$_config; try { echo '<pre>'; ga521(); echo 'All notes marked for reindexing<br />'; $hddece=b476c(); try { $hddece -> erase(); echo 'Indexes dropped<br />'; } catch (\S2\Rose\Exception\RuntimeException $e){ c12f6($ae1671,'Rose threw RuntimeException'); } s198f(); die ('</pre>'); } catch (AeMySQLException $e){ c12f6($ae1671,'Could not make all notes for reindexing'); die ('<pre>DB unaccessible</pre>'); } } function s198f(){ $ke1fab=array(); @s6e52(USER_FOLDER.'indexing.psa',serialize($ke1fab)); } function k3b97(){ return (is_file(USER_FOLDER.'indexing.psa')); } function qd2e1($b39a37){ if(Log::$ned2b5)__log('Indexer: index noterec'); static $tf4540=null; try { if ($tf4540===null){ $vfce9c=new PorterStemmerRussian(); $tf4540=new Indexer(b476c(),$vfce9c); } $g2bfe4=c154e($b39a37['FormatterID'], @$b39a37['Text'],'full-rss'); wfc4d($b39a37,$g2bfe4); $j1cb25=strip_tags($g2bfe4['text-final']); $n3e961=new Indexable( 'n'. $b39a37['ID'], $b39a37['Title'], $j1cb25 ); return $tf4540 -> index($n3e961); } catch (\Exception $e){ return false; } } function v10fe($ub80bb){ static $tf4540=null; try { if ($tf4540===null){ $vfce9c=new PorterStemmerRussian(); $tf4540=new Indexer(b476c(),$vfce9c); } return $tf4540 -> removeById('n'. $ub80bb); } catch (\Exception $e){ return false; } } function r713e($fa2f2e){ $u851f5='S2\\Rose\\'; $g32fcc=__DIR__.'/library/rose/'; $hf5a8e=strlen($u851f5); if(strncmp($u851f5,$fa2f2e,$hf5a8e)!==0) return; $ke1cb9=substr($fa2f2e,$hf5a8e); $m8c7dd=$g32fcc.str_replace('\\','/',$ke1cb9).'.php'; if(file_exists($m8c7dd)) require $m8c7dd; } function pd372(){ return array ( 'TOC' => 'Contents', 'WORD' => 'Word', 'FULLTEXT_INDEX' => 'Fulltext', 'KEYWORD_INDEX' => 'Keyword', 'KEYWORD_MULTIPLE_INDEX' => 'KeywordMultiple', ); } function b476c(){ global$_config,$settings; static $u88131=null; if ($u88131===null and SEARCH_USE_ROSE){ $ucf66e=new \PDO( 'mysql:'. 'host='. $settings['db']['server'] .';'. 'dbname='. $settings['db']['name'], $settings['db']['user_name'], aee85($settings['db']['passw']) ); $a2af72=$ucf66e -> getAttribute(\PDO::ATTR_SERVER_VERSION); $w84bea=version_compare($a2af72,'5.5.3','>=')?'utf8mb4':'utf8'; $ucf66e -> exec('SET NAMES '.$w84bea); $ucf66e -> setAttribute(\PDO::ATTR_ERRMODE, \PDO::ERRMODE_EXCEPTION); $l44b61=pd372(); $u88131=new PdoStorage( $ucf66e, $_config['db_table_prefix'].SEARCH_EXTRA_PREFIX, array ( PdoStorage::TOC => $l44b61['TOC'], PdoStorage::WORD => $l44b61['WORD'], PdoStorage::FULLTEXT_INDEX => $l44b61['FULLTEXT_INDEX'], PdoStorage::KEYWORD_INDEX => $l44b61['KEYWORD_INDEX'], PdoStorage::KEYWORD_MULTIPLE_INDEX => $l44b61['KEYWORD_MULTIPLE_INDEX'], ) ); } return $u88131; } function m4c2d($j1cb25,$a4dd42){ foreach ($a4dd42 as $l2510c){ if ($l2510c=='-') continue; $l2510c=preg_quote($l2510c,'/'); $l2510c=str_replace('е','[её]',$l2510c); $l2510c=str_replace('Е','[ЕЁ]',$l2510c); $j1cb25=preg_replace('/(?<=^|\W)('.$l2510c.'[\w\p{M}]*)/iu','<mark>$1</mark>',$j1cb25); } $j1cb25=str_replace('</mark> <mark>',' ',$j1cb25); $j1cb25=str_replace('</mark> <mark>',' ',$j1cb25); return $j1cb25; } function d48d8($a341be){ $ue05fe=mb_strtoupper(mb_substr($a341be,0,1)); return $ue05fe.mb_substr($a341be,1); } function ga521(){ global$_config; a0738( "UPDATE `". $_config['db_table_prefix']."Notes` ". "SET `IsIndexed`=0", 'mark all notes for reindexing' ); } function e2_check_timeout(){ static $o90272; if(is_null($o90272)) { $af48ef=ini_get('max_execution_time'); if ($af48ef){ $o90272=time()+$af48ef-5; } else { $o90272=0; } } return ($o90272==0)?true:$o90272 >= time(); } function e2_write_dump_header($m8c7dd){ $x099fb=( 'SET SQL_MODE="NO_AUTO_VALUE_ON_ZERO";' .PHP_EOL. 'SET AUTOCOMMIT=0;' .PHP_EOL. 'START TRANSACTION;' .PHP_EOL. "/*!40101 SET @OLD_CHARACTER_SET_CLIENT=@@CHARACTER_SET_CLIENT */;" .PHP_EOL. "/*!40101 SET @OLD_CHARACTER_SET_RESULTS=@@CHARACTER_SET_RESULTS */;" .PHP_EOL. "/*!40101 SET @OLD_COLLATION_CONNECTION=@@COLLATION_CONNECTION */;" .PHP_EOL. "/*!40014 SET @OLD_UNIQUE_CHECKS=@@UNIQUE_CHECKS, UNIQUE_CHECKS=0 */;" .PHP_EOL. "/*!40014 SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0 */;" .PHP_EOL. "/*!40101 SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE=NO_AUTO_VALUE_ON_ZERO */;" .PHP_EOL. "/*!40101 SET NAMES utf8 */;" .PHP_EOL. "/*!50503 SET NAMES utf8mb4 */;" .PHP_EOL. '' ); fwrite($m8c7dd,$x099fb); return true; } function e2_write_dump_footer($m8c7dd){ $f251d1='COMMIT;' .PHP_EOL; $f251d1 .= "/*!40101 SET SQL_MODE=@OLD_SQL_MODE */;" .PHP_EOL ."/*!40014 SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS */;" .PHP_EOL ."/*!40014 SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS */;" .PHP_EOL ."/*!40101 SET CHARACTER_SET_RESULTS=@OLD_CHARACTER_SET_RESULTS */;".PHP_EOL ."/*!40101 SET COLLATION_CONNECTION=@OLD_COLLATION_CONNECTION */;" .PHP_EOL ."/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;" .PHP_EOL; fwrite($m8c7dd,$f251d1); return true; } function e2_get_table_definition($w0c1d0,$paab9e){ $p5c286=null; $result=mysqli_query($w0c1d0,"SHOW CREATE TABLE `{$paab9e}`"); if($result){ $e47c80=mysqli_fetch_array($result); $p5c286=$e47c80['Create Table']; } return $p5c286; } function e2_write_table_definition($m8c7dd,$w0c1d0,$paab9e){ $i30618=e2_get_table_definition($w0c1d0,$paab9e); if(e2_check_timeout() && $i30618){ fwrite($m8c7dd,$i30618); fwrite($m8c7dd,';'); fwrite($m8c7dd,PHP_EOL.PHP_EOL); return true; } return false; } function e2_get_table_data($w0c1d0,$paab9e,$k7a86c,$taa9f7){ $f1b1cc="SELECT * FROM `{$paab9e}` LIMIT {$k7a86c}, {$taa9f7}"; $result=mysqli_query($w0c1d0,$f1b1cc); if (!$result){ return false; } $z66e9c=''; $g3c41a="INSERT INTO `{$paab9e}` VALUES"; while ($ef1965=mysqli_fetch_assoc($result)) { $y691d5=array(); foreach($ef1965 as $b2063c){ $y691d5[] = is_null($b2063c)?"NULL":"'".mysqli_real_escape_string($w0c1d0,$b2063c)."'"; } $z66e9c.=$g3c41a.'('.join(', ',$y691d5).');'.PHP_EOL; } return $z66e9c; } function e2_table_disable_keys($paab9e){ return "ALTER TABLE `{$paab9e}` DISABLE KEYS;".PHP_EOL; } function e2_table_enable_keys($paab9e){ return "ALTER TABLE `{$paab9e}` ENABLE KEYS;".PHP_EOL; } function e2_get_total_records($w0c1d0,$paab9e){ $c8ce4b=mysqli_fetch_row(mysqli_query($w0c1d0,"SELECT COUNT(*) FROM `{$paab9e}`")); return $c8ce4b[0]; } function e2_write_table_data($m8c7dd,$w0c1d0,$paab9e){ $hfbb44=e2_get_total_records($w0c1d0,$paab9e); $k7a86c=0; $taa9f7=1000; $result=true; $j47495=20000; $i80fc1=30; if ($hfbb44){ $hfbda5=e2_table_disable_keys($paab9e); fwrite($m8c7dd,$hfbda5); } $z66e9c="INSERT INTO `{$paab9e}` VALUES"; $ode57a=$hfbb44; while ($ode57a > 0){ $f1b1cc="SELECT * FROM `{$paab9e}` LIMIT {$k7a86c}, {$taa9f7}"; $result=mysqli_query($w0c1d0,$f1b1cc); $lb428d=mysqli_num_rows($result); if (!$result || !e2_check_timeout()) { $result=false; break; } $ddf347=array(); $f4b3a6=0; $bb6539=0; while ($ef1965=mysqli_fetch_assoc($result)) { if (!e2_check_timeout()) { $result=false; break; } $lb428d--; $r54ca8=array(); foreach($ef1965 as $b2063c){ $r54ca8[] = is_null($b2063c)?"NULL":"'".mysqli_real_escape_string($w0c1d0,$b2063c)."'"; } $o8d777='('.join(', ',$r54ca8).')'; $f4b3a6+=strlen($o8d777); $ddf347[] = $o8d777; $bb6539++; if ( ($f4b3a6 >= $j47495) || ($bb6539 >= $i80fc1) || ($lb428d==0)) { $f1b1cc=$z66e9c.join(', ',$ddf347).';'; fwrite($m8c7dd,$f1b1cc); fwrite($m8c7dd,PHP_EOL); $f4b3a6=0; $bb6539=0; $ddf347=array(); } } $k7a86c+=$taa9f7; $ode57a -= $taa9f7; } if ($hfbb44){ $m6bfc4=e2_table_enable_keys($paab9e); fwrite($m8c7dd,$m6bfc4); } return$result; } function e2_backup($w0c1d0,$m9ab2e,$pa9745,$u93da6=array()) { $u2beda=tmpfile(); e2_write_dump_header($u2beda); if(Log::$ned2b5)__log('Backup: wrote header'); $h75101=true; foreach($m9ab2e as $paab9e){ if(Log::$ned2b5)__log('Backup: table '. $paab9e); $e91e7e=e2_write_table_definition($u2beda,$w0c1d0,$paab9e); if(Log::$ned2b5)__log('Backup: wrote table definition with result '. (int)$e91e7e); $v35285=e2_write_table_data($u2beda,$w0c1d0,$paab9e); if(Log::$ned2b5)__log('Backup: wrote table data with result '. (int)$v35285); $h75101=$e91e7e && $v35285; if ($h75101===false){ break; } } if(Log::$ned2b5)__log('Backup: wrote data with running == '. (int)$h75101); if ($h75101){ e2_write_dump_footer($u2beda); fseek($u2beda,0); $m8c7dd=fopen($pa9745,'w+'); while ($h75101 && ($o8d777=fread($u2beda,1024))) { if(e2_check_timeout()) { fwrite($m8c7dd,$o8d777); } else { $h75101=false; } } fclose($m8c7dd); } fclose($u2beda); return $h75101; } function g3e5c($v0c426,$content){ $q52766=MTMPL_FOLDER.$v0c426 .'.mtmpl.php'; if(is_file($q52766)) { ob_start(); include $q52766; $jde7a3=ob_get_contents(); ob_end_clean(); return trim($jde7a3); } } function oaed2(){ global$_config,$_superconfig; $i9e35a=$_config['mail_from']; if (@$_superconfig['mail_from']) { $i9e35a=$_superconfig['mail_from']; } if ($i9e35a[strlen($i9e35a)-1]=='@'){ $i9e35a.=$_SERVER['HTTP_HOST']; } return $i9e35a; } function xa41b($e01b6e,$subject,$z78e73,$r145a2=''){ global$_superconfig; if (@$_superconfig['mail_debug']) { $c8fa14=tempnam('mail-debug',''); $j1cb25=( 'To:       '.$e01b6e ."\n". 'Subject:  '.$subject ."\n". $r145a2 ."\n". "--------------------------------------------------\n". $z78e73 ); s6e52($c8fa14,$j1cb25); chmod($c8fa14,E2_NEW_FILES_RIGHTS); rename($c8fa14,$c8fa14.'.txt'); } $subject='=?UTF-8?B?'. base64_encode($subject) .'?='; $r145a2.="\r\nContent-Type: text/plain; charset=utf-8"; mail($e01b6e,$subject,$z78e73,trim($r145a2)); } function _A($j1cb25){ global$_candy,$_protocol,$z57de2,$da57c1,$_current_url; if ( preg_match('/\<a href\=\"(.*?)\"[^>]*\>(.*?)\<\/a\>/si',$j1cb25,$o9c28d) and ( $o9c28d[1]=='' or $o9c28d[1]==$_current_url or $_protocol .'://'. $z57de2.$o9c28d[1]==$_current_url or $_protocol .'://'. $z57de2.$da57c1 .'/'. $o9c28d[1]==$_current_url or $_candy=='e2m_install' ) ) { return $o9c28d[2]; } else { return $j1cb25; } } function _AT($qe8fab){ global$_candy,$z57de2,$da57c1,$_current_url; return ( $qe8fab=='' or $qe8fab==$_current_url or $_protocol .'://'. $z57de2.$qe8fab==$_current_url or $_protocol .'://'. $z57de2.$da57c1 .'/'. $qe8fab==$_current_url ); } function _IMGSRC($n435ed){ return g1492($n435ed); } function _SVG($n435ed){ return hf42c($n435ed); } function _COLOR($mf97c5,$hb8a9f,$hcc321,$i4efa2=1){ if(strlen($mf97c5)!=3 and strlen($mf97c5)!=6) return 'f0f'; if(strlen($hb8a9f)!=3 and strlen($hb8a9f)!=6) return 'f0f'; if(strlen($mf97c5)==3)$mf97c5=$mf97c5{0}.$mf97c5{0}.$mf97c5{1}.$mf97c5{1}.$mf97c5{2}.$mf97c5{2}; if(strlen($hb8a9f)==3)$hb8a9f=$hb8a9f{0}.$hb8a9f{0}.$hb8a9f{1}.$hb8a9f{1}.$hb8a9f{2}.$hb8a9f{2}; $cf09cc=array ( $mf97c5{0}.$mf97c5{1}, $mf97c5{2}.$mf97c5{3}, $mf97c5{4}.$mf97c5{5}, $hb8a9f{0}.$hb8a9f{1}, $hb8a9f{2}.$hb8a9f{3}, $hb8a9f{4}.$hb8a9f{5}, ); foreach ($cf09cc as $c8ce4b => $i9e366){ $cf09cc[$c8ce4b]=hexdec($i9e366); } $n22af6=array ( $cf09cc[0]+pow($hcc321,$i4efa2) * ($cf09cc[3]-$cf09cc[0]), $cf09cc[1]+pow($hcc321,$i4efa2) * ($cf09cc[4]-$cf09cc[1]), $cf09cc[2]+pow($hcc321,$i4efa2) * ($cf09cc[5]-$cf09cc[2]), ); $y70dda=''; foreach ($n22af6 as $c8ce4b => $i9e366){ $y70dda.=str_pad(dechex($i9e366),2,'0',STR_PAD_LEFT); } return $y70dda; } function _DT($q1ddcb,$ob35c6){ if (!$ob35c6) return ''; list ($o96b8c,$wb2c6c)=$ob35c6; $f2cb9d=$q1ddcb; $r7436f=e5a2f('m',$o96b8c,$wb2c6c); $f2cb9d=str_replace('{zone}',e2__escape_all(z9515($wb2c6c['offset'])), $f2cb9d); $f2cb9d=str_replace('{month}',e2__escape_all(e2l_get_string('um--month', array ('month' => $r7436f))), $f2cb9d); $f2cb9d=str_replace('{month-short}',e2__escape_all(e2l_get_string('um--month-short', array ('month' => $r7436f))), $f2cb9d); $f2cb9d=str_replace('{month-g}',e2__escape_all(e2l_get_string('um--month-g', array ('month' => $r7436f))), $f2cb9d); $f2cb9d=e5a2f($f2cb9d,$o96b8c,$wb2c6c); return $f2cb9d; } function _AGO($ob35c6){ return s9093($ob35c6[0], array ('offset' => $ob35c6[1]['offset'],'is_dst' => $ob35c6[1]['is_dst']) ); } function _NUM($j1cb25){ return e2_decline_for_number($j1cb25); } function _FIRST($e437b9){ return ($e437b9['_']['_ord']==0); } function _LAST($e437b9){ return ($e437b9['_']['_ord']==$e437b9['_']['_ord_max']); } function _CSS($xc7a62){ return ed4c1($xc7a62); } function _CSS_HREF($xc7a62){ return h576f($xc7a62); } function _JS($s32981){ return id00a($s32981); } function _LIB($ue8acc){ return l16f0($ue8acc); } function _T($h52678){ return n166b($h52678); } function _T_DEFER($eb0689){ return lab71($eb0689); } function _X($h52678){ return f6a97($h52678); } function _T_FOR($h52678,$id5566=null){ global$content; if ($id5566===null)$id5566=$h52678; if(array_key_exists($id5566,$content)) { n166b($h52678); } } function _GUIDES($yeca07=false){ global$_olba_guides; if(is_array($yeca07))$_olba_guides=$yeca07; if (!is_array($_olba_guides)) return; $u88408='<div style="position: fixed; width: 100%; height: 100%; z-index: -100">'; $d1d623=0; $k07d43=$_olba_guides; $k07d43[] = 100; foreach ($k07d43 as $d865c0 => $vd89e2){ if ($vd89e2==100) break; $d1d623+=$vd89e2; $u88408.='<div style="position: fixed; left: '. $vd89e2 .'%; width: 0; height: 100%; border-left: 1px #000 dotted; opacity: .2; -webkit-opacity: .2; -moz-opacity: .2"></div>'; $fa1b01='position: absolute; padding: 2px 3px; top: 0; font-size: 9px; background: #ccc; color: #000; font-family: "Verdana", sans-serif; opacity: .8; -webkit-opacity: .8; -moz-opacity: .8'; if ($k07d43[$d865c0+1]-$k07d43[$d865c0] < 4){ $u88408.='<div style="'. $fa1b01.'; right: '. (100-$vd89e2) .'%; border-bottom-left-radius: .5em; -webkit-border-bottom-left-radius: .5em; -moz-border-bottom-left-radius: .5em;">'. $vd89e2 .'%</div>'; } else { $u88408.='<div style="'. $fa1b01.'; left: '. $vd89e2 .'%; border-bottom-right-radius: .5em; -webkit-border-bottom-right-radius: .5em; -moz-border-bottom-right-radius: .5em;">'. $vd89e2 .'%</div>'; } } $u88408.='</div>'; $_olba_current_col=0; return $u88408; } function _S($bb45cf){ global$_strings; return$_strings[$bb45cf]; } function _SHORTCUT($eb0689){ return wbb8d($eb0689); } function e2__escape_all($bb45cf){ $f2cb9d=''; for ($d865c0=0; $d865c0 < mb_strlen($bb45cf); ++ $d865c0){ $f2cb9d.='\\'. mb_substr($bb45cf,$d865c0,1); } return $f2cb9d; } abstract class E2GIP { protected $gip_cookie_name='gip'; protected $gip_token_cookie_name='gip_access_token'; protected $gip_token=null; abstract public function get_auth_url(); abstract public static function get_profile_url($ub80bb); abstract public function callback(); public static function set_session_data($v3c6e0,$b2063c){ if(session_status()==PHP_SESSION_NONE){ session_start(); } $_SESSION[$v3c6e0]=$b2063c; } public static function get_session_data($v3c6e0,$he2181=false){ if(session_status()==PHP_SESSION_NONE){ session_start(); } if(!isset($_SESSION[$v3c6e0])) { return null; } $b2063c=$_SESSION[$v3c6e0]; if($he2181){ unset($_SESSION[$v3c6e0]); } return $b2063c; } public function get_config($v3c6e0){ $dcbb14='gips/'. $this->type .'.json'; if(is_file(USER_FOLDER.$dcbb14)) { $d466de=@file_get_contents(USER_FOLDER.$dcbb14); } else { $d466de=@file_get_contents(SYSTEM_FOLDER.$dcbb14); } if ($d466de!==false){ $f2cb9d=json_decode($d466de,true,512,JSON_BIGINT_AS_STRING)[$v3c6e0]; if ($f2cb9d) return $f2cb9d; } return null; } public function get_callback_url(){ return i83c8('e2m_gip_sign_in_callback', array('provider' => $this->type)); } protected function get_proxy_param(){ global$settings; return '?language='.$settings['language'].'&type='.$this->type.'&callback_url='.urlencode($this->get_callback_url()); } public function get_gip_session_data(){ global$_config; $t94a08=$this->gip_token?$this->gip_token:$_COOKIE[p8c3b($this->gip_token_cookie_name)]; a0738( "SELECT * FROM `". $_config['db_table_prefix']."GIPsSessions` ". "WHERE `GIP` = '". $this->type ."' ". "AND `SessionToken` = '".c7928($t94a08)."' ". "ORDER BY `ID` DESC LIMIT 1", 'get GIP session data' ); $result=z0d6b(); return$result?$result[0] : array(); } public function is_logged_in(){ if(empty($_COOKIE[p8c3b($this->gip_cookie_name)]) || !in_array($_COOKIE[p8c3b($this->gip_cookie_name)], e2_list_gips()) || $_COOKIE[p8c3b($this->gip_cookie_name)] != $this->type || empty($_COOKIE[p8c3b($this->gip_token_cookie_name)])) { return false; } $o8d777=$this->get_gip_session_data(); return (bool)$o8d777; } protected function save_session($ub80bb,$eb0689,$accessToken,$bb974d='',$userEmail='',$userLink=''){ $o96b8c=time(); x9943( 'GIPsSessions', array ( 'GIP' => $this->type, 'GIPAuthorID' => $ub80bb, 'AuthorName' => $eb0689, 'AuthorEmail' => $userEmail, 'AuthorProfileLink' => $userLink, 'SessionToken' => $accessToken, 'Stamp' => $o96b8c, ), 'INSERT', 'ON DUPLICATE KEY UPDATE '. '`SessionToken` = "'.c7928($accessToken).'", '. '`AuthorName` = "'.c7928($eb0689).'", '. '`Stamp` = "'.$o96b8c.'"' ); ec64a($this->gip_cookie_name,$this->type); ec64a($this->gip_token_cookie_name,$accessToken); if(isset($userEmail) && !empty($userEmail))ec64a('commenter_email',$userEmail); $this->gip_token=$accessToken; } public static function get_logout_key(){ if ($d4a73c=self::get_session_data('logout_key')) { return $d4a73c; } $d4a73c=md5(microtime()); self::set_session_data('logout_key',$d4a73c); return $d4a73c; } public static function is_valid_logout_key($v3c6e0){ $web1de=self::get_session_data('logout_key',true); if (empty($web1de) || empty($v3c6e0) || $web1de!=$v3c6e0){ return false; } return true; } public function logout(){ global$_config; ec64a($this->gip_cookie_name); ec64a($this->gip_token_cookie_name); a0738( "DELETE FROM `". $_config['db_table_prefix']."GIPsSessions` ". "WHERE `GIP` = '".$this->type."' ". "AND `SessionToken` = '" . c7928($_COOKIE[p8c3b($this->gip_token_cookie_name)]) . "'", 'logout' ); } public function get_avatar_width(){ return USERPIC_WIDTH; } public function get_avatar_height(){ return USERPIC_HEIGHT; } public function save_avatar($ub80bb,$s3d02b){ global$_config; @naf42(MEDIA_ROOT_FOLDER.AVATARS_FOLDER); @chmod(MEDIA_ROOT_FOLDER.AVATARS_FOLDER,$_config['uploaded_files_mode']); $n435ed=MEDIA_ROOT_FOLDER.AVATARS_FOLDER.$this->type .'-'. $ub80bb .'.jpg'; if ($s5b860=file_get_contents($s3d02b)) { file_put_contents($n435ed,$s5b860); } return $n435ed; } } function e2m_gip_sign_in($o8d777){ global$_config,$settings; $type=$o8d777['provider']; $z7123a=e2_get_gip_instance($type); if (!$z7123a){ x4930(); die; } header('Location: '.$z7123a->get_auth_url()); die; } function e2m_gip_sign_in_callback($o8d777){ global$_config; $type=$o8d777['provider']; $z7123a=e2_get_gip_instance($type); if (!$z7123a){ die($type.' is not defined'); } $r73797=$z7123a->callback(); echo '<script>'; if ($r73797===true){ $xa64f4=$z7123a->get_gip_session_data(); $d78506=[ 'name' => $xa64f4['AuthorName'], 'gipIcon' => _SVG($type), 'logoutUrl' => i83c8('e2m_gip_sign_out', array('provider' => E2GIP::get_logout_key())), ]; echo 'window.opener.oauthAuthorized('.json_encode($d78506).');'; } else { echo 'alert (\''. $r73797. '\');'; } echo 'window.close();</script>'; die; } function e2m_gip_sign_out($o8d777){ global$_config; $d4a73c=$o8d777['provider']; if (!E2GIP::is_valid_logout_key($d4a73c)) { die('invalid logout key'); } $z7123a=e2_get_logged_gip(); if($z7123a){ $z7123a->logout(); } x4930(); die; } function e2_list_gips(){ static $f2d168=null; if(!is_null($f2d168)) { return $f2d168; } $o1c05f=SYSTEM_FOLDER. 'gips/'; $e700f6=opendir($o1c05f); $f2d168=[]; while (($m8c7dd=readdir($e700f6)) !== false){ if(pathinfo($m8c7dd,PATHINFO_EXTENSION)!='php') continue; $f2d168[] = pathinfo($m8c7dd,PATHINFO_FILENAME); } closedir($e700f6); return $f2d168; } function e2_get_gip_class_name($type){ return "E2GIP".ucfirst($type); } function e2_get_gip_instance($type){ if (!in_array($type,e2_list_gips())) { return false; } $c38c9b=e2_get_gip_class_name($type); $z7123a=new $c38c9b; return $z7123a; } function e2_get_gip_auth_url($type){ return i83c8('e2m_gip_sign_in', array('provider' => $type)); } function e2_is_logged_in($type=''){ $id14a8=!$type?e2_list_gips() : array($type); foreach($id14a8 as$type){ $z7123a=e2_get_gip_instance($type); if ($z7123a && $z7123a->is_logged_in()) { return true; } } return false; } function e2_get_logged_gip(){ foreach(e2_list_gips() as$type){ $z7123a=e2_get_gip_instance($type); if ($z7123a && $z7123a->is_logged_in()) { return $z7123a; } } return false; } function e2_get_logged_gip_name(){ foreach(e2_list_gips() as$type){ $z7123a=e2_get_gip_instance($type); if ($z7123a && $z7123a->is_logged_in()) { return$type; } } return false; } function e2_get_user_profile_url($type,$z2a304){ $c38c9b=e2_get_gip_class_name($type); return $c38c9b::get_profile_url($z2a304); } function e2_get_gip_session($type){ $z7123a=e2_get_gip_instance($type); if (!$z7123a || !$z7123a->is_logged_in()) { return false; } return $z7123a->get_gip_session_data(); } foreach(e2_list_gips() as $a48e15){ require_once 'system/gips/'.$a48e15.'.php'; } define('__DEV', (@$_config['dev_verbose'] > (int) !ge852())); $_stopwatch=f7f78($_stopwatch); d372b(); m74e0(); $_strings=lfc91(); if(!BUILT) @include 'builder.php'; function e2(){ global$settings,$content, $_candy, $_config, $_strings, $_candies_installer, $_candies_public, $_candies_ajax, $_candies_to_disallow_in_read_only, $_template, $_diagnose; dabdd(); set_error_handler('ge1c4'); set_exception_handler('oaefe'); spl_autoload_register('r713e'); header('X-Powered-By: E2 Aegea v'. E2_VERSION); header('Content-type: text/html; charset=UTF-8'); try { list ($fc48ba,$parameters)=mb7e9(); $content=[]; $_candy=$fc48ba; if ( @$_config['dev_slow_ajax'] and ( in_array($fc48ba,$_candies_ajax) ) ) { sleep(1+2 * (rand()/getrandmax())); } if (!in_array($fc48ba,$_candies_installer)) { e2_make_sure_that_installed(); } if (@$_config['read_only'] and in_array($fc48ba,$_candies_to_disallow_in_read_only)) { $fc48ba='e2m_error404'; } $i58387=(bool)ge852(); $p0b448=!in_array($fc48ba,$_candies_public); if(Log::$ned2b5)__log('User signed in? '. ($i58387? 'Yes':'No')); $_newsfeeds=[]; a3010('rss',o6f51(),i83c8('e2m_rss')); a3010('json',o6f51(),i83c8('e2m_json')); if(E2_EDITION){ b2f04(); } if(substr($fc48ba,0,4)=='e2m_'){ zdb82(); } if(is_callable($fc48ba)) { if ($p0b448 && !$i58387){ if(substr($fc48ba,0,4)=='e2s_'){ $content=call_user_func('e2s_sign_in_necessary'); } else { $content['title']=$_strings['pt--sign-in']; } } else { if(Log::$ned2b5)__log('Candy call {'); $content=call_user_func($fc48ba,$parameters); if(Log::$ned2b5)__log('}'); } } else { $p0b448=false; $content=e2_error404_mode(); } } catch (AeMySQLException $e){ if(substr($fc48ba,0,4)=='e2s_'){ b4aff($ae1671); } else { c12f6($ae1671); $parameters=array(); $content['unavailable?']=true; } } if (!is_array($content))$content=array(); if (!array_key_exists('class',$content)) { $content['class']=str_replace('_','-',str_replace('e2m_','',$fc48ba)); } if (!array_key_exists('notes',$content))$content['notes'] = array (); if (!array_key_exists('drafts',$content))$content['drafts'] = array (); if (!array_key_exists('comments',$content))$content['comments'] = array (); if (!array_key_exists('notes-list',$content))$content['notes-list'] = array (); if(e2_get_instance()!==null){ if(Log::$ned2b5)__log('Stuff for installed engine {'); $content['sign-in'] = [ 'done?' => $i58387, 'required?' => $p0b448, 'necessary?' => $p0b448 && !$i58387, 'href' => i83c8('e2m_sign_in'), 'prompt' => $_strings['gs--need-password'], ]; $content['hrefs'] = array ( 'everything' => i83c8('e2m_everything'), ); if (!array_key_exists('popular',$content)) $content['popular']=x7f52(); if (!array_key_exists('tags',$content)) $content['tags']=ue531($parameters); $content['blog']=u3020(); $content['form-search']=n5070($parameters); $content['form-login']=t126f(); $content['engine']=i29a1(); $content['template']['use-likely-light?']=$_template['use_likely_light']; if (!array_key_exists('summary',$content)) { $content['summary']=strip_tags($content['blog']['description']); } if (ge852()) { $content['admin']=z5e47(); $content['last-modifieds-by-id']='{}'; if (@$_COOKIE[p8c3b('local_copies')]) { $content['last-modifieds-by-id'] = ( ra2d8($_COOKIE[p8c3b('local_copies')]) ); } } if(Log::$ned2b5)__log('}'); } $content['title']=strip_tags(a6f10(htmlspecialchars($content['title'],ENT_NOQUOTES,HSC_ENC))); if (@$content['heading']) { $content['heading']=strip_tags(a6f10(htmlspecialchars($content['heading'],ENT_NOQUOTES,HSC_ENC))); } if (!@isset ($_diagnose['ok?'])) { if (@$_COOKIE[p8c3b('diagnose')] or @$_diagnose['need?']) { i8739(); } } if(count($content['notes']) > 0){ $content['notes']=e2_populate_read_counts_in_notes_ctree_($content['notes']); foreach($content['notes'] as $raad65){ r57ad($raad65['format-info']['links-required']); } } if(E2_EDITION){ if (!ge852()) { $content['embed']['pre-head-end']=$settings['embed']['google-analytics']; $content['embed']['pre-body-end']=$settings['embed']['yandex-metrika']; } } $content['message']=z0955(); $t78e62=ybc21(); $content['meta']=hc4da( $fc48ba, $content['notes'], $content['tag'], $content['blog'], $content['pages'] ); $content['stat']=i6442(); $t78e62=f326f($t78e62); $mfa6a9=false; if(e2_get_instance()!==null and k3b97()) { if(is_writable(USER_FOLDER.'indexing.psa')) { $mfa6a9=true; } else { $_diagnose['need?']=true; ec64a('diagnose','1'); } } echo $t78e62; if(e2_get_instance()!==null and $mfa6a9){ if(Log::$ned2b5)__log('Spawn BSI step'); rcc38(i83c8('e2s_bsi_step', array ())); } if (@$_config['dev_dump_ctree'])zce80($s6bf76); } ?>