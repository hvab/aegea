<?php $_stopwatch=microtime(); define('E2_VERSION',3783); define('E2_RELEASE','2.10b'); define('E2_EDITION',1); define('E2_UA_STRING','E2 (v'. E2_VERSION .'; Aegea)'); define('E2_MINIMUM_PHP','5.6'); define('E2_MINIMUM_MYSQL',4.1); define('BUILDER_OBFUSCATE',1); define('BUILDER_FLATTEN',1); define('E2_NEW_FILES_RIGHTS',0777); define('E2_JSON_STYLE',JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE); define('E2_RUN_ID',chr(rand(65,90))); define('HSC_ENC','UTF-8'); define('SECONDS_IN_A_MINUTE',60); define('SECONDS_IN_AN_HOUR',3600); define('SECONDS_IN_A_DAY',86400); define('SECONDS_IN_A_WEEK',604800); define('SECONDS_IN_A_MONTH',2592000); define('SECONDS_IN_A_YEAR',31536000); if(version_compare(PHP_VERSION,E2_MINIMUM_PHP) < 0){ die ('PHP version must be '. E2_MINIMUM_PHP .' or later, you are running '. PHP_VERSION); } if(!function_exists('getimagesize')) { die ('Function getimagesize is not defined, php_gd not installed?'); } if(!function_exists('mb_internal_encoding')) { die ('Function mb_internal_encoding is not defined, php_mbstring not installed?'); } error_reporting(E_ALL); setlocale(LC_CTYPE,'ru_RU.UTF'); mb_internal_encoding('UTF-8'); date_default_timezone_set('GMT'); if(version_compare(PHP_VERSION,'7.0') < 0){ error_reporting(E_ALL & ~E_STRICT); } if(is_file('superconfig.php')) { include 'superconfig.php'; } $_protocol=( !empty ($_SERVER['HTTPS']) && $_SERVER['HTTPS']!=='off' or $_SERVER['SERVER_PORT']==443 or isset ($_SERVER['HTTP_X_FORWARDED_PROTO']) && $_SERVER['HTTP_X_FORWARDED_PROTO']=='https' or isset ($_SERVER['HTTP_X_HTTPS']) && ($_SERVER['HTTP_X_HTTPS']) ) ? 'https':'http'; if(is_file('force-https')) { $_protocol='https'; } $c=substr( $_SERVER['PHP_SELF'],0,strpos($_SERVER['PHP_SELF'],'/index.php') ); list ($v, ) = explode(':',$_SERVER['HTTP_HOST']); $full_blog_url=$_protocol. '://'. $v.$c; $_user_folder_name=str_replace('/','--',$v.$c); if(substr($_user_folder_name,0,4)=='www.'){ $_user_folder_name=substr($_user_folder_name,4); } if(is_file('multiuser')) { if ( !empty ($_superconfig) and array_key_exists('rewrites',$_superconfig) and array_key_exists($_user_folder_name,$_superconfig['rewrites']) ) { $_user_folder_name=$_superconfig['rewrites'][$_user_folder_name]; } define('USER_FOLDER','users/'. $_user_folder_name .'/'); } else { define('USER_FOLDER','user/'); } if( !empty ($_superconfig) and array_key_exists('store_files_by_users',$_superconfig) and $_superconfig['store_files_by_users'] ) { define('MEDIA_ROOT_FOLDER',USER_FOLDER .'files/'); } else { define('MEDIA_ROOT_FOLDER',''); } if(in_array('mail',explode(',',ini_get('disable_functions')))) { define('MAIL_ENABLED',false); } else { define('MAIL_ENABLED',true); } define('EXTRAS_FOLDER',USER_FOLDER.'extras/'); define('BACKUP_FOLDER',USER_FOLDER.'backup/'); define('CACHES_FOLDER',USER_FOLDER.'caches/'); define('USER_LIBRARY_FOLDER',USER_FOLDER.'library/'); define('LOG_FOLDER',USER_FOLDER.'logs/'); define('LICENSE_FILE',USER_FOLDER.'license.psa'); define('PICTURES_FOLDER','pictures/'); define('THUMBNAILS_FOLDER','pictures/thumbs/'); define('AVATARS_FOLDER','pictures/avatars/'); define('VIDEO_FOLDER','video/'); define('AUDIO_FOLDER','audio/'); define('TEMPLATES_FOLDER','themes/'); define('SYSTEM_FOLDER','system/'); define('SCRIPTS_FOLDER','system/js/'); define('SYSTEM_LIBRARY_FOLDER','system/library/'); define('SYSTEM_TEMPLATE_FOLDER','system/theme/'); define('VIDEO_ICON_IMAGE','system/theme/images/video.svg'); define('VIDEO_ICON_WIDTH',180); define('VIDEO_ICON_HEIGHT',120); define('AUDIO_ICON_IMAGE','system/theme/images/audio.svg'); define('AUDIO_ICON_WIDTH',120); define('AUDIO_ICON_HEIGHT',120); define('LANGUAGES_FOLDER','system/languages/'); define('DEFAULTS_FOLDER','system/default/'); define('MTMPL_FOLDER','system/default/mail/'); define('DEFAULT_TEMPLATE','acute'); if(!is_file(DEFAULTS_FOLDER. 'config.php')) die ('System config missing'); include DEFAULTS_FOLDER.'config.php'; $_default_config=$_config; if(is_file(USER_FOLDER. 'config.php')) { include USER_FOLDER.'config.php'; $_config=array_merge($_default_config,$_config); } define('E2E_STRANGE_ERROR',10); define('E2E_USER_ERROR',20); define('E2E_PERMISSIONS_ERROR',30); define('E2E_MESSAGE',100); define('E2E_DIAGNOSTICS_MESSAGE',110); define('DEFAULT_ITEMS_PER_PAGE',10); define('MAX_ITEMS_PER_PAGE',100); define('FP_NO_ID_OR_NEW', -1); define('FP_INSERT_ERROR', -10); define('FP_UPDATE_ERROR', -11); define('FP_EMPTY_FIELD', -20); define('FP_TITLE_OR_TEXT_EMPTY', -21); define('FP_NOT_COMMENTABLE', -30); define('FP_COMMENT_DOUBLE_POST', -101); define('FP_COMMENT_TOO_LONG', -102); define('FP_COMMENT_SPAM_SUSPECT', -103); define('NOTE_COMMENTABLE_NOW', -1); define('NOTE_COMMENTABLE_NOW_CONDITIONALLY', -2); define('THUMB_WIDTH',180); define('THUMB_HEIGHT',120); define('THUMB_JPG_QUALITY',50); define('SCALED_IMAGE_JPG_QUALITY',80); define('USERPIC_WIDTH',80); define('USERPIC_HEIGHT',80); define('USERPIC_JPG_QUALITY',80); $_fp_error=false; if(strstr(__FILE__,'all.php')) { define('BUILT',0); } else { define('BUILT',1); } function c($b=''){ global$_protocol,$errors,$v,$c; @session_start(); $_SESSION['errors']=$errors; if(substr($b,0,strlen($_protocol)+3)!=$_protocol .'://'){ header('Location: '. $_protocol .'://'. $v.$c .'/'. $b); } else { header('Location: '. $b); } flush(); die; } function v(){ $y=$_SERVER['HTTP_REFERER']; c($y); } function b($n=''){ global $c; $m=str_replace('/','--',trim($c,'/')); if ($m!=='')$m.='-'; $f=substr_count($_SERVER['HTTP_HOST'],'.'); $d=$m . @str_repeat('_',$f).$n; return $d; } function y($n,$s='',$a=true){ $q=$a? (time()+3600*24*365) : (0); $l=$_SERVER['HTTP_HOST']; $z=substr_count($l,'.'); if ($z < 3)$l=str_repeat('.',3-$z).$l; $f=setcookie(b($n),$s,$q,'/'); } function n($k,$x,$e_=''){ if(trim($x)!=''){ $x=explode($k,$x); foreach ($x as $r => $t)$x[$r]=trim($t); foreach ($x as $r => $t) if ($t=='') unset ($x[$r]); $j=array_unique($x); if ('sort'==$e_)sort($j); return $j; } else return array (); } function m($x){ $h=array(); if(is_file(DEFAULTS_FOLDER.'romanize.txt')) { $h=file(DEFAULTS_FOLDER.'romanize.txt'); } $g=$w=''; foreach ($h as $r => $u){ if (!($r%2))$g.=rtrim($u) .' '; else $w.=rtrim($u) .' '; if ($r%2){ while (mb_strlen($w) < mb_strlen($g))$w.=' '; while (mb_strlen($w) > mb_strlen($g))$g.=' '; } } $i=''; $o=-1; for ($r=0; $r < mb_strlen($g); ++ $r){ $p=mb_substr($g,$r,1); if ($p!=' '){ $i.=$p; if ($o == -1)$o=$r; } elseif ($i){ $cv=trim(mb_substr($w,$o,mb_strpos($w,' ',$o+1)-$o)); $vv=array ($i,$cv); $bv[mb_strlen($i)][] = $vv; $i=''; $o=-1; } } $yv=array(); for ($r=count($bv); $r > 0; -- $r){ foreach ($bv[$r] as $vv)$yv[$vv[0]] = $vv[1]; } return strtr($x,$yv); } function f($nv,$mv,$fv=0){ if ($mv==0) return 0; $dv=round($nv/$mv*100,$fv); $sv=pow(10, -$fv); if ($nv > 0 and $dv==0)$dv=$sv; if ($nv < $mv and $dv==100)$dv=100-$sv; return $dv; } function d($av,$action,$qv){ if (!is_array($av))$av=array(); if($action=='add'){ $av=array_unique(array_merge($av,$qv)); } if($action=='remove'){ unset ($av[array_search($qv,$av)]); } if (!is_array($av))$av=array(); return $av; } function s($lv){ $parameters=$lv['parameters']; $zv=[ 'success' => false ]; try { $lv['flipping-function'] ($parameters); $kv=$parameters; $kv['value'] = !$parameters['value']; $zv=[ 'success' => true, 'data' => [ 'flag-now-on' => ($parameters['value']==1), 'new-href' => jv($lv['candy-name'],$kv), ] ]; } catch (AeMySQLException $e){ kv($e,'Could not set '. $lv['flag-name'] .' flag'); } if(array_key_exists('result',$_POST) and ($_POST['result']=='ajaxresult')) { $zv=json_encode($zv); die ($zv); } else { c(jv('e2m_tag',$parameters)); } } function a($x){ $xv=@$_SERVER['HTTP_USER_AGENT'] or $xv=''; $ev=strstr($xv,'iPhone') || strstr($xv,'iPad'); $rv=strstr($xv,'Macintosh'); if ($ev) return ''; if ($x=='submit'){ if ($rv){ return '&#x2303; &#x21a9;'; } else { return 'Ctrl + Enter'; } } if ($x=='livesave'){ if ($rv){ return '&#x2318; S'; } else { return 'Ctrl + S'; } } if ($x=='navigation'){ if ($rv){ return '&#x2325;'; } else { return 'Ctrl'; } } if ($x=='navigation-later'){ if ($rv){ return '&#x2325; &uarr;'; } else { return 'Ctrl + &uarr;'; } } if ($x=='navigation-earlier'){ if ($rv){ return '&#x2325; &darr;'; } else { return 'Ctrl + &darr;'; } } } function q($tv){ $tv=str_replace('<','&lt;',$tv); $tv=str_replace('>','&gt;',$tv); return $tv; } function l($tv){ $tv=str_replace('"','&quot;',$tv); return $tv; } function z($s,$jv){ return str_replace('.',',',round($s,$jv)); } function e2_stripslashes_array($hv){ return is_array($hv)?array_map('e2_stripslashes_array',$hv):stripslashes($hv); } function k(){ if(version_compare(PHP_VERSION,'7.4') >= 0) return; if(get_magic_quotes_runtime()) { set_magic_quotes_runtime(0); } if(get_magic_quotes_gpc()) { $_GET=e2_stripslashes_array($_GET); $_POST=e2_stripslashes_array($_POST); $_COOKIE=e2_stripslashes_array($_COOKIE); $_REQUEST=e2_stripslashes_array($_REQUEST); } } function x($gv){ return sprintf('%u',ip2long($gv)); } function e_($wv){ return long2ip(sprintf('%d',$wv)); } function e2_decline_for_number($tv,$wv=null){ $uv=$tv; if ($wv===null){ $wv=substr($tv,0,strpos($tv,' ')); $uv=substr($tv,strpos($tv,' ')+1); } $iv=strpos($uv,'('); $ov=strpos($uv,')'); if ($ov > $iv)$pv=substr($uv,$iv,$ov-$iv+1); $cb=explode(',',trim(@$pv,'()')); if(count($cb)==2)array_unshift($cb,''); $vb=array (2,0,1,1,1,2,2,2,2,2); if ($wv%100 > 10 and $wv%100 < 20)$bb=2; else $bb=$vb[$wv%10]; $yb=$cb[$bb]; $tv=str_replace($pv,$yb,$tv); if(strstr($tv,'(') and strstr($tv,')')) { return e2_decline_for_number($tv,$wv); } else { return $tv; } } function r($nb){ $mb=glob($nb,GLOB_NOSORT); if(is_array($mb)) { foreach ($mb as $fb){ @unlink($fb); } } } function t($db){ $mb=glob($db .'*',GLOB_NOSORT); if(is_array($mb)) { foreach ($mb as $fb){ if(basename($fb)!='.' and basename($fb)!='..'){ if(is_dir($fb)) { if (t($fb .'/')) { if (!rmdir($fb)) { return false; } } else { return false; } } else { @unlink($fb); } } } return true; } else { return false; } } function j($sb){ $sb=trim($sb,'/'); $sb=explode('/',$sb); $db=''; foreach ($sb as $ab){ $db=$db.$ab; if (!is_dir($db)) { if (@mkdir($db)) { @chmod($db,E2_NEW_FILES_RIGHTS); } else { return false; } } $db=$db.'/'; } return true; } function h($sb){ return preg_replace('/\/([^\/]+?)\/\.\./','',$sb); } function g($x){ $qb=get_html_translation_table(HTML_ENTITIES); $qb=array_flip($qb); return strtr($x,$qb); } function w($lb=NULL){ if(NULL==$lb)$lb=microtime(); list ($zb,$kb)=explode(' ',$lb); return ((float)$zb + (float)$kb); } if(E2_EDITION){ function u($xb=false){ global$_config,$v; static $eb=null; if(is_array($eb)) return $eb; $eb=@unserialize(file_get_contents(LICENSE_FILE)); $rb=time(); if(is_array($eb)) { if (@$eb['checked-stamp'] >= $rb-SECONDS_IN_A_DAY){ return $eb; } } if (!$xb) return false; $eb=file_get_contents($_config['license_url'].$v); if ($eb===false) return $eb; $eb=json_decode($eb,true); if ($eb===false) return $eb; list ($tb,$jb,$hb)=explode('.',$eb['until']); $gb=gmmktime(23,59,59,$jb,$tb,$hb); $gb -= ly(ay(),$rb); $eb['checked-stamp']=time(); $eb['until-stamp']=$gb; @n3(LICENSE_FILE,serialize($eb)); return $eb; } function i(){ if (!u()) { p3(jv('e2s_post_service', ['service' => 'verify']), true); } } } function o(){ global$settings; if (!isset ($settings))$settings=array(); $ib=array(); if(is_file(USER_FOLDER.'settings.json')) { $ib=json_decode(file_get_contents(USER_FOLDER.'settings.json'),true); $ob=13; } elseif(is_file(USER_FOLDER.'settings.psa')) { $ib=unserialize(file_get_contents(USER_FOLDER.'settings.psa')); } if (!is_array($ib))$ib=array(); $settings=array_merge($settings,$ib); if ( !array_key_exists('appearance',$settings) or !array_key_exists('notes_per_page',$settings['appearance']) or !is_numeric($settings['appearance']['notes_per_page']) or $settings['appearance']['notes_per_page'] < 1 ){ $settings['appearance']['notes_per_page']=DEFAULT_ITEMS_PER_PAGE; } if($settings['appearance']['notes_per_page'] > MAX_ITEMS_PER_PAGE){ $settings['appearance']['notes_per_page']=MAX_ITEMS_PER_PAGE; } if ( !array_key_exists('comments',$settings) or !array_key_exists('default_on', @$settings['comments']) ) { $settings['comments']['default_on']=false; } if (!array_key_exists('respond_to_dark_mode',$settings['appearance'])) { $settings['appearance']['respond_to_dark_mode']=true; } return true; } function e2m_settings(){ global$settings,$_template,$_strings,$_config; $pb=array(); $c3=DEFAULT_LANGUAGE; if(array_key_exists('language',$settings)) { $c3=$settings['language']; } foreach(glob(LANGUAGES_FOLDER. '*.php') as $fb){ $v3=substr(basename($fb),0,2); $b3=file_get_contents($fb); if(preg_match( '/^ *\/\/ *display_name *\= *(.*?) *$/ismu',$b3,$y3 )) { $n3=$y3[1]; } else { $n3=$v3; } $pb[$v3] = array ( 'selected?' => (bool) ($c3==$v3), 'display-name' => $n3, ); } $eb=$m3=false; if(E2_EDITION){ $eb=u(); $m3=true; } $f3=(string) @$eb['pay-href']; if ((string)$f3===''){ $f3='https://'. $_strings['e2--website-host'] .'/get/'; } $d['title']=$_strings['pt--settings']; $d['heading']=$_strings['pt--settings']; $d['form']='form-preferences'; $d['form-preferences'] = array ( 'blog-title-default' => htmlspecialchars($_strings['e2--default-blog-title'],ENT_COMPAT,HSC_ENC), 'blog-title' => htmlspecialchars(cd(),ENT_COMPAT,HSC_ENC), 'blog-subtitle' => htmlspecialchars(@$settings['blog_subtitle'],ENT_COMPAT,HSC_ENC), 'blog-meta-description' => htmlspecialchars(@$settings['meta_description'],ENT_COMPAT,HSC_ENC), 'blog-author-default' => htmlspecialchars($_strings['e2--default-blog-author'],ENT_COMPAT,HSC_ENC), 'blog-author' => htmlspecialchars(@$settings['author'],ENT_COMPAT,HSC_ENC), 'languages' => $pb, 'language' => $c3, 'form-action' => jv('e2s_settings_save'), 'userpic-href' => bd('square'), 'notes-per-page' => $settings['appearance']['notes_per_page'], 'emailing-possible?' => MAIL_ENABLED, 'email-notify?' => (bool) @$settings['notifications']['new_comments'], 'email' => htmlspecialchars(@$settings['author_email'],ENT_COMPAT,HSC_ENC), 'comments-default-on?' => (bool) @$settings['comments']['default_on'], 'comments-require-gip?' => (bool) @$settings['comments']['require_gip'], 'comments-fresh-only?' => (bool) @$settings['comments']['fresh_only'], 'show-view-counts?' => (bool)$settings['appearance']['show_view_counts'], 'show-sharing-buttons?' => (bool)$settings['appearance']['show_sharing_buttons'], 'includes-google-analytics?' => false, 'includes-yandex-metrika?' => false, 'template-name' => $_template['name'], 'templates' => ws(), 'respond-to-dark-mode?' => (bool) @$settings['appearance']['respond_to_dark_mode'], 'submit-text' => $_strings['fb--save-changes'], 'show-payment-info?' => $m3 and ($eb!==false), 'paid-period' => $eb['licensed?'] ? (time() <= $eb['until-stamp']) : false, 'paid-period-ended' => $eb['licensed?'] ? (time() > $eb['until-stamp']) : false, 'paid-until' => $eb['licensed?'] ? ([$eb['until-stamp'],ay()]) : false, 'pay-href' => $f3, 'space-usage' => j3(r3(),true), ); if(E2_EDITION){ $d['form-preferences']['includes-google-analytics?']=true; $d['form-preferences']['google-analytics'] = ( htmlspecialchars( @$settings['embed']['google-analytics'],ENT_COMPAT,HSC_ENC ) ); $d['form-preferences']['includes-yandex-metrika?']=true; $d['form-preferences']['yandex-metrika'] = ( htmlspecialchars( @$settings['embed']['yandex-metrika'],ENT_COMPAT,HSC_ENC ) ); } return $d; } function e2s_settings_save(){ global$settings,$_strings; if($_SERVER['REQUEST_METHOD']!='POST'){ c(jv('e2m_settings')); } $d3=$s3=''; if(array_key_exists('blog-title',$_POST)) { $d3=trim($_POST['blog-title']); } if(array_key_exists('blog-subtitle',$_POST)) { $s3=trim($_POST['blog-subtitle']); } if(array_key_exists('blog-meta-description',$_POST)) { $a3=trim($_POST['blog-meta-description']); } if(array_key_exists('blog-author',$_POST)) { $q3=trim($_POST['blog-author']); } if(array_key_exists('language',$_POST)) $l3=$_POST['language']; if(array_key_exists('email',$_POST)) $z3=trim($_POST['email']); $k3=(int)$_POST['notes-per-page']; $settings['blog_title']=$d3; $settings['blog_title']=cd(); $settings['author']=$q3; $settings['author_email']=$z3; $settings['notifications']['new_comments'] = isset ($_POST['email-notify']); if(array_key_exists('template',$_POST)) { $settings['template']=trim($_POST['template']); } $settings['comments']['default_on'] = isset ($_POST['comments-default-on']); $settings['comments']['require_gip'] = isset ($_POST['comments-require-gip']); $settings['appearance']['show_view_counts'] = isset ($_POST['show-view-counts']); if ( !array_key_exists('language',$settings) or $settings['language']!=$l3 ){ e2_drop_all_kinds_of_cache(); $settings['language']=$l3; } if ( $settings['blog_subtitle']!=$s3 or $settings['meta_description']!=$a3 or $settings['appearance']['notes_per_page']!=$k3 or $settings['appearance']['show_sharing_buttons'] != isset ($_POST['show-sharing-buttons']) or $settings['appearance']['respond_to_dark_mode'] != isset ($_POST['respond-to-dark-mode']) or $settings['comments']['fresh_only'] != isset ($_POST['comments-fresh-only']) ) { @unlink(CACHE_FILENAME_FRONTPAGE); @unlink(CACHE_FILENAME_FRONTPAGE_FEED); @unlink(CACHE_FILENAME_FRONTPAGE_AUTHOR); $settings['blog_subtitle']=$s3; $settings['meta_description']=$a3; $settings['appearance']['notes_per_page']=$k3; $settings['appearance']['show_sharing_buttons'] = isset ($_POST['show-sharing-buttons']); $settings['appearance']['respond_to_dark_mode'] = isset ($_POST['respond-to-dark-mode']); $settings['comments']['fresh_only'] = isset ($_POST['comments-fresh-only']); } if(E2_EDITION){ if(array_key_exists('google-analytics',$_POST)) { $settings['embed']['google-analytics']=trim($_POST['google-analytics']); } if(array_key_exists('yandex-metrika',$_POST)) { $settings['embed']['yandex-metrika']=trim($_POST['yandex-metrika']); } } r(CACHE_FILENAMES_NOTES_COMMENTS); if (!@n3(USER_FOLDER.'settings.json',json_encode($settings,E2_JSON_STYLE))) { mv($_strings['er--settings-not-saved'],E2E_PERMISSIONS_ERROR); c(jv('e2m_settings')); } c(jv('e2m_frontpage', array ('page' => 1))); } function e2m_underhood(){ global$_db; $d['title']=$_strings['pt--database']; $d['heading']=$_strings['pt--database']; $d['title']='Underhood'; $d['heading']='Underhood'; zn('check version'); $x3=$e3=0; foreach(glob(CACHES_FOLDER .'/*') as $fb){ $x3 ++; $e3+=stat($fb)['size']; } $r3=$t3=0; foreach(glob(LOG_FOLDER .'*') as $fb){ $r3 ++; $t3+=stat($fb)['size']; } $j3=da(); $h3=f($j3['indexed_count'],$j3['total_count']); $g3=false; if ($j3['time_spent']) { $g3=floor($j3['time_spent']); if ($g3 >= 60){ $g3=( floor($g3/60) .'min '. str_pad($g3 % 60,2,'0',STR_PAD_LEFT). 's' ); } elseif ($g3 > 0){ $g3.='s'; } else { $g3=false; } } $w3=array_keys(tn()); $d['form']='form-underhood'; $d['form-underhood'] = [ 'mysql-version' => $_db['version'], 'form-action-engine-rebuild' => BUILT? false:jv('e2s_post_service', ['service' => 'build']), 'cache-files-count' => $x3, 'cache-files-size' => $e3, 'form-action-cache-invalidate' => jv('e2s_post_service', ['service' => 'sync']), 'search-index-items-count' => $j3['indexed_count'], 'search-index-total-items-count' => $j3['total_count'], 'search-index-time-spent' => $g3, 'search-index-percentage' => $h3, 'form-action-search-index-continue' => qa()? jv('e2s_bsi_step'):false, 'form-action-search-index-rebuild' => jv('e2s_bsi_drop'), 'log-files-count' => $r3, 'log-files-size' => $t3, 'form-action-logs-enable' => jv('e2s_post_service', ['service' => 'log']), 'backup-last' => count($w3)? xy('D, M d, Y \a\t H:i:s',$w3[0]) : false, 'form-action-backup' => jv('e2s_dump'), 'form-action-database-migrate' => jv( 'e2s_post_service', ['service' => 'migrate'] ), 'form-action-license-verify' => jv( 'e2s_post_service', ['service' => 'verify'] ), ]; return $d; } function e2m_database(){ global$settings,$_strings,$_superconfig; if (@$_superconfig['disallow_db_config']) { return e2_error404_mode(); } $d['title']=$_strings['pt--database']; $d['heading']=$_strings['pt--database']; $d['form']='form-database'; $d['form-database'] = array ( 'form-action' => jv('e2s_database_save'), 'db-server' => htmlspecialchars(@$settings['db']['server']? $settings['db']['server']:'localhost'), 'db-user' => htmlspecialchars(@$settings['db']['user_name']? $settings['db']['user_name']:'root'), 'db-password' => htmlspecialchars(i2(@$settings['db']['passw'])), 'db-database' => htmlspecialchars(@$settings['db']['name']), 'submit-text' => $_strings['fb--connect-to-this-db'], ); return $d; } function e2s_database_save(){ global$settings,$_db,$_superconfig,$_strings,$_config; if($_SERVER['REQUEST_METHOD']!='POST'){ c(jv('e2m_database')); } if (@$_superconfig['disallow_db_config']) { return e2_error404_mode(); } $u3['server'] = @$_POST['db-server']; $u3['user_name'] = @$_POST['db-user']; $u3['passw'] = u2(@$_POST['db-password']); $u3['name'] = @$_POST['db-database']; $i3=false; try { zn('check database from HTTP post',$u3); $o3=e2_model_data_check($u3['name']); if (!$o3['occupied'] or !$o3['migrateable']) { mv($_strings['er--db-data-incomplete']); c(jv('e2m_database')); } qn(); $i3=true; } catch (AeMySQLCannotConnectException $e){ mv( $_strings['er--cannot-connect-to-db']. ':<br />'. mysqli_connect_error() .' ('. mysqli_connect_errno() .')' ); } catch (AeMySQLTooOldException $e){ mv(e2l_get_string('er--mysql-version-too-old', [ 'v1' => $_db['version'], 'v2' => E2_MINIMUM_MYSQL, ])); } catch (AeMySQLException $e){ mv($_strings['er--cannot-find-db'] .' '. $u3['name']); } if (!$i3){ c(jv('e2m_database')); } $settings['db']=$u3; if (!@n3(USER_FOLDER.'settings.json',json_encode($settings,E2_JSON_STYLE))) { mv($_strings['er--settings-not-saved'],E2E_PERMISSIONS_ERROR); c(jv('e2m_database')); } e2_drop_all_kinds_of_cache(); if (!$_config['retain_search_indexes_on_db_switch']) { $p3=ea(); try { $p3 -> erase(); } catch (\S2\Rose\Exception\RuntimeException $e){ if(Log::$cy)__log('Rose not available'); } aa(); } p3(jv('e2s_bsi_step')); c(jv('e2m_settings')); } function p(){ return class_exists('ZipArchive'); } function e2m_get_backup(){ if (p()) { $vy=new ZipArchive(); $by=BACKUP_FOLDER .'backup.zip'; if ($vy -> open($by,ZIPARCHIVE::CREATE)) { @ $vy -> addEmptyDir('backup'); @ $vy -> addFile(USER_FOLDER.'userpic@2x.jpg','backup/files/userpic@2x.jpg'); @ $vy -> addFile(USER_FOLDER.'userpic@2x.png','backup/files/userpic@2x.png'); $yy=BACKUP_FOLDER .'backup-tail.sql'; $ny=''; $my=-1; foreach(glob(BACKUP_FOLDER .'backup-*.sql') as $fy){ if ($fy===$yy) continue; $dy=stat($fy); if ($dy['ctime'] > $my)$ny=$fy; $my=$dy['ctime']; } $vy -> addFile($ny,'backup/'. basename($ny)); if(is_file($yy)) { @file_put_contents($yy,"COMMIT;\r\n\r\n",FILE_APPEND | LOCK_EX); @chmod($yy,E2_NEW_FILES_RIGHTS); } $vy -> addFile($yy,'backup/backup-tail.sql'); $vy -> close(); } if(is_file($by)) { header('Content-Type: application/zip'); header('Content-Disposition: attachment; filename="backup.zip"'); readfile($by); unlink($by); } else { die ('Cannot get backup'); } die; } else { die ('Cannot get backup'); } } if(substr(@$_SERVER['HTTP_ACCEPT_LANGUAGE'],0,2)=='ru'){ define('DEFAULT_LANGUAGE','ru'); } else { define('DEFAULT_LANGUAGE','en'); } function e2l_get_string($ay,$lv){ global$_strings; $name=$_strings[$ay]; if(preg_match_all('/\$\[(.+?)\]/u',$name,$y3,PREG_SET_ORDER)) { foreach ($y3 as $qy){ $n=$qy[1]; $ly=''; if(strstr($n,'.')) list ($n,$ly)=explode('.',$n,2); if(array_key_exists($n,$lv)) { if ($ly){ $name=str_replace($qy[0],e2l__format_value($ly,$lv[$n],$ay),$name); } else { $name=str_replace($qy[0],$lv[$n],$name); } } } } return$name; } function e2l__format_value($ly,$s,$ay){ list ($ly,$zy)=explode('.',$ly,2); $ky='e2lstr_'. $ly; if(function_exists($ky)) { return call_user_func($ky,$s,$zy,$ay); } else { return $s; } return $s; } function cv(){ global$_lang,$settings; if ( array_key_exists('language',$settings) and is_file($xy=LANGUAGES_FOLDER.$settings['language'] .'.php') ) { $_lang=$settings['language']; include $xy; } elseif(is_file($xy=LANGUAGES_FOLDER.DEFAULT_LANGUAGE .'.php')) { $_lang=DEFAULT_LANGUAGE; include $xy; } else { die ('Language file missing: '. $xy); } return e2l_load_strings(); } define('LOG_FILE',LOG_FOLDER.'main.log'); define('LOG_DEBUG_FILE',LOG_FOLDER.'debug.log'); class Log { public static $cy=false; public static $ey=false; } function vv(){ global$_config; if ( $_config['write_log'] and ($_config['write_log_create'] or is_file(LOG_FILE)) ) { Log::$cy=true; Log::$ey=true; } else { Log::$cy=false; Log::$ey=false; } if (!Log::$cy) return; @j(LOG_FOLDER); if($_config['write_log_reset']) { @file_put_contents(LOG_FILE,''); @chmod(LOG_FILE,E2_NEW_FILES_RIGHTS); } if (@$_config['write_log_limit'] and is_file(LOG_FILE)) { $ry=@stat(LOG_FILE); $ry=$ry['size']; if ($ry > $_config['write_log_limit']) { @rename(LOG_FILE,LOG_FILE .'.bak'); @chmod(LOG_FILE .'.bak',E2_NEW_FILES_RIGHTS); @file_put_contents(LOG_FILE,''); } } __log('────────────────────────────────────────────────────────────────────────────────'); } function bv($ty=false) { static $jy=false; if ($ty===false) return $jy; if ($ty==='') return $jy=false; $fb=str_replace( '$',gmdate('Y-m-d-\a\t-H-i-s'),$ty ); return $jy= $fb; } function __log($tv){ static $gy; global$_stopwatch; $wy=bv(); $uy=''; $iy=str_pad(round(w()-$_stopwatch,5),10,' ',STR_PAD_RIGHT); if ($tv[0]=='}'){ -- $gy; if ($gy < 0)$gy=0; } $oy=( E2_RUN_ID .' '. $uy .''. $iy .' '. str_repeat(' ',$gy*2). $tv."\n" ); if ($tv[strlen($tv)-1]=='{'){ ++ $gy; } $py=FILE_APPEND; if(Log::$ey){ @file_put_contents(LOG_FILE,$oy,$py); @chmod(LOG_FILE,E2_NEW_FILES_RIGHTS); } if ($wy!==false){ $fb=LOG_FOLDER.$wy .'.log'; @j(LOG_FOLDER); @file_put_contents($fb,$oy,$py); @chmod($wy,E2_NEW_FILES_RIGHTS); } if ($tv[0]=='#'){ @j(dirname(LOG_DEBUG_FILE). '/'); @file_put_contents(LOG_DEBUG_FILE,$oy,$py); @chmod(LOG_DEBUG_FILE,E2_NEW_FILES_RIGHTS); } } function yv($cn){ @n3( USER_FOLDER .'ctree.php', "<?php\r\n\r\n". var_export($cn,true). "\r\n\r\n?>php" ); } function nv(){ @j(LOG_FOLDER); @file_put_contents(LOG_FILE,''); @chmod(LOG_FILE,E2_NEW_FILES_RIGHTS); } function mv($vn,$type=E2E_STRANGE_ERROR){ global$errors,$settings, $_config, $_strings, $_diagnose; if (!isset ($errors))$errors=[]; $bn=(!k2()+1 <= (int)$_config['show_call_stack']); if ($vn){ if ($vn[0]!='<')$vn='<p>'.$vn .'</p>'; $yn=array ( 'description' => $vn, 'type' => $type, ); if($type==E2E_STRANGE_ERROR and $bn){ $yn['backtrace']=debug_backtrace(); } $errors[] = $yn; } if($type==E2E_PERMISSIONS_ERROR){ $_diagnose['need?']=true; y('diagnose','1'); } return true; } function fv(){ global$errors,$nn,$_strings,$_diagnose; $mn=y3(); if(count($mn)==0){ y('diagnose',''); unset($_COOKIE['diagnose']); $_diagnose['need?']=false; $_diagnose['ok?']=true; return true; } else { $fn_=''; $fn_.='<p>'. $_strings['gs--enable-write-permissions-for-the-following'] .'</p>'; $fn_.='<ul>'; foreach ($mn as $dn){ if ($dn=='.')$dn=''; $fn_.='<li><tt>./'. $dn .'</tt></li>'; if(Log::$cy)__log('Diagnostics: cannot write <'. $dn .'>'); } $fn_.='</ul>'; $yn=array ( 'title' => $_strings['et--fix-permissions-on-server'], 'description' => $fn_, 'type' => E2E_DIAGNOSTICS_MESSAGE, 'class' => 'serious', ); $errors[] = $yn; $_diagnose['ok?']=false; return false; } } function dv($an,$vn,$qn,$ln,$zn){ global$errors; if(0==error_reporting() or ($an & 8)) return; $qn=str_replace(__DIR__,'',$qn); mv($qn .', line '. $ln .'<br />Error '. $an .': '. $vn); $errors[count($errors)-1]['phpcode']=$an; } function sv($kn,$xn,$fy,$u){ if (!(error_reporting() & $kn)) return; throw new ErrorException($xn,0,$kn,$fy,$u); } function av(){ global$errors,$settings,$_config; if (!isset ($errors))$errors=[]; @session_start(); if(is_array(@$_SESSION['errors'])) { $e=array_merge(@$_SESSION['errors'],$errors); } else { $e=$errors; } $bn=(!k2()+1 <= (int)$_config['show_call_stack']); if (@$_config['store_backtrace'] and $bn and $e!=NULL){ @n3('backtrace.psa',serialize($e)); } else { @unlink('backtrace.psa'); } if (isset ($_SESSION['errors'])) unset($_SESSION['errors']); $d=array(); $en=false; if(count($e) > 0){ foreach($e as $r => $rn){ if ($rn['type']==E2E_STRANGE_ERROR){ $rn['class']='serious'; $en=true; if ($bn){ $rn['backtrace']=lv($rn['backtrace']); } } if ($rn['type']==E2E_MESSAGE){ $rn['class']='info'; } $e[$r]=$rn; } $d['each']=$e; if ( $en and @$_config['store_backtrace'] and $bn and is_file('debug.php') ) { $d['debug-link']='debug.php'; } } return $d; } function qv(){ $errors=av(); foreach($errors['each'] as $tn){ echo '<p>'. $tn['description'] .'</p>'; } die; } function lv($jn){ global $c; if (!is_array($jn)) return 'No backtrace info'; $jn=array_reverse($jn); $jn=array_splice($jn,0,count($jn)-1); $e='<p style="background: #fea; padding: .25em .5em; line-height: 1em; overflow: hidden">'; foreach ($jn as $r => $h){ $hn=@$h['args'] or $hn=array(); $gn=array(); foreach ($hn as $wn){ $gn[] = var_export($wn,true); } $fy=@$h['file']; $fy=str_replace($_SERVER['DOCUMENT_ROOT'],'',$fy); $u=(@$h['line']? (' #'. $h['line']) : '?'); $e.='<div style="margin: .25em 0 .5em '. $r*3 .'em">'; $e.='<span style="float: right; color: #666"> '. $fy.$u .'</span>'; $e.='<tt><b>'. @$h['function'] .' (</b>'; if(count($gn)) { $un=str_replace("array (\n)",'array ()',$gn); $un=implode(', ',$un); if(0){ $un=highlight_string('<?'. $un .'?'.'>',true); $un=substr($un,77, -28); } $un=str_replace('&nbsp;',' ',$un); $un=nl2br($un); $e.='<div style="margin: 0 0 0 1.12em">'. $un .'</div>'; } $e.='<b>)</b> &rarr;</tt></div>'; } $e.='</p>'; return$e; } class AeException extends \Exception {} class AeMySQLException extends AeException {} class AeMySQLNotFoundException extends AeMySQLException {} class AeMySQLTooOldException extends AeMySQLException {} class AeMySQLCannotConnectException extends AeMySQLException {} class AeMySQLAccessDeniedException extends AeMySQLCannotConnectException {} class AeMySQLQueryException extends AeMySQLException {} class AeMySQLCorruptedUpdateRecordCallException extends AeMySQLException {} class AeInstallException extends AeException {} class AeInstallAlreadyInstalledException extends AeInstallException {} class AeInstallDatabaseOccupiedException extends AeInstallException {} class AeNotSavedException extends AeException {} class AePasswordHashNotSavedException extends AeNotSavedException {} class AeSettingsNotSavedException extends AeNotSavedException {} class AeModelUnknownTableException extends AeException {} class AeOlbaException extends AeException {} class AeOlbaTemplateMissingException extends AeOlbaException {} class AeNotAndCannotBeInstalledException extends AeException {} class AeUpdateAlreadyInProcess extends AeException {} class AeUpdateCannotLock extends AeException {} function zv($in,$on=false){ $pn=substr(__DIR__,0,strrpos(__DIR__,'/')); $cm=''; $vm=[]; foreach(array_reverse($in -> getTrace()) as $bm){ $ym['where']=str_replace( $pn .'/','',$bm['file'] ) .':'. $bm['line']; $nm=[]; foreach ($bm['args'] as $mm){ $nm[] = htmlspecialchars( str_replace("\n","\n  ",var_export($mm,true)), ENT_NOQUOTES,HSC_ENC ); } $fm=''; if(count($nm)) { $fm=("\n". '  '. implode(",\n  ",$nm). "\n" ); } $ym['call']=$bm['function'] .' ('. $fm .')'; $vm[] = $ym; } do { if ((string)$in -> getMessage()!==''){ $cm.=$in -> getMessage() ."\n"; } $cm.="\n";; $cm .= ( get_class($in) .' in '. str_replace( $pn .'/','',$in -> getFile() ) .':'. $in -> getLine(). "\n" ); if ($in -> getCode()) { $cm.='Code: '. $in -> getCode() ."\n"; } $dm=''; $r=1; foreach ($vm as $u){ $dm.=$r++ .'. '. $u['where'] .' '. $u['call']. "\n"; if (!$on)$dm.="\n";; } $cm.="\n";; } while ($in=$in -> getPrevious()); if ($on){ $dm=preg_replace('/^.*?$/smu','│            $0',$dm); $cm.='┌─'. "\n"; $cm.=$dm; $cm.='└─'; } else { $cm.=$dm; } return $cm; } function kv($in,$xn=''){ global$_config; if(__DEV)mv('<pre>'. zv($in) .'</pre>'); if($_config['log_errors']) { Log::$cy=true; if(Log::$cy)bv('error-$'); } if(Log::$cy)__log('Exception caught: '. zv($in,true)); if(Log::$cy)bv(''); if ((string)$xn!==''){ if(Log::$cy)__log($xn); } } function xv($in){ global$_config,$content,$c; $content['title']=':-('; $content['exception-message']=$in -> getMessage(); if(__DEV)$content['exception-string']=zv($in); if($_config['log_errors']) { Log::$cy=true; if(Log::$cy)bv('error-$'); } if(Log::$cy)__log('Panic: '. zv($in,true)); $d=rs('panic',true); if(Log::$cy)__log(':-('); echo $d; die; } function ev($in){ xv($in); } $_url_map=array ( '@log' => 'e2://e2s_log', '@retrieve:url' => 'e2://e2s_retrieve', '@instantiate:version' => 'e2://e2s_instantiate', '@notify' => 'e2://e2s_notify', '@info' => 'e2://e2m_info', '' => 'e2://e2m_frontpage?page=1', ':page' => 'e2://e2m_frontpage', 'rss' => 'e2://e2m_rss', 'json' => 'e2://e2m_json', 'sitemap.xml' => 'e2://e2m_sitemap_xml', ':year' => 'e2://e2m_year', ':year/:month' => 'e2://e2m_month', ':year/:month/:day' => 'e2://e2m_day', 'all' => 'e2://e2m_everything', ':note' => 'e2://e2m_note?is_published=1&preview-key=0', ':note/:preview' => 'e2://e2m_note?is_published=1', ':note/edit' => 'e2://e2m_note_edit?is_published=1', ':note/favourite' => 'e2://e2m_note_flag_favourite?is_published=1&value=1', ':note/unfavourite' => 'e2://e2m_note_flag_favourite?is_published=1&value=0', ':note/show' => 'e2://e2m_note_flag?is_published=1&flag=IsVisible&value=1', ':note/hide' => 'e2://e2m_note_flag?is_published=1&flag=IsVisible&value=0', ':note/discuss' => 'e2://e2m_note_flag?is_published=1&flag=IsCommentable&value=1', ':note/quiet' => 'e2://e2m_note_flag?is_published=1&flag=IsCommentable&value=0', ':note/withdraw' => 'e2://e2m_note_withdraw?is_published=1', ':note/json' => 'e2://e2m_note_json', ':note/broadcast' => 'e2://e2m_note_broadcast', ':note/read' => 'e2://e2m_note_read', ':note/delete' => 'e2://e2m_note_delete?is_published=1', ':note/format/:formatter' => 'e2://e2m_note_use_formatter?is_published=1', ':note/:unsubscr' => 'e2://e2m_unsubscribe?is_published=1', ':note/:comnum' => 'e2://e2m_comment', ':note/:comnum/edit' => 'e2://e2m_comment_edit', ':note/:comnum/important' => 'e2://e2m_comment_flag_ajax?flag=IsFavourite&value=1', ':note/:comnum/usual' => 'e2://e2m_comment_flag_ajax?flag=IsFavourite&value=0', ':note/:comnum/replace' => 'e2://e2m_comment_flag_ajax?flag=IsVisible&value=1', ':note/:comnum/remove' => 'e2://e2m_comment_flag_ajax?flag=IsVisible&value=0', ':note/:comnum/spam' => 'e2://e2m_comment_flag?flag=IsSpamSuspect&value=1', ':note/:comnum/good' => 'e2://e2m_comment_flag?flag=IsSpamSuspect&value=0', ':note/:comnum/wipe' => 'e2://e2m_comment_delete', ':note/:comnum/reply/edit' => 'e2://e2m_comment_reply', ':note/:comnum/reply/important' => 'e2://e2m_comment_flag_ajax?flag=IsReplyFavourite&value=1', ':note/:comnum/reply/usual' => 'e2://e2m_comment_flag_ajax?flag=IsReplyFavourite&value=0', ':note/:comnum/reply/replace' => 'e2://e2m_comment_flag_ajax?flag=IsReplyVisible&value=1', ':note/:comnum/reply/remove' => 'e2://e2m_comment_flag_ajax?flag=IsReplyVisible&value=0', ':note/:comnum/reply/delete' => 'e2://e2m_comment_reply_delete', 'drafts' => 'e2://e2m_drafts?page=1', 'drafts-:page' => 'e2://e2m_drafts', 'drafts/:draft' => 'e2://e2m_note?is_published=0&preview-key=0', 'drafts/:draft/:preview' => 'e2://e2m_note?is_published=0', 'drafts/:draft/edit' => 'e2://e2m_note_edit?is_published=0', 'drafts/:draft/delete' => 'e2://e2m_note_delete?is_published=0', 'drafts/:draft/format/:formatter' => 'e2://e2m_note_use_formatter?is_published=0', 'sources' => 'e2://e2m_sources', 'sources/:source/trust' => 'e2://e2m_source_trust', 'sources/:source/premoderate' => 'e2://e2m_source_premoderate', 'sources/:source/ban' => 'e2://e2m_source_ban', 'sources/:source/forget' => 'e2://e2m_source_forget', 'tags' => 'e2://e2m_tags', 'tags/:tag' => 'e2://e2m_tag?page=1', 'tags/:tag/:page' => 'e2://e2m_tag', 'tags/:tag/rss' => 'e2://e2m_tag_rss', 'tags/:tag/json' => 'e2://e2m_tag_json', 'tags/:tag/edit' => 'e2://e2m_tag_edit', 'tags/:tag/delete' => 'e2://e2m_tag_delete', 'tags/:tag/pin' => 'e2://e2m_tag_flag_ajax?flag=IsFavourite&value=1', 'tags/:tag/unpin' => 'e2://e2m_tag_flag_ajax?flag=IsFavourite&value=0', 'hot' => 'e2://e2m_most_commented?page=1', 'hot/:page' => 'e2://e2m_most_commented', 'selected' => 'e2://e2m_favourites?page=1', 'selected/:page' => 'e2://e2m_favourites', 'popular' => 'e2://e2m_popular?page=1', 'popular/:page' => 'e2://e2m_popular', 'untagged' => 'e2://e2m_untagged?page=1', 'untagged/:page' => 'e2://e2m_untagged', 'found' => 'e2://e2m_found&query=', 'found/:query' => 'e2://e2m_found', 'new' => 'e2://e2m_write', 'install' => 'e2://e2m_install', 'settings' => 'e2://e2m_settings', 'settings/underhood' => 'e2://e2m_underhood', 'settings/underhood/build' => 'e2://e2s_post_service?service=build', 'settings/underhood/sync' => 'e2://e2s_post_service?service=sync', 'settings/underhood/log' => 'e2://e2s_post_service?service=log', 'settings/underhood/migrate' => 'e2://e2s_post_service?service=migrate', 'settings/underhood/verify' => 'e2://e2s_post_service?service=verify', 'settings/underhood/backup' => 'e2://e2s_dump', 'settings/underhood/index' => 'e2://e2s_bsi_step', 'settings/underhood/reindex' => 'e2://e2s_bsi_drop', 'settings/database' => 'e2://e2m_database', 'settings/password' => 'e2://e2m_password?recovery-key=', 'settings/password-reset' => 'e2://e2m_password_reset', 'settings/password/:reset' => 'e2://e2m_password', 'settings/timezone' => 'e2://e2m_timezone', 'settings/sessions' => 'e2://e2m_sessions', 'settings/theme-preview' => 'e2://e2m_theme_preview?theme=', 'settings/theme-preview/:theme' => 'e2://e2m_theme_preview', 'settings/get-backup' => 'e2://e2m_get_backup', 'sign-in' => 'e2://e2m_sign_in', 'sign-out' => 'e2://e2m_sign_out', 'sign-in/:provider' => 'e2://e2m_gip_sign_in', 'sign-out/:provider' => 'e2://e2m_gip_sign_out', 'sign-in-done/:provider' => 'e2://e2m_gip_sign_in_callback', '@ajax/::' => 'e2://e2j_::', '@actions/::' => 'e2://e2s_::', ); $_url_chunks=array ( '\:page' => 'page\-(?P<page>\d+)', '\:year' => '(?P<year>\d{4})', '\:month' => '(?P<month>\d{1,2})', '\:day' => '(?P<day>\d{1,2})', '\:note' => array ( 'all\/(?P<alias>[-a-zA-Z0-9]+)', '(?P<year>\d{4})\/(?P<month>\d{1,2})\/(?P<day>\d{1,2})\/(?P<day_number>\d+)', ), '\:draft' => array ( '(?P<oalias2>[-a-zA-Z0-9]+)\/(?P<draft2>\d+)', '(?P<oalias>[-a-zA-Z0-9]+)', '-\/(?P<draft>\d+)', ), '\:comnum' => 'comment\-(?P<comment_number>[0-9]+)', '\:file' => '(?P<file>.*?)', '\:tag' => '(?P<tag_alias>[-a-zA-Z0-9,]+)', '\:query' => '(?P<query>.*?)', '\:provider' => '(?P<provider>.*?)', '\:version' => '\:(?P<version>\d+)', '\:source' => '\:(?P<source>.*?)', '\:picture' => '\:(?P<picture>.*?)', '\:unsubscr' => 'unsubscribe\:(?P<unsubscribe_email>.+?)\:(?P<unsubscribe_key>[0-9a-f]{32})', '\:reset' => 'reset\:(?P<recovery_key>[0-9a-f]{40})', '\:formatter' => '(?P<formatter>.*?)', '\:alias' => '(?P<newalias>[-a-zA-Z0-9]+)', '\:preview' => 'preview\:(?P<preview_key>[0-9a-f]{32})', '\:theme' => '(?P<theme>[-a-zA-Z0-9]+)', '\:source' => '(?P<source>\d+)', '\:url' => '\:(?P<url>[a-zA-Z0-9\=\/\\\+\-\_\,]+)', ); $_url_autoredirects=array ( '/^favo(?:u?)rites(\~.+)?$/i' => 'selected\\1', '/^favo(?:u?)rites\/(.+)/i' => 'selected/\\1', '/^keywords$/i' => 'tags', '/^keywords\/(.*)/i' => 'tags/\\1', '/^everything$/i' => 'all', '/^search\/(.+)/i' => 'found/\\1', '/^(\d{4}\/\d{1,2}\/\d{1,2}\/\d+)\/comments(\/?)$/i' => '\\1', '/^\~(\d+)/i' => 'page-\\1', '/\/?\~(\d+)/i' => '/page-\\1', ); function rv($sm){ global$_url_autoredirects,$c; $sm=preg_replace(array_keys($_url_autoredirects),array_values($_url_autoredirects),$sm); if(preg_match('/^([0-9]+)[.-]([0-9]+)[.-]([0-9]+)(.*)/',$sm,$y3)) { if(2==strlen($y3[3]))$y3[3]='20'.$y3[3]; return ($y3[3].'/'.$y3[2].'/'.$y3[1].$y3[4]); } if(preg_match('/^tags\-rss\/(.*?)\/?$/',$sm,$y3)) { $am=substr($y3[1],strrpos($y3[1],'/')+1); return ('tags/'. $am.'/rss/'); } return $sm; } function tv(){ static $qm=false; global$__synthetic_urls,$_config,$_superconfig; if ($qm) return; $lm=$_config['url_composition']; if (!empty ($_superconfig) and array_key_exists('url_composition',$_superconfig)) { $lm=$_superconfig['url_composition']; } $__synthetic_urls=false; if ($lm=='synthetic'){ $__synthetic_urls=true; } if ($lm=='auto'){ if(function_exists('apache_get_modules')) { if(in_array('mod_rewrite',apache_get_modules())) { $__synthetic_urls=true; } } } $qm=true; } function jv($candy,$parameters=array ()) { global$_url_map,$_url_chunks,$_config,$__synthetic_urls,$_protocol,$v,$c; $zm=array_flip($_url_map); if ( @$_config['preferred_domain_name'] and $_SERVER['HTTP_HOST']!=$_config['preferred_domain_name'] ) { $v=$_config['preferred_domain_name']; } $sm=$_protocol .'://'. $v.$c .'/'; $km='e2://'. $candy; if(array_key_exists('page',$parameters)) { $page=$parameters['page']; } else { $page=1; } if($parameters){ $km.='?'; $xm=array(); $em=array(); foreach($parameters as $rm => $s){ if ($rm=='*note'){ $em[] = $rm; $xm[] = wv($s); } if ($rm=='*tags'){ $em[] = $rm; $xm[] = uv($s); } if ($rm=='*tag'){ $em[] = $rm; $xm[] = uv([$s]); } } foreach ($em as $rm) unset($parameters[$rm]); foreach ($xm as $tm){ $parameters=array_merge($parameters,$tm); } foreach($parameters as $rm => $s){ if (@$rm[0]!='_'){ $km.=$rm .'='. urlencode($s) .'&'; } } $km=substr($km,0, -1); } if(array_key_exists($km,$zm)) { if ($zm[$km]!=='')$sm.=$zm[$km] .'/'; return $sm; } else { $gm=false; foreach ($zm as $wm => $um){ $im=$wm; $im=preg_quote($im,'/'); $om=parse_url($wm); $pm=$om['host']; $cf=parse_url($km); if(strstr($wm,'::')) { $vf=$cf['scheme'] .'://'. $cf['host']; $im=str_replace('\:\:','(.*)',$im); $im='/^'. $im .'$/s'; if(preg_match($im,$vf,$y3)) { $sb=str_replace('::',$y3[1],$um); $sb=str_replace('_','-',$sb); $bf=$cf['query']; if($__synthetic_urls and $bf){ $sm.=$sb .'/?'. $bf; } elseif($__synthetic_urls){ $sm.=$sb .'/'; } elseif ($bf){ $sm.='?go='. $sb .'/?'. $bf; } else { $sm.='?go='. $sb .'/'; } return $sm; } } $yf=false; if($candy===$pm){ $gm=true; if ($om['query']) { $nf=explode('&',$om['query']); foreach ($nf as $mf){ list ($rm,$s)=explode('=',$mf); $s=urldecode($s); $rm=str_replace('_','-',$rm); if ( array_key_exists($rm,$parameters) and $parameters[$rm]!=$s ){ $yf=true; break; } } } if (!$yf){ if(preg_match_all('/\:[\-a-z]+/i',$um,$y3)) { foreach ($y3[0] as $ff){ $df=$_url_chunks['\\'. $ff]; if (!is_array($df)) { $df=array ($df); } $sf=$df[0]; foreach ($df as $sf){ $af='/\(\?P\<(.*?)\>.*?\)/'; $qf=true; if (@preg_match_all($af,$sf,$y3)) { $y3=$y3[1]; $qf=true; for ($r=0; $r < count($y3); ++ $r){ if ( !array_key_exists(str_replace("_","-",$y3[$r]), $parameters) or $parameters[str_replace("_","-",$y3[$r])] === '' ){ $qf=false; break; } } } if (!$qf) continue; $lf=@preg_replace_callback( $af, function ($y3) use ($parameters){ return$parameters[str_replace("_","-",$y3[1])]; }, $sf ); $lf=stripslashes($lf); $zf=str_replace($ff,$lf,$um); break; } $um=$zf; } } $kf=array(); if ($um){ if($__synthetic_urls){ $sm.=$um .'/'; } else { $kf[] = 'go='. $um .'/'; } } foreach($_GET as $t => $xf) if(in_array($t, array ('result','themeless'))) { $kf[] = $t . ($xf? ('='. urlencode($xf)) : ''); } if(count($kf)) { $sm.='?'. implode('&',$kf); } return $sm; } } } if ($gm){ return $sm; } else { die ('Cannot compose url for candy '. $candy); } } } function hv($sm=null){ global$_url_map,$_url_chunks,$_config,$_current_url,$__synthetic_urls,$_protocol,$v,$c; if ($sm===null) $sm=urldecode($_GET['go']); if(Log::$cy)__log('Resolve "'. $sm .'" {'); tv(); $ef=$sm; $sm=trim($sm,'/'); $sm=rv($sm); $parameters=array(); foreach($_url_map as $rf => $wm){ $tf=$rf; $tf=preg_quote($tf,'/'); if(strstr($rf,'::')) { $tf=str_replace('\:\:','(.*)',$tf); $tf='/^'. $tf .'$/s'; if(preg_match($tf,$sm,$y3)) { $jf=str_replace('-','_',$y3[1]); $km=str_replace('::',$jf,$wm); } } elseif(strstr($rf,':')) { $hf=array(); foreach($_url_chunks as $t => $xf){ if(is_array($xf)) { $hf[$t]='(?:(?:'. implode(')|(?:',$xf) .'))'; } else { $hf[$t]=$xf; } } $tf=str_replace( array_keys($hf), array_values($hf), $tf ); $tf='/^'. $tf .'$/s'; if(preg_match($tf,$sm,$y3)) { $km=$wm; foreach ($y3 as $rm => $s) if (!is_numeric($rm)) { $rm=str_replace('_','-',$rm); $parameters[$rm]=$s; } } } else { if ($rf==$sm){ $km=$wm; break; } } } $gf=(bool)$km; if (!$km)$km='e2://e2_error404_mode'; $cf=parse_url($km); $candy=$cf['host']; if ($cf['query']) { $nf=explode('&',$cf['query']); foreach ($nf as $mf){ list ($rm,$s)=explode('=',$mf); $s=urldecode($s); $rm=str_replace('_','-',$rm); $parameters[$rm]=$s; } } $d=false; $parameters=iv($parameters); if ($gf){ if($_config['force_canonical_urls']) { foreach (['draft2','oalias2'] as $wf){ if(array_key_exists($wf,$parameters)) { unset($parameters[$wf]); } } $uf=jv($candy,$parameters); list ($if_,$of)=explode('?',$_SERVER['REQUEST_URI'],2); $pf=$_protocol .'://'. $_SERVER['HTTP_HOST'].$if_; $c2=$_protocol .'://'. $_SERVER['HTTP_HOST'].urldecode($if_); $of=explode('&',$of); foreach ($of as $v2){ list ($b2, ) = explode('=',$v2); if ($b2=='go'){ $pf.='?'. $v2; $c2.='?'. urldecode($v2); } } $_current_url=$pf; if ( $pf!=$uf and $c2!=$uf and $pf!=$_protocol .'://'. $_SERVER['HTTP_HOST'].$c.'/@notify' ){ if(Log::$cy)__log('Used URL "'. $pf .'" or "'. $_2used_url .'"'); if(Log::$cy)__log('Redirecting to canonical URL "'. $uf .'"'); if(Log::$cy)__log('}'); c($uf); } } if(is_callable($candy)) { $d=array ($candy,$parameters); } else { $d=array (null, array ()); } } else { $d=array (null, array ()); } foreach($_GET as $rm => $s){ if ($rm!=='go')$d[1][$rm]=$s; } if(Log::$cy){ if(count($d[1]) > 0){ $y2=print_r($d[1],true); $y2=substr($y2,8, -2); $y2='    '. trim($y2); $y2=preg_replace('/^.*?$/smu','         $0',$y2); $y2=' with parameters:'."\r\n". $y2; } __log( 'Resolved to candy "'. $d[0] .'"'. $y2 ); } if(Log::$cy)__log('}'); return $d; } function wv($n2){ global $c,$_config; if (!isset ($n2['IsPublished'])) { return []; } if (!$n2['IsPublished']) { $parameters['is-published']=0; if ($n2['OriginalAlias']===''){ $parameters['draft']=$n2['ID']; } elseif (gm($n2['OriginalAlias']) == 1){ $parameters['oalias']=$n2['OriginalAlias']; } else { $parameters['draft2']=$n2['ID']; $parameters['oalias2']=$n2['OriginalAlias']; } return$parameters; } $parameters['is-published']=1; $m2=gn(); $f2='n'. $n2['ID']; $d2=$m2[$f2]; if (isset ($n2['__force_ymdn']) and ((string)$n2['OriginalAlias']==='')) { $f2='n'. $n2['ID'] .'-ymdn'; if(array_key_exists($f2,$m2)) { $d2=$m2[$f2]; } } if(preg_match( '/(?P<year>\d{4})\/(?P<month>\d{1,2})\/(?P<day>\d{1,2})\/(?P<day_number>\d+)/', $d2,$y3 )) { $parameters['year']=$y3['year']; $parameters['month']=$y3['month']; $parameters['day']=$y3['day']; $parameters['day-number']=$y3['day_number']; } else { $parameters['alias']=$d2; } return$parameters; } function uv($s2){ $a2=$parameters=[]; foreach ($s2 as $q2){ $a2[] = gn() ['t'. $q2['ID']]; } if(count($a2)) { $parameters['tag-alias']=implode(',',$a2); } return$parameters; } function iv($parameters){ if ( (string) @$parameters['alias']!=='' or ( (string) @$parameters['year']!=='' and (string) @$parameters['month']!=='' and (string) @$parameters['day']!=='' and (string) @$parameters['day-number']!=='' ) ) { if ($l2=e2_published_noterec_with_parameters_($parameters)) { $parameters['*note']=$l2; } } if ( (string) @$parameters['oalias']!=='' or (string) @$parameters['draft']!=='' or (string) @$parameters['oalias2']!=='' or (string) @$parameters['draft2']!=='' ){ if ($l2=e2_noterec_with_parameters_($parameters)) { $parameters['*note']=$l2; } } if ( (string) @$parameters['tag-alias']!=='' ){ $parameters['*tags']=e2_tagrecs_with_parameters_($parameters); if(count($parameters['*tags']) == 1){ $parameters['*tag']=$parameters['*tags'][0]; } } return$parameters; } function ov($f){ global$_e2utf8__unformat_htmlentity_neasden; if($_e2utf8__unformat_htmlentity_neasden){ return $f; } else { return '((html '. $f .'))'; } } function pv($z2,$k2=false){ $x2=''; $e2_=strlen($z2); for ($r=0; $r < 256; ++ $r){ $r2[$r]=0; $t2=$r; while ($t2 & 0x00000080){ $t2 <<= 1; ++ $r2[$r]; } } for ($r=0xd090; $r <= 0xd0bf; $r++)$j2[$r]=chr(($r & 0x000000ff)+48); for ($r=0xd180; $r <= 0xd18f; $r++)$j2[$r]=chr(($r & 0x000000ff)+112); $j2[0xd081]="\xa8"; $j2[0xd191]="\xb8"; $j2[0xc299]="\x99"; $j2[0xc2a9]="\xa9"; $j2[0xc2ae]="\xae"; $j2[0xc2ab]="\xab"; $j2[0xc2bb]="\xbb"; $j2[0xc2a0]="\xa0"; $r=0; while ($r < $e2_){ $h2=$z2[$r]; $g2=ord($h2); if ($r2[$g2]==0){ $x2.=$h2; ++ $r; } elseif ($r2[$g2]==2){ $w2=$j2[($g2 << 8) | ord($z2[$r+1])]; $x2 .= ($w2!=null)? $w2 : ( $k2? (ov( cb(substr($z2,$r,2)) )) : '?' ); $r+=2; } else { $u2=substr($z2,$r,$r2[$g2]); if ($u2=="\xe2\x84\x96")$x2.="\xb9"; elseif ($u2=="\xe2\x80\x93")$x2.="\x96"; elseif ($u2=="\xe2\x80\x94")$x2.="\x97"; elseif ($u2=="\xe2\x80\x98")$x2.="\x91"; elseif ($u2=="\xe2\x80\x99")$x2.="\x92"; elseif ($u2=="\xe2\x80\x9a")$x2.="\x82"; elseif ($u2=="\xe2\x80\x9c")$x2.="\x93"; elseif ($u2=="\xe2\x80\x9d")$x2.="\x94"; elseif ($u2=="\xe2\x80\x9e")$x2.="\x84"; elseif ($u2=="\xe2\x80\xa6")$x2.="\x85"; elseif ($u2=="\xe2\x80\xb9")$x2.="\x8b"; elseif ($u2=="\xe2\x80\xba")$x2.="\x9b"; elseif ($u2=="\xe2\x82\xac")$x2.="\x88"; elseif ($u2=="\xe2\x84\xa2")$x2.="\x99"; else $x2.=$k2? (ov( cb($u2) )) : '?'; $r+=$r2[$g2]; } } return $x2; } function cb($p){ $i2=''; $e2_=strlen($p); for ($r=0; $r < $e2_; ++ $r){ $i2.=preg_replace('/^1*0/','',decbin(ord($p[$r]))); } return '&#'. bindec($i2) .';'; } function vb($o2) { $d=$o2; $d=preg_replace_callback('/([\x80-\xFF])/','e2_utf_from_windows_1251_char',$d); return $d; } function e2_utf_from_windows_1251_char($p){ list (, $p)=$p; if ($p=="\xa8") return "\xd0\x81"; if ($p=="\xb8") return "\xd1\x91"; if ($p >= "\xc0" && $p <= "\xef") return "\xd0".chr(ord($p)-48); if ($p >= "\xf0") return "\xd1".chr(ord($p)-112); if ($p=="\x85") return "\xe2\x80\xa6"; if ($p=="\x96") return "\xe2\x80\x93"; if ($p=="\x97") return "\xe2\x80\x94"; if ($p=="\xab") return "\xc2\xab"; if ($p=="\xbb") return "\xc2\xbb"; if ($p=="\x91") return "\xe2\x80\x98"; if ($p=="\x92") return "\xe2\x80\x99"; if ($p=="\x93") return "\xe2\x80\x9c"; if ($p=="\x94") return "\xe2\x80\x9d"; if ($p=="\x84") return "\xe2\x80\x9e"; if ($p=="\x99") return "\xe2\x84\xa2"; if ($p=="\xb9") return "\xe2\x84\x96"; if ($p=="\xa0") return "\xc2\xa0"; return '?'; }; function e2_utf8_version_of_array_($hv){ foreach ($hv as $t => $xf){ if (!array_key_exists($t.'.u?',$hv)) { if(is_string($hv[$t])) { $hv[$t]=vb($hv[$t]); } elseif(is_array($hv[$t])) { $hv[$t]=e2_utf8_version_of_array_($hv[$t]); } } } return $hv; } function yb($jb){ return mb_convert_encoding($jb[0],'HTML-ENTITIES','UTF-8'); } function nb($o2,$p2=false){ if ($p2){ return preg_replace_callback( '/[\x{10000}-\x{fffff}]/u','e2_question_long_utf8_chars_helper',$o2 ); } else { return preg_replace('/[\x{10000}-\x{fffff}]/u','?',$o2); } } function e2img_filename_by_processing( $cd,$vd, $bd,$yd,$nd ){ global$_config; if(Log::$cy)__log('Process image: "'. $cd .'" -> "'. $vd .'"'); if (!is_file($cd)) return false; $md=stat($cd)['size']; if (!wb($cd)) { if(Log::$cy)__log('Process image: SVG, no processing'); return $cd; } if(is_file($vd) and !b3($cd,$vd)) { if(Log::$cy)__log('Process image: Already exists'); return $vd; } if (!extension_loaded('gd')) return false; $fd=pathinfo($vd); if (!@j($fd['dirname'])) { if(Log::$cy)__log( 'Process image: Can’t create directory <'. $fd['dirname'] .'>' ); return false; } if(Log::$cy)__log('Process image: Detecting image type'); $type=e2img__type_of_file($cd); if (!$type) return false; $dd='imagecreatefrom'. $type; if (!function_exists($dd)) return false; if(Log::$cy)__log('Process image: Opening original image ('. $dd .')'); $sd=call_user_func($dd,$cd); if (!$sd) return false; if ($ad=e2img__orientation_of_file($cd)) { if(Log::$cy)__log('Process image: Needs orientation fix'); $sd=e2img__res_rotate($sd, -$ad); } $qd=[imagesx($sd),imagesy($sd)]; $ld=$qd; $zd=[0,0,0,0]; if ($yd==CROP_SQUARE){ if(Log::$cy)__log('Process image: Needs crop'); list ($ld,$zd) = ( e2img__crop_metrics_to_square($ld) ); } $ld=e2_fit_metrics_to_constraints( $ld,$bd ); if ( $ad===0 and $ld===$qd ){ if(Log::$cy)__log('Process image: No changes necessary, leaving original'); return $cd; } if(Log::$cy)__log(var_export($ld,true)); if(Log::$cy)__log(var_export($zd,true)); $kd=e2img__create_copy_resampled( $sd, $ld, $zd, $type ); imagejpeg($kd,$vd,$nd); if (!is_file($vd)) { if(Log::$cy)__log('Process image: File not created by imagejpeg'); return false; } if ($ad===0){ $xd=stat($vd)['size']; if ($xd >= $md){ if(Log::$cy)__log('Process image: Conversion to JPEG made file bigger, back up'); unlink($vd); $vd=$cd; } } @chmod($vd,$_config['uploaded_files_mode']); if(Log::$cy)__log('Process image: Done'); return $vd; } function e2img__create_copy_resampled( $sd,$ld,$zd,$type ){ list ($ed,$rd)=$ld; list ($td,$jd,$hd,$gd)=$zd; $kd=imagecreatetruecolor($ed,$rd); if($type==='png'){ imagefill($kd,0,0,imagecolorallocate($kd,255,255,255)); imagealphablending($kd,true); } $wd=imagesx($sd); $ud=imagesy($sd); imagecopyresampled( $kd, $sd, 0,0, 0+$td,0+$jd, $ed,$rd, $wd-$hd,$ud-$gd ); imageinterlace($kd,1); return $kd; } function e2img__type_of_file($fb){ $id=@getimagesize($fb); if (!$id or $id[2] > 3) return false; if ($id[2]==IMAGETYPE_GIF) return 'gif'; if ($id[2]==IMAGETYPE_JPEG) return 'jpeg'; if ($id[2]==IMAGETYPE_PNG) return 'png'; return false; } function e2img__orientation_of_file($fb){ if (!function_exists('exif_read_data')) return 0; if (($od=@exif_read_data($fb)) === false) return 0; if ($od['Orientation']==3) return -180; if ($od['Orientation']==6) return -270; if ($od['Orientation']==8) return -90; return 0; } function e2img__res_rotate($sy,$ad){ $pd=imagerotate($sy,$ad,0); if ($pd!==false){ imagedestroy($sy); $sy=$pd; } return $sy; } function e2_fit_metrics_to_constraints( $cs,$bd ){ if ($bd===false)$bd=[0,0]; list ($vs,$bs)=$cs; list ($ys,$ns)=$bd; $ms=[1]; if ($ys)$ms[] = $ys/$vs; if ($ns)$ms[] = $ns/$bs; $fs=min($ms); if ($fs < 1){ $vs=(int)round($vs*$fs); $bs=(int)round($bs*$fs); } return [$vs,$bs]; } function e2img__crop_metrics_to_square($cs){ $ds=$ss=$as_=$qs=0; list ($vs,$bs)=$cs; if ($vs > $bs){ $as_=$vs-$bs; $ds=floor($as_/2); $bs=$vs; } elseif ($vs < $bs){ $qs=$bs-$vs; $ss=floor($as_/2); $vs=$bs; } $zd=[$ds,$ss,$as_,$qs]; $ls=[$vs,$bs]; return [$ls,$zd]; } define('PROVIDE_MEDIA_ASYNC',10); define('PROVIDE_MEDIA_NOW',20); function mb($zs){ global$full_blog_url; $ks=parse_url($zs); if (isset ($ks['host'])) { $sm=$zs; if ($ks['host']=='www.youtube.com'){ $xs=basename($ks['path']); $es='remote/youtube-'. $xs .'-cover.jpg'; return [ 'url' => $sm, 'type' => 'online-video', 'is-local?' => false, 'is-usable-as-cover?' => true, 'is-using-thumbnails?' => true, 'is-generating-thumbnail?' => true, 'is-snippetable?' => true, 'is-rss-enclosure?' => false, 'video-service' => 'youtube', 'video-id' => $xs, 'local-cover-href' => $full_blog_url .'/'. PICTURES_FOLDER.$es, 'local-relative-filename' => $es, 'local-full-filename' => MEDIA_ROOT_FOLDER.PICTURES_FOLDER.$es, 'local-full-failname' => MEDIA_ROOT_FOLDER.PICTURES_FOLDER.$es.'.failed', ]; } elseif ($ks['host']=='player.vimeo.com'){ $xs=basename($ks['path']); $es='remote/vimeo-'. $xs .'-cover.jpg'; return [ 'url' => $sm, 'type' => 'online-video', 'is-local?' => false, 'is-usable-as-cover?' => true, 'is-using-thumbnails?' => true, 'is-generating-thumbnail?' => true, 'is-snippetable?' => true, 'is-rss-enclosure?' => false, 'video-service' => 'vimeo', 'video-id' => $xs, 'local-cover-href' => $full_blog_url .'/'. PICTURES_FOLDER.$es, 'local-relative-filename' => $es, 'local-full-filename' => MEDIA_ROOT_FOLDER.PICTURES_FOLDER.$es, 'local-full-failname' => MEDIA_ROOT_FOLDER.PICTURES_FOLDER.$es.'.failed', ]; } elseif (gb($ks['path'])) { return [ 'url' => $sm, 'type' => 'remote-image', 'is-local?' => false, 'is-usable-as-cover?' => false, 'is-using-thumbnails?' => false, 'is-generating-thumbnail?' => false, 'is-snippetable?' => false, 'is-rss-enclosure?' => false, 'mime-type' => v3($ks['path']), 'length' => '', ]; } else { return [ 'url' => $sm, 'type' => 'remote-non-image', 'is-local?' => false, 'is-usable-as-cover?' => false, 'is-using-thumbnails?' => false, 'is-generating-thumbnail?' => false, 'is-snippetable?' => false, 'is-rss-enclosure?' => true, 'mime-type' => v3($ks['path']), 'length' => '', ]; } } else { if (gb($ks['path'])) { $sm=$full_blog_url .'/'. PICTURES_FOLDER.$ks['path']; $rs=MEDIA_ROOT_FOLDER.PICTURES_FOLDER.$ks['path']; return [ 'url' => $sm, 'type' => 'local-image', 'is-local?' => true, 'is-usable-as-cover?' => true, 'is-using-thumbnails?' => true, 'is-generating-thumbnail?' => wb($ks['path']), 'is-snippetable?' => true, 'is-rss-enclosure?' => false, 'mime-type' => v3($ks['path']), 'length' => @stat($rs)['size'], 'local-href' => $sm, 'local-cover-href' => $sm, 'local-relative-filename' => $ks['path'], 'local-full-filename' => $rs, 'thumb-full-filename' => $rs, ]; } elseif (ib($ks['path'])) { $sm=$full_blog_url .'/'. VIDEO_FOLDER.$ks['path']; $rs=MEDIA_ROOT_FOLDER.VIDEO_FOLDER.$ks['path']; return [ 'url' => $sm, 'type' => 'local-video', 'is-local?' => true, 'is-usable-as-cover?' => false, 'is-using-thumbnails?' => true, 'is-generating-thumbnail?' => false, 'is-snippetable?' => false, 'is-rss-enclosure?' => true, 'mime-type' => v3($ks['path']), 'length' => @stat($rs)['size'], 'local-href' => $sm, 'local-relative-filename' => $ks['path'], 'local-full-filename' => $rs, 'thumb-full-filename' => VIDEO_ICON_IMAGE, ]; } else { $sm=$full_blog_url .'/'. AUDIO_FOLDER.$ks['path']; $rs=MEDIA_ROOT_FOLDER.AUDIO_FOLDER.$ks['path']; return [ 'url' => $sm, 'type' => 'local-non-image', 'is-local?' => true, 'is-usable-as-cover?' => false, 'is-using-thumbnails?' => true, 'is-generating-thumbnail?' => false, 'is-snippetable?' => false, 'is-rss-enclosure?' => true, 'mime-type' => v3($ks['path']), 'length' => @stat($rs)['size'], 'local-href' => $sm, 'local-full-filename' => $rs, 'thumb-full-filename' => AUDIO_ICON_IMAGE, ]; } } } function fb($ts){ $js=[]; foreach ($ts as $zs){ $hs=mb($zs); if ($hs['is-local?'])$js[] = $zs; } return $js; } function db($ts){ $js=[]; foreach ($ts as $zs){ $hs=mb($zs); if ($hs['is-snippetable?'])$js[] = $zs; } return $js; } function sb( $gs,$ws ){ if (!is_array($gs))$gs=[]; if (!is_array($ws))$ws=[]; $ts=array_merge($ws,$gs); $ts=array_reverse($ts); $ts=array_unique($ts); $ts=array_reverse($ts); return $ts; } function ab($ts){ global$full_blog_url; if (!is_array($ts) or !count($ts)) return []; rb($ts); $us=[]; foreach ($ts as $zs){ if (!empty ($is[$zs])) continue; $hs=mb($zs); if (!$hs['is-usable-as-cover?']) continue; if (!is_file($hs['local-full-filename'])) continue; $size=m3($hs['local-full-filename']); list ($vs,$bs,$os,$ps)=$size; $us[] = [ 'src' => $hs['local-cover-href'], 'width' => $vs, 'height' => $bs, 'horizontality' => $os, 'verticality' => $ps, ]; $is[$zs]=true; } return $us; } function qb($ts){ global$full_blog_url,$_strings; if (!is_array($ts) or !count($ts)) return []; rb($ts); $ca=[]; foreach ($ts as $zs){ if (!empty ($is[$zs])) continue; $hs=mb($zs); if (!$hs['is-using-thumbnails?']) continue; if (!is_file($hs['local-full-filename'])) continue; $va=[ 'is-available?' => true, 'src' => '', 'width' => '', 'height' => '', 'original-filename' => '', 'original-filesize' => '', ]; if (!$hs['is-local?'] or is_file($hs['local-full-filename'])) { if ($hs['is-generating-thumbnail?']) { $ba=tb( $hs ); } else { $ba=$hs['thumb-full-filename']; } } if (empty ($ba)) { $va['is-available?']=false; $ba=jb( $hs['local-relative-filename'] ); } $va['src']=x3($ba); if ($va['is-available?']) { $size=m3($ba); list ($vs,$bs)=$size; } else { $vs=$bs=''; } if (!$vs)$vs=THUMB_WIDTH/2; if (!$bs)$bs=THUMB_HEIGHT/2; list ($vs,$bs)=e2_fit_metrics_to_constraints( [$vs,$bs], [THUMB_WIDTH/2,THUMB_HEIGHT/2] ); $va['width']=$vs; $va['height']=$bs; if ($hs['is-local?']) { $va['original-filename']=$zs; if(is_file($hs['local-full-filename'])) { $ya=stat($hs['local-full-filename'])[7]; $ya=round($ya/1024) .' '. $_strings['gs--kb']; $va['original-filesize']=$ya; } } $ca[] = $va; $is[$zs]=true; } return $ca; } function lb($na){ foreach ( ['maxresdefault','hqdefault','mqdefault','sddefault','default'] as $fb ){ $sm='http://img.youtube.com/vi/'. $na .'/'. $fb .'.jpg'; if(Log::$cy)__log('Trying '. $sm .'...'); $ma=@file_get_contents($sm); if ($ma!==false) return $ma; } return false; } function zb($fa){ $da=@unserialize( file_get_contents('http://vimeo.com/api/v2/video/'. $fa .'.php') ); if (!empty ($da[0]['thumbnail_large'])) { return @file_get_contents($da[0]['thumbnail_large']); } return false; } function kb($hs,$sa){ if(is_file($hs['local-full-filename'])) { if(Log::$cy)__log('Already exists: '. $hs['local-full-filename']); } elseif(is_file($hs['local-full-failname'])) { if(Log::$cy)__log('Already tried and failed: '. $hs['local-full-filename']); } else { if(Log::$cy)__log('Resource '. $hs['url'].' is missing a cover, retrieving'); if ($sa==PROVIDE_MEDIA_ASYNC){ p3(jv('e2s_retrieve', [ 'url' => strtr(base64_encode($hs['url']), '+/','-_'), ])); } if ($sa==PROVIDE_MEDIA_NOW){ if(Log::$cy)__log('Downloading "'. $hs['video-service'] .'" cover as '. $hs['local-full-filename'] .'...'); if ($hs['video-service']=='youtube'){ $ma=lb($hs['video-id']); } if ($hs['video-service']=='vimeo') { $ma=zb($hs['video-id']); } if ($ma!==false){ n3($hs['local-full-filename'],$ma); } else { n3($hs['local-full-failname'],''); } } } } function xb($zs,$sa){ $hs=mb($zs); if(Log::$cy)__log('Resource '. $zs .' is of type '. $hs['type']); if ($hs['type']=='local-image'){ tb($hs); } if ($hs['type']=='online-video'){ kb($hs,$sa); if ($sa==PROVIDE_MEDIA_NOW and is_file($hs['local-full-filename'])) { tb($hs); } } if ($hs['type']=='remote-image'){ } } function eb($ts){ foreach ($ts as $zs){ $hs=mb($zs); if (empty ($hs['local-full-failname'])) continue; if(is_file($hs['local-full-failname'])) { if(Log::$cy)__log('Deleting '. $hs['local-full-failname'] .' to try again'); unlink($hs['local-full-failname']); } } } function rb($ts){ if (!is_array($ts)) return; if(Log::$cy)__log('Asynchronously provide data for resnames {'); foreach ($ts as $zs){ xb($zs,PROVIDE_MEDIA_ASYNC); } if(Log::$cy)__log('}'); } function tb($hs){ if (!$hs['is-generating-thumbnail?']) return false; return e2img_filename_by_processing( $hs['local-full-filename'], jb($hs['local-relative-filename']), [THUMB_WIDTH,THUMB_HEIGHT], CROP_NONE, THUMB_JPG_QUALITY ); } function jb($aa){ return pb( MEDIA_ROOT_FOLDER.THUMBNAILS_FOLDER.$aa, 'thumb@2x' ); } if(E2_EDITION){ function hb($ts){ $qa=[]; foreach ($ts as $zs){ $hs=mb($zs); if ($hs['is-rss-enclosure?']) { $qa[] = [ 'url' => $hs['url'], 'type' => $hs['mime-type'], 'length' => $hs['length'], ]; } } return $qa; } } function gb($zs){ $la=pathinfo($zs); $za=$la['extension']; return (in_array(strtolower($za), ['jpg','jpeg','gif','png','svg'])); } function wb($zs){ $la=pathinfo($zs); $za=$la['extension']; return (in_array(strtolower($za), ['jpg','jpeg','gif','png'])); } function ub($zs){ $la=pathinfo($zs); $za=$la['extension']; return (in_array(strtolower($za), ['svg'])); } function ib($zs){ $la=pathinfo($zs); $za=$la['extension']; return (in_array(strtolower($za), ['mp4','mov'])); } function ob($zs){ $la=pathinfo($zs); $za=$la['extension']; return (in_array(strtolower($za), ['mp3'])); } function pb($zs,$ka){ if (!empty ($ka)) { $xa=explode('/',$zs); $ea=array_pop($xa); $ra=explode('.',$ea); if(count($ra) < 2)$ra[] = ''; $za=array_pop($ra); $ra[] = $ka; if ($za)$ra[] = $za; $ea=implode('.',$ra); $xa[] = $ea; $zs=implode('/',$xa); } return $zs; } function c3($ta,$ea){ if (!is_file($ta.$ea)) return $ea; $ja=strrpos($ea,'.'); $ha=substr($ea,0,$ja); $za=substr($ea,$ja); $r=0; while (is_file($ta.$ha .'-'. (++ $r).$za)); $ea=$ha .'-'. $r.$za; return $ea; } function v3($zs){ $la=pathinfo($zs); $za=$la['extension']; if ($za=='png') return 'image/png'; if ($za=='gif') return 'image/gif'; if ($za=='jpg' or $za=='jpeg') return 'image/jpeg'; if ($za=='mp3') return 'audio/mpeg'; if ($za=='svg') return 'image/svg+xml'; if ($za=='mp4') return 'video/mp4'; if ($za=='mov') return 'video/quicktime'; } function b3($ga,$wa){ return strcasecmp($ga,$wa)===0; } $_folders_written=[ '.', USER_FOLDER, CACHES_FOLDER, BACKUP_FOLDER, LOG_FOLDER, MEDIA_ROOT_FOLDER.PICTURES_FOLDER, MEDIA_ROOT_FOLDER.THUMBNAILS_FOLDER, MEDIA_ROOT_FOLDER.PICTURES_FOLDER .'remote/', MEDIA_ROOT_FOLDER.THUMBNAILS_FOLDER .'remote/', MEDIA_ROOT_FOLDER.VIDEO_FOLDER, MEDIA_ROOT_FOLDER.AUDIO_FOLDER, MEDIA_ROOT_FOLDER.AVATARS_FOLDER, ]; $_files_written=[ USER_FOLDER.'password-hash.psa', USER_FOLDER.'password-wait.psa', USER_FOLDER.'last-comment.psa', USER_FOLDER.'new-uploads.psa', USER_FOLDER.'settings.json', USER_FOLDER.'indexing.psa', USER_FOLDER.'auth.psa', USER_FOLDER.'scheduled.psa', ]; define('CROP_NONE',0); define('CROP_SQUARE',1); function y3(){ global$_folders_written,$_files_written; clearstatcache(); $ua=[]; foreach($_folders_written as $dn){ if(is_dir($dn) and !is_writable($dn)) { $ua[] = $dn; } } foreach($_files_written as $dn){ if(is_file($dn) and !is_writable($dn)) { $ua[] = $dn; } } return $ua; } function n3($fy,$x){ @j(dirname($fy)); if (!@file_put_contents($fy,$x,LOCK_EX)) { return false; } @chmod($fy,E2_NEW_FILES_RIGHTS); return true; } function m3($fb){ $vs=$bs=0; if (wb($fb)) { list ($vs,$bs)=getimagesize($fb); } elseif (ib($fb)) { try { require_once SYSTEM_LIBRARY_FOLDER .'getid3/getid3.php'; $id=new getid3(); $id=$id->analyze($fb); $vs=$id['video']['resolution_x']; $bs=$id['video']['resolution_y']; } catch (\Exception $e){} } elseif (ub($fb)) { if(function_exists('simplexml_load_string')) { $ia=simplexml_load_string(file_get_contents($fb)); if ($ia){ $oa=$ia->attributes(); list ($vs,$bs) = [(string)$oa -> width, (string)$oa -> height]; } } } if(substr($fb,strrpos($fb,'.')-3,3)=='@2x'){ $vs=(int)floor($vs/2); $bs=(int)floor($bs/2); } $os=round(($bs > 0) ? ($vs/$bs):1,2); $ps=round(($vs > 0) ? ($bs/$vs):1,2); return [$vs,$bs,$os,$ps]; } function e2s_retrieve($parameters){ $sm=base64_decode(strtr($parameters['url'],'-_','+/')); if(Log::$cy)__log('Retrieve: '. $sm); xb($sm,PROVIDE_MEDIA_NOW); die; } function f3( $pa,$c1,$gs ){ $v1=[]; if(is_array($gs)) { $v1=fb($gs); } $b1=@unserialize( $c1['Uploads'] ) or $b1=[]; $y1=array_diff($v1,$b1); if(count($y1) > 0){ z3($pa,$c1['ID'],'add',$y1); } return $y1; } function d3($ts){ $ua=[]; foreach (ab($ts) as $n1){ $ua[] = $n1['src']; } return $ua; } function s3($name,$m1){ $name=m($name); if(preg_match('//u',$name))$name=pv($name,false); if ($m1=='image'){ $ta=MEDIA_ROOT_FOLDER.PICTURES_FOLDER; } elseif ($m1=='video'){ $ta=MEDIA_ROOT_FOLDER.VIDEO_FOLDER; } elseif ($m1=='audio'){ $ta=MEDIA_ROOT_FOLDER.AUDIO_FOLDER; } else { return false; } $f1=''; for ($r=0; $r < strlen($name); $r++) { if($name[$r]=='?'){ $f1.=''; } elseif($name[$r]==' '){ $f1.='-'; } elseif(ord($name[$r]) <= 127){ $f1.=$name[$r]; } } if ($f1=='')$f1=$m1; if ($f1[0]=='.')$f1=$m1.$f1; return $f1; } function a3($d1){ global$_config; if(Log::$cy)__log('Count references for upload <'. $d1 .'>'); if(is_file(USER_FOLDER.'new-uploads.psa')) { $s1=@unserialize(file_get_contents(USER_FOLDER.'new-uploads.psa')); } $a1='%'. str_replace('%','#%',$d1) .'%'; kn( "SELECT `ID`, `Text`, `FormatterID`, `Uploads` ". "FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND (`Text` LIKE '". $a1 ."' ESCAPE '#' ". "OR `Uploads` LIKE '". $a1 ."' ESCAPE '#')", 'get notes where uploads may be referenced' ); $q1=xn(); $l1=@unserialize($q1[0]['Uploads']); if (!is_array($l1)) { foreach ($q1 as $n2){ $z1=u3( $n2['FormatterID'], @$n2['Text'],'full-rss' ); $l1=f3( 'note',$n2, $z1['meta']['resources-detected'] ); } } kn( "SELECT `ID`, `Description`, `Uploads` ". "FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND (`Description` LIKE '". $a1 ."' ESCAPE '#' ". "OR `Uploads` LIKE '". $a1 ."' ESCAPE '#')", 'get tags where uploads may be referenced' ); $q1=xn(); $k1=@unserialize($q1[0]['Uploads']); if (!is_array($k1)) { foreach ($q1 as $q2){ $z1=i3( @$q2['Description'],'full-rss' ); $k1=f3( 'tag',$q2, $z1['meta']['resources-detected'] ); } } if (!is_array($s1))$s1=[]; if (!is_array($l1))$l1=[]; if (!is_array($k1))$k1=[]; $x1=array_merge($s1,$l1,$k1); if(Log::$cy)__log('References found in relevant entries: '. var_export($x1,true)); if(in_array($d1,$x1)) { if(Log::$cy)__log('Still referenced, do not delete file'); return true; } return false; } function q3($e1,$xs){ global$_config; if ($e1=='note' and $xs=='new'){ if(is_file(USER_FOLDER.'new-uploads.psa')) { $x1=@unserialize(file_get_contents(USER_FOLDER.'new-uploads.psa')); } } elseif ($e1=='note'){ kn( "SELECT `Uploads` FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID`=". $xs ); $q1=xn(); $x1=@unserialize($q1[0]['Uploads']); } elseif ($e1=='tag'){ kn( "SELECT `Uploads` FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID`=". $xs ); $q1=xn(); $x1=@unserialize($q1[0]['Uploads']); } if (!is_array($x1))$x1=array(); return $x1; } function l3($e1,$xs,$x1){ global$_config; if ($e1=='note' and $xs=='new'){ if (!@n3(USER_FOLDER.'new-uploads.psa',serialize($x1))) { mv('ERROR',E2E_PERMISSIONS_ERROR); } } elseif ($e1=='note'){ kn( "UPDATE `". $_config['db_table_prefix']."Notes` ". "SET `Uploads`='". serialize($x1) ."' ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID`=". $xs ); } elseif ($e1=='tag'){ kn( "UPDATE `". $_config['db_table_prefix']."Keywords` ". "SET `Uploads`='". serialize($x1) ."' ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID`=". $xs ); } else { return false; } if (!is_array($x1))$x1=array(); return $x1; } function z3($e1,$xs,$action,$qv){ global$_config; $x1=array(); if(Log::$cy)__log('Register upload: <'. $e1.', '. $xs.', '. $action.', '. $qv .'>'); $x1=q3($e1,$xs); $x1=d($x1,$action,$qv); l3($e1,$xs,$x1); } function k3($r1,$t1,$gs){ $b1=@unserialize($t1['Uploads']) or $b1=array(); $j1=fb($gs); $x1=d($b1,'add',$j1); $x1=serialize($x1); if ($x1!=$t1['Uploads']) { $t1['Uploads']=$x1; nn($r1,$t1); } } function e2j_file_upload($parameters=array ()) { global$_config,$full_blog_url,$_strings; @j(MEDIA_ROOT_FOLDER.PICTURES_FOLDER); @chmod(MEDIA_ROOT_FOLDER.PICTURES_FOLDER,$_config['uploaded_files_mode']); @j(MEDIA_ROOT_FOLDER.VIDEO_FOLDER); @chmod(MEDIA_ROOT_FOLDER.VIDEO_FOLDER,$_config['uploaded_files_mode']); @j(MEDIA_ROOT_FOLDER.AUDIO_FOLDER); @chmod(MEDIA_ROOT_FOLDER.AUDIO_FOLDER,$_config['uploaded_files_mode']); $zv=[ 'success' => false ]; if(count($_FILES) > 0){ foreach($_FILES as $fy){ if (!$fy['error']) { if(Log::$cy)__log('Ajax file upload: <'. $fy['name'].'>'); $zv['data']['file-kind']='image'; $ta=MEDIA_ROOT_FOLDER.PICTURES_FOLDER; if (ib($fy['name'])) { $zv['data']['file-kind']='video'; $ta=MEDIA_ROOT_FOLDER.VIDEO_FOLDER; } elseif (ob($fy['name'])) { $zv['data']['file-kind']='audio'; $ta=MEDIA_ROOT_FOLDER.AUDIO_FOLDER; } $h1=( array_key_exists('overwrite',$_GET) and is_file($ta.$fy['name']) ); $g1=false; $zv['data']['overwrite'] = (int)$h1; if(Log::$cy)__log('Ajax file upload: Overwrite is resolved to <'. (int)$h1.'>'); $f1=s3($fy['name'],$zv['data']['file-kind']); if(Log::$cy)__log('Ajax file upload: Safe name is <'. $f1.'>'); if(is_file($ta.$f1)) { if(file_get_contents($ta.$f1)==file_get_contents($fy['tmp_name'])) { if(Log::$cy)__log('Ajax file upload: Existing file is the same'); $g1=true; } elseif (!$h1){ $f1=c3($ta,$f1); } } if (!$g1){ move_uploaded_file($fy['tmp_name'],$ta.$f1); @chmod($ta.$f1,$_config['uploaded_files_mode']); } if(Log::$cy)__log('Ajax file upload: File kind is <'. $zv['data']['file-kind'].'>'); if ($zv['data']['file-kind']=='image'){ $za=pathinfo($f1,PATHINFO_EXTENSION); if (b3($za,'jpg')) { $w1=$f1; } else { $w1=$f1 .'.jpg'; $w1=c3( MEDIA_ROOT_FOLDER.PICTURES_FOLDER,$w1 ); } $u1=MEDIA_ROOT_FOLDER.PICTURES_FOLDER.$f1; $i1=MEDIA_ROOT_FOLDER.PICTURES_FOLDER.$w1; if(Log::$cy)__log('Ajax file upload: Process uploaded image <'. $u1.'>'. ' to possibly <'. $i1.'>'); $i1=e2img_filename_by_processing( $u1, $i1, [ $_config['fit_uploaded_images'], $_config['fit_uploaded_images'], ], CROP_NONE, SCALED_IMAGE_JPG_QUALITY ); $ya=$fy['size']; if (!b3($i1,$u1)) { @unlink($u1); $f1=$w1; $ya=stat($i1)['size']; } if ($h1){ @unlink(jb($f1)); } if ($o1=e2img_filename_by_processing( $u1, jb($f1), [THUMB_WIDTH,THUMB_HEIGHT], CROP_NONE, THUMB_JPG_QUALITY )) { if(Log::$cy)__log('Ajax file upload: thumbnail, done as '. $o1); list ($vs,$bs)=m3($o1); if(Log::$cy)__log('Ajax file upload: image size '. $vs .'×'. $bs); if (!$vs)$vs=THUMB_WIDTH/2; if (!$bs)$bs=THUMB_HEIGHT/2; list ($vs,$bs)=e2_fit_metrics_to_constraints( [$vs,$bs], [THUMB_WIDTH/2,THUMB_HEIGHT/2] ); $zv['success']=true; $zv['data']['new-name']=$f1; $zv['data']['filesize']=round($ya/1024) .' '. $_strings['gs--kb']; $zv['data']['thumb']=x3($o1); $zv['data']['width']=$vs; $zv['data']['height']=$bs; z3($parameters['entity'],$parameters['entity-id'],'add', array ($f1)); } else { if(Log::$cy)__log('Ajax file upload: couldn’t create thumbnail'); @unlink($ta.$f1); $zv['error']['message']=_S('er--cannot-create-thumbnail'); } } if ($zv['data']['file-kind']=='video'){ if(Log::$cy)__log('Ajax file upload: video, done'); $zv['success']=true; $zv['data']['new-name']=$f1; $zv['data']['filesize']=round($fy['size']/1024) .' '. $_strings['gs--kb']; $zv['data']['thumb']=VIDEO_ICON_IMAGE; $zv['data']['width']=VIDEO_ICON_WIDTH/2; $zv['data']['height']=VIDEO_ICON_HEIGHT/2; z3($parameters['entity'],$parameters['entity-id'],'add', array ($f1)); } if ($zv['data']['file-kind']=='audio'){ if(Log::$cy)__log('Ajax file upload: audio, done'); $zv['success']=true; $zv['data']['new-name']=$f1; $zv['data']['filesize']=round($fy['size']/1024) .' '. $_strings['gs--kb']; $zv['data']['thumb']=AUDIO_ICON_IMAGE; $zv['data']['width']=AUDIO_ICON_WIDTH/2; $zv['data']['height']=AUDIO_ICON_HEIGHT/2; z3($parameters['entity'],$parameters['entity-id'],'add', array ($f1)); } } elseif(4!=$fy['error']) { if ($fy['error']==1){ $zv['error']['message']='too-big'; } elseif ($fy['error']==2){ $zv['error']['message']='too-big'; } elseif ($fy['error']==3){ $zv['error']['message']='partial'; } else { $zv['error']=$fy['error']; } } } } else { if(Log::$cy)__log('Ajax file upload error: no files'); $zv['error']['message']='no-files'; } $zv=json_encode($zv); die ($zv); } function x3($p1){ global$full_blog_url; $e2_=strlen(MEDIA_ROOT_FOLDER); if ($e2_ and substr($p1,0,$e2_)==MEDIA_ROOT_FOLDER){ return substr($p1,$e2_); } else { return$full_blog_url .'/'. $p1; } } function e3(){ @unlink(USER_FOLDER.'userpic@2x.png'); @unlink(USER_FOLDER.'userpic@2x.jpg'); @unlink(USER_FOLDER.'userpic-large@2x.jpg'); @unlink(USER_FOLDER.'userpic-square@2x.jpg'); } function e2j_userpic_remove(){ if($_SERVER['REQUEST_METHOD']!='POST'){ c(jv('e2m_settings')); } e3(); $zv=json_encode([ 'success' => true ]); die ($zv); } function e2j_userpic_upload(){ global$_config; $zv=[ 'success' => false ]; if(count($_FILES)!=1){ if(Log::$cy)__log('Ajax userpic upload error: no or too many files'); $zv['error']['message']='No or too many files'; $zv=json_encode($zv); die ($zv); } $fy=array_pop($_FILES); if (!$fy['error']) { if(Log::$cy)__log('Ajax userpic upload: <'. $fy['name'].'>'); $cq=pathinfo($fy['name']); $za=strtolower($cq['extension']); if ($za!='png')$za='jpg'; $fb='userpic.original.'. $za; move_uploaded_file($fy['tmp_name'],USER_FOLDER.$fb); @chmod(USER_FOLDER.$fb,$_config['uploaded_files_mode']); e3(); copy( USER_FOLDER.$fb, USER_FOLDER .'userpic-large@2x.jpg' ); $vq=e2img_filename_by_processing( USER_FOLDER .'userpic-large@2x.jpg', USER_FOLDER .'userpic-large@2x.jpg', [$_config['max_image_width'],$_config['max_image_width']], CROP_NONE, USERPIC_JPG_QUALITY ); copy( USER_FOLDER.$fb, USER_FOLDER .'userpic-square@2x.jpg' ); $bq=e2img_filename_by_processing( USER_FOLDER .'userpic-square@2x.jpg', USER_FOLDER .'userpic-square@2x.jpg', [$_config['max_image_width'],$_config['max_image_width']], CROP_SQUARE, USERPIC_JPG_QUALITY ); $yq=e2img_filename_by_processing( USER_FOLDER.$fb, USER_FOLDER .'userpic@2x.jpg', [USERPIC_WIDTH,USERPIC_HEIGHT], CROP_SQUARE, USERPIC_JPG_QUALITY ); if ($bq){ $zv=[ 'success' => true, 'data' => [ 'new-image-src' => $bq, ] ]; } else { $zv['error']['message']=_S('er--supported-only-png-jpg-gif'); } } elseif(4!=$fy['error']) { if ($fy['error']==1){ $zv['error']['message']='File too big'; } elseif ($fy['error']==2){ $zv['error']['message']='File too big'; } elseif ($fy['error']==3){ $zv['error']['message']='File upload is partial'; } else { $zv['error']['message']='File upload error '. $fy['error']; } } $zv=json_encode($zv); die ($zv); } function e2j_file_remove($parameters){ if (!array_key_exists('file',$_POST)) { $zv=[ 'success' => false ]; $zv=json_encode($zv); die ($zv); } $fy=$_POST['file']; $zv=[ 'success' => true ]; $zv=json_encode($zv); z3($parameters['entity'],$parameters['entity-id'],'remove',$fy); if (!a3($fy)) { if (ob($fy)) { if(Log::$cy)__log('Not referenced, deleting '. MEDIA_ROOT_FOLDER.AUDIO_FOLDER.$fy); @unlink(MEDIA_ROOT_FOLDER.AUDIO_FOLDER.$fy); } elseif (ib($fy)) { if(Log::$cy)__log('Not referenced, deleting '. MEDIA_ROOT_FOLDER.VIDEO_FOLDER.$fy); @unlink(MEDIA_ROOT_FOLDER.VIDEO_FOLDER.$fy); } else { $yq=pb($fy,'thumb@2x'); $nq=@unlink(MEDIA_ROOT_FOLDER.PICTURES_FOLDER.$fy); $mq=@unlink(MEDIA_ROOT_FOLDER.THUMBNAILS_FOLDER.$yq); } } die ($zv); } function r3(){ global$_config; if (!$_config['files_total_size_limit']) return false; $fq=0; foreach(glob(MEDIA_ROOT_FOLDER.PICTURES_FOLDER .'/*') as $fy){ $f=stat($fy); $fq+=$f['size']; } foreach(glob(MEDIA_ROOT_FOLDER.VIDEO_FOLDER .'/*') as $fy){ $f=stat($fy); $fq+=$f['size']; } foreach(glob(MEDIA_ROOT_FOLDER.AUDIO_FOLDER .'/*') as $fy){ $f=stat($fy); $fq+=$f['size']; } $dq=$_config['files_total_size_limit']; $sq=f($fq,$dq); return array ($fq,$dq,$sq); } function t3($aq){ $qq=true; if (list ($fq,$dq,$sq)=$aq){ $qq=($dq-$fq) > 0; } return $qq; } function j3($aq,$lq=false){ $zq=''; if (list ($fq,$dq,$sq)=$aq){ $aq=array ( 'used' => round($fq/1024/1024), 'total' => round($dq/1024/1024), 'percent' => $sq ); if ($lq or ($dq-$fq) < 1024*1024*10){ if ($fq < $dq){ $zq=e2l_get_string('gs--used',$aq); } else { $zq=e2l_get_string('gs--used-all',$aq); } } } return $zq; } function e2_error404_mode(){ global$_config,$_strings; if($_config['try_redirect_to_all']) { $kq='all/'. urldecode($_GET['go']); hv($kq); } header('HTTP/1.1 404 Not found'); $xq['class']='404'; $xq['heading']=$_strings['pt--page-not-found']; $xq['title']=$_strings['pt--page-not-found']; if(E2_EDITION){ $xq['popular']=a2(); } return $xq; } function e2s_post_service($parameters){ if($_SERVER['REQUEST_METHOD']!='POST'){ c(jv('e2m_underhood')); } if($parameters['service']==='build'){ e2_build(); mv('Engine core built',E2E_MESSAGE); } if($parameters['service']==='sync'){ e2_drop_all_kinds_of_cache(); mv('Caches invalidated',E2E_MESSAGE); } if($parameters['service']==='log'){ nv(); mv('Logs enabled',E2E_MESSAGE); } if($parameters['service']==='backup'){ } if($parameters['service']==='migrate'){ qn(); mv('Database structure up to date',E2E_MESSAGE); } if(E2_EDITION){ if($parameters['service']==='verify'){ u(true); } } c(jv('e2m_underhood')); } function h3($tv){ include_once 'neasden/neasden.php'; $Nn=new Neasden; $Nn->profile_name='kavychki'; return$Nn->format($tv); } function g3($ly,$tv,$eq){ include_once 'neasden/neasden.php'; if ($tv==='') return array (); if ($ly=='calliope'){ preg_match_all('/\(\(([^ ]*)( |\)\))/',$tv,$y3); return $y3[1]; } elseif ($ly=='neasden'){ $Nn=new Neasden; $Nn->profile_name=$eq; $Nn->format($tv); return$Nn->resources_detected; } else { return array (); } } function w3(){ return '<div class="foot" style="color: var(--errorColor); font-style: italic">This text was created with a very old version of Aegea that used a formatter called Calliope. It is no longer included with Aegea&nbsp;2.10.</div><div class="foot" style="color: var(--errorColor); font-style: italic">Edit this note to switch it and its comments to the current formatter, Neasden. If anything breaks, edit again to fix.</div><div class="foot" style="color: var(--errorColor); font-style: italic">To temporarily install Calliope, get the directory <tt>/system/calliope/</tt> from Aegea&nbsp;2.9 and copy it to your <tt>/user/calliope/</tt>. This will not work with Aegea&nbsp;2.11. See release notes for Aegea&nbsp;2.10 for details.</div>'; } function u3($ly,$tv,$eq){ include_once 'neasden/neasden.php'; if(Log::$cy)__log('Format: format with formatter "'. $ly .'" in context "'. $eq.'"'); if ($ly=='calliope'){ $tv=pv($tv); $tv=o3($tv,$eq); $meta=array(); $tv=vb($tv); $tv='<div class="e2-text-calliope-formatted">'. h3($tv) .'</div>'; } elseif ($ly=='neasden'){ $Nn=new Neasden; $Nn->profile_name=$eq; $tv=$Nn->format($tv); $meta=array ( 'links-required' => $Nn->links_required, 'resources-detected' => $Nn->resources_detected ); } return array ( 'text-final' => $tv, 'meta' => $meta, ); } function i3($tv,$eq){ global$_config; return u3($_config['default_formatter'],$tv,$eq); } function o3($tv,$eq){ global$_config,$settings,$full_blog_url,$_template; @ (list ($eq,$rq)=explode('|',$eq)); if (!is_file(USER_FOLDER.'calliope/WikiFormatter.php')) { return w3(); } require_once USER_FOLDER.'calliope/WikiFormatter.php'; if ('full'==$eq)$tq=WF_FULL_MODE; elseif ('full-rss'==$eq)$tq=WF_FULL_MODE; elseif ('simple'==$eq)$tq=WF_SIMPLE_MODE; elseif ('simple-rss'==$eq)$tq=WF_SIMPLE_MODE; else return $tv; $jq=new WikiFormatter(); $jq -> replace=array ( '/' => 'i', '+' => 'small', '-' => 's', '*' => 'b', '^' => 'sup', 'v' => 'sub', '#' => 'tt', '!' => 'blockquote', ); $jq -> settings=array ( 'hrefSize' => 100, 'localImgDir' => $full_blog_url .'/'. PICTURES_FOLDER, 'maxImgWidth' => $_template['max_image_width'], 'mode' => $tq, 'enableShrinkLongHref' => 1, 'enableHr' => 0, 'enableBr' => 1, 'enableHeaders' => 1, 'headersStartWith' => 1, 'enableTables' => 1, 'simpleTableCSSClass' => 'e2-text-table', 'enableAutoAcronymEngine' => 0, 'enableAcronym' => 0, 'acronymBase' => '', 'enableList' => 1, 'mailSafe' => "<a href=\"\" onmouseover=\"this.href='mailto:'+{email}\">{icon}<script language=\"JavaScript\">document.write({name});</script></a>", 'ljUserTag' => '<a href="http://livejournal.com/users/{name}/">{name}</a>', 'fullVersionURL' => $rq, 'enableTagIcons' => 0, 'outerUrlInNewWindow' => 0, 'lineBreak' => "\n", 'extLinkHrefPrefix' => '', ); $tv=$jq -> Wiki2HTML($tv); return $tv; } function p3($sm,$hq=false){ if(Log::$cy)__log('Spawn: Curl '. $sm .' using '. ($hq? 'post':'get') .'...'); if(function_exists('curl_init')) { $gq=curl_init(); $wq=!ini_get('open_basedir'); curl_setopt_array($gq, array ( CURLOPT_URL => $sm, CURLOPT_POST => $hq, CURLOPT_CONNECTTIMEOUT => 300, CURLOPT_TIMEOUT => 1, CURLOPT_MAXREDIRS => 1, CURLOPT_COOKIE => r2(), CURLOPT_SSL_VERIFYPEER => false, CURLOPT_FOLLOWLOCATION => $wq, CURLOPT_RETURNTRANSFER => true, CURLOPT_AUTOREFERER => true, CURLOPT_USERAGENT => E2_UA_STRING, )); $content=curl_exec($gq); $uq=curl_errno($gq); $iq=curl_error($gq); $oq=curl_getinfo($gq); curl_close($gq); if(Log::$cy)__log('Spawn: Curl returns: ['. print_r($oq,true) .'] ['. $content .'], (errno='. $uq .', errstr='. $iq .')...'); } else { if(Log::$cy)__log('Spawn: Curl functions are not available'); } } function cy($pq){ global$_config; if (@$_config['broadcast_url'] and !$pq['IsExternal']) { if($_config['log_broadcast']) { Log::$cy=true; if(Log::$cy)bv('broadcast'); } if(Log::$cy)__log('Broadcast-async note: '. $pq['Title']); $sm=jv('e2m_note_broadcast', array ('*note' => $pq)); if(Log::$cy)__log('Broadcast will spawn url: '. $sm); p3($sm); } } function vy($cl){ global$_config; if (!$cl) return false; $sm=$_config['broadcast_url']; $sm.='?src='. urlencode($cl); if($_config['log_broadcast']) { Log::$cy=true; if(Log::$cy)bv('broadcast'); } if(Log::$cy)__log('Broadcast: Curl '. $sm .'...'); if(function_exists('curl_init')) { $gq=curl_init(); $wq=!ini_get('open_basedir'); curl_setopt_array($gq, array ( CURLOPT_URL => $sm, CURLOPT_CONNECTTIMEOUT => 300, CURLOPT_TIMEOUT => 1, CURLOPT_MAXREDIRS => 1, CURLOPT_COOKIE => r2(), CURLOPT_SSL_VERIFYPEER => false, CURLOPT_FOLLOWLOCATION => $wq, CURLOPT_RETURNTRANSFER => true, CURLOPT_AUTOREFERER => true, CURLOPT_USERAGENT => E2_UA_STRING, )); $content=curl_exec($gq); $uq=curl_errno($gq); $iq=curl_error($gq); $oq=curl_getinfo($gq); curl_close($gq); if(Log::$cy)__log('Broadcast: Curl returns: ['. print_r($oq,true) .'] ['. $content .'], (errno='. $uq .', errstr='. $iq .')...'); if ($uq===0) return true; } else { if(Log::$cy)__log('Spawn: Curl functions are not available'); } return false; } function by($pq){ if (!$pq) return false; $cl=jv('e2m_note_json', array ('*note' => $pq)); return vy($cl); } function e2m_note_broadcast($parameters=array ()) { global$_config; if (@$_config['broadcast_url']) { if(array_key_exists('*note',$parameters)) { $cl=jv('e2m_note_json', array ('*note' => $parameters['*note'])); } elseif(array_key_exists('alias',$parameters)) { $cl=jv('e2m_note_json', array ('alias' => $parameters['alias'])); } if (vy($cl)) { die ('Broadcasted.'); } else { die ('Could not broadcast.'); } } else { return e2_error404_mode(); } } function e2m_timezone(){ global$_strings,$settings; $vl=array ( 'form-action' => jv('e2s_select_timezone'), 'submit-text' => $_strings['fb--select'], 'timezone-selector' => fy($settings['timezone']['offset'],1), 'dst?' => $settings['timezone']['is_dst'], ); return array ( 'title' => $_strings['pt--default-timezone'], 'heading' => $_strings['pt--default-timezone'], 'form' => 'form-timezone', 'form-timezone' => $vl, ); } function yy(){ global$_strings; $bl=array ( -720 => '', -660 => '', -600 => '', -540 => '', -480 => $_strings['tt--zone-pt'], -420 => $_strings['tt--zone-mt'], -360 => $_strings['tt--zone-ct'], -300 => $_strings['tt--zone-et'], -240 => '', -210 => '', -180 => '', -120 => '', -60 => '', 0 => $_strings['tt--zone-gmt'], 60 => $_strings['tt--zone-cet'], 120 => $_strings['tt--zone-eet'], 180 => '', 210 => '', 240 => $_strings['tt--zone-msk'], 270 => '', 300 => '', 330 => '', 345 => '', 360 => $_strings['tt--zone-ekt'], 390 => '', 420 => '', 480 => '', 540 => '', 570 => '', 600 => '', 660 => '', 720 => '', 780 => '', 840 => '', ); return $bl; } function ny($yl){ $bl=yy(); return @$bl[(int)$yl/SECONDS_IN_A_MINUTE]; } function my($yl){ $nl='+'; if ($yl < 0)$nl='&ndash;'; $ml=str_pad((int) (abs($yl)/3600),2,'0',STR_PAD_LEFT); $fl=str_pad(abs($yl)/60 % 60,2,'0',STR_PAD_LEFT); return 'GMT'. $nl.$ml .':'. $fl; } function fy($dl,$sl=''){ global$_strings; $bl=yy(); $d=''; if (!$sl)$sl=count($bl); $d.='<select class="e2-select" name="offset" size="'. $sl .'">'; foreach ($bl as $yl => $al){ $ql=''; if ($yl*SECONDS_IN_A_MINUTE==$dl)$ql=' selected="selected"'; $d.='<option'. $ql .' value="'.$yl.'">'; $nl=''; if ($yl < 0)$nl='−'; if ($yl > 0)$nl='+'; $ml=(int) (abs($yl*SECONDS_IN_A_MINUTE)/3600); $fl=(int) (abs($yl*SECONDS_IN_A_MINUTE)/60 % 60); if ($ml){ $d .= ( $nl .' '. $ml .' '. $_strings['gs--timezone-offset-hours'] .' '. ($fl? ($fl .' '. $_strings['gs--timezone-offset-minutes']) : '') ); if ($al){ $d .= ' ('. $al. ')'; } } else { $d .= $al; } $d.='</option>'; } $d.='</select>'; return $d; } function e2s_select_timezone(){ global$settings,$_strings; if (@$_POST['offset'] >= -720 and @$_POST['offset'] <= 780){ $settings['timezone']['offset'] = @$_POST['offset']*SECONDS_IN_A_MINUTE; $settings['timezone']['is_dst'] = isset ($_POST['is_dst']); } if (!@n3(USER_FOLDER.'settings.json',json_encode($settings,E2_JSON_STYLE))) { mv($_strings['er--settings-not-saved'],E2E_PERMISSIONS_ERROR); c(jv('e2m_timezone')); } c(jv('e2m_settings')); } function dy($l2){ return array ( 'offset' => (int)$l2['Offset'], 'is_dst' => (bool)$l2['IsDST'], ); } function sy(){ return array ( 'offset' => 0, 'is_dst' => false, ); } function ay(){ global$settings; if(array_key_exists('timezone',$settings)) { return$settings['timezone']; } else { return sy(); } } function qy($ll,$zl){ if (@$ll['is_dst']) { $kl=(int)date('I',$zl); $xl=date('Z',$zl)-$kl*SECONDS_IN_AN_HOUR; $el=$ll['offset']; $rl=$el-$xl; $tl=date('I',$zl+$rl); return $tl; } else { return 0; } } function ly($ll,$zl){ global$settings; if ($ll and is_array($ll)) { return ( $ll['offset'] + qy($ll,$zl)*SECONDS_IN_AN_HOUR ); } } function zy($zl){ return ly(ay(),$zl); } function ky($jl,$qv,$ll){ return gmdate($jl,$qv+ly($ll,$qv)); } function xy($jl,$qv){ return ky($jl,$qv,ay()); } function ey($hb,$jb=false,$tb=false){ if(is_numeric($tb)) { $hl=gmmktime(0,0,0,$jb,$tb,$hb); $gl=gmmktime(0,0,0,$jb,$tb+1,$hb)-1; } elseif(is_numeric($jb)) { $hl=gmmktime(0,0,0,$jb,1,$hb); $gl=gmmktime(0,0,0,$jb+1,1,$hb)-1; } else { $hl=gmmktime(0,0,0,1,1,$hb); $gl=gmmktime(0,0,0,1,1,$hb+1)-1; } return array ($hl,$gl); } function ry($ll,$hb,$jb=false,$tb=false){ list ($hl,$gl)=ey($hb,$jb,$tb); $hl -= ly($ll,$hl); $gl -= ly($ll,$gl); return array ($hl,$gl); } function ty($hb,$jb=false,$tb=false){ return ry(ay(),$hb,$jb,$tb); } function jy($hb,$jb=false,$tb=false){ $wl=13; $ul=-12; $wl+=1; $ul -= 1; list ($hl,$gl)=ey($hb,$jb,$tb); $hl -= $wl*3600; $gl -= $ul*3600; return array ($hl,$gl); } function hy($yl){ if ((int) @$yl > 0) return (string)'+'.abs(@$yl); elseif ((int) @$yl < 0) return (string)'-'.abs(@$yl); else return ''; } function gy($zl,$il=''){ $ol=zy($zl); $nl=($ol >= 0)?'+':'-'; $ol=abs($ol); $pl=$ol % 60; $ol -= $pl; $jb=$ol % 3600/60; $ol -= $jb*60; $c4=$ol/3600; if ($c4 < 10)$c4='0'.$c4; if ($jb < 10)$jb='0'.$jb; return $nl.$c4.$il.$jb; } function wy($v4){ global$settings; if(is_numeric($v4)) { $q1['offset']=SECONDS_IN_A_MINUTE*$v4; $q1['is_dst']=false; $b4=SECONDS_IN_A_MINUTE*$v4-SECONDS_IN_AN_HOUR; $y4=array ('offset' => $b4,'is_dst' => true); $y4=(int)ly($y4,time()); if ($q1['offset']==$y4){ $q1['offset']=$b4; $q1['is_dst']=true; } } else { if(array_key_exists('timezone',$settings)) { $q1=$settings['timezone']; } else { $q1['offset']=0; $q1['is_dst']=false; } } return $q1; } function uy($n4){ $c4=xy('H',$n4); if ($c4 <= 4) return 4; elseif ($c4 <= 10) return 1; elseif ($c4 <= 16) return 2; elseif ($c4 <= 22) return 3; else return 4; } function iy($m4,$f4=null){ global$_strings; if ($f4===null)$f4=ay(); $d4=ky('d.m.Y',$rb,$f4); $s4=ky('d.m.Y',$m4,$f4); $a4=SECONDS_IN_A_MINUTE; $q4=SECONDS_IN_AN_HOUR; $rb=time(); $l4=uy($rb); $z4=uy($m4); $kb=$rb-$m4; if ($kb < 0) return$_strings['tt--from-the-future']; if ($kb >= 0 and $kb < 54) return$_strings['tt--just-now']; if ($kb >= 54 and $kb < 108) return$_strings['tt--one-minute-ago']; $k4=$kb+12; $x4=floor($k4/$a4); if ($kb >= 108 and $kb < 54*$a4) return e2l_get_string( 'tt--minutes-ago', array ('minutes' => $x4) ); if ($kb >= 54*$a4 and $kb < 108*$a4) return$_strings['tt--one-hour-ago']; $k4=$kb+12*$a4; $e4=floor($k4/$q4); if ($kb >= 108*$a4 and $kb < 4*$q4) return e2l_get_string( 'tt--hours-ago', array ('hours' => $e4) ); $r4=ky('G:i',$m4,$f4); if ($kb >= 4*$q4 and $l4 > $z4 and $d4==$s4){ return$_strings['tt--today']; } if ((($rb-$m4) <= 7884000)) { return e2l_get_string( 'tt--date', array ( 'day' => ky('j',$m4,$f4), 'month' => ky('m',$m4,$f4), ) ); } return ky('Y',$m4,$f4); } function oy($m4,$f4=null){ global$_strings; $kb=time()-$m4; if ($kb < 0) return$_strings['tt--from-the-future']; if ($kb==0) return$_strings['tt--now']; $t4=array ( array (1,'tt--seconds-short'), array (SECONDS_IN_A_MINUTE,'tt--minutes-short'), array (SECONDS_IN_AN_HOUR,'tt--hours-short'), array (SECONDS_IN_A_DAY,'tt--days-short'), array (SECONDS_IN_A_MONTH,'tt--months-short'), array (SECONDS_IN_A_YEAR,'tt--years-short'), array (SECONDS_IN_A_YEAR+SECONDS_IN_A_MONTH,''), ); for ($r=0; $r < count($t4); ++ $r){ if ($kb >= $t4[$r][0] and $kb < $t4[$r+1][0]) { return e2l_get_string( $t4[$r][1], array ('value' => floor($kb/$t4[$r][0])) ); } } if ($f4===null)$f4=ay(); return ky('Y',$m4,$f4); } $_model_contractions=[ 'key' => "INT UNSIGNED AUTO_INCREMENT PRIMARY KEY", 'pkey' => "INT UNSIGNED DEFAULT '0' NOT NULL", 'pkey1' => "INT UNSIGNED DEFAULT '1' NOT NULL", 'int' => "INT DEFAULT '0' NOT NULL", 'uint' => "INT UNSIGNED DEFAULT '0' NOT NULL", 'time' => "INT UNSIGNED DEFAULT '0' NOT NULL", '0' => "TINYINT(1) DEFAULT '0' NOT NULL", '1' => "TINYINT(1) DEFAULT '1' NOT NULL", 'v1' => "VARCHAR(1) DEFAULT '' NOT NULL", 'v8' => "VARCHAR(8) DEFAULT '' NOT NULL", 'v15' => "VARCHAR(15) DEFAULT '' NOT NULL", 'v32' => "VARCHAR(32) DEFAULT '' NOT NULL", 'v39' => "VARCHAR(39) DEFAULT '' NOT NULL", 'v64' => "VARCHAR(64) DEFAULT '' NOT NULL", 'fid' => "VARCHAR(32) DEFAULT '". $_config['default_formatter'] ."' NOT NULL", 'v255' => "VARCHAR(255) DEFAULT '' NOT NULL", 'text' => "MEDIUMTEXT", ]; $_model=[ 'Actions' => [ ['ID', 'key'], ['SubsetID', 'pkey1'], ['EntityID', 'pkey'], ['Stamp', 'time'], ['ReadCount', 'int'], ], 'Aliases' => [ ['ID', 'key'], ['SubsetID', 'pkey1'], ['EntityType', 'v1'], ['EntityID', 'pkey'], ['Alias', 'v64'], ['Stamp', 'time'], ], 'Comments' => [ ['ID', 'key'], ['SubsetID', 'pkey1'], ['NoteID', 'pkey'], ['AuthorName', 'v255'], ['AuthorEmail', 'v255'], ['Text', 'text'], ['Reply', 'text'], ['IsVisible', '1'], ['IsFavourite', '0'], ['IsReplyVisible', '0'], ['IsReplyFavourite', '0'], ['IsAnswerAware', '1'], ['IsSubscriber', '0'], ['IsSpamSuspect', '0'], ['IsNew', '0'], ['Stamp', 'time'], ['LastModified', 'time'], ['ReplyStamp', 'time'], ['ReplyLastModified', 'time'], ['IP', 'v39'], ['IsGIPUsed', '0'], ['GIP', 'v15'], ['GIPAuthorID', 'v64'], ], 'GIPsSessions' => [ ['ID', 'key'], ['SubsetID', 'pkey1'], ['GIP', 'v15'], ['GIPAuthorID', 'v64'], ['AuthorName', 'v255'], ['AuthorEmail', 'v255'], ['AuthorProfileLink', 'v255'], ['SessionToken', 'v255'], ['Stamp', 'time'], ], 'Keywords' => [ ['ID', 'key'], ['SubsetID', 'pkey1'], ['Keyword', 'v255'], ['OriginalAlias', 'v64'], ['PageTitle', 'v255'], ['Description', 'text'], ['Summary', 'text'], ['Uploads', 'text'], ['IsVisible', '1'], ['IsFavourite', '0'], ], 'Notes' => [ ['ID', 'key'], ['SubsetID', 'pkey1'], ['Title', 'v255'], ['Text', 'text'], ['Summary', 'text'], ['FormatterID', 'fid'], ['OriginalAlias', 'v64'], ['Uploads', 'text'], ['IsPublished', '0'], ['IsCommentable', '0'], ['IsVisible', '1'], ['IsFavourite', '0'], ['Stamp', 'time'], ['LastModified', 'time'], ['Offset', 'int'], ['IsDST', '0'], ['IsIndexed', '0'], ['IsExternal', '0'], ['ReadCount', 'uint'], ['SourceID', 'pkey'], ['SourceNoteID', 'pkey'], ['SourceNoteURL', 'v255'], ['SourceNoteJSONURL', 'v255'], ['SourceNoteData', 'text'], ], 'NotesKeywords' => [ ['ID', 'key'], ['SubsetID', 'pkey1'], ['NoteID', 'pkey'], ['KeywordID', 'pkey'], ], 'Sources' => [ ['ID', 'key'], ['SubsetID', 'pkey1'], ['TrueID', 'pkey'], ['Title', 'v255'], ['AuthorName', 'v255'], ['URL', 'v255'], ['PictureURL', 'v255'], ['IsWhiteListed', '0'], ['IsTrusted', '0'], ], ]; $_model_indexes_create_sql=[ 'index' => 'INDEX', 'unique' => 'UNIQUE INDEX', 'fulltext' => 'FULLTEXT', ]; $_model_indexes_check_sql=[ 'index' => 'KEY', 'unique' => 'UNIQUE KEY', 'fulltext' => 'FULLTEXT KEY', ]; $_model_indexes=[ 'Actions' => [ ['unique', ['EntityID','Stamp']], ['index', ['SubsetID']], ], 'Aliases' => [ ['index', ['SubsetID']], ['index', ['Alias']], ['index', ['EntityID']], ], 'Comments' => [ ['index', ['SubsetID']], ['index', ['NoteID']], ], 'GIPsSessions' => [ ['unique', ['GIP','GIPAuthorID']], ['index', ['SubsetID']], ], 'Keywords' => [ ['index', ['SubsetID']], ], 'Notes' => [ ['fulltext', ['Title','Text']], ['index', ['SubsetID']], ['index', ['Stamp']], ['index', ['SourceID']], ['index', ['SourceNoteID']], ], 'NotesKeywords' => [ ['index', ['SubsetID']], ['index', ['NoteID']], ], 'Sources' => [ ['index', ['SubsetID']], ], ]; $_model_minimal_table_list=[ 'Comments', 'Keywords', 'Notes', 'NotesKeywords', ]; function e2_model_data_check($j4){ global$_db,$_model,$_model_minimal_table_list,$_config; $h4=false; $g4=array(); $sql='SHOW TABLES FROM `'. mysqli_real_escape_string($_db['link'],$j4). '`'; $q1=mysqli_query($_db['link'],$sql); if ($q1){ while ($w4=mysqli_fetch_row($q1)) { foreach(array_keys($_model) as $u4){ if(strcasecmp($w4[0],$_config['db_table_prefix'].$u4)===0){ $h4=true; $g4[] = $u4; } } } } $i4=true; foreach(array_keys($_model) as $u4){ if (!in_array($u4,$g4)) { $i4=false; } } $o4=true; foreach($_model_minimal_table_list as $u4){ if (!in_array($u4,$g4)) { $o4=false; } } return array ( 'occupied' => $h4, 'complete' => $i4, 'migrateable' => $o4, ); } function py($p4,$cz,$vz){ global $bz; if (($yz=mysqli_connect($p4,$cz,$vz)) === false) return []; $nz=[]; $mz=[ 'information_schema', 'performance_schema', 'sys', 'mysql' ]; @$bz ++; $bf='SHOW DATABASES'; if(Log::$cy)__log('DB ['. $bz .']: '. $bf); $q1=mysqli_query($yz,$bf); while ($w4=mysqli_fetch_row($q1)) { if(mysqli_select_db($yz,$w4[0]) and !in_array($w4[0],$mz)) { $nz[] = $w4[0]; } } return $nz; } function cn($fz){ global$_config; kn( "SHOW TABLES LIKE '". $_config['db_table_prefix'].$fz . "'" ); $sy=xn(); return count($sy) > 0; } function vn($fz,$dz=null){ global$_config; if ($dz===null){ $dz=$_config['db_table_prefix']; } kn( "SHOW TABLE STATUS LIKE '". $dz.$fz . "'" ); $q1=xn(); return $q1?$q1[0] : []; } function bn($fz){ global $_model, $_model_contractions, $_model_indexes, $_model_indexes_check_sql, $_config, $_db; if (!array_key_exists($fz,$_model)) throw new AeModelUnknownTableException(); if (cn($fz)) return; $dz=$_config['db_table_prefix']; $sz=[]; foreach($_model[$fz] as $az){ list ($name,$type)=$az; $sz[] = "`". $name ."` ". $_model_contractions[$type]; } if(is_array(@$_model_indexes[$fz])) { foreach($_model_indexes[$fz] as $qz){ $lz=$_model_indexes_check_sql[$qz[0]] . ' (`'. implode('`, `',$qz[1]) .'`)'; $sz[] = $lz; } } $sql=( "CREATE TABLE `". $dz.$fz ."` ". "(". implode(", ",$sz) .") ". "ENGINE=InnoDB DEFAULT CHARSET=". $_db['charset'] ); kn($sql); } function yn($fz,$t1,$zz='INSERT',$kz=''){ global$_config,$_db; $xz['SubsetID']=$_config['db_table_subset']; foreach ($t1 as $t => $xf){ $xz[$t]="'". en($xf) ."'"; } $ez="`". implode("`, `",array_keys($xz)). "`"; $rz=implode(", ",array_values($xz)); kn( $zz ." INTO `". $_config['db_table_prefix'].$fz ."` ". "(".$ez .") VALUES (". $rz .")". ($kz? (' '. $kz):'') ); $t1['ID']=mysqli_insert_id($_db['link']); return $t1; } function nn($fz,$t1,$tz=false,$jz=false){ global$_config; if(Log::$cy)__log('Model: update record in table '. $fz .' {'); $hz=array(); foreach(e2model__soft_fields_for_table_($fz) as $gz){ if(array_key_exists($gz,$t1)) { $hz[] = '`'. $gz .'`'."='". en($t1[$gz]) ."'"; } } $wz=array(); if(is_array($tz)) { foreach(e2model__soft_fields_for_table_($fz) as $gz){ if(array_key_exists($gz,$tz)) { $wz[] = '`'. $gz .'`'."='". en($tz[$gz]) ."'"; } } } if(count($wz)) { $b=implode(" AND ",$wz); } else { if (!array_key_exists('ID',$t1) or !is_numeric($t1['ID'])) { if(Log::$cy)__log('Error: e2_update_record must be called with an ID field in $record when updating single row'); return false; } $b="`ID`=". $t1['ID']; } if(count($hz) > 0){ $uz=$jz? 'LOW_PRIORITY ':''; kn( "UPDATE ". $uz ."`". $_config['db_table_prefix'].$fz ."` ". "SET ". implode(', ',$hz) ." ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND (". $b .")" ); } if(Log::$cy)__log('}'); return true; } function e2model__soft_fields_for_table_($fz){ global$_model; $d=array(); if(array_key_exists($fz,$_model)) { foreach($_model[$fz] as $gz){ if (!in_array($gz[1], array ('key'))) { $d[] = $gz[0]; } } } return $d; } function e2m_install(){ global$_strings,$_superconfig,$_files_written,$_diagnose; if (fn_()!==null)c(); qs(DEFAULT_TEMPLATE); $d=array(); if($_superconfig['disallow_installer']) { die ('Installer disabled by superconfig'); } if(Log::$cy)__log('Installer: not installed, present user with form'); $iz=true; $oz['server'] = @$_COOKIE[b('install_db_server')]; $oz['user_name'] = @$_COOKIE[b('install_db_user_name')]; $oz['passw']=i2(@$_COOKIE[b('install_db_passw')]); $oz['name'] = @$_COOKIE[b('install_db_name')]; if (!@isset ($_diagnose['ok?']))fv(); if (!$_diagnose['ok?']) { if(Log::$cy)__log('Installer: problems, tell user'); $iz=false; } $d=[ 'title' => $_strings['pt--install'], 'heading' => $_strings['pt--install'], 'form-install' => [ 'form-action' => jv('e2s_install'), 'form-check-db-config-action' => jv('e2j_check_db_config'), 'form-list-databases-action' => jv('e2j_list_databases'), 'installation-possible?' => $iz, 'submit-text' => $_strings['fb--begin'], 'retry-href' => jv('e2m_install'), 'retry-text' => $_strings['fb--retry'], 'db-server' => htmlspecialchars(@$oz['server']? $oz['server']:'localhost'), 'db-user' => htmlspecialchars(@$oz['user_name']? $oz['user_name']:'root'), 'db-password' => '', 'db-database' => htmlspecialchars(@$oz['name']), ] ]; return $d; } function fn_(){ static $pz=null; if ($pz===null){ $pz=@unserialize( @file_get_contents(USER_FOLDER.'instance.psa') ) or $pz=null; } return $pz; } function dn($ck){ static $pz=null; $pz=fn_(); $pz['version']=$ck; if (n3(USER_FOLDER. '/instance.psa',serialize($pz))) { return $pz; } else { die ('Cannot instantiate v'. $ck .': probably permission denied'); } } function e2s_instantiate($parameters){ global$_strings; if (fn_()!==null){ die ('Remove the file "'. USER_FOLDER .'instance.psa" first'); } else { if(is_numeric($parameters['version'])) { if (dn($parameters['version'])) { mv($_strings['gs--instantiated-version'] .' v'. $parameters['version'],E2E_MESSAGE); c(jv('e2m_frontpage', array ('page' => 1))); } } } die ('Could not create instance of engine'); } function e2_install($lv){ global$_folders_written,$_model,$_strings,$_config,$settings; if (fn_()!==null){ throw new AeInstallAlreadyInstalledException('Instance already created'); } if($_config['log_installs']) { Log::$cy=true; if(Log::$cy)bv('install-$'); } if(Log::$cy)__log('Installer: force directories'); foreach($_folders_written as $vk){ @j($vk); } if(Log::$cy)__log('Installer: write password hash'); if (!@n3(USER_FOLDER.'password-hash.psa',serialize(sha1($lv['password'])))) { throw new AePasswordHashNotSavedException; } if(array_key_exists('plain_password',$lv['db_params'])) { $lv['db_params']['passw']=u2($lv['db_params']['plain_password']); unset ($lv['db_params']['plain_password']); } $settings['db']=$lv['db_params']; $settings['template']=DEFAULT_TEMPLATE; $settings['language']=DEFAULT_LANGUAGE; zn('check database during installation',$lv['db_params']); $o3=e2_model_data_check($lv['db_params']['name']); $bk=false; if ($o3['occupied']) { if ($o3['migrateable'] and $lv['allow_migration']) { $bk=true; if(Log::$cy)__log('Installer: data exists and migrateable'); } else { if(Log::$cy)__log('Installer: incomplete data in the database'); throw new AeInstallDatabaseOccupiedException('Database already has some data'); } } if ($bk){ if(Log::$cy)__log('Installer: no need to create tables, will migrate'); try { qn(); } catch (AeMySQLException $e){ kv($e,'Could not migrate'); mv($_strings['er--double-check-db-params']); } } else { if(Log::$cy)__log('Installer: create tables'); foreach(array_keys($_model) as $fz){ bn($fz); } } if(Log::$cy)__log('Installer: write settings'); if (!@n3(USER_FOLDER.'settings.json',json_encode($settings,E2_JSON_STYLE))) { throw new AeSettingsNotSavedException; } e2_drop_all_kinds_of_cache(); if(Log::$cy)__log('Installer: search index'); $p3=ea(); try { $p3 -> erase(); } catch (\S2\Rose\Exception\RuntimeException $e){ if(Log::$cy)__log('Installer: Rose not available'); } aa(); if(Log::$cy)__log('Installer: instantiate'); dn(E2_VERSION); if(Log::$cy)__log('Installer: complete'); } function sn(){ $u3['server']=$u3['user_name'] = $u3['passw']=$u3['name']=''; if(array_key_exists('db-server',$_POST)) $u3['server']=$_POST['db-server']; if(array_key_exists('db-user',$_POST)) $u3['user_name']=$_POST['db-user']; if(array_key_exists('db-password',$_POST))$u3['passw']=$_POST['db-password']; if(array_key_exists('db-database',$_POST))$u3['name']=$_POST['db-database']; return $u3; } function e2s_install(){ global$_strings,$_config,$_db; if (fn_()!==null)c(); $u3=sn(); foreach ($u3 as $t => $xf){ y('install_db_'. $t,$xf); } if (!array_key_exists('password',$_POST) or trim($_POST['password']) == ''){ mv($_strings['er--no-password-entered'],E2E_USER_ERROR); c(jv('e2m_install')); } $yk=trim($_POST['password']); @session_start(); $i3=false; try { e2_install([ 'allow_migration' => true, 'password' => $yk, 'db_params' => $u3, ]); $i3=true; } catch (AeMySQLCannotConnectException $e){ mv( $_strings['er--cannot-connect-to-db']. ':<br />'. mysqli_connect_error() .' ('. mysqli_connect_errno() .')' ); } catch (AeMySQLTooOldException $e){ mv(e2l_get_string('er--mysql-version-too-old', [ 'v1' => $_db['version'], 'v2' => E2_MINIMUM_MYSQL, ])); } catch (AeMySQLException $e){ mv($_strings['er--cannot-find-db'] .' '. $u3['name']); } catch (AeInstallDatabaseOccupiedException $e){ mv($_strings['er--db-data-incomplete-install']); } catch (AeNotSavedException $e){ mv($_strings['er--settings-not-saved'],E2E_PERMISSIONS_ERROR); } catch (AeInstallException $e){ } if (!$i3)c(jv('e2m_install')); $nk['sessions'] = [[ 'stamp' => time(), 'remote_ip' => q2(), 'key_hash' => z2(true), 'ua' => $_SERVER['HTTP_USER_AGENT'], ]]; if (!e2_($nk)) { mv($_strings['er--cannot-write-auth-data'],E2E_PERMISSIONS_ERROR); } p3(jv('e2s_bsi_step', array ())); c(); } function an(){ global $v,$c,$_superconfig,$_config; $pz=fn_(); if (fn_()!==null){ if(E2_VERSION < $pz ['version']) { if (@$_config['dev_ignore_version_mismatch']) return; if(Log::$cy)__log('Installer: cannot downdate'); header('HTTP/1.1 503 Service Unavailable'); die ('E2 does not support automatic downgrade.'); } elseif(E2_VERSION > $pz ['version']) { if(Log::$cy)__log('Installer: need to update'); header('Location: http://'. $v.$c .'/perform_update/'); header('Location: '. jv('e2s_update_perform')); die; } else { return; } } if(Log::$cy)__log('Installer: not installed {'); if ((strpos($_SERVER['SERVER_SOFTWARE'],'Apache')===0)) { if(Log::$cy)__log('Installer: running on Apache'); $mk=DEFAULTS_FOLDER.'default.htaccess'; $fk=false; if (!is_file($mk)) { echo 'File not found: '.$mk. '. Please use the full E2 installation package.'; die; } if(is_file('.htaccess')) { if(Log::$cy)__log('Installer: there is a .htaccess file in the installation directory'); $dk=file_get_contents($mk); $sk=file_get_contents('.htaccess'); if ($sk!=$dk){ $fk=true; $ak=$qk='.htaccess.old'; $lk=1; while (is_file($qk)) { $qk=$ak .'.'. $lk ++; } if(Log::$cy)__log('Installer: existing .htaccess wrong, backing up as <'. $qk .'>'); if (!@rename('.htaccess',$qk)) { if(Log::$cy)__log('Installer: fuck'); echo 'Looks like you are using Apache and have put an incorrect ".htaccess" file in the installation directory. Additionally, the installer was not able to back up your existing ".htaccess" file in order to replace it with the correct one. Please use the full E2 installation package and grant write access on the installation target directory, all the files and subdirectories.'; die; } } } else { $fk=true; } if ($fk){ if(Log::$cy)__log('Installer: writing a correct .htaccess file'); if (!@copy($mk,'.htaccess')) { if(Log::$cy)__log('Installer: fuck'); echo 'The installer was not able to create a correct ".htaccess" file. Please grant write access on the installation target directory.'; die; } } } if($_superconfig['disallow_installer']) { if(Log::$cy)__log('Installer: disallowed in superconfig'); xv(new AeNotAndCannotBeInstalledException); } else { $zk=jv('e2m_install'); if(Log::$cy)__log('Installer: will need to install, going to '. $zk); if(Log::$cy)__log('}'); c($zk); } } function e2j_check_db_config(){ global$_db,$_strings; $u3=sn(); $zv=[ 'success' => true, 'data' => [ 'message' => '', 'db-responding' => false, 'db-connected' => false, 'db-found' => false, 'db-compatible' => false, 'db-occupied' => false, 'db-migrateable' => false, ] ]; try { $u3['passw']=u2($u3['passw']); zn('connect to check DB config (try 1)',$u3); } catch (AeMySQLAccessDeniedException $e){ $zv['data']['db-responding']=true; $zv=json_encode($zv); die ($zv); } catch (AeMySQLCannotConnectException $e){ $zv['data']['message']='no-connect'; $zv=json_encode($zv); die ($zv); } catch (AeMySQLTooOldException $e){ $zv['data']['db-responding']=true; $zv['data']['db-connected']=true; $zv['data']['message']=e2l_get_string('er--mysql-version-too-old', [ 'v1' => $_db['version'], 'v2' => E2_MINIMUM_MYSQL, ]); $zv=json_encode($zv); die ($zv); } catch (AeMySQLNotFoundException $e){ $zv['data']['db-responding']=true; $zv['data']['db-connected']=true; if ($u3['name']) { $zv=json_encode($zv); die ($zv); } else { $nz=py( $u3['server'],$u3['user_name'],$u3['passw'] ); if(count($nz) > 0){ $zv['data']['db-found']=true; $u3['name']=$nz[0]; } else { $zv=json_encode($zv); die ($zv); } } } $zv['data']['db-responding']=true; $zv['data']['db-connected']=true; $zv['data']['db-found']=true; $zv['data']['db-compatible']=true; try { zn('connect to check DB config (try 2)',$u3); } catch (AeMySQLException $e){ $zv=json_encode($zv); die ($zv); } $zv['data']['db-good']=true; $o3=e2_model_data_check($u3['name']); if ($o3['occupied']) { if ($o3['migrateable']) { $zv['data']['message']=$_strings['gs--data-exists']; } else { $zv['data']['db-good']=false; $zv['data']['message']=$_strings['er--db-data-incomplete-install']; } } $zv=json_encode($zv); die ($zv); } function e2j_list_databases(){ $u3=sn(); $nz=py( $u3['server'],$u3['user_name'],$u3['passw'] ); $zv=[ 'success' => true, 'data' => [ 'databases-list' => $nz, ] ]; $zv=json_encode($zv); die ($zv); } function qn(){ global $_db, $_config, $_model, $_model_indexes, $_model_indexes_create_sql, $_model_indexes_check_sql; $dz=$_config['db_table_prefix']; kn('SET sql_quote_show_create=1'); ln( $dz, ($_db['charset']==='utf8mb4')?'utf8mb4':'utf8' ); if(Log::$cy)__log('Get existing table information {'); foreach(array_keys($_model) as $fz){ bn($fz); try { kn("SHOW CREATE TABLE `". $dz.$fz ."`"); $kk[$fz]=xn(); $kk[$fz]=$kk[$fz][0]['Create Table']; } catch (AeMySQLException $e){ kv($e); die ('Database table "'. $dz .$fz .'" not accessible during migration. Check your database availability'); } kn("SHOW INDEX FROM `". $dz.$fz ."`"); $xk=xn(); $ek=array(); foreach ($xk as $qz){ $qz=$qz['Key_name']; if(preg_match('/\_[0-9]+$/',$qz)) { $rk[] = $qz; $ek[] = 'DROP INDEX `'. $qz. '`'; } } if(count($ek)) { $ek=implode(', ',array_unique($ek)); $rk=implode(', ',array_unique($rk)); if(Log::$cy)__log( 'Drop erroneous index "'. $rk .'" on "'. $dz.$fz .'"' ); kn( "ALTER TABLE `". $dz.$fz ."` ". $ek ); } if (!strstr($kk[$fz],'InnoDB')) { kn( "ALTER TABLE `". $dz.$fz ."` ". "ENGINE = InnoDB" ); } if (!strstr($kk[$fz],'`SubsetID`')) { kn( "ALTER TABLE `". $dz.$fz."` ". "ADD `SubsetID` INT UNSIGNED DEFAULT '0' NOT NULL AFTER `ID`" ); } if($_config['db_table_subset'] > 0){ kn( "UPDATE `". $dz.$fz ."` ". "SET `SubsetID` = ". $_config['db_table_subset'] ." ". "WHERE `SubsetID` = 0" ); } else { die ('db_table_subset must be greater than 0'); } } if(Log::$cy)__log('}'); if (!strstr($kk['Actions'],'`ReadCount`')) { kn( "ALTER TABLE `". $dz."Actions` ". "ADD `ReadCount` INT DEFAULT '0' NOT NULL" ); } if(strstr($kk['Actions'],'`HitCount`')) { kn( "ALTER TABLE `". $dz."Actions` ". "DROP `HitCount`" ); kn( "DELETE FROM `". $dz."Actions` ". "WHERE `ReadCount` = 0" ); } if (!strstr($kk['Aliases'],'`EntityType`')) { kn( "ALTER TABLE `". $dz."Aliases` ". "ADD `EntityType` VARCHAR( 1 ) DEFAULT '' NOT NULL AFTER `ID`" ); } kn( "UPDATE `". $dz."Aliases` ". "SET `EntityType` = 'n' ". "WHERE `EntityType` = ''" ); kn( "DELETE FROM `". $_config['db_table_prefix']."Aliases` ". "WHERE `ID` IN (". "SELECT `ID` FROM (". "SELECT a.`ID` FROM `". $_config['db_table_prefix']."Aliases` a ". "LEFT OUTER JOIN `". $_config['db_table_prefix']."Keywords` e ". "ON a.`EntityID` = e.`ID` ". "WHERE a.`EntityType` = 't' ". "AND e.`ID` IS NULL". ") AS temp". ")", 'clean up “leaked” tag aliases' ); if (!stristr($kk['Comments'],'`Text` MEDIUMTEXT')) { kn( "ALTER TABLE `". $dz."Comments` ". "CHANGE `Text` `Text` MEDIUMTEXT" ); } if (!stristr($kk['Comments'],'`Reply` MEDIUMTEXT')) { kn( "ALTER TABLE `". $dz."Comments` ". "CHANGE `Reply` `Reply` MEDIUMTEXT" ); } if (!stristr($kk['Comments'],'`IP` VARCHAR(39)')) { kn( "ALTER TABLE `". $dz."Comments` ". "CHANGE `IP` `IP` VARCHAR(39)  DEFAULT '' NOT NULL" ); } if (!strstr($kk['Comments'],'`IsGIPUsed`')) { kn( "ALTER TABLE `". $dz."Comments` ". "ADD `IsGIPUsed` TINYINT(1) DEFAULT '0' NOT NULL AFTER `IP`" ); } if (!strstr($kk['Comments'],'`GIP`')) { kn( "ALTER TABLE `". $dz."Comments` ". "ADD `GIP` VARCHAR(15) DEFAULT '' NOT NULL AFTER `IsGIPUsed`" ); } if (!strstr($kk['Comments'],'`GIPAuthorID`')) { kn( "ALTER TABLE `". $dz."Comments` ". "ADD `GIPAuthorID` VARCHAR(64) DEFAULT '' NOT NULL AFTER `GIP`" ); } if(strstr($kk['Comments'],'`SocialType`')) { kn( "ALTER TABLE `". $dz."Comments` ". "DROP `SocialType`" ); } if(strstr($kk['Comments'],'`SocialID`')) { kn( "ALTER TABLE `". $dz."Comments` ". "DROP `SocialID`" ); } if (!strstr($kk['GIPsSessions'],'`AuthorEmail`')) { kn( "ALTER TABLE `". $dz."GIPsSessions` ". "ADD `AuthorEmail` VARCHAR(255) DEFAULT '' NOT NULL AFTER `AuthorName`" ); } if (!strstr($kk['GIPsSessions'],'`AuthorProfileLink`')) { kn( "ALTER TABLE `". $dz."GIPsSessions` ". "ADD `AuthorProfileLink` VARCHAR(255) DEFAULT '' NOT NULL AFTER `AuthorEmail`" ); } if(strstr($kk['Keywords'],'`ParentKeywordID`')) { kn( "ALTER TABLE `". $dz."Keywords` ". "DROP `ParentKeywordID`" ); } if (!strstr($kk['Keywords'],'`OriginalAlias`')) { kn( "ALTER TABLE `". $dz."Keywords` ". "CHANGE `URLName` `OriginalAlias` VARCHAR( 64 ) DEFAULT '' NOT NULL AFTER `Keyword`" ); } if (!strstr($kk['Keywords'],'`PageTitle`')) { kn( "ALTER TABLE `". $dz."Keywords` ". "ADD `PageTitle` VARCHAR(255) DEFAULT '' NOT NULL AFTER `OriginalAlias`" ); } if (!stristr($kk['Keywords'],'`Description` MEDIUMTEXT')) { kn( "ALTER TABLE `". $dz."Keywords` ". "CHANGE `Description` `Description` MEDIUMTEXT" ); } if (!strstr($kk['Keywords'],'`Summary`')) { kn( "ALTER TABLE `". $dz."Keywords` ". "ADD `Summary` MEDIUMTEXT AFTER `Description`" ); } if (!strstr($kk['Keywords'],'`Uploads`')) { kn( "ALTER TABLE `". $dz."Keywords` ". "ADD `Uploads` MEDIUMTEXT AFTER `Summary`" ); } if (!stristr($kk['Keywords'],'`Uploads` MEDIUMTEXT')) { kn( "ALTER TABLE `". $dz."Keywords` ". "CHANGE `Uploads` `Uploads` MEDIUMTEXT" ); } if (!strstr($kk['Keywords'],'`IsVisible`')) { kn( "ALTER TABLE `". $dz."Keywords` ". "ADD `IsVisible` TINYINT(1) DEFAULT '1' NOT NULL AFTER `Uploads`" ); } kn( "UPDATE `". $dz."Keywords` SET `Summary` = '' WHERE `Summary` IS NULL" ); kn( "UPDATE `". $dz."Keywords` SET `Uploads` = '' WHERE `Uploads` IS NULL" ); if (!strstr($kk['Notes'],'`FormatterID`')) { kn( "ALTER TABLE `". $dz."Notes` ". "ADD `FormatterID` VARCHAR( 32 ) DEFAULT '". $_config['default_formatter'] ."' NOT NULL AFTER `Text`" ); } if (!strstr($kk['Notes'],"DEFAULT 'calliope'")) { kn( "ALTER TABLE `". $dz."Notes` ". "CHANGE `FormatterID` `FormatterID` VARCHAR( 32 ) DEFAULT '". $_config['default_formatter'] ."' NOT NULL" ); } if (!strstr($kk['Notes'],'`OriginalAlias`')) { kn( "ALTER TABLE `". $dz."Notes` ". "CHANGE `URLName` `OriginalAlias` VARCHAR( 64 ) DEFAULT '' NOT NULL AFTER `FormatterID`" ); } if(strstr($kk['Notes'],'`IP`')) { kn( "ALTER TABLE `". $dz."Notes` ". "DROP `IP`" ); } if (!stristr($kk['Notes'],'`Text` MEDIUMTEXT')) { kn( "ALTER TABLE `". $dz."Notes` ". "CHANGE `Text` `Text` MEDIUMTEXT" ); } if (!strstr($kk['Notes'],'`Summary`')) { kn( "ALTER TABLE `". $dz."Notes` ". "ADD `Summary` MEDIUMTEXT AFTER `Text`" ); } if (!strstr($kk['Notes'],'`IsIndexed`')) { kn( "ALTER TABLE `". $dz."Notes` ". "ADD `IsIndexed` TINYINT( 1 ) DEFAULT '0' NOT NULL AFTER `IsDST`" ); } if (!strstr($kk['Notes'],'`Uploads`')) { kn( "ALTER TABLE `". $dz."Notes` ". "ADD `Uploads` MEDIUMTEXT AFTER `OriginalAlias`" ); } if (!stristr($kk['Notes'],'`Uploads` MEDIUMTEXT')) { kn( "ALTER TABLE `". $dz."Notes` ". "CHANGE `Uploads` `Uploads` MEDIUMTEXT" ); } if (!strstr($kk['Notes'],'`IsExternal`')) { kn( "ALTER TABLE `". $dz."Notes` ". "ADD `IsExternal` TINYINT(1) DEFAULT '0' NOT NULL AFTER `IsIndexed`" ); } if (!strstr($kk['Notes'],'`SourceID`')) { kn( "ALTER TABLE `". $dz."Notes` ". "ADD `SourceID` INT UNSIGNED DEFAULT '0' NOT NULL AFTER `IsExternal`" ); } if (!strstr($kk['Notes'],'`SourceNoteID`')) { kn( "ALTER TABLE `". $dz."Notes` ". "ADD `SourceNoteID` INT UNSIGNED DEFAULT '0' NOT NULL AFTER `SourceID`" ); } if (!strstr($kk['Notes'],'`SourceNoteURL`')) { kn( "ALTER TABLE `". $dz."Notes` ". "ADD `SourceNoteURL` VARCHAR(255) DEFAULT '' NOT NULL AFTER `SourceNoteID`" ); } if (!strstr($kk['Notes'],'`SourceNoteData`')) { kn( "ALTER TABLE `". $dz."Notes` ". "ADD `SourceNoteData` MEDIUMTEXT AFTER `SourceNoteURL`" ); } if (!strstr($kk['Notes'],'`SourceNoteJSONURL`')) { kn( "ALTER TABLE `". $dz."Notes` ". "ADD `SourceNoteJSONURL` VARCHAR(255) DEFAULT '' NOT NULL AFTER `SourceNoteData`" ); } if(strstr($kk['Notes'],'`SourceMainImageURL`')) { kn( "ALTER TABLE `". $dz."Notes` ". "DROP `SourceMainImageURL`" ); } if(strstr($kk['Notes'],'`IsIssue`')) { kn( "ALTER TABLE `". $dz."Notes` ". "DROP `IsIssue`" ); } if (!strstr($kk['Notes'],'`ReadCount`')) { kn( "ALTER TABLE `". $dz."Notes` ". "ADD `ReadCount` INT UNSIGNED DEFAULT '0' NOT NULL AFTER `IsExternal`" ); kn( "UPDATE `". $dz."Notes` n JOIN (". "SELECT `EntityID`, SUM(`ReadCount`) `AggregateReadCount` ". "FROM  `". $dz."Actions` ". "GROUP BY `EntityID`". ") a ON n.`ID` = a.`EntityID` ". "SET `ReadCount` = `AggregateReadCount`" ); } kn( "UPDATE `". $dz."Notes` SET `Summary` = '' WHERE `Summary` IS NULL" ); kn( "UPDATE `". $dz."Notes` SET `Uploads` = '' WHERE `Uploads` IS NULL" ); kn( "UPDATE `". $dz."Notes` SET `SourceNoteData` = '' WHERE `SourceNoteData` IS NULL" ); if (!strstr($kk['Sources'],'`TrueID`')) { kn( "ALTER TABLE `". $dz."Sources` ". "ADD `TrueID` INT UNSIGNED DEFAULT '0' NOT NULL AFTER `ID`" ); kn( "UPDATE `". $dz."Sources` ". "SET `TrueID` = `ID`" ); } if(Log::$cy)__log('Ensure indexes {'); if(strstr($kk['Notes'],'`Title` (`Title`(191))')) { if(Log::$cy)__log('Drop erroneous index on "'. $dz .'Notes.Title"'); kn( "ALTER TABLE `". $dz ."Notes` ". "DROP INDEX `Title`" ); } foreach(array_keys($_model) as $fz){ foreach($_model_indexes[$fz] as $qz){ list ($type,$sz)=$qz; $tk=$_model_indexes_check_sql[$type].' `'.$sz[0].'` (`'. implode('`,`',$sz) .'`)'; $jk=$_model_indexes_create_sql[$type].' (`'. implode('`, `',$sz) .'`)'; if (!strstr($kk[$fz],$tk)) { if(Log::$cy)__log( 'Table "'. $dz.$fz .'" is missing "'. $_model_indexes_check_sql[$type] .'" on columns "'. implode('", "',$sz) .'"' ); kn( "ALTER TABLE `". $dz.$fz ."` ". "ADD ". $jk ); } } } if(Log::$cy)__log('}'); return true; } function ln($dz,$hk){ global$_model,$_db; if (!in_array($hk, ['utf8','utf8mb4'])) return; if(Log::$cy)__log('Ensure encoding '. $hk .' on all tables {'); $gk=xa(); foreach ($gk as $t => $xf){ $gk[$t]=SEARCH_EXTRA_PREFIX. $xf; } $wk=array_merge( array_keys($_model), array_values($gk) ); foreach ($wk as $u4){ if(Log::$cy)__log('Migrate: Check table '. $u4); $uk=vn($u4,$dz); if (!$uk) continue; $ik=$uk['Collation']; if ($hk==='utf8' and ($ik=='utf8_general_ci')) continue; if ($hk==='utf8mb4' and stripos($ik,'utf8mb4')===0) continue; if(Log::$cy)__log('Migrate: Drop indexes of table '. $u4); kn( "ALTER TABLE `". $dz.$u4 ."` ". "DROP INDEX" ); if(Log::$cy)__log('Migrate: Convert table '. $u4. ' to '. $hk); kn( "ALTER TABLE `". $dz.$u4 ."` ". "CONVERT TO CHARACTER SET ". $hk. (($hk==='utf8')? " COLLATE utf8_general_ci":"") ); } if(Log::$cy)__log('}'); } function e2s_update_perform(){ global$_model,$settings,$_config,$_diagnose; if(1){ $ok=ini_get('max_execution_time')+5; $pk=@unserialize(file_get_contents(USER_FOLDER.'updating.psa')); if (!is_array($pk))$pk=[]; if ( isset ($pk['lock']) and $pk['lock'] >= time()-$ok ){ throw new AeUpdateAlreadyInProcess('Update already in process'); } $pk['lock']=time(); if (!@n3(USER_FOLDER.'updating.psa',serialize($pk))) { throw new AeUpdateCannotLock('Update can’t get a new lock'); } } $pz=fn_(); $g=max((int) ($pz['version']), 2285); if ($pz['version']==E2_VERSION)v(); if($_config['log_updates']) { Log::$cy=true; if(Log::$cy)bv('update-$'); } if($_config['backup_before_update']) { if(Log::$cy)__log('Backup before update {'); if (!hn()) { die ('Could not make backup before update. Try again?'); } if(Log::$cy)__log('}'); } if(Log::$cy)__log('Update from v'. $g .' to v'. E2_VERSION.' {'); if ($g < 2587){ r('caches/*'); rmdir('caches'); } if ($g < 2691){ $settings=e2_utf8_version_of_array_($settings); if (!@n3(USER_FOLDER.'settings.json',json_encode($settings,E2_JSON_STYLE))) { mv($_strings['er--cannot-save-data'],E2E_PERMISSIONS_ERROR); qv(); } } if ($g < 2921){ $settings['template']='plain'; } if ($g < 3354){ @rename('pictures/userpics/',AVATARS_FOLDER); @unlink(USER_FOLDER. 'password-reset.txt'); } if ($g < 3496){ $settings['appearance']['respond_to_dark_mode']=true; } @unlink(USER_FOLDER. 'last-update.psa'); @unlink(CACHES_FOLDER.'index.xml'); @j(CACHES_FOLDER); @j(BACKUP_FOLDER); @j(MEDIA_ROOT_FOLDER.PICTURES_FOLDER .'remote/'); @j(MEDIA_ROOT_FOLDER.THUMBNAILS_FOLDER .'remote/'); @j(MEDIA_ROOT_FOLDER.VIDEO_FOLDER); if (@$settings['template']=='')$settings['template']=DEFAULT_TEMPLATE; if (isset ($settings['appearance']['hot_frontpage'])) { unset($settings['appearance']['hot_frontpage']); } if (!isset ($settings['blog_subtitle'])) { if (isset ($settings['description'])) { $settings['blog_subtitle']=$settings['description']; unset($settings['description']); } } if (!isset ($settings['blog_title'])) { if (isset ($settings['site_title'])) { $settings['blog_title']=$settings['site_title']; unset($settings['site_title']); } } if (!isset ($settings['author_email'])) { if (isset ($settings['user']['email'])) { $settings['author_email']=$settings['user']['email']; unset($settings['user']); } } if (isset ($settings['db']['table_prefix'])) { if($settings['db']['table_prefix'] != @$_config['db_table_prefix']) { die ('You’ve been using a database with a table prefix “'. $settings['db']['table_prefix'] .'”. Now this should be set in the configuration. Please add the following line to the file user/config.php:<br /><br />$_config[\'db_table_prefix\'] = \''. $settings['db']['table_prefix'] .'\';<br /><br />Then refresh this page.'); } else { unset($settings['db']['table_prefix']); } } if (isset ($settings['comments']['on'])) { if (!$settings['comments']['on']) { try { kn( "UPDATE LOW_PRIORITY `". $_config['db_table_prefix']."Notes` ". "SET `IsCommentable`=0 ". "WHERE `SubsetID`=". $_config['db_table_subset'] ); } catch (AeMySQLException $e){} } $settings['comments']['default_on'] = (bool)$settings['comments']['on']; unset($settings['comments']['on']); } if (isset ($settings['v3223_rss_permalinks_before_stamp'])) { unset($settings['v3223_rss_permalinks_before_stamp']); } if ( is_file(USER_FOLDER.'settings.json') and is_file(USER_FOLDER.'settings.psa') ) { @unlink(USER_FOLDER.'settings.psa'); } if (!@n3(USER_FOLDER.'settings.json',json_encode($settings,E2_JSON_STYLE))) { mv($_strings['er--cannot-save-data'],E2E_PERMISSIONS_ERROR); } e2_drop_all_kinds_of_cache(); qn(); if ($g < 3601){ ja(); $p3=ea(); try { $p3 -> erase(); } catch (\S2\Rose\Exception\RuntimeException $e){ if(Log::$cy)__log('Rose not available'); } aa(); } $_diagnose['need?']=true; y('diagnose','1'); $pz=dn(E2_VERSION); if(Log::$cy)__log('}'); @unlink(USER_FOLDER.'updating.psa'); if (k2()) { mv(e2l_get_string('gs--updated-successfully', array ( 'from' => 'v'. $g, 'to' => 'v'. $pz['version'], )), E2E_MESSAGE); } c(); } define('E2_MYSQL_CONNECT_TIMEOUT',5); function zn($c7='',$u3=null){ static $v7=false; global$settings,$_db,$bz,$_config; if ($v7) return; if ($u3===null)$u3=$settings['db']; $b7=mysqli_init(); $b7 -> options(MYSQLI_OPT_CONNECT_TIMEOUT,E2_MYSQL_CONNECT_TIMEOUT); if($_config['dev_chaos'] and !rand(0, (1/$_config['dev_chaos']) - 1)) { throw new AeMySQLCannotConnectException('Could not '. $c7 ."\n\nChaos in e2_mysql_ensure"); } $y7=@mysqli_real_connect( $b7, 'p:'. $u3['server'], $u3['user_name'], i2($u3['passw']) ); if (!$y7){ $uq=mysqli_connect_errno(); if ($uq==1045){ $y7=@mysqli_real_connect( $b7, 'p:'. $u3['server'], $u3['user_name'], $u3['passw'] ); if ($y7){ $u3['passw']=u2($u3['passw']); $settings['db']=$u3; if(Log::$cy)__log('Storing encrypted password'); @n3(USER_FOLDER.'settings.json',json_encode($settings,E2_JSON_STYLE)); } else { throw new AeMySQLAccessDeniedException('Could not '. $c7); } } else { throw new AeMySQLCannotConnectException('Could not '. $c7); } } $_db['version']=mysqli_get_server_info($b7); if(version_compare($_db['version'],E2_MINIMUM_MYSQL,'<')) { throw new AeMySQLTooOldException('Could not '. $c7); } if (!@mysqli_select_db($b7,$u3['name'])) { throw new AeMySQLNotFoundException('Could not '. $c7); } $_db['link']=$b7; $_db['charset']=version_compare($_db['version'],'5.5.3','>=')?'utf8mb4':'utf8'; $bf='SET NAMES '. $_db['charset']; mysqli_query($b7,$bf); @$bz ++; if(Log::$cy)__log('DB ['. $bz .']: '. $bf); $v7=true; } function kn($bf,$c7='run some query'){ global $bz,$_db,$_strings,$_config; zn($c7); if($_config['dev_chaos'] and !rand(0, (1/$_config['dev_chaos']) - 1)) { throw new AeMySQLQueryException('Could not '. $c7 ."\n\nChaos in e2_mysql_query"); } @$bz ++; if(Log::$cy) if ($c7)__log('Will '. $c7); if(Log::$cy)__log('DB ['. $bz .']: '. $bf); $_db['result'] = @mysqli_query($_db['link'],$bf); if($_config['backup_tail']) { if ( stripos($bf,"SELECT")!==0 and stripos($bf,"SHOW")!==0 ){ $fb=BACKUP_FOLDER .'backup-tail.sql'; @file_put_contents($fb,$bf .";\r\n\r\n",FILE_APPEND | LOCK_EX); @chmod($fb,E2_NEW_FILES_RIGHTS); } } if (!$_db['result']) { throw new AeMySQLQueryException('Could not '. $c7 ."\n\nMySQL says:\n". mysqli_error($_db['link'])); } } function xn($type=MYSQLI_ASSOC){ global$_db; $d=array(); while ($nv=@mysqli_fetch_array($_db['result'],$type)) { foreach ($nv as $r => $n7){ if(is_string($n7)) { $nv[$r]=$n7; } } $d[] = $nv; } return $d; } function en($x){ global$_db; zn('escape string'); return mysqli_real_escape_string($_db['link'],$x); } function rn(){ global$_config; $ua=array_keys(tn()); if(Log::$cy)__log('Backup: Found '. count($ua) .' backups'); if(count($ua)) { $m7=time()-$ua[0]; $f7=($m7 >= $_config['backup_rebase_interval']); if(Log::$cy)__log('Backup: '. $m7 .' seconds since last backup'); } else { $f7=true; } if ($f7){ if(Log::$cy)__log('Backup: Will rebuild backup'); p3(jv('e2s_dump', []), true); } } function tn(){ $ua=[]; foreach(glob(BACKUP_FOLDER. '*.sql') as $fy){ if(preg_match('/^backup\-(\d+)\-(\d+)\-(\d+)\-at\-(\d+)\-(\d+)\-(\d+)\.sql$/is',basename($fy),$y3)) { list (, $hb,$jb,$tb,$c4,$r,$pl)=$y3; $n4=gmmktime($c4,$r,$pl,$jb,$tb,$hb); $ua[$n4]=$fy; } } krsort($ua); return $ua; } function jn(){ $ua=tn(); if(count($ua) > 3){ $s7=-1; $a7=array (SECONDS_IN_A_MINUTE,SECONDS_IN_AN_HOUR,SECONDS_IN_A_DAY, -1); $r=0; foreach ($ua as $n4 => $fy){ if ($s7 == -1){ $s7=$n4; } elseif ($a7[$r] == -1){ @unlink($fy); } else { if ($s7-$n4 < $a7[$r]) { @unlink($fy); } else { $r ++; $s7=$n4; } } } } else { } return; } function hn(){ global$_model,$_db,$_config; try { zn('make backup'); if($_db['link']) { $q7=[]; foreach(array_keys($_model) as $fz){ $q7[] = $_config['db_table_prefix'].$fz; } $r4=time(); $fb=BACKUP_FOLDER .'backup-'.gmdate('Y-m-d-\a\t-H-i-s',$r4).'.sql'; e2_backup($_db['link'],$q7,$fb); @unlink(BACKUP_FOLDER .'backup-tail.sql'); jn(); return true; } } catch (AeMySQLException $e){ kv($e,'Could not do backup'); return false; } } function e2s_dump(){ if($_SERVER['REQUEST_METHOD']!='POST'){ c(jv('e2m_underhood')); } if (hn())mv('Backed up',E2E_MESSAGE); c(jv('e2m_underhood')); } define('ALIAS_MAX_LENGTH',64); function gn($l7=false){ global$_config; static $m2=null; if ($l7){ if(Log::$cy)__log('Reset aliasmap'); @unlink(CACHE_FILENAME_ALIASMAP); $m2=null; return; } if(is_array($m2)) return $m2; if(CACHE_ALIASMAP and is_file(CACHE_FILENAME_ALIASMAP)) { $m2=@unserialize(file_get_contents(CACHE_FILENAME_ALIASMAP)); } if(is_array($m2)) return $m2; if(Log::$cy)__log('Build aliasmap {'); $m2=[]; kn( "SELECT `EntityType`, `EntityID`, `Alias` ". "FROM `". $_config['db_table_prefix']."Aliases` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `Stamp` IN (". "SELECT MAX(`Stamp`) `MaxStamp` ". "FROM `". $_config['db_table_prefix']."Aliases` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "GROUP BY `EntityType`, `EntityID`". ")", 'get all active aliases' ); foreach (xn() as $z7){ $f2=$z7['EntityType'].$z7['EntityID']; $m2[$f2]=$z7['Alias']; } kn( "SELECT `ID`, `Stamp`, `Offset`, `IsDST`, `OriginalAlias` ". "FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished` = 1 ". "ORDER BY `Stamp`", 'get all notes to cache y/d/m/n urls' ); $k7=0; $x7=false; foreach (xn() as $n2){ $f2='n'. $n2['ID']; $e7=ky( 'Y/m/d',$n2['Stamp'],dy($n2) ); if ($e7!==$x7)$k7=0; $k7 ++; $r7=$e7 .'/'. $k7; if (empty ($m2[$f2])) { $m2[$f2]=$r7; } else { if ((string)$n2['OriginalAlias']===''){ $m2[$f2.'-ymdn']=$r7; } } $x7=$e7; } kn( "SELECT `ID`, `OriginalAlias` ". "FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `SubsetID`=". $_config['db_table_subset'], 'get original active aliases for tags' ); foreach (xn() as $q2){ $f2='t'. $q2['ID']; if (empty ($m2[$f2])) { $m2[$f2]=$q2['OriginalAlias']; } } if(CACHE_ALIASMAP)n3(CACHE_FILENAME_ALIASMAP,serialize($m2)); if(Log::$cy)__log('}'); return $m2; } function e2ali__alias_from_title_($t7){ global$_config; $j7=$t7; if(array_key_exists('autoreplace_for_aliases',$_config)) { $j7=strtr( $j7, $_config['autoreplace_for_aliases'] ); } $j7=m($j7); $j7=str_replace('\'','',$j7); $j7=str_replace('’','',$j7); $j7=str_replace(chr(146),'',$j7); $h7=''; for ($r=0; $r < strlen($j7); ++ $r){ if ( (ord($j7[$r]) >= 48 and ord($j7[$r]) <= 57) or (ord($j7[$r]) >= 65 and ord($j7[$r]) <= 90) or (ord($j7[$r]) >= 97 and ord($j7[$r]) <= 122) or 0 ){ $h7.=$j7[$r]; } else { $h7.='-'; } } $h7=preg_replace('/\-+/','-',$h7); $h7=trim($h7,'-'); $h7=strtolower($h7); if ($h7=='-')$h7=''; $h7=substr($h7,0,ALIAS_MAX_LENGTH); return $h7; } function un($g7){ global$_config; if ((string)$g7==='') return false; kn( "SELECT * FROM `". $_config['db_table_prefix']."Aliases` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `Alias` = '". $g7 ."' ". "ORDER BY `Stamp` LIMIT 1", 'get alias record for alias "'. $g7 .'"' ); $q1=xn(); if(count($q1)==1){ return $q1[0]; } else { return false; } } function in($g7){ global$_config; if ((string)$g7==='') return false; if(Log::$cy)__log('Get entity type and id from alias "'. $g7 .'"'); $w7=@array_flip(gn()); $f2=$w7[$g7]; if ($f2[0]=='n' or $f2[0]=='t'){ $vv=[ 'type' => $f2[0], 'id' => (int)substr($f2,1) ]; return $vv; } $z7=un($g7); if (!$z7) return false; $vv=[ 'type' => $z7['EntityType'], 'id' => (int)$z7['EntityID'], ]; if(Log::$cy)__log('Got entity type "'. $vv['type'] .'" and id "'. $vv['id'] .'"'); return $vv; } function on($py,$pa,$u7,$t7,$i7=1){ if(Log::$cy)__log('Aliases: "'. $py .'" available alias for source "'. $t7. '"'); if ($py=='set' and (!$pa or !$u7)) return false; $h7=e2ali__alias_from_title_($t7); if ($t7!=='' and $h7===''){ $h7=(string)$i7; } elseif ($i7 > 1){ $o7='-'. $i7; $h7=substr($h7,0,ALIAS_MAX_LENGTH-strlen($o7)) . $o7; } if ($z7=un($h7)) { $p7=$z7['EntityType']; $cx=$z7['EntityID']; if ( (($u7 and $cx==$u7) and ($pa and $p7==$pa)) or $h7!=gn() [$p7.$cx] ) { if ($py=='find'){ return $h7; } if ($py=='set'){ if(Log::$cy)__log('Aliases: update alias timestamp'); nn('Aliases', array ( 'ID' => $z7['ID'], 'EntityType' => $pa, 'EntityID' => $u7, 'Alias' => $h7, 'Stamp' => time(), )); gn(true); return $h7; } } else { return on($py,$pa,$u7,$t7,$i7+1); } } else { if ($pa and $u7 and $h7==''){ if(preg_match( '/(?P<year>\d{4})\/(?P<month>\d{1,2})\/(?P<day>\d{1,2})\/(?P<day_number>\d+)/', gn() [$pa.$u7] )) { if(Log::$cy)__log('Aliases: d/m/y/n was already used for this entity'); return ''; } } if(Log::$cy)__log('Aliases: it’s an empty alias, and it was not being used for this entity'); if ( $pa=='t' and $vx=df($h7) ) { if ($vx['ID']!=$u7){ return on($py,$pa,$u7,$t7,$i7+1); } } if ($py=='find'){ return $h7; } if ($py=='set'){ yn('Aliases', array ( 'EntityType' => $pa, 'EntityID' => $u7, 'Alias' => $h7, 'Stamp' => time(), )); gn(true); return $h7; } } return ''; } class AeLayoutDiversityManager { private static $layoutsUseIndexes=[]; private static $layoutsUseIndex=1; private static $layoutsUseMaxIndex=1; public static function addLayoutsUsed($bx){ self::$layoutsUseIndexes[$bx]=self::$layoutsUseIndex; self::$layoutsUseIndex ++; self::$layoutsUseMaxIndex ++; } public static function hasLayoutBeenUsed($bx){ if (isset (self::$layoutsUseIndexes[$bx])) return true; } public static function getLayoutsUseRecency($bx){ if (isset (self::$layoutsUseIndexes[$bx])) { return self::$layoutsUseIndexes[$bx]-self::$layoutsUseMaxIndex; } } } class AeNoteReadCountsProvider { private static $dataByNoteID=[]; private static $hasRun=false; private static $sql=null; public static function setSQLRequestTemplateToMapIDsToReadCounts($sql){ self::$sql=$sql; } public static function requestDeferredReadCountForNoteID($noteID){ self::$dataByNoteID[$noteID]=true; } public static function getReadCountForNoteID($noteID){ if(self::$sql===null) return false; if (!self::$hasRun)self :: run(); if (empty (self::$dataByNoteID[$noteID])) return false; return self::$dataByNoteID[$noteID]; } private static function run(){ self::$hasRun=true; $yx=[]; foreach(self::$dataByNoteID as $nx => $lv){ $yx[] = "(`ID` = ". $nx.")"; } if (!count($yx)) return; $yx=implode(' OR ',$yx); try { kn( self::$sql ." AND (". $yx .")", 'get all requested read counts for notes' ); $ib=xn(); foreach ($ib as $vv){ self::$dataByNoteID[$vv['ID']] = $vv['ReadCount']; } } catch (AeMySQLException $e){ kv($e); if(Log::$cy)__log('Could not get requested read counts for notes'); } } } class AePageableNotesView { private $candy; private $parameters; private $pageExists=false; private $isCached=false; private $hasRun=false; private $sql=null; private $sql_count=null; private $highlightedTags=null; private $cacheFilename=null; private $prevPageTitle=null; private $nextPageTitle=null; private $totalNotes=null; private $totalPages=null; private $notesCTree=null; private $pagesCTree=null; private $wantPaging=false; private $wantNewCommentsCount=false; private $wantReadHrefs=false; private $wantPreviewHrefs=false; private $wantControls=false; private $wantHiddenTags=false; private $wantRelatedNotes=false; private $useLocalHrefs=false; private $page=1; private $limit=10; public function __construct($candy,$parameters){ $this->candy=$candy; $this->parameters=$parameters; if (empty ($parameters['page'])) { $this->page=1; } else { $this->page=(int)$parameters['page']; } } public function setSQLCountRequest($sql_count){ if(strpos($sql_count,"SELECT COUNT(*) Total FROM ")!==0){ die ('AePageableNotesView: Count request must start with "SELECT COUNT(*) Total FROM "'); } $this->sql_count=$sql_count; } public function setLimitlessSQLRequest($sql){ if(strstr($sql,"LIMIT")) { die ('AePageableNotesView: Request must not contain "LIMIT"'); } $this->sql=$sql; if($this->sql_count===null){ if(strpos($sql,"SELECT * ")===0){ $this->sql_count="SELECT COUNT(*) Total ". substr($sql,9); } else { die ('AePageableNotesView: setSQLCountRequest () must be used'); } } } public function setPortionSize($limit){ $this->limit=abs((int)$limit); } public function setNextPrevPageTitles($nextPageTitle,$prevPageTitle){ $this->nextPageTitle=$nextPageTitle; $this->prevPageTitle=$prevPageTitle; } public function setHighlightedTags($highlightedTags){ $this->highlightedTags=$highlightedTags; } public function setCacheFilename($cacheFilename){ $this->isCached=true; $this->cacheFilename=$cacheFilename; } public function setWantPaging($wantPaging){ $this->wantPaging=$wantPaging; } public function setWantNewCommentsCount($wantNewCommentsCount){ $this->wantNewCommentsCount=$wantNewCommentsCount; } public function setWantReadHrefs($wantReadHrefs){ $this->wantReadHrefs=$wantReadHrefs; } public function setWantPreviewHrefs($wantPreviewHrefs){ $this->wantPreviewHrefs=$wantPreviewHrefs; } public function setWantControls($wantControls){ $this->wantControls=$wantControls; } public function setWantHiddenTags($wantHiddenTags){ $this->wantHiddenTags=$wantHiddenTags; } public function setWantRelatedNotes($wantRelatedNotes){ $this->wantRelatedNotes=$wantRelatedNotes; } public function setUseLocalHrefs($useLocalHrefs){ $this->useLocalHrefs=$useLocalHrefs; } public function isExistingPage(){ if (!$this->hasRun)$this -> run(); return$this->pageExists; } public function isFirstPage(){ return$this->page===1; } public function isFirstPageOfEmptyView(){ if (!$this->hasRun)$this -> run(); return$this->page===1 and $this->totalPages===0; } public function getTotalNotes(){ if (!$this->hasRun)$this -> run(); return$this->totalNotes; } public function getTotalPages(){ if (!$this->hasRun)$this -> run(); return$this->totalPages; } public function getNotesCTree(){ if (!$this->hasRun)$this -> run(); return$this->notesCTree; } public function getPagesCTree(){ if (!$this->hasRun)$this -> run(); return$this->pagesCTree; } private function prepareCacheableData(){ $this->totalNotes=0; if($this->limit){ $yl=($this->page-1)*$this->limit; $this->sql.=' LIMIT '. $yl .', '. $this->limit; } kn($this->sql_count,'count total notes of "'. $this->candy .'" list'); $mx=xn(); $this->totalNotes=$mx ? (int)$mx[0]['Total']:0; kn($this->sql,'get limited full notes "'. $this->candy .'" list'); $q1=xn(); $fx=[]; foreach ($q1 as $t => $pq){ $fx[] = $pq['ID']; } $this->notesCTree=[]; foreach ($q1 as $t => $pq){ $noteView=new AeNoteView($pq); $noteView -> setWantNewCommentsCount($this->wantNewCommentsCount); $noteView -> setWantReadHref($this->wantReadHrefs); $noteView -> setWantPreviewHref($this->wantPreviewHrefs); $noteView -> setWantControls($this->wantControls); $noteView -> setWantHiddenTags($this->wantHiddenTags); $noteView -> setWantCommentsLink(true); $noteView -> setWantRelatedNotes($this->wantRelatedNotes); $noteView -> setFilterOutRelatedNoteIDs($fx); $noteView -> setHighlightedTags($this->highlightedTags); $noteView -> setUseLocalHref($this->useLocalHrefs); $this->notesCTree[] = $noteView -> getNoteCTree(); } $this->pagesCTree=[]; if ( $this->limit and $this->totalPages=(int)ceil($this->totalNotes/$this->limit) ) { $this->pagesCTree['timeline?']=true; $this->pagesCTree['count'] = (int)$this->totalPages; $this->pagesCTree['this'] = (int)$this->page; if($this->wantPaging){ $this->pagesCTree['earlier-title']=$this->nextPageTitle; $this->pagesCTree['later-title']=$this->prevPageTitle; $dx=$this->parameters; if($this->page < $this->totalPages){ $dx['page']=$this->page+1; $this->pagesCTree['earlier-href']=jv($this->candy,$dx); } if($this->page > 1){ $dx['page']=$this->page-1; $this->pagesCTree['later-href']=jv($this->candy,$dx); } } } } private function run(){ $this->hasRun=true; if($this->isCached and is_file($this->cacheFilename)) { $sx=@unserialize(file_get_contents($this->cacheFilename)); $this->totalNotes=@$sx['notes_total']; $this->notesCTree=@$sx['notes_ctree']; $this->pagesCTree=@$sx['pages_ctree']; $this->totalPages=$this->pagesCTree['count']; } if ( is_int($this->totalNotes) and is_array($this->notesCTree) and is_array($this->pagesCTree) and is_int($this->totalPages) ) { if(Log::$cy)__log('Retrieved cached CTree'); } else { $this -> prepareCacheableData(); if($this->isCached){ n3($this->cacheFilename,serialize([ 'notes_total' => $this->totalNotes, 'notes_ctree' => $this->notesCTree, 'pages_ctree' => $this->pagesCTree, ])); } } foreach($this->notesCTree as $ax){ AeNoteReadCountsProvider :: requestDeferredReadCountForNoteID($ax['id']); if (empty ($ax['related']['each'])) continue; foreach ($ax['related']['each'] as $qx){ AeNoteReadCountsProvider :: requestDeferredReadCountForNoteID($qx['id']); } } $this->pageExists=( $this->totalPages > 0 and $this->page >= 1 and $this->page <= $this->totalPages ); } } class AeArbitraryNotesCollectionView { private $name=''; private $isCached=false; private $hasRun=false; private $sql=null; private $currentURL=null; private $cacheFilename=null; private $cacheExpiresFilename=null; private $cacheable=[]; private $viewExpiration=null; private $notesCTree=null; private $filterOutIDs=[]; public function __construct($name){ $this->name=$name; } public function setSQLRequest($sql){ $this->sql=$sql; } public function setCurrentURL($currentURL){ $this->currentURL=$currentURL; } public function setCacheFilename($cacheFilename){ $this->isCached=true; $this->cacheFilename=$cacheFilename; } public function setCacheExpiresFilename($cacheExpiresFilename){ $this->cacheExpiresFilename=$cacheExpiresFilename; } public function setViewExpiration($viewExpiration){ $this->viewExpiration=$viewExpiration; } public function setFilterOutIDs($filterOutIDs){ $this->filterOutIDs=$filterOutIDs; } public function orderNotesCTreeByVerticality(){ if (!$this->hasRun)$this -> run(); usort($this->notesCTree, function ($lx,$zx){ if (empty ($lx['images'][0]['verticality']))$kx=0; else $kx=$lx['images'][0]['verticality']; if (empty ($zx['images'][0]['verticality']))$xx=0; else $xx=$zx['images'][0]['verticality']; return (int)round(($xx-$kx)*10000); }); } public function getNotesCTree(){ if (!$this->hasRun)$this -> run(); return$this->notesCTree; } private function prepareCacheableData(){ $ex=[ 'notes-records' => function () { $rx=[]; try { kn($this->sql,'get "'. $this->name .'" list'); foreach (xn() as $pq){ if (xm($pq)==='public'){ $rx[] = $pq; } } } catch (AeMySQLException $e){ kv($e); if(Log::$cy)__log('Could not get list from database'); } return $rx; }, ]; if($this->isCached and is_file($this->cacheFilename)) { $this->cacheable=@unserialize(file_get_contents($this->cacheFilename)) or $this->cacheable=[]; } $tx=true; if (!empty ($this->cacheExpiresFilename)) { if($this->isCached and is_file($this->cacheExpiresFilename)) { $r4=time(); $jx=(int) @file_get_contents($this->cacheExpiresFilename); if(Log::$cy)__log('List expires '. date('r',$jx) .', now '. date('r',$r4)); $tx=($r4 < $jx); } } $hx=false; foreach ($ex as $gz => $gx){ if (!array_key_exists($gz,$this->cacheable) or !$tx){ if(Log::$cy)__log('Build cache: "'. $gz .'"'); $this->cacheable[$gz]=$gx(); $hx=true; } else { if(Log::$cy)__log('Retrieved from cache: "'. $gz .'"'); } } if ($hx){ n3($this->cacheFilename,serialize($this->cacheable)); if($this->cacheExpiresFilename){ @n3($this->cacheExpiresFilename,time()+$this->viewExpiration); } } } private function run(){ $this->hasRun=true; if(Log::$cy)__log('AeArbitraryNotesCollectionView "'. $this->name .'" run {'); if(Log::$cy)__log('Cacheable data {'); $this -> prepareCacheableData(); if(Log::$cy)__log('}'); if(Log::$cy)__log('Uncacheable data {'); $this->notesCTree=[]; foreach($this->cacheable['notes-records'] as $pq){ if(in_array($pq['ID'],$this->filterOutIDs)) continue; $noteView=new AeNoteView($pq); $l2=$noteView -> getNoteCTree(); $l2['current?'] = ($l2['href']==$this->currentURL); $this->notesCTree[] = $l2; AeNoteReadCountsProvider :: requestDeferredReadCountForNoteID($pq['ID']); } if(Log::$cy)__log('}'); if(Log::$cy)__log('}'); } } class AeNoteView { private $noteRecord=[]; private $isCached=false; private $hasRun=false; private $cacheFilename=null; private $noteCTree=null; private $highlightedTags=null; private $cacheable=[]; private $OGImages=[]; private $wantRichText=false; private $wantCommentsLink=false; private $wantNewCommentsCount=false; private $wantReadHref=false; private $wantPreviewHref=false; private $wantControls=false; private $wantHiddenTags=false; private $wantSharingButtons=false; private $wantRelatedNotes=false; private $filterOutRelatedNoteIDs=[]; private $useLocalHref=false; public function __construct($noteRecord){ $this->noteRecord=$noteRecord; if(CACHE_NOTES){ $this->isCached=true; $this->cacheFilename=e2_note_cache_filename_with_id_($noteRecord['ID']); } } public function setHighlightedTags($highlightedTags){ $this->highlightedTags=$highlightedTags; } public function setWantRichText($wantRichText){ $this->wantRichText=$wantRichText; } public function setWantCommentsLink($wantCommentsLink){ $this->wantCommentsLink=$wantCommentsLink; } public function setWantNewCommentsCount($wantNewCommentsCount){ $this->wantNewCommentsCount=$wantNewCommentsCount; } public function setWantReadHref($wantReadHref){ $this->wantReadHref=$wantReadHref; } public function setWantPreviewHref($wantPreviewHref){ $this->wantPreviewHref=$wantPreviewHref; } public function setWantControls($wantControls){ $this->wantControls=$wantControls; } public function setWantHiddenTags($wantHiddenTags){ $this->wantHiddenTags=$wantHiddenTags; } public function setWantSharingButtons($wantSharingButtons){ $this->wantSharingButtons=$wantSharingButtons; } public function setWantRelatedNotes($wantRelatedNotes){ $this->wantRelatedNotes=$wantRelatedNotes; } public function setFilterOutRelatedNoteIDs($filterOutRelatedNoteIDs){ $this->filterOutRelatedNoteIDs=$filterOutRelatedNoteIDs; } public function setUseLocalHref($useLocalHref){ $this->useLocalHref=$useLocalHref; } public function getNoteCTree(){ if (!$this->hasRun)$this -> run(); return$this->noteCTree; } private function prepareCacheableData(){ $ex=[ 'title' => function () { return h3( htmlspecialchars($this->noteRecord['Title'],ENT_NOQUOTES,HSC_ENC) ); }, 'text-format-info' => function () { return u3( $this->noteRecord['FormatterID'], $this->noteRecord['Text'], 'full' ); }, 'summary' => function () { if ((string)$this->noteRecord['Summary']!==''){ return h3(htmlspecialchars($this->noteRecord['Summary'],ENT_NOQUOTES,HSC_ENC)); } else { return km($this->cacheable['text-format-info']['text-final']); } }, 'comments-count' => function () { if (!$this->noteRecord['IsPublished']) { return false; } else { return pf($this->noteRecord['ID']); } }, 'tags-data' => function () { $s2=cf($this->noteRecord['ID']); $wx['ctree'] = []; $wx['all-resnames-uploads'] = []; foreach ($s2 as $r => $q2){ $wx['ctree'][] = [ 'visible?' => (bool)$q2['IsVisible'], 'name' => htmlspecialchars($q2['Keyword'],ENT_NOQUOTES,HSC_ENC), 'href' => jv('e2m_tag', array ('*tag' => $q2)), ]; $wx['all-resnames-uploads']=array_merge( $wx['all-resnames-uploads'], q3('tag',$q2['ID']) ); } $wx['all-resnames-uploads']=array_unique( $wx['all-resnames-uploads'] ); return $wx; }, ]; if($this->isCached and is_file($this->cacheFilename)) { $this->cacheable=@unserialize(file_get_contents($this->cacheFilename)) or $this->cacheable=[]; } $hx=false; foreach ($ex as $gz => $gx){ if (!array_key_exists($gz,$this->cacheable)) { if(Log::$cy)__log('Build cache: "'. $gz .'"'); $this->cacheable[$gz]=$gx(); $hx=true; } else { if(Log::$cy)__log('Retrieved from cache: "'. $gz .'"'); } } if ($hx){ n3($this->cacheFilename,serialize($this->cacheable)); } } private function run(){ $this->hasRun=true; if(Log::$cy)__log('AeNoteView run {'); if(Log::$cy)__log('Cacheable data {'); $this -> prepareCacheableData(); if(Log::$cy)__log('}'); if(Log::$cy)__log('Uncacheable data {'); $ux=false; if($this->noteRecord['IsPublished']) { if ((string)$this->noteRecord['OriginalAlias']!==''){ $ux=jv('e2m_note', ['alias' => $this->noteRecord['OriginalAlias']]); } else { $ix=$this->noteRecord; $ix['__force_ymdn']=true; $ux=jv('e2m_note', ['*note' => $ix]); } } $ll=dy($this->noteRecord); $ox=[(int)$this->noteRecord['LastModified'],$ll]; $r4=( $this->noteRecord['IsPublished'] ? [(int)$this->noteRecord['Stamp'],$ll]:$ox ); $px=xm($this->noteRecord); $gs=$this->cacheable['text-format-info']['meta']['resources-detected']; if (!is_array($gs))$gs=[]; if(count($gs)) { rb($gs); } $ce=db($gs); $ws=@unserialize($this->noteRecord['Uploads']) or $ws=[]; $ve=array_merge( sb( $gs,$ws ), $this->cacheable['tags-data']['all-resnames-uploads'] ); $be=d3($ve); $ye=db($ve); $ne=$this->noteRecord['SourceNoteData']; $ne=@json_decode($ne,true); $me=@$ne['og_images'][0] or $me=''; if($this->noteRecord['IsExternal']) { $fe=ad($this->noteRecord); } else { $fe=[]; } $de=false; if(E2_EDITION){ if($this->wantRelatedNotes){ $de=hm( $this->noteRecord['ID'], $this->filterOutRelatedNoteIDs ); if(count($de)==0){ $de=a2( false, $this->filterOutRelatedNoteIDs ); } } } $se=$this->cacheable['tags-data']['ctree']; foreach ($se as $t => $xf){ if($this->highlightedTags!==null){ $se[$t]['current?']=in_array($se[$t]['name'],$this->highlightedTags); } if (!$this->wantHiddenTags and !$se[$t]['visible?']) { unset ($se[$t]); } } if($this->wantSharingButtons and $this->noteRecord['IsPublished'] and !$this->scheduled){ $ae=pn($be); } else { $ae=false; } if($this->wantNewCommentsCount){ $qe=of($this->noteRecord['ID']); } else { $qe=false; } $this->noteCTree=[ 'id' => (int)$this->noteRecord['ID'], 'title' => (string)$this->cacheable['title'], 'href' => jv('e2m_note', ['*note' => $this->noteRecord]), 'href-original' => $ux, 'time' => $r4, 'last-modified' => $ox, 'text' => (string)$this->cacheable['text-format-info']['text-final'], 'format-info' => $this->cacheable['text-format-info']['meta'], 'summary' => (string)$this->cacheable['summary'], 'snippet-text' => (string)$this->cacheable['summary'], 'draft?' => $px==='draft', 'scheduled?' => $px==='scheduled', 'public?' => $px==='public', 'hidden?' => $px==='hidden', 'current?' => false, 'favourite?' => (bool) ($this->noteRecord['IsFavourite'] and $px!=='draft'), 'images' => ab($ce), 'thumbs' => qb($ce), 'source-main-image-url' => (string)$me, 'og-images' => $be, 'og-images-thumbs' => qb($ye), 'tags' => $se, 'sharing-buttons' => $ae, 'related' => $de, 'read-href' => ($this->wantReadHref and $this->noteRecord['IsPublished'])? jv('e2m_note_read', ['*note' => $this->noteRecord]) : false, 'preview-href' => ($this->wantPreviewHref and ($px!=='public'))? jv('e2m_note', [ '*note' => $this->noteRecord, 'preview-key' => rm($this->noteRecord) ]) : false, 'comments-count' => $this->cacheable['comments-count'], 'comments-count-text' => is_int($this->cacheable['comments-count'])? e2l_get_string('gs--n-comments', [ 'number' => $this->cacheable['comments-count'] ]) : '', 'new-comments-count' => $qe, 'new-comments-count-text' => is_int($qe)? e2l_get_string('gs--comments-n-new', [ 'number' => $qe ]) : '', 'comments-link?' => (bool) ( $this->wantCommentsLink and $this->noteRecord['IsPublished'] and ( n2($this->noteRecord) or ($this->cacheable['comments-count'] > 0) ) ), ]; if($this->noteRecord['IsExternal']) { $this->noteCTree=array_merge($this->noteCTree,$fe); $this->noteCTree['href-original']=$this->noteCTree['href-external']; if (!$this->useLocalHref){ $this->noteCTree['href']=$this->noteCTree['href-external']; } } if($this->wantControls){ $this->noteCTree['edit-href']=jv( 'e2m_note_edit', array ('*note' => $this->noteRecord) ); if($this->noteRecord['IsPublished'] and !$this->noteRecord['IsVisible']) { $this->noteCTree['show-href']=jv('e2m_note_flag', [ '*note' => $this->noteRecord, 'flag' => 'IsVisible', 'value' => 1 ]); } if($this->noteRecord['IsPublished']) { $this->noteCTree['favourite-toggle-href']=jv( 'e2m_note_flag_favourite', [ '*note' => $this->noteRecord, 'value' => !$this->noteRecord['IsFavourite'] ] ); } } if(Log::$cy)__log('}'); AeNoteReadCountsProvider :: requestDeferredReadCountForNoteID($this->noteRecord['ID']); if(Log::$cy)__log('}'); } } function pn($be){ global$_config; $le=$_config['share_to']; $ze='|twitter|facebook|vkontakte|telegram|linkedin|whatsapp|'; if (@$_config['share_to_twitter_via']) { $lv['twitter']['via']=$_config['share_to_twitter_via']; } if(count($be) > 0){ $ke=$be[0]; $ze.='pinterest|'; $lv['pinterest']['media']=$ke; } $xe=[]; foreach(explode(',',$le) as $ee){ $ee=trim($ee); if(strstr($ze,'|'. $ee. '|')) { $xe[$ee]['share?']=true; if ($lv[$ee]) { $xe[$ee]['data']=$lv[$ee]; } } } return $xe; } function e2m_note($parameters=[]) { global$settings,$_config,$_strings; if(Log::$cy)__log('Note {'); $n2=$parameters['*note']; if ($n2==false) return e2_error404_mode(); $re=rm($n2); $te=xm($n2); $je=k2(); $he=($parameters['preview-key']==$re); if (!empty ($parameters['preview-key']) and !$he) return e2_error404_mode(); if (!$je and !$he and $te!=='public') return e2_error404_mode(); if (!empty ($parameters['preview-key']) and $te==='public'){ unset($parameters['preview-key']); $ge=jv('e2m_note',$parameters); c($ge); } $ge=jv('e2m_note',$parameters); $noteView=new AeNoteView($n2); $noteView -> setWantReadHref($_config['count_reads']); $noteView -> setWantControls($je and !@$_config['read_only']); $noteView -> setWantHiddenTags($je); if ($te==='draft' or $te==='scheduled'){ if (!$he){ $we=[ '.note-id' => $n2['ID'], 'form-action' => jv('e2s_note_publish'), 'submit-text' => $_strings['fb--publish-note'], 'can-schedule?' => false, 'can-publish?' => !@$_config['read_only'], ]; if(E2_EDITION){ $we['can-schedule?']=true; $we['stamp-formatted']=''; if ($te==='scheduled'){ $we['stamp-formatted']=ky( 'd.m.Y H:i:s',$n2['Stamp'],dy($n2) ); } $we['submit-schedule-text']=$_strings['fb--publish-note-at-this-time']; } } } $ue=[]; if ($te==='public'){ $noteView -> setWantNewCommentsCount($je); $noteView -> setWantSharingButtons($settings['appearance']['show_sharing_buttons']); $noteView -> setWantRelatedNotes(true); if(Log::$cy)__log('Navigation {'); $ie=nm($n2,'prev'); $oe=nm($n2,'next'); if ($ie){ $ue['prev-href']=jv('e2m_note', array ('*note' => $ie)); $ue['prev-title']=h3(htmlspecialchars($ie['Title'],ENT_NOQUOTES,HSC_ENC)); } if ($oe){ $ue['next-href']=jv('e2m_note', array ('*note' => $oe)); $ue['next-title']=h3(htmlspecialchars($oe['Title'],ENT_NOQUOTES,HSC_ENC)); } $ue['title']=$_strings['nm--posts']; $ue['timeline?']=false; $ue['this-title']=h3(htmlspecialchars($n2['Title'],ENT_NOQUOTES,HSC_ENC)); if(Log::$cy)__log('}'); if(Log::$cy)__log('Comments {'); $pe=''; $c6=false; $v6=false; $b6=array(); if ($je){ $y6=e2_note_cache_filename_with_id_($n2['ID'] .'-comments-author'); } else { $y6=e2_note_cache_filename_with_id_($n2['ID'] .'-comments'); } $n6=null; if(CACHE_NOTES_COMMENTS and is_file($y6)) { $n6=@unserialize(file_get_contents($y6)); } if(is_array($n6)) { if(Log::$cy)__log('retrieve cached ctree'); $pe=$n6; } else { if(Log::$cy)__log('assemble ctree...'); $m6=b2($n2['ID']); $f6=array(); $d6=true; foreach ($m6 as $t => $s6){ if ($s6['IsVisible']) { $a6=hf( $n2, $s6, $t+1 ); if ($a6['new?'] and $d6){ $a6['first-new?']=true; $d6=false; } $f6[] = $a6; } } $pe=$f6; if(CACHE_NOTES_COMMENTS)n3($y6,serialize($pe)); } if (!@$_config['read_only'] and n2($n2)) { $q6=if_($n2); $q6['.comment-number']=count($pe)+1; } if(Log::$cy)__log('} // Comments'); } if(E2_EDITION){ if (!$he){ $noteView -> setWantPreviewHref(true); } } $ax=$noteView -> getNoteCTree(); if(E2_EDITION){ if ($he){ unset ($ax['href']); $ue=[]; } } if ($je and n2($n2,NOTE_COMMENTABLE_NOW_CONDITIONALLY)) { if ($n2['IsCommentable']) { $b6['href']=jv('e2m_note_flag', array ( '*note' => $n2, 'flag' => 'IsCommentable', 'value' => 0, )); $b6['text']=$_strings['bt--close-comments-to-post']; } else { $b6['href']=jv('e2m_note_flag', array ( '*note' => $n2, 'flag' => 'IsCommentable', 'value' => 1, )); $b6['text']=$_strings['bt--open-comments-to-post']; } } if ($je and $ax['new-comments-count'] > 0){ if(Log::$cy)__log('mark comments as not new'); e2_drop_caches_for_note_($nx,true); nn('Comments', array ('IsNew' => 0), array ('NoteID' => $n2['ID'])); } if ($je and ($n2['FormatterID']=='calliope')) { if(is_file(USER_FOLDER.'calliope/WikiFormatter.php')) { $ax['text']=w3().$ax['text']; } } $d=[ 'title' => $n2['Title'], 'notes' => ['only' => $ax], 'pages' => $ue, 'summary' => $ax['summary'], ]; if ($pe) $d['comments']['each']=$pe; if ($b6) $d['comments']['toggle']=$b6; $d['comments']['count']=$ax['comments-count']; $d['comments']['count-text']=$ax['comments-count-text']; $d['comments']['new-count']=$ax['new-comments-count']; $d['comments']['new-count-text']=$ax['new-comments-count-text']; $d['comments']['display-form?']=n2($n2); if (!empty ($q6)) { $d['form']='form-comment'; $d['form-comment']=$q6; } if (!empty ($we)) { $d['form']='form-note-publish'; $d['form-note-publish']=$we; } if(Log::$cy)__log('} // Note'); return $d; } function e2m_note_read($parameters=array ()) { global$_config; if (!$_config['count_reads']) { die ('Read counting disabled'); } if(Log::$cy)__log('Note read {'); $n2=$parameters['*note']; kn( "UPDATE LOW_PRIORITY `". $_config['db_table_prefix']."Notes` ". "SET `ReadCount` = `ReadCount` + 1 ". "WHERE `ID` = ". $n2['ID'] ); $l6=time(); $l6=$l6 - ($l6 % SECONDS_IN_AN_HOUR); yn( 'Actions', [ 'EntityID' => $n2['ID'], 'Stamp' => $l6, 'ReadCount' => 1, ], 'INSERT LOW_PRIORITY', 'ON DUPLICATE KEY UPDATE `ReadCount` = `ReadCount` + 1' ); kn( "DELETE LOW_PRIORITY FROM `". $_config['db_table_prefix']."Actions` ". "WHERE (`Stamp` < ". (time() - (SECONDS_IN_A_MONTH)) .")" ); if(Log::$cy)__log('}'); c(jv('e2m_note',$parameters)); } function e2m_note_withdraw($parameters=array ()) { global$_strings; $pq=$parameters['*note']; if (!$pq) return e2_error404_mode(); if($_SERVER['REQUEST_METHOD']!='POST'){ c(jv('e2m_note', array ('*note' => $pq))); } $z6=jv('e2m_note_broadcast', array ('*note' => $pq)); $pq['IsPublished']=0; $pq['IsCommentable']=0; $pq['IsVisible']=1; $pq['Stamp']=time(); $pq['IP']=q2(); if($parameters['alias']) { $pq['OriginalAlias']=$parameters['alias']; } else { $pq['OriginalAlias']=on( 'find','n',$pq['ID'],$pq['Title'] ); } e2_drop_caches_for_note_($pq['ID'],null); if ($pq['IsFavourite']) { @unlink(CACHE_FILENAME_FAVS); } nn('Notes',$pq); za($pq['ID']); p3($z6); on('set','n',$pq['ID'],''); c(jv('e2m_note', ['*note' => $pq])); } function e2m_note_delete($parameters=array()) { global$_strings; $pq=$parameters['*note']; if (!$pq) return e2_error404_mode(); $te=xm($pq); $k6=!$pq['IsPublished']; if ($k6){ $x6=e2l_get_string('gs--draft-will-be-deleted', array ( 'draft' => htmlspecialchars($pq['Title'],ENT_NOQUOTES,HSC_ENC), )); } else { $x6=e2l_get_string('gs--post-will-be-deleted', array ( 'post' => htmlspecialchars($pq['Title'],ENT_NOQUOTES,HSC_ENC), )); } $e6=$k6? $_strings['pt--draft-deletion']:$_strings['pt--post-deletion']; $r6=array ( '.note-id' => $pq['ID'], '.is-draft' => (int)$k6, 'note-title' => htmlspecialchars($pq['Title'],ENT_COMPAT,HSC_ENC), 'caution-text' => $x6, 'form-action' => jv('e2s_note_delete'), 'submit-text' => $_strings['fb--delete'], 'draft?' => (int)$k6, ); if ($te==='public'){ $r6['hide-href']=jv( 'e2m_note_flag', [ '*note' => $parameters['*note'], 'flag' => 'IsVisible', 'value' => 0 ] ); } if ($pq['IsPublished']) { $r6['withdraw-href']=jv( 'e2m_note_withdraw',$parameters ); } $d=array ( 'title' => $e6. ': '. htmlspecialchars($pq['Title'],ENT_NOQUOTES,HSC_ENC), 'heading' => $e6, 'form' => 'form-note-delete', 'form-note-delete' => $r6, ); return $d; } function e2m_note_flag_favourite($parameters){ global$_config; $parameters['flag']='IsFavourite'; s([ 'flag-name' => 'favourite', 'candy-name' => 'e2m_note_flag_favourite', 'parameters' => $parameters, 'flipping-function' => function () use ($parameters){ cm($parameters); }, ]); } function e2m_note_flag($parameters){ cm($parameters); c(jv('e2m_note',$parameters)); } function cm($parameters){ $nx=$parameters['*note']['ID']; if (!is_numeric($nx)) { return e2_error404_mode(); } e2_drop_caches_for_note_($nx,$parameters['*note']['IsPublished']); if($parameters['flag']=='IsFavourite'){ @unlink(CACHE_FILENAME_FAVS); } if($parameters['flag']=='IsVisible'){ ds(); } nn('Notes', array ( 'ID' => $nx, $parameters['flag'] => (int) ($parameters['value']==1), )); try { cy(ym($nx)); } catch (AeMySQLException $e){ kv($e,'Could not broadcast note flag change'); } return true; } function e2m_note_use_formatter($parameters){ $nx=$parameters['*note']['ID']; if (!is_numeric($nx)) { return e2_error404_mode(); } e2_drop_caches_for_note_($nx,$parameters['*note']['IsPublished']); if(in_array($parameters['formatter'], array ('calliope','raw','neasden'))) { nn('Notes', array ( 'ID' => $nx, 'FormatterID' => $parameters['formatter'], )); echo 'formatter set to '. $parameters['formatter']; } else { echo 'unknown formatter'; } die; } function vm($t6,$parameters=array ()) { global$full_blog_url,$_strings,$_config; $e6=$_strings['pt--new-post']; $j6=$_strings['pt--new-post']; $nx='new'; $h6=$_config['default_formatter']; if ($t6=='edit'){ $pq=$parameters['*note']; if (!$pq) return e2_error404_mode(); if ($pq){ $g6=(string)$pq['Summary']; if ($pq['IsPublished']) { $j6=$_strings['pt--edit-post']; $w6=''; $g7=$parameters['alias']; } else { $j6=$_strings['pt--edit-draft']; $w6=on( 'find','n',$pq['ID'],$pq['Title'] ); if (@$pq['OriginalAlias']) { $g7=$pq['OriginalAlias']; } else { $g7=$w6; } } } $nx=$pq['ID']; $h6=$pq['FormatterID']; $e6=$pq['Title']; } $u6=mf(); $i6=array(); if ($u6!==null) foreach ($u6 as $o6){ $i6[] = $o6['tag']; } $p6=array(); if ($t6=='edit' and count($i6)) { $u6=cf($pq['ID']); foreach ($u6 as $o6){ $p6[] = htmlspecialchars($o6['Keyword'],ENT_NOQUOTES,HSC_ENC); } } $cr=array(); foreach ($i6 as $o6){ $vr['name']=$o6; $vr['selected?']=in_array($o6,$p6); $cr[] = $vr; } $br=''; $p6=implode(', ',$p6); if ($p6)$br=$p6; if ($t6=='write'){ $yr=$_strings['fb--save-and-preview']; } if ($t6=='edit'){ if(array_key_exists('draft',$parameters)) { $yr=$_strings['fb--save-and-preview']; } else { $yr=$_strings['fb--save-changes']; } } $gs=[]; if ($t6=='edit'){ $gs=g3( $pq['FormatterID'],$pq['Text'],'full' ); } $ws=@unserialize( $pq['Uploads'] ) or $ws=[]; $nr=qb( fb( sb( $gs,$ws ) ) ); if ($t6=='edit'){ k3( 'Notes', $pq, $gs ); } $n4=min($pq['Stamp'],time()); if(E2_EDITION){ $n4=$pq['Stamp']; } $aq=r3(); $qq=t3($aq); $ll=dy($pq); $te=xm($pq); $d['title']=$e6; $d['heading']=$j6; $d['form']='form-note'; $d['uploads'] = [ 'enabled?' => $qq, 'each' => $nr, 'default-name' => htmlspecialchars($g7,ENT_COMPAT,HSC_ENC), 'upload-action' => jv('e2j_file_upload'), 'remove-action' => jv('e2j_file_remove'), ]; $d['form-note'] = [ '.note-id' => $nx, '.formatter-id' => $h6, '.last-modified-stamp' => (int)$pq['LastModified'], '.published?' => (bool)$pq['IsPublished'], '.old-tags-hash' => md5($br), '.action' => $t6, 'form-action' => jv('e2s_note_process'), 'form-note-livesave-action' => jv('e2j_note_livesave'), 'create:edit?' => (bool) ($t6=='write'), 'title' => htmlspecialchars($pq['Title'],ENT_COMPAT,HSC_ENC), 'tags' => $br, 'tags-info' => $cr, 'text' => htmlspecialchars($pq['Text'],ENT_NOQUOTES,HSC_ENC), 'all-tags' => $i6, 'stamp-formatted' => ky('d.m.Y H:i:s',$n4,$ll), 'time' => $pq['IsPublished']? [(int)$n4,$ll]:false, 'draft?' => $te==='draft', 'uploads-enabled?' => $qq, 'summary' => $g6, 'alias-autogenerated' => htmlspecialchars($w6,ENT_COMPAT,HSC_ENC), 'alias' => htmlspecialchars($g7,ENT_COMPAT,HSC_ENC), 'submit-text' => $yr, 'space-usage' => j3($aq), ]; if ($t6=='edit'){ $d['related-delete-href']=jv( 'e2m_note_delete', array ('*note' => $pq) ); } return $d; } function e2m_note_edit($parameters=array ()) { return vm('edit',$parameters); } function e2m_write(){ return vm('write'); } function e2s_note_process(){ global$_fp_error,$_strings; $nx=lm(); if (!$nx){ if($_fp_error==FP_TITLE_OR_TEXT_EMPTY){ mv($_strings['er--post-must-have-title-and-text'],E2E_USER_ERROR); } elseif($_fp_error==FP_NO_ID_OR_NEW){ } else { mv($_strings['er--error-occurred']); } c(jv('e2m_write')); } try { $n2=ym($nx); c(jv('e2m_note', ['*note' => $n2])); } catch (AeMySQLException $e){ kv($e,'Could not get note by ID'); c(); } die; } function e2s_note_publish(){ global$_strings,$_config,$settings; $nx=false; if(array_key_exists('note-id',$_POST)) { $nx=$_POST['note-id']; $mr=false; $pq=ym($nx); $fr=$pq['OriginalAlias']; $dr=$pq['Stamp']; $sr=!$pq['IsExternal']; if(E2_EDITION){ if (@$_POST['submit-button']=='schedule'){ $mr=@$_POST['stamp']; } if ( (is_dir(USER_FOLDER) and !is_writable(USER_FOLDER)) or ( is_file(USER_FOLDER.'scheduled.psa') and !is_writable(USER_FOLDER.'scheduled.psa') ) ) { fv(); c(jv('e2m_note', ['*note' => $pq])); } } $pq['ID']=$nx; $pq['IsVisible']=1; $pq['IsPublished']=1; $pq['IsCommentable'] = (int)$settings['comments']['default_on']; $pq['IsFavourite']=0; if(array_key_exists('browser-offset',$_POST)) { $ll=wy(@$_POST['browser-offset']); } else { $ll=ay(); } if ($mr and $n4=qm($mr,$ll)) { $pq['Stamp']=$n4; if(E2_EDITION){ if ($n4 > time())jm($pq); } } elseif ($sr){ $pq['Stamp']=time(); } else { $pq['Stamp']=$dr; } if (la($pq)) { $pq['IsIndexed']='1'; } if ($ll){ $pq['Offset'] = (int)$ll['offset']; $pq['IsDST'] = (int)$ll['is_dst']; } e2_drop_caches_for_note_($nx,null); nn('Notes',$pq); $g7=''; if ($fr or $fr==='0'){ $g7=on('set','n',$nx,$fr); $pq['OriginalAlias']=$g7; } if ($g7!=$fr){ nn('Notes',$pq); } if ($te==='public'){ cy($pq); } c(jv('e2m_note', array ('*note' => $pq))); } c(); } function bm($nx,$ar=-1){ global$_config; $qr=true; if ($ar){ $qr=false; } if ($ar === -1){ $qr=null; } e2_drop_caches_for_note_($nx,$qr); if (!$ar or $ar === -1) { @unlink(CACHE_FILENAME_FAVS); } kn( "DELETE FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID` = '". ((int)$nx) ."'", 'delete note by ID' ); za($nx); kn( "DELETE FROM `". $_config['db_table_prefix']."Aliases` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `EntityType` = 'n' ". "AND `EntityID`=". ((int)$nx), 'delete aliases after deleting note' ); kn( "DELETE FROM `". $_config['db_table_prefix']."NotesKeywords` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `NoteID`=". ((int)$nx), 'delete tag bindings after deleting note' ); } function e2s_note_delete(){ global$_strings,$_config; $nx=$_POST['note-id']; $ar=(bool)$_POST['is-draft']; $pq=ym($nx); $z6=jv('e2m_note_broadcast', array ('*note' => $pq)); bm($nx,$ar); p3($z6); if ($ar){ c(jv('e2m_drafts', ['page' => 1])); } else { c(); } die; } function e2j_note_livesave(){ die (lm('ajaxresult')); } function ym($xs){ global$_config; kn( "SELECT * FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID` = '". $xs ."'" ); $ib=xn(); if(count($ib) > 0){ return $ib[0]; } else { return false; } } function nm($n2,$lr,$zr=1){ global$_strings,$_config; $kr=($lr=='next')?'>':'<'; $xr=($lr=='next')?'':'DESC '; try { kn( "SELECT * FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished`=". $zr ." ". "AND `Stamp` ". $kr ." '". $n2['Stamp'] ."' ". "OR (`Stamp` = '". $n2['Stamp'] ."' AND `ID` ". $kr.$n2['ID'] .") ". em(k2()). "ORDER BY `Stamp` ". $xr.", `ID` ". $xr . "LIMIT 1", 'get '. $lr .' note' ); $ib=xn(); if(count($ib) > 0) return $ib[0]; else return false; } catch (AeMySQLException $e){ kv($e,'Could not get '. $lr .' note'); return null; } } function mm($er){ global$_config; if(Log::$cy)__log('Lastmodifieds for Local Copier'); if(CACHE_LASTMODIFIEDS and is_file(CACHE_FILENAME_LASTMODIFIEDS)) { $rr=@unserialize(file_get_contents(CACHE_FILENAME_LASTMODIFIEDS)); if ($rr['ids_csv']==$er){ if(Log::$cy)__log('Returned from cache'); return $rr['lastmodifieds_json']; } } $b='`ID`='. str_replace(',',' OR `ID`=',$er); $tr=array(); kn( "SELECT `ID`, `LastModified` ". "FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND (". $b .")", 'get lastmodifieds for Local Copier' ); if(Log::$cy)__log('Requested from DB'); $q1=xn(); foreach ($q1 as $t => $xf){ $tr[(int)$xf['ID']] = (int)$xf['LastModified']; } $jr=json_encode($tr); if ($jr=='[]')$jr='{}'; $rr=array ( 'ids_csv' => $er, 'lastmodifieds_json' => $jr, ); if(CACHE_LASTMODIFIEDS){ n3(CACHE_FILENAME_LASTMODIFIEDS,serialize($rr)); } return $jr; } function fm($hb,$jb,$tb=false){ global$_config; list ($gr,$wr)=jy($hb,$jb,$tb); kn( "SELECT * FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished` AND (`Stamp` BETWEEN " .$gr. " AND " .$wr. ") ". "ORDER BY Stamp", 'get all notes for the date '. $tb .'.'. $jb .'.'. $hb ); $d=[]; foreach (xn() as $ur){ if(is_numeric($tb)) { $ir=((int)$hb) .'/'. ((int)$jb) .'/'. ((int)$tb) == ky('Y/n/j',$ur['Stamp'],dy($ur)); } elseif(is_numeric($jb)) { $ir=((int)$hb) .'/'. ((int)$jb) == ky('Y/n',$ur['Stamp'],dy($ur)); } else { $ir=((int)$hb) == ky('Y',$ur['Stamp'],dy($ur)); } if ($ir)$d[] = $ur; } return $d; } function e2_published_noterec_with_parameters_($parameters=array ()) { $n2=e2_noterec_with_parameters_($parameters); if ($n2['IsPublished']) return $n2; } function e2_noterec_with_parameters_($parameters=array ()) { global$_config; $n2=false; $or_=false; if ((string) @$parameters['oalias']!=='')$or_=$parameters['oalias']; if ((string)$or_!==''){ kn( "SELECT * FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `OriginalAlias` = '". $or_ ."' ". "AND `IsPublished` = 0", 'get note record by original alias' ); $n2=xn(); if(count($n2)===1) { $n2=@$n2[0]; if ($n2) return $n2; } } $pr=false; if (@$parameters['draft']!=='') $pr=$parameters['draft']; if (@$parameters['draft2']!=='')$pr=$parameters['draft2']; if ($pr){ $n2=ym($pr); return $n2; } if ((string)$or_!==''){ $parameters['alias']=$or_; } if ((string) @$parameters['alias']!==''){ if ($ct=in(@$parameters['alias'])) { if ($ct['type']=='n'){ $n2=ym($ct['id']); if ($n2['IsPublished']) return $n2; } } } $vt=fm($parameters['year'],$parameters['month'],$parameters['day']); if (@$vt[$parameters['day-number']-1]) { return $vt[$parameters['day-number']-1]; } } function am($e6,$tv,$ll,$bt){ global$_config; ss(); @unlink(CACHE_FILENAME_DRAFTS); @unlink(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); $n2=array ( 'Title' => $e6, 'Text' => $tv, 'FormatterID' => $_config['default_formatter'], 'OriginalAlias' => on('find','','',$e6), 'Uploads' => $bt, 'Stamp' => (int)time(), 'LastModified' => (int)time(), ); if ($ll and is_array($ll)) { $n2['Offset'] = (int)$ll['offset']; $n2['IsDST'] = (int)$ll['is_dst']; } $n2=yn('Notes',$n2); return $n2['ID']; } function qm($yt,$ll){ $nt='/^ *(\d{1,2})\.(\d{1,2})\.(\d{2}|\d{4}) +(\d{1,2})\:(\d{1,2})\:(\d{1,2}) *$/'; if(preg_match($nt,$yt,$jb)) { $n4=gmmktime($jb[4],$jb[5],$jb[6],$jb[2],$jb[1],$jb[3]); $n4 -= ly($ll,$n4); return $n4; } else { return false; } } function lm($mt=''){ global$_fp_error,$_config,$_e2utf8__unformat_htmlentity_neasden,$_db; if(Log::$cy)__log('Process note form'); try { $_fp_error=false; $nx=$e6=$ft=$tv=$dt=''; if(array_key_exists('note-id',$_POST)) $nx=$_POST['note-id']; if(array_key_exists('title',$_POST)) $e6=trim($_POST['title']); if(array_key_exists('tags',$_POST)) $ft=$_POST['tags']; if(array_key_exists('text',$_POST)) $tv=trim($_POST['text'],"\r\n"); if(array_key_exists('summary',$_POST)) $g6=trim($_POST['summary'],"\r\n"); if(array_key_exists('old-tags-hash',$_POST)) $dt=$_POST['old-tags-hash']; if(is_array($ft))$ft=implode(', ',$ft); $ft=trim($ft); if ($nx=='new'){ $_e2utf8__unformat_htmlentity_neasden=($_config['default_formatter']=='neasden'); } else { $_e2utf8__unformat_htmlentity_neasden=($_POST['formatter-id']=='neasden'); } $st=vn('Notes'); if(stripos($st['Collation'],'utf8mb4')!==0){ $e6=nb($e6); $ft=nb($ft); $tv=nb($tv,true); } $at=$tv; $at=str_replace("\n",'\n'."\n",$at); $at=str_replace("\r",'\r'."\r",$at); $qt=n(',',$ft,'sort'); $ft=implode(', ',$qt); $lt=md5($ft); if(array_key_exists('browser-offset',$_POST)) { $ll=wy(@$_POST['browser-offset']); } else { $ll=ay(); } $zt=@$_POST['old-stamp']; $mr=@$_POST['stamp']; $g7=@$_POST['alias']; if ($nx!='new'){ $kt=ym($nx); } else { $kt=array(); } if ($nx){ if ((string)$e6!=='' and (string)$tv!==''){ if ($nx=='new'){ $bt=''; if(is_file(USER_FOLDER.'new-uploads.psa')) { $bt=@file_get_contents(USER_FOLDER.'new-uploads.psa'); } try { $nx=am($e6,$tv,$ll,$bt); @unlink(USER_FOLDER.'new-uploads.psa'); $xt=array ( '*note' => ym($nx), ); $et=[ 'success' => true, 'data' => [ 'status' => 'created', 'id' => $nx, 'note-url' => jv('e2m_note',$xt), 'note-edit-url' => jv('e2m_note_edit',$xt) ] ]; $q1=(int)$nx; } catch (AeMySQLException $e){ kv($e,'Could not insert note'); $et=[ 'success' => false, 'error' => [ 'message' => 'Cannot create record' ] ]; $q1=false; } } else { e2_drop_caches_for_note_($nx,$kt['IsPublished']); $rt=$kt; $rt['ID']=$nx; $rt['Title']=$e6; $rt['Summary']=$g6; $rt['Text']=$tv; $rt['FormatterID']=$kt['FormatterID']; $rt['LastModified']=time(); $rt['IsIndexed']='0'; if ($rt['FormatterID']==='calliope'){ $rt['FormatterID']=$_config['default_formatter']; } if ($zt!=$mr){ if ($n4=qm($mr,$ll)) { $rt['Stamp']=min($n4,time()); if(E2_EDITION){ $rt['Stamp']=$n4; if ($n4 > time())jm($rt); } } } $h7=$g7; if ((string)$g7!==''){ $tt=$g7; } elseif (!$kt['IsPublished']) { $tt=$e6; } else { $tt=''; } if ($kt['IsPublished']) { $h7=on( 'set','n',$nx,$tt ); $xt=array ( '*note' => $rt, 'alias' => $h7, ); } else { $jt=true; $h7=on('find','n',$nx,$tt); $rt['OriginalAlias']=$h7; $xt=array ( '*note' => $rt, 'alias' => $h7, ); } $gs=g3( $rt['FormatterID'],$rt['Text'],'full' ); if(count($gs) > 0){ eb($gs); rb($gs); } try { nn('Notes',$rt); if ($rt['IsPublished']) { if (la($rt)) { $rt['IsIndexed']='1'; nn('Notes',$rt); } if ($zt!=$mr){ gn(true); } cy($rt); } $et=[ 'success' => true, 'data' => [ 'status' => 'saved', 'new-alias' => $h7, 'note-url' => jv('e2m_note',$xt), 'note-edit-url' => jv('e2m_note_edit',$xt) ] ]; $q1=(int)$nx; } catch (AeMySQLException $e){ kv($e,'Could not update record'); $et=[ 'success' => false, 'error' => [ 'message' => 'Cannot update record ('. mysqli_error(). ')' ] ]; $q1=false; } } if ($lt!=$dt){ vf(array ('NoteID' => $nx)); foreach ($qt as $am){ $ht=ff($am); if (!$ht){ $ht['ID']=yf($am); } kn( "INSERT INTO `". $_config['db_table_prefix']."NotesKeywords` ". "(`SubsetID`, `NoteID`, `KeywordID`) ". "VALUES (". ((int)$_config['db_table_subset']) .", ". ((int)$nx) .", ". ((int)$ht['ID']). ")", 'add new tag bindings' ); } } if ( $mt!='ajaxresult' and $q1 and $_POST['instant-publish']=='yes' ){ $_POST['note-id']=$nx; e2s_note_publish(); } } else { $et=[ 'success' => false, 'error' => [ 'message' => 'Title or text is empty' ] ]; $_fp_error=FP_TITLE_OR_TEXT_EMPTY; $q1=false; } } else { $et=[ 'success' => false, 'error' => [ 'message' => 'No note id/new specified' ] ]; $_fp_error=FP_NO_ID_OR_NEW; $q1=false; } if($_config['backup_automatically']) { rn(); } } catch (AeMySQLException $e){ kv($e); $et=[ 'success' => false, 'error' => [ 'message' => 'Database error' ] ]; $q1=false; } if ($mt=='ajaxresult') return json_encode($et); else return $q1; } function zm($gt,$wt){ global$_config; if (!($gt and $wt) and !k2()) { if(Log::$cy)__log('Error: e2_notes_count_generic called for invisible items unsecurely'); return null; } if (!is_bool($gt) or !is_bool($wt)) { if(Log::$cy)__log ('Error: e2_notes_count_generic called with non-bool params'); return null; } if (!$gt and !$wt){ if(Log::$cy)__log ('Error: e2_notes_count_generic called with nonsensical parameters'); return null; } $ut=( CACHES_FOLDER . 'notes-count-p'. (int)$gt . ($gt ? ('v'. (int)$wt):'') . '.txt' ); $q1=false; if(CACHE_NOTES_COUNTS and is_file($ut)) { $q1=@file_get_contents($ut); } if(is_numeric($q1) and $q1 > 0){ return $q1; } else { $q1=null; try { kn( "SELECT COUNT(*) As NotesCount FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished`=". (int)$gt. " ". ($gt ? ( "AND `IsVisible`=". (int)$wt ):""), 'count notes with flags p'. (int)$gt . ($gt ? ('v'. (int)$wt):'') ); $q1=xn(); $q1=$q1[0]['NotesCount']; if(CACHE_NOTES_COUNTS)n3($ut,$q1); } catch (AeMySQLException $e){ kv($e); if(Log::$cy)__log('Could not count notes'); } return $q1; } } function km($tv){ $g6=$tv; $g6=preg_match( '/^(\<\/div\>)?\<p( class\=\"lead\")?\>(.*)\<\/p\>$/mu', $g6, $y3 ); $g6=$y3[3]; if (!$g6)$g6=$tv; if(mb_strlen($g6) <= 50)$g6=$tv; $g6=str_replace(array ( '<p>','<blockquote>','<ul>','<ol>','<br />', ), "\n",$g6); $g6=trim(strip_tags($g6)); if(mb_strlen($g6) > 50){ $it=mb_strpos($g6,"\n",50); } else { $it=mb_strrpos($g6,"\n"); } if ($it!==false){ $g6=mb_substr($g6,0,$it); $g6=trim($g6,' :.()'."\n"); } if(preg_match('/^(.{100,}?)(?:[:.!?()]|'."\n".')/su',$g6,$y3)) { $g6=trim($y3[0],' :.()'."\n"); } if(preg_match('/^(.{150,}?)[:.!?(),]/su',$g6,$y3)) { $g6=trim($y3[0],' :.(),'."\n"); } if(preg_match('/^(.{200,}?)[:.!?(), ]/su',$g6,$y3)) { $g6=trim($y3[0],' :.()'."\n"); } $g6=preg_replace('/[ \n\r\t]+/su',' ',$g6); if(mb_substr($g6, -1)==='.')$g6=mb_substr($g6,0, -1); if(mb_substr($g6, -1)===':')$g6=mb_substr($g6,0, -1); if(mb_substr($g6, -1)==='!')$g6=mb_substr($g6,0, -1); if(in_array($g6[mb_strlen($g6)-1], array (',',' '))) { $g6=trim($g6,', '). '...'; } if(mb_strlen($g6) > 250){ $g6=trim(mb_substr($g6,0,250)). '...'; } return $g6; } function xm($n2){ $ot=false; if(E2_EDITION){ $ot=($n2['Stamp'] > time()); } if ($n2['IsPublished']) { if ($ot){ return 'scheduled'; } else { if ($n2['IsVisible']) { return 'public'; } else { return 'hidden'; } } } else { return 'draft'; } } function em($je=false){ if ($je){ return ''; } else { return 'AND (n.`IsVisible` = 1 AND n.`Stamp` <= '. time() .') '; } } function rm($n2){ if(E2_EDITION){ return md5($n2['Text'].$n2['LastModified']); } return ''; } if(E2_EDITION){ function tm(){ $fb=USER_FOLDER.'scheduled.psa'; if (!is_file($fb)) return; if(Log::$cy)__log('Check notes schedule'); $scheduled=(array) @unserialize(file_get_contents($fb)); $pt=array(); $c5=array(); $v5=false; foreach($scheduled as $b5){ if(time() >= @$b5['stamp']) { if (!$v5)ds(); $v5=true; if ($y5[$b5['id']]) continue; $y5[$b5['id']] = true; try { vy(jv( 'e2m_note_json', array ('*note' => ym($b5['id'])) )); } catch (AeMySQLException $e){ kv($e,'Could not broadcast a note published by schedule'); } } else { $pt[] = $b5; } } foreach ($pt as $b5){ if (!@$y5[$b5['id']]) { $c5[] = $b5; } } if ($v5){ if(count($c5)) { @n3($fb,serialize($c5)); } else { @unlink($fb); } } } function jm($pq){ $fb=USER_FOLDER.'scheduled.psa'; $scheduled=@unserialize(file_get_contents($fb)); if (!is_array($scheduled))$scheduled=array(); $scheduled[] = array ( 'id' => $pq['ID'], 'stamp' => $pq['Stamp'], ); @n3($fb,serialize($scheduled)); } function hm($nx,$fx){ global$_config,$_strings,$_current_url; $je=k2(); $relatedNotesCollectionView=new AeArbitraryNotesCollectionView('related notes'); $relatedNotesCollectionView -> setCurrentURL($_current_url); $relatedNotesCollectionView -> setFilterOutIDs($fx); if(CACHE_NOTES_RELATED){ $relatedNotesCollectionView -> setCacheFilename(CACHES_FOLDER.'note-'. $nx .'-related.psa'); } $relatedNotesCollectionView -> setSQLRequest( "SELECT * FROM `". $_config['db_table_prefix'] ."Notes` n ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND n.`IsPublished` = 1 ". "AND n.`IsFavourite` = 1 ". em($je). "AND `ID` IN (". "SELECT `NoteID` FROM (". "SELECT `NoteID`, COUNT(`KeywordID`) `KeywordsCount` ". "FROM `". $_config['db_table_prefix'] ."NotesKeywords` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `KeywordID` IN (". "SELECT `KeywordID` FROM `". $_config['db_table_prefix'] ."NotesKeywords`". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `NoteID` = ". $nx ."". ") ". "AND `NoteID` != ". $nx ." ". "GROUP BY `NoteID` ". "ORDER BY `KeywordsCount` DESC ". ") As RelatedNotesIDs". ") ". "ORDER BY MD5(`ID`+". ($nx*2) .") DESC ". "LIMIT 7" ); $n5=$relatedNotesCollectionView -> getNotesCTree(); if(count($n5)) { $de=[ 'each' => $n5, 'seed' => $nx, 'title' => $_strings['nm--read-next'], ]; } else { $de=[]; } return $de; } } function e2m_drafts($parameters){ global$_strings,$_config; $je=k2(); $draftsView=new AePageableNotesView('e2m_drafts',$parameters); $draftsView -> setPortionSize((int)$_config['drafts_per_page']); $draftsView -> setNextPrevPageTitles($_strings['gs--earlier'],$_strings['gs--later']); $draftsView -> setWantPaging(true); $draftsView -> setUseLocalHrefs(true); if($draftsView -> isFirstPage() and CACHE_DRAFTS){ $draftsView -> setCacheFilename(CACHE_FILENAME_DRAFTS); } $draftsView -> setLimitlessSQLRequest( "SELECT * ". "FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished`=0 ". "ORDER BY `LastModified` DESC" ); $m5=$draftsView -> getNotesCTree(); if(count($m5)) { if(Log::$cy)__log('Thumbnails {'); foreach ($m5 as $t => $xf){ $m5[$t]['thumbs']=qb(@$xf['format-info']['resources-detected']); } if(Log::$cy)__log('}'); } $d=[ 'title' => $_strings['pt--drafts'], 'heading' => $_strings['pt--drafts'], 'notes' => $m5, 'pages' => $draftsView -> getPagesCTree(), ]; if($draftsView -> isFirstPageOfEmptyView()) { $d['nothing']=$_strings['gs--no-drafts']; } elseif (!$draftsView -> isExistingPage()) { return e2_error404_mode(); } return $d; } function gm($f5){ global$_config; if(Log::$cy)__log('Drafts: find duplicate OriginalAliases...'); if(CACHE_DRAFTS_ALIAS_USE_COUNTS and is_file(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS)) { $d5=@unserialize(file_get_contents(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS)); } if(CACHE_DRAFTS_ALIAS_USE_COUNTS and is_array($d5)) { if(Log::$cy)__log('Drafts: retrieve cached'); } else { if(Log::$cy)__log('Drafts: assemle cacheable...'); $d5=array(); kn( "SELECT `OriginalAlias` FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished`=0 ". "ORDER BY `ID`", 'get original aliases of drafts to calculate use counts' ); $q1=xn(); $s5=array(); foreach ($q1 as $t => $n2){ @$d5[$n2['OriginalAlias']] ++; } if(CACHE_DRAFTS_ALIAS_USE_COUNTS){ n3(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS,serialize($d5)); } } return $d5[$f5]; } function wm(){ global$_strings,$_user_folder_name; $a5='https://'. $_strings['e2--website-host'] .'/'; $q5='('. $_strings['e2--release'] .' '. E2_RELEASE .', v'. E2_VERSION .')'; return [ 'built?' => BUILT, 'installed?' => (fn_()!==null), 'version' => 'v'. E2_VERSION, 'version-description' => $_strings['e2--vname-aegea'] .' '. $q5, 'user-folder-name' => $_user_folder_name, 'cookie-prefix' => b(), 'href' => $a5, 'about' => ( '<span title="E2 '.$q5 .'">'. $_strings['e2--powered-by'] .' '. '<a href="'. $a5 .'" class="nu"><u>'. $_strings['e2--vname-aegea'] .'</u> '. '<span class="e2-svgi">'. is('aegea') .'</span></a></span>' ), ]; } function um($candy,$l5,$z5,$k5,$ue){ global$full_blog_url,$content, $_config, $_candies_indexable, $_candies_indexable_conditionally, $_template, $_newsfeeds, $_current_url; $meta['base-href']=$full_blog_url. '/'; $meta['current-href']=$_current_url; $meta['stylesheets']=ps(); $meta['scripts']=ca(); $meta['newsfeeds']=$_newsfeeds; $meta['favicon-type']='image/x-icon'; $meta['favicon-href']='favicon.ico'; if ($x5=bd()) { $meta['favicon-type']=v3($x5); $meta['favicon-href']=$x5; $meta['apple-touch-icon-href']=bd('square'); } $meta['navigation-links'] = [[ 'rel' => 'index', 'href' => jv('e2m_frontpage', ['page' => 1]), 'id' => 'link-index', ]]; if (!empty ($ue)) { foreach (['prev','next','earlier','later'] as $e5){ if(array_key_exists($e5 .'-href',$ue)) { $kr=$e5; if ($e5=='earlier')$kr='prev'; if ($e5=='later')$kr='next'; $meta['navigation-links'][] = [ 'rel' => $kr, 'href' => $ue[$e5 .'-href'], 'id' => 'link-'. $e5, ]; } } } $r5='noindex, follow'; if (@$_config['index_follow_everything']) { $r5='index, follow'; } if(in_array($candy,$_candies_indexable)) { $meta['robots']='index, follow'; } if(in_array($candy,$_candies_indexable_conditionally)) { $meta['robots']=$r5; } $meta['viewport']=$_template['meta_viewport']; if(is_file(MEDIA_ROOT_FOLDER.'manifest.json')) { $meta['manifest-href']=$full_blog_url. '/manifest.json'; } $meta['og-images'] = []; if(is_array($l5['only']['og-images'])) { $meta['og-images']=$l5['only']['og-images']; $meta['twitter-card']='summary_large_image'; } if(is_array($z5['og-images'])) { $meta['og-images']=$z5['og-images']; $meta['twitter-card']='summary_large_image'; } if (!count($meta['og-images'])) { $meta['og-images'] = array ($k5['userpic-large-href']); $meta['twitter-card']='summary'; } return$meta; } function im(){ global$_superconfig,$_config; $t5=[ 'new-note-href' => jv('e2m_write'), 'drafts-href' => jv('e2m_drafts', ['page' => 1]), 'drafts-count' => (int)zm(false,true), 'settings-href' => jv('e2m_settings'), 'theme-preview-href' => jv('e2m_theme_preview', array ('theme' => '')), 'password-href' => jv('e2m_password', array ('recovery-key' => '')), 'database-href' => jv('e2m_database'), 'timezone-href' => jv('e2m_timezone'), 'sessions-href' => jv('e2m_sessions'), 'sign-out-href' => jv('e2m_sign_out'), ]; if (p()) { $t5['get-backup-href']=jv('e2m_get_backup'); } if (@$_config['read_only']) { unset ($t5['new-note-href']); unset ($t5['settings-href']); unset ($t5['timezone-href']); } if (@$_superconfig['disallow_themes_preview']) { unset ($t5['theme-preview-href']); } if (@$_superconfig['disallow_db_config']) { unset ($t5['database-href']); } list ($qe,$j5,$h5)=v2(); if ($qe){ $t5['new-comments-count']=$qe; $t5['new-comments-href']=$h5; } return $t5; } function e2m_tags(){ global$_strings; $d['title']=$_strings['pt--tags']; $d['heading']=$_strings['pt--tags']; $d['tags']=nf([]); $g5=mf(true); if ($g5===null){ $d['unavailable?']=true; } else { $d['tags']['each']=$g5; if(count($g5)==0){ $d['nothing']=$_strings['gs--no-tags']; } } return $d; } function e2m_tag($parameters=[]) { global $settings, $_config, $_current_tags, $_strings, $page, $full_blog_url; if(Log::$cy)__log('Tag {'); $je=k2(); $tagNotesView=new AePageableNotesView('e2m_tag',$parameters); $tagNotesView -> setPortionSize($settings['appearance']['notes_per_page']); $tagNotesView -> setNextPrevPageTitles($_strings['gs--earlier'],$_strings['gs--later']); $tagNotesView -> setWantPaging(true); $tagNotesView -> setWantNewCommentsCount($je); $tagNotesView -> setWantReadHrefs($_config['count_reads']); $tagNotesView -> setWantControls($je and !@$_config['read_only']); $tagNotesView -> setWantHiddenTags($je); if(E2_EDITION){ $tagNotesView -> setWantPreviewHrefs(true); } $w5=[]; if(array_key_exists('*tags',$parameters)) { foreach($parameters['*tags'] as $q2){ if ($je or $q2['IsVisible']) { $w5[] = $q2; } } } if (!$w5[0]) return e2_error404_mode(); $u5=count($w5); $o6=$w5[0]; $i5=$parameters['tag-alias']; $_current_tags=[]; foreach ($w5 as $o6)$_current_tags[] = $o6['Keyword']; $tagNotesView -> setHighlightedTags($_current_tags); if(CACHE_TAG and $tagNotesView -> isFirstPage() and $u5===1){ if ($je){ $tagNotesView -> setCacheFilename(e2_cache_filename_with_id_($o6['ID'],CACHE_FILENAMES_TAG_AUTHOR)); } else { $tagNotesView -> setCacheFilename(e2_cache_filename_with_id_($o6['ID'],CACHE_FILENAMES_TAG)); } } foreach ($w5 as $o6) if ($o6)$o5[] = "nk.`KeywordID`=". $o6['ID']; $p5=( "FROM `". $_config['db_table_prefix'] ."Notes` n ". "JOIN `". $_config['db_table_prefix'] ."NotesKeywords` nk ". "ON nk.`NoteID` = n.`ID` ". "WHERE n.`SubsetID`=". $_config['db_table_subset'] ." ". "AND nk.`SubsetID`=". $_config['db_table_subset'] ." ". "AND (". implode(" OR ",$o5).") ". "AND IsPublished=1 ". em($je). "GROUP BY n.`ID` ". "HAVING COUNT(*)>=". $u5 ); $tagNotesView -> setSQLCountRequest( "SELECT COUNT(*) Total FROM (SELECT 1 ". $p5 .") _" ); $tagNotesView -> setLimitlessSQLRequest( "SELECT n.*, COUNT(*) ". $p5 ." ". "ORDER BY n.`Stamp` DESC" ); $cj=bf($o6['ID'],5); $vj=''; $z5['description']=''; $z5['summary']=''; $z5['visible?'] = (bool)$o6['IsVisible']; if ($u5==1){ if ($je){ $z5['edit-href']=jv( 'e2m_tag_edit', array ('tag-alias' => $i5) ); } if ((string)$o6['Description']!==''){ $z1=i3($o6['Description'],'full'); $vn=$z1['text-final']; $z5['description']=$vn; $z5['description-format-info']=$z1['meta']; va(@$z1['meta']['links-required']); } if ((string)$o6['Summary']!==''){ $z5['summary']=h3(htmlspecialchars($o6['Summary'],ENT_NOQUOTES,HSC_ENC)); } elseif ((string)$z5['description']!==''){ $z5['summary']=km($z5['description']); }; $bj=jv('e2m_tag_rss', array ('tag-alias' => $i5)); $yj=jv('e2m_tag_json', array ('tag-alias' => $i5)); zd( 'rss', cd() .': '. $o6['Keyword'], $bj ); zd( 'json', cd() .': '. $o6['Keyword'], $yj ); $z5['og-images']=d3( sb( $z5['description-format-info']['resources-detected'], q3('tag',$o6['ID']) ) ); $z5['name']=htmlspecialchars($o6['Keyword'],ENT_COMPAT,HSC_ENC); if(E2_EDITION){ $z5['popular']=a2($o6['ID']); $z5['related']=$cj; } $vj=htmlspecialchars($o6['PageTitle'],ENT_COMPAT,HSC_ENC); } $nj=$tagNotesView -> getTotalNotes(); $z5['notes-count']=$nj; $z5['notes-count-text']=e2l_get_string('pt--n-posts', array ('number' => $nj)); $mj=$z5['notes-count-text'] .' '. $_strings['gs--tagged']; $fj=[]; foreach ($w5 as $xf){ $fj[] = htmlspecialchars($xf['Keyword'],ENT_COMPAT,HSC_ENC); } $fj=implode(', ',$fj); if ((string)$vj!==''){ $e6=$vj; $j6=$vj; } else { $e6=cd() .': '. $mj .' '. $fj; if(count($w5) > 1){ $j6=$_strings['pt--tags'] .': '. $fj; } else { $j6=$_strings['pt--tag'] .': '. $fj; } } $se=nf($parameters); $d=[ 'title' => $e6, 'heading' => htmlspecialchars_decode($j6,ENT_COMPAT), 'notes' => $tagNotesView -> getNotesCTree(), 'pages' => $tagNotesView -> getPagesCTree(), 'tags' => $se, ]; if ( !$tagNotesView -> isExistingPage() and !$tagNotesView -> isFirstPageOfEmptyView() ) { return e2_error404_mode(); } if ( $tagNotesView -> isFirstPageOfEmptyView() and !$je ){ return e2_error404_mode(); } if($tagNotesView -> isFirstPageOfEmptyView()) { $d['nothing']=$_strings['gs--no-such-notes']; } if ((string)$z5['summary']!==''){ $d['summary']=$z5['summary']; } if(count($w5)==1){ $d['tag']=$z5; if (k2()) { $d['related-edit-href']=$z5['edit-href']; $d['related-edit-title']=$_strings['tt--edit-tag']; } } if(Log::$cy)__log('} // Tag'); return $d; } function e2m_tag_edit($parameters=array()) { global$_strings; if(array_key_exists('*tag',$parameters)) { $o6=$parameters['*tag']; } if (!$o6) return e2_error404_mode(); $gs=g3( 'neasden',$o6['Description'],'full' ); $ws=@unserialize( $o6['Uploads'] ) or $ws=[]; $nr=qb( fb( sb( $gs,$ws ) ) ); k3( 'Keywords', $o6, $gs ); $aq=r3(); $dj=[ 'enabled?' => t3($aq), 'each' => $nr, 'default-name' => htmlspecialchars($parameters['tag-alias'],ENT_COMPAT,HSC_ENC), 'upload-action' => jv('e2j_file_upload'), 'remove-action' => jv('e2j_file_remove'), ]; $sj=array ( '.tag-id' => $o6['ID'], '.formatter-id' => 'neasden', 'form-action' => jv('e2s_tag_edit'), 'submit-text' => $_strings['fb--save-changes'], 'tag' => htmlspecialchars($o6['Keyword'],ENT_COMPAT,HSC_ENC), 'page-title' => htmlspecialchars($o6['PageTitle'],ENT_COMPAT,HSC_ENC), 'page-title-placeholder' => htmlspecialchars($o6['Keyword'],ENT_COMPAT,HSC_ENC), 'alias' => htmlspecialchars($parameters['tag-alias'],ENT_COMPAT,HSC_ENC), 'description' => htmlspecialchars($o6['Description'],ENT_COMPAT,HSC_ENC), 'summary' => (string)$o6['Summary'], 'favourite?' => (bool)$o6['IsFavourite'], 'space-usage' => j3($aq), ); $sj['.cache-sensitive-hash']=md5( $sj['tag'] . $sj['uploads'] . $sj['urlname'] ); $d=array ( 'body-uploads-enabled?' => t3($aq), 'title' => $_strings['pt--tag-edit'] .': '. $o6['Keyword'], 'heading' => $_strings['pt--tag-edit'], 'form' => 'form-tag', 'form-tag' => $sj, 'uploads' => $dj, 'related-delete-href' => jv('e2m_tag_delete', array ('*tag' => $o6)), ); return $d; } function e2m_tag_flag_ajax($parameters){ s([ 'flag-name' => 'tag', 'candy-name' => 'e2m_tag_flag_ajax', 'parameters' => $parameters, 'flipping-function' => function () use ($parameters){ om($parameters); }, ]); } function om($parameters){ if(array_key_exists('*tag',$parameters)) { $o6=$parameters['*tag']; } if (!$o6) return e2_error404_mode(); e2_drop_caches_for_tag_($o6['ID']); nn('Keywords', array ( 'ID' => $o6['ID'], $parameters['flag'] => (int) ($parameters['value']==1), )); return true; } function e2m_tag_delete($parameters=array()) { global$_strings; if(array_key_exists('*tag',$parameters)) { $o6=$parameters['*tag']; } if (!$o6) return e2_error404_mode(); $aj=array ( '.tag-id' => $o6['ID'], 'caution-text' => e2l_get_string('gs--tag-will-be-deleted-notes-remain', array ( 'tag' => htmlspecialchars($o6['Keyword'],ENT_COMPAT,HSC_ENC) )), 'tag' => htmlspecialchars($o6['Keyword'],ENT_COMPAT,HSC_ENC), 'form-action' => jv('e2s_tag_delete'), 'submit-text' => $_strings['fb--delete'], ); $d=array ( 'title' => $_strings['pt--tag-delete'] .': '. $o6['Keyword'], 'heading' => $_strings['pt--tag-delete'], 'form' => 'form-tag-delete', 'form-tag-delete' => $aj, ); return $d; } function e2m_untagged($parameters=[]) { global$settings,$_strings,$_config; $je=k2(); $untaggedView=new AePageableNotesView('e2m_untagged',$parameters); $untaggedView -> setPortionSize($settings['appearance']['notes_per_page']); $untaggedView -> setNextPrevPageTitles($_strings['gs--earlier'],$_strings['gs--later']); $untaggedView -> setWantPaging(true); $untaggedView -> setWantNewCommentsCount($je); $untaggedView -> setWantReadHrefs($_config['count_reads']); $untaggedView -> setWantControls($je and !@$_config['read_only']); $untaggedView -> setWantHiddenTags($je); if(E2_EDITION){ $untaggedView -> setWantPreviewHrefs(true); } $p5=( "FROM `". $_config['db_table_prefix']."Notes` n ". "LEFT OUTER JOIN `". $_config['db_table_prefix']."NotesKeywords` nk ". "ON nk.`NoteID` = n.`ID` ". "WHERE n.`SubsetID`=". $_config['db_table_subset'] ." ". "AND n.`IsPublished`=1 ". "AND nk.`SubsetID` IS NULL ". em($je) ); $untaggedView -> setSQLCountRequest( "SELECT COUNT(*) Total ". $p5 ); $untaggedView -> setLimitlessSQLRequest( "SELECT n.* ". $p5 ." ORDER BY n.`Stamp` DESC" ); $d=[ 'title' => $_strings['pt--posts-without-tags'], 'heading' => $_strings['pt--posts-without-tags'], 'notes' => $untaggedView -> getNotesCTree(), 'pages' => $untaggedView -> getPagesCTree(), ]; if($untaggedView -> isFirstPageOfEmptyView()) { $d['nothing']=$_strings['gs--no-posts-without-tags']; } elseif (!$untaggedView -> isExistingPage()) { return e2_error404_mode(); } return $d; } function e2s_tag_edit(){ global$_strings,$_config; $qj=$am=$vn=$tt=''; if(array_key_exists('tag-id',$_POST)) $qj=$_POST['tag-id']; if(array_key_exists('tag',$_POST)) $am=$_POST['tag']; if(array_key_exists('page-title',$_POST)) $vj=trim($_POST['page-title'],"\r\n"); if(array_key_exists('description',$_POST)) $vn=trim($_POST['description'],"\r\n"); if(array_key_exists('summary',$_POST)) $g6=trim($_POST['summary'],"\r\n"); if(array_key_exists('urlname',$_POST)) $tt=trim($_POST['urlname'],"\r\n"); if(array_key_exists('cache-sensitive-hash',$_POST)) { $lj=$_POST['cache-sensitive-hash']; $zj=md5($am.$tt); } $st=vn('Notes'); if(stripos($st['Collation'],'utf8mb4')!==0){ $am=nb($am); $vj=nb($vj); $vn=nb($vn,true); } kn( "SELECT * FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID` = ".((int)$qj)."", 'get tag record to update' ); $kj=xn(); if(count($kj)!=1) die; $q2=$kj[0]; kn( "SELECT * FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `Keyword` = '". en($am) ."' ". "AND (`ID` != ".((int)$qj).")", 'make sure new tag name does not conflict with existing ones' ); $kj=xn(); if(count($kj)==0){ if ($zj!=$lj){ ds(); } e2_drop_caches_for_tag_($qj); $q2['ID'] = ((int)$qj); $q2['Keyword']=$am; $q2['PageTitle']=$vj; $q2['Description']=$vn; $q2['Summary']=$g6; $gs=g3( 'neasden',$q2['Description'],'full' ); if(count($gs) > 0){ eb($gs); rb($gs); } nn('Keywords',$q2); $h7=on( 'set','t',$q2['ID'],$tt ); c(jv('e2m_tag', array ('tag-alias' => $h7))); } else { mv($_strings['er--cannot-rename-tag'],E2E_USER_ERROR); v(); } die; } function e2s_tag_delete(){ global$_strings,$_config; $qj=((int)$_POST['tag-id']); ds(); e2_drop_caches_for_tag_($qj); kn( "DELETE FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID`=". $qj, 'delete note by ID' ); kn( "DELETE FROM `". $_config['db_table_prefix']."Aliases` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `EntityType` = 't' ". "AND `EntityID` = ". ((int)$qj), 'delete aliases after deleting note' ); kn( "DELETE FROM `". $_config['db_table_prefix']."NotesKeywords` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `KeywordID`=". $qj, 'delete tag bindings after deleting tag' ); c(jv('e2m_tags')); } function pm($xj){ global$_current_tags,$_config; $ej=null; if(CACHE_FAVTAGS and is_file(CACHE_FILENAME_FAVTAGS)) { $ej=@unserialize(file_get_contents(CACHE_FILENAME_FAVTAGS)); } if (!is_array($ej)) { try { kn( "SELECT * FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsFavourite`=1 ORDER BY `Keyword`", 'get favorite tags for tags menu' ); $rj=xn(); $ej=array(); foreach ($rj as $q2){ $tj['tag']=htmlspecialchars($q2['Keyword'],ENT_NOQUOTES,HSC_ENC); $tj['href']=jv( 'e2m_tag', array ('*tag' => $q2) ); $tj['visible?'] = (bool)$q2['IsVisible']; $ej[] = $tj; } if(CACHE_FAVTAGS)n3(CACHE_FILENAME_FAVTAGS,serialize($ej)); } catch (AeMySQLException $e){ kv($e); if(Log::$cy)__log('Count not get tags menu from database'); } } if (!is_array($ej)) return null; if (!empty ($_current_tags)) { $jj=false; foreach ($ej as $t => $xf){ $ej[$t]['current?']=in_array($ej[$t]['tag'],$_current_tags); if ($ej[$t]['current?']) { $jj=true; $hj=$xj; $hj['flag']='IsFavourite'; $hj['value']=0; if (k2()) { $ej[$t]['pinnable?']=true; $ej[$t]['pinned?']=true; $ej[$t]['pinned-toggle-href'] = ( jv('e2m_tag_flag_ajax',$hj) ); } } } } if (k2()) { if (!$jj and array_key_exists('*tag',$xj)) { $gj=$xj; $gj['flag']='IsFavourite'; $gj['value']=1; $wj=[ 'tag' => htmlspecialchars($xj['*tag']['Keyword'],ENT_NOQUOTES,HSC_ENC), 'href' => jv('e2m_tag',$xj), 'visible?' => (bool)$xj['*tag']['IsVisible'], 'current?' => true, 'pinnable?' => true, 'pinned?' => false, 'pinned-toggle-href' => jv('e2m_tag_flag_ajax',$gj), ]; $ej[] = $wj; } } return $ej; } function cf($nx){ global$_config; $s2=array(); kn( "SELECT k.* ". "FROM `". $_config['db_table_prefix']."Keywords` k, ". "`". $_config['db_table_prefix']."NotesKeywords` nk ". "WHERE k.`SubsetID`=". $_config['db_table_subset'] ." ". "AND nk.`SubsetID`=". $_config['db_table_subset'] ." ". "AND nk.`NoteID`=". ((int)$nx) ." ". "AND k.`ID`=nk.`KeywordID` ". "ORDER BY `Keyword`", 'get tag records for note by id' ); $s2=xn(); return $s2; } function vf($uj){ global$_config; $ij=array(); foreach (array ( 'ID', 'NoteID', 'KeywordID', ) as $gz) if(array_key_exists($gz,$uj)) { $hz[] = '`'. $gz .'`'."='". en($uj[$gz]) ."'"; if ($gz=='ID')$oj='tagbinging-id'; if ($gz=='NoteID')$oj='tagbinging-note-id'; if ($gz=='KeywordID')$oj='tagbinging-tag-id'; $ij[$oj]=$uj[$gz]; } $bf=( "DELETE FROM `". $_config['db_table_prefix']."NotesKeywords` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND ". implode(' AND ',$hz) ); kn($bf); } function bf($qj,$pj){ global$_config; kn( "SELECT `ID`, `Keyword`, `OriginalAlias` ". "FROM `". $_config['db_table_prefix'] ."Keywords` k ". "WHERE k.`SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsVisible` = 1 ". "AND k.`ID` IN (". "SELECT `KeywordID` FROM (". "SELECT COUNT(`NoteID`) NotesCount, `KeywordID` ". "FROM `". $_config['db_table_prefix'] ."NotesKeywords` nk ". "WHERE nk.`SubsetID`=". $_config['db_table_subset'] ." ". "AND nk.`NoteID` IN (". "SELECT nk2.`NoteID` ". "FROM `". $_config['db_table_prefix'] ."NotesKeywords` nk2 ". "WHERE nk2.`SubsetID`=". $_config['db_table_subset'] ." ". "AND nk2.`KeywordID`=". $qj. ") ". "GROUP BY nk.`KeywordID` ". "HAVING NotesCount > 1 ". "ORDER BY NotesCount DESC ". "LIMIT 1, ". $pj. ") k_ids". ")", 'find related tags' ); $cj=[]; foreach (xn() as $q2){ if ($q2['ID']===$qj) continue; $cj[] = [ 'name' => htmlspecialchars($q2['Keyword'],ENT_NOQUOTES,HSC_ENC), 'href' => jv('e2m_tag', array ('*tag' => $q2)), 'visible?' => true, ]; } return $cj; } function yf($am){ @unlink(CACHE_FILENAME_TAGS); @unlink(CACHE_FILENAME_TAGS_FULL); @unlink(CACHE_FILENAME_TAGS_AUTHOR); @unlink(CACHE_FILENAME_TAGS_AUTHOR_FULL); gn(true); $q2=array ( 'Keyword' => $am, 'OriginalAlias' => on('find','','',$am), 'Description' => '', ); $q2=yn('Keywords',$q2); $ch=on( 'set','t',$q2['ID'],$am ); if ($ch!=$q2['OriginalAlias']) { $q2['OriginalAlias']=$ch; nn('Keywords',$q2); } return $q2['ID']; } function nf($parameters){ if (($vh=mf()) === null) return []; $se['each']=$vh; if(count($se['each']) > 0){ $se['href']=jv('e2m_tags'); } if (($bh=pm($parameters)) !== null){ $se['menu-each']=$bh; } return $se; } function mf($yh=false){ global$_config; $je=k2(); $ut=CACHE_FILENAME_TAGS; if ($je)$ut=CACHE_FILENAME_TAGS_AUTHOR; if ($yh){ $ut=CACHE_FILENAME_TAGS_FULL; if ($je)$ut=CACHE_FILENAME_TAGS_AUTHOR_FULL; } $nh=null; if(CACHE_TAGS and is_file($ut)) { $nh=@unserialize(file_get_contents($ut)); } if (!is_array($nh)) { try { kn( "SELECT * FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "ORDER BY `Keyword`", 'get all tags' ); $mh=array(); foreach (xn() as $q2){ $am['id'] = (int)$q2['ID']; $am['tag']=htmlspecialchars($q2['Keyword'],ENT_NOQUOTES,HSC_ENC); $am['favourite?'] = (bool)$q2['IsFavourite']; $am['visible?'] = (bool)$q2['IsVisible']; $am['notes-count']=0; $am['last-used']=0; $am['freshness']=0; $am['weight']=0; if ($yh){ $am['href']=jv('e2m_tag', array ('*tag' => $q2)); } $mh[$q2['ID']] = $am; } kn( "SELECT nk.KeywordID, COUNT(DISTINCT n.ID) as Count, max(n.Stamp) as LastUsed ". "FROM `". $_config['db_table_prefix']."NotesKeywords` nk, ". "`". $_config['db_table_prefix']."Notes` n ". "WHERE nk.`SubsetID`=". $_config['db_table_subset'] ." ". "AND n.`SubsetID`=". $_config['db_table_subset'] ." ". "AND n.`IsPublished` = 1 ". em($je). "AND nk.`NoteID` = n.`ID` ". "GROUP BY nk.KeywordID", 'get tags ordering info' ); $fh=0; $dh=0; $sh=0; foreach (xn() as $ah){ $tj =& $mh[$ah['KeywordID']]; $tj['notes-count']=$ah['Count']; if (@$tj['last-used'] < $ah['LastUsed']) { $tj['last-used']=$ah['LastUsed']; $qh=(time()-$tj['last-used']) / SECONDS_IN_A_YEAR; $tj['freshness']=pow(1/2,$qh); } $fh=max($fh,$tj['notes-count']); $dh=max($dh,$tj['freshness']); $sh=max($sh,$tj['notes-count']*$tj['freshness']); } $nh=array(); foreach ($mh as $r => $xf){ if (!$je and $xf['notes-count']==0) continue; $lh=mb_strtolower($xf['tag']); $nh[$lh]=$xf; if ($dh!=0){ $nh[$lh]['freshness']=$xf['freshness']/$dh; } else { $nh[$lh]['freshness']=0; } if ($sh!=0){ $nh[$lh]['weight'] = ( $xf['freshness']*$xf['notes-count']/$sh ); } else { $nh[$lh]['weight']=0; } if ($nh[$lh]['favourite?'])$nh[$lh]['weight']=1; } if(CACHE_TAGS)n3($ut,serialize($nh)); } catch (AeMySQLException $e){ kv($e); if(Log::$cy)__log('Could not get tags from database'); } } return $nh; } function ff($o6){ global$_config; kn( "SELECT * FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `Keyword`='". en($o6) ."'", 'get tag by name' ); $t=xn(); if (isset ($t[0])) { return $t[0]; } else { return null; } } function df($zh){ global$_config; kn( "SELECT * FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `OriginalAlias`='".en($zh)."'", 'get tag by legacy urlname name' ); $ib=xn(); if (isset ($ib[0])) { return $ib[0]; } else { return null; } } function sf($xs){ global$_config; kn( "SELECT * FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID`='".((int)$xs)."'", 'get tag by id' ); $ib=xn(); if (isset ($ib[0])) { return $ib[0]; } else { return null; } } function e2_tagrecs_with_parameters_($parameters){ $kh=array(); if (@$parameters['tag-alias'] or $parameters['tag-alias']==='0'){ $kh=explode(',',$parameters['tag-alias']); } $s2=array(); foreach ($kh as $zh) if ($zh or $zh==='0'){ if ( $ct=in(@$zh) and ($ct['type']=='t') and ($q2=sf($ct['id'])) ) { $s2[] = $q2; } else { if ($xh=df($zh)) { $s2[] = $xh; } } } return $s2; } function qf(){ global$full_blog_url; static $eh; $rm=w2(); if (empty ($eh)) { $eh=md5($full_blog_url .'email'. $rm); } return $eh; } function lf(){ global$full_blog_url; static $rh; $rm=w2(); if (empty ($rh)) { $rh=md5($full_blog_url .'nospam'. $rm.date('n-Y')); } return $rh; } function zf(){ global$full_blog_url; static $th; $rm=w2(); if(empty($th)) { $th=md5($full_blog_url .'nospam'. $rm.date('n-Y',strtotime('-1 month'))); } return $th; } function kf($nx){ global$full_blog_url; $rm=w2(); return b('comment_'. md5($full_blog_url .'nospam_cookie'. $rm.$nx)); } function xf(){ global$full_blog_url; $jh=$_SERVER['HTTP_USER_AGENT']; $rm=w2(); return md5($full_blog_url .'nospam_cookie'. $rm.$jh); } function ef(){ if ( array_key_exists('email',$_POST) and $_POST['email']!=='' ) return true; $rh=lf(); $th=zf(); if ( !array_key_exists($rh,$_POST) and !array_key_exists($th,$_POST) ) return true; if ( ( array_key_exists($rh,$_POST) and $_POST[$rh]!=='' ) or ( array_key_exists($th,$_POST) and $_POST[$th]!=='' ) ) return true; if ( !array_key_exists('comment',$_POST) or (strlen($_POST['comment']) > 6) ) return true; return false; } function e2_cookie_data_is_spam_suspicios_for_note_id_($nx){ if ( !array_key_exists(kf($nx),$_COOKIE) or ($_COOKIE[kf($nx)] !== xf()) ) return true; return false; } function e2m_comment($parameters=array ()) { c(jv('e2m_note',$parameters)); } function e2m_comment_edit($parameters=array ()) { return tf('edit',$parameters); } function tf($t6,$parameters=array ()) { global$_config,$_strings,$full_blog_url; $e6=$j6=$_strings['pt--new-comment']; $hh='new'; if ($t6=='edit'){ $s6=e2_commentrec_with_parameters_($parameters); $yr=$_strings['fb--save-changes']; $n2=$s6['noterec']; $e6=$j6=$_strings['pt--edit-comment']; $gh=hf($n2,$s6,$parameters['comment-number']); $hh=$wh['ID']; if (!$s6){ return e2_error404_mode(); } $uh=array ( '.note-id' => $s6['NoteID'], '.comment-id' => $s6['ID'], '.comment-number' => $parameters['comment-number'], '.already-subscribed?' => false, '.gip' => $s6['GIP'], 'create:edit?' => false, 'form-action' => jv('e2s_comment_process'), 'submit-text' => $yr, 'show-subscribe?' => true, 'subscribe?' => (bool)$s6['IsSubscriber'], 'name' => htmlspecialchars($s6['AuthorName'],ENT_COMPAT,HSC_ENC), 'email' => htmlspecialchars($s6['AuthorEmail'],ENT_COMPAT,HSC_ENC), 'text' => htmlspecialchars($s6['Text'],ENT_COMPAT,HSC_ENC), 'email-field-name' => qf(), ); if (''!=trim($s6['IP'])) { $uh['ip']=$s6['IP']; } } $d=array ( 'title' => $e6, 'heading' => $j6, 'form' => 'form-comment', 'form-comment' => $uh, ); if (!empty ($gh)) { $d['comments'] = array ('each' => array ('only' => $gh)); } return $d; } function e2m_comment_reply($parameters=array ()) { global$_strings; $s6=e2_commentrec_with_parameters_($parameters); if (!$s6){ return e2_error404_mode(); } $n2=$s6['noterec']; $gh=hf($n2,$s6,$parameters['comment-number']); $gh['replying?'] = (bool)true; $ih=($s6['Reply']=='' or !$s6['IsReplyVisible']); $e6=$ih? $_strings['pt--reply-to-comment']:$_strings['pt--edit-reply-to-comment']; $oh=array ( '.note-id' => $n2['ID'], '.comment-id' => $s6['ID'], '.reply-action' => $ih? 'new':'edit', 'form-action' => jv('e2s_comment_edit_reply'), 'submit-text' => $ih? $_strings['fb--publish']:$_strings['fb--save-changes'], 'create:edit?' => (bool) ($ih), 'reply-text' => htmlspecialchars($s6['Reply'],ENT_COMPAT,HSC_ENC), 'emailing-possible?' => MAIL_ENABLED, 'mail-back?' => (bool) ($ih), ); return array ( 'title' => $e6, 'heading' => $e6, 'comments' => array ('each' => array ('only' => $gh)), 'form' => 'form-comment-reply', 'form-comment-reply' => $oh, ); } function e2m_comment_delete($parameters=array ()) { global$_strings,$settings,$ph,$_config; $s6=e2_commentrec_with_parameters_($parameters); $nx=$s6['NoteID']; if (!$s6){ return e2_error404_mode(); } e2_drop_caches_for_note_($nx,true); @unlink(USER_FOLDER. '/last-comment.psa'); kn( "DELETE FROM `". $_config['db_table_prefix']."Comments` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID` = '". ((int)$s6['ID']). "'" ); v(); } function e2m_comment_reply_delete($parameters=array ()) { global$_strings,$settings,$_config; $s6=e2_commentrec_with_parameters_($parameters); if (!$s6){ return e2_error404_mode(); } kn( "UPDATE `". $_config['db_table_prefix']."Comments` SET ". "`Reply`='', ". "`IsReplyFavourite`='0' ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID`=".((int)$s6['ID']) ); v(); } function e2m_unsubscribe($parameters){ global$_strings,$_config; $c8="ORDER BY `ID` DESC"; $v8=false; $n2=$parameters['*note']; $nx=$n2['ID']; $z3=$parameters['unsubscribe-email']; $b8=$parameters['unsubscribe-key']; $z3=str_replace(' ','+',$z3); if ($nx){ kn( "SELECT `ID`, `Stamp` FROM `". $_config['db_table_prefix']."Comments` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `NoteID`=". $nx ." ". "AND `IsSubscriber`=1 ". "AND `AuthorEmail`='". $z3 ."' ". $c8, 'get subscriber’s comments ids' ); $q1=xn(); if(count($q1) < 1) { $d['unsubscribe']['error-message']=$_strings['gs--you-are-not-subscribed']; } else { $a6=@$q1[0]; $y8=md5($a6['ID'].$a6['Stamp'] .'x'); if ($b8==$y8){ kn( "UPDATE `". $_config['db_table_prefix']."Comments` ". "SET `IsSubscriber`=0 ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `NoteID`=". $nx ." ". "AND `AuthorEmail` = '". en($z3). "'", 'unsubscribe' ); $v8=true; $d['unsubscribe']['note-title']=h3( htmlspecialchars($n2['Title'],ENT_COMPAT,HSC_ENC) ); $d['unsubscribe']['note-href']=jv( 'e2m_note', array ('*note' => $n2) ); } if (!$v8){ $d['unsubscribe']['error-message']=$_strings['gs--unsubscription-didnt-work']; } } } else { $d['unsubscribe']['error-message']=$_strings['gs--post-not-found']; } if ($v8){ $e6=$_strings['pt--unsubscription-done']; } else { $e6=$_strings['pt--unsubscription-failed']; } $d['unsubscribe']['success?']=$v8; $d['title']=$e6; $d['heading']=$e6; return $d; } function e2m_comment_flag($parameters){ jf($parameters); c(jv('e2m_note',$parameters)); } function e2m_comment_flag_ajax($parameters){ s([ 'flag-name' => 'comment', 'candy-name' => 'e2m_comment_flag_ajax', 'parameters' => $parameters, 'flipping-function' => function () use ($parameters){ jf($parameters); }, ]); } function jf($parameters){ $s6=e2_commentrec_with_parameters_($parameters); $nx=$s6['NoteID']; if ($s6){ nn('Comments', array ( 'ID' => $s6['ID'], $parameters['flag'] => (int) ($parameters['value']==1), )); e2_drop_caches_for_note_($nx,true); } } function e2s_comment_process(){ global$_strings,$_fp_error; list ($nx,$hh,$n8)=f2(); if(Log::$cy)__log('Comments: processed, noteid <'. $nx .'>, commentid <'. $hh .'>'); if (!$hh){ $m8=''; if($_fp_error==FP_NOT_COMMENTABLE){ mv($_strings['er--post-not-commentable'],E2E_USER_ERROR); } elseif($_fp_error==FP_EMPTY_FIELD){ mv($_strings['er--name-email-text-required'],E2E_USER_ERROR); } elseif($_fp_error==FP_COMMENT_TOO_LONG){ $f8=$_strings['gs--comment-too-long']; $m8=$_strings['gs--comment-too-long-description']; } elseif($_fp_error==FP_COMMENT_DOUBLE_POST){ $f8=$_strings['gs--comment-double-post']; $m8=$_strings['gs--comment-double-post-description']; } elseif($_fp_error==FP_COMMENT_SPAM_SUSPECT){ $f8=$_strings['gs--comment-spam-suspect']; $m8=$_strings['gs--comment-spam-suspect-description']; } elseif($_fp_error==FP_NO_ID_OR_NEW){ mv($_strings['er--error-occurred'].' (FP_NO_ID_OR_NEW)'); } else { mv($_strings['er--error-occurred'].' (FP '. $_fp_error .')'); } if ($m8){ $d['title']=$f8; $d['heading']=$f8; $d['form']='form-unaccepted-comment'; $d['form-unaccepted-comment'] = array ( 'reason' => $m8, 'text' => @htmlspecialchars($n8['text'],ENT_COMPAT,HSC_ENC), ); return $d; } } if ($nx){ c(jv('e2m_note', array ('*note' => ym($nx)))); } else { c(); } die; } function e2s_comment_edit_reply(){ global$_strings,$v,$_config; $d8=@$_POST['text']; if(trim($d8)=='')$d8=''; $nx=@$_POST['note-id']; $n2=ym($nx); $hh=@$_POST['comment-id']; $s6=gf($hh); $s8=isset ($_POST['mail-back']); $a8=time(); if (@$_POST['reply-action']=='new'){ $q8=time(); } @unlink(e2_note_cache_filename_with_id_($nx .'-comments')); @unlink(e2_note_cache_filename_with_id_($nx .'-comments-author')); if ($s6){ kn( "UPDATE `". $_config['db_table_prefix']."Comments` SET ". "`Reply`='". en($d8) ."', ". ( isset ($q8)? ( "`ReplyStamp`='". $q8 ."', " ) : ( "" ) ). "`ReplyLastModified`='". $a8 ."', ". "`IsReplyVisible`='1' ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID`=".((int)$hh), 'update comment reply' ); $ge=jv('e2m_note', array ('*note' => $n2)); if ($s8 and $d8!=''){ $tj['comment-time'] = array ($s6['Stamp'],ay()); $tj['commenter']=$s6['AuthorName']; $tj['commenter-email']=$s6['AuthorEmail']; $tj['comment-text']=$s6['Text']; $tj['note-title']=h3($n2['Title']); $tj['reply-time'] = array (time(),ay()); $tj['blog-author']=vd(); $tj['note-href']=$ge; $tj['comment-href']=$ge; $tj['reply-text']=$d8; if(1){ $l8=f1( 'comment-reply',$tj ); $z8=e2l_get_string( 'em--comment-reply', $tj ); $k8=$s6['AuthorEmail']; $x8='From: '. d1(); s1($k8,$z8,$l8,$x8); } if(1){ unset ($tj['commenter-email']); $x8='From: '. d1(); foreach (y2($n2,$s6['AuthorEmail']) as $e8){ $r8=$e8['AuthorEmail']; $t8=md5($e8['ID'].$e8['Stamp'].'x'); $tj['unsubscribe-href']=jv('e2m_unsubscribe', array ( '*note' => $n2, 'unsubscribe-email' => $r8, 'unsubscribe-key' => $t8, ) ); $k8=$r8; $l8=f1('comment-reply-to-public',$tj); $z8=e2l_get_string( 'em--comment-reply-to-public-subject', $tj ); s1($k8,$z8,$l8,$x8); } } } c($ge); } else { v(); } die; } function hf($n2,$a6,$wv){ global$_config,$full_blog_url; if(Log::$cy)__log('Package comment '. $a6['ID'] .'...'); if ($n2===null){ $n2=ym($a6['NoteID']); } $tj['number']=$wv; $j8=!empty ($a6['IsGIPUsed']); $tj['gip-used?']=$j8; $tj['gip']=$tj['gip-used?']?$a6['GIP']:''; $tj['name']=htmlspecialchars($a6['AuthorName'],ENT_NOQUOTES,HSC_ENC); $tj['userpic-set?']=false; if ($j8){ $h8=AVATARS_FOLDER.$a6['GIP'] .'-'. $a6['GIPAuthorID'] .'.jpg'; if(is_file(MEDIA_ROOT_FOLDER.$h8)) { $tj['userpic-set?']=true; $tj['userpic-href']=$full_blog_url .'/'. $h8; } } $tj['name-href']=''; if ( $j8 and $g8=e2_get_user_profile_url($a6['GIP'],$a6['GIPAuthorID'],$a6['AuthorProfileLink']) ) { $tj['name-href']=$g8; } if (k2()) { $tj['email']=htmlspecialchars($a6['AuthorEmail'],ENT_NOQUOTES,HSC_ENC); if (''!=trim($a6['IP'])) { $tj['ip']=$a6['IP']; } } $tj['author-name']=vd(); $tj['important?'] = (bool)$a6['IsFavourite']; $tj['reply-visible?'] = (bool) ($a6['IsVisible'] && $a6['IsReplyVisible']); $tj['reply-important?'] = (bool)$a6['IsReplyFavourite']; $tj['spam-suspect?'] = (bool)$a6['IsSpamSuspect']; $w8=array ((int)$a6['Stamp'],dy($n2)); $tj['time']=$w8; $tj['last-modified']=$w8; if ($a6['LastModified']) $tj['last-modified'] = array ((int)$a6['LastModified'],dy($n2)); if ($a6['ReplyStamp']) $tj['reply-time'] = array ((int)$a6['ReplyStamp'],dy($n2)); if ($a6['ReplyLastModified']) $tj['reply-last-modified'] = array ((int)$a6['ReplyLastModified'],dy($n2)); if (k2()) { $tj['subscriber?'] = (bool)$a6['IsSubscriber']; $tj['new?'] = (bool)$a6['IsNew']; $tj['first-new?']=false; if (!@$_config['read_only']) { if ($a6['IsFavourite']) { $tj['important-toggle-href']=jv( 'e2m_comment_flag_ajax', array ('*note' => $n2,'comment-number' => $wv,'flag' => 'IsFavourite','value' => 0) ); } else { $tj['important-toggle-href']=jv( 'e2m_comment_flag_ajax', array ('*note' => $n2,'comment-number' => $wv,'flag' => 'IsFavourite','value' => 1) ); } if ($a6['IsReplyFavourite']) { $tj['reply-important-toggle-href']=jv( 'e2m_comment_flag_ajax', array ( '*note' => $n2,'comment-number' => $wv,'flag' => 'IsReplyFavourite','value' => 0 ) ); } else { $tj['reply-important-toggle-href']=jv( 'e2m_comment_flag_ajax', array ( '*note' => $n2,'comment-number' => $wv,'flag' => 'IsReplyFavourite','value' => 1 ) ); } $tj['edit-href']=jv( 'e2m_comment_edit', array ('*note' => $n2,'comment-number' => $wv) ); $tj['removed-toggle-href']=jv( 'e2m_comment_flag_ajax', array ( '*note' => $n2,'comment-number' => $wv, 'flag' => 'IsVisible','value' => !$a6['IsVisible'] ) ); $tj['removed-reply-toggle-href']=jv( 'e2m_comment_flag_ajax', array ( '*note' => $n2,'comment-number' => $wv, 'flag' => 'IsReplyVisible','value' => !$a6['IsVisible'] ) ); $tj['removed-href']=jv( 'e2m_comment_flag_ajax', array ( '*note' => $n2,'comment-number' => $wv, 'flag' => 'IsVisible','value' => 0 ) ); $tj['removed-reply-href']=jv( 'e2m_comment_flag_ajax', array ( '*note' => $n2,'comment-number' => $wv, 'flag' => 'IsReplyVisible','value' => 0 ) ); $tj['replaced-href']=jv( 'e2m_comment_flag_ajax', array ( '*note' => $n2,'comment-number' => $wv, 'flag' => 'IsVisible','value' => 1 ) ); $tj['replaced-reply-href']=jv( 'e2m_comment_flag_ajax', array ( '*note' => $n2,'comment-number' => $wv, 'flag' => 'IsReplyVisible','value' => 1 ) ); $u8=jv( 'e2m_comment_reply', array ('*note' => $n2,'comment-number' => $wv) ); if ($a6['Reply']=='' or !$a6['IsReplyVisible']) { $tj['reply-href']=$u8; } else { $tj['edit-reply-href']=$u8; } } } if(mb_strlen($a6['Text']) > $_config['max_comment_length']) { $a6['Text']=mb_substr($a6['Text'],0,$_config['max_comment_length']); } $i8=$n2['FormatterID']==='raw'?'neasden':$n2['FormatterID']; $z1=u3($i8,$a6['Text'],'simple'); $tj['text']=$z1['text-final']; $tj['reply']=''; $tj['replying?'] = (bool)false; $tj['replied?'] = (bool) ( (trim($a6['Reply']) != '') && ($a6['IsReplyVisible']) ); if ((string)$a6['Reply']!==''){ $z1=u3($n2['FormatterID'],$a6['Reply'],'full'); $tj['reply']=$z1['text-final']; } if(Log::$cy)__log('Comments: done'); return $tj; } function gf($xs){ global$_config; kn( "SELECT * FROM `". $_config['db_table_prefix']."Comments` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID` = '". $xs ."'" ); $ib=xn(); if(count($ib) > 0){ return $ib[0]; } else { return false; } } function wf($wt){ e2_comment_set_flag('IsVisible',$wt); } function uf($o8){ e2_comment_set_flag('IsReplyVisible',$o8); } function if_($pq){ global$_strings,$_config,$settings; $p8=@$_COOKIE[b('commenter_name')]; $cg=@$_COOKIE[b('commenter_email')]; $vg=@$_COOKIE[b('commenter_ph')]; $bg=false; if ($cg and $vg){ foreach (y2($pq) as $e8){ $y8=md5($e8['ID'].$e8['Stamp'] .'x'); if ( $e8['AuthorEmail']==$cg and $vg==$y8 ){ $bg=true; break; } } } $yr=$_strings['fb--submit']; $rh=lf(); $uh=array ( '.note-id' => $pq['ID'], '.comment-id' => 'new', '.already-subscribed?' => (bool)$bg, 'cookie-name' => kf($pq['ID']), 'cookie-value' => xf(), 'email-field-name' => qf(), 'nospam-field-name-part-1' => substr($rh,0,4), 'nospam-field-name-part-2' => substr($rh,4), 'create:edit?' => true, 'form-action' => jv('e2s_comment_process'), 'submit-text' => $yr, 'show-subscribe?' => (bool) !$bg, 'emailing-possible?' => MAIL_ENABLED, 'subscribe?' => (bool)$bg, 'subscription-status' => $bg? $_strings['gs--you-are-already-subscribed']:'', 'name' => htmlspecialchars($p8,ENT_COMPAT,HSC_ENC), 'email' => htmlspecialchars($cg,ENT_COMPAT,HSC_ENC), 'text' => htmlspecialchars($a6['Text'],ENT_COMPAT,HSC_ENC), 'email-comments-enabled?' => empty ($settings['comments']['require_gip']), 'gips' => array (), ); $yg=false; $ng=''; foreach(e2_list_gips() as $mg){ if (!is_file(SYSTEM_FOLDER .'gips/'. $mg .'.json')) { continue; } $fg=e2_is_logged_in($mg); $uh['gips'][$mg] = ( e2_get_gip_auth_url($mg) ); if ($fg){ $yg=true; $dg=e2_get_gip_session($mg); $ng=$dg['GIP']; $uh['name']=htmlspecialchars( $dg['AuthorName'],ENT_COMPAT,HSC_ENC ); } } if (!$uh['email-comments-enabled?'] and !count($uh['gips'])) { return false; } $uh['email-comments-only?'] = (count($uh['gips']) === 0); $uh['logged-in?']=$yg; $uh['logged-in-gip']=$ng; $uh['logout-url']=$yg?jv('e2m_gip_sign_out', array('provider' => E2GIP::get_logout_key())) : ''; return $uh; } function of($nx){ return c2($nx,'`IsNew` = 1'); } function pf($nx){ return c2($nx,'`IsVisible` = 1'); } function c2($nx,$b){ global$_config; if (!is_numeric($nx)) return 0; $sg=0; kn( "SELECT count(*) ". "FROM `". $_config['db_table_prefix']."Comments` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `NoteID`=". $nx ." ". "AND (". $b. ")", 'count comments' ); $q1=xn(); $q1=(int)$q1[0]['count(*)']; $sg=$q1; return (int)$sg; } function v2(){ global$_config; if(Log::$cy)__log('Count new comments'); $ag=0; $qg=''; $rq=''; try { kn( "SELECT `NoteID`, `Text` FROM `". $_config['db_table_prefix']."Comments` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsNew`=1 ORDER BY `Stamp`", 'count new comments for author menu' ); $q1=xn(); $ag=count($q1); if ($ag){ $nx=$q1[0]['NoteID']; $rq=jv( 'e2m_note', array ('*note' => ym($nx)) ); } } catch (AeMySQLException $e){ kv($e); if(Log::$cy)__log('Could not count new comments or provide link to the latest one'); } return array ((int)$ag,$qg,$rq); } function b2($nx){ global$_config; if(Log::$cy)__log('Comments: getting comments for note '. $nx); kn( "SELECT * FROM `". $_config['db_table_prefix']."Comments` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `NoteID`=". @$nx." ". "ORDER BY `Stamp`", 'get comments including deleted' ); $q1=xn(); return $q1; } function y2($n2,$lg=''){ global$_config; $c8="ORDER BY `ID` DESC"; $d=$zg=[]; kn( "SELECT DISTINCT `ID`, `Text`, `IsSubscriber`, `IsVisible`, ". "`AuthorName`, `AuthorEmail`, `Stamp` ". "FROM `". $_config['db_table_prefix']."Comments` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `NoteID`=". @$n2['ID'] ." ". "AND `IsSubscriber`=1 ". "AND `IsVisible`=1 ". "AND `AuthorEmail`!='". en($lg) ."' ". $c8, 'get subscribers by note' ); $q1=xn(); foreach ($q1 as $e8){ if (!in_array($e8['AuthorEmail'],$zg)) { $d[] = $e8; } $zg[] = $e8['AuthorEmail']; } return $d; } function n2($n2,$ir=NOTE_COMMENTABLE_NOW){ global$settings,$_config; $kg=true; if (@$settings['comments']['fresh_only']) if (isset ($_config['comment_freshness_days'])) if ($n2['Stamp'] < time()-$_config['comment_freshness_days']*SECONDS_IN_A_DAY) $kg=false; $xg=$n2['IsCommentable']; if ($ir==NOTE_COMMENTABLE_NOW_CONDITIONALLY){ $xg=true; } return ( xm($n2)==='public' and $kg and $xg ); } function e2_commentrec_with_parameters_($parameters=array ()) { $n2=$parameters['*note']; $f6=b2($n2['ID']); $s6=@$f6[$parameters['comment-number']-1]; if ($s6){ $s6['noterec']=$n2; return $s6; } } function f2($mt=''){ global$settings,$ph,$_config,$_fp_error; $_fp_error=false; $eh=qf(); $nx=$hh=$name=$z3=$tv=''; if(array_key_exists('note-id',$_POST)) $nx=trim(@$_POST['note-id']); if(array_key_exists('comment-id',$_POST)) $hh=trim(@$_POST['comment-id']); if(array_key_exists('comment-number',$_POST)) $wv=trim(@$_POST['comment-number']); if(array_key_exists('name',$_POST)) $name=trim(@$_POST['name']); if(array_key_exists($eh,$_POST)) $z3=trim(@$_POST[$eh]); if(array_key_exists('text',$_POST)) $tv=trim(@$_POST['text']); $eg=vn('Comments'); if(stripos($eg['Collation'],'utf8mb4')!==0){ $name=nb($name); $tv=nb($tv); } if ($hh=='new'){ $rg=e2_get_logged_gip_name(); if ($rg){ $dg=e2_get_gip_session($rg); $name=trim($dg['AuthorName']); $z3=''; $tg=$dg['GIPAuthorID']; } } else { if(array_key_exists('gip',$_POST))$rg=trim(@$_POST['gip']); } $jg=( (array_key_exists('already-subscribed',$_POST) and $_POST['already-subscribed']) or (array_key_exists('subscribe',$_POST) and $_POST['subscribe']) ); $hg=time(); $n8['text']=$tv; if ($hh=='new' and !$rg){ y('commenter_name',$name); y('commenter_email',$z3); } $gg=($hh=='new' and ( ef() or e2_cookie_data_is_spam_suspicios_for_note_id_($nx) )); $wg=1; $q1=false; if (!is_numeric($nx)) { $_fp_error=FP_NO_ID_OR_NEW; } elseif (!is_numeric($hh) and !($hh=='new')) { $_fp_error=FP_NO_ID_OR_NEW; } else { if ( $tv=='' or ( !$rg and ($name=='' or $z3=='') ) ) { $_fp_error=FP_EMPTY_FIELD; } if ($hh=='new'){ $ug=@unserialize(file_get_contents(USER_FOLDER. '/last-comment.psa')); if(md5($name.$z3.$tv)==$ug['md5']) { $_fp_error=FP_COMMENT_DOUBLE_POST; } if ( isset ($_config['max_comment_length']) and strlen(@$_POST['text']) > ($_config['max_comment_length']) ){ $_fp_error=FP_COMMENT_TOO_LONG; } $n2=ym($nx); if ($hh=='new' and !n2($n2)) { $_fp_error=FP_NOT_COMMENTABLE; } if ($gg){ $_fp_error=FP_COMMENT_SPAM_SUSPECT; } } } if (!$_fp_error){ e2_drop_caches_for_note_($nx,true); if ($hh=='new'){ $s6=array ( 'NoteID' => (int)$nx, 'AuthorName' => $name, 'AuthorEmail' => $z3, 'Text' => $tv, 'Reply' => '', 'IsVisible' => 1, 'IsAnswerAware' => 1, 'IsSubscriber' => (int)$jg, 'IsSpamSuspect' => (int)$gg, 'IsNew' => (int)$wg, 'Stamp' => (int)time(), 'LastModified' => (int)time(), 'IP' => en(q2()), 'IsGIPUsed' => intval(!empty ($rg) && !empty ($tg)), 'GIP' => !empty ($rg)?en($rg):'', 'GIPAuthorID' => !empty ($tg)?en($tg):'', ); $s6=yn('Comments',$s6); $hh=$s6['ID']; $ug=array ( 'id' => $hh, 'md5' => md5($name.$z3.$tv), ); @n3(USER_FOLDER. 'last-comment.psa',serialize($ug)); $q1=(int)$hh; $ig=md5($s6['ID'].$s6['Stamp'].'x'); y('commenter_ph',$ig); $n2=ym($nx); $ge=jv('e2m_note', array ('*note' => $n2)); $tj['comment-time'] = array ($hg,ay()); $tj['commenter']=$name; $tj['commenter-email']=$z3; $tj['comment-text']=$tv; $tj['note-title']=$n2['Title']; $tj['note-href']=$ge; $tj['comment-href']=$ge; $tj['comments-disable-href']=jv('e2m_note_flag', array ( '*note' => $n2, 'flag' => 'IsCommentable', 'value' => 0 )); $tj['reply-href']=jv( 'e2m_comment_reply', array ( '*note' => $n2, 'comment-number' => $wv ) ); if (isset ($settings['author_email']) and @$settings['notifications']['new_comments']) { $l8=f1( 'comment-new-to-author',$tj ); $z8=e2l_get_string( 'em--comment-new-to-author-subject', $tj ); $k8=$settings['author_email']; $x8 = 'From: '. d1() ."\r\n". 'Reply-to: '. $name .' <'. $z3 .">"; s1($k8,$z8,$l8,$x8); } if (!$gg){ unset ($tj['commenter-email']); $x8='From: '. d1(); foreach (y2($n2,$z3) as $e8){ $r8=$e8['AuthorEmail']; $t8=md5($e8['ID'].$e8['Stamp'].'x'); $tj['unsubscribe-href']=jv('e2m_unsubscribe', array ( '*note' => $n2, 'unsubscribe-email' => $r8, 'unsubscribe-key' => $t8 ) ); $k8=$r8; $l8=f1('comment-new-to-public',$tj); $z8=e2l_get_string( 'em--comment-new-to-public-subject', $tj ); s1($k8,$z8,$l8,$x8); } } } else { $og=array ( 'ID' => $hh, 'Text' => $tv, 'IsSubscriber' => ((int)$jg), 'LastModified' => time(), ); if (!empty ($name))$og['AuthorName']=$name; if (!empty ($z3))$og['AuthorEmail']=$z3; nn('Comments',$og); $q1=(int)$hh; } } if ($mt=='ajaxresult') return $et; else return array ((int)$nx,$q1,$n8); } function e2m_most_commented($parameters=[]) { global$settings,$_strings,$_config; $je=k2(); $mostCommentedView=new AePageableNotesView('e2m_most_commented',$parameters); $mostCommentedView -> setPortionSize($settings['appearance']['notes_per_page']); $mostCommentedView -> setNextPrevPageTitles($_strings['gs--earlier'],$_strings['gs--later']); $mostCommentedView -> setWantNewCommentsCount($je); $mostCommentedView -> setWantReadHrefs($_config['count_reads']); $mostCommentedView -> setWantControls($je and !@$_config['read_only']); $mostCommentedView -> setWantHiddenTags($je); if(E2_EDITION){ $mostCommentedView -> setWantPreviewHrefs(true); } $pg=$_config['hot_period']; $cw=time()-d2($_config['hot_period']); $mostCommentedView -> setLimitlessSQLRequest( "SELECT * ". "FROM `". $_config['db_table_prefix'] ."Notes` n ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished`=1 ". em($je). "AND `ID` IN ( ". "SELECT `NoteID` FROM ( ". "SELECT `NoteID`, COUNT(*) CommentsCount ". "FROM `". $_config['db_table_prefix']."Comments` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsVisible` = 1 ". "AND `Stamp` > ". $cw." ". "GROUP BY `NoteID` ". "ORDER BY CommentsCount DESC ". ") As MostCommentedNotesIDs ". ")" ); $d=[ 'title' => e2l_get_string('pt--most-commented', ['period' => $pg]), 'heading' => e2l_get_string('pt--most-commented', ['period' => $pg]), 'notes' => $mostCommentedView -> getNotesCTree(), 'pages' => $mostCommentedView -> getPagesCTree(), ]; if($mostCommentedView -> isFirstPageOfEmptyView()) { $d['nothing']=$_strings['gs--no-such-notes']; } elseif (!$mostCommentedView -> isExistingPage()) { return e2_error404_mode(); } return $d; } function e2m_favourites($parameters=[]) { global$settings,$_config,$_strings; $je=k2(); $favouritesView=new AePageableNotesView('e2m_favourites',$parameters); $favouritesView -> setPortionSize($settings['appearance']['notes_per_page']); $favouritesView -> setNextPrevPageTitles($_strings['gs--earlier'],$_strings['gs--later']); $favouritesView -> setWantPaging(true); $favouritesView -> setWantNewCommentsCount($je); $favouritesView -> setWantReadHrefs($_config['count_reads']); $favouritesView -> setWantControls($je and !@$_config['read_only']); $favouritesView -> setWantHiddenTags($je); if(E2_EDITION){ $favouritesView -> setWantPreviewHrefs(true); } $favouritesView -> setLimitlessSQLRequest( "SELECT * ". "FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished`=1 ". "AND `IsFavourite`=1 ". em($je). "ORDER BY `Stamp` DESC" ); $d=[ 'title' => $_strings['pt--favourites'], 'heading' => $_strings['pt--favourites'], 'notes' => $favouritesView -> getNotesCTree(), 'pages' => $favouritesView -> getPagesCTree(), ]; if($favouritesView -> isFirstPageOfEmptyView()) { $d['nothing']=$_strings['gs--no-favourites']; } elseif (!$favouritesView -> isExistingPage()) { return e2_error404_mode(); } return $d; } function d2($pg){ if ('year'==$pg) return SECONDS_IN_A_YEAR; elseif ('month'==$pg) return SECONDS_IN_A_MONTH; elseif ('week'==$pg) return SECONDS_IN_A_DAY*7; elseif ('day'==$pg) return SECONDS_IN_A_DAY; else return PHP_INT_MAX; } function e2m_popular($parameters=[]) { global$settings,$_config,$_strings; $je=k2(); $popularView=new AePageableNotesView('e2m_popular',$parameters); $popularView -> setPortionSize($settings['appearance']['notes_per_page']); $popularView -> setNextPrevPageTitles($_strings['gs--earlier'],$_strings['gs--later']); $popularView -> setWantNewCommentsCount($je); $popularView -> setWantReadHrefs($_config['count_reads']); $popularView -> setWantControls($je and !@$_config['read_only']); $popularView -> setWantHiddenTags($je); if(E2_EDITION){ $popularView -> setWantPreviewHrefs(true); } $pg=$_config['popular_period']; $cw=time()-d2($_config['popular_period']); $p5=( "FROM `". $_config['db_table_prefix']."Actions` a, ". "`". $_config['db_table_prefix']."Notes` n ". "WHERE a.`SubsetID`=". $_config['db_table_subset'] ." ". "AND n.`SubsetID`=". $_config['db_table_subset'] ." ". "AND a.`Stamp` > ". $cw ." ". "AND n.`IsPublished` = 1 ". em($je). "AND a.`EntityID` = n.`ID` ". "GROUP BY a.`EntityID`" ); $popularView -> setSQLCountRequest( "SELECT COUNT(*) Total FROM (SELECT 1 ". $p5 .") _" ); $popularView -> setLimitlessSQLRequest( "SELECT n.*, a.`EntityID`, SUM(a.`ReadCount`) `AggregateReadCount` ". $p5 ." ". "ORDER BY `IsFavourite` DESC, `AggregateReadCount` DESC" ); $d=[ 'title' => e2l_get_string('pt--most-read', ['period' => $pg]), 'heading' => e2l_get_string('pt--most-read', ['period' => $pg]), 'notes' => $popularView -> getNotesCTree(), 'pages' => $popularView -> getPagesCTree(), ]; if($popularView -> isFirstPageOfEmptyView()) { $d['nothing']=$_strings['gs--no-such-notes']; } elseif (!$popularView -> isExistingPage()) { return e2_error404_mode(); } return $d; } function s2($qj=false,$fx=[]) { global$_config,$_current_url; $vw=$bw=''; if(E2_EDITION){ if ($qj!==false){ $vw="JOIN `". $_config['db_table_prefix'] ."NotesKeywords` nk ON nk.`NoteID` = n.`ID` "; $bw=( "AND nk.`SubsetID` = ". $_config['db_table_subset'] ." ". "AND nk.`KeywordID` = ". $qj ." " ); } } $mostReadNotesCollectionView=new AeArbitraryNotesCollectionView('most read or most read by tag'); $mostReadNotesCollectionView -> setCurrentURL($_current_url); $mostReadNotesCollectionView -> setFilterOutIDs($fx); $cw=time()-d2($_config['popular_period']); $mostReadNotesCollectionView -> setSQLRequest( "SELECT n.*, a.`EntityID`, SUM(a.`ReadCount`) `AggregateReadCount` ". "FROM `". $_config['db_table_prefix']."Actions` a, ". "`". $_config['db_table_prefix']."Notes` n ". $vw. "WHERE a.`SubsetID`=". $_config['db_table_subset'] ." ". "AND n.`SubsetID`=". $_config['db_table_subset'] ." ". $bw. "AND a.`Stamp` > ". $cw ." ". "AND n.`IsPublished` = 1 ". "AND n.`IsFavourite` = 1 ". em(k2()). "AND a.`EntityID` = n.`ID` ". "GROUP BY a.`EntityID` ". "ORDER BY `IsFavourite` DESC, `AggregateReadCount` DESC ". "LIMIT 10" ); if ($qj===false){ if(CACHE_POPULAR){ $mostReadNotesCollectionView -> setViewExpiration(SECONDS_IN_A_DAY); $mostReadNotesCollectionView -> setCacheFilename(CACHE_FILENAME_POPULAR); $mostReadNotesCollectionView -> setCacheExpiresFilename(CACHE_FILENAME_POPULAR_EXPIRES); } } else { if(CACHE_POPULAR_WITH_TAG){ $mostReadNotesCollectionView -> setViewExpiration(SECONDS_IN_A_DAY); $mostReadNotesCollectionView -> setCacheFilename(e2_cache_filename_with_id_($qj,CACHE_FILENAMES_POPULAR_WITH_TAG)); $mostReadNotesCollectionView -> setCacheExpiresFilename( e2_cache_filename_with_id_($qj,CACHE_FILENAMES_POPULAR_WITH_TAG_EXPIRES) ); } } return$mostReadNotesCollectionView -> getNotesCTree(); } function a2($qj=false,$fx=[]) { global$_strings; $yw=[ 'title' => $_strings['nm--most-read'], ]; $yw['each']=s2($qj,$fx); if ($qj){ $yw['seed']=$qj; } if(count($yw['each']) < 7){ return []; } return $yw; } function e2m_password_reset(){ global$_strings,$_superconfig,$settings; if (!is_file(USER_FOLDER. 'password-reset.psa')) { $rm=sha1(rand()); $sm=jv('e2m_password', array ('recovery-key' => $rm)); @n3(USER_FOLDER. 'password-reset.psa',$sm); } $d['title']=$_strings['pt--password-reset']; $d['heading']=$_strings['pt--password-reset']; $nw=(bool) ($k8=$settings['author_email']); $d['form']='form-password-reset-email'; $d['form-password-reset-email'] = array ( 'form-action' => jv('e2s_password_reset_email'), 'show-controls?' => $nw, 'submit-text' => $_strings['fb--send-link-by-email'], ); if (!@$_superconfig['user_has_no_access_to_files']) { $d['form-password-reset-email']['reset-info']=$_strings['gs--password-reset-link-saved']; } elseif (!$nw){ mv($_strings['er--cannot-reset-password']); } return $d; } function e2s_password_reset_email(){ global$_strings,$settings; if($_SERVER['REQUEST_METHOD']!='POST')c(); if(array_key_exists('email',$_POST))$z3=trim($_POST['email']); if (!$z3){ mv($_strings['er--cannot-send-link-email-empty']); c(jv('e2m_password_reset')); } $mw=@file_get_contents(USER_FOLDER. 'password-reset.psa'); if(strlen($mw)==0){ mv($_strings['er--error-occurred']); c(jv('e2m_password_reset')); } if ($k8=$settings['author_email']) { if ($z3==$k8){ $l8=f1( 'password-reset', array ('reset-href' => $mw) ); $z8=$_strings['em--password-reset-subject']; $x8='From: '. d1(); s1($k8,$z8,$l8,$x8); } mv($_strings['gs--password-reset-link-sent-maybe'],E2E_MESSAGE); c(jv('e2m_password_reset')); } die; } function e2m_password($parameters){ global$settings,$_strings; $fw=false; $rm=''; if(array_key_exists('recovery-key',$parameters)) { $rm=$parameters['recovery-key']; $sm=jv('e2m_password', array ('recovery-key' => $rm)); $mw=@file_get_contents(USER_FOLDER. 'password-reset.psa'); if(strlen($mw) > 0){ $fw=($sm==$mw); } } if (k2() or $fw){ $d['title']=$_strings['pt--password']; $d['heading']=$_strings['pt--password-for-blog']; if ($fw){ $d['title']=$_strings['pt--password-reset']; $d['heading']=$_strings['pt--password-reset']; } $d['form']='form-password'; $d['form-password'] = array ( 'form-action' => jv('e2s_password_save'), '.recovery-key' => $rm, 'recovering?' => $fw, 'submit-text' => $_strings['fb--change'], ); return $d; } else { c(); } } function e2m_sessions(){ global$settings,$_strings; $nk=x2(); $d['title']=$_strings['pt--sessions']; $d['heading']=$_strings['pt--sessions']; $dw=array(); $rm=$_COOKIE[b('key')]; foreach ($nk['sessions'] as $t => $xf){ $dw[] = array ( 'current?' => sha1($rm)===$xf['key_hash'], 'opened' => array ((int)$xf['stamp'],sy()), 'ip-address' => $xf['remote_ip'], 'source' => ($xf['remote_ip']=='127.0.0.1')? $_strings['gs--locally']:$xf['remote_ip'], 'title' => j2($xf['ua']), 'user-agent' => $xf['ua']? $xf['ua']:$_strings['gs--unknown'], ); } $dw=array_reverse($dw); $d['sessions']['each']=$dw; if(count($dw) > 1){ $d['form']='form-sessions'; $d['form-sessions'] = array ( 'form-action' => jv('e2s_drop_other_sessions'), 'submit-text' => $_strings['fb--end-all-sessions-but-this'], ); } return $d; } function e2m_sign_in(){ if (k2()) { c(jv('e2m_frontpage', array ('page' => 1))); } else { return array (); } } function e2m_sign_out(){ global$_strings; $nk=x2(); $sw=-1; if(array_key_exists('sessions',$nk) and is_array($nk['sessions'])) { foreach ($nk['sessions'] as $t => $xf){ $rm=$_COOKIE[b('key')]; if(sha1($rm)===$xf['key_hash']) { $sw=$t; break; } } } if ($sw > -1) unset ($nk['sessions'][$sw]); if (!e2_($nk)) { mv($_strings['er--cannot-write-auth-data'],E2E_PERMISSIONS_ERROR); } y('key',''); c(); } function e2s_password_save(){ global$settings,$_strings; $fw=false; $aw=trim($_POST['old-password']); if ($rm=trim($_POST['recovery-key'])) { $sm=jv('e2m_password', array ('recovery-key' => $rm)); $mw=@file_get_contents(USER_FOLDER. 'password-reset.psa'); if(strlen($mw) > 0){ $fw=($sm==$mw); } } if (l2($aw) or $fw){ $yk=trim($_POST['new-password']); if ($yk!=''){ if (@n3(USER_FOLDER. '/password-hash.psa',serialize(sha1($yk)))) { @unlink(USER_FOLDER. 'password-reset.psa'); mv($_strings['gs--password-changed'],E2E_MESSAGE); c(); } else { mv($_strings['er--could-not-change-password'],E2E_PERMISSIONS_ERROR); c(jv('e2m_password', array ('recovery-key' => ''))); } } else { mv($_strings['er--no-password-entered'],E2E_USER_ERROR); c(jv('e2m_password', array ('recovery-key' => ''))); } } else { mv($_strings['er--wrong-password'],E2E_USER_ERROR); c(jv('e2m_password', array ('recovery-key' => ''))); } die; } function q2(){ $gv=$_SERVER['REMOTE_ADDR']; if(array_key_exists('HTTP_X_FORWARDED_FOR',$_SERVER)) { $gv=array_pop(explode(',',$_SERVER['HTTP_X_FORWARDED_FOR'])); } return $gv; } function e2s_sign_in(){ global$_strings; $nk=x2(); if($_SERVER['REQUEST_METHOD']=='POST'){ $vz=@$_POST['password']; $qw=@$_POST['is_public_pc']; } else { $vz=@$_GET['password']; $qw=false; } if (l2($vz)) { @unlink(USER_FOLDER. 'password-reset.psa'); $lw=array ( 'stamp' => time(), 'remote_ip' => q2(), 'key_hash' => z2($qw), 'ua' => $_SERVER['HTTP_USER_AGENT'], ); $nk['sessions'][] = $lw; } elseif(strlen(trim($vz)) > 0){ g2(); mv($_strings['er--wrong-password'],E2E_USER_ERROR); } if (!e2_($nk)) { mv($_strings['er--cannot-write-auth-data'],E2E_PERMISSIONS_ERROR); c(); } v(); } function e2s_drop_other_sessions(){ global$_strings; $nk=x2(); foreach ($nk['sessions'] as $t => $xf){ $rm=$_COOKIE[b('key')]; if(sha1($rm)===$xf['key_hash']) { $lw=$xf; break; } } $nk['sessions'] = array ($lw); if (!e2_($nk)) { mv($_strings['er--cannot-write-auth-data'],E2E_PERMISSIONS_ERROR); } v(); die; } function l2($vz){ $zw=@unserialize(file_get_contents(USER_FOLDER. '/password-hash.psa')); return (sha1($vz)===$zw and trim($vz)!=''); } function z2($kw=false){ global$settings; $rm=h2(); $xw=sha1($rm); y('key',$rm, !$kw); return $xw; } function k2(){ global $nn,$settings,$_auth_sessions; if (isset ($nn)) return $nn; $nn=false; if (isset ($_COOKIE[b('key')])) { $rm=$_COOKIE[b('key')]; $nk=x2(); $ew=array(); if(array_key_exists('sessions',$nk) and is_array($nk['sessions'])) { foreach ($nk['sessions'] as $lw){ $ew[] = $lw['key_hash']; } $_auth_sessions['count']=count($nk['sessions']); } if(1){ $nn=(bool)in_array(sha1($rm),$ew,true); } if (!$nn){ y('key',''); } } return $nn; } function x2(){ if(is_file(USER_FOLDER.'auth.psa')) { $nk=unserialize(@file_get_contents(USER_FOLDER.'auth.psa')); if ($nk) return $nk; } return array (); } function e2_($nk){ return n3(USER_FOLDER.'auth.psa',serialize($nk)); } function r2(){ if ($rm=$_COOKIE[b('key')]) { return b('key') .'='. $rm .""; } } function t2(){ if ($rm=$_COOKIE[b('key')]) { return 'Cookie: '. b('key') .'='. $rm ."\r\n"; } return "\r\n"; } function j2($xv){ global$_strings; if(strstr($xv,'iPhone')) return$_strings['gs--ua-iphone']; if(strstr($xv,'iPad')) return$_strings['gs--ua-ipad']; if(strstr($xv,'Opera'))$d=$_strings['gs--ua-opera']; if(strstr($xv,'Firefox'))$d=$_strings['gs--ua-firefox']; if(strstr($xv,'Chrome'))$d=$_strings['gs--ua-chrome']; if(strstr($xv,'Safari') and !strstr($xv,'Chrome'))$d=$_strings['gs--ua-safari']; if (!$d)$d=$_strings['gs--ua-unknown']; if(strstr($xv,'Macintosh')) { if ($d)$d.=' '. $_strings['gs--ua-for-mac']; } return $d; } function e2j_check_password(){ $zw=@unserialize(file_get_contents(USER_FOLDER. '/password-hash.psa')); $vz=''; if(array_key_exists('password',$_POST))$vz=$_POST['password']; g2(); $zv=[ 'success' => true, 'data' => [ 'password-correct' => trim($vz)!=='' and sha1($vz)===$zw ], ]; $zv=json_encode($zv); die ($zv); } function h2(){ $rw=''; $tw='0123456789abcdef'; for ($r=0; $r < 40; $r++)$rw.=$tw[mt_rand(0,15)]; $rw.=time(); $rw=sha1($rw); return $rw; } function g2(){ if(is_file(USER_FOLDER. 'password-wait.psa')) { $jw=unserialize( file_get_contents(USER_FOLDER. '/password-wait.psa') ); if ($jw['delay'] < 5){ $jw['delay'] ++; } if(time()-$jw['time'] > SECONDS_IN_A_MINUTE){ $jw['delay']=0; } $jw['time']=time(); } else { $jw=array ( 'time' => time(), 'delay' => 5, ); } n3(USER_FOLDER.'password-wait.psa',serialize($jw)); sleep($jw['delay']); } function w2(){ static $hw; if(empty($hw))$hw=md5('seсret'); return $hw; } function u2($x){ $rm=w2(); $gw=strlen($rm); $ww=strlen($x); $d=''; for ($r=0; $r < $ww+rand(16,64); ++ $r){ if ($r > $ww){ $uw=rand(0,127); } elseif ($r==$ww){ $uw=0; } else { $uw=ord($x[$r]); } $iw=chr(($uw+ord($rm[$r%$gw])) % 256); $d.=$iw; } $d=base64_encode($d); return $d; } function i2($x){ $rm=w2(); $gw=strlen($rm); $x=base64_decode($x); $ww=strlen($x); $d=''; for ($r=0; $r < $ww; ++ $r){ $ow=(ord($x[$r]) + 256-ord($rm[$r%$gw])) % 256; if ($ow===0) break; $d.=chr($ow); } return $d; } function o2(){ global$settings; if (k2()) { return null; } else { return [ 'form-action' => jv('e2s_sign_in'), 'form-check-password-action' => jv('e2j_check_password'), 'login-name' => @$settings['author'], 'public-pc?' => false, 'reset-href' => jv('e2m_password_reset'), ]; } } $_candies_installer=array ( 'e2s_build', 'e2m_info', 'e2m_install', 'e2j_check_db_config', 'e2j_list_databases', 'e2s_instantiate', 'e2s_install', 'e2s_update_perform', ); $_candies_public=array ( 'e2m_info', 'e2m_frontpage', 'e2m_rss', 'e2m_json', 'e2m_note', 'e2m_note_json', 'e2m_note_read', 'e2m_tags', 'e2m_tag', 'e2m_untagged', 'e2m_tag_rss', 'e2m_tag_json', 'e2m_favourites', 'e2m_most_commented', 'e2m_found', 'e2m_comments', 'e2m_everything', 'e2m_sitemap_xml', 'e2m_year', 'e2m_month', 'e2m_day', 'e2m_unsubscribe', 'e2m_theme_preview', 'e2m_password_reset', 'e2s_password_reset_email', 'e2m_password', 'e2s_password_save', 'e2s_sign_in', 'e2m_sign_out', 'e2m_gip_sign_in', 'e2m_gip_sign_in_callback', 'e2m_gip_sign_out', 'e2s_comment_process', 'e2s_search', 'e2s_bsi_step', 'e2j_check_password', 'e2s_notify', 'e2s_dump', ); $_candies_to_disallow_in_read_only=array ( 'e2m_write', 'e2m_note_edit', 'e2s_note_process', 'e2s_note_publish', 'e2s_note_delete', 'e2m_note_flag_favourite', 'e2m_note_flag', 'e2m_comment_edit', 'e2m_comment_delete', 'e2m_comment_reply', 'e2m_comment_reply_delete', 'e2m_comment_flag', 'e2m_comment_flag_ajax', 'e2m_unsubscribe', 'e2s_comment_process', 'e2m_settings', 'e2m_timezone', ); $_candies_public=array_merge($_candies_public,$_candies_installer); $_candies_indexable=array ( 'e2m_note', ); $_candies_indexable_conditionally=array ( 'e2m_frontpage', 'e2m_tag', 'e2m_favourites', 'e2m_most_commented', 'e2m_found', 'e2m_tags', 'e2m_everything', ); $_candies_ajax=array ( 'e2j_check_db_config', 'e2j_list_databases', 'e2j_check_password', 'e2j_userpic_upload', 'e2j_userpic_remove', 'e2j_file_upload', 'e2j_file_remove', 'e2j_note_livesave', 'e2m_note_flag_favourite', 'e2m_comment_flag_ajax', 'e2m_tag_flag_ajax', ); function p2(){ global$settings,$_lang,$_config,$_strings,$c; if(Log::$cy)__log('Blog information'); $pw['author']=htmlspecialchars(vd(),ENT_NOQUOTES,HSC_ENC); if(array_key_exists('blog_subtitle',$settings)) { $z1=i3($settings['blog_subtitle'],'full'); $s3=$z1['text-final']; $pw['subtitle']=$s3; $pw['subtitle-format-info']=$z1['meta']; va(@$z1['meta']['links-required']); } $pw['title']=htmlspecialchars(cd(),ENT_NOQUOTES,HSC_ENC); $pw['userpic-set?']=false; $pw['userpic-changeable?']=k2(); if ($pw['userpic-href']=bd()) { $pw['userpic-set?']=true; $pw['userpic-large-href']=bd('large'); $pw['userpic-square-href']=bd('square'); $pw['userpic-changeable-href']=$pw['userpic-href']; } else { unset ($pw['userpic-href']); } if (k2()) { $pw['userpic-upload-action']=jv('e2j_userpic_upload'); $pw['userpic-remove-action']=jv('e2j_userpic_remove'); } $pw['href']=jv('e2m_frontpage', array ('page' => 1)); $pw['rss-href']=jv('e2m_rss'); $pw['jsonfeed-href']=jv('e2m_json'); $pw['language']=$_lang; $pw['show-subscribe-button?']=false; if(E2_EDITION){ $pw['show-subscribe-button?']=true; } $rb=array (time(),ay()); $cu=xy('Y',$rb[0]); $pw['now']=$rb; $vu=$cu; $bu=bs('start'); if(array_key_exists('stamp',$bu)) { $vu=xy('Y',$bu['stamp']); $pw['start-time'] = array ((int)$bu['stamp'],$bu['timezone']); } $yu=false; $nu=zm(true,true); if ($nu!==null){ if (k2()) { $mu=zm(true,false); if ($mu!==null){ $yu=($nu+$mu==0); } } else { $yu=($nu==0); } } $pw['notes-count'] = (int)$nu; $pw['virgin?']=$yu; $fu=$_config['years_range_separator']? $_config['years_range_separator']:$_strings['gs--range-separator']; $pw['years-range']=$vu . (($vu==$cu)? '':($fu.$cu)); if ($c){ $pw['parent-site-href']=substr($c, (int)strpos('/',$c)); } return $pw; } function cd(){ global$settings,$_strings; if ( array_key_exists('blog_title',$settings) and trim($settings['blog_title']) != '' ){ return trim($settings['blog_title']); } else { return$_strings['e2--default-blog-title']; } } function vd(){ global$settings,$_strings; if ( array_key_exists('author',$settings) and trim($settings['author']) != '' ){ return trim($settings['author']); } else { return$_strings['e2--default-blog-author']; } } function bd($size=''){ global$full_blog_url; if (!is_file($fb=USER_FOLDER .'userpic@2x.png')) { if (!is_file($fb=USER_FOLDER .'userpic@2x.jpg')) { return false; } } if($size=='large' and is_file(USER_FOLDER .'userpic-large@2x.jpg')) { $fb=USER_FOLDER .'userpic-large@2x.jpg'; } if($size=='square' and is_file(USER_FOLDER .'userpic-square@2x.jpg')) { $fb=USER_FOLDER .'userpic-square@2x.jpg'; } $ry=stat($fb); if ($ry['mtime']) { $fb.='?'. $ry['mtime']; } $du=$full_blog_url .'/'. $fb; return $du; } function yd(){ global$_config,$_stopwatch,$bz; $su=round(w()-$_stopwatch,3); return [ 'show?' => ($_config['display_stat'] > (int) !k2()), 'generation-time' => str_replace('.',',',$su), 'peak-memory-mb' => str_replace('.',',',round((memory_get_peak_usage()/1024/1024)*100)/100), 'db-query-count' => (int) @$bz, ]; } function e2m_info(){ global$settings,$_config,$v,$c,$_template; $hv=array ( 'E2_VERSION' => E2_VERSION, 'E2_RELEASE' => E2_RELEASE, 'E2_UA_STRING' => E2_UA_STRING, '---', 'PHP_VERSION' => PHP_VERSION, '---', 'installed' => (fn_()!==null), 'server_name' => $v, 'folder_on_server' => $c, '---', 'default formatter' => $_config['default_formatter'], '---', 'theme' => $settings['template'], '---', 'Olba name' => $_template['name'], 'Olba max_image_width' => $_template['max_image_width'], 'Olba stack' => $_template['stack'], '---', 'Neasden' => substr(md5(file_get_contents('system/neasden/neasden.php')), 0,4), '---', ); echo '<pre>'; foreach ($hv as $t => $xf){ if ($xf=='---'){ echo "\n"; continue; } echo str_pad($t,24); echo '\''; print_r($xf); echo '\''; echo "\n"; } echo '</pre>'; die; } function e2s_notify(){ global$_config; if($_config['holborn']) { $au=@$_GET['src']; if ($au==''){ if(Log::$cy)__log('Holborn: No src URL'); die; } $qu=file_get_contents($au); $qu=dd($qu); $lu=json_decode($qu,true); if (!$lu){ if(Log::$cy)__log('Holborn: No meaningful info from '. $au .' ('. json_last_error() .')'); if ($zu=md($au)) { if(Log::$cy)__log('Holborn: Delete note with ID '. $zu['ID']); bm($zu['ID']); } die; } nd($lu,$au); } die; } function e2m_sources($parameters){ global$_config; $ku=$_GET['ord']; if (!$ku)$ku='ID'; $ku="`". en($ku) ."`"; kn( "SELECT *, REPLACE(REPLACE(REPLACE(`URL`, 'http://', ''), 'https://', ''), 'www.', '') AS _URLX ". "FROM `". $_config['db_table_prefix']."Sources` " . "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "ORDER BY ". $ku ); $q1=xn(); foreach ($q1 as $bm){ $xu=$bm['ID']; if ($bm['ID']!=$bm['TrueID'])$xu.='<br />'. $bm['TrueID']; $t7=array ( 'id' => $xu, 'userpic-href' => $bm['PictureURL'], 'href' => $bm['URL'], 'href-display' => str_replace('/','/<wbr>',$bm['URL']), 'href-filtered' => str_replace('/','/<wbr>',$bm['_URLX']), 'title' => $bm['Title'], 'author' => $bm['AuthorName'], 'true?' => $bm['ID']==$bm['TrueID'], 'whitelisted?' => (bool)$bm['IsWhiteListed'], 'trusted?' => (bool)$bm['IsTrusted'], ); if (!$bm['IsTrusted']) { $t7['trust-url']=jv( 'e2m_source_trust', array ('source' => $bm['ID']) ); } if ($bm['IsTrusted']) { $t7['premoderate-url']=jv( 'e2m_source_premoderate', array ('source' => $bm['ID']) ); } $t7['ban-url']=jv( 'e2m_source_ban', array ('source' => $bm['ID']) ); $t7['forget-url']=jv( 'e2m_source_forget', array ('source' => $bm['ID']) ); $eu[] = $t7; } $d=array ( 'title' => 'Sources', 'heading' => 'Sources', ); if(count($eu)) { $d['sources']=$eu; } else { $d['nothing']='No sources'; } return $d; } function e2m_source_trust($parameters){ global$_config; $ru=$parameters['source']; kn( "UPDATE  ". $_config['db_table_prefix']."Sources ". "SET `IsWhitelisted`=1, `IsTrusted`=1 ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID`=". $ru, 'trust source' ); kn( "UPDATE  ". $_config['db_table_prefix']."Notes ". "SET `IsPublished`=1 ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `SourceID`=". $ru, 'publish all notes from the just trusted source' ); aa(); ds(); @unlink(CACHE_FILENAME_DRAFTS); @unlink(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); c(); } function e2m_source_premoderate($parameters){ global$_config; $ru=$parameters['source']; kn( "UPDATE  ". $_config['db_table_prefix']."Sources ". "SET `IsTrusted`=0 ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID`=". $ru, 'distrust source, set to premoderation' ); ds(); c(); } function e2m_source_ban($parameters){ global$_config; $ru=$parameters['source']; kn( "UPDATE  ". $_config['db_table_prefix']."Sources ". "SET `IsWhiteListed`=0, `IsTrusted`=0 ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID`=". $ru, 'ban source' ); kn( "DELETE FROM  ". $_config['db_table_prefix']."Notes ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `SourceID`=". $ru, 'delete all notes from the just banned source' ); ds(); @unlink(CACHE_FILENAME_DRAFTS); @unlink(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); c(); } function e2m_source_forget($parameters){ global$_config; $ru=$parameters['source']; kn( "DELETE FROM  ". $_config['db_table_prefix']."Sources ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID`=". $ru, 'forget source' ); kn( "DELETE FROM  ". $_config['db_table_prefix']."Notes ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `SourceID`=". $ru, 'delete all notes from the just forgotten source' ); ds(); @unlink(CACHE_FILENAME_DRAFTS); @unlink(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); c(); } function nd($tu,$au){ global$_config; $ju=sd(array ( 'author' => $tu['author']['name'], 'title' => $tu['title'], 'href' => $tu['author']['url'], 'userpic-href' => $tu['author']['avatar'], )); if (!$ju['IsWhiteListed']) return; if(preg_match('/\+(\d\d)\:(\d\d)/',$tu['items'][0]['date_published'],$y3)) { $yl=$y3[1]*SECONDS_IN_AN_HOUR+$y3[2]*SECONDS_IN_A_MINUTE; } $hu=@$tu['items'][0]['_e2_data'] or $hu=array(); $hu=json_encode($hu); $gu=$ju['IsTrusted']; $n2=array ( 'Title' => $tu['items'][0]['title'], 'Text' => $tu['items'][0]['content_html'], 'FormatterID' => 'raw', 'OriginalAlias' => '', 'Uploads' => '', 'Stamp' => strtotime($tu['items'][0]['date_published']), 'Offset' => (int)$yl, 'IsDST' => 0, 'LastModified' => strtotime($tu['items'][0]['date_modified']), 'IsCommentable' => 0, 'IsPublished' => $gu, 'IsExternal' => 1, 'SourceID' => $ju['ID'], 'SourceNoteID' => $tu['items'][0]['id'], 'SourceNoteURL' => $tu['items'][0]['url'], 'SourceNoteJSONURL' => $au, 'SourceNoteData' => $hu, ); $nx=$tu['items'][0]['id']; if ( $zu=fd($ju['ID'],$nx) ) { $n2['ID']=$zu['ID']; nn('Notes',$n2); } else { $n2=yn('Notes',$n2); } if ($gu){ if (la($n2)) { $n2['IsIndexed']='1'; nn('Notes',$n2); } } e2_drop_caches_for_note_($n2['ID'],$gu); if($_config['backup_automatically']) { rn(); } } function md($au){ global$_config; kn( "SELECT `ID` FROM ". $_config['db_table_prefix']."Notes ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `SourceNoteJSONURL`='". en($au) ."' ". "LIMIT 1", 'get note ID by source JSON URL' ); $q1=xn(); return $q1[0]; } function fd($ru,$wu){ global$_config; kn( "SELECT `ID` FROM ". $_config['db_table_prefix']."Notes ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `SourceID`= '". $ru ."' ". "AND `SourceNoteID`= '". $wu ."' ". "LIMIT 1", 'get note ID by source ID and source note ID' ); $q1=xn(); return $q1[0]; } function dd($qu){ for ($r=0; $r <= 31; ++$r){ $qu=str_replace(chr($r),'',$qu); } $qu=str_replace(chr(127),'',$qu); if(0===strpos(bin2hex($qu),'efbbbf')) { $qu=substr($qu,3); } return $qu; } function sd($uu){ global$_config; $iu=false; kn( "SELECT * FROM ". $_config['db_table_prefix']."Sources ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `URL`= '". $uu['href'] ."' ". "LIMIT 1", 'get source record by the URL from blog info' ); $q1=xn(); if(count($q1)) { $iu=$q1[0]; if ($iu['ID']!=$iu['TrueID']) { kn( "SELECT * FROM ". $_config['db_table_prefix']."Sources ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID`= '". $iu['TrueID'] ."' ". "LIMIT 1", 'get true source record by using the TrueID of just found record' ); $q1=xn(); if(count($q1)) { $iu=$q1[0]; } } } $ju=array ( 'Title' => $uu['title'], 'AuthorName' => $uu['author'], 'PictureURL' => $uu['userpic-href'], ); if ($iu!==false){ if ( $iu['Title']!==$uu['title'] or $iu['AuthorName']!==$uu['author'] or $iu['PictureURL']!==$uu['userpic-href'] ) { $ju['ID']=$iu['ID']; nn('Sources',$ju); } return $iu; } else { $ju['URL']=$uu['href']; $ju['IsWhiteListed']=1; $ju['IsTrusted']=0; $ju=yn('Sources',$ju); $ju['TrueID']=$ju['ID']; nn('Sources',$ju); return $ju; } } function ad($n2){ global$_config; $tj=array(); if (@$n2['IsExternal']) { if(array_key_exists('SourceID',$n2)) { kn( "SELECT * FROM `". $_config['db_table_prefix']."Sources` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID` = '". $n2['SourceID'] ."'", 'get source by id' ); $ib=xn(); $tj['source']=$ib[0]['Title']; $tj['source-id'] = (int)$n2['SourceID']; $tj['source-true-id'] = (int)$ib[0]['TrueID']; $tj['source-whitelisted?'] = (bool)$ib[0]['IsWhiteListed']; $tj['source-trusted?'] = (bool)$ib[0]['IsTrusted']; if (!$ib[0]['IsTrusted']) { $tj['source-trust-url']=jv( 'e2m_source_trust', array ('source' => $n2['SourceID']) ); } if ($ib[0]['IsTrusted']) { $tj['source-premoderate-url']=jv( 'e2m_source_premoderate', array ('source' => $n2['SourceID']) ); } $tj['source-ban-url']=jv( 'e2m_source_ban', array ('source' => $n2['SourceID']) ); $tj['source-forget-url']=jv( 'e2m_source_forget', array ('source' => $n2['SourceID']) ); $tj['author']=$ib[0]['AuthorName']; $tj['author-href']=$ib[0]['URL']; $tj['userpic-href']=$ib[0]['PictureURL']; } if(array_key_exists('SourceNoteURL',$n2) and @$n2['SourceNoteURL']!=''){ $tj['href-external']=$n2['SourceNoteURL']; } } return $tj; } function e2m_frontpage($parameters=[]) { global$settings,$_strings,$_config; if(Log::$cy)__log('Frontpage {'); $je=k2(); $frontpageView=new AePageableNotesView('e2m_frontpage',$parameters); $frontpageView -> setPortionSize($settings['appearance']['notes_per_page']); $frontpageView -> setNextPrevPageTitles($_strings['gs--earlier'],$_strings['gs--later']); $frontpageView -> setWantPaging(true); $frontpageView -> setWantNewCommentsCount($je); $frontpageView -> setWantReadHrefs($_config['count_reads']); $frontpageView -> setWantControls($je and !@$_config['read_only']); $frontpageView -> setWantHiddenTags($je); $frontpageView -> setWantRelatedNotes(true); if(E2_EDITION){ $frontpageView -> setWantPreviewHrefs(true); } if(CACHE_FRONTPAGE and $frontpageView -> isFirstPage()) { if ($je){ $frontpageView -> setCacheFilename(CACHE_FILENAME_FRONTPAGE_AUTHOR); } else { $frontpageView -> setCacheFilename(CACHE_FILENAME_FRONTPAGE); } } $frontpageView -> setLimitlessSQLRequest( "SELECT * ". "FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished`=1 ". em($je). "ORDER BY `Stamp` DESC" ); $d=[ 'title' => cd(), 'heading' => '', 'notes' => $frontpageView -> getNotesCTree(), 'pages' => $frontpageView -> getPagesCTree(), 'frontpage?' => $frontpageView -> isFirstPage(), ]; if ( !$frontpageView -> isExistingPage() and !$frontpageView -> isFirstPageOfEmptyView() ) { return e2_error404_mode(); } if(Log::$cy)__log('} // Frontpage'); return $d; } function e2m_json($parameters=array ()) { list ($ou,$hg)=ed(); $qu=json_encode($ou,E2_JSON_STYLE); hd($qu,$hg,'json'); } function e2m_rss($parameters=array ()) { list ($ou,$hg)=ed(); $pu=e2feeds__rss_using_jsonfeed_array_($ou); hd($pu,$hg,'rss'); } function e2m_tag_json($parameters=array ()) { if(array_key_exists('*tag',$parameters)) { $q2=$parameters['*tag']; } else { return e2_error404_mode(); } list ($ou,$hg)=rd($q2); $qu=json_encode($ou,E2_JSON_STYLE); hd($qu,$hg,'json'); } function e2m_tag_rss($parameters=array ()) { global$settings,$_config,$_strings; if(array_key_exists('*tag',$parameters)) { $q2=$parameters['*tag']; } else { return e2_error404_mode(); } list ($ou,$hg)=rd($q2); $pu=e2feeds__rss_using_jsonfeed_array_($ou); hd($pu,$hg,'rss'); } function e2m_note_json($parameters=array ()) { global$settings,$_current_url; $n2=$parameters['*note']; if ($n2==false) return e2_error404_mode(); $je=k2(); if (!( xm($n2)==='public' or ($je and $n2['IsPublished']) )) return e2_error404_mode(); $hg=$n2['Stamp']; $c0=e2_jsonfeed_item_array_from_noterec_($n2); $v0=array ($c0); $ou=e2_jsonfeed_array_stub_from_jsonfeed_item_arrays_($v0); $ou['title']=cd(); $ou['_rss_description']=xd(); $ou['home_page_url']=jv('e2m_frontpage', array ('page' => 1)); $ou['feed_url']=$_current_url; hd(json_encode($ou,E2_JSON_STYLE),$hg,'json'); } function e2_jsonfeed_array_stub_from_jsonfeed_item_arrays_($v0){ global$_lang,$_config,$settings; $d=[ 'version' => 'https://jsonfeed.org/version/1', 'title' => null, '_rss_description' => null, '_rss_language' => $_lang, '_itunes_email' => '', '_itunes_categories_xml' => '', '_itunes_image' => '', '_itunes_explicit' => '', 'home_page_url' => null, 'feed_url' => null, 'icon' => bd(), 'author' => array ( 'name' => vd(), 'url' => jv('e2m_frontpage', array ('page' => 1)), 'avatar' => bd(), ), 'items' => $v0, '_e2_version' => E2_VERSION, '_e2_ua_string' => E2_UA_STRING, ]; if(E2_EDITION){ $d['_itunes_email']=htmlspecialchars(@$settings['author_email'],ENT_NOQUOTES,HSC_ENC); $d['_itunes_categories_xml']=$_config['rss_itunes_categories_xml']; $d['_itunes_image']=bd('square'); $d['_itunes_explicit']=$_config['rss_itunes_explicit']; } return $d; } function e2_jsonfeed_item_array_from_noterec_($n2){ global$settings; $sm=jv('e2m_note', array ('*note' => $n2)); $b0=( xy('Y-m-d\TH:i:s',$n2['Stamp']) . gy($n2['Stamp'],':') ); $y0=( xy('Y-m-d\TH:i:s',$n2['LastModified']) . gy($n2['LastModified'],':') ); $n0=( xy('D, d M Y H:i:s ',$n2['Stamp']) . gy($n2['Stamp']) ); $z1=u3($n2['FormatterID'], @$n2['Text'],'full-rss'); $be=d3( sb( $z1['meta']['resources-detected'], q3('note',$n2['ID']) ) ); $xq=array ( 'id' => (string)$n2['ID'], 'url' => $sm, 'title' => h3($n2['Title']), 'content_html' => $z1['text-final'], 'date_published' => $b0, 'date_modified' => $y0, ); if ($n2['IsExternal']) { $f0=ad($n2); $xq['url']=$f0['href-external']; $xq['author'] = array ( 'name' => $f0['author'], 'url' => $f0['author-href'], 'avatar' => $f0['userpic-href'], ); } if(count($be) > 0){ $xq['image']=$be[0]; } $xq['_date_published_rfc2822']=$n0; $xq['_rss_guid_is_permalink']='false'; $xq['_rss_guid'] = (string)$n2['ID']; if(E2_EDITION){ $xq['_rss_enclosures']=hb( $z1['meta']['resources-detected'] ); } $xq['_e2_data'] = array ( 'is_favourite' => (bool)$n2['IsFavourite'], 'links_required' => $z1['meta']['links-required'], 'og_images' => $be, ); return $xq; } function zd($d0,$e6,$rq){ global$_newsfeeds; if (!isset ($_newsfeeds))$_newsfeeds=[]; $s0=''; if ($d0=='rss')$s0='application/rss+xml'; if ($d0=='json')$s0='application/json'; $_newsfeeds[] = [ 'type' => $s0, 'title' => htmlspecialchars($e6,ENT_NOQUOTES,HSC_ENC), 'href' => $rq ]; } function kd(){ global$_config; kn( "SELECT * FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished`=1 ". em(). "ORDER BY `Stamp` DESC ". "LIMIT ". $_config['rss_items'], 'get recent public noterecs for RSS or JSONFeed' ); return xn(); } function xd(){ global$settings; if (!empty ($settings['meta_description'])) { $a0=strip_tags(h3(htmlspecialchars($settings['meta_description'],ENT_NOQUOTES,HSC_ENC))); } elseif (!empty ($settings['blog_subtitle'])) { $z1=i3($settings['blog_subtitle'],'full'); $a0=$z1['text-final']; $a0=km($a0); } else { $a0=cd(); } return $a0; } function ed(){ global$settings,$_current_url; $hg=0; $v0=array(); $ou=array(); $ut=CACHE_FILENAME_FRONTPAGE_FEED; if(CACHE_FRONTPAGE_FEED and is_file($ut)) { if(Log::$cy)__log('Feed array (RSS, JSON): cached'); $ou=@unserialize(file_get_contents($ut)); $hg=filemtime($ut); } else { if(Log::$cy)__log('Feed array (RSS, JSON): not cached, will need to build'); $vt=kd(); foreach ($vt as $n2){ $v0[] = e2_jsonfeed_item_array_from_noterec_($n2); $hg=max($hg,$n2['Stamp']); } $ou=e2_jsonfeed_array_stub_from_jsonfeed_item_arrays_($v0); $ou['title']=cd(); $ou['_rss_description']=xd(); $ou['home_page_url']=jv('e2m_frontpage', array ('page' => 1)); $ou['feed_url']=$_current_url; if(CACHE_FRONTPAGE_FEED)n3($ut,serialize($ou)); } return array ($ou,$hg); } function rd($q2){ global$settings,$_config,$_strings,$_current_url; $hg=0; $v0=array(); kn( "SELECT n.* ". "FROM `". $_config['db_table_prefix']."Notes` n ". "INNER JOIN `". $_config['db_table_prefix']."NotesKeywords` nk ". "ON nk.`NoteID` = n.`ID` ". "WHERE n.`SubsetID`=". $_config['db_table_subset'] ." ". "AND nk.`SubsetID`=". $_config['db_table_subset'] ." ". "AND (nk.`KeywordID` = ". $q2['ID'] .") ". "AND n.`IsPublished` = 1 ". em(k2()). "ORDER BY n.`Stamp` DESC ". "LIMIT ". $_config['rss_items'], 'get tag noterecs for RSS or JSONFeed' ); $vt=xn(); foreach ($vt as $n2){ $v0[] = e2_jsonfeed_item_array_from_noterec_($n2); $hg=max($hg,$n2['Stamp']); } if ((string)$q2['Summary']!==''){ $a0=strip_tags(h3(htmlspecialchars($q2['Summary'],ENT_NOQUOTES,HSC_ENC))); } else if ((string)$q2['Description']!==''){ $z1=i3($q2['Description'],'full'); $a0=$z1['text-final']; $a0=km($a0); } else { $a0=xd(); } $vj=htmlspecialchars($q2['PageTitle'],ENT_COMPAT,HSC_ENC); if ((string)$vj!==''){ $e6=$vj; } else { $e6=( cd() .': '. $_strings['gs--posts-tagged'] .' '. htmlspecialchars($q2['Keyword'],ENT_COMPAT,HSC_ENC) ); } $ou=e2_jsonfeed_array_stub_from_jsonfeed_item_arrays_($v0); $ou['title']=$e6; $ou['_rss_description']=$a0; $ou['home_page_url']=jv('e2m_tag', array ('*tag' => $q2)); $ou['feed_url']=$_current_url; if(E2_EDITION){ $be=d3( sb( $z1['resources-detected'], q3('tag',$q2['ID']) ) ); if(count($be) > 0){ $ou['_itunes_image']=$be[0]; } } return array ($ou,$hg); } function e2feeds__rss_using_jsonfeed_array_($content){ $q0=USER_FOLDER.'rss/rss.tmpl.php'; if (!is_file($q0)) { $q0=DEFAULTS_FOLDER.'rss/rss.tmpl.php'; } if(is_file($q0)) { ob_start(); include $q0; $pu=ob_get_contents(); ob_end_clean(); } return $pu; } function jd($pu){ $pu=str_replace("\x0",'',$pu); for ($r=0; $r < strlen($pu); ++$r){ if(ord($pu[$r]) < 32 and !in_array(ord($pu[$r]), array (10,13))) { $pu[$r]=''; } } return $pu; } function hd($l0,$hg,$d0){ global$_config; $z0=gmdate('r',$hg); $k0=md5($hg); if ($d0=='rss'){ if (@$_config['dev_xml_as_text']) { header('Content-Type: text/plain'); } else { header('Content-Type: application/xml; charset=utf-8'); } } elseif ($d0=='json'){ header('Content-Type: application/json'); } else { header('Content-Type: text/plain'); } header('Last-modified: '. $z0); header('Etag: '. $k0); header('Cache-Control: public'); header('Expires: '. date('r',$hg+SECONDS_IN_A_DAY)); $x0=isset($_SERVER['HTTP_IF_MODIFIED_SINCE'])? stripslashes($_SERVER['HTTP_IF_MODIFIED_SINCE']) : false; $e0=isset($_SERVER['HTTP_IF_NONE_MATCH'])? stripslashes($_SERVER['HTTP_IF_NONE_MATCH']) : false; if ( !$x0 && !$e0 or $e0 && $e0!=$k0 or $x0 && $x0!=$z0 ){ if ($d0=='rss'){ $pu=jd($pu); } ini_set('zlib.output_compression',0); echo $l0; ini_set('zlib.output_compression',1); } else { header('HTTP/1.1 304 Not Modified'); } die; } function e2m_year($parameters=array ()) { global$_strings,$_config; $r0=$parameters['year']; $t0=e2l_get_string('pt--nth-year', array ('year' => $r0)); if (!ud($r0)) { return e2_error404_mode(); } $j0=gmmktime(0,0,0,1,1,$r0-1); $h0=gmmktime(0,0,0,1,1,$r0+1); list ($g0,$w0)=e2__fruitful_neighbours_with_ymd_($r0); $u0='e2m_year'; if ($g0){ $i0['prev-href']=jv( $u0,e2__parameters_with_timestamp_($g0) ); $i0['prev-jump?'] = (bool) (gmdate('Y',$j0)!=gmdate('Y',$g0)); $i0['prev-title']=gmdate('Y',$g0); } if ($w0){ $i0['next-href']=jv( $u0,e2__parameters_with_timestamp_($w0) ); $i0['next-jump?'] = (bool) (gmdate('Y',$h0)!=gmdate('Y',$w0)); $i0['next-title']=gmdate('Y',$w0); } $i0['timeline?']=false; $i0['this']=$r0; $i0['this-title']=$r0; $o0=bs('start'); $p0=bs('end'); if ( $r0==ky('Y',$o0['stamp'],$o0['timezone']) ) { $c9=ky('m',$o0['stamp'],$o0['timezone']); } else { $c9=1; } if ( $r0==xy('Y',time()) ) { $v9=xy('m',time()); } else { $v9=12; } $b9=cs($r0); for ($y9=1; $y9 <= 12; ++ $y9){ $n9=gmmktime(0,0,0,$y9,1,$r0); $m9[$y9] = array ( 'number' => $y9, 'start-time' => array ($n9,sy()), 'href' => gmdate('Y/m/',$n9), 'real?' => $y9 >= $c9 and $y9 <= $v9, 'fruitful?' => @in_array(gmdate('n',$n9),$b9), ); } list ($gr,$wr)=jy($r0); $d=[ 'title' => $t0, 'heading' => $t0, 'pages' => $i0, 'year' => (int)$r0, 'year-months' => $m9, ]; kn( "SELECT * FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished` = 1 ". em(k2()). "AND `Stamp` BETWEEN ". $gr ." ". "AND ". $wr ." ". "ORDER BY `Stamp`", 'get all notes for the year' ); $q1=xn(); $s5=pd($q1,$r0); if(count($s5)) { $d['notes-list']=$s5; } else { $d['nothing']=$_strings['gs--no-such-notes']; } return $d; } function e2m_month($parameters=array ()) { global$_strings,$_config; $r0= $parameters['year']; $y9=$parameters['month']; $t0=e2l_get_string( 'pt--nth-month-of-nth-year', array ('year' => $r0,'month' => $y9) ); if (!ud($r0,$y9)) { return e2_error404_mode(); } $j0=gmmktime(0,0,0,$y9-1,1,$r0); $h0=gmmktime(0,0,0,$y9+1,1,$r0); list ($g0,$w0)=e2__fruitful_neighbours_with_ymd_($r0,$y9); $u0='e2m_month'; if ($g0){ $i0['prev-href']=jv( $u0,e2__parameters_with_timestamp_($g0) ); $i0['prev-jump?'] = (bool) (gmdate('Y/m',$j0)!=gmdate('Y/m',$g0)); $i0['prev-title']=e2l_get_string( 'gs--nth-month-of-nth-year', array ( 'year' => gmdate('Y',$g0),'month' => gmdate('n',$g0) ) ); } if ($w0){ $i0['next-href']=jv( $u0,e2__parameters_with_timestamp_($w0) ); $i0['next-jump?'] = (bool) (gmdate('Y/m',$h0)!=gmdate('Y/m',$w0)); $i0['next-title']=e2l_get_string( 'gs--nth-month-of-nth-year', array ( 'year' => gmdate('Y',$w0),'month' => gmdate('n',$w0) ) ); } $i0['timeline?']=false; $i0['this-title']=$t0; list ($gr,$wr)=jy($r0,$y9); $d=[ 'title' => $t0, 'heading' => $t0, 'pages' => $i0, 'year' => (int)$r0, 'month' => (int)$y9, 'month-days' => e2_pack_month_days_with_ymd_($r0,$y9,false), ]; kn( "SELECT * FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished` = 1 ". em(k2()). "AND `Stamp` BETWEEN ". $gr ." ". "AND ". $wr ." ". "ORDER BY `Stamp`", 'get all notes for the month' ); $q1=xn(); $s5=pd($q1,$r0,$y9); if(count($s5)) { $d['notes-list']=$s5; } else { $d['nothing']=$_strings['gs--no-such-notes']; } return $d; } function e2m_day($parameters=array ()) { global$_strings,$_config; $r0= (int)$parameters['year']; $y9=(int)$parameters['month']; $d9= (int)$parameters['day']; if (!(ud($r0,$y9,$d9))) { return e2_error404_mode(); } $t0=e2l_get_string( 'pt--nth-day-of-nth-month-of-nth-year', array ('year' => $r0,'month' => $y9,'day' => $d9) ); $j0=gmmktime(0,0,0,$y9,$d9-1,$r0); $h0=gmmktime(0,0,0,$y9,$d9+1,$r0); list ($g0,$w0)=e2__fruitful_neighbours_with_ymd_($r0,$y9,$d9); $u0='e2m_day'; if ($g0){ $i0['prev-href']=jv( $u0,e2__parameters_with_timestamp_($g0) ); $i0['prev-jump?'] = (bool) (gmdate('Y/m/d',$j0)!=gmdate('Y/m/d',$g0)); $i0['prev-title']=e2l_get_string( 'gs--nth-day-of-nth-month-of-nth-year', array ( 'year' => gmdate('Y',$g0),'month' => gmdate('n',$g0),'day' => gmdate('j',$g0), ) ); } if ($w0){ $i0['next-href']=jv( $u0,e2__parameters_with_timestamp_($w0) ); $i0['next-jump?'] = (bool) (gmdate('Y/m/d',$h0)!=gmdate('Y/m/d',$w0)); $i0['next-title']=e2l_get_string( 'gs--nth-day-of-nth-month-of-nth-year', array ( 'year' => gmdate('Y',$w0),'month' => gmdate('n',$w0),'day' => gmdate('j',$w0), ) ); } $i0['timeline?']=false; $i0['this-title']=$t0; $d=[ 'title' => $t0, 'heading' => $t0, 'pages' => $i0, 'month-days' => e2_pack_month_days_with_ymd_($r0,$y9,$d9), ]; $q1=fm($r0,$y9,$d9); $q1=array_reverse($q1); $je=k2(); $s5=[]; foreach ($q1 as $t => $n2){ if (!( xm($n2)==='public' or ($je and $n2['IsPublished']) )) continue; $noteView=new AeNoteView($n2); $noteView -> setWantNewCommentsCount($je); $noteView -> setWantReadHref($_config['count_reads']); $noteView -> setWantControls($je and !@$_config['read_only']); $noteView -> setWantHiddenTags($je); $noteView -> setWantCommentsLink(true); $s5[] = $noteView -> getNoteCTree(); } if(count($s5)) { $d['notes']=$s5; } else { $d['nothing']=$_strings['gs--no-such-notes']; } return $d; } function gd(){ global$_config; $s5=null; if(CACHE_FULLLIST and is_file(CACHE_FILENAME_FULLLIST)) { $s5=@unserialize(file_get_contents(CACHE_FILENAME_FULLLIST)); if(Log::$cy)__log('Retrieving full notes list from cache...'); } if (!is_array($s5)) { if(Log::$cy)__log('Retrieving full notes list from database...'); kn( "SELECT `ID`, `Title`, `Stamp`, `LastModified`, `Offset`, `IsDST`, ". "`IsFavourite`, `IsPublished`, `IsVisible`, `SourceNoteURL`, `OriginalAlias` ". "FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished` = 1 ". em(). "ORDER BY `Stamp`", 'get full notes list' ); $q1=xn(); $s5=pd($q1); if(CACHE_FULLLIST)n3(CACHE_FILENAME_FULLLIST,serialize($s5)); } return $s5; } function e2m_everything($parameters=array ()) { global$_strings; $s5=gd(); $s9=count($s5); $t0=e2l_get_string('pt--n-posts', array ('number' => $s9)); $d=[ 'title' => $t0, 'heading' => $t0, ]; if(count($s5)) { $d['notes-list']=$s5; } else { $d['nothing']=$_strings['gs--no-notes']; } return $d; } function e2m_sitemap_xml($parameters=array ()) { global$_config; $s5=gd(); if (@$_config['dev_xml_as_text']) { header('Content-Type: text/plain'); } else { header('Content-type: application/xml; charset=utf-8'); } echo '<?xml version="1.0" encoding="UTF-8"?>'."\r\n"; echo '<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">'."\r\n"; if(count($s5)) { $hg=@$s5[0]['last-modified']; echo '<url>'."\r\n"; echo '<loc>'. jv('e2m_frontpage', array ('page' => 1)) .'</loc>'."\r\n"; echo '<lastmod>'; echo gmdate('Y-m-d\TH:i:s\Z',$hg[0]); echo '</lastmod>'."\r\n"; echo '<changefreq>hourly</changefreq>'; echo '</url>'."\r\n"; foreach ($s5 as $l2){ echo '<url>'."\r\n"; echo '<loc>'; echo $l2['href']; echo '</loc>'."\r\n"; echo '<lastmod>'; echo gmdate('Y-m-d\TH:i:s\Z',$l2['last-modified'][0]); echo '</lastmod>'."\r\n"; echo '</url>'."\r\n"; } } echo '</urlset>'."\r\n"; die; } function e2_pack_month_days_with_ymd_($r0,$y9,$d9){ $a9=ky('t',gmmktime(0,0,0,$y9,1,$r0),sy()); $o0=bs('start'); $p0=bs('end'); if ( $r0 .'/'. $y9 == ky('Y/n',$o0['stamp'],$o0['timezone']) ) { $q9=ky('d',$o0['stamp'],$o0['timezone']); } else { $q9=1; } if ( $r0 .'/'. $y9 == xy('Y/n',time()) ) { $l9=xy('d',time()); } else { $l9=$a9; } $z9=vs($r0,$y9); for ($r=1; $r <= $a9; ++ $r){ $n9=gmmktime(0,0,0,$y9,$r,$r0); $k9[$r] = array ( 'number' => $r, 'start-time' => array ($n9,sy()), 'href' => gmdate('Y/m/d/',$n9), 'this?' => (bool) ($r==$d9), 'real?' => $r >= $q9 and $r <= $l9, 'fruitful?' => @in_array(gmdate('d',$n9),$z9), ); } return $k9; } function ud($r0,$y9=false,$d9=false){ $o0=bs('start'); if ($o0===false){ return false; } $x9=ky('Y',$o0['stamp'],$o0['timezone']); $e9=xy('Y',time()); if ($y9===false){ return (bool) ( $r0 >= $x9 and $r0 <= $e9 ); } else { $r9=ky('n',$o0['stamp'],$o0['timezone']); $t9=xy('n',time()); if ($d9===false){ return (bool) ( $y9 >= 1 and $y9 <= 12 and ( ($r0 > $x9 and $r0 < $e9) or ($r0==$x9 and $y9 >= $r9) or ($r0==$e9 and $y9 <= $t9) ) ); } else { $j9=ky('j',$o0['stamp'],$o0['timezone']); $h9=xy('j',time()); if(1){ return (bool) ( checkdate($y9,$d9,$r0) and ( ($r0 > $x9 and $r0 < $e9) or ($r0==$x9 and $y9 > $r9) or ($r0==$x9 and $y9==$r9 and $d9 >= $j9) or ($r0==$e9 and $y9 < $t9) or ($r0==$e9 and $y9==$t9 and $d9 <= $h9) ) ); } } } } function e2__fruitful_neighbours_with_ymd_($hb,$jb=false,$tb=false){ global$_db,$_config; list ($g9,$w9)=jy($hb,$jb,$tb); $u9=SECONDS_IN_A_DAY; if ($tb===false)$u9=SECONDS_IN_A_MONTH; if ($jb===false)$u9=SECONDS_IN_A_YEAR; $i9=$o9=null; kn( "SELECT `Stamp`, `Offset`, `IsDST` ". "FROM `". $_config['db_table_prefix']. "Notes` n ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished`=1 ". "AND `Stamp` < '". ($w9-$u9) ."' ". em(k2()). "ORDER BY Stamp DESC", 'get previous fruitful neighbour with ymd' ); while ($u=mysqli_fetch_array($_db['result'],MYSQLI_ASSOC)) { list ($r0,$y9,$d9)=explode('/', ky('Y/n/j',$u['Stamp'],dy($u)) ); $p9=$hb*10000 + ($jb? ($jb*100):0) + ($tb? $tb:0); $ci=$r0*10000 + ($jb? ($y9*100):0) + ($tb? $d9:0); if ($ci < $p9){ $i9=gmmktime(0,0,0,$y9,$d9,$r0); break; } } kn( "SELECT `Stamp`, `Offset`, `IsDST` ". "FROM `". $_config['db_table_prefix']. "Notes` n ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished`=1 ". "AND `Stamp` > '". ($g9+$u9) ."' ". em(k2()). "ORDER BY Stamp", 'get next fruitful neighbour with ymd' ); while ($u=mysqli_fetch_array($_db['result'],MYSQLI_ASSOC)) { list ($r0,$y9,$d9)=explode('/', ky('Y/n/j',$u['Stamp'],dy($u)) ); $p9=$hb*10000 + ($jb? ($jb*100):0) + ($tb? $tb:0); $ci=$r0*10000 + ($jb? ($y9*100):0) + ($tb? $d9:0); if ($ci > $p9){ $o9=gmmktime(0,0,0,$y9,$d9,$r0); break; } } return [$i9,$o9]; } function e2__parameters_with_timestamp_($n4){ list ( $parameters['year'], $parameters['month'], $parameters['day'] ) = explode('/',gmdate('Y/m/d',$n4)); return$parameters; } function pd($vt,$r0=false,$y9=false){ $vi=0; $s5=array(); $x7=''; $s5=array(); $bi=array(); foreach ($vt as $t => $n2){ $l2['href'] = jv('e2m_note', array ('*note' => $n2)); $l2['time'] = array ((int)min($n2['Stamp'],time()), dy($n2)); $l2['last-modified'] = array ((int)min($n2['LastModified'],time()), dy($n2)); $l2['favourite?'] = (bool) ($n2['IsFavourite'] && $n2['IsPublished']); $te=xm($n2); $l2['draft?'] = $te==='draft'; $l2['scheduled?'] = $te==='scheduled'; $l2['public?'] = $te==='public'; $l2['hidden?'] = $te==='hidden'; if(array_key_exists('SourceNoteURL',$n2) and @$n2['SourceNoteURL']!=''){ $l2['href']=$n2['SourceNoteURL']; $l2['href-original']=$n2['SourceNoteURL']; } if ( ($r0 and $y9 and ( ((int)$r0) .'/'. ((int)$y9) == ky('Y/n',$n2['Stamp'],dy($n2)) )) or ($r0 and !$y9 and ( (int)$r0 == ky('Y',$n2['Stamp'],dy($n2)) )) or (!$r0 and !$y9) ) { array_unshift($s5,$l2); array_unshift($bi,str_replace("\n",' ',$n2['Title'])); } } if(Log::$cy)__log('Will do typography'); $yi=implode("\n",$bi); $yi=h3(htmlspecialchars($yi,ENT_NOQUOTES,HSC_ENC)); $bi=explode("\n",$yi); foreach ($s5 as $t => $xf){ $s5[$t]['title']=$bi[$t]; } return $s5; } function cs($hb){ global$_config; list ($ni,$mi)=jy($hb); kn( "SELECT `Stamp`, `Offset`, `IsDST` ". "FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished`=1 ". "AND `Stamp` BETWEEN '". $ni. "' AND '". $mi ."' ". em(k2()), 'get all notes for the year '. $hb .' to list months with notes' ); $q1=xn(); $fi=array(); foreach ($q1 as $ur){ if ( ((int)$hb) == ky('Y',$ur['Stamp'],dy($ur)) ) { $fi[] = (int)ky('n',$ur['Stamp'],dy($ur)); } } $fi=@array_unique($fi); sort($fi); return $fi; } function vs($hb,$jb){ global$_config; list ($di,$si)=jy($hb,$jb); kn( "SELECT `Stamp`, `Offset`, `IsDST` ". "FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished`=1 ". "AND `Stamp` BETWEEN '". $di ."' AND '". $si ."' ". em(k2()), 'get all notes for the month '.$jb.' of the year '. $hb .' to list days with notes' ); $q1=xn(); $ai=array(); foreach ($q1 as $ur){ if ( ((int)$hb) .'/'. ((int)$jb) == ky('Y/n',$ur['Stamp'],dy($ur)) ) { $ai[] = (int)ky('j',$ur['Stamp'],dy($ur)); } } $ai=@array_unique($ai); sort($ai); return $ai; } function bs($qi){ global$_config; $li='p1'; if (!k2()) { $li='p1v1'; } $ut=CACHES_FOLDER.$qi .'-stamp-'. $li .'.e2time.psa'; if(CACHE_EDGE_TIMEINFO and is_file($ut)) { $d=@unserialize(file_get_contents($ut)); } if(is_array($d)) { return $d; } else { $d=array ( 'stamp' => time(), 'timezone' => ay(), ); if ($qi=='start'){ kn( "SELECT `Stamp`, `Offset`, `IsDST` ". "FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished`=1 ". em(k2()). "ORDER BY `Stamp` LIMIT 1", 'get blog start timestamp' ); } elseif ($qi=='end'){ kn( "SELECT `Stamp`, `Offset`, `IsDST` ". "FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished`=1 ". em(k2()). "ORDER BY `Stamp` DESC LIMIT 1", 'get blog latest note timestamp' ); } $q1=xn(); if(count($q1)) { $d=array ( 'stamp' => $q1[0]['Stamp'], 'timezone' => dy($q1[0]), ); if(CACHE_EDGE_TIMEINFO)n3($ut,serialize($d)); return $d; } return $d; } } define('CACHE',true); define('CACHE_ALIASMAP',CACHE and true); define('CACHE_NOTES',CACHE and true); define('CACHE_NOTES_RELATED',CACHE and true); define('CACHE_NOTES_COMMENTS',CACHE and true); define('CACHE_POPULAR',CACHE and true); define('CACHE_POPULAR_WITH_TAG',CACHE and true); define('CACHE_TAGS',CACHE and true); define('CACHE_FAVTAGS',CACHE and true); define('CACHE_NOTES_COUNTS',CACHE and true); define('CACHE_EDGE_TIMEINFO',CACHE and true); define('CACHE_FRONTPAGE',CACHE and true); define('CACHE_FRONTPAGE_FEED',CACHE and true); define('CACHE_TAG',CACHE and true); define('CACHE_FULLLIST',CACHE and true); define('CACHE_DRAFTS',CACHE and true); define('CACHE_DRAFTS_ALIAS_USE_COUNTS',CACHE and true); define('CACHE_LASTMODIFIEDS',CACHE and true); define('CACHE_FILENAME_ALIASMAP',CACHES_FOLDER.'aliasmap.psa'); define('CACHE_FILENAMES_NOTES',CACHES_FOLDER.'note-*.psa'); define('CACHE_FILENAMES_NOTES_RELATED',CACHES_FOLDER.'note-*-related.psa'); define('CACHE_FILENAMES_NOTES_COMMENTS',CACHES_FOLDER.'note-*-comments.ctree.psa'); define('CACHE_FILENAMES_NOTES_COMMENTS_AUTHOR',CACHES_FOLDER.'note-*-comments-author.ctree.psa'); define('CACHE_FILENAMES_NOTES_COUNTS',CACHES_FOLDER.'notes-count-*.txt'); define('CACHE_FILENAMES_EDGE_TIMEINFO',CACHES_FOLDER.'*.e2time.psa'); define('CACHE_FILENAME_POPULAR',CACHES_FOLDER.'popular.ctree.psa'); define('CACHE_FILENAME_POPULAR_EXPIRES',CACHES_FOLDER.'popular-expires.txt'); define('CACHE_FILENAMES_POPULAR_WITH_TAG',CACHES_FOLDER.'popular-*.ctree.psa'); define('CACHE_FILENAMES_POPULAR_WITH_TAG_EXPIRES',CACHES_FOLDER.'popular-*-expires.txt'); define('CACHE_FILENAME_TAGS',CACHES_FOLDER.'tags.ctree.psa'); define('CACHE_FILENAME_TAGS_FULL',CACHES_FOLDER.'tags-full.ctree.psa'); define('CACHE_FILENAME_TAGS_AUTHOR',CACHES_FOLDER.'tags-author.ctree.psa'); define('CACHE_FILENAME_TAGS_AUTHOR_FULL',CACHES_FOLDER.'tags-author-full.ctree.psa'); define('CACHE_FILENAME_FAVTAGS',CACHES_FOLDER.'favtags.ctree.psa'); define('CACHE_FILENAME_FRONTPAGE',CACHES_FOLDER.'frontpage.ctree.psa'); define('CACHE_FILENAME_FRONTPAGE_AUTHOR',CACHES_FOLDER.'frontpage-author.ctree.psa'); define('CACHE_FILENAME_FRONTPAGE_FEED',CACHES_FOLDER.'frontpage-feed.psa'); define('CACHE_FILENAMES_TAG',CACHES_FOLDER.'tag-*.ctree.psa'); define('CACHE_FILENAMES_TAG_AUTHOR',CACHES_FOLDER.'tag-*-author.ctree.psa'); define('CACHE_FILENAME_FULLLIST',CACHES_FOLDER.'notes-list.ctree.psa'); define('CACHE_FILENAME_DRAFTS',CACHES_FOLDER.'drafts.psa'); define('CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS',CACHES_FOLDER.'drafts-auc.psa'); define('CACHE_FILENAME_LASTMODIFIEDS',CACHES_FOLDER.'last-modifieds-by-id.psa'); function e2_cache_filename_with_id_($xs,$li){ return str_replace('*',$xs,$li); } function e2_note_cache_filename_with_id_($xs){ return e2_cache_filename_with_id_($xs,CACHE_FILENAMES_NOTES); } function e2_drop_caches_for_note_($nx,$qr){ if(is_numeric($nx)) { if(Log::$cy)__log('Caches: Drop caches for note id '. $nx); @unlink(e2_note_cache_filename_with_id_($nx)); @unlink(e2_note_cache_filename_with_id_($nx .'-comments')); @unlink(e2_note_cache_filename_with_id_($nx .'-comments-author')); } else { r(CACHE_FILENAMES_NOTES); r(CACHE_FILENAMES_NOTES_COMMENTS); r(CACHE_FILENAMES_NOTES_COMMENTS_AUTHOR); } ss(); if ($qr!==false){ as_(); r(CACHE_FILENAMES_NOTES_RELATED); r(CACHE_FILENAMES_POPULAR_WITH_TAG); r(CACHE_FILENAMES_TAG); r(CACHE_FILENAMES_TAG_AUTHOR); @unlink(CACHE_FILENAME_POPULAR); @unlink(CACHE_FILENAME_FRONTPAGE); @unlink(CACHE_FILENAME_FRONTPAGE_AUTHOR); @unlink(CACHE_FILENAME_FRONTPAGE_FEED); @unlink(CACHE_FILENAME_FULLLIST); @unlink(CACHE_FILENAME_TAGS); @unlink(CACHE_FILENAME_TAGS_FULL); @unlink(CACHE_FILENAME_TAGS_AUTHOR); @unlink(CACHE_FILENAME_TAGS_AUTHOR_FULL); } if ($qr!==true){ @unlink(CACHE_FILENAME_DRAFTS); @unlink(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); } @unlink(CACHE_FILENAME_LASTMODIFIEDS); } function e2_drop_caches_for_tag_($qj){ if(is_numeric($qj)) { @unlink(e2_cache_filename_with_id_($qj,CACHE_FILENAMES_TAG)); @unlink(e2_cache_filename_with_id_($qj,CACHE_FILENAMES_TAG_AUTHOR)); } else { r(CACHE_FILENAMES_TAG); r(CACHE_FILENAMES_TAG_AUTHOR); } @unlink(CACHE_FILENAME_FAVTAGS); @unlink(CACHE_FILENAME_TAGS); @unlink(CACHE_FILENAME_TAGS_FULL); @unlink(CACHE_FILENAME_TAGS_AUTHOR); @unlink(CACHE_FILENAME_TAGS_AUTHOR_FULL); } function ds(){ if(Log::$cy)__log('Caches: Drop notes caches'); e2_drop_caches_for_note_(null,null); } function ss(){ if(Log::$cy)__log('Caches: Drop notes counts cache'); r(CACHE_FILENAMES_NOTES_COUNTS); } function as_(){ if(Log::$cy)__log('Caches: Drop egde time info cache'); r(CACHE_FILENAMES_EDGE_TIMEINFO); } function e2_drop_all_kinds_of_cache(){ if(Log::$cy)__log('Caches: Drop all kinds of caches'); r(CACHES_FOLDER.'*'); return true; } define('OLBA_SPECIAL_CHAR',"\x1"); define('OLBA_SPECIAL_SEQUENCE_LENGTH',6); function qs($zi=null){ global$_template,$_config,$settings; if ($zi===null)$zi=@$settings['template']; $ki=null; $xi=null; $ei=null; $ri=null; $ti=array(); $ji=$zi; if ($ji!==null){ while (1){ if(Log::$cy)__log('Prepare theme "'. $ji .'"'); $hi=TEMPLATES_FOLDER.$ji .'/'; if ( !is_dir($hi) or !is_file($hi .'/theme-info.php') ) { if(Log::$cy)__log('Theme "'. $ji .'" not found, using default theme "'. DEFAULT_TEMPLATE .'"'); $ji=DEFAULT_TEMPLATE; $hi=TEMPLATES_FOLDER.$ji .'/'; } array_push($ti,$hi); $gi=include $hi .'/theme-info.php'; $wi[$hi]=$gi; if(array_key_exists('max_image_width',$gi)) { if ($ki===null){ $ki=$gi['max_image_width']; } } if(array_key_exists('meta_viewport',$gi)) { if ($xi===null){ $xi=$gi['meta_viewport']; } } if(array_key_exists('supports_dark_mode',$gi)) { if ($ei===null){ $ei=$gi['supports_dark_mode']; } } if(array_key_exists('use_likely_light',$gi)) { if ($ri===null){ $ri=$gi['use_likely_light']; } } if(array_key_exists('based_on',$gi)) { $ji=$gi['based_on']; } else { break; } } } if ($ki===null){ $ki=$_config['max_image_width']; } if ($xi===null)$xi=''; if ($ei===null)$ei=false; if ($ri===null)$ri=false; $hi=SYSTEM_TEMPLATE_FOLDER; array_push($ti,$hi); $_template['name']=$zi; $_template['max_image_width']=$ki; $_template['meta_viewport']=$xi; $_template['supports_dark_mode']=$ei; $_template['use_likely_light']=$ri; $_template['stack']=$ti; $_template['infos']=$wi; }; function ls($ui){ global$content; if (!isset ($_olba_includes))$_olba_includes=0; ++ $_olba_includes; if(Log::$cy)__log('Eat "'. $ui .'"'); ob_start(); include $ui; return ob_get_clean(); } function zs($qz){ return ( OLBA_SPECIAL_CHAR. str_pad($qz,OLBA_SPECIAL_SEQUENCE_LENGTH,'0',STR_PAD_LEFT). OLBA_SPECIAL_CHAR ); } function ks($name){ static $qz=0; ba($name,'_olba_placeholders'); return zs($qz ++); } function xs($ii){ global$_olba_placeholders; foreach($_olba_placeholders as $qz => $s){ $oi=zs($qz); $pi=strpos($ii,$oi); $co=rs($s,true); if ($pi!==false){ $ii=substr_replace( $ii,$co,$pi,strlen($oi) ); } else { break; } } return $ii; } function es($vo){ if(is_dir(EXTRAS_FOLDER)) { $bo=EXTRAS_FOLDER.$vo .'.tmpl.php'; if(is_file($bo)) { return ls($bo); } } return ''; } function rs($vo){ global$_template,$_olba_includes; $bo='templates/'. $vo .'.tmpl.php'; if ($ui=e2o__usable_file_with_basename_($bo)) { return ls($ui); } else { ob_end_clean(); throw new AeOlbaTemplateMissingException('Missing: '. $bo); } } function ts(){ global$_config; if ( @$_config['raw_template_data'] or @$_config['raw_template_data_with_param'] and array_key_exists('raw',$_GET) ) { $yo='raw'; } else { $yo='main'; } return rs($yo,true); } function js($no){ ba($no .'.css','_olba_used_stylesheets'); } function hs($mo){ ba($mo .'.js','_olba_used_scripts'); } function gs($fo){ foreach (array (SYSTEM_LIBRARY_FOLDER,USER_LIBRARY_FOLDER) as $do_){ foreach(glob($do_.$fo .'/*') as $fy){ $za=pathinfo($fy,PATHINFO_EXTENSION); if ($za=='js'){ ba($fy,'_olba_used_scripts'); } if ($za=='css'){ ba($fy,'_olba_used_stylesheets'); } } } } function ws(){ global$_template,$_config,$settings; if ($so=@opendir(TEMPLATES_FOLDER)) { while (false !== ($ao=readdir($so))) { if(is_dir(TEMPLATES_FOLDER. $ao) and $ao!='.' and $ao!='..'){ if(is_file(TEMPLATES_FOLDER.$ao .'/theme-info.php')) { $qo[$ao]=TEMPLATES_FOLDER.$ao .'/'; } } } closedir($so); } $ua=array(); $lo=1000; foreach ($qo as$name => $ta){ $gi=include $ta .'theme-info.php'; $n3=@$gi['display_name']; if (!$n3) continue; if(is_array($n3)) { if(array_key_exists($settings['language'],$n3)) { $n3=$n3[$settings['language']]; } else { $n3=array_shift($n3); } } $qz=@$gi['index'] or $qz=$lo ++; $zo=@$gi['colors']; if (!$zo)$zo=array ( 'background' => 'transparent', 'headings' => 'rgba(128,128,128,.2)', 'text' => 'rgba(128,128,128,.2)', 'link' => 'rgba(128,128,128,.2)', ); $ko=(bool) ($name==$_template['name']); if ($ko){ $xo=jv('e2m_theme_preview', array ('theme' => '')); } else { $xo=jv('e2m_theme_preview', array ('theme' => $name)); } $ua[$qz] = array ( 'name' => $name, 'display-name' => $n3, 'colors' => $zo, 'current?' => $ko, 'preview-url' => $xo, 'supports-dark-mode?' => $gi['supports_dark_mode'], ); } ksort($ua); return $ua; } function us($fb){ return e2o__usable_file_with_basename_('images/'. $fb); } function is($eo){ return file_get_contents(e2o__usable_file_with_basename_('images/'. $eo .'.svg')); } function os($no){ global$_template; $ea='styles/'. $no .'.css'; $ro=array(); foreach($_template['stack'] as $hi){ if(is_file($fb=$hi.$ea)) { $ro[] = $fb; } if ( array_key_exists('reset_styles',$_template['infos'][$hi]) and in_array($no,$_template['infos'][$hi]['reset_styles']) ) { break; } } $ro=array_reverse($ro); } function ps(){ global$_olba_used_stylesheets,$_template; if (!isset ($_olba_used_stylesheets)) return; $_olba_used_stylesheets=array_unique($_olba_used_stylesheets); $to=array(); foreach($_olba_used_stylesheets as $no){ if(is_file($no)) { $to[] = $no; continue; } if(is_file($fb=USER_FOLDER .'js/'. $no)) { $to[] = $fb; } $ea='styles/'. $no; $ro=array(); foreach($_template['stack'] as $hi){ if(is_file($fb=$hi.$ea)) { $ro[] = $fb; } if ( array_key_exists('reset_styles',$_template['infos'][$hi]) and in_array($no,$_template['infos'][$hi]['reset_styles']) ) { break; } } $ro=array_reverse($ro); $to=array_merge($to,$ro); } if(E2_EDITION){ foreach($_template['stack'] as $hi){ if(array_key_exists('global_styles',$_template['infos'][$hi])) { $to[] = $_template['infos'][$hi]['global_styles']; } } } foreach ($to as $t => $xf){ $ry=stat($xf); $to[$t].='?'. $ry['mtime']; } return $to; } function ca(){ global$_olba_used_scripts; if (!isset ($_olba_used_scripts)) return; $_olba_used_scripts=array_unique($_olba_used_scripts); $jo=array(); foreach($_olba_used_scripts as $mo){ if ( substr($mo,0,7)=='http://' or substr($mo,0,8)=='https://' or substr($mo,0,2)=='//' ){ $jo[] = $mo; continue; } if(is_file($mo)) { $jo[] = $mo; continue; } if(is_file($ho=USER_FOLDER .'js/'. $mo)) { $jo[] = $ho; } $ea='js/'. $mo; if ($ho=e2o__usable_file_with_basename_($ea)) { $jo[] = $ho; } } foreach ($jo as $t => $xf){ $ry=stat($xf); if ($ry['mtime']) { $jo[$t].='?'. $ry['mtime']; } } return $jo; } function va($go){ if (!is_array($go)) return; foreach ($go as $yz){ if(substr($yz, -3)=='.js'){ hs(substr($yz,0, -3)); } if(substr($yz, -4)=='.css'){ js(substr($yz,0, -4)); } } } function ba($s,$hv){ if (!isset ($GLOBALS[$hv])) { $GLOBALS[$hv] = array ($s); } else { $GLOBALS[$hv][] = $s; } } function e2o__usable_file_with_basename_($ea){ global$_template; if (!isset ($_template))qs(); foreach($_template['stack'] as $hi){ if(is_file($fb=$hi.$ea)) { return $fb; } } return ''; } function e2m_theme_preview($parameters){ global$_lang,$_strings,$_superconfig,$_template; if (@$_superconfig['disallow_themes_preview']) { return e2_error404_mode(); } if($parameters['theme']==$_template['name']) { c(jv('e2m_theme_preview', array ('theme' => ''))); } if($parameters['theme']) { qs($parameters['theme']); } $wo=$_lang; if (!is_file($fy='system/preview/'. $wo .'.php')) { $wo=$_strings['--secondary-language']; $fy='system/preview/'. $wo .'.php'; } if (!is_file($fy='system/preview/'. $wo .'.php')) { $fy='system/preview/'. DEFAULT_LANGUAGE .'.php'; } $xq=include $fy; return $xq; } if(E2_EDITION){ function na($uo){ if(substr($uo, -1)=='_'){ $d['has-horizontal-rule?']=true; $uo=substr($uo,0, -1); } else { $d['has-horizontal-rule?']=false; } if(substr($uo, -1)=='|'){ $d['has-vertical-rule?']=true; $uo=substr($uo,0, -1); } else { $d['has-vertical-rule?']=false; } $d['has-image?'] = (strpos('WwFftG',$uo[0]) !== false); $d['has-large-image?'] = (strpos('WwFG',$uo[0]) !== false); $d['has-thumb?'] = ('t'==$uo[0]); $d['has-side-image?'] = (strpos('|FL|FR|fl|fr|','|'. substr($uo,0,2) .'|')!==false); $d['has-large-side-image?'] = (strpos('|FL|FR|','|'. substr($uo,0,2) .'|')!==false); $d['has-large-left-image?'] = ('FL'==substr($uo,0,2)); $d['has-large-right-image?'] = ('FR'==substr($uo,0,2)); $d['has-large-title?'] = (strpos('HWFG',$uo[0]) !== false); $d['has-jumbo-title?'] = ('J'==$uo[0]); $d['has-summary?'] = (substr($uo, -1)=='s'); return $d; } function ma($oo,$po){ global$_config; $cp=$_config['fitter_debug']; $vp=$_config['fitter_ignore_constraints']; $bp=$_config['fitter_ignore_default_constraints']; $yp=$_config['fitter_force_seed']; $np=$_config['fitter_force_layout']; $mp=require DEFAULTS_FOLDER. 'layouts.php'; $nu=count($oo); $fp=0; foreach ($oo as $l2) if(count($l2['images'])) ++ $fp; if ($cp){ echo '<div class="e2-error" style="background: #f0f0f0; padding: .5em 2em; margin-bottom: 1em">'; echo '<p><b>'. $nu .' notes to fit</b></p>'; echo '<div style="padding-left: 2em">'; echo '<ul>'; foreach ($oo as $dp => $l2){ echo '<li>#'.$dp.' "'.$l2['title'] .'" has '. count($l2['images']) .' image(s)<br />'; foreach ($l2['images'] as $sp => $n1){ echo '#'. $sp .'. w='. $n1['width'] .' h='. $n1['height'] .' v='. $n1['verticality'] .'. '; } echo '</li>'; } echo '</ul>'; echo '</div>'; echo '<br />'; echo '<p>'. $fp. ' of '. $nu .' notes contain images</p>'; echo '<p><b>h'. $nu .'i'. $fp. '</b> has to fit</p>'; echo '<br />'; } $ap=[]; $qp=[]; $lp=[]; $zp=0; $kp=0; foreach ($mp as $xp => $ep){ $rp=0; $tp=0; $jp=[]; if ($cp) echo '<p><b>'. $xp .'</b></p>'; foreach ($ep['areas'] as $hp => $gp){ list ($wp,$up,$ip)=$gp; if (!is_array($wp))$wp=[$wp]; foreach ($wp as $op){ $rp ++; if (na($op) ['has-image?']) { $tp ++; } } $pp=na($wp[0]); if ($pp['has-large-image?'] and !$bp){ if (empty ($ip['iv>']))$ip['iv>']=.34; if (empty ($ip['iv<=']))$ip['iv<=']=.67; } if ($pp['has-thumb?'] and !$bp){ if (empty ($ip['iv>']))$ip['iv>']=.2; if (empty ($ip['iv<=']))$ip['iv<=']=2; } if ($vp){ $ip=null; } if(is_array(@$ip)) { if ($cp) echo '<div style="padding-left: 2em">'; if ($cp) echo '<p><b>area #'. $hp .'</b> has '. count($ip) .' constraint(s), finding a matching note...</p>'; if ($cp) echo '<div style="padding-left: 2em">'; if ($cp) echo '<ul>'; $ccv=false; foreach ($oo as $dp => $l2){ if (@$jp[$l2['id']]) { if ($cp) echo '<li>note "'. $l2['title'] .'" already used once in layout '. $xp .', skipping</li>'; continue; } elseif ($pp['has-image?'] and !count($l2['images'])) { if ($cp) echo '<li>note "'. $l2['title'] .'" has no images, but the area requires them</li>'; continue; } else { if ($cp) echo '<li>note "'. $l2['title'] .'": </li>'; } if(1){ if ($cp) echo '<li>title of "'. $l2['title'] .'" has length='. mb_strlen($l2['title']) .'<br />'; $ccv=true; foreach ($ip as $vcv => $bcv){ if ($vcv[0]!=='h') continue; if ($vcv=='hl<'){ $ccv=$ccv && (mb_strlen($l2['title']) < $bcv); } elseif ($vcv=='hl>='){ $ccv=$ccv && (mb_strlen($l2['title']) >= $bcv); } else { if ($cp) echo 'unknown text constraint '. $vcv .'<br />'; } if ($cp) echo ( 'checked '. $vcv.$bcv .', '. 'pass='. (int)$ccv .'<br />' ); if (!$ccv) break; } if ($cp) echo '</li>'; if (!$ccv) continue; if ($cp) echo '<b>title of note "'. $l2['title'] .'"</b> (#'. $dp .') may be used for area #'. $hp .' of layout '. $xp .' if everything is OK with images<br />'; $jp[$l2['id']] = true; $lp[$xp][$hp] = [$dp,0]; } if (!$pp['has-image?']) { if ($cp) echo 'area accepts no images<br />'; } else { foreach ($l2['images'] as $ycv => $ncv){ if ($cp) echo '<li>'. basename($ncv['src']) .' (#'. $ycv .') of note "'. $l2['title'] .'" has '; if ($cp) echo 'width='. $ncv['width'] .', verticality='. $ncv['verticality'] .'<br />'; $ccv=true; foreach ($ip as $vcv => $bcv){ if ($vcv[0]!=='i') continue; if ($vcv=='iw>='){ $ccv=$ccv && ($ncv['width'] >= $bcv); } elseif ($vcv=='iv<='){ $ccv=$ccv && ($ncv['verticality'] <= $bcv); } elseif ($vcv=='iv>'){ $ccv=$ccv && ($ncv['verticality'] > $bcv); } else { if ($cp) echo 'unknown image constraint '. $vcv .'<br />'; } if ($cp) echo 'checked '. $vcv.$bcv .', pass='. (int)$ccv .'<br />'; if (!$ccv) break; } if ($ccv){ if ($cp) echo '<b>' .basename($ncv['src']) .' (#'. $ycv .') of note "'. $l2['title'] .'"</b> (#'. $dp .') will be used for area #'. $hp .' of layout '. $xp .'<br />'; $jp[$l2['id']] = true; $lp[$xp][$hp] = [$dp,$ycv]; } if ($cp) echo '</li>'; if ($ccv) break; } } if ($ccv) break; } if ($cp){ if (!$ccv) echo '<b>failed</b> to find fit, the layout can’t be used<br />'; echo '</div>'; echo '</ul>'; echo '</div>'; } if (!$ccv) break; } else { $ccv=true; } } if (!$ccv) continue; if ($rp > $nu) continue; if ($tp > $fp) continue; if (!$rp) continue; if (isset ($ep['promote'])) { $mcv=$ep['promote']; } else { $mcv=0; } $kp=max($kp,$tp); if(AeLayoutDiversityManager :: hasLayoutBeenUsed($xp)) { $fcv=AeLayoutDiversityManager :: getLayoutsUseRecency($xp); if ( empty ($dcv[$tp]) or $fcv < $dcv[$tp] ) { $dcv[$tp]=$fcv; $scv[$tp]=$xp; } if ($cp)$ap[$tp][] = $xp; } else { for ($r=0; $r <= $mcv; ++ $r){ $qp[$tp+$r][] = $xp; } $zp=max($zp,$tp); } } if(count($qp[$zp])) { $acv=$qp[$zp]; $qcv=0; if (isset ($yp) and is_int($yp)) { $po=$yp; } if (!empty ($acv)) { $qcv=$po % count($acv); } $xp=$acv[$qcv]; } else { $zp=$kp; $xp=$scv[$zp]; } if (isset ($np) and is_string($np)) { $xp=$np; } $ep=$mp[$xp]; if ($cp){ echo '<br />'; if(count($acv)) { if ($kp > $zp){ echo '<p>'. $kp.' images could fit if we ignored used layouts, but only '. $zp .' will</p>'; echo '<br />'; } if (!empty ($ap[$zp])) { echo '<p>Already used, but otherwise good options:</p>'; echo '<ul>'; foreach ($ap[$zp] as $lcv => $yb){ $zcv=' (recency '. ((int)AeLayoutDiversityManager :: getLayoutsUseRecency($yb)) .')'; echo '<li>#    '. $yb.$kcv.$zcv.'</li>'; } echo '</ul>'; echo '<br />'; } echo '<p>Good options:</p>'; echo '<ul>'; foreach ($acv as $xcv => $ecv){ $kcv=' (promote '. (int) @$mp[$ecv]['promote'] .')'; if ($xp===$ecv){ echo '<li>#'. $xcv .'. <b>'. $ecv .'</b>'. $kcv .' ← winner</li>'; } else { echo '<li>#'. $xcv .'. '. $ecv.$kcv .'</li>'; } } echo '</ul>'; echo '<br />'; if (isset ($yp) and is_int($yp)) echo '<p><b>Debugging with forced seed '. $yp .'</b></p>'; echo '<p>Using option '. $qcv. ' of 0...'. (count($acv)-1) .' (seed is '. $po. ')</p>'; } else { echo '<p>Not using options, just picking the most unrecently used layout ('. $scv[$kp] .')</p>'; } echo '<p><b>Layout '. $xp .'</b> wins, '. $zp .' of '. $fp .' images will fit</p>'; echo '<br />'; } AeLayoutDiversityManager :: addLayoutsUsed($xp); $rcv=[]; $tcv=[]; if (!empty ($lp[$xp])) { $rcv=$lp[$xp]; foreach ($rcv as $jcv){ list ($dp, ) = $jcv; $tcv[$dp]=true; } if ($cp){ echo '<p><b>Layout has constraints</b>, '. count($rcv) .' good fits were pre-selected</p>'; } } if ($cp){ echo '</div>'; } $hcv['debugging?'] = (bool)$cp; $hcv['grid-rows'] = @$ep['grid-rows'] or $hcv['grid-rows']=1; $hcv['areas'] = []; foreach ($ep['areas'] as $gcv => $gp){ list ($wp,$up,$ip)=$gp; if (!is_array($wp))$wp=[$wp]; $wcv=false; $ucv=false; $icv=[]; foreach ($wp as $ocv => $io){ $pcv=na($io); $pcv['index']=$ocv; $pcv['has-image?'] = ($pcv['has-image?'] and $ocv < $zp); if ( !empty ($rcv[$gcv]) and $ocv===0 ){ list ($dp,$cvv)=$rcv[$gcv]; if (!($cvv > 0))$cvv=0; $l2=$oo[$dp]; $vvv[$dp]=true; if ($cp){ $pcv['debug-selectedness']='pre-selected: note #'. $dp; if ($cvv > 0){ $pcv['debug-selectedness'].=' image #'. $cvv; } } } else { $cvv=0; foreach ($oo as $dp => $l2){ if (empty ($vvv[$dp]) and empty ($tcv[$dp])) { $l2=$oo[$dp]; $vvv[$dp]=true; break; } } if ($cp){ $pcv['debug-selectedness']='whatever: note #'. $dp; } } $pcv['note']=$l2; $pcv['note-image-index']=$cvv; if ($cp){ $pcv['debug-descriptor']=$io; } $icv[] = $pcv; $wcv=( $wcv or $pcv['has-vertical-rule?'] ); $ucv=( $ucv or $pcv['has-horizontal-rule?'] ); } $bvv=[ 'index' => $gcv, 'grid-area' => $up, 'has-vertical-rule?' => $wcv, 'has-horizontal-rule?' => $ucv, 'items' => $icv, ]; if ($cp){ $bvv['debug-descriptors-list']=implode($wp,','); } $hcv['areas'][$gcv]=$bvv; } return $hcv; } } define('SEARCH_EXTRA_PREFIX','Rose'); define('SEARCH_LIMIT',20); define('SEARCH_SNIPPETS_LIMIT',20); define('SEARCH_USE_ROSE',1); define('SEARCH_USE_MYSQL',1); define('BSI_SELECT_PORTION',10); define('BSI_GIVE_UP_TIMEOUT',10); define('BSI_UNLOCK_TIMEOUT',10); use S2\Rose\Storage\Exception\EmptyIndexException; use S2\Rose\Storage\Database\PdoStorage; use S2\Rose\Storage\Database\MysqlRepository; use S2\Rose\Stemmer\PorterStemmerEnglish; use S2\Rose\Stemmer\PorterStemmerRussian; use S2\Rose\Indexer; use S2\Rose\Entity\Indexable; use S2\Rose\Entity\Query; use S2\Rose\Entity\ExternalContent; use S2\Rose\Finder; use S2\Rose\SnippetBuilder; function e2m_found($parameters=array ()) { global$_strings,$_config,$settings,$full_blog_url; $parameters['query']=trim($parameters['query']); $bf=$parameters['query']; if (!$bf){ return array ( 'title' => $_strings['pt--search-query-empty'], 'heading' => $_strings['pt--search'], 'nothing' => $_strings['gs--search-query-empty'], ); } $yvv=false; $cj=[]; try { if (k2()) { $nvv=''; } else { $nvv='AND `IsVisible` = 1 '; } kn( "SELECT * FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". $nvv . "AND `Keyword`='". en($bf) ."'", 'get tags matching the search query' ); $ib=xn(); if (isset ($ib[0]['ID'])) { $yvv=[ 'href' => jv('e2m_tag', array ('*tag' => $ib[0])), 'name' => htmlspecialchars($bf,ENT_NOQUOTES,HSC_ENC), 'visible?' => (bool)$ib[0]['IsVisible'], ]; $cj=bf($ib[0]['ID'],4); array_unshift($cj,$yvv); } } catch (AeMySQLException $e){ kv($e,'Could not get tags matching the search query'); } $mvv=n(' ',$parameters['query']); if(SEARCH_USE_ROSE){ $fvv=new PorterStemmerRussian(new PorterStemmerEnglish()); foreach ($mvv as $t => $xf){ $mvv[$t]=$fvv -> stemWord($mvv[$t]); } } $dvv=array(); $je=k2(); if(SEARCH_USE_ROSE){ try { $p3=ea(); $svv=new Finder($p3,$fvv); $svv -> setHighlightTemplate('<mark>%s</mark>'); $avv=new Query($bf); $avv -> setInstanceId($_config['db_table_subset']); $avv -> setLimit(SEARCH_LIMIT); $resultSet=$svv -> find($avv); foreach($resultSet -> getFoundExternalIds() as $qvv){ $lvv=$qvv -> getId(); if ($lvv[0]=='n'){ $nx=substr($lvv,1); $n2=ym($nx); if (!empty ($_config['search_favourites_boost'])) { if ($n2['IsFavourite']) { $resultSet->setRelevanceRatio( $lvv, $_config['search_favourites_boost'] ); } } } } $snippetBuilder=new SnippetBuilder($fvv); $snippetBuilder -> setSnippetLineSeparator(' · '); $snippetBuilder -> attachSnippets( $resultSet, static function (array $kvv){ $q1=new ExternalContent(); foreach ( array_slice($kvv,0,SEARCH_SNIPPETS_LIMIT) as $qvv ){ $lvv=$qvv -> getId(); if ($lvv[0]=='n'){ $nx=substr($lvv,1); $n2=ym($nx); if ($n2){ $noteView=new AeNoteView($n2); $noteView -> setWantReadHref($_config['count_reads']); $noteView -> setWantControls($je and !@$_config['read_only']); $noteView -> setWantHiddenTags($je); $ax=$noteView -> getNoteCTree(); $xvv[$n2['ID']] = $ax; $q1 -> attach($qvv,$ax['text']); } } } return $q1; } ); foreach($resultSet -> getItems() as $evv){ $rvv=$evv -> getId(); if ($rvv[0]=='n'){ $nx=substr($rvv,1); $n2=ym($nx); if (!( xm($n2)==='public' or ($je and $n2['IsPublished']) )) continue; $n2['_']['_srprovider']='Rose'; $n2['_']['_rose_relevance']=$evv -> getRelevance(); $n2['_']['_rose_title']=$evv -> getHighlightedTitle($fvv); $n2['_']['_rose_snippet']=$evv -> getSnippet(); $dvv[] = $n2; } } if (@$_config['dev_rose_info']) { $tvv=print_r($resultSet -> getTrace(),true); } } catch (EmptyIndexException $e){ sa(); } catch (AeMySQLException $e){ kv($e,'Could not do something with the database while working on Rose search results'); } } if(SEARCH_USE_MYSQL){ $jvv=en(preg_quote($bf)); $hvv=( "SELECT * FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished`=1 AND MATCH (`Title`, `Text`) AGAINST ('". $jvv ."') ". em($je). "LIMIT ". SEARCH_LIMIT ); try { kn( $hvv, 'search using MySQL fulltext search' ); $q1=xn(); foreach ($q1 as $t => $n2){ $n2['_']['_srprovider']='MySQL'; $dvv[] = $n2; } } catch (AeMySQLException $e){ kv($e,'Could not search using MySQL fulltext search'); } } $gvv=array(); $s5=array(); $r=0; foreach ($dvv as $n2){ if (!in_array($n2['ID'],$gvv)) { if (!empty ($xvv[$n2['ID']])) { $l2=$xvv[$n2['ID']]; } else { $noteView=new AeNoteView($n2); $noteView -> setWantReadHref($_config['count_reads']); $noteView -> setWantControls($je and !@$_config['read_only']); $l2=$noteView -> getNoteCTree(); } $l2['search-result-provider']=$n2['_']['_srprovider']; if ($n2['_']['_srprovider']=='Rose'){ $l2['search-rose'] = [ 'relevance' => $n2['_']['_rose_relevance'], 'title' => $n2['_']['_rose_title'], 'snippet' => $n2['_']['_rose_snippet'], ]; } if (@$n2['_']['_rose_title']) { $l2['title']=$n2['_']['_rose_title']; } else { $l2['title']=ra($l2['title'],$mvv); } $l2['title']=h3($l2['title']); if (!empty ($n2['_']['_rose_snippet'])) { $l2['snippet-text']=$n2['_']['_rose_snippet']; } else { $tv=$l2['text']; $tv=preg_replace('/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/i','',$tv); $tv=preg_replace('/<style\b[^<]*(?:(?!<\/style>)<[^<]*)*<\/style>/i','',$tv); $tv=str_replace( array ( '<br>', '<br/>', '<br />', '</h1>', '</h2>', '</h3>', '</h4>', '</h5>', '</h6>', '</p>', '</pre>', '</blockquote>', '</li>', ), ' ', $tv ); $tv=strip_tags($tv); $wvv=array(); $uvv=preg_split('/[\\n\(\)\[\]]|[.:;?!](\s|$)/uis',$tv); $ivv=0; $ovv=''; foreach ($uvv as $pvv){ $pvv=trim($pvv); if (!$pvv) continue; if (!$ovv)$ovv=$pvv; $cbv=$pvv; $cbv=ra($cbv,$mvv); if ($cbv!=$pvv){ $wvv[] = ta($cbv); $ivv ++; if ($ivv > 3) break; } } if(count($wvv)) { $l2['snippet-text']=implode(' · ',$wvv); } else { $l2['snippet-text']=$ovv; } } $l2['has-highlighed-thumbs?']=false; if ($gs=@$l2['format-info']['resources-detected']) { $vbv=qb( db($gs) ); foreach ($vbv as $t => $xf){ $vbv[$t]['highlighted?'] = ( strstr($xf['original-filename'],$bf)!==false ); if ($vbv[$t]['highlighted?']) { $l2['has-highlighted-thumbs?']=true; } } $l2['thumbs']=$vbv; } $s5[] = $l2; $gvv[] = $n2['ID']; $r ++; if ($r >= SEARCH_LIMIT) break; } } $nj=count($s5); if ($nj){ $bbv=e2l_get_string( 'pt--n-posts', array ('number' => $nj) ); } else { $bbv=$_strings['pt--no-posts']; $d['nothing']=$_strings['gs--nothing-found']; } if ($r >= SEARCH_LIMIT){ $bbv=$_strings['gs--many-posts']; } if ($cj){ $d['search-related-tags']=$cj; } $d['notes']=$s5; $d['pages'] = array (); $d['title']=$bbv .' '. $_strings['gs--found-for-query'] .': '. htmlspecialchars($bf,ENT_NOQUOTES,HSC_ENC); $d['heading']=$bf; if (@$tvv){ $d['rose-debug-info']=$tvv; } return $d; } function fa($parameters){ if(Log::$cy)__log('Search form'); $bf=trim((string) @$parameters['query']); return [ 'form-action' => jv('e2s_search'), 'query' => htmlspecialchars($bf,ENT_COMPAT,HSC_ENC), ]; } function e2s_search(){ $bf=@$_POST['query']; $bf=str_replace('?',urlencode('?'),$bf); $bf=str_replace('/',' ',$bf); $bf=trim($bf); $bf=str_replace(' ','+',$bf); c(jv('e2m_found', array ('query' => $bf))); } function da(){ global$_config; $ybv=@unserialize(file_get_contents(USER_FOLDER.'indexing.psa')); if (!is_array($ybv))$ybv=array ('spent' => '?'); $nbv=$mbv=$dv='?'; try { kn( "SELECT count(*) c FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished`=1 ", 'count total published notes' ); $sy=xn(); $nbv=$sy[0]['c']; kn( "SELECT count(*) c FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsIndexed`=1 AND `IsPublished`=1 ", 'count indexed published notes' ); $sy=xn(); $mbv=$sy[0]['c']; } catch (AeMySQLException $e){ kv($e,'Could not count some notes'); return false; } $fbv=true; foreach (xa() as $dbv){ if (!cn(SEARCH_EXTRA_PREFIX. $dbv)) { $fbv=false; break; } } if (!$fbv){ $mbv=0; $ybv['spent']=false; } return [ 'indexed_count' => $mbv, 'total_count' => $nbv, 'time_spent' => $ybv['spent']? $ybv['spent']:false, ]; } function e2s_bsi_step(){ global$_db,$_config,$_strings; echo '<pre>'; if($_config['log_bsi']) { Log::$cy=true; if(Log::$cy)bv('bsi'); } if(Log::$cy)__log('BSI step'); if (!qa()) { if(Log::$cy)__log('Not indexing'); die ('Not indexing</pre>'); } $ybv=@unserialize(file_get_contents(USER_FOLDER.'indexing.psa')); if (!is_array($ybv))$ybv=array ('spent' => '?'); if ( !isset ($ybv['lock']) or $ybv['lock'] < time() - (BSI_GIVE_UP_TIMEOUT+BSI_UNLOCK_TIMEOUT) ) { if (isset ($ybv['lock'])) { if(Log::$cy)__log('Indexer: old lock is '. $ybv['lock']); echo 'Old lock is '. $ybv['lock'] .'<br />'; } else { echo 'No old lock<br />'; } $ybv['lock']=time(); if (!@n3(USER_FOLDER.'indexing.psa',serialize($ybv))) { if(Log::$cy)__log('Indexer: can’t get a new lock'); die ('Can’t get a new lock<br />'); } if(Log::$cy)__log('Indexer: new lock is '. $ybv['lock']); echo 'New lock is '. $ybv['lock'] .'<br /><br />'; try { $r=0; $sbv=0; $abv=w(); $qbv=false; $sn=false; while ($sbv < BSI_GIVE_UP_TIMEOUT){ kn( "SELECT * FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsIndexed`=0 AND `IsPublished`=1 ". "ORDER BY `Stamp` DESC ". "LIMIT ". BSI_SELECT_PORTION, 'get portion of unindexed notes for indexing' ); $sy=xn(); if(count($sy)) { ++ $r; if(Log::$cy)__log('Indexer: portion '. $r); echo 'Portion '. $r .'<br />'; foreach ($sy as $pq){ if(Log::$cy)__log('Indexer: indexing "'. $pq['Title'].'"'); echo 'Indexing: '. $pq['Title'] .'<br />'; if (la($pq)) { $pq['IsIndexed']='1'; nn('Notes',$pq); } else { $sn=true; break 2; } if($_config['broadcast_on_indexing']) { by($pq); } } $sbv=round(w()-$abv,3); if(Log::$cy)__log('Indexer: step done '. count($sy) .', spent '. $sbv .' ms so far'); echo 'Step done '. count($sy) .', spent '. $sbv .' ms so far<br /><br />'; if(Log::$cy)__log($ii); } else { $qbv=true; break; } } if ($qbv){ if(Log::$cy)__log('Indexer: indexing complete'); echo 'Indexing complete<br /><br />'; @unlink(USER_FOLDER.'indexing.psa'); } elseif ($sn){ if(Log::$cy)__log('Indexer: indexing failed'); echo 'Indexing failed<br /><br />'; } else { echo 'Time out<br />'; unset ($ybv['lock']); $ybv['done']=count($sy); if ($ybv['spent']!='?')$ybv['spent']+=$sbv; @n3(USER_FOLDER.'indexing.psa',serialize($ybv)); } } catch (AeMySQLException $e){ kv($e,'Could not index notes'); if(Log::$cy)__log('Indexer: DB unaccessible'); echo 'DB unaccessible<br />'; } } else { if(Log::$cy)__log('Indexer: locked'); echo 'Locked<br />'; } die ('</pre>'); } function e2s_bsi_drop(){ if($_SERVER['REQUEST_METHOD']=='POST'){ sa(true); } c(jv('e2m_underhood')); } function sa($lbv=false){ global$_db,$_config; try { ja(); if ($lbv)mv('Notes marked for reindexing',E2E_MESSAGE); $p3=ea(); try { $p3 -> erase(); if ($lbv)mv('Indexes erased',E2E_MESSAGE); } catch (\S2\Rose\Exception\RuntimeException $e){ kv($e,'Rose threw RuntimeException'); } aa(); } catch (AeMySQLException $e){ kv($e,'Could not mark all notes for reindexing'); } } function aa(){ $ybv=array(); @n3(USER_FOLDER.'indexing.psa',serialize($ybv)); } function qa(){ return (is_file(USER_FOLDER.'indexing.psa')); } function la($n2){ global$_config; if(Log::$cy)__log('Indexer: index noterec'); static $zbv=null; try { if ($zbv===null){ $fvv=new PorterStemmerRussian(new PorterStemmerEnglish()); $zbv=new Indexer(ea(),$fvv); } $z1=u3($n2['FormatterID'], @$n2['Text'],'full-rss'); f3( 'note',$n2, $z1['meta']['resources-detected'] ); $tv=strip_tags($z1['text-final']); $kbv=new Indexable( 'n'. $n2['ID'], $n2['Title'], $tv, $_config['db_table_subset'] ); $zbv -> index($kbv); return true; } catch (EmptyIndexException $e){ sa(); } catch (\Exception $e){ kv($e,'Could not index note'); return false; } } function za($xs){ global$_config; static $zbv=null; try { if ($zbv===null){ $fvv=new PorterStemmerRussian(new PorterStemmerEnglish()); $zbv=new Indexer(ea(),$fvv); } return $zbv -> removeById('n'. $xs,$_config['db_table_subset']); } catch (EmptyIndexException $e){ sa(); } catch (\Exception $e){ kv($e,'Could not index note'); return false; } } function ka($xbv){ $dz='S2\\Rose\\'; $ebv=__DIR__.'/library/rose/'; $e2_=strlen($dz); if(strncmp($dz,$xbv,$e2_)!==0) return; $rbv=substr($xbv,$e2_); $fy=$ebv.str_replace('\\','/',$rbv).'.php'; if(file_exists($fy)) require $fy; } function xa(){ return array ( 'TOC' => 'Contents', 'WORD' => 'Word', 'FULLTEXT_INDEX' => 'Fulltext', 'KEYWORD_INDEX' => 'Keyword', 'KEYWORD_MULTIPLE_INDEX' => 'KeywordMultiple', ); } function ea(){ global$_config,$settings; static $tbv=null; if ($tbv===null and SEARCH_USE_ROSE){ $jbv=new \PDO( 'mysql:'. 'host='. $settings['db']['server'] .';'. 'dbname='. $settings['db']['name'], $settings['db']['user_name'], i2($settings['db']['passw']) ); $ck=$jbv -> getAttribute(\PDO::ATTR_SERVER_VERSION); $hbv=version_compare($ck,'5.5.3','>=')?'utf8mb4':'utf8'; $jbv -> exec('SET NAMES '.$hbv); $jbv -> setAttribute(\PDO::ATTR_ERRMODE, \PDO::ERRMODE_EXCEPTION); $gbv=xa(); $tbv=new PdoStorage( $jbv, $_config['db_table_prefix'].SEARCH_EXTRA_PREFIX, array ( MysqlRepository::TOC => $gbv['TOC'], MysqlRepository::WORD => $gbv['WORD'], MysqlRepository::FULLTEXT_INDEX => $gbv['FULLTEXT_INDEX'], MysqlRepository::KEYWORD_INDEX => $gbv['KEYWORD_INDEX'], MysqlRepository::KEYWORD_MULTIPLE_INDEX => $gbv['KEYWORD_MULTIPLE_INDEX'], ) ); } return $tbv; } function ra($tv,$mvv){ foreach ($mvv as $c4){ if ($c4=='-') continue; $c4=preg_quote($c4,'/'); $c4=str_replace('е','[её]',$c4); $c4=str_replace('Е','[ЕЁ]',$c4); $tv=preg_replace('/(?<=^|\W)('.$c4.'[\w\p{M}]*)/iu','<mark>$1</mark>',$tv); } $tv=str_replace('</mark> <mark>',' ',$tv); $tv=str_replace('</mark> <mark>',' ',$tv); return $tv; } function ta($o2){ $wbv=mb_strtoupper(mb_substr($o2,0,1)); return $wbv.mb_substr($o2,1); } function ja(){ global$_config; kn( "UPDATE `". $_config['db_table_prefix']."Notes` ". "SET `IsIndexed`=0 ". "WHERE `SubsetID`=". $_config['db_table_subset'], 'mark all notes for reindexing' ); } function e2_check_timeout(){ static $ubv; if(is_null($ubv)) { $ibv=ini_get('max_execution_time'); if ($ibv){ $ubv=time()+$ibv-5; } else { $ubv=0; } } return ($ubv==0)?true:$ubv >= time(); } function e2_write_dump_header($fy){ $oq=( 'SET SQL_MODE="NO_AUTO_VALUE_ON_ZERO";' .PHP_EOL. 'SET AUTOCOMMIT=0;' .PHP_EOL. 'START TRANSACTION;' .PHP_EOL. "/*!40101 SET @OLD_CHARACTER_SET_CLIENT=@@CHARACTER_SET_CLIENT */;" .PHP_EOL. "/*!40101 SET @OLD_CHARACTER_SET_RESULTS=@@CHARACTER_SET_RESULTS */;" .PHP_EOL. "/*!40101 SET @OLD_COLLATION_CONNECTION=@@COLLATION_CONNECTION */;" .PHP_EOL. "/*!40014 SET @OLD_UNIQUE_CHECKS=@@UNIQUE_CHECKS, UNIQUE_CHECKS=0 */;" .PHP_EOL. "/*!40014 SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0 */;" .PHP_EOL. "/*!40101 SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE=NO_AUTO_VALUE_ON_ZERO */;" .PHP_EOL. "/*!40101 SET NAMES utf8 */;" .PHP_EOL. "/*!50503 SET NAMES utf8mb4 */;" .PHP_EOL. '' ); fwrite($fy,$oq); return true; } function e2_write_dump_footer($fy){ $obv='COMMIT;' .PHP_EOL; $obv .= "/*!40101 SET SQL_MODE=@OLD_SQL_MODE */;" .PHP_EOL ."/*!40014 SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS */;" .PHP_EOL ."/*!40014 SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS */;" .PHP_EOL ."/*!40101 SET CHARACTER_SET_RESULTS=@OLD_CHARACTER_SET_RESULTS */;".PHP_EOL ."/*!40101 SET COLLATION_CONNECTION=@OLD_COLLATION_CONNECTION */;" .PHP_EOL ."/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;" .PHP_EOL; fwrite($fy,$obv); return true; } function e2_get_table_definition($pbv,$fz){ $c3v=null; $q1=mysqli_query($pbv,"SHOW CREATE TABLE `{$fz}`"); if ($q1){ $v3v=mysqli_fetch_array($q1); $c3v=$v3v['Create Table']; } return $c3v; } function e2_write_table_definition($fy,$pbv,$fz){ $b3v=e2_get_table_definition($pbv,$fz); if(e2_check_timeout() && $b3v){ fwrite($fy,$b3v); fwrite($fy,';'); fwrite($fy,PHP_EOL.PHP_EOL); return true; } return false; } function e2_get_table_data($pbv,$fz,$yl,$limit){ $bf="SELECT * FROM `{$fz}` LIMIT {$yl}, {$limit}"; $q1=mysqli_query($pbv,$bf); if (!$q1){ return false; } $y3v=''; $n3v="INSERT INTO `{$fz}` VALUES"; while ($w4=mysqli_fetch_row($q1)) { $icv=array(); foreach($w4 as $s){ $icv[] = is_null($s)?"NULL":"'".mysqli_real_escape_string($pbv,$s)."'"; } $y3v.=$n3v.'('.join(', ',$icv).');'.PHP_EOL; } return $y3v; } function e2_table_disable_keys($fz){ return "ALTER TABLE `{$fz}` DISABLE KEYS;".PHP_EOL; } function e2_table_enable_keys($fz){ return "ALTER TABLE `{$fz}` ENABLE KEYS;".PHP_EOL; } function e2_get_total_records($pbv,$fz){ $t=mysqli_fetch_row(mysqli_query($pbv,"SELECT COUNT(*) FROM `{$fz}`")); return $t[0]; } function e2_backup_select_chuck_size_for_table_($fz){ $limit=5000; if(substr($fz, -7)==='Actions')$limit=50000; if(substr($fz, -7)==='Aliases')$limit=20000; if(substr($fz, -7)==='NotesKeywords')$limit=50000; if(Log::$cy)__log('Backup: chunk size '. (int)$limit); return$limit; } function e2_write_table_data($fy,$pbv,$fz){ $nj=e2_get_total_records($pbv,$fz); $yl=0; $limit=e2_backup_select_chuck_size_for_table_($fz); $q1=true; $m3v=20000; $f3v=30; if ($nj){ $d3v=e2_table_disable_keys($fz); fwrite($fy,$d3v); } $y3v="INSERT INTO `{$fz}` VALUES"; $s3v=$nj; while ($s3v > 0){ $bf="SELECT * FROM `{$fz}` ORDER BY `ID` LIMIT {$yl}, {$limit}"; $q1=mysqli_query($pbv,$bf); $a3v=mysqli_num_rows($q1); if (!$q1 || !e2_check_timeout()) { $q1=false; break; } $q3v=array(); $l3v=0; $z3v=0; while ($w4=mysqli_fetch_row($q1)) { if (!e2_check_timeout()) { $q1=false; break; } $a3v--; $sz=array(); foreach($w4 as $s){ $sz[] = is_null($s)?"NULL":"'".mysqli_real_escape_string($pbv,$s)."'"; } $lv='('.join(', ',$sz).')'; $l3v+=strlen($lv); $q3v[] = $lv; $z3v++; if ( ($l3v >= $m3v) || ($z3v >= $f3v) || ($a3v==0)) { $bf=$y3v.join(', ',$q3v).';'; fwrite($fy,$bf); fwrite($fy,PHP_EOL); $l3v=0; $z3v=0; $q3v=array(); } } $yl+=$limit; $s3v -= $limit; } if ($nj){ $k3v=e2_table_enable_keys($fz); fwrite($fy,$k3v); } return $q1; } function e2_backup($pbv,$q7,$x3v,$cb=array()) { $e3v=tmpfile(); e2_write_dump_header($e3v); if(Log::$cy)__log('Backup: wrote header'); $r3v=true; foreach($q7 as $fz){ if(Log::$cy)__log('Backup: table '. $fz); $t3v=e2_write_table_definition($e3v,$pbv,$fz); if(Log::$cy)__log('Backup: wrote table definition with result '. (int)$t3v); $j3v=e2_write_table_data($e3v,$pbv,$fz); if(Log::$cy)__log('Backup: wrote table data with result '. (int)$j3v); $r3v=$t3v && $j3v; if ($r3v===false){ break; } } if(Log::$cy)__log('Backup: wrote data with running == '. (int)$r3v); if ($r3v){ e2_write_dump_footer($e3v); fseek($e3v,0); $fy=fopen($x3v,'w+'); while ($r3v && ($lv=fread($e3v,1024))) { if(e2_check_timeout()) { fwrite($fy,$lv); } else { $r3v=false; } } fclose($fy); } fclose($e3v); return $r3v; } function f1($h3v,$content){ $g3v=MTMPL_FOLDER.$h3v .'.mtmpl.php'; if(is_file($g3v)) { ob_start(); include $g3v; $l8=ob_get_contents(); ob_end_clean(); return trim($l8); } } function d1(){ global$_config,$_superconfig; $w3v=$_config['mail_from']; if (@$_superconfig['mail_from']) { $w3v=$_superconfig['mail_from']; } if ($w3v[strlen($w3v)-1]=='@'){ $w3v.=$_SERVER['HTTP_HOST']; } return $w3v; } function s1($w,$subject,$xn,$u3v=''){ global$_superconfig; if (@$_superconfig['mail_debug']) { $ta='mail-debug'; $dn=basename(tempnam($ta,'m-')); $tv=( 'To:       '.$w ."\n". 'Subject:  '.$subject ."\n". $u3v ."\n". "--------------------------------------------------\n". $xn ); n3($ta .'/'. $dn,$tv); chmod($ta .'/'. $dn,E2_NEW_FILES_RIGHTS); rename($ta .'/'. $dn,$ta .'/'. $dn.'.txt'); } $subject='=?UTF-8?B?'. base64_encode($subject) .'?='; $u3v.="\r\nContent-Type: text/plain; charset=utf-8"; if(MAIL_ENABLED){ mail($w,$subject,$xn,trim($u3v)); } } function _A($tv){ global$_candy,$_protocol,$v,$c,$_current_url; if ( preg_match('/\<a href\=\"(.*?)\"[^>]*\>(.*?)\<\/a\>/si',$tv,$y3) and ( $y3[1]==='' or $y3[1]===$_current_url or $_protocol .'://'. $v.$y3[1]===$_current_url or $_protocol .'://'. $v.$c .'/'. $y3[1]===$_current_url or $_candy=='e2m_install' ) ) { return $y3[2]; } else { return $tv; } } function _AT($rq){ global$_candy,$v,$c,$_current_url; return ( $rq==='' or $rq===$_current_url or $_protocol .'://'. $v.$rq===$_current_url or $_protocol .'://'. $v.$c .'/'. $rq===$_current_url ); } function _READS($ax){ if (!empty ($ax['read-count'])) return $ax['read-count']; return AeNoteReadCountsProvider :: getReadCountForNoteID($ax['id']); } function _IMGSRC($fb){ return us($fb); } function _SVG($fb){ return is($fb); } function _COLOR($lx,$zx,$i3v,$o3v=1){ if(strlen($lx)!=3 and strlen($lx)!=6) return 'f0f'; if(strlen($zx)!=3 and strlen($zx)!=6) return 'f0f'; if(strlen($lx)==3)$lx=$lx[0].$lx[0].$lx[1].$lx[1].$lx[2].$lx[2]; if(strlen($zx)==3)$zx=$zx[0].$zx[0].$zx[1].$zx[1].$zx[2].$zx[2]; $rz=array ( $lx[0].$lx[1],$lx[2].$lx[3],$lx[4].$lx[5], $zx[0].$zx[1],$zx[2].$zx[3],$zx[4].$zx[5], ); foreach ($rz as $t => $xf){ $rz[$t]=hexdec($xf); } $ty=array ( $rz[0]+pow($i3v,$o3v) * ($rz[3]-$rz[0]), $rz[1]+pow($i3v,$o3v) * ($rz[4]-$rz[1]), $rz[2]+pow($i3v,$o3v) * ($rz[5]-$rz[2]), ); $p3v=''; foreach ($ty as $t => $xf){ $p3v.=str_pad(dechex($xf),2,'0',STR_PAD_LEFT); } return $p3v; } function _DT($jl,$cyv){ if (!$cyv) return ''; list ($n4,$ll)=$cyv; $d=$jl; $y9=ky('m',$n4,$ll); $d=str_replace('{zone}',e2__escape_all(my($ll['offset'])), $d); $d=str_replace('{month}',e2__escape_all(e2l_get_string('um--month', array ('month' => $y9))), $d); $d=str_replace('{month-short}',e2__escape_all(e2l_get_string('um--month-short', array ('month' => $y9))), $d); $d=str_replace('{month-g}',e2__escape_all(e2l_get_string('um--month-g', array ('month' => $y9))), $d); $d=ky($d,$n4,$ll); return $d; } function _AGO($cyv){ return oy($cyv[0], array ('offset' => $cyv[1]['offset'],'is_dst' => $cyv[1]['is_dst']) ); } function _NUM($tv){ return e2_decline_for_number($tv); } function _CSS($vyv){ return js($vyv); } function _CSS_HREF($vyv){ return os($vyv); } function _JS($byv){ return hs($byv); } function _LIB($fo){ return gs($fo); } function _T($vo){ echo rs($vo); } function _T_DEFER($name){ echo ks($name); } function _X($vo){ echo es($vo); } function _T_FOR($vo,$yyv=null){ global$content; if ($yyv===null)$yyv=$vo; if(array_key_exists($yyv,$content)) { echo rs($vo); } else { echo ''; } } function _FIT($oo,$po){ if(E2_EDITION){ return ma($oo,$po);; } } function _GUIDES($nyv=false){ global$_olba_guides; if(is_array($nyv))$_olba_guides=$nyv; if (!is_array($_olba_guides)) return; $myv='<div style="position: fixed; width: 100%; height: 100%; z-index: -100">'; $fyv=0; $dyv=$_olba_guides; $dyv[] = 100; foreach ($dyv as $r => $ik){ if ($ik==100) break; $fyv+=$ik; $myv.='<div style="position: fixed; left: '. $ik .'%; width: 0; height: 100%; border-left: 1px #000 dotted; opacity: .2; -webkit-opacity: .2; -moz-opacity: .2"></div>'; $syv='position: absolute; padding: 2px 3px; top: 0; font-size: 9px; background: #ccc; color: #000; font-family: "Verdana", sans-serif; opacity: .8; -webkit-opacity: .8; -moz-opacity: .8'; if ($dyv[$r+1]-$dyv[$r] < 4){ $myv.='<div style="'. $syv.'; right: '. (100-$ik) .'%; border-bottom-left-radius: .5em; -webkit-border-bottom-left-radius: .5em; -moz-border-bottom-left-radius: .5em;">'. $ik .'%</div>'; } else { $myv.='<div style="'. $syv.'; left: '. $ik .'%; border-bottom-right-radius: .5em; -webkit-border-bottom-right-radius: .5em; -moz-border-bottom-right-radius: .5em;">'. $ik .'%</div>'; } } $myv.='</div>'; $_olba_current_col=0; return $myv; } function _S($x){ global$_strings; return$_strings[$x]; } function _SHORTCUT($name){ return a($name); } function e2__escape_all($x){ $d=''; for ($r=0; $r < mb_strlen($x); ++ $r){ $d.='\\'. mb_substr($x,$r,1); } return $d; } abstract class E2GIP { protected $gip_cookie_name='gip'; protected $gip_token_cookie_name='gip_access_token'; protected $gip_token=null; abstract public function get_auth_url(); abstract public static function get_profile_url($xs,$yz); abstract public function callback(); const PHP_VERSION_VK_FEATURE=70100; public static function set_session_data($rm,$s){ if(session_status()==PHP_SESSION_NONE){ session_start(); } $_SESSION[$rm]=$s; } public static function get_session_data($rm,$ayv=false){ if(session_status()==PHP_SESSION_NONE){ session_start(); } if(!isset($_SESSION[$rm])) { return null; } $s=$_SESSION[$rm]; if($ayv){ unset($_SESSION[$rm]); } return $s; } public static function get_gips_order(){ return [ 'twitter' => 0, 'facebook' => 1, 'vk' => 2, 'telegram' => 3 ]; } public function get_config($rm){ $qyv='gips/'. $this->type .'.json'; if(is_file(USER_FOLDER.$qyv)) { $qu=@file_get_contents(USER_FOLDER.$qyv); } else { $qu=@file_get_contents(SYSTEM_FOLDER.$qyv); } if ($qu!==false){ $d=json_decode($qu,true,512,JSON_BIGINT_AS_STRING)[$rm]; if ($d) return $d; } return null; } public function get_callback_url(){ return jv('e2m_gip_sign_in_callback', array('provider' => $this->type)); } protected function get_proxy_param(){ global$settings; $wo=DEFAULT_LANGUAGE; if(array_key_exists('language',$settings))$wo=$settings['language']; return '?language='.$wo.'&type='.$this->type.'&callback_url='.urlencode($this->get_callback_url()); } public function get_gip_session_data(){ global$_config; $lyv=$this->gip_token?$this->gip_token:$_COOKIE[b($this->gip_token_cookie_name)]; kn( "SELECT * FROM `". $_config['db_table_prefix']."GIPsSessions` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `GIP` = '". $this->type ."' ". "AND `SessionToken` = '".en($lyv)."' ". "ORDER BY `ID` DESC LIMIT 1", 'get GIP session data' ); $q1=xn(); return $q1?$q1[0] : array(); } public function is_logged_in(){ if(empty($_COOKIE[b($this->gip_cookie_name)]) || !in_array($_COOKIE[b($this->gip_cookie_name)], e2_list_gips()) || $_COOKIE[b($this->gip_cookie_name)] != $this->type || empty($_COOKIE[b($this->gip_token_cookie_name)])) { return false; } $lv=$this->get_gip_session_data(); return (bool)$lv; } protected function save_session($xs,$name,$accessToken,$zyv='',$userEmail='',$userLink=''){ $n4=time(); yn( 'GIPsSessions', array ( 'GIP' => $this->type, 'GIPAuthorID' => $xs, 'AuthorName' => $name, 'AuthorEmail' => $userEmail, 'AuthorProfileLink' => $userLink, 'SessionToken' => $accessToken, 'Stamp' => $n4, ), 'INSERT', 'ON DUPLICATE KEY UPDATE '. '`SessionToken` = "'.en($accessToken).'", '. '`AuthorName` = "'.en($name).'", '. '`Stamp` = "'.$n4.'"' ); y($this->gip_cookie_name,$this->type); y($this->gip_token_cookie_name,$accessToken); if(isset($userEmail) && !empty($userEmail))y('commenter_email',$userEmail); $this->gip_token=$accessToken; } public static function get_logout_key(){ if ($kyv=self::get_session_data('logout_key')) { return $kyv; } $kyv=md5(microtime()); self::set_session_data('logout_key',$kyv); return $kyv; } public static function is_valid_logout_key($rm){ $xyv=self::get_session_data('logout_key',true); if (empty($xyv) || empty($rm) || $xyv!=$rm){ return false; } return true; } public function logout(){ global$_config; y($this->gip_cookie_name); y($this->gip_token_cookie_name); kn( "DELETE FROM `". $_config['db_table_prefix']."GIPsSessions` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `GIP` = '".$this->type."' ". "AND `SessionToken` = '" . en($_COOKIE[b($this->gip_token_cookie_name)]) . "'", 'logout' ); } public function get_avatar_width(){ return USERPIC_WIDTH; } public function get_avatar_height(){ return USERPIC_HEIGHT; } public function save_avatar($xs,$eyv){ global$_config; if (!preg_match('/^https?\:\/\/i',$eyv)) return; $eyv=str_replace("\0",'',$eyv); @j(MEDIA_ROOT_FOLDER.AVATARS_FOLDER); @chmod(MEDIA_ROOT_FOLDER.AVATARS_FOLDER,$_config['uploaded_files_mode']); $fb=MEDIA_ROOT_FOLDER.AVATARS_FOLDER.$this->type .'-'. $xs .'.jpg'; if ($ryv=file_get_contents($eyv)) { file_put_contents($fb,$ryv); } return $fb; } } function e2m_gip_sign_in($lv){ global$_config,$settings; $type=$lv['provider']; $pz=e2_get_gip_instance($type); if (!$pz)v(); header('Location: '.$pz->get_auth_url()); die; } function e2m_gip_sign_in_callback($lv){ global$_config; $type=$lv['provider']; $pz=e2_get_gip_instance($type); if (!$pz){ die ('Unknown provider'); } $tyv=$pz->callback(); echo '<script>'; if ($tyv===true){ $dg=$pz->get_gip_session_data(); $jyv=[ 'name' => $dg['AuthorName'], 'gipIcon' => _SVG($type), 'logoutUrl' => jv('e2m_gip_sign_out', array('provider' => E2GIP::get_logout_key())), ]; echo 'window.opener.oauthAuthorized('.json_encode($jyv).');'; } else { echo 'alert (\''. $tyv. '\');'; } echo 'window.close();</script>'; die; } function e2m_gip_sign_out($lv){ global$_config; $kyv=$lv['provider']; if (!E2GIP::is_valid_logout_key($kyv)) { die('invalid logout key'); } $pz=e2_get_logged_gip(); if($pz){ $pz->logout(); } v(); } function e2_list_gips(){ static $hyv=null; if(!is_null($hyv)) { return $hyv; } $gyv=SYSTEM_FOLDER. 'gips/'; $wyv=opendir($gyv); $hyv=[]; $uyv=E2GIP::get_gips_order(); $iyv=count($uyv); while (($fy=readdir($wyv)) !== false){ if(pathinfo($fy,PATHINFO_EXTENSION)!='php') continue; $oyv=pathinfo($fy,PATHINFO_FILENAME); if ($oyv=='vk'){ if(PHP_VERSION_ID < E2GIP::PHP_VERSION_VK_FEATURE) continue; } $rm=isset($uyv[$oyv]) ? $uyv[$oyv] : ++$iyv; $hyv[$rm]=$oyv; } closedir($wyv); ksort($hyv); return $hyv; } function e2_get_gip_class_name($type){ return "E2GIP".ucfirst($type); } function e2_get_gip_instance($type){ if (!in_array($type,e2_list_gips())) { return false; } $pyv=e2_get_gip_class_name($type); $pz=new $pyv; return $pz; } function e2_get_gip_auth_url($type){ return jv('e2m_gip_sign_in', array('provider' => $type)); } function e2_is_logged_in($type=''){ $cnv=!$type?e2_list_gips() : array($type); foreach($cnv as$type){ $pz=e2_get_gip_instance($type); if ($pz && $pz->is_logged_in()) { return true; } } return false; } function e2_get_logged_gip(){ foreach(e2_list_gips() as$type){ $pz=e2_get_gip_instance($type); if ($pz && $pz->is_logged_in()) { return $pz; } } return false; } function e2_get_logged_gip_name(){ foreach(e2_list_gips() as$type){ $pz=e2_get_gip_instance($type); if ($pz && $pz->is_logged_in()) { return$type; } } return false; } function e2_get_user_profile_url($type,$xs,$yz){ $pyv=e2_get_gip_class_name($type); return $pyv::get_profile_url($xs,$yz); } function e2_get_gip_session($type){ $pz=e2_get_gip_instance($type); if (!$pz || !$pz->is_logged_in()) { return false; } return $pz->get_gip_session_data(); } foreach(e2_list_gips() as $mg){ require_once 'system/gips/'.$mg.'.php'; } define('__DEV', (@$_config['dev_verbose'] > (int) !k2())); $_stopwatch=w($_stopwatch); spl_autoload_register('ka'); vv(); o(); $_strings=cv(); if(!BUILT) @include 'builder.php'; function e2(){ global$settings,$content, $_candy, $_lang, $_config, $_strings, $_candies_installer, $_candies_public, $_candies_ajax, $_candies_to_disallow_in_read_only, $_template, $_diagnose; k(); set_error_handler('dv'); set_exception_handler('ev'); header('X-Powered-By: E2 Aegea v'. E2_VERSION); header('Content-type: text/html; charset=UTF-8'); list ($candy,$parameters)=hv(); try { $content=[]; $_candy=$candy; if ( @$_config['dev_slow_ajax'] and ( in_array($candy,$_candies_ajax) ) ) { sleep(1+2 * (rand()/getrandmax())); } if (!in_array($candy,$_candies_installer)) { an(); } if (@$_config['read_only'] and in_array($candy,$_candies_to_disallow_in_read_only)) { $candy='e2m_error404'; } $vnv=(bool)k2(); $bnv=!in_array($candy,$_candies_public); if(Log::$cy)__log('User signed in? '. ($vnv? 'Yes':'No')); $_newsfeeds=[]; zd('rss',cd(),jv('e2m_rss')); zd('json',cd(),jv('e2m_json')); if(E2_EDITION){ tm(); } if(substr($candy,0,4)=='e2m_'){ qs(); } if(is_callable($candy)) { if ($bnv && !$vnv){ if(substr($candy,0,4)=='e2s_'){ c(jv('e2m_sign_in')); } else { $content['title']=$_strings['pt--sign-in']; } } else { if(Log::$cy)__log('Candy call {'); $content=call_user_func($candy,$parameters); if(Log::$cy)__log('}'); } } else { $bnv=false; $content=e2_error404_mode(); } } catch (AeMySQLException $e){ if(substr($candy,0,4)=='e2s_'){ xv($e); } else { kv($e); $parameters=array(); $content['unavailable?']=true; } } if (!is_array($content))$content=array(); $content['template']['respond-to-dark-mode?'] = ( $_template['supports_dark_mode'] and (bool) @$settings['appearance']['respond_to_dark_mode'] ); $content['template']['use-likely-light?']=$_template['use_likely_light']; if (!array_key_exists('class',$content)) { $content['class']=str_replace('_','-',str_replace('e2m_','',$candy)); } if (!array_key_exists('notes',$content))$content['notes'] = array (); if (!array_key_exists('drafts',$content))$content['drafts'] = array (); if (!array_key_exists('comments',$content))$content['comments'] = array (); if (!array_key_exists('notes-list',$content))$content['notes-list'] = array (); if (fn_()!==null){ if(Log::$cy)__log('Stuff for installed engine {'); $content['sign-in'] = [ 'done?' => $vnv, 'required?' => $bnv, 'necessary?' => $bnv && !$vnv, 'href' => jv('e2m_sign_in'), 'prompt' => $_strings['gs--need-password'], ]; $content['hrefs'] = array ( 'everything' => jv('e2m_everything'), ); if (!array_key_exists('tags',$content)) $content['tags']=nf($parameters); $content['blog']=p2(); $content['form-search']=fa($parameters); $content['engine']=wm(); $content['form-login']=o2(); if($content['form-login']===null) unset($content['form-login']); if (!array_key_exists('summary',$content)) { if (!empty ($settings['meta_description'])) { $content['summary']=strip_tags(h3(htmlspecialchars($settings['meta_description'],ENT_NOQUOTES,HSC_ENC))); } else { $content['summary']=trim(strip_tags($content['blog']['subtitle'])); } } if (k2()) { $content['admin']=im(); $content['last-modifieds-by-id']='{}'; if (@$_COOKIE[b('local_copies')]) { $content['last-modifieds-by-id'] = ( mm($_COOKIE[b('local_copies')]) ); } } if(Log::$cy)__log('}'); } $content['title']=strip_tags(h3(htmlspecialchars($content['title'],ENT_NOQUOTES,HSC_ENC))); if (@$content['heading']) { $content['heading']=strip_tags(h3(htmlspecialchars($content['heading'],ENT_NOQUOTES,HSC_ENC))); } $content['language']=$_lang; if (!@isset ($_diagnose['ok?'])) { if (@$_COOKIE[b('diagnose')] or @$_diagnose['need?']) { fv(); } } if (fn_()!==null){ if ( $settings['appearance']['show_view_counts'] ) { AeNoteReadCountsProvider :: setSQLRequestTemplateToMapIDsToReadCounts( "SELECT `ID`, `ReadCount` ". "FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ); } foreach($content['notes'] as $l2){ va($l2['format-info']['links-required']); } if(E2_EDITION){ if (!k2()) { $content['embed']['pre-head-end']=$settings['embed']['google-analytics']; $content['embed']['pre-body-end']=$settings['embed']['yandex-metrika']; } } } $content['message']=av(); $ii=ts(); $content['meta']=um( $candy, $content['notes'], $content['tag'], $content['blog'], $content['pages'] ); $content['stat']=yd(); $ii=xs($ii); if (fn_()!==null){ $ynv=false; if (fn_()!==null and qa()) { if(is_writable(USER_FOLDER.'indexing.psa')) { $ynv=true; } else { $_diagnose['need?']=true; y('diagnose','1'); } } } echo $ii; if (fn_()!==null){ if ($ynv){ if(Log::$cy)__log('Spawn BSI step'); p3(jv('e2s_bsi_step', array ())); } if(E2_EDITION){ i(); } } if (@$_config['dev_dump_ctree'])yv($content); } ?>