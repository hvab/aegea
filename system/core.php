<?php $stopwatch=microtime(); define('IGNORE_VERSION_MISMATCH',false); define('E2_VERSION',3387); define('E2_RELEASE','2.8'); define('E2_UA_STRING','E2 (v'. E2_VERSION .'; Aegea)'); define('E2_MINIMUM_PHP','5.4'); define('E2_MINIMUM_MYSQL',4.1); define('XML_AS_TEXT',0); define('BUILDER_OBFUSCATE',1); define('BUILDER_FLATTEN',1); header('X-Powered-By: E2 Aegea v'. E2_VERSION); if(version_compare(PHP_VERSION,E2_MINIMUM_PHP) < 0){ die ('PHP version must be '. E2_MINIMUM_PHP .' or later, you are running '. PHP_VERSION); } define('OUTPUT_CHARSET','UTF-8'); setlocale(LC_CTYPE,'ru_RU.UTF'); mb_internal_encoding('UTF-8'); define('HSC_ENC','UTF-8'); if(function_exists('date_default_timezone_set'))date_default_timezone_set('GMT'); error_reporting(E_ALL); define('RUN_ID',chr(rand(65,90))); define('DEV_TRACK_TIME',false); define('DEV_HOST','e2'); define('SECONDS_IN_A_MINUTE',60); define('SECONDS_IN_AN_HOUR',3600); define('SECONDS_IN_A_DAY',86400); define('SECONDS_IN_A_MONTH',2592000); define('SECONDS_IN_A_YEAR',31536000); define('YEAR_DISPLAY_THRESH',7884000); define('KILO_THRESH',768); define('BYTES_DECIMALS',1); define('FILE_READ_BUFFER',64*1024); if(defined('JSON_PRETTY_PRINT')) { define('E2_JSON_STYLE',JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE); } else { define('E2_JSON_STYLE',0); } define('NEW_FILES_RIGHTS',0777); if(is_file('multiuser')) { define('USER_MODE','multi'); } else { define('USER_MODE','single'); } if(is_file('superconfig.php')) { include 'superconfig.php'; } $_protocol=( !empty ($_SERVER['HTTPS']) && $_SERVER['HTTPS']!=='off' or $_SERVER['SERVER_PORT']==443 or isset ($_SERVER['HTTP_X_FORWARDED_PROTO']) && $_SERVER['HTTP_X_FORWARDED_PROTO']=='https' or isset ($_SERVER['HTTP_X_HTTPS']) && ($_SERVER['HTTP_X_HTTPS']) ) ? 'https':'http'; if(is_file('force-https')) { $_protocol='https'; } $wa57c1=substr( $_SERVER['PHP_SELF'],0,strpos($_SERVER['PHP_SELF'],'/index.php') ); list ($s57de2, ) = explode(':',$_SERVER['HTTP_HOST']); $full_blog_url=$_protocol. '://'. $s57de2.$wa57c1; $_user_folder_name=str_replace('/','--',$s57de2.$wa57c1); if(substr($_user_folder_name,0,4)=='www.'){ $_user_folder_name=substr($_user_folder_name,4); } if(USER_MODE=='multi'){ if (@array_key_exists($_user_folder_name,$_superconfig['rewrites'])) { $_user_folder_name=$_superconfig['rewrites'][$_user_folder_name]; } define('USER_FOLDER','users/'. $_user_folder_name .'/'); } else { define('USER_FOLDER', @$__E2_FOLDER_PREFIX__.'user/'); } if(@$_superconfig['store_files_by_users']) { define('MEDIA_ROOT_FOLDER',USER_FOLDER .'files/'); } else { define('MEDIA_ROOT_FOLDER',''); } define('EXTRAS_FOLDER',USER_FOLDER.'extras/'); define('BACKUP_FOLDER',USER_FOLDER.'backup/'); define('CACHES_FOLDER',USER_FOLDER.'caches/'); define('USER_LIBRARY_FOLDER',USER_FOLDER.'library/'); define('LOG_FILE',USER_FOLDER.'log.txt'); define('LOG_SPECIAL_FILE',USER_FOLDER.'log-special.txt'); define('PICTURES_FOLDER','pictures/'); define('THUMBNAILS_FOLDER','pictures/thumbs/'); define('AVATARS_FOLDER','pictures/avatars/'); define('AUDIO_FOLDER','audio/'); define('TEMPLATES_FOLDER','themes/'); define('SYSTEM_FOLDER','system/'); define('SCRIPTS_FOLDER','system/js/'); define('SYSTEM_LIBRARY_FOLDER','system/library/'); define('SYSTEM_TEMPLATE_FOLDER','system/theme/'); define('DEFAULT_USERPIC_FILENAME','system/theme/images/userpic.svg'); define('DEFAULT_USERPIC_PLACEHOLDER_FILENAME','system/theme/images/userpic-placeholder.svg'); define('AUDIO_ICON_IMAGE','system/theme/images/audio.svg'); define('AUDIO_ICON_WIDTH',64); define('AUDIO_ICON_HEIGHT',64); define('LANGUAGES_FOLDER','system/languages/'); define('DEFAULTS_FOLDER','system/default/'); define('MTMPL_FOLDER','system/default/mail/'); define('DEFAULT_TEMPLATE','plain'); if(substr(@$_SERVER['HTTP_ACCEPT_LANGUAGE'],0,2)=='ru'){ define('DEFAULT_LANGUAGE','ru'); } else { define('DEFAULT_LANGUAGE','en'); } @include DEFAULTS_FOLDER. 'config.php'; $_default_config=$_config; @include USER_FOLDER. 'config.php'; $_config=array_merge($_default_config,$_config); if( $_config['write_log'] and ($_config['write_log_create'] or is_file(LOG_FILE)) )define('__LOG',1); else define('__LOG',0); if (@$_config['write_log_limit'] and is_file(LOG_FILE)) { $lbc7b3=@stat(LOG_FILE); $lbc7b3=$lbc7b3['size']; if ($lbc7b3 > $_config['write_log_limit']) { @rename(LOG_FILE,LOG_FILE .'.bak'); @chmod(LOG_FILE .'.bak',NEW_FILES_RIGHTS); @file_put_contents(LOG_FILE,''); } } define('CACHE',true); define('CACHE_NOTES',CACHE and true); define('CACHE_NOTES_COMMENTS',CACHE and true); define('CACHE_POPULAR',CACHE and true); define('CACHE_HOT',CACHE and true); define('CACHE_FAVS',CACHE and true); define('CACHE_TAGS',CACHE and true); define('CACHE_FAVTAGS',CACHE and true); define('CACHE_NOTES_COUNTS',CACHE and true); define('CACHE_EDGE_TIMEINFO',CACHE and true); define('CACHE_FRONTPAGE',CACHE and true); define('CACHE_FRONTPAGE_FEED',CACHE and true); define('CACHE_FULLLIST',CACHE and true); define('CACHE_DRAFTS',CACHE and true); define('CACHE_DRAFTS_ALIAS_USE_COUNTS',CACHE and true); define('CACHE_LASTMODIFIEDS',CACHE and true); define('CACHE_FILENAMES_NOTES',CACHES_FOLDER.'note-*.ctree.psa'); define('CACHE_FILENAMES_NOTES_COMMENTS', CACHES_FOLDER.'note-*-comments.ctree.psa' ); define('CACHE_FILENAMES_NOTES_COMMENTS_AUTHOR', CACHES_FOLDER.'note-*-comments-author.ctree.psa' ); define('CACHE_FILENAMES_NOTES_COUNTS',CACHES_FOLDER.'notes-count-*.txt'); define('CACHE_FILENAMES_EDGE_TIMEINFO',CACHES_FOLDER.'*.e2time.psa'); define('CACHE_FILENAME_POPULAR',CACHES_FOLDER.'popular.ctree.psa'); define('CACHE_FILENAME_POPULAR_EXPIRES',CACHES_FOLDER.'popular-expires.txt'); define('CACHE_FILENAME_HOT',CACHES_FOLDER.'hot.ctree.psa'); define('CACHE_FILENAME_HOT_EXPIRES',CACHES_FOLDER.'hot-expires.txt'); define('CACHE_FILENAME_FAVS',CACHES_FOLDER.'favourites.ctree.psa'); define('CACHE_FILENAME_TAGS',CACHES_FOLDER.'tags.ctree.psa'); define('CACHE_FILENAME_TAGS_AUTHOR',CACHES_FOLDER.'tags-author.ctree.psa'); define('CACHE_FILENAME_FAVTAGS',CACHES_FOLDER.'favtags.ctree.psa'); define('CACHE_FILENAME_FRONTPAGE',CACHES_FOLDER.'frontpage.ctree.psa'); define('CACHE_FILENAME_FRONTPAGE_AUTHOR',CACHES_FOLDER.'frontpage-author.ctree.psa'); define('CACHE_FILENAME_FRONTPAGE_FEED',CACHES_FOLDER.'frontpage-feed.psa'); define('CACHE_FILENAME_FULLLIST',CACHES_FOLDER.'notes-list.ctree.psa'); define('CACHE_FILENAME_DRAFTS',CACHES_FOLDER.'drafts.psa'); define('CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS',CACHES_FOLDER.'drafts-auc.psa'); define('CACHE_FILENAME_LASTMODIFIEDS',CACHES_FOLDER.'last-modifieds-by-id.psa'); define('E2E_STRANGE_ERROR',10); define('E2E_USER_ERROR',20); define('E2E_PERMISSIONS_ERROR',30); define('E2E_DATABASE_ERROR',40); define('E2E_MESSAGE',100); define('E2E_DIAGNOSTICS_MESSAGE',110); define('DB_PASSWORD_RECOVER_AND_SHOW',false); define('DEFAULT_ITEMS_PER_PAGE',10); define('MAX_ITEMS_PER_PAGE',100); define('DB_OK',0); define('DB_CANNOT_FIND', -1); define('DB_CANNOT_CONNECT', -2); define('DB_QUERY_ERROR', -3); define('DB_TOO_OLD', -4); define('FP_NO_ID_OR_NEW', -1); define('FP_INSERT_ERROR', -10); define('FP_UPDATE_ERROR', -11); define('FP_EMPTY_FIELD', -20); define('FP_TITLE_OR_TEXT_EMPTY', -21); define('FP_NOT_COMMENTABLE', -30); define('FP_COMMENT_DOUBLE_POST', -101); define('FP_COMMENT_TOO_LONG', -102); define('FP_COMMENT_SPAM_SUSPECT', -103); define('NOTE_COMMENTABLE_NOW', -1); define('NOTE_COMMENTABLE_NOW_CONDITIONALLY', -2); define('ENTITY_TYPE_UNSPECIFIED',''); define('ENTITY_TYPE_NOTE','n'); define('ENTITY_TYPE_TAG','t'); define('THUMB_WIDTH',200); define('THUMB_HEIGHT',160); define('THUMB_JPG_QUALITY',90); define('SCALED_IMAGE_JPG_QUALITY',80); define('USERPIC_WIDTH',80); define('USERPIC_HEIGHT',80); define('USERPIC_JPG_QUALITY',95); define('RESOURCES_ALL',0); define('RESOURCES_LOCAL',1); $a5269f=@$_SERVER['HTTP_USER_AGENT'] or $a5269f=''; $_ios=strstr($a5269f,'iPhone') || strstr($a5269f,'iPad'); $_macintosh=strstr($a5269f,'Macintosh'); error_reporting(E_ALL); $_db_error=false; $_fp_error=false; $x589b3=true; if(strstr(__FILE__,'all.php'))$x589b3=false; function __log($y1cb25,$cc9e9a=0){ global$stopwatch,$_log_depth; @saf42(dirname(LOG_FILE) .'/'); if ($y1cb25===null){ if(function_exists('file_put_contents')) { @file_put_contents(LOG_FILE,''); @chmod(LOG_FILE,NEW_FILES_RIGHTS); } return; } $j605ac=''; $daf240=str_pad(round(w7f78()-$stopwatch,5),10,' ',STR_PAD_RIGHT); if ($y1cb25[0]=='}'){ -- $_log_depth; if($_log_depth < 0)$_log_depth=0; } $u8e13f=( RUN_ID .' '. $j605ac .''. $daf240 .' '. str_repeat(' ',$_log_depth*2). $y1cb25."\n" ); if ($y1cb25[strlen($y1cb25)-1]=='{'){ ++ $_log_depth; } $l15d61=FILE_APPEND; if(function_exists('file_put_contents')) { @file_put_contents(LOG_FILE,$u8e13f,$l15d61); @chmod(LOG_FILE,NEW_FILES_RIGHTS); if ($y1cb25[0]=='#'){ @saf42(dirname(LOG_SPECIAL_FILE). '/'); @file_put_contents(LOG_SPECIAL_FILE,$u8e13f,$l15d61); @chmod(LOG_SPECIAL_FILE,NEW_FILES_RIGHTS); } } } function e2_go_to($f56790=''){ global$_protocol,$errors,$s57de2,$wa57c1; @session_start(); $_SESSION['errors']=$errors; if(substr($f56790,0,strlen($_protocol)+3)!=$_protocol .'://'){ header('Location: '. $_protocol .'://'. $s57de2.$wa57c1 .'/'. $f56790); } else { header('Location: '. $f56790); } flush(); return true; } function s4930(){ $b469bb=$_SERVER['HTTP_REFERER']; return e2_go_to($b469bb); } function p4924($f56790){ if($_SERVER['HTTP_REFERER'])$f56790=$_SERVER['HTTP_REFERER']; return e2_go_to($f56790); } function p8c3b($xb2145=''){ $m9dd4e=substr_count($_SERVER['HTTP_HOST'],'.'); $x2cb9d=@str_repeat('_',$m9dd4e).$xb2145; return $x2cb9d; } function rc64a($xb2145,$o2063c='',$jb0b70=true){ $kcd91e=$jb0b70? (time()+3600*24*365) : (0); $mad5f8=$_SERVER['HTTP_HOST']; $be9c6c=substr_count($mad5f8,'.'); if ($be9c6c < 3)$mad5f8=str_repeat('.',3-$be9c6c).$mad5f8; $m9dd4e=setcookie(p8c3b($xb2145),$o2063c,$kcd91e,'/'); } function z163d($u183d6,$lb45cf,$dcadc8=''){ if(trim($lb45cf)!=''){ $lb45cf=explode($u183d6,$lb45cf); foreach ($lb45cf as $v865c0 => $z8ce4b)$lb45cf[$v865c0]=trim($z8ce4b); foreach ($lb45cf as $v865c0 => $z8ce4b) if ($z8ce4b=='') unset ($lb45cf[$v865c0]); $r7b774=array_unique($lb45cf); if ('sort'==$dcadc8)sort($r7b774); return $r7b774; } else return array (); } function de1e7($qcdaee,$action,$p4a202){ if (!is_array($qcdaee))$qcdaee=array(); if($action=='add'){ $qcdaee=array_unique(array_merge($qcdaee,$p4a202)); } if($action=='remove'){ unset ($qcdaee[array_search($p4a202,$qcdaee)]); } if (!is_array($qcdaee))$qcdaee=array(); return $qcdaee; } function mbb8d($lb45cf){ global$_macintosh,$_ios; if($_ios) return ''; if ($lb45cf=='submit'){ if($_macintosh){ return '&#x2303; &#x21a9;'; } else { return 'Ctrl + Enter'; } } if ($lb45cf=='livesave'){ if($_macintosh){ return '&#x2318; S'; } else { return 'Ctrl + S'; } } if ($lb45cf=='navigation'){ if($_macintosh){ return '&#x2325;'; } else { return 'Ctrl'; } } if ($lb45cf=='navigation-later'){ if($_macintosh){ return '&#x2325; &uarr;'; } else { return 'Ctrl + &uarr;'; } } if ($lb45cf=='navigation-earlier'){ if($_macintosh){ return '&#x2325; &darr;'; } else { return 'Ctrl + &darr;'; } } } function x7b91($y1cb25){ $y1cb25=str_replace('<','&lt;',$y1cb25); $y1cb25=str_replace('>','&gt;',$y1cb25); return $y1cb25; } function dc4b6($y1cb25){ $y1cb25=str_replace('"','&quot;',$y1cb25); return $y1cb25; } function cd056($o2063c,$s5d6db){ return str_replace('.',',',round($o2063c,$s5d6db)); } function e2_stripslashes_array($gf1f71){ return is_array($gf1f71)?array_map('e2_stripslashes_array',$gf1f71):stripslashes($gf1f71); } function i269a(){ if(get_magic_quotes_runtime()) { set_magic_quotes_runtime(0); } if(get_magic_quotes_gpc()) { $_GET=e2_stripslashes_array($_GET); $_POST=e2_stripslashes_array($_POST); $_COOKIE=e2_stripslashes_array($_COOKIE); $_REQUEST=e2_stripslashes_array($_REQUEST); } } function g0786($q957b5){ return sprintf('%u',ip2long($q957b5)); } function w7c85($wb1bc2){ return long2ip(sprintf('%d',$wb1bc2)); } function e2_decline_for_number($y1cb25,$wb1bc2=null){ $t2f713=$y1cb25; if ($wb1bc2===null){ $wb1bc2=substr($y1cb25,0,strpos($y1cb25,' ')); $t2f713=substr($y1cb25,strpos($y1cb25,' ')+1); } $if07c9=strpos($t2f713,'('); $s46901=strpos($t2f713,')'); if ($s46901 > $if07c9)$v22b9f=substr($t2f713,$if07c9,$s46901-$if07c9+1); $i93da6=explode(',',trim(@$v22b9f,'()')); if(count($i93da6)==2)array_unshift($i93da6,''); $pc78bd=array (2,0,1,1,1,2,2,2,2,2); if ($wb1bc2%100 > 10 and $wb1bc2%100 < 20)$ccd14c=2; else $ccd14c=$pc78bd[$wb1bc2%10]; $gef3e3=$i93da6[$ccd14c]; $y1cb25=str_replace($v22b9f,$gef3e3,$y1cb25); if(strstr($y1cb25,'(') and strstr($y1cb25,')')) { return e2_decline_for_number($y1cb25,$wb1bc2); } else { return $y1cb25; } } function fc5a6($qf2ce1){ $s87e9e=glob($qf2ce1,GLOB_NOSORT); if(is_array($s87e9e)) { foreach ($s87e9e as $v435ed){ @unlink($v435ed); } } } function t74dc($c73600){ $s87e9e=glob($c73600 .'*',GLOB_NOSORT); if(is_array($s87e9e)) { foreach ($s87e9e as $v435ed){ if(basename($v435ed)!='.' and basename($v435ed)!='..'){ if(is_dir($v435ed)) { if (t74dc($v435ed .'/')) { if (!rmdir($v435ed)) { return false; } } else { return false; } } else { @unlink($v435ed); } } } return true; } else { return false; } } function saf42($kd6fe1){ $kd6fe1=trim($kd6fe1,'/'); $kd6fe1=explode('/',$kd6fe1); $c73600=''; foreach ($kd6fe1 as $u83878){ $c73600=$c73600.$u83878; if (!is_dir($c73600)) { if (@mkdir($c73600)) { @chmod($c73600,NEW_FILES_RIGHTS); } else { return false; } } $c73600=$c73600.'/'; } return true; } function b4d36($kd6fe1){ return preg_replace('/\/([^\/]+?)\/\.\./','',$kd6fe1); } function qce9b($lb45cf){ $qcee6f=get_html_translation_table(HTML_ENTITIES); $qcee6f=array_flip($qcee6f); return strtr($lb45cf,$qcee6f); } function w7f78($a32c11=NULL){ if(NULL==$a32c11)$a32c11=microtime(); list ($k6021b,$i74459)=explode(' ',$a32c11); return ((float)$k6021b + (float)$i74459); } $stopwatch=w7f78($stopwatch); function e3aa5($m9dd4e){ global$_e2utf8__unformat_htmlentity_neasden; if($_e2utf8__unformat_htmlentity_neasden){ return $m9dd4e; } else { return '((html '. $m9dd4e .'))'; } } function medd9($ae98a6,$a98df3=false){ $x80a41=''; $ff5a8e=strlen($ae98a6); for ($v865c0=0; $v865c0 < 256; ++ $v865c0){ $bf3d13[$v865c0]=0; $q0fc3c=$v865c0; while ($q0fc3c & 0x00000080){ $q0fc3c <<= 1; ++ $bf3d13[$v865c0]; } } for ($v865c0=0xd090; $v865c0 <= 0xd0bf; $v865c0++)$t84a26[$v865c0]=chr(($v865c0 & 0x000000ff)+48); for ($v865c0=0xd180; $v865c0 <= 0xd18f; $v865c0++)$t84a26[$v865c0]=chr(($v865c0 & 0x000000ff)+112); $t84a26[0xd081]="\xa8"; $t84a26[0xd191]="\xb8"; $t84a26[0xc299]="\x99"; $t84a26[0xc2a9]="\xa9"; $t84a26[0xc2ae]="\xae"; $t84a26[0xc2ab]="\xab"; $t84a26[0xc2bb]="\xbb"; $t84a26[0xc2a0]="\xa0"; $v865c0=0; while ($v865c0 < $ff5a8e){ $bac558=$ae98a6{$v865c0}; $pc267c=ord($bac558); if ($bf3d13[$pc267c]==0){ $x80a41.=$bac558; ++ $v865c0; } elseif ($bf3d13[$pc267c]==2){ $w06214=$t84a26[($pc267c << 8) | ord($ae98a6{$v865c0+1})]; $x80a41 .= ($w06214!=null)? $w06214 : ( $a98df3? (e3aa5( iebe5(substr($ae98a6,$v865c0,2)) )) : '?' ); $v865c0+=2; } else { $gdfbc9=substr($ae98a6,$v865c0,$bf3d13[$pc267c]); if ($gdfbc9=="\xe2\x84\x96")$x80a41.="\xb9"; elseif ($gdfbc9=="\xe2\x80\x93")$x80a41.="\x96"; elseif ($gdfbc9=="\xe2\x80\x94")$x80a41.="\x97"; elseif ($gdfbc9=="\xe2\x80\x98")$x80a41.="\x91"; elseif ($gdfbc9=="\xe2\x80\x99")$x80a41.="\x92"; elseif ($gdfbc9=="\xe2\x80\x9a")$x80a41.="\x82"; elseif ($gdfbc9=="\xe2\x80\x9c")$x80a41.="\x93"; elseif ($gdfbc9=="\xe2\x80\x9d")$x80a41.="\x94"; elseif ($gdfbc9=="\xe2\x80\x9e")$x80a41.="\x84"; elseif ($gdfbc9=="\xe2\x80\xa6")$x80a41.="\x85"; elseif ($gdfbc9=="\xe2\x80\xb9")$x80a41.="\x8b"; elseif ($gdfbc9=="\xe2\x80\xba")$x80a41.="\x9b"; elseif ($gdfbc9=="\xe2\x82\xac")$x80a41.="\x88"; elseif ($gdfbc9=="\xe2\x84\xa2")$x80a41.="\x99"; else $x80a41.=$a98df3? (e3aa5( iebe5($gdfbc9) )) : '?'; $v865c0+=$bf3d13[$pc267c]; } } return $x80a41; } function iebe5($s4a8a0){ $occ411=''; $ff5a8e=strlen($s4a8a0); for ($v865c0=0; $v865c0 < $ff5a8e; ++ $v865c0){ $occ411.=preg_replace('/^1*0/','',decbin(ord($s4a8a0{$v865c0}))); } return '&#'. bindec($occ411) .';'; } function yfd97($x341be) { $x2cb9d=$x341be; $x2cb9d=preg_replace_callback('/([\x80-\xFF])/','e2_utf_from_windows_1251_char',$x2cb9d); return $x2cb9d; } function e2_utf_from_windows_1251_char($s4a8a0){ list (, $s4a8a0)=$s4a8a0; if ($s4a8a0=="\xa8") return "\xd0\x81"; if ($s4a8a0=="\xb8") return "\xd1\x91"; if ($s4a8a0 >= "\xc0" && $s4a8a0 <= "\xef") return "\xd0".chr(ord($s4a8a0)-48); if ($s4a8a0 >= "\xf0") return "\xd1".chr(ord($s4a8a0)-112); if ($s4a8a0=="\x85") return "\xe2\x80\xa6"; if ($s4a8a0=="\x96") return "\xe2\x80\x93"; if ($s4a8a0=="\x97") return "\xe2\x80\x94"; if ($s4a8a0=="\xab") return "\xc2\xab"; if ($s4a8a0=="\xbb") return "\xc2\xbb"; if ($s4a8a0=="\x91") return "\xe2\x80\x98"; if ($s4a8a0=="\x92") return "\xe2\x80\x99"; if ($s4a8a0=="\x93") return "\xe2\x80\x9c"; if ($s4a8a0=="\x94") return "\xe2\x80\x9d"; if ($s4a8a0=="\x84") return "\xe2\x80\x9e"; if ($s4a8a0=="\x99") return "\xe2\x84\xa2"; if ($s4a8a0=="\xb9") return "\xe2\x84\x96"; if ($s4a8a0=="\xa0") return "\xc2\xa0"; return '?'; }; function e2_utf8_version_of_array_($gf1f71){ foreach ($gf1f71 as $z8ce4b => $q9e366){ if (!array_key_exists($z8ce4b.'.u?',$gf1f71)) { if(is_string($gf1f71[$z8ce4b])) { $gf1f71[$z8ce4b]=yfd97($gf1f71[$z8ce4b]); } elseif(is_array($gf1f71[$z8ce4b])) { $gf1f71[$z8ce4b]=e2_utf8_version_of_array_($gf1f71[$z8ce4b]); } } } return $gf1f71; } function x869e($k6f8f5){ return mb_convert_encoding($k6f8f5[0],'HTML-ENTITIES','UTF-8'); } function nff7c($x341be,$w22019=false){ if ($w22019){ return preg_replace_callback( '/[\x{10000}-\x{fffff}]/u','e2_question_long_utf8_chars_helper',$x341be ); } else { return preg_replace('/[\x{10000}-\x{fffff}]/u','?',$x341be); } } function e2img_filename_by_processing( $rfce75,$y1c925, $f26635,$jcff96,$jd6663 ){ global$_config; if(__LOG)__log('Process image: "'. $rfce75 .'" -> "'. $y1c925 .'"'); if (!is_file($rfce75)) return false; if (!lb6c5($rfce75)) { if(__LOG)__log('Process image: SVG, no processing'); return $rfce75; } if(is_file($y1c925) and !s4f9d($rfce75,$y1c925)) { if(__LOG)__log('Process image: Already exists'); return $y1c925; } if (!extension_loaded('gd')) return false; $i7ae08=pathinfo($y1c925); if (!@saf42($i7ae08['dirname'])) { if(__LOG)__log( 'Process image: Can’t create directory <'. $i7ae08['dirname'] .'>' ); return false; } if(__LOG)__log('Process image: Detecting image type'); $type=e2img__type_of_file($rfce75); if (!$type) return false; $z94ba2='imagecreatefrom'. $type; if (!function_exists($z94ba2)) return false; if(__LOG)__log('Process image: Opening original image ('. $z94ba2 .')'); $w1ccee=call_user_func($z94ba2,$rfce75); if (!$w1ccee) return false; if ($z89918=e2img__orientation_of_file($rfce75)) { if(__LOG)__log('Process image: Needs orientation fix'); $w1ccee=e2img__res_rotate($w1ccee, -$z89918); } $l6af77=[imagesx($w1ccee),imagesy($w1ccee)]; $rb3e38=$l6af77; $yac50f=[0,0,0,0]; if ($jcff96==CROP_SQUARE){ if(__LOG)__log('Process image: Needs crop'); list ($rb3e38,$yac50f) = ( e2img__crop_metrics_to_square($rb3e38) ); } $rb3e38=e2img__fit_metrics_to_constraints( $rb3e38,$f26635 ); if ( $z89918===0 and $rb3e38===$l6af77 ){ if(__LOG)__log('Process image: No changes necessary, leaving original'); return $rfce75; } if(__LOG)__log(var_export($rb3e38,true)); if(__LOG)__log(var_export($yac50f,true)); $q26ea7=e2img__create_copy_resampled( $w1ccee, $rb3e38, $yac50f, $type ); imagejpeg($q26ea7,$y1c925,$jd6663); if (!is_file($y1c925)) { if(__LOG)__log('Process image: File not created by imagejpeg'); return false; } chmod($y1c925,$_config['uploaded_files_mode']); if(__LOG)__log('Process image: Done'); return $y1c925; } function e2img__create_copy_resampled( $w1ccee,$rb3e38,$yac50f,$type ){ list ($id4d55,$s455ce)=$rb3e38; list ($o98453,$x2aaef,$mb40c7,$a0a71b)=$yac50f; $q26ea7=imagecreatetruecolor($id4d55,$s455ce); if($type==='png'){ imagefill($q26ea7,0,0,imagecolorallocate($q26ea7,255,255,255)); imagealphablending($q26ea7,true); } $j2097d=imagesx($w1ccee); $i97874=imagesy($w1ccee); imagecopyresampled( $q26ea7, $w1ccee, 0,0, 0+$o98453,0+$x2aaef, $id4d55,$s455ce, $j2097d-$mb40c7,$i97874-$a0a71b ); imageinterlace($q26ea7,1); return $q26ea7; } function e2img__type_of_file($v435ed){ $ycaf9b=@getimagesize($v435ed); if (!$ycaf9b or $ycaf9b[2] > 3) return false; if ($ycaf9b[2]==IMAGETYPE_GIF) return 'gif'; if ($ycaf9b[2]==IMAGETYPE_JPEG) return 'jpeg'; if ($ycaf9b[2]==IMAGETYPE_PNG) return 'png'; return false; } function e2img__orientation_of_file($v435ed){ if (!function_exists('exif_read_data')) return 0; if (($d9beff=@exif_read_data($v435ed)) === false) return 0; if ($d9beff['Orientation']==3) return -180; if ($d9beff['Orientation']==6) return -270; if ($d9beff['Orientation']==8) return -90; return 0; } function e2img__res_rotate($w9b207,$z89918){ $x65370=imagerotate($w9b207,$z89918,0); if ($x65370!==false){ imagedestroy($w9b207); $w9b207=$x65370; } return $w9b207; } function e2img__fit_metrics_to_constraints( $z0b73d,$f26635 ){ if ($f26635===false)$f26635=[0,0]; list ($reaae2,$bb435e)=$z0b73d; list ($udb99b,$m4278c)=$f26635; $k8e7bb=[1]; if ($udb99b)$k8e7bb[] = $udb99b/$reaae2; if ($m4278c)$k8e7bb[] = $m4278c/$bb435e; $e0cb47=min($k8e7bb); if ($e0cb47 < 1){ $reaae2=round($reaae2*$e0cb47); $bb435e=round($bb435e*$e0cb47); } return [$reaae2,$bb435e]; } function e2img__crop_metrics_to_square($z0b73d){ $e81188=$ob2835=$s4505c=$me6dec=0; list ($reaae2,$bb435e)=$z0b73d; if ($reaae2 > $bb435e){ $s4505c=$reaae2-$bb435e; $e81188=floor($s4505c/2); $bb435e=$reaae2; } elseif ($reaae2 < $bb435e){ $me6dec=$bb435e-$reaae2; $ob2835=floor($s4505c/2); $reaae2=$bb435e; } $yac50f=[$e81188,$ob2835,$s4505c,$me6dec]; $e27e5c=[$reaae2,$bb435e]; return [$e27e5c,$yac50f]; } $_folders_written=array ( '.', USER_FOLDER, CACHES_FOLDER, BACKUP_FOLDER, MEDIA_ROOT_FOLDER.PICTURES_FOLDER, MEDIA_ROOT_FOLDER.THUMBNAILS_FOLDER, MEDIA_ROOT_FOLDER.PICTURES_FOLDER .'remote/', MEDIA_ROOT_FOLDER.THUMBNAILS_FOLDER .'remote/', MEDIA_ROOT_FOLDER.AUDIO_FOLDER, MEDIA_ROOT_FOLDER.AVATARS_FOLDER, ); $_files_written=array ( USER_FOLDER.'password-hash.psa', USER_FOLDER.'password-wait.psa', USER_FOLDER.'last-comment.psa', USER_FOLDER.'new-uploads.psa', USER_FOLDER.'settings.json', USER_FOLDER.'indexing.psa', USER_FOLDER.'auth.psa', USER_FOLDER.'log.txt', ); define('CROP_NONE',0); define('CROP_SQUARE',1); define('PROVIDE_DATA_SPAWN',10); define('PROVIDE_DATA_NOW',20); function qea70(){ global$_folders_written,$_files_written; clearstatcache(); $o10ae9=array(); foreach($_folders_written as $m8fa14){ if(is_dir($m8fa14) and !is_writable($m8fa14)) { $o10ae9[] = $m8fa14; } } foreach($_files_written as $m8fa14){ if(is_file($m8fa14) and !is_writable($m8fa14)) { $o10ae9[] = $m8fa14; } } return $o10ae9; } function x6e52($o8c7dd,$lb45cf){ @saf42(dirname($o8c7dd)); if (!@file_put_contents($o8c7dd,$lb45cf,LOCK_EX)) { return false; } @chmod($o8c7dd,NEW_FILES_RIGHTS); return true; } function r1cae($s954eb){ if(preg_match('/^https?\:\/\//iu',$s954eb)) { $t6efa1=$s954eb; $t6efa1=preg_replace('/^https?\:\/\//iu','',$t6efa1); $t6efa1=str_replace('/','--',$t6efa1); $t6efa1=MEDIA_ROOT_FOLDER.THUMBNAILS_FOLDER.$t6efa1; } else { $t6efa1=MEDIA_ROOT_FOLDER.THUMBNAILS_FOLDER.$s954eb; } $t6efa1=e2files__add_ext_prefix($t6efa1,'thumb@2x'); return $t6efa1; } function s6e61($s954eb){ if(preg_match('/^https?\:\/\//iu',$s954eb)) { $naf721=$s954eb; } else { $naf721=MEDIA_ROOT_FOLDER.PICTURES_FOLDER.$s954eb; } $t6efa1=e2img_filename_by_processing( $naf721, r1cae($s954eb), [THUMB_WIDTH,THUMB_HEIGHT], CROP_NONE, THUMB_JPG_QUALITY ); if ($t6efa1===false) return false; $ff5a8e=strlen(MEDIA_ROOT_FOLDER); if(substr($t6efa1,0,$ff5a8e)==MEDIA_ROOT_FOLDER){ $a85133=substr($t6efa1,$ff5a8e); } return $a85133; } function n30f2($naf721){ $k8743c=pathinfo($naf721); $pabf77=$k8743c['extension']; return (in_array(strtolower($pabf77), array ('jpg','jpeg','gif','png','svg'))); } function lb6c5($naf721){ $k8743c=pathinfo($naf721); $pabf77=$k8743c['extension']; return (in_array(strtolower($pabf77), array ('jpg','jpeg','gif','png'))); } function lef67($naf721){ $k8743c=pathinfo($naf721); $pabf77=$k8743c['extension']; if ($pabf77=='png') return IMAGETYPE_PNG; if ($pabf77=='gif') return IMAGETYPE_GIF; if ($pabf77=='jpg' or $pabf77=='jpeg') return IMAGETYPE_JPEG; } function h19a4($v435ed){ if (lb6c5($v435ed)) { list ($reaae2,$bb435e)=getimagesize($v435ed); } else { $ae2da9=simplexml_load_string(file_get_contents($v435ed)); if ($ae2da9){ $ud0a5e=$ae2da9->attributes(); list ($reaae2,$bb435e) = array ((string)$ud0a5e -> width, (string)$ud0a5e -> height); } else { return false; } } if(substr($v435ed,strrpos($v435ed,'.')-3,3)=='@2x'){ $reaae2=(int)floor($reaae2/2); $bb435e=(int)floor($bb435e/2); } return array ($reaae2,$bb435e); } function e2s_retrieve($parameters){ $r36cd3=urldecode(base64_decode($parameters['url'])); if(__LOG)__log('Retrieve: '. $r36cd3); z1066($r36cd3,PROVIDE_DATA_NOW); } function tbcd0($f447b7){ global$full_blog_url; $m78f08=parse_url($f447b7); if (isset ($m78f08['scheme'])) { if (n30f2($m78f08['path'])) { return array ( 'type' => 'remote-image', 'is-local?' => false, ); } elseif ($m78f08['host']=='www.youtube.com'){ $sb80bb=basename($m78f08['path']); $o15ba8='remote/youtube-'. $sb80bb .'-cover.jpg'; return array ( 'type' => 'online-video', 'is-local?' => false, 'video-service' => 'youtube', 'video-id' => $sb80bb, 'local-cover-name' => $o15ba8, 'local-cover-href' => $full_blog_url .'/'. PICTURES_FOLDER.$o15ba8, 'local-full-filename' => MEDIA_ROOT_FOLDER.PICTURES_FOLDER.$o15ba8, 'local-full-failname' => MEDIA_ROOT_FOLDER.PICTURES_FOLDER.$o15ba8.'.failed', ); } elseif ($m78f08['host']=='player.vimeo.com'){ $sb80bb=basename($m78f08['path']); $o15ba8='remote/vimeo-'. $sb80bb .'-cover.jpg'; return array ( 'type' => 'online-video', 'is-local?' => false, 'video-service' => 'vimeo', 'video-id' => $sb80bb, 'local-cover-name' => $o15ba8, 'local-cover-href' => $full_blog_url .'/'. PICTURES_FOLDER.$o15ba8, 'local-full-filename' => MEDIA_ROOT_FOLDER.PICTURES_FOLDER.$o15ba8, 'local-full-failname' => MEDIA_ROOT_FOLDER.PICTURES_FOLDER.$o15ba8.'.failed', ); } } else { if (n30f2($m78f08['path'])) { return array ( 'type' => 'local-image', 'is-local?' => true, 'local-href' => $full_blog_url .'/'. PICTURES_FOLDER.$m78f08['path'], 'local-full-filename' => MEDIA_ROOT_FOLDER.PICTURES_FOLDER.$m78f08['path'] ); } else { return array ( 'type' => 'local-non-image', 'is-local?' => true, ); } } } function z1066($f447b7,$tdb88a){ $v1c149=tbcd0($f447b7); if ($v1c149['type']=='remote-image'){ } elseif ($v1c149['type']=='online-video'){ if(is_file($v1c149['local-full-filename'])) { if(__LOG)__log('Already exists: '. $v1c149['local-full-filename']); } elseif(is_file($v1c149['local-full-failname'])) { if(__LOG)__log('Already tried and failed: '. $v1c149['local-full-filename']); } else { if(__LOG)__log($f447b7.' is missing a cover, retrieving'); if ($tdb88a==PROVIDE_DATA_SPAWN){ tcc38(v83c8('e2s_retrieve', array ( 'url' => urlencode(base64_encode($f447b7)), ))); } if ($tdb88a==PROVIDE_DATA_NOW){ if ($v1c149['video-service']=='youtube') { $l5f89d=array ( 'maxresdefault','hqdefault','mqdefault','sddefault','default' ); foreach ($l5f89d as $ed7d16){ $n572d4='http://img.youtube.com/vi/'. $v1c149['video-id'] .'/'. $ed7d16 .'.jpg'; if(__LOG)__log('Getting '.$n572d4 .' as '. $v1c149['local-full-filename']); $p6c43d=file_get_contents($n572d4); if ($p6c43d!==false) break; } } if ($v1c149['video-service']=='vimeo') { $dc4a72=unserialize( file_get_contents('http://vimeo.com/api/v2/video/'. $v1c149['video-id'] .'.php') ); if (isset ($dc4a72[0]['thumbnail_large'])) { $p6c43d=file_get_contents($dc4a72[0]['thumbnail_large']); } } if ($p6c43d!==false){ x6e52($v1c149['local-full-filename'],$p6c43d); } else { x6e52($v1c149['local-full-failname'],''); } } } if ($tdb88a==PROVIDE_DATA_NOW){ if(is_file($v1c149['local-full-filename'])) { s6e61($v1c149['local-cover-name']); } } } elseif ($v1c149['type']=='local-image'){ if(__LOG)__log($f447b7.' is a local image'); s6e61($f447b7); } elseif ($v1c149['type']=='local-non-image'){ if(__LOG)__log($f447b7.' is a local non-image'); } } function j6be4($o10ae9){ if (!is_array($o10ae9)) return; if(__LOG)__log('Provide data for resources {'); foreach ($o10ae9 as $f447b7){ z1066($f447b7,PROVIDE_DATA_SPAWN); } if(__LOG)__log('}'); } function zf898($o89111,$ldffc4,$ce449c){ $o5128f=efb75($o89111,$ldffc4); $o55b55=array_merge($o5128f,$ce449c); $o55b55=array_reverse($o55b55); $o55b55=array_unique($o55b55); $o55b55=array_reverse($o55b55); return p2e82($o55b55,RESOURCES_LOCAL); } function ifc4d($xd430b,$e2bfe4){ $c84841=array(); if(is_array($e2bfe4['meta']['resources-detected'])) { $ce449c=$e2bfe4['meta']['resources-detected']; $c84841=xdc5a($ce449c); } $e16137=@unserialize( $xd430b['Uploads'] ) or $e16137=array(); $p08204=array_diff($c84841,$e16137); if(count($p08204) > 0){ c4ae9('note',$xd430b['ID'],'add',$p08204); } return $p08204; } function xdc5a($dd7f81){ $o10ae9=array(); foreach ($dd7f81 as $v1993e){ $v1c149=tbcd0($v1993e); if ($v1c149['is-local?'])$o10ae9[] = $v1993e; } return $o10ae9; } function p2e82($o55b55,$i8b7af=RESOURCES_ALL){ global$full_blog_url; $hef067=array(); $c59b51=array(); if (!is_array($o55b55)) return $c59b51; j6be4($o55b55); foreach ($o55b55 as $y96ab4){ $v1c149=tbcd0($y96ab4); if ($i8b7af==RESOURCES_LOCAL and !$v1c149['is-local?']) continue; if ($v1c149['type']=='remote-image'){ } elseif ($v1c149['type']=='online-video'){ if ($r742c4=s6e61($v1c149['local-cover-name'])) { $size=h19a4(MEDIA_ROOT_FOLDER.$r742c4); list ($reaae2,$bb435e)=$size; if (!in_array($y96ab4,$hef067)) { $hef067[] = $y96ab4; $c59b51[] = array ( 'original-filename' => $y96ab4, 'href' => $full_blog_url .'/'. $r742c4, 'width' => $reaae2, 'height' => $bb435e, ); } } } elseif ($v1c149['type']=='local-image'){ if ($r742c4=s6e61($y96ab4)) { $size=h19a4(MEDIA_ROOT_FOLDER.$r742c4); list ($reaae2,$bb435e)=$size; if (!$reaae2)$reaae2=THUMB_WIDTH/2; if (!$bb435e)$bb435e=THUMB_HEIGHT/2; if (!in_array($y96ab4,$hef067)) { $hef067[] = $y96ab4; $c59b51[] = array ( 'original-filename' => $y96ab4, 'href' => $full_blog_url .'/'. $r742c4, 'width' => $reaae2, 'height' => $bb435e, ); } } } elseif ($v1c149['type']=='local-non-image'){ if(is_file(MEDIA_ROOT_FOLDER.AUDIO_FOLDER.$y96ab4)) { if (!in_array($y96ab4,$hef067)) { $hef067[] = $y96ab4; $c59b51[] = array ( 'original-filename' => $y96ab4, 'href' => $full_blog_url .'/'. AUDIO_ICON_IMAGE, 'width' => AUDIO_ICON_WIDTH, 'height' => AUDIO_ICON_HEIGHT, ); } } } } return $c59b51; } function hdbcc($o89111,$ldffc4,$o55b55){ global$full_blog_url; $o10ae9=array(); if(is_array($o55b55)) { $o10ae9=e2files__list_og_images_for_resources_($o55b55); } $o5128f=efb75($o89111,$ldffc4); if(is_array($o5128f)) { foreach ($o5128f as $z8ce4b => $q9e366){ if(is_file(MEDIA_ROOT_FOLDER.PICTURES_FOLDER.$q9e366)) { $o5128f[$z8ce4b]=$full_blog_url .'/'. PICTURES_FOLDER.$q9e366; } else { unset ($o5128f[$z8ce4b]); } } $o10ae9=array_merge($o5128f,$o10ae9); } $o10ae9=array_reverse($o10ae9); $o10ae9=array_unique($o10ae9); $o10ae9=array_reverse($o10ae9); return $o10ae9; } function e2files__list_og_images_for_resources_($o55b55){ $c59b51=array(); j6be4($o55b55); foreach ($o55b55 as $y96ab4){ $v1c149=tbcd0($y96ab4); if ($v1c149['type']=='remote-image'){ } elseif ($v1c149['type']=='online-video'){ if(is_file($v1c149['local-full-filename'])) { $c59b51[] = $v1c149['local-cover-href']; } } elseif ($v1c149['type']=='local-image'){ if(is_file($v1c149['local-full-filename'])) { $c59b51[] = $v1c149['local-href']; } } elseif ($v1c149['type']=='local-non-image'){ } } return $c59b51; } function m9c0a($ub0689,$c12e09){ if(preg_match('//u',$ub0689))$ub0689=medd9($ub0689,false); if ($c12e09=='image'){ $a85114=MEDIA_ROOT_FOLDER.PICTURES_FOLDER; } elseif ($c12e09=='audio'){ $a85114=MEDIA_ROOT_FOLDER.AUDIO_FOLDER; } else { return false; } $s96704=''; for ($v865c0=0; $v865c0 < strlen($ub0689); $v865c0++) { if ($ub0689[$v865c0]=='?'){ $s96704.=''; } elseif ($ub0689[$v865c0]==' '){ $s96704.='-'; } elseif(ord($ub0689[$v865c0]) <= 127){ $s96704.=$ub0689[$v865c0]; } } if ($s96704=='')$s96704=$c12e09; if ($s96704[0]=='.')$s96704=$c12e09.$s96704; return $s96704; } function df0fb($a76ee3){ global$_config; if(__LOG)__log('Count references for upload <'. $a76ee3 .'>'); $t7cd94=$rbe270=$c6ae44=array(); if(is_file(USER_FOLDER.'new-uploads.psa')) { $t7cd94=@unserialize(file_get_contents(USER_FOLDER.'new-uploads.psa')); if (!is_array($t7cd94))$t7cd94=array(); } $a5a976='%'. str_replace('%','#%',$a76ee3) .'%'; if (s0738( "SELECT `ID`, `Text`, `FormatterID`, `Uploads` ". "FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `Text` LIKE '". $a5a976 ."' ESCAPE '#' ". "OR `Uploads` LIKE '". $a5a976 ."' ESCAPE '#'" )) { $result=z0d6b(); $rbe270=@unserialize($result[0]['Uploads']); if (!is_array($rbe270)) { foreach($result as $b39a37){ $e2bfe4=q154e( $b39a37['FormatterID'], @$b39a37['Text'],'full-rss' ); $rbe270=ifc4d($b39a37,$e2bfe4); } } } if (s0738( "SELECT `ID`, `Description`, `Uploads` ". "FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `Description` LIKE '". $a5a976 ."' ESCAPE '#' ". "WHERE `Uploads` LIKE '". $a5a976 ."' ESCAPE '#'" )) { $result=z0d6b(); $c6ae44=@unserialize($result[0]['Uploads']); if (!is_array($c6ae44)) { foreach($result as $sb19ad){ $e2bfe4=wb7f1( @$sb19ad['Description'],'full-rss' ); $c6ae44=ifc4d($sb19ad,$e2bfe4); } } } $o5128f=array_merge($t7cd94,$rbe270,$c6ae44); if(__LOG)__log('References found in relevant entries: '. var_export($o5128f,true)); if(in_array($a76ee3,$o5128f)) { if(__LOG)__log('Still referenced, do not delete file'); return true; } return false; } function efb75($qf5e63,$sb80bb){ global$_config; if ($qf5e63=='note' and $sb80bb=='new'){ if(is_file(USER_FOLDER.'new-uploads.psa')) { $o5128f=@unserialize(file_get_contents(USER_FOLDER.'new-uploads.psa')); } } elseif ($qf5e63=='note'){ if (s0738( "SELECT `Uploads` FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `ID`=". $sb80bb )) { $result=z0d6b(); $o5128f=@unserialize($result[0]['Uploads']); } } elseif ($qf5e63=='tag'){ if (s0738( "SELECT `Uploads` FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `ID`=". $sb80bb )) { $result=z0d6b(); $o5128f=@unserialize($result[0]['Uploads']); } } if (!is_array($o5128f))$o5128f=array(); return $o5128f; } function fbc90($qf5e63,$sb80bb,$o5128f){ global$_config; if ($qf5e63=='note' and $sb80bb=='new'){ if (!@x6e52(USER_FOLDER.'new-uploads.psa',serialize($o5128f))) { p8a40('ERROR',E2E_PERMISSIONS_ERROR); } } elseif ($qf5e63=='note'){ s0738( "UPDATE `". $_config['db_table_prefix']."Notes` ". "SET `Uploads`='". serialize($o5128f) ."' ". "WHERE `ID`=". $sb80bb ); } elseif ($qf5e63=='tag'){ s0738( "UPDATE `". $_config['db_table_prefix']."Keywords` ". "SET `Uploads`='". serialize($o5128f) ."' ". "WHERE `ID`=". $sb80bb ); } else { return false; } if (!is_array($o5128f))$o5128f=array(); return $o5128f; } function c4ae9($qf5e63,$sb80bb,$action,$p4a202){ global$_config; $o5128f=array(); if(__LOG)__log('Register upload: <'. $qf5e63.', '. $sb80bb.', '. $action.', '. $p4a202 .'>'); $o5128f=efb75($qf5e63,$sb80bb); $o5128f=de1e7($o5128f,$action,$p4a202); fbc90($qf5e63,$sb80bb,$o5128f); } function l2f83($g4b27b,$ade17f,$ce449c){ $e16137=@unserialize($ade17f['Uploads']) or $e16137=array(); $d28a47=xdc5a($ce449c); $o5128f=de1e7($e16137,'add',$d28a47); $o5128f=serialize($o5128f); if ($o5128f!=$ade17f['Uploads']) { $ade17f['Uploads']=$o5128f; paa79($g4b27b,$ade17f); } } function e2j_file_upload($parameters=array ()) { global$_config,$full_blog_url; @saf42(MEDIA_ROOT_FOLDER.PICTURES_FOLDER); @chmod(MEDIA_ROOT_FOLDER.PICTURES_FOLDER,$_config['uploaded_files_mode']); @saf42(MEDIA_ROOT_FOLDER.AUDIO_FOLDER); @chmod(MEDIA_ROOT_FOLDER.AUDIO_FOLDER,$_config['uploaded_files_mode']); $hd1fc8=array(); $hd1fc8['success']=0; if(count($_FILES) > 0){ foreach($_FILES as $o8c7dd){ if (!$o8c7dd['error']) { if(__LOG)__log('Ajax file upload: <'. $o8c7dd['name'].'>'); $hd1fc8['file-kind']='image'; $a85114=MEDIA_ROOT_FOLDER.PICTURES_FOLDER; if(substr($o8c7dd['name'],strrpos($o8c7dd['name'],'.')) == '.mp3'){ $hd1fc8['file-kind']='audio'; $a85114=MEDIA_ROOT_FOLDER.AUDIO_FOLDER; } $t77dce=( array_key_exists('overwrite',$_GET) and is_file($a85114.$o8c7dd['name']) ); $u6f4b5=false; $hd1fc8['overwrite'] = (int)$t77dce; if(__LOG)__log('Ajax file upload: Overwrite is resolved to <'. (int)$t77dce.'>'); $s96704=m9c0a($o8c7dd['name'],$hd1fc8['file-kind']); if(__LOG)__log('Ajax file upload: Safe name is <'. $s96704.'>'); if(is_file($a85114.$s96704)) { if(file_get_contents($a85114.$s96704)==file_get_contents($o8c7dd['tmp_name'])) { if(__LOG)__log('Ajax file upload: Existing file is the same'); $u6f4b5=true; } elseif (!$t77dce){ $s96704=e2files__find_free_filename($a85114,$s96704); } } if (!$u6f4b5){ move_uploaded_file($o8c7dd['tmp_name'],$a85114.$s96704); @chmod($d9f57c,$_config['uploaded_files_mode']); } if(__LOG)__log('Ajax file upload: File kind is <'. $hd1fc8['file-kind'].'>'); if ($hd1fc8['file-kind']=='image'){ $za28be=e2files__find_free_filename_with_added_ext( MEDIA_ROOT_FOLDER.PICTURES_FOLDER, $s96704,'jpg' ); $vb1cee=MEDIA_ROOT_FOLDER.PICTURES_FOLDER.$s96704; $y093b5=MEDIA_ROOT_FOLDER.PICTURES_FOLDER.$za28be; if(__LOG)__log('Ajax file upload: Process uploaded image <'. $vb1cee.'>'. ' to possibly <'. $y093b5.'>'); $y093b5=e2img_filename_by_processing( $vb1cee, $y093b5, [ $_config['fit_uploaded_images'], $_config['fit_uploaded_images'], ], CROP_NONE, SCALED_IMAGE_JPG_QUALITY ); if (!s4f9d($y093b5,$vb1cee)) { @unlink($vb1cee); $s96704=$za28be; } if ($t77dce){ @unlink(r1cae($s96704)); } if ($r742c4=s6e61($s96704)) { if(__LOG)__log('Ajax file upload: thumbnail, done'); list ($reaae2,$bb435e)=h19a4(MEDIA_ROOT_FOLDER.$r742c4); $hd1fc8['success']=1; $hd1fc8['new-name']=$s96704; $hd1fc8['thumb']=$full_blog_url .'/'. $r742c4; $hd1fc8['width']=$reaae2; $hd1fc8['height']=$bb435e; c4ae9($parameters['entity'],$parameters['entity-id'],'add', array ($s96704)); } else { if(__LOG)__log('Ajax file upload: couldn’t create thumbnail'); @unlink($a85114.$s96704); $hd1fc8['error']='could-not-create-thumbnail'; } } if ($hd1fc8['file-kind']=='audio'){ if(__LOG)__log('Ajax file upload: audio, done'); $hd1fc8['success']=1; $hd1fc8['new-name']=$s96704; $hd1fc8['thumb']=AUDIO_ICON_IMAGE; $hd1fc8['width']=AUDIO_ICON_WIDTH; $hd1fc8['height']=AUDIO_ICON_HEIGHT; c4ae9($parameters['entity'],$parameters['entity-id'],'add', array ($s96704)); } } elseif(4!=$o8c7dd['error']) { if ($o8c7dd['error']==1){ $hd1fc8['error']='too-big'; } elseif ($o8c7dd['error']==2){ $hd1fc8['error']='too-big'; } elseif ($o8c7dd['error']==3){ $hd1fc8['error']='partial'; } else { $hd1fc8['error']=$o8c7dd['error']; } } } } else { if(__LOG)__log('Ajax file upload error: no files'); $hd1fc8['error']='no-files'; } $hd1fc8=json_encode($hd1fc8); die ($hd1fc8); } function e2j_userpic_upload(){ global$_config; if(count($_FILES)==1){ $o8c7dd=array_pop($_FILES); if (!$o8c7dd['error']) { if(__LOG)__log('Ajax userpic upload: <'. $o8c7dd['name'].'>'); $ka93b8=pathinfo($o8c7dd['name']); $pabf77=strtolower($ka93b8['extension']); if ($pabf77!='png')$pabf77='jpg'; $v435ed='userpic.original.'. $pabf77; move_uploaded_file($o8c7dd['tmp_name'],USER_FOLDER.$v435ed); @chmod(USER_FOLDER.$v435ed,$_config['uploaded_files_mode']); @unlink(USER_FOLDER.'userpic@2x.png'); @unlink(USER_FOLDER.'userpic@2x.jpg'); $wf1210=e2img_filename_by_processing( USER_FOLDER.$v435ed, USER_FOLDER .'userpic@2x.jpg', [USERPIC_WIDTH,USERPIC_HEIGHT], CROP_SQUARE, USERPIC_JPG_QUALITY ); @unlink(USER_FOLDER.$v435ed); if ($wf1210){ if(__LOG)__log('Ajax userpic upload: userpic, done'); die ('image|'. $wf1210); } else { die ('image|'.DEFAULT_USERPIC_FILENAME); } } elseif(4!=$o8c7dd['error']) { if ($o8c7dd['error']==1){ die ('error|too-big'); } elseif ($o8c7dd['error']==2){ die ('error|too-big'); } elseif ($o8c7dd['error']==3){ die ('error|partial'); } else { die ('error|'. $o8c7dd['error']); } } } else { if(__LOG)__log('Ajax userpic upload error: no or too many files'); die ('error|no-or-too-many-files'); } die ('error|uncatched-error'); } function e2j_file_remove($parameters){ $o8c7dd=$wf1210=''; if(array_key_exists('file',$_POST))$o8c7dd=$_POST['file']; c4ae9($parameters['entity'],$parameters['entity-id'],'remove',$o8c7dd); if (df0fb($o8c7dd)) { die ('nothing'); } else { if(substr($o8c7dd,strrpos($o8c7dd,'.')) == '.mp3'){ @unlink(MEDIA_ROOT_FOLDER.AUDIO_FOLDER.$o8c7dd); die ('nothing'); } else { $wf1210=e2files__add_ext_prefix($o8c7dd,'thumb@2x'); if ($o8c7dd){ $uf6347=@unlink(MEDIA_ROOT_FOLDER.PICTURES_FOLDER.$o8c7dd); $s8f458=@unlink(MEDIA_ROOT_FOLDER.THUMBNAILS_FOLDER.$wf1210); die ('nothing'); } } } die ('error|no-filename-passed'); } function ud10e(){ global$_config; if (!$_config['files_total_size_limit']) return false; $l70a36=0; foreach(glob(MEDIA_ROOT_FOLDER.PICTURES_FOLDER .'/*') as $o8c7dd){ $m9dd4e=stat($o8c7dd); $l70a36+=$m9dd4e['size']; } foreach(glob(MEDIA_ROOT_FOLDER.AUDIO_FOLDER .'/*') as $o8c7dd){ $m9dd4e=stat($o8c7dd); $l70a36+=$m9dd4e['size']; } $wd515a=$_config['files_total_size_limit']; $v354f0=round($l70a36/$wd515a*100); if ($l70a36 > 0 and $v354f0==0)$v354f0=1; if ($l70a36 < $wd515a and $v354f0==100)$v354f0=99; return array ($l70a36,$wd515a,$v354f0); } function s4f9d($tbd198,$l3667f){ return strcasecmp($tbd198,$l3667f)===0; } function o1363($fc999b){ $s85faf=true; if (list ($l70a36,$wd515a,$v354f0)=$fc999b){ $s85faf=($wd515a-$l70a36) > 0; } return $s85faf; } function gaf64($fc999b,$ef9f90=false){ $pf3ecb=''; if (list ($l70a36,$wd515a,$v354f0)=$fc999b){ $fc999b=array ( 'used' => round($l70a36/1024/1024), 'total' => round($wd515a/1024/1024), 'percent' => $v354f0 ); if ($ef9f90 or ($wd515a-$l70a36) < 1024*1024*10){ if ($l70a36 < $wd515a){ $pf3ecb=e2l_get_string('gs--used',$fc999b); } else { $pf3ecb=e2l_get_string('gs--used-all',$fc999b); } } } return $pf3ecb; } function e2files__find_free_filename($a85114,$v435ed){ if (!is_file($a85114.$v435ed)) return $v435ed; $ye12a7=e2files__extless($v435ed); $pabf77=substr($v435ed,strrpos($v435ed,'.')); $v865c0=0; while (is_file($a85114.$ye12a7 .'-'. (++$v865c0).$pabf77)); $v435ed=$ye12a7 .'-'. $v865c0.$pabf77; return $v435ed; } function e2files__add_ext_prefix($v435ed,$k3dbb8){ if ($k3dbb8){ $h80127=explode('/',$v435ed); $s954eb=array_pop($h80127); $n35b88=explode('.',$s954eb); if(count($n35b88) < 2)$n35b88[] = ''; $pabf77=array_pop($n35b88); $n35b88[] = $k3dbb8; if ($pabf77)$n35b88[] = $pabf77; $s954eb=implode('.',$n35b88); $h80127[] = $s954eb; $v435ed=implode('/',$h80127); } return $v435ed; } function e2files__extless($v435ed){ return substr($v435ed,0,strrpos($v435ed,'.')); } function e2files__find_free_filename_with_added_ext($a85114,$v435ed,$t3cedd){ $pabf77=pathinfo($v435ed,PATHINFO_EXTENSION); if (!strcasecmp($pabf77,$t3cedd)) return $v435ed; return e2files__find_free_filename($a85114,$v435ed .'.'. $t3cedd); } function g74e0(){ global$settings; if (!isset ($settings))$settings=array(); $bfa816=array(); if(is_file(USER_FOLDER.'settings.json')) { $bfa816=json_decode(file_get_contents(USER_FOLDER.'settings.json'),true); $g098f6=13; } elseif(is_file(USER_FOLDER.'settings.psa')) { $bfa816=unserialize(file_get_contents(USER_FOLDER.'settings.psa')); } if (!is_array($bfa816))$bfa816=array(); $settings=array_merge($settings,$bfa816); if ( !is_numeric(@$settings['appearance']['notes_per_page']) or @$settings['appearance']['notes_per_page'] < 1 ){ $settings['appearance']['notes_per_page']=DEFAULT_ITEMS_PER_PAGE; } if ( @$settings['appearance']['notes_per_page'] > MAX_ITEMS_PER_PAGE ){ $settings['appearance']['notes_per_page']=MAX_ITEMS_PER_PAGE; } if ( !array_key_exists('comments',$settings) or !array_key_exists('default_on', @$settings['comments']) ) { $settings['comments']['default_on']=false; } return true; } function e2m_settings(){ global$settings,$_template,$_strings; $af3e33=array(); $o5e107=@$settings['language']? $settings['language']:DEFAULT_LANGUAGE; foreach(glob(LANGUAGES_FOLDER. '*.php') as $v435ed){ $g5b54c=substr(basename($v435ed),0,2); $g98bf7=file_get_contents($v435ed); if(preg_match( '/^ *\/\/ *display_name *\= *(.*?) *$/ismu',$g98bf7,$u9c28d )) { $rc2657=$u9c28d[1]; } else { $rc2657=$g5b54c; } $af3e33[$g5b54c] = array ( 'selected?' => (bool) ($o5e107==$g5b54c), 'display-name' => $rc2657, ); } $x2cb9d['title']=$_strings['pt--settings']; $x2cb9d['heading']=$_strings['pt--settings']; $x2cb9d['form']='form-preferences'; $x2cb9d['form-preferences'] = array ( 'blog-title-default' => htmlspecialchars($_strings['e2--default-blog-title'],ENT_COMPAT,HSC_ENC), 'blog-title' => htmlspecialchars(q6f51(),ENT_COMPAT,HSC_ENC), 'blog-description' => htmlspecialchars(@$settings['description'],ENT_COMPAT,HSC_ENC), 'blog-author-default' => htmlspecialchars($_strings['e2--default-blog-author'],ENT_COMPAT,HSC_ENC), 'blog-author' => htmlspecialchars(@$settings['author'],ENT_COMPAT,HSC_ENC), 'languages' => $af3e33, 'language' => $o5e107, 'form-action' => v83c8('e2s_settings_save'), 'notes-per-page' => $settings['appearance']['notes_per_page'], 'email-notify?' => (bool) @$settings['notifications']['new_comments'], 'email' => htmlspecialchars(@$settings['user']['email'],ENT_NOQUOTES,HSC_ENC), 'comments-default-on?' => (bool) @$settings['comments']['default_on'], 'comments-require-gip?' => (bool) @$settings['comments']['require_gip'], 'comments-fresh-only?' => (bool) @$settings['comments']['fresh_only'], 'show-sharing-buttons?' => (bool)$settings['appearance']['show_sharing_buttons'], 'includes-google-analytics?' => false, 'includes-yandex-metrika?' => false, 'template-name' => $_template['name'], 'templates' => k94dd(), 'submit-text' => $_strings['fb--save-changes'], 'space-usage' => gaf64(ud10e(),true), ); return $x2cb9d; } function e2s_settings_save(){ global$settings,$_strings; if($_SERVER['REQUEST_METHOD']!='POST') return e2_go_to(v83c8('e2m_settings')); $t05df2=$f67daf=''; if(array_key_exists('blog-title',$_POST)) { $t05df2=trim($_POST['blog-title']); } if(array_key_exists('blog-description',$_POST)) { $f67daf=trim($_POST['blog-description']); } if(array_key_exists('blog-author',$_POST)) { $s02bd9=trim($_POST['blog-author']); } if(array_key_exists('language',$_POST)) $b8512a=$_POST['language']; if(array_key_exists('email',$_POST)) $z0c83f=trim($_POST['email']); $n0c2bd=(int)$_POST['notes-per-page']; $settings['site_title']=$t05df2; $settings['site_title']=q6f51(); $settings['description']=$f67daf; $settings['author']=$s02bd9; $settings['user']['email']=$z0c83f; $settings['notifications']['new_comments'] = isset ($_POST['email-notify']); if(array_key_exists('template',$_POST)) { $settings['template']=trim($_POST['template']); } $settings['comments']['default_on'] = isset ($_POST['comments-default-on']); $settings['comments']['require_gip'] = isset ($_POST['comments-require-gip']); if ( $settings['language']!=$b8512a or $settings['appearance']['notes_per_page']!=$n0c2bd or $settings['appearance']['show_sharing_buttons'] != isset ($_POST['show-sharing-buttons']) or $settings['comments']['fresh_only'] != isset ($_POST['comments-fresh-only']) ) { @unlink(CACHE_FILENAME_FRONTPAGE); @unlink(CACHE_FILENAME_FRONTPAGE_AUTHOR); $settings['language']=$b8512a; $settings['appearance']['notes_per_page']=$n0c2bd; $settings['appearance']['show_sharing_buttons'] = isset ($_POST['show-sharing-buttons']); $settings['comments']['fresh_only'] = isset ($_POST['comments-fresh-only']); } fc5a6(CACHE_FILENAMES_NOTES_COMMENTS); if (!@x6e52(USER_FOLDER.'settings.json',json_encode($settings,E2_JSON_STYLE))) { p8a40($_strings['er--settings-not-saved'],E2E_PERMISSIONS_ERROR); e2_go_to(v83c8('e2m_settings')); die; } e2_go_to(v83c8('e2m_frontpage', array ('page' => 1))); die; } function e2m_database(){ global$settings,$_strings,$_superconfig; if (@$_superconfig['disallow_db_config']) { return e2_error404_mode(); } $x2cb9d['title']=$_strings['pt--database']; $x2cb9d['heading']=$_strings['pt--database']; $x2cb9d['form']='form-database'; $x2cb9d['form-database'] = array ( 'form-action' => v83c8('e2s_database_save'), 'db-server' => htmlspecialchars(@$settings['db']['server']? $settings['db']['server']:'localhost'), 'db-user' => htmlspecialchars(@$settings['db']['user_name']? $settings['db']['user_name']:'root'), 'db-password' => htmlspecialchars(kee85(@$settings['db']['passw'])), 'db-database' => htmlspecialchars(@$settings['db']['name']), 'submit-text' => $_strings['fb--connect-to-this-db'], ); return $x2cb9d; } function e2s_database_save(){ global$settings,$_db,$_superconfig,$_strings,$_config; if($_SERVER['REQUEST_METHOD']!='POST') return e2_go_to(v83c8('e2m_database')); if (@$_superconfig['disallow_db_config']) { return e2_error404_mode(); } $p0ba44=s55fd(); if ($p0ba44=='bingo-data-exists'){ $settings['db']['server'] = @$_POST['db-server']; $settings['db']['user_name'] = @$_POST['db-user']; $settings['db']['passw']=j1305(@$_POST['db-password']); $settings['db']['name'] = @$_POST['db-database']; if (!@x6e52(USER_FOLDER.'settings.json',json_encode($settings,E2_JSON_STYLE))) { p8a40($_strings['er--settings-not-saved'],E2E_PERMISSIONS_ERROR); e2_go_to(v83c8('e2m_database')); die; } e2_drop_all_kinds_of_cache(); ebb8d(); if (!$_config['retain_search_indexes_on_db_switch']) { $addece=g476c(); try { $addece -> erase(); } catch (\S2\Rose\Exception\RuntimeException $e){ if(__LOG)__log('Rose not available'); } q198f(); } tcc38(v83c8('e2s_bsi_step')); e2_go_to(v83c8('e2m_settings')); } else { p8a40($_strings['er--double-check-db-params']); e2_go_to(v83c8('e2m_database')); } die; } function rda67(){ return class_exists('ZipArchive'); } function e2m_get_backup(){ if (rda67()) { $bfbade=new ZipArchive(); $q979eb=BACKUP_FOLDER .'backup.zip'; if ($bfbade -> open($q979eb,ZIPARCHIVE::CREATE)) { @ $bfbade -> addEmptyDir('backup'); @ $bfbade -> addEmptyDir('backup/db'); @ $bfbade -> addFile(USER_FOLDER.'userpic@2x.jpg','backup/files/userpic@2x.jpg'); @ $bfbade -> addFile(USER_FOLDER.'userpic@2x.png','backup/files/userpic@2x.png'); foreach(glob(BACKUP_FOLDER .'backup-*.sql') as $o8c7dd); $bfbade -> addFile($o8c7dd,'backup/db/'. basename($o8c7dd)); $bfbade -> close(); } if(is_file($q979eb)) { header('Content-Type: application/zip'); header('Content-Disposition: attachment; filename="backup.zip"'); readfile($q979eb); unlink($q979eb); } else { die ('Cannot get backup'); } die; } else { die ('Cannot get backup'); } } g74e0(); function p8a40($f67daf,$type=E2E_STRANGE_ERROR){ global$errors,$settings, $_config, $_strings, $_diagnose; $u1897a=(!ee852()+1 <= (int)$_config['show_call_stack']); if ($f67daf){ if ($f67daf[0]!='<')$f67daf='<p>'.$f67daf .'</p>'; $kcd1dd=array ( 'description' => $f67daf, 'type' => $type, ); if ( $type==E2E_STRANGE_ERROR and $u1897a and function_exists('debug_backtrace') ) { $kcd1dd['backtrace']=debug_backtrace(); } $errors[] = $kcd1dd; } if($type==E2E_PERMISSIONS_ERROR){ $_diagnose['need?']=true; rc64a('diagnose','1'); } if($type==E2E_DATABASE_ERROR){ } return true; } function c8739(){ global$errors,$w1c0b7,$_strings,$_diagnose; $e7287a=qea70(); if(count($e7287a)==0){ rc64a('diagnose',''); unset($_COOKIE['diagnose']); $_diagnose['need?']=false; $_diagnose['ok?']=true; return true; } else { $u6e2ba=''; $u6e2ba.='<p>'. $_strings['gs--enable-write-permissions-for-the-following'] .'</p>'; $u6e2ba.='<ul>'; foreach ($e7287a as $m8fa14){ if ($m8fa14=='.')$m8fa14=''; $u6e2ba.='<li><tt>.../'. $m8fa14 .'</tt></li>'; if(__LOG)__log('Diagnostics: cannot write <'. $m8fa14 .'>'); } $u6e2ba.='</ul>'; $kcd1dd=array ( 'title' => $_strings['et--fix-permissions-on-server'], 'description' => $u6e2ba, 'type' => E2E_DIAGNOSTICS_MESSAGE, 'class' => 'serious', ); $errors[] = $kcd1dd; $_diagnose['ok?']=false; return false; } } function ve1c4($kc1336,$f67daf,$d1407f,$ac2d4b,$i4f62c){ global$errors; if(0==error_reporting() or ($kc1336 & 8)) return; $d1407f=str_replace(__DIR__,'',$d1407f); p8a40($d1407f .', line '. $ac2d4b .'<br />Error '. $kc1336 .': '. $f67daf); $errors[count($errors)-1]['phpcode']=$kc1336; } function qec07(){ global$errors,$settings,$_config; @session_start(); if(is_array(@$_SESSION['errors'])) { $qe1671=array_merge(@$_SESSION['errors'],$errors); } else { $qe1671=$errors; } $u1897a=(!ee852()+1 <= (int)$_config['show_call_stack']); if (@$_config['store_backtrace'] and $u1897a and $qe1671!=NULL){ @x6e52('backtrace.psa',serialize($qe1671)); } else { @unlink('backtrace.psa'); } if (isset ($_SESSION['errors'])) unset($_SESSION['errors']); $x2cb9d=array(); $ib8735=false; if(count($qe1671) > 0){ foreach ($qe1671 as $v865c0 => $t08a44){ if ($t08a44['type']==E2E_STRANGE_ERROR){ $t08a44['class']='serious'; $ib8735=true; if ($u1897a){ $t08a44['backtrace']=m2616($t08a44['backtrace']); } } if ($t08a44['type']==E2E_MESSAGE){ $t08a44['class']='info'; } $qe1671[$v865c0]=$t08a44; } $x2cb9d['each']=$qe1671; if ( $ib8735 and @$_config['store_backtrace'] and $u1897a and is_file('debug.php') ) { $x2cb9d['debug-link']='debug.php'; } } return $x2cb9d; } function p4006(){ $errors=qec07(); foreach($errors['each'] as $ncb5e1){ echo '<p>'. $ncb5e1['description'] .'</p>'; } die; } function m2616($i69206){ global $wa57c1; if (!is_array($i69206)) return 'No backtrace info'; $i69206=array_reverse($i69206); $i69206=array_splice($i69206,0,count($i69206)-1); $qe1671='<p style="background: #fea; padding: .25em .5em; line-height: 1em; overflow: hidden">'; foreach ($i69206 as $v865c0 => $oe358e){ $i195df=@$oe358e['args'] or $i195df=array(); $ta956a=array(); foreach ($i195df as $i5919c){ $ta956a[] = var_export($i5919c,true); } $o8c7dd=@$oe358e['file']; $o8c7dd=str_replace($_SERVER['DOCUMENT_ROOT'],'',$o8c7dd); $u6438c=(@$oe358e['line']? (' #'. $oe358e['line']) : '?'); $qe1671.='<div style="margin: .25em 0 .5em '. $v865c0*3 .'em">'; $qe1671.='<span style="float: right; color: #666"> '. $o8c7dd.$u6438c .'</span>'; $qe1671.='<tt><b>'. @$oe358e['function'] .' (</b>'; if(count($ta956a)) { $qeb84a=str_replace("array (\n)",'array ()',$ta956a); $qeb84a=implode(', ',$qeb84a); if(0){ $qeb84a=highlight_string('<?'. $qeb84a .'?'.'>',true); $qeb84a=substr($qeb84a,77, -28); } $qeb84a=str_replace('&nbsp;',' ',$qeb84a); $qeb84a=nl2br($qeb84a); $qe1671.='<div style="margin: 0 0 0 1.12em">'. $qeb84a .'</div>'; } $qe1671.='<b>)</b> &rarr;</tt></div>'; } $qe1671.='</p>'; return $qe1671; } set_error_handler('ve1c4'); function e2_error404_mode(){ global$_config,$_strings; if($_config['try_redirect_to_all']) { $u4a7dc='all/'. urldecode($_GET['go']); mb7e9($u4a7dc); } header('HTTP/1.1 404 Not found'); $pe70c4['class']='404'; $pe70c4['heading']=$_strings['pt--page-not-found']; $pe70c4['title']=$_strings['pt--page-not-found']; return $pe70c4; } include_once 'neasden/neasden.php'; function i6f10($y1cb25){ $Nn=new Neasden; $Nn->profile_name='kavychki'; return$Nn->format($y1cb25); } function yc0c4($mf2ffc,$y1cb25,$e5c18e){ if ($y1cb25==='') return array (); if ($mf2ffc=='calliope'){ preg_match_all('/\(\(([^ ]*)( |\)\))/',$y1cb25,$u9c28d); return $u9c28d[1]; } elseif ($mf2ffc=='neasden'){ $Nn=new Neasden; $Nn->profile_name=$e5c18e; $Nn->format($y1cb25); return$Nn->resources_detected; } else { return array (); } } function q154e($mf2ffc,$y1cb25,$e5c18e){ if(__LOG)__log('Format: format with formatter "'. $mf2ffc .'" in context "'. $e5c18e.'"'); if ($mf2ffc=='calliope'){ $y1cb25=medd9($y1cb25); $y1cb25=g5599($y1cb25,$e5c18e); $meta=array(); $y1cb25=yfd97($y1cb25); $y1cb25='<div class="e2-text-calliope-formatted">'. i6f10($y1cb25) .'</div>'; } elseif ($mf2ffc=='neasden'){ $Nn=new Neasden; $Nn->profile_name=$e5c18e; $y1cb25=$Nn->format($y1cb25); $meta=array ( 'links-required' => $Nn->links_required, 'resources-detected' => $Nn->resources_detected ); } return array ( 'text-final' => $y1cb25, 'meta' => $meta, ); } function wb7f1($y1cb25,$e5c18e){ global$_config; return q154e($_config['default_formatter'],$y1cb25,$e5c18e); } function g5599($y1cb25,$e5c18e){ global$_config,$settings,$full_blog_url,$_template; @ (list ($e5c18e,$fe8fab)=explode('|',$e5c18e)); require_once 'calliope/WikiFormatter.php'; if ('full'==$e5c18e)$mad910=WF_FULL_MODE; elseif ('full-rss'==$e5c18e)$mad910=WF_FULL_MODE; elseif ('simple'==$e5c18e)$mad910=WF_SIMPLE_MODE; elseif ('simple-rss'==$e5c18e)$mad910=WF_SIMPLE_MODE; else return $y1cb25; $b0a1d3=new WikiFormatter(); $b0a1d3 -> replace=array ( '/' => 'i', '+' => 'small', '-' => 's', '*' => 'b', '^' => 'sup', 'v' => 'sub', '#' => 'tt', '!' => 'blockquote', ); $b0a1d3 -> settings=array ( 'hrefSize' => 100, 'localImgDir' => $full_blog_url .'/'. PICTURES_FOLDER, 'maxImgWidth' => $_template['max_image_width'], 'mode' => $mad910, 'enableShrinkLongHref' => 1, 'enableHr' => 0, 'enableBr' => 1, 'enableHeaders' => 1, 'headersStartWith' => 1, 'enableTables' => 1, 'simpleTableCSSClass' => 'e2-text-table', 'enableAutoAcronymEngine' => 0, 'enableAcronym' => 0, 'acronymBase' => '', 'enableList' => 1, 'mailSafe' => "<a href=\"\" onmouseover=\"this.href='mailto:'+{email}\">{icon}<script language=\"JavaScript\">document.write({name});</script></a>", 'ljUserTag' => '<a href="http://livejournal.com/users/{name}/">{name}</a>', 'fullVersionURL' => $fe8fab, 'enableTagIcons' => 0, 'outerUrlInNewWindow' => 0, 'lineBreak' => "\n", 'extLinkHrefPrefix' => '', ); $y1cb25=$b0a1d3 -> Wiki2HTML($y1cb25); return $y1cb25; } function tcc38($n572d4){ if(__LOG)__log('Spawn: Curl '. $n572d4 .'...'); if(function_exists('curl_init')) { $bf6e57=curl_init(); $a80e25=!ini_get('open_basedir'); curl_setopt_array($bf6e57, array ( CURLOPT_URL => $n572d4, CURLOPT_CONNECTTIMEOUT => 300, CURLOPT_TIMEOUT => 1, CURLOPT_MAXREDIRS => 1, CURLOPT_COOKIE => rc3fb(), CURLOPT_SSL_VERIFYPEER => false, CURLOPT_FOLLOWLOCATION => $a80e25, CURLOPT_RETURNTRANSFER => true, CURLOPT_AUTOREFERER => true, CURLOPT_USERAGENT => E2_UA_STRING, )); $content=curl_exec($bf6e57); $z70106=curl_errno($bf6e57); $m809b1=curl_error($bf6e57); $g099fb=curl_getinfo($bf6e57); curl_close($bf6e57); if(__LOG)__log('Spawn: Curl returns: ['. print_r($g099fb,true) .'] ['. $content .'], (errno='. $z70106 .', errstr='. $m809b1 .')...'); } else { if(__LOG)__log('Spawn: Curl functions are not available'); } } function i5b68($pea59a){ global$_config; if (@$_config['broadcast_url'] and !$pea59a['IsExternal']) { if(__LOG)__log('Broadcast-async note: '. $pea59a['Title']); $n572d4=v83c8('e2m_note_broadcast', array ('*note' => $pea59a)); if(__LOG)__log('Broadcast will spawn url: '. $n572d4); tcc38($n572d4); } } function m0d22($qcffbb){ global$_config; if (!$qcffbb) return false; $n572d4=$_config['broadcast_url']; $n572d4.='?src='. urlencode($qcffbb); if(__LOG)__log('Broadcast: Curl '. $n572d4 .'...'); if(function_exists('curl_init')) { $bf6e57=curl_init(); $a80e25=!ini_get('open_basedir'); curl_setopt_array($bf6e57, array ( CURLOPT_URL => $n572d4, CURLOPT_CONNECTTIMEOUT => 300, CURLOPT_TIMEOUT => 1, CURLOPT_MAXREDIRS => 1, CURLOPT_COOKIE => rc3fb(), CURLOPT_SSL_VERIFYPEER => false, CURLOPT_FOLLOWLOCATION => $a80e25, CURLOPT_RETURNTRANSFER => true, CURLOPT_AUTOREFERER => true, CURLOPT_USERAGENT => E2_UA_STRING, )); $content=curl_exec($bf6e57); $z70106=curl_errno($bf6e57); $m809b1=curl_error($bf6e57); $g099fb=curl_getinfo($bf6e57); curl_close($bf6e57); if(__LOG)__log('Broadcast: Curl returns: ['. print_r($g099fb,true) .'] ['. $content .'], (errno='. $z70106 .', errstr='. $m809b1 .')...'); if ($z70106===0) return true; } else { if(__LOG)__log('Spawn: Curl functions are not available'); } return false; } function web3b($pea59a){ if (!$pea59a) return false; $qcffbb=v83c8('e2m_note_json', array ('*note' => $pea59a)); return m0d22($qcffbb); } function e2m_note_broadcast($parameters=array ()) { global$_config; if (@$_config['broadcast_url']) { if(array_key_exists('*note',$parameters)) { $qcffbb=v83c8('e2m_note_json', array ('*note' => $parameters['*note'])); } elseif(array_key_exists('alias',$parameters)) { $qcffbb=v83c8('e2m_note_json', array ('alias' => $parameters['alias'])); } if (m0d22($qcffbb)) { die ('Broadcasted.'); } } else { return e2_error404_mode(); } } function e2m_timezone(){ global$_strings,$settings; $hde2fd=array ( 'form-action' => v83c8('e2s_select_timezone'), 'submit-text' => $_strings['fb--select'], 'timezone-selector' => d9fe5($settings['timezone']['offset'],1), 'dst?' => $settings['timezone']['is_dst'], ); return array ( 'title' => $_strings['pt--default-timezone'], 'heading' => $_strings['pt--default-timezone'], 'form' => 'form-timezone', 'form-timezone' => $hde2fd, ); } function p4c37(){ global$_strings; $a5cacd=array ( -720 => '', -660 => '', -600 => '', -540 => '', -480 => $_strings['tt--zone-pt'], -420 => $_strings['tt--zone-mt'], -360 => $_strings['tt--zone-ct'], -300 => $_strings['tt--zone-et'], -240 => '', -210 => '', -180 => '', -120 => '', -60 => '', 0 => $_strings['tt--zone-gmt'], 60 => $_strings['tt--zone-cet'], 120 => $_strings['tt--zone-eet'], 180 => '', 210 => '', 240 => $_strings['tt--zone-msk'], 270 => '', 300 => '', 330 => '', 345 => '', 360 => $_strings['tt--zone-ekt'], 390 => '', 420 => '', 480 => '', 540 => '', 570 => '', 600 => '', 660 => '', 720 => '', 780 => '', 840 => '', ); return $a5cacd; } function g82a3($w7a86c){ $a5cacd=p4c37(); return @$a5cacd[(int)$w7a86c/SECONDS_IN_A_MINUTE]; } function w9515($w7a86c){ $c04b29='+'; if ($w7a86c < 0)$c04b29='&ndash;'; $i73cdd=str_pad((int) (abs($w7a86c)/3600),2,'0',STR_PAD_LEFT); $k640fd=str_pad(abs($w7a86c)/60 % 60,2,'0',STR_PAD_LEFT); return 'GMT'. $c04b29.$i73cdd .':'. $k640fd; } function d9fe5($h0743a,$h5784d=''){ global$_strings; $a5cacd=p4c37(); $x2cb9d=''; if (!$h5784d)$h5784d=count($a5cacd); $x2cb9d.='<select name="offset" size="'. $h5784d .'">'; foreach ($a5cacd as $w7a86c => $y83bce){ $wc03a8=''; if ($w7a86c*SECONDS_IN_A_MINUTE==$h0743a)$wc03a8=' selected="selected"'; $x2cb9d.='<option'. $wc03a8 .' value="'.$w7a86c.'">'; $c04b29=''; if ($w7a86c < 0)$c04b29='−'; if ($w7a86c > 0)$c04b29='+'; $i73cdd=(int) (abs($w7a86c*SECONDS_IN_A_MINUTE)/3600); $k640fd=(int) (abs($w7a86c*SECONDS_IN_A_MINUTE)/60 % 60); if ($i73cdd){ $x2cb9d .= ( $c04b29 .' '. $i73cdd .' '. $_strings['gs--timezone-offset-hours'] .' '. ($k640fd? ($k640fd .' '. $_strings['gs--timezone-offset-minutes']) : '') ); if ($y83bce){ $x2cb9d .= ' ('. $y83bce. ')'; } } else { $x2cb9d .= $y83bce; } $x2cb9d.='</option>'; } $x2cb9d.='</select>'; return $x2cb9d; } function e2s_select_timezone(){ global$settings,$_strings; if (@$_POST['offset'] >= -720 and @$_POST['offset'] <= 780){ $settings['timezone']['offset'] = @$_POST['offset']*SECONDS_IN_A_MINUTE; $settings['timezone']['is_dst'] = isset ($_POST['is_dst']); } if (!@x6e52(USER_FOLDER.'settings.json',json_encode($settings,E2_JSON_STYLE))) { p8a40($_strings['er--settings-not-saved'],E2E_PERMISSIONS_ERROR); e2_go_to(v83c8('e2m_timezone')); die; } e2_go_to(v83c8('e2m_settings')) and die (); } function m0923($iaad65){ return array ( 'offset' => (int)$iaad65['Offset'], 'is_dst' => (bool)$iaad65['IsDST'], ); } function n3211(){ return array ( 'offset' => 0, 'is_dst' => false, ); } function e5c05(){ global$settings; return$settings['timezone']; } function i7770($qb2c6c,$ydf491){ if (@$qb2c6c['is_dst']) { $u30481=(int)date('I',$ydf491); $f6b7ea=date('Z',$ydf491)-$u30481*SECONDS_IN_AN_HOUR; $c3e61a=$qb2c6c['offset']; $d178ae=$c3e61a-$f6b7ea; $a75b02=date('I',$ydf491+$d178ae); return $a75b02; } else { return 0; } } function zb2bf($qb2c6c,$ydf491){ global$settings; if ($qb2c6c and is_array($qb2c6c)) { return ( $qb2c6c['offset'] + i7770($qb2c6c,$ydf491)*SECONDS_IN_AN_HOUR ); } } function n8afe($ydf491){ return zb2bf(e5c05(),$ydf491); } function w5a2f($s1ddcb,$p4a202,$qb2c6c){ return gmdate($s1ddcb,$p4a202+zb2bf($qb2c6c,$p4a202)); } function ba846($s1ddcb,$p4a202){ return w5a2f($s1ddcb,$p4a202,e5c05()); } function w66cd($p41529,$k6f8f5=false,$v8277e=false){ if(is_numeric($v8277e)) { $lea2b2=gmmktime(0,0,0,$k6f8f5,$v8277e,$p41529); $g7f021=gmmktime(0,0,0,$k6f8f5,$v8277e+1,$p41529)-1; } elseif(is_numeric($k6f8f5)) { $lea2b2=gmmktime(0,0,0,$k6f8f5,1,$p41529); $g7f021=gmmktime(0,0,0,$k6f8f5+1,1,$p41529)-1; } else { $lea2b2=gmmktime(0,0,0,1,1,$p41529); $g7f021=gmmktime(0,0,0,1,1,$p41529+1)-1; } return array ($lea2b2,$g7f021); } function l2143($qb2c6c,$p41529,$k6f8f5=false,$v8277e=false){ list ($lea2b2,$g7f021)=w66cd($p41529,$k6f8f5,$v8277e); $lea2b2 -= zb2bf($qb2c6c,$lea2b2); $g7f021 -= zb2bf($qb2c6c,$g7f021); return array ($lea2b2,$g7f021); } function cac5b($p41529,$k6f8f5=false,$v8277e=false){ return l2143(e5c05(),$p41529,$k6f8f5,$v8277e); } function l5273($p41529,$k6f8f5=false,$v8277e=false){ $p32038=13; $oda4f0=-12; $p32038+=1; $oda4f0 -= 1; list ($lea2b2,$g7f021)=w66cd($p41529,$k6f8f5,$v8277e); $lea2b2 -= $p32038*3600; $g7f021 -= $oda4f0*3600; return array ($lea2b2,$g7f021); } function rd17a($w7a86c){ if ((int) @$w7a86c > 0) return (string)'+'.abs(@$w7a86c); elseif ((int) @$w7a86c < 0) return (string)'-'.abs(@$w7a86c); else return ''; } function hd536($ydf491,$aa0f0b=''){ $h2ab64=n8afe($ydf491); $c04b29=($h2ab64 >= 0)?'+':'-'; $h2ab64=abs($h2ab64); $a03c7c=$h2ab64 % 60; $h2ab64 -= $a03c7c; $k6f8f5=$h2ab64 % 3600/60; $h2ab64 -= $k6f8f5*60; $b2510c=$h2ab64/3600; if ($b2510c < 10)$b2510c='0'.$b2510c; if ($k6f8f5 < 10)$k6f8f5='0'.$k6f8f5; return $c04b29.$b2510c.$aa0f0b.$k6f8f5; } function da618($faa759){ global$settings; if(is_numeric($faa759)) { $result['offset']=SECONDS_IN_A_MINUTE*$faa759; $result['is_dst']=false; $cd8935=SECONDS_IN_A_MINUTE*$faa759-SECONDS_IN_AN_HOUR; $ra6cfc=array ('offset' => $cd8935,'is_dst' => true); $ra6cfc=(int)zb2bf($ra6cfc,time()); if($result['offset']==$ra6cfc){ $result['offset']=$cd8935; $result['is_dst']=true; } } else { if(array_key_exists('timezone',$settings)) { $result=$settings['timezone']; } else { $result['offset']=0; $result['is_dst']=false; } } return$result; } function v692f($a96b8c){ $b2510c=ba846('H',$a96b8c); if ($b2510c <= 4) return 4; elseif ($b2510c <= 10) return 1; elseif ($b2510c <= 16) return 2; elseif ($b2510c <= 22) return 3; else return 4; } function c7a0b($t0e524,$xb65f7=null){ global$_strings; if ($xb65f7===null)$xb65f7=e5c05(); $bdb42a=w5a2f('d.m.Y',$z97bc5,$xb65f7); $o33284=w5a2f('d.m.Y',$t0e524,$xb65f7); $led79a=SECONDS_IN_A_MINUTE; $a77cbc=SECONDS_IN_AN_HOUR; $z97bc5=time(); $h0b375=v692f($z97bc5); $q3dfda=v692f($t0e524); $i74459=$z97bc5-$t0e524; if ($i74459 < 0) return$_strings['tt--from-the-future']; if ($i74459 >= 0 and $i74459 < 54) return$_strings['tt--just-now']; if ($i74459 >= 54 and $i74459 < 108) return$_strings['tt--one-minute-ago']; $d7eccb=$i74459+12; $o7828e=floor($d7eccb/$led79a); if ($i74459 >= 108 and $i74459 < 54*$led79a) return e2l_get_string( 'tt--minutes-ago', array ('minutes' => $o7828e) ); if ($i74459 >= 54*$led79a and $i74459 < 108*$led79a) return$_strings['tt--one-hour-ago']; $d7eccb=$i74459+12*$led79a; $e6b497=floor($d7eccb/$a77cbc); if ($i74459 >= 108*$led79a and $i74459 < 4*$a77cbc) return e2l_get_string( 'tt--hours-ago', array ('hours' => $e6b497) ); $i07cc6=w5a2f('G:i',$t0e524,$xb65f7); if ($i74459 >= 4*$a77cbc and $h0b375 > $q3dfda and $bdb42a==$o33284){ return$_strings['tt--today']; } if ((($z97bc5-$t0e524) <= YEAR_DISPLAY_THRESH)) { return e2l_get_string( 'tt--date', array ( 'day' => w5a2f('j',$t0e524,$xb65f7), 'month' => w5a2f('m',$t0e524,$xb65f7), ) ); } return w5a2f('Y',$t0e524,$xb65f7); } function a9093($t0e524,$xb65f7=null){ global$_strings; $i74459=time()-$t0e524; if ($i74459 < 0) return ''; if ($i74459==0) return$_strings['tt--now']; $eb98b3=array ( array (1,'tt--seconds-short'), array (SECONDS_IN_A_MINUTE,'tt--minutes-short'), array (SECONDS_IN_AN_HOUR,'tt--hours-short'), array (SECONDS_IN_A_DAY,'tt--days-short'), array (SECONDS_IN_A_MONTH,'tt--months-short'), array (SECONDS_IN_A_YEAR,'tt--years-short'), array (SECONDS_IN_A_YEAR+SECONDS_IN_A_MONTH,''), ); for ($v865c0=0; $v865c0 < count($eb98b3); ++ $v865c0){ if ($i74459 >= $eb98b3[$v865c0][0] and $i74459 < $eb98b3[$v865c0+1][0]) { return e2l_get_string( $eb98b3[$v865c0][1], array ('value' => floor($i74459/$eb98b3[$v865c0][0])) ); } } if ($xb65f7===null)$xb65f7=e5c05(); return w5a2f('Y',$t0e524,$xb65f7); } $_model_contractions=array ( 'key' => "INT UNSIGNED AUTO_INCREMENT PRIMARY KEY", 'pkey' => "INT UNSIGNED DEFAULT '0' NOT NULL", 'int' => "INT DEFAULT '0' NOT NULL", 'uint' => "INT UNSIGNED DEFAULT '0' NOT NULL", 'time' => "INT UNSIGNED DEFAULT '0' NOT NULL", '0' => "TINYINT(1) DEFAULT '0' NOT NULL", '1' => "TINYINT(1) DEFAULT '1' NOT NULL", 'v1' => "VARCHAR(1) DEFAULT '' NOT NULL", 'v8' => "VARCHAR(8) DEFAULT '' NOT NULL", 'v15' => "VARCHAR(15) DEFAULT '' NOT NULL", 'v32' => "VARCHAR(32) DEFAULT '' NOT NULL", 'v64' => "VARCHAR(64) DEFAULT '' NOT NULL", 'fid' => "VARCHAR(32) DEFAULT '". $_config['default_formatter'] ."' NOT NULL", 'v255' => "VARCHAR(255) DEFAULT '' NOT NULL", 'text' => "MEDIUMTEXT", ); $_model=array ( 'Actions' => array ( array ('ID', 'key'), array ('EntityID', 'pkey'), array ('Stamp', 'time'), array ('ReadCount', 'int'), ), 'Aliases' => array ( array ('ID', 'key'), array ('EntityType', 'v1'), array ('EntityID', 'pkey'), array ('Alias', 'v64'), array ('Stamp', 'time'), ), 'Comments' => array ( array ('ID', 'key'), array ('NoteID', 'pkey'), array ('AuthorName', 'v255'), array ('AuthorEmail', 'v255'), array ('Text', 'text'), array ('Reply', 'text'), array ('IsVisible', '1'), array ('IsFavourite', '0'), array ('IsReplyVisible', '0'), array ('IsReplyFavourite', '0'), array ('IsAnswerAware', '1'), array ('IsSubscriber', '0'), array ('IsSpamSuspect', '0'), array ('IsNew', '0'), array ('Stamp', 'time'), array ('LastModified', 'time'), array ('ReplyStamp', 'time'), array ('ReplyLastModified', 'time'), array ('IP', 'v15'), array ('IsGIPUsed', '0'), array ('GIP', 'v15'), array ('GIPAuthorID', 'v64'), ), 'Keywords' => array ( array ('ID', 'key'), array ('Keyword', 'v255'), array ('OriginalAlias', 'v64'), array ('Description', 'text'), array ('Uploads', 'text'), array ('IsFavourite', '0'), ), 'Notes' => array ( array ('ID', 'key'), array ('Title', 'v255'), array ('Text', 'text'), array ('FormatterID', 'fid'), array ('OriginalAlias', 'v64'), array ('Uploads', 'text'), array ('IsPublished', '0'), array ('IsCommentable', '0'), array ('IsVisible', '1'), array ('IsFavourite', '0'), array ('Stamp', 'time'), array ('LastModified', 'time'), array ('Offset', 'int'), array ('IsDST', '0'), array ('IsIndexed', '0'), array ('IsExternal', '0'), array ('SourceID', 'pkey'), array ('SourceNoteID', 'pkey'), array ('SourceNoteURL', 'v255'), array ('SourceNoteJSONURL', 'v255'), array ('SourceNoteData', 'text'), ), 'NotesKeywords' => array ( array ('ID', 'key'), array ('NoteID', 'pkey'), array ('KeywordID', 'pkey'), ), 'GIPsSessions' => array ( array ('ID', 'key'), array ('GIP', 'v15'), array ('GIPAuthorID', 'v64'), array ('AuthorName', 'v255'), array ('AuthorEmail', 'v255'), array ('AuthorProfileLink', 'v255'), array ('SessionToken', 'v255'), array ('Stamp', 'time'), ), 'Sources' => array ( array ('ID', 'key'), array ('TrueID', 'pkey'), array ('Title', 'v255'), array ('AuthorName', 'v255'), array ('URL', 'v255'), array ('PictureURL', 'v255'), array ('IsWhiteListed', '0'), array ('IsTrusted', '0'), ), ); $_model_indexes=array ( 'Actions' => array ( "UNIQUE INDEX (`EntityID`, `Stamp`)", ), 'Aliases' => array ( "INDEX (`Alias`)", "INDEX (`EntityID`)", ), 'Comments' => array ( "INDEX (`NoteID`)", ), 'Keywords' => array (), 'GIPsSessions' => array ( "UNIQUE INDEX (`GIP`, `GIPAuthorID`)" ), 'Notes' => array ( "FULLTEXT (`Title`, `Text`)", "INDEX (`Stamp`)", "INDEX (`SourceID`)", "INDEX (`SourceNoteID`)", ), 'NotesKeywords' => array ( "INDEX (`NoteID`)", ), ); $_model_minimal_table_list=array ( 'Comments', 'Keywords', 'Notes', 'NotesKeywords', ); function e2_model_data_check($l2a304,$u11e0e){ global$_model,$_model_minimal_table_list,$_config; $y08cfc=false; $u35f9b=array(); $zac5c7='SHOW TABLES FROM `'. mysqli_real_escape_string($l2a304,$u11e0e). '`'; $result=mysqli_query($l2a304,$zac5c7); if($result){ while ($if1965=mysqli_fetch_row($result)) { foreach(array_keys($_model) as $gd2ffa){ if(strcasecmp($if1965[0],$_config['db_table_prefix'].$gd2ffa)===0){ $y08cfc=true; $u35f9b[] = $gd2ffa; } } } } $rd9a22=true; foreach(array_keys($_model) as $gd2ffa){ if (!in_array($gd2ffa,$u35f9b)) { $rd9a22=false; } } $u7ec6f=true; foreach($_model_minimal_table_list as $gd2ffa){ if (!in_array($gd2ffa,$u35f9b)) { $u7ec6f=false; } } return array ( 'occupied' => $y08cfc, 'complete' => $rd9a22, 'migrateable' => $u7ec6f, ); } function rb154($ccf1e8,$fee11c,$n5f4dc){ $t32e95=array(); if (($l2a304=mysqli_connect($ccf1e8,$fee11c,$n5f4dc)) !== false){ $result=mysqli_query($l2a304,"SHOW DATABASES"); while ($if1965=mysqli_fetch_row($result)) { if ( mysqli_select_db($l2a304,$if1965[0]) and !in_array($if1965[0], array ('information_schema','mysql')) ) { $t32e95[] = $if1965[0]; } } } return $t32e95; } function s55fd(){ global$_model,$_config; $ccf1e8=$fee11c=$n5f4dc=$u11e0e=''; if(array_key_exists('db-server',$_POST)) $ccf1e8= $_POST['db-server']; if(array_key_exists('db-user',$_POST)) $fee11c= $_POST['db-user']; if(array_key_exists('db-password',$_POST))$n5f4dc=$_POST['db-password']; if(array_key_exists('db-database',$_POST))$u11e0e=$_POST['db-database']; if (($l2a304=mysqli_connect($ccf1e8,$fee11c,$n5f4dc)) === false){ if(mysqli_connect_errno()==1045){ return 'server-responding'; } else { return 'no-connect'; } } else { if (!$u11e0e){ $t32e95=rb154($ccf1e8,$fee11c,$n5f4dc); $u11e0e=$t32e95[0]; } if(mysqli_select_db($l2a304,$u11e0e)===false){ return 'server-lets-in'; } else { $uaae42=e2_model_data_check($l2a304,$u11e0e); if ($uaae42['occupied'] and $uaae42['migrateable']) { return 'bingo-data-exists'; } elseif ($uaae42['occupied']) { return 'data-incomplete'; } else { return 'bingo'; } } } } function wa0f9($vaab9e){ global$_config; $z7694f=( "SHOW TABLES LIKE '". $_config['db_table_prefix'].$vaab9e . "'" ); s0738($z7694f); $w9b207=z0d6b(); return count($w9b207) > 0; } function z07e3($vaab9e,$t851f5=null){ global$_config; if(__LOG)__log('Model: check table status to figure out if we can store emoji'); if ($t851f5===null){ $t851f5=$_config['db_table_prefix']; } $z7694f=( "SHOW TABLE STATUS LIKE '". $t851f5.$vaab9e . "'" ); s0738($z7694f); $result=z0d6b(); return$result?$result[0] : []; } function yf1ac($vaab9e){ global$_model,$_model_contractions,$_model_indexes,$_config,$_db; if (wa0f9($vaab9e)) { return true; } $t851f5=$_config['db_table_prefix']; if(array_key_exists($vaab9e,$_model)) { $l54ca8=array(); foreach($_model[$vaab9e] as $z1afd3){ list ($ub0689,$type)=$z1afd3; $l54ca8[] = "`". $ub0689 ."` ". $_model_contractions[$type]; } $p1b1cc=( "CREATE TABLE `". $t851f5.$vaab9e ."` ". "(". implode(" ,",$l54ca8) .") ". "ENGINE=MyISAM DEFAULT CHARSET=". $_db['charset'] ); $t260ca=s0738($p1b1cc); if(is_array(@$_model_indexes[$vaab9e])) { foreach($_model_indexes[$vaab9e] as $z6a992){ $p1b1cc=( "ALTER TABLE `". $t851f5.$vaab9e ."` ". "ADD ". $z6a992 ); s0738($p1b1cc); } } if ($t260ca) return true; } } function f9943($vaab9e,$ade17f,$nb512d='INSERT',$m07ccf=''){ global$_config,$_db; foreach ($ade17f as $z8ce4b => $q9e366){ $k10249=y7928($q9e366); if ($k10249[0]=='`'){ $qbcf11=$k10249; } else { $qbcf11="'". $k10249 ."'"; } $r8688e[$z8ce4b]=$qbcf11; } $ud05b6="`". implode("`, `",array_keys($r8688e)). "`"; $bf09cc=implode(", ",array_values($r8688e)); $p1b1cc=( $nb512d ." INTO `". $_config['db_table_prefix'].$vaab9e ."` ". "(".$ud05b6 .") VALUES (". $bf09cc .")". ($m07ccf? (' '. $m07ccf):'') ); if (s0738($p1b1cc)) { $ade17f['ID']=mysqli_insert_id($_db['link']); return $ade17f; } } function paa79($vaab9e,$ade17f,$h7692d=false,$d0f543=false){ global$_config; if(__LOG)__log('Model: update record in table '. $vaab9e .' {'); $v6a7f2=array(); foreach(e2model__soft_fields_for_table_($vaab9e) as $k06e3d){ if(array_key_exists($k06e3d,$ade17f)) { $k10249=y7928($ade17f[$k06e3d]); if ($k10249[0]=='`'){ $qbcf11=$k10249; } else { $qbcf11="'". $k10249 ."'"; } $v6a7f2[] = '`'. $k06e3d .'`'."=". $qbcf11 .""; } } $cb5b39=array(); if(is_array($h7692d)) { foreach(e2model__soft_fields_for_table_($vaab9e) as $k06e3d){ if(array_key_exists($k06e3d,$h7692d)) { $cb5b39[] = '`'. $k06e3d .'`'."='". y7928($h7692d[$k06e3d]) ."'"; } } } if(count($cb5b39)) { $f56790=implode(" AND ",$cb5b39); } else { if (!array_key_exists('ID',$ade17f) or !is_numeric($ade17f['ID'])) { die ('API MISUSE: e2_update_record must be called with an ID field in $record when updating single row'); } $f56790="`ID`=". $ade17f['ID']; } $result=false; if(count($v6a7f2) > 0){ $r91179=$d0f543? 'LOW_PRIORITY ':''; $p1b1cc=( "UPDATE ". $r91179 ."`". $_config['db_table_prefix'].$vaab9e ."` ". "SET ". implode(', ',$v6a7f2) ." WHERE ". $f56790 ); $result=s0738($p1b1cc); } if(__LOG)__log('}'); if($result) return true; } function e2model__soft_fields_for_table_($vaab9e){ global$_model; $x2cb9d=array(); if(array_key_exists($vaab9e,$_model)) { foreach($_model[$vaab9e] as $k06e3d){ if (!in_array($k06e3d[1], array ('key'))) { $x2cb9d[] = $k06e3d[0]; } } } return $x2cb9d; } function e2m_install(){ global$_strings,$_superconfig,$_files_written,$_diagnose; $x2cb9d=array(); if(e2_is_installed()) { e2_go_to(''); } else { if($_superconfig['disallow_installer']) { die ('Installer disabled by superconfig'); } if(__LOG)__log('Installer: not installed, present user with form'); $x2cb9d['title']=$_strings['pt--install']; $x2cb9d['heading']=$_strings['pt--install']; $rc50d0=$_strings['fb--begin']; $cd77d5['server'] = @$_COOKIE[p8c3b('install_db_server')]; $cd77d5['user_name'] = @$_COOKIE[p8c3b('install_db_user_name')]; $cd77d5['passw']=kee85(@$_COOKIE[p8c3b('install_db_passw')]); $cd77d5['name'] = @$_COOKIE[p8c3b('install_db_name')]; $x2cb9d['form-install'] = array ( 'form-action' => v83c8('e2s_install'), 'form-check-db-config-action' => v83c8('e2j_check_db_config'), 'form-list-databases-action' => v83c8('e2j_list_databases'), 'submit-text' => $rc50d0, 'retry-text' => $_strings['fb--retry'], 'db-server' => htmlspecialchars(@$cd77d5['server']? $cd77d5['server']:'localhost'), 'db-user' => htmlspecialchars(@$cd77d5['user_name']? $cd77d5['user_name']:'root'), 'db-password' => htmlspecialchars(DB_PASSWORD_RECOVER_AND_SHOW? (@$cd77d5['passw']) : ''), 'db-database' => htmlspecialchars(@$cd77d5['name']), ); $x2cb9d['form-install']['installation-possible?']=true; if (!@isset ($_diagnose['ok?']))c8739(); if($_diagnose['ok?']) { if(__LOG)__log('Installer: everything is fine'); } else { if(__LOG)__log('Installer: problems, tell user'); $x2cb9d['form-install']['installation-possible?']=false; } } if(__LOG)__log('Installer: return'); return $x2cb9d; } function e2_instantiate($h2af72){ global$_instance; $_instance['version']=$h2af72; if (x6e52(USER_FOLDER. '/instance.psa',serialize($_instance))) { return true; } else { die ('Cannot instantiate v'. $h2af72 .': probably permission denied'); } } function e2s_instantiate($parameters){ global$_strings; if(e2_is_installed()) { die ('Remove the file "'. USER_FOLDER .'instance.psa" first'); } else { if(is_numeric($parameters['version'])) { if(e2_instantiate($parameters['version'])) { p8a40($_strings['gs--instantiated-version'] .' v'. $parameters['version'],E2E_MESSAGE); e2_go_to(v83c8('e2m_frontpage', array ('page' => 1))); die; } } } die ('Could not create instance of engine'); } function e2s_install(){ global$settings,$_strings,$_instance,$_config,$vfd6b1,$_folders_written; if(e2_is_installed()) { e2_go_to(v83c8('e2m_install')); die; } else { e2_drop_all_kinds_of_cache(); $cd77d5['server'] = @$_POST['db-server']; $cd77d5['user_name'] = @$_POST['db-user']; $cd77d5['passw'] = j1305(@$_POST['db-password']); $cd77d5['name'] = @$_POST['db-database']; if ( ($l2a304=mysqli_connect( $cd77d5['server'],$cd77d5['user_name'],$_POST['db-password'] )) === false ){ p8a40($_strings['er--cannot-connect-to-db'],E2E_DATABASE_ERROR); e2_go_to(v83c8('e2m_install')); die; } $uaae42=e2_model_data_check($l2a304,$cd77d5['name']); $c0e88b=false; if ($uaae42['occupied'] and $uaae42['migrateable']) { if(__LOG)__log('Installer: DB data exists and migrateable'); $c0e88b=true; } elseif ($uaae42['occupied']) { if(__LOG)__log('Installer: DB data exists, but incomplete'); p8a40($_strings['er--db-data-incomplete'],E2E_DATABASE_ERROR); e2_go_to(v83c8('e2m_install')); die; } $qb2c6c=da618(@$_POST['browser-offset']); foreach ($cd77d5 as $z8ce4b => $q9e366){ rc64a('install_db_' .$z8ce4b,$q9e366); } @session_start(); if (!array_key_exists('password',$_POST) or trim($_POST['password']) == ''){ p8a40($_strings['er--no-password-entered'],E2E_USER_ERROR); e2_go_to(v83c8('e2m_install')); die; } $d88162=trim($_POST['password']); $v2d6d8['sessions'] = array (array ( 'stamp' => time(), 'remote_ip' => $_SERVER['REMOTE_ADDR'], 'key_hash' => ne8ed(true), 'ua' => $_SERVER['HTTP_USER_AGENT'], )); $d444bc=true; if (!f1d21($v2d6d8)) { p8a40($_strings['er--cannot-write-auth-data'],E2E_PERMISSIONS_ERROR); $d444bc=false; } if (!@x6e52(USER_FOLDER.'password-hash.psa',serialize(d4c49($d88162)))) { p8a40($_strings['er--settings-not-saved'],E2E_PERMISSIONS_ERROR); $d444bc=false; } if (!$c0e88b){ $settings=array(); } $settings['db']=$cd77d5; $settings['timezone']=$qb2c6c; $settings['template']=DEFAULT_TEMPLATE; $settings['language']=DEFAULT_LANGUAGE; if (!@x6e52(USER_FOLDER.'settings.json',json_encode($settings,E2_JSON_STYLE))) { p8a40($_strings['er--settings-not-saved'],E2E_PERMISSIONS_ERROR); $d444bc=false; } if ($d444bc){ if(__LOG)__log('Installer: force directories'); foreach($_folders_written as $d45684){ @saf42($d45684); } if ($c0e88b){ if(__LOG)__log('Installer: No need to create DB'); $eba46b=x0f7c(); if ($eba46b){ if(__LOG)__log('Installer: Migrate'); ebb8d(); } else { if(__LOG)__log('Installer: DB not OK'); p8a40($_strings['er--double-check-db-params']); } } else { if(__LOG)__log('Installer: Creating DB...'); $eba46b=( yf1ac('Notes') and yf1ac('Comments') and yf1ac('Keywords') and yf1ac('NotesKeywords') and yf1ac('Aliases') and yf1ac('Actions') and yf1ac('Sources') and yf1ac('GIPsSessions') ); if (!$eba46b){ if(__LOG)__log('Installer: DB not OK'); p8a40($_strings['er--double-check-db-params']); } } if ($eba46b){ if(__LOG)__log('Installer: Search index...'); $addece=g476c(); try { $addece -> erase(); } catch (\S2\Rose\Exception\RuntimeException $e){ if(__LOG)__log('Installer: Rose not available'); } q198f(); if(__LOG)__log('Installer: DB OK, instantiating...'); e2_instantiate(E2_VERSION); if(__LOG)__log('Installer: Done'); if(__LOG)__log('Installer: Complete'); } tcc38(v83c8('e2s_bsi_step', array ())); e2_go_to(); die; } else { e2_go_to(v83c8('e2m_install')); die; } } } function e2_is_installed(){ global$_instance; return (bool)$_instance; } function e2_make_sure_that_installed(){ global $s57de2,$wa57c1,$_instance,$_superconfig; if(e2_is_installed()) { if(E2_VERSION < $_instance ['version']) { if(IGNORE_VERSION_MISMATCH) return; if(__LOG)__log('Installer: cannot downdate'); header('HTTP/1.1 503 Service Unavailable'); die ('E2 does not support automatic downgrade.'); } elseif(E2_VERSION > $_instance ['version']) { if(__LOG)__log('Installer: need to update'); header('Location: http://'. $s57de2.$wa57c1 .'/perform_update/'); header('Location: '. v83c8('e2s_update_perform')); die; } else { if(__LOG)__log('Installer: no job for me'); return; } } if(__LOG)__log('Installer: not installed {'); if ((strpos($_SERVER['SERVER_SOFTWARE'],'Apache')===0)) { if(__LOG)__log('Installer: running on Apache'); $aefe79=DEFAULTS_FOLDER.'default.htaccess'; $rd5c54=false; if (!is_file($aefe79)) { echo 'File not found: '.$aefe79. '. Please use the full E2 installation package.'; die; } if(is_file('.htaccess')) { if(__LOG)__log('Installer: there is a .htaccess file in the installation directory'); $we6f97=file_get_contents($aefe79); $oc6680=file_get_contents('.htaccess'); if ($oc6680!=$we6f97){ $rd5c54=true; $y6a9d4=$id1813='.htaccess.old'; $q3c549=1; while (is_file($id1813)) { $id1813=$y6a9d4 .'.'. $q3c549 ++; } if(__LOG)__log('Installer: existing .htaccess wrong, backing up as <'. $id1813 .'>'); if (!@rename('.htaccess',$id1813)) { if(__LOG)__log('Installer: fuck'); echo 'Looks like you are using Apache and have put an incorrect ".htaccess" file in the installation directory. Additionally, the installer was not able to back up your existing ".htaccess" file in order to replace it with the correct one. Please use the full E2 installation package and grant write access on the installation target directory, all the files and subdirectories.'; die; } } } else { $rd5c54=true; } if ($rd5c54){ if(__LOG)__log('Installer: writing a correct .htaccess file'); if (!@copy($aefe79,'.htaccess')) { if(__LOG)__log('Installer: fuck'); echo 'The installer was not able to create a correct ".htaccess" file. Please grant write access on the installation target directory.'; die; } } } if($_superconfig['disallow_installer']) { die ('Not installed'); } else { $t601f0=v83c8('e2m_install'); if(__LOG)__log('Installer: will need to install, going to '. $t601f0); if(__LOG)__log('}'); e2_go_to($t601f0); die; } } function e2j_check_db_config(){ echo s55fd(); die; } function e2j_list_databases(){ $ccf1e8=$fee11c=$n5f4dc=''; if(array_key_exists('db-server',$_POST)) $ccf1e8= $_POST['db-server']; if(array_key_exists('db-user',$_POST)) $fee11c= $_POST['db-user']; if(array_key_exists('db-password',$_POST))$n5f4dc=$_POST['db-password']; $t32e95=rb154($ccf1e8,$fee11c,$n5f4dc); if ($t32e95) die (implode('|',$t32e95)); die; } function ebb8d(){ global$_db,$_db_error,$_config,$_model; $t851f5=$_config['db_table_prefix']; x0f7c(); if(__LOG)__log('Migrate: start'); if($_db['charset']==='utf8mb4'){ xb01c($t851f5); } else { udb59($t851f5); } s0738('SET sql_quote_show_create=1'); foreach(array_keys($_model) as $vaab9e){ yf1ac($vaab9e); $z7694f="SHOW CREATE TABLE `". $t851f5.$vaab9e ."`"; if(__LOG)__log('Migrate: '. $z7694f); if (s0738($z7694f)) { $x4fded[$vaab9e]=z0d6b(); $x4fded[$vaab9e]=$x4fded[$vaab9e][0]['Create Table']; } else { die ('Database table "'. $t851f5 .$vaab9e .'" not accessible during migration. Check your database availability'); } if (s0738("SHOW INDEX FROM `". $t851f5.$vaab9e ."`")) { $z62699=z0d6b(); $f43eef=array(); foreach ($z62699 as $z6a992){ $z6a992=$z6a992['Key_name']; if(preg_match('/\_[0-9]+$/',$z6a992)) { $f43eef[] = 'DROP INDEX '. $z6a992; } } if(count($f43eef)) { $f43eef=implode(', ',array_unique($f43eef)); s0738( "ALTER TABLE  `". $t851f5.$vaab9e ."` ". $f43eef ); } } if(__LOG)__log('Migrate: '. print_r($x4fded,true)); } if (!strstr($x4fded['Notes'],'`FormatterID`')) { s0738( "ALTER TABLE `". $t851f5."Notes` ". "ADD `FormatterID` VARCHAR( 32 ) DEFAULT 'calliope' NOT NULL AFTER `Text`" ); } if (!strstr($x4fded['Notes'],'`OriginalAlias`')) { s0738( "ALTER TABLE `". $t851f5."Notes` ". "CHANGE `URLName` `OriginalAlias` VARCHAR( 64 ) DEFAULT '' NOT NULL AFTER `FormatterID`" ); } if (!strstr($x4fded['Notes'],'KEY `Stamp` (`Stamp`)')) { s0738( "ALTER TABLE `". $t851f5."Notes` ". "ADD INDEX (`Stamp`);" ); } if(strstr($x4fded['Notes'],'`IP`')) { s0738( "ALTER TABLE `". $t851f5."Notes` ". "DROP `IP`" ); } s0738( "ALTER TABLE `". $t851f5."Notes` ". "CHANGE `Text` `Text` MEDIUMTEXT" ); if (!strstr($x4fded['Notes'],'`IsIndexed`')) { s0738( "ALTER TABLE `". $t851f5."Notes` ". "ADD `IsIndexed` TINYINT( 1 ) DEFAULT '0' NOT NULL AFTER `IsDST`" ); } if (!strstr($x4fded['Notes'],'`Uploads`')) { s0738( "ALTER TABLE `". $t851f5."Notes` ". "ADD `Uploads` MEDIUMTEXT AFTER `OriginalAlias`" ); } s0738( "ALTER TABLE `". $t851f5."Notes` ". "CHANGE `Uploads` `Uploads` MEDIUMTEXT" ); if (!strstr($x4fded['Notes'],'`IsExternal`')) { s0738( "ALTER TABLE `". $t851f5."Notes` ". "ADD `IsExternal` TINYINT(1) DEFAULT '0' NOT NULL AFTER `IsIndexed`" ); } if (!strstr($x4fded['Notes'],'`SourceID`')) { s0738( "ALTER TABLE `". $t851f5."Notes` ". "ADD `SourceID` INT UNSIGNED DEFAULT '0' NOT NULL AFTER `IsExternal`" ); } if (!strstr($x4fded['Notes'],'`SourceNoteID`')) { s0738( "ALTER TABLE `". $t851f5."Notes` ". "ADD `SourceNoteID` INT UNSIGNED DEFAULT '0' NOT NULL AFTER `SourceID`" ); } if (!strstr($x4fded['Notes'],'`SourceNoteURL`')) { s0738( "ALTER TABLE `". $t851f5."Notes` ". "ADD `SourceNoteURL` VARCHAR(255) DEFAULT '' NOT NULL AFTER `SourceNoteID`" ); } if (!strstr($x4fded['Notes'],'`SourceNoteData`')) { s0738( "ALTER TABLE `". $t851f5."Notes` ". "ADD `SourceNoteData` MEDIUMTEXT AFTER `SourceNoteURL`" ); } if (!strstr($x4fded['Notes'],'`SourceNoteJSONURL`')) { s0738( "ALTER TABLE `". $t851f5."Notes` ". "ADD `SourceNoteJSONURL` VARCHAR(255) DEFAULT '' NOT NULL AFTER `SourceNoteData`" ); } if(strstr($x4fded['Notes'],'`SourceMainImageURL`')) { s0738( "ALTER TABLE `". $t851f5."Notes` ". "DROP `SourceMainImageURL`" ); } if(strstr($x4fded['Notes'],'`IsIssue`')) { s0738( "ALTER TABLE `". $t851f5."Notes` ". "DROP `IsIssue`" ); } if (!strstr($x4fded['Notes'],'KEY `SourceID` (`SourceID`)')) { s0738( "ALTER TABLE `". $t851f5."Notes` ". "ADD INDEX (`SourceID`);" ); } if (!strstr($x4fded['Notes'],'KEY `SourceNoteID` (`SourceNoteID`)')) { s0738( "ALTER TABLE `". $t851f5."Notes` ". "ADD INDEX (`SourceNoteID`);" ); } if (!strstr($x4fded['Comments'],'KEY `NoteID` (`NoteID`)')) { s0738( "ALTER TABLE `". $t851f5."Comments` ". "ADD INDEX (`NoteID`);" ); } s0738( "ALTER TABLE `". $t851f5."Comments` ". "CHANGE `Text` `Text` MEDIUMTEXT" ); s0738( "ALTER TABLE `". $t851f5."Comments` ". "CHANGE `Reply` `Reply` MEDIUMTEXT" ); if (!strstr($x4fded['Keywords'],'`OriginalAlias`')) { s0738( "ALTER TABLE `". $t851f5."Keywords` ". "CHANGE `URLName` `OriginalAlias` VARCHAR( 64 ) DEFAULT '' NOT NULL AFTER `Keyword`" ); } s0738( "ALTER TABLE `". $t851f5."Keywords` ". "CHANGE `Description` `Description` MEDIUMTEXT" ); if (!strstr($x4fded['Keywords'],'`Uploads`')) { s0738( "ALTER TABLE `". $t851f5."Keywords` ". "ADD `Uploads` MEDIUMTEXT AFTER `Description`" ); } s0738( "ALTER TABLE `". $t851f5."Keywords` ". "CHANGE `Uploads` `Uploads` MEDIUMTEXT" ); if(strstr($x4fded['Keywords'],'`ParentKeywordID`')) { s0738( "ALTER TABLE `". $t851f5."Keywords` ". "DROP `ParentKeywordID`" ); } if (!strstr($x4fded['Comments'],'`IsGIPUsed`')) { s0738( "ALTER TABLE `". $t851f5."Comments` ". "ADD `IsGIPUsed` TINYINT(1) DEFAULT '0' NOT NULL AFTER `IP`" ); } if (!strstr($x4fded['Comments'],'`GIP`')) { s0738( "ALTER TABLE `". $t851f5."Comments` ". "ADD `GIP` VARCHAR(15) DEFAULT '' NOT NULL AFTER `IsGIPUsed`" ); } if (!strstr($x4fded['Comments'],'`GIPAuthorID`')) { s0738( "ALTER TABLE `". $t851f5."Comments` ". "ADD `GIPAuthorID` VARCHAR(64) DEFAULT '' NOT NULL AFTER `GIP`" ); } if (!strstr($x4fded['Aliases'],'KEY `Alias` (`Alias`)')) { s0738( "ALTER TABLE `". $t851f5."Aliases` ". "ADD INDEX (`Alias`);" ); } if (!strstr($x4fded['Aliases'],'KEY `EntityID` (`EntityID`)')) { s0738( "ALTER TABLE `". $t851f5."Aliases` ". "ADD INDEX (`EntityID`);" ); } if (!strstr($x4fded['Aliases'],'`EntityType`')) { s0738( "ALTER TABLE `". $t851f5."Aliases` ". "ADD `EntityType` VARCHAR( 1 ) DEFAULT '' NOT NULL AFTER `ID`" ); } s0738( "UPDATE `". $t851f5."Aliases` ". "SET `EntityType` = 'n' ". "WHERE `EntityType` = ''" ); if (!strstr($x4fded['Actions'],'`ReadCount`')) { s0738( "ALTER TABLE `". $t851f5."Actions` ". "ADD `ReadCount` INT DEFAULT '0' NOT NULL" ); } if(strstr($x4fded['Actions'],'`HitCount`')) { s0738( "ALTER TABLE `". $t851f5."Actions` ". "DROP `HitCount`" ); s0738( "DELETE FROM `". $t851f5."Actions` ". "WHERE `ReadCount` = 0" ); } if (!strstr($x4fded['GIPsSessions'],'`AuthorEmail`')) { s0738( "ALTER TABLE `". $t851f5."GIPsSessions` ". "ADD `AuthorEmail` VARCHAR(255) DEFAULT '' NOT NULL AFTER `AuthorName`" ); } if (!strstr($x4fded['GIPsSessions'],'`AuthorProfileLink`')) { s0738( "ALTER TABLE `". $t851f5."GIPsSessions` ". "ADD `AuthorProfileLink` VARCHAR(255) DEFAULT '' NOT NULL AFTER `AuthorEmail`" ); } if (!strstr($x4fded['Sources'],'`TrueID`')) { s0738( "ALTER TABLE `". $t851f5."Sources` ". "ADD `TrueID` INT UNSIGNED DEFAULT '0' NOT NULL AFTER `ID`" ); s0738( "UPDATE `". $t851f5."Sources` ". "SET `TrueID` = `ID`" ); } return true; } function udb59($t851f5){ global$_model; foreach(array_keys($_model) as $gd2ffa){ $i4b43b=z07e3($gd2ffa,$t851f5); if ($i4b43b){ $id89e2=$i4b43b['Collation']; if ($id89e2!='utf8_general_ci'){ if(__LOG)__log('Migrate: Convert table '. $gd2ffa. ' to UTF8'); s0738( "ALTER TABLE `". $t851f5.$gd2ffa ."` ". "CONVERT TO CHARACTER SET utf8 COLLATE utf8_general_ci" ); } } } } function e2mig__queries_to_recreate_indexes_for_table_($vaab9e) { $rf78dd=$f4f12d=[]; $z7694f=( "SELECT s.column_name, s.table_name, s.index_name, s.non_unique ". "FROM information_schema.statistics s ". " JOIN information_schema.columns USING (table_name, table_schema, column_name) ". " JOIN information_schema.tables USING (table_name, table_schema) ". "WHERE s.table_schema = DATABASE() AND engine = 'InnoDB' ". " AND column_type like '%varchar%' AND table_name='".$vaab9e."'" ); s0738($z7694f); foreach (z0d6b() as $if1965){ $rf78dd[] = sprintf( "DROP INDEX %s ON %s", $if1965['index_name'], $if1965['table_name'] ); $f4f12d[] = sprintf( "CREATE %s INDEX %s ON %s(%s(191))", $if1965['non_unique']?'':'UNIQUE', $if1965['index_name'], $if1965['table_name'], $if1965['column_name'] ); } return array ($rf78dd,$f4f12d); } function xb01c($t851f5){ global$_model,$_db; $x752cb=bd372(); $w0b95a=array_merge( array_keys($_model), array_values($x752cb) ); $rf78dd=$f4f12d=null; foreach ($w0b95a as $gd2ffa){ $i4b43b=z07e3($gd2ffa,$t851f5); if ($i4b43b){ $id89e2=$i4b43b['Collation']; if(stripos($id89e2,'utf8mb4')!==0){ list ( $rf78dd, $f4f12d )=e2mig__queries_to_recreate_indexes_for_table_($t851f5.$gd2ffa); if ($rf78dd!==null){ if(__LOG){ __log('Migrate: Drop indexes of table '. $gd2ffa); } foreach ($rf78dd as $teaf65){ s0738($teaf65); } } if(__LOG){ __log('Migrate: Convert table '. $gd2ffa. ' to UTF8MB4'); } s0738( "ALTER TABLE `". $t851f5.$gd2ffa ."` ". "CONVERT TO CHARACTER SET utf8mb4" ); if ($f4f12d!==null){ if(__LOG){ __log('Migrate: Recreate indexes of table '.$gd2ffa); } foreach ($f4f12d as $c2464f){ s0738($c2464f); } } } } } } function e2s_migrate(){ ebb8d(); die ('Database migration finished.'); } function e2s_update_perform(){ global$_instance,$_model,$settings,$_config,$_diagnose; $ld98a0=max((int) ($_instance['version']), 2285); if($_instance['version']==E2_VERSION){ s4930(); die; } if ($ld98a0 < 2587){ fc5a6('caches/*'); rmdir('caches'); } if ($ld98a0 < 2691){ $settings=e2_utf8_version_of_array_($settings); if (!@x6e52(USER_FOLDER.'settings.json',json_encode($settings,E2_JSON_STYLE))) { p8a40($_strings['er--cannot-save-data'],E2E_PERMISSIONS_ERROR); p4006(); } } if ($ld98a0 < 2921){ $settings['template']='plain'; } if ($ld98a0 < 3223){ $settings['v3223_rss_permalinks_before_stamp']=time(); } if ($ld98a0 < 3354){ @rename('pictures/userpics/',AVATARS_FOLDER); @unlink(USER_FOLDER. 'password-reset.txt'); } @unlink(USER_FOLDER. 'last-update.psa'); @unlink(CACHES_FOLDER.'index.xml'); @saf42(CACHES_FOLDER); @saf42(BACKUP_FOLDER); @saf42(MEDIA_ROOT_FOLDER.PICTURES_FOLDER .'remote/'); @saf42(MEDIA_ROOT_FOLDER.THUMBNAILS_FOLDER .'remote/'); if (@$settings['template']=='')$settings['template']=DEFAULT_TEMPLATE; if (isset ($settings['appearance']['hot_frontpage'])) { unset($settings['appearance']['hot_frontpage']); } if (isset ($settings['db']['table_prefix'])) { if($settings['db']['table_prefix'] != @$_config['db_table_prefix']) { die ('You’ve been using a database with a table prefix “'. $settings['db']['table_prefix'] .'”. Now this should be set in the configuration. Please add the following line to the file user/config.php:<br /><br />$_config[\'db_table_prefix\'] = \''. $settings['db']['table_prefix'] .'\';<br /><br />Then refresh this page.'); } else { unset($settings['db']['table_prefix']); } } if (isset ($settings['comments']['on'])) { if (!$settings['comments']['on']) { @s0738( "UPDATE LOW_PRIORITY `". $_config['db_table_prefix']."Notes` ". "SET `IsCommentable`=0" ); } $settings['comments']['default_on'] = (bool)$settings['comments']['on']; unset($settings['comments']['on']); } if ( is_file(USER_FOLDER.'settings.json') and is_file(USER_FOLDER.'settings.psa') ) { @unlink(USER_FOLDER.'settings.psa'); } if (!@x6e52(USER_FOLDER.'settings.json',json_encode($settings,E2_JSON_STYLE))) { p8a40($_strings['er--cannot-save-data'],E2E_PERMISSIONS_ERROR); } e2_drop_all_kinds_of_cache(); ebb8d(); if ($ld98a0 < 3386){ if (oa521()) { $addece=g476c(); try { $addece -> erase(); } catch (\S2\Rose\Exception\RuntimeException $e){ if(__LOG)__log('Rose not available'); } } q198f(); } $_diagnose['need?']=true; rc64a('diagnose','1'); e2_instantiate(E2_VERSION); if (ee852()) { p8a40(e2l_get_string('gs--updated-successfully', array ( 'from' => 'v'. $ld98a0, 'to' => 'v'. $_instance['version'], )), E2E_MESSAGE); } e2_go_to(); die; } function x0f7c(){ global$settings,$_db,$_db_error; if (empty($_db['connected'])) { $_db['link'] = @mysqli_connect( 'p:'. $settings['db']['server'], $settings['db']['user_name'], kee85($settings['db']['passw']) ); if (!$_db['link']) { $_db['link'] = @mysqli_connect( 'p:'. $settings['db']['server'], $settings['db']['user_name'], $settings['db']['passw'] ); if($_db['link']) { $settings['db']['passw']=j1305($settings['db']['passw']); if(__LOG){ __log('DB: storing password in a new way'); } @x6e52(USER_FOLDER.'settings.json',json_encode($settings,E2_JSON_STYLE)); } } if (!$_db['link']) { $_db_error=DB_CANNOT_CONNECT; return false; } if (@mysqli_select_db($_db['link'],$settings['db']['name'])) { $_db_error=DB_OK; $_db['connected']=true; $h2af72=mysqli_get_server_info($_db['link']); if(version_compare($h2af72,E2_MINIMUM_MYSQL,'>=')) { $_db['charset']=version_compare($h2af72,'5.5.3','>=')?'utf8mb4':'utf8'; $_db['link'] -> query('SET NAMES '. $_db['charset']); } else { $_db_error=DB_TOO_OLD; return false; } return true; } else { $_db_error=DB_CANNOT_FIND; return false; } } else { $_db_error=DB_OK; return true; } } function s0738($z7694f){ global $p11755,$_db,$_db_error,$_strings; if(__LOG)__log('DB: '. $z7694f); $g9b54f=w7f78(); @$p11755 ++; if (x0f7c()) { if($_db['result']=mysqli_query($_db['link'],$z7694f)) { if(__LOG)__log('DB: done in '. round(w7f78()-$g9b54f,3)); $_db_error=DB_OK; return true; } else { p8a40($_strings['er--error-in-query']. ': <br /><code>'.nl2br($z7694f).'</code><br />'. mysqli_error($_db['link']), E2E_DATABASE_ERROR); $_db_error=DB_QUERY_ERROR; return false; } } else { if($_db_error==DB_CANNOT_FIND){ if(__LOG)__log('DB: cannot find db'); p8a40($_strings['er--cannot-find-db'],E2E_DATABASE_ERROR); } elseif($_db_error==DB_CANNOT_CONNECT){ if(__LOG)__log('DB: cannot connect to db'); p8a40($_strings['er--cannot-connect-to-db'],E2E_DATABASE_ERROR); } elseif($_db_error==DB_TOO_OLD){ if(__LOG)__log('DB: MySQL version too old'); p8a40($_strings['er--error-occurred'].' (DB_TOO_OLD)',E2E_DATABASE_ERROR); } else { if(__LOG)__log('DB: db error '. $_db_error); p8a40($_strings['er--error-occurred'].' ('. $_db_error .')',E2E_DATABASE_ERROR); } return false; } } function z0d6b($type=MYSQLI_ASSOC){ global$_db; $x2cb9d=array(); while ($t0cc17=@mysqli_fetch_array($_db['result'],$type)) { foreach ($t0cc17 as $v865c0 => $n4921c){ if(is_string($n4921c)) { $t0cc17[$v865c0]=$n4921c; } } $x2cb9d[] = $t0cc17; } return $x2cb9d; } function y7928($lb45cf){ global$_db; x0f7c(); return mysqli_real_escape_string($_db['link'],$lb45cf); } function mb488(){ echo '<pre>'; echo 'Sifting backups...<br>'; $o10ae9=array(); foreach(glob(BACKUP_FOLDER. '*.sql') as $o8c7dd){ if(preg_match('/^backup\-(\d+)\-(\d+)\-(\d+)\-at\-(\d+)\-(\d+)\-(\d+)\.sql$/is',basename($o8c7dd),$u9c28d)) { list (, $p41529,$k6f8f5,$v8277e,$b2510c,$v865c0,$a03c7c)=$u9c28d; $a96b8c=gmmktime($b2510c,$v865c0,$a03c7c,$k6f8f5,$v8277e,$p41529); $o10ae9[$a96b8c]=$o8c7dd; } } if(count($o10ae9) > 3){ echo 'More than 3 backups, time to sift...<br>'; $u536a1=-1; $af46c9=array (SECONDS_IN_A_MINUTE,SECONDS_IN_AN_HOUR,SECONDS_IN_A_DAY, -1); $v865c0=0; foreach(array_reverse($o10ae9,true) as $a96b8c => $o8c7dd){ echo '-> '. $o8c7dd .' ('. gmdate('r',$a96b8c) .')<br>'; if ($u536a1 == -1){ echo '   latest, leave<br>'; $u536a1=$a96b8c; } elseif ($af46c9[$v865c0] == -1){ echo '   too old, remove<br>'; unlink($o8c7dd); } else { if ($u536a1-$a96b8c < $af46c9[$v865c0]) { echo '   no need (not long ago), remove<br>'; unlink($o8c7dd); } else { $v865c0 ++; echo '   ok, leave, set interval to '. $af46c9[$v865c0] .'<br>'; $u536a1=$a96b8c; } } } } else { echo 'No need to sift<br>'; } echo '</pre>'; return; } function e2s_dump(){ global$_model,$_db,$_config; if (x0f7c()) { if($_db['link']) { $u68720=time() - (SECONDS_IN_A_DAY); $o9ab2e=array(); foreach(array_keys($_model) as $vaab9e){ $o9ab2e[] = $_config['db_table_prefix'].$vaab9e; } $i07cc6=time(); $v435ed=BACKUP_FOLDER .'backup-'.gmdate('Y-m-d-\a\t-H-i-s',$i07cc6).'.sql'; e2_backup( $_db['link'], $o9ab2e, $v435ed ); mb488(); die ('Backed up.'); } } die ('Could not backup.'); } define('ALIAS_MAX_LENGTH',64); function e2ali__alias_from_title_($r36cd3){ global$_config; $e3e891=$r36cd3; if(array_key_exists('autoreplace_for_aliases',$_config)) { $e3e891=strtr( $e3e891, $_config['autoreplace_for_aliases'] ); } $e3e891=e2l_transliterate($e3e891); $e3e891=str_replace('\'','',$e3e891); $e3e891=str_replace('’','',$e3e891); $e3e891=str_replace(chr(146),'',$e3e891); $x17901=''; for ($v865c0=0; $v865c0 < strlen($e3e891); ++ $v865c0){ if ( (ord($e3e891[$v865c0]) >= 48 and ord($e3e891[$v865c0]) <= 57) or (ord($e3e891[$v865c0]) >= 65 and ord($e3e891[$v865c0]) <= 90) or (ord($e3e891[$v865c0]) >= 97 and ord($e3e891[$v865c0]) <= 122) or 0 ){ $x17901.=$e3e891[$v865c0]; } else { $x17901.='-'; } } $x17901=preg_replace('/\-+/','-',$x17901); $x17901=trim($x17901,'-'); $x17901=strtolower($x17901); if ($x17901=='-')$x17901=''; $x17901=substr($x17901,0,ALIAS_MAX_LENGTH); return $x17901; } function e2_aliasrec_of_alias_($g72487){ global$_config; if (!$g72487 and $g72487!=='0') return false; if (s0738( "SELECT * FROM `". $_config['db_table_prefix']."Aliases` ". "WHERE `Alias` = '". $g72487 ."' ". "ORDER BY Stamp LIMIT 1" )) { $result=z0d6b(); if(count($result)==1){ return$result[0]; } } } function e2_active_alias_for_page_($o89111,$ldffc4){ global$_config,$_e2_active_aliases; if ($ldffc4){ if ( is_array($_e2_active_aliases) and array_key_exists($o89111.$ldffc4,$_e2_active_aliases) ) { return @$_e2_active_aliases[$o89111.$ldffc4]; } else { if (s0738( "SELECT `Alias` ". "FROM `". $_config['db_table_prefix']."Aliases` ". "WHERE `EntityType` = '". $o89111 ."' ". "AND `EntityID` = ". $ldffc4 ." ". "ORDER BY `Stamp` DESC LIMIT 1" )) { $result=z0d6b(); $g72487=$result[0]['Alias']; } if ($g72487==='')$g72487=null; if (!$g72487 and $o89111==ENTITY_TYPE_TAG){ if (s0738( "SELECT OriginalAlias FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE ID = '". ((int)$ldffc4)."'") ) { $result=z0d6b(); $g72487=$result[0]['OriginalAlias']; } } $_e2_active_aliases[$o89111.$ldffc4]=$g72487; } return @$_e2_active_aliases[$o89111.$ldffc4]; } } function bd712($l15d61,$o89111,$ldffc4,$r36cd3,$cfb873=1){ global$_e2_active_aliases; if(__LOG)__log('Aliases: '. $l15d61 .' available alias for source "'. $r36cd3. '"'); if ($l15d61=='set' and (!$o89111 or !$ldffc4)) return false; $x17901=e2ali__alias_from_title_($r36cd3); if ($x17901===''){ $x17901=(string)$cfb873; } elseif ($cfb873 > 1){ $p9f626='-'. $cfb873; $x17901=substr($x17901,0,ALIAS_MAX_LENGTH-strlen($p9f626)) . $p9f626; } if ($cc45dd=e2_aliasrec_of_alias_($x17901)) { $d6bae4=$cc45dd['EntityType']; $j1123c=$cc45dd['EntityID']; if ( (($ldffc4 and $j1123c==$ldffc4) and ($o89111 and $d6bae4==$o89111)) or $x17901!=e2_active_alias_for_page_($d6bae4,$j1123c) ) { if ($l15d61=='find'){ return $x17901; } if ($l15d61=='set'){ if(__LOG)__log('Aliases: update alias timestamp'); if (paa79('Aliases', array ( 'ID' => $cc45dd['ID'], 'EntityType' => $o89111, 'EntityID' => $ldffc4, 'Alias' => $x17901, 'Stamp' => time(), ))) { return$_e2_active_aliases[$o89111.$ldffc4]=$x17901; } } } else { return bd712($l15d61,$o89111,$ldffc4,$r36cd3,$cfb873+1); } } else { if ($o89111 and $ldffc4 and $x17901==''){ if(e2_active_alias_for_page_($o89111,$ldffc4)==''){ return ''; } } if ( $o89111==ENTITY_TYPE_TAG and $bd62e3=p8770($x17901) ) { if ($bd62e3['ID']!=$ldffc4){ return bd712($l15d61,$o89111,$ldffc4,$r36cd3,$cfb873+1); } } if ($l15d61=='find'){ return $x17901; } if ($l15d61=='set'){ if (f9943('Aliases', array ( 'EntityType' => $o89111, 'EntityID' => $ldffc4, 'Alias' => $x17901, 'Stamp' => time(), ))) { return$_e2_active_aliases[$o89111.$ldffc4]=$x17901; } } } return ''; } function e2m_note($parameters=array ()) { global $settings, $s57de2, $_config, $_superconfig, $_strings; if(__LOG)__log('Note {'); $iaad65=$parameters['*note']; if ($iaad65==false){ return e2_error404_mode(); } if (!jb44b($iaad65,ee852())) { return e2_error404_mode(); } $td58c0=v83c8('e2m_note',$parameters); if(__LOG)__log('Navigation {'); $wfcb08=jcca7($iaad65,'prev'); $zd0cab=jcca7($iaad65,'next'); if ($wfcb08){ $ub3b32['prev-href']=v83c8('e2m_note', array ('*note' => $wfcb08)); $ub3b32['prev-title']=i6f10(htmlspecialchars($wfcb08['Title'],ENT_NOQUOTES,HSC_ENC)); } if ($zd0cab){ $ub3b32['next-href']=v83c8('e2m_note', array ('*note' => $zd0cab)); $ub3b32['next-title']=i6f10(htmlspecialchars($zd0cab['Title'],ENT_NOQUOTES,HSC_ENC)); } $ub3b32['title']=$_strings['nm--posts']; $ub3b32['timeline?']=false; $ub3b32['this-title']=i6f10(htmlspecialchars($iaad65['Title'],ENT_NOQUOTES,HSC_ENC)); if(__LOG)__log('}'); if(__LOG)__log('Packaging...'); $iaad65['_']['_id']=$iaad65['ID']; $iaad65['_']['_ord']=0; $iaad65['_']['_ord_max']=0; $k8e4cd=r6791($iaad65); $re35b1=''; $r33ff2=false; $p905f7=false; $y7bae4=array(); $id09b4=''; if (ee852()) { $k83625=e2_note_cache_filename_with_id_($iaad65['_']['_id'] .'-comments-author'); } else { $k83625=e2_note_cache_filename_with_id_($iaad65['_']['_id'] .'-comments'); } $p1e8cc=null; if(CACHE_NOTES_COMMENTS and is_file($k83625)) { $p1e8cc=@unserialize(file_get_contents($k83625)); } if(__LOG)__log('Comments {'); if(is_array($p1e8cc)) { if(__LOG)__log('retrieve cached ctree'); $re35b1=$p1e8cc; } else { if(__LOG)__log('assemble ctree...'); $gc1fdc=i70a7($iaad65['ID']); $ja5d49=array(); $n04c25=true; foreach ($gc1fdc as $z8ce4b => $h4032b){ if ($h4032b['IsVisible']) { $h4032b['_']['_id']=$h4032b['ID']; $h4032b['_']['_ord']=$z8ce4b; $h4032b['_']['_ord_max']=count($gc1fdc)-1; $f06d4c=v86f8( $iaad65, $h4032b, $z8ce4b+1 ); if ($f06d4c['new?'] and $n04c25){ $f06d4c['first-new?']=true; $n04c25=false; } $ja5d49[] = $f06d4c; } } $re35b1=$ja5d49; if(CACHE_NOTES_COMMENTS)x6e52($k83625,serialize($re35b1)); } if(__LOG)__log('} // Comments'); if (!@$_config['read_only'] and $k8e4cd['commentable-now?']) { $e80f02=d66aa($iaad65); $e80f02['.comment-number']=count($re35b1)+1; } if (ee852() and sb387($iaad65,NOTE_COMMENTABLE_NOW_CONDITIONALLY)) { if ($iaad65['IsCommentable']) { $y7bae4['href']=v83c8('e2m_note_flag', array ( '*note' => $iaad65, 'flag' => 'IsCommentable', 'value' => 0, )); $y7bae4['text']=$_strings['bt--close-comments-to-post']; } else { $y7bae4['href']=v83c8('e2m_note_flag', array ( '*note' => $iaad65, 'flag' => 'IsCommentable', 'value' => 1, )); $y7bae4['text']=$_strings['bt--open-comments-to-post']; } } if ( ee852() and array_key_exists('new-comments-count',$k8e4cd) and $k8e4cd['new-comments-count'] ) { if(__LOG)__log('mark comments as not new'); e2_drop_caches_for_note_($z21158); paa79('Comments', array ('IsNew' => 0), array ('NoteID' => $iaad65['_']['_id'])); } if(__LOG)__log('more work...'); $pe70c4['title']=$iaad65['Title']; $pe70c4['pages']=$ub3b32; $pe70c4['summary']=$k8e4cd['summary']; $pe70c4['notes'] = array ('only' => $k8e4cd); if ($re35b1) $pe70c4['comments']['each']=$re35b1; if ($y7bae4) $pe70c4['comments']['toggle']=$y7bae4; $pe70c4['comments']['count']=$k8e4cd['comments-count']; $pe70c4['comments']['count-text']=$k8e4cd['comments-count-text']; $pe70c4['comments']['new-count']=$k8e4cd['new-comments-count']; $pe70c4['comments']['new-count-text']=$k8e4cd['new-comments-count-text']; $pe70c4['comments']['commentable-now?']=$k8e4cd['commentable-now?']; if ($e80f02)$pe70c4['form-comment']=$e80f02; if(__LOG)__log('} // Note'); return $pe70c4; } function e2m_note_read($parameters=array ()) { if(__LOG)__log('Note read {'); $iaad65=$parameters['*note']; $vff089=time(); $vff089=$vff089 - ($vff089 % SECONDS_IN_AN_HOUR); f9943( 'Actions', array ( 'EntityID' => $iaad65['ID'], 'Stamp' => $vff089, 'ReadCount' => 1, ), 'INSERT LOW_PRIORITY', 'ON DUPLICATE KEY UPDATE `ReadCount` = `ReadCount` + 1' ); if(__LOG)__log('}'); e2_go_to(v83c8('e2m_note',$parameters)); } function e2m_note_withdraw($parameters=array ()) { global$_strings; $pea59a=$parameters['*note']; if (!$pea59a) return e2_error404_mode(); $w22db1=v83c8('e2m_note_broadcast', array ('*note' => $pea59a)); $pea59a['IsPublished']=0; $pea59a['IsCommentable']=0; $pea59a['IsVisible']=1; $pea59a['Stamp']=time(); $pea59a['IP']=$_SERVER['REMOTE_ADDR']; if($parameters['alias']) { $pea59a['OriginalAlias']=$parameters['alias']; } else { $pea59a['OriginalAlias']=bd712( 'find',ENTITY_TYPE_NOTE,$pea59a['ID'],$pea59a['Title'] ); } e2_drop_caches_for_note_($pea59a['ID']); @unlink(CACHE_FILENAME_DRAFTS); @unlink(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); if ($pea59a['IsFavourite']) { @unlink(CACHE_FILENAME_FAVS); } if (paa79('Notes',$pea59a)) { i10fe($pea59a['ID']); tcc38($w22db1); bd712('set',ENTITY_TYPE_NOTE,$pea59a['ID'],''); e2_go_to(v83c8('e2m_draft', array ( 'draft' => $z21158, 'oalias' => $pea59a['OriginalAlias'], ))); } else { s4930(); } } function e2m_note_delete($parameters=array()) { global$_strings; $pea59a=$parameters['*note']; if (!$pea59a) return e2_error404_mode(); $vf91b2=!$pea59a['IsPublished']; if ($vf91b2){ $q72bd7=e2l_get_string('gs--draft-will-be-deleted', array ( 'draft' => htmlspecialchars($pea59a['Title'],ENT_NOQUOTES,HSC_ENC), )); } else { $q72bd7=e2l_get_string('gs--post-will-be-deleted', array ( 'post' => htmlspecialchars($pea59a['Title'],ENT_NOQUOTES,HSC_ENC), )); } $ud5d3d=$vf91b2? $_strings['pt--draft-deletion']:$_strings['pt--post-deletion']; $q57529=array ( '.note-id' => $pea59a['ID'], '.is-draft' => (int)$vf91b2, 'note-title' => htmlspecialchars($pea59a['Title'],ENT_COMPAT,HSC_ENC), 'caution-text' => $q72bd7, 'form-action' => v83c8('e2s_note_delete'), 'submit-text' => $_strings['fb--delete'], 'draft?' => (int)$vf91b2, ); if ($pea59a['IsPublished']) { $q57529['withdraw-href']=v83c8( 'e2m_note_withdraw',$parameters ); } $x2cb9d=array ( 'title' => $ud5d3d. ': '. htmlspecialchars($pea59a['Title'],ENT_NOQUOTES,HSC_ENC), 'heading' => $ud5d3d, 'form' => 'form-note-delete', 'form-note-delete' => $q57529, ); return $x2cb9d; } function e2m_note_flag_favourite($parameters){ global$_config; $parameters['flag']='IsFavourite'; if (i7e6c($parameters)) { $v67142=$parameters; $v67142['value'] = !$parameters['value']; if($parameters['value']==1){ $p99859=v83c8('e2m_note_flag_favourite',$v67142); $q1fa03='on-rehref|'. $p99859; } else { $p99859=v83c8('e2m_note_flag_favourite',$v67142); $q1fa03='off-rehref|'. $p99859; } } else { $q1fa03='error'; } if(array_key_exists('result',$_POST) and ($_POST['result']=='ajaxresult')) { die ($q1fa03); } else { e2_go_to(v83c8('e2m_note',$parameters)); die; } } function e2m_note_flag($parameters){ i7e6c($parameters); if(array_key_exists('draft',$parameters)) { e2_go_to(v83c8('e2m_draft',$parameters)); } else { e2_go_to(v83c8('e2m_note',$parameters)); } die; } function i7e6c($parameters){ $z21158=$parameters['*note']['ID']; if (!is_numeric($z21158)) { return e2_error404_mode(); } e2_drop_caches_for_note_($z21158); if($parameters['flag']=='IsFavourite'){ @unlink(CACHE_FILENAME_FAVS); } if($parameters['flag']=='IsVisible'){ z7996(); } $result=paa79('Notes', array ( 'ID' => $z21158, $parameters['flag'] => (int) ($parameters['value']==1), )); $b39a37=h4627($z21158); i5b68($b39a37); return$result; } function e2m_note_use_formatter($parameters){ $z21158=$parameters['*note']['ID']; if (!is_numeric($z21158)) { return e2_error404_mode(); } e2_drop_caches_for_note_($z21158); if (!$parameters['*note']['IsPublished']) { @unlink(CACHE_FILENAME_DRAFTS); } if(in_array($parameters['formatter'], array ('calliope','raw','neasden'))) { $result=paa79('Notes', array ( 'ID' => $z21158, 'FormatterID' => $parameters['formatter'], )); echo 'formatter set to '. $parameters['formatter']; } else { echo 'unknown formatter'; } die; } function e2m_note_edit($parameters=array ()) { return p7dd3('edit',$parameters); } function p7dd3($m60cd8,$parameters=array ()) { global$full_blog_url,$_strings,$_config; $ud5d3d=$_strings['pt--new-post']; $of74f5=$_strings['pt--new-post']; $z21158='new'; $n9763c=$_config['default_formatter']; if ($m60cd8=='edit'){ $pea59a=$parameters['*note']; if (!$pea59a) return e2_error404_mode(); if ($pea59a){ if ($pea59a['IsPublished']) { $of74f5=$_strings['pt--edit-post']; $j3aa13=''; $g72487=$parameters['alias']; } else { $of74f5=$_strings['pt--edit-draft']; $j3aa13=bd712( 'find',ENTITY_TYPE_NOTE,$pea59a['ID'],$pea59a['Title'] ); if (@$pea59a['OriginalAlias']) { $g72487=$pea59a['OriginalAlias']; } else { $g72487=$j3aa13; } } } $z21158=$pea59a['ID']; $n9763c=$pea59a['FormatterID']; $ud5d3d=$pea59a['Title']; } $p04868=e5d57(); $n77b75=array(); foreach ($p04868 as $cd7df5){ $n77b75[] = $cd7df5['tag']; } $kd2e3e=array(); if ($m60cd8=='edit' and count($n77b75)) { $p04868=za463($pea59a['ID']); foreach ($p04868 as $cd7df5){ $kd2e3e[] = htmlspecialchars($cd7df5['Keyword'],ENT_NOQUOTES,HSC_ENC); } } $hc93df=array(); foreach ($n77b75 as $cd7df5){ $nfd2ef['name']=$cd7df5; $nfd2ef['selected?']=in_array($cd7df5,$kd2e3e); $hc93df[] = $nfd2ef; } $o9dbb8=''; $kd2e3e=implode(', ',$kd2e3e); if ($kd2e3e)$o9dbb8=$kd2e3e; if ($m60cd8=='write'){ $rc50d0=$_strings['fb--save-and-preview']; } if ($m60cd8=='edit'){ if(array_key_exists('draft',$parameters)) { $rc50d0=$_strings['fb--save-and-preview']; } else { $rc50d0=$_strings['fb--save-changes']; } } $ce449c=array(); if ($m60cd8=='edit'){ $ce449c=yc0c4( $pea59a['FormatterID'],$pea59a['Text'],'full' ); } $c75e1b=zf898( 'note',$z21158,$ce449c ); if ($m60cd8=='edit'){ l2f83( 'Notes', $pea59a, $ce449c ); } $a96b8c=min($pea59a['Stamp'],time()); $fc999b=ud10e(); $x2cb9d['title']=$ud5d3d; $x2cb9d['heading']=$of74f5; $x2cb9d['form']='form-note'; $x2cb9d['body-uploads-enabled?']=o1363($fc999b); $x2cb9d['form-note'] = array ( '.note-id' => $z21158, '.formatter-id' => $n9763c, '.from' => substr($_SERVER['HTTP_REFERER'],strlen($full_blog_url)+1), '.old-tags-hash' => md5($o9dbb8), '.action' => $m60cd8, 'form-action' => v83c8('e2s_note_process'), 'form-note-livesave-action' => v83c8('e2j_note_livesave'), 'form-file-upload-action' => v83c8('e2j_file_upload'), 'form-file-remove-action' => v83c8('e2j_file_remove'), 'create:edit?' => (bool) ($m60cd8=='write'), 'title' => htmlspecialchars($pea59a['Title'],ENT_COMPAT,HSC_ENC), 'tags' => $o9dbb8, 'tags-info' => $hc93df, 'text' => htmlspecialchars($pea59a['Text'],ENT_NOQUOTES,HSC_ENC), 'uploads' => $c75e1b, 'uploads-enabled?' => o1363($fc999b), 'all-tags' => $n77b75, 'stamp-formatted' => w5a2f('d.m.Y H:i:s',$a96b8c,m0923($pea59a)), 'time' => $pea59a['IsPublished']? array ((int)$a96b8c,m0923($pea59a)) : false, 'alias-autogenerated' => $j3aa13, 'alias' => $g72487, 'submit-text' => $rc50d0, 'space-usage' => gaf64($fc999b), ); if (!$s85faf){ } if ($m60cd8=='edit'){ $x2cb9d['related-delete-href']=v83c8( 'e2m_note_delete', array ('*note' => $pea59a) ); if (!array_key_exists('draft',$parameters)) { $pea59a['_']['_id']=$pea59a['ID']; $pea59a['_']['_ord']=0; $pea59a['_']['_ord_max']=0; $x2cb9d['form-note']['note']=r6791($pea59a); } } return $x2cb9d; } function e2m_write(){ return p7dd3('write'); } function e2s_note_process(){ global$_fp_error,$_strings; $z21158=ba21e(); if (!$z21158){ if($_fp_error==FP_TITLE_OR_TEXT_EMPTY){ p8a40($_strings['er--post-must-have-title-and-text'],E2E_USER_ERROR); } elseif($_fp_error==FP_NO_ID_OR_NEW){ } else { p8a40($_strings['er--error-occurred']); } e2_go_to(v83c8('e2m_write')); die; } $iaad65=h4627($z21158); if ($iaad65['IsPublished']) { e2_go_to(v83c8('e2m_note', array ('*note' => $iaad65))); } else { e2_go_to(v83c8('e2m_draft', array ('*note' => $iaad65))); } die; } function e2s_note_publish(){ global$_strings,$_config,$settings; $z21158=false; if(array_key_exists('note-id',$_POST)) { $z21158=$_POST['note-id']; $yaddfe=false; $pea59a=h4627($z21158); $q82b30=$pea59a['OriginalAlias']; $y098ae=$pea59a['Stamp']; $cbb4fe=!$pea59a['IsExternal']; $pea59a['ID']=$z21158; $pea59a['IsVisible']=1; $pea59a['IsPublished']=1; $pea59a['IsCommentable'] = (int)$settings['comments']['default_on']; $pea59a['IsFavourite']=0; if(array_key_exists('browser-offset',$_POST)) { $qb2c6c=da618(@$_POST['browser-offset']); } else { $qb2c6c=false; } if ($yaddfe and $a96b8c=u1630($yaddfe,$qb2c6c)) { $pea59a['Stamp']=$a96b8c; } elseif ($cbb4fe){ $pea59a['Stamp']=time(); } else { $pea59a['Stamp']=$y098ae; } od2e1($pea59a); if ($qb2c6c){ $pea59a['Offset'] = (int)$qb2c6c['offset']; $pea59a['IsDST'] = (int)$qb2c6c['is_dst']; } e2_drop_caches_for_note_($z21158); @unlink(CACHE_FILENAME_DRAFTS); @unlink(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); if (paa79('Notes',$pea59a)) { $g72487=''; if ($q82b30 or $q82b30==='0'){ $g72487=bd712('set',ENTITY_TYPE_NOTE,$z21158,$q82b30); $pea59a['OriginalAlias']=$g72487; } if ($g72487!=$q82b30){ paa79('Notes',$pea59a); } if (jb44b($pea59a)) { i5b68($pea59a); } e2_go_to(v83c8('e2m_note', array ('*note' => $pea59a))); die; } else { s4930(); die; } } e2_go_to(); die; } function ue268($z21158,$d9a92d=-1){ global$_config; e2_drop_caches_for_note_($z21158); if ($d9a92d or $d9a92d === -1){ @unlink(CACHE_FILENAME_DRAFTS); @unlink(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); } if (!$d9a92d or $d9a92d === -1) { @unlink(CACHE_FILENAME_FAVS); } if (s0738( "DELETE FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `ID` = '".((int)$z21158)."'" )) { i10fe($z21158); s0738( "DELETE FROM `". $_config['db_table_prefix']."Aliases` ". "WHERE `EntityID`=". ((int)$z21158) ); s0738( "DELETE FROM `". $_config['db_table_prefix']."NotesKeywords` ". "WHERE `NoteID`=". ((int)$z21158) ); return true; } } function e2s_note_delete(){ global$_strings,$_config; $z21158=$_POST['note-id']; $d9a92d=(bool)$_POST['is-draft']; $pea59a=h4627($z21158); $w22db1=v83c8('e2m_note_broadcast', array ('*note' => $pea59a)); if (ue268($z21158,$d9a92d)) { tcc38($w22db1); if ($d9a92d){ e2_go_to(v83c8('e2m_drafts')); } else { e2_go_to(); } } die; } function e2j_note_livesave(){ die (ba21e('ajaxresult')); } function r6791($iaad65,$o8698e=false){ global $settings, $_config, $_superconfig, $_candy, $_current_tag, $s57de2, $ke5564, $full_blog_url; if (!is_numeric($iaad65['_']['_id'])) return false; $xda497=e2_note_cache_filename_with_id_($iaad65['_']['_id']); $de244c=null; if(CACHE_NOTES and is_file($xda497)) { $de244c=@unserialize(file_get_contents($xda497)); } if(__LOG)__log('Notes: package note <'. $iaad65['_']['_id'] .'>...'); $be919a=w7f78(); if(CACHE_NOTES and is_array($de244c)) { if(__LOG)__log('Notes: retrieve cached ctree'); $mc6827=$de244c; } else { if(__LOG)__log('Notes: assemle cacheable ctree...'); if(__LOG)__log('Notes: formatter ID = '. $iaad65['FormatterID']); $e2bfe4=q154e($iaad65['FormatterID'], @$iaad65['Text'],'full'); $mc6827['title'] = i6f10(htmlspecialchars($iaad65['Title'],ENT_NOQUOTES,HSC_ENC)); $mc6827['text'] = $e2bfe4['text-final']; $mc6827['summary'] = x5421($mc6827['text']); $mc6827['format-info'] = $e2bfe4['meta']; $mc6827['time'] = array ((int)$iaad65['Stamp'],m0923($iaad65)); $mc6827['last-modified'] = array ((int)$iaad65['LastModified'],m0923($iaad65)); $mc6827['last-ip'] = $iaad65['IP']; $mc6827['published?'] = (bool)$iaad65['IsPublished']; $mc6827['commentable?'] = (bool) ($iaad65['IsCommentable'] && $iaad65['IsPublished']); $mc6827['favourite?'] = (bool) ($iaad65['IsFavourite'] && $iaad65['IsPublished']); $mc6827['visible?'] = jb44b($iaad65); $mc6827['scheduled?'] = false; $ud972d=@$iaad65['SourceNoteData']; $ud972d=@json_decode($ud972d,true); $mc6827['source-main-image-url'] = @$ud972d['og_images'][0]; if(is_array($e2bfe4['meta']['resources-detected'])) { j6be4($e2bfe4['meta']['resources-detected']); } if (!$mc6827['published?'])$mc6827['time']=$mc6827['last-modified']; $mc6827['og-images']=hdbcc( 'note',$iaad65['_']['_id'], $mc6827['format-info']['resources-detected'] ); $k0dff3=sce23($iaad65['ID']); $fd57ac=array(); foreach ($k0dff3 as $v865c0 => $sb19ad){ $mc6827['og-images']=array_merge( $mc6827['og-images'], hdbcc('tag',$sb19ad['ID'], array ()) ); $me4d23['name']=htmlspecialchars($sb19ad['Keyword'],ENT_NOQUOTES,HSC_ENC); $me4d23['href']=v83c8('e2m_tag', array ('*tag' => $sb19ad)); $fd57ac[] = $me4d23; } $mc6827['tags']=$fd57ac; if (@in_array(SYSTEM_LIBRARY_FOLDER. 'jouele/jouele.js',$e2bfe4['meta']['links-required'])) { $mc6827['playlist?']=true; } $p905f7=p254f($iaad65['ID']); if ($mc6827['published?']) { $mc6827['comments-count']=$p905f7; } $de244c=$mc6827; if(CACHE_NOTES) @x6e52($xda497,serialize($de244c)); } if ($o8698e){ if(__LOG)__log('Notes: short-track package for caching only'); if(__LOG)__log('Notes: package note done in '. round(w7f78()-$be919a,3)); return $mc6827; } if(__LOG)__log('Notes: continue with the uncacheable, '. round(w7f78()-$be919a,3) .' so far...'); $mc6827['commentable-now?']=sb387($iaad65); if(array_key_exists('comments-count',$mc6827)) { $mc6827['comments-count-text']=e2l_get_string('gs--n-comments', array ( 'number' => $mc6827['comments-count'] )); } foreach ($mc6827['tags'] as $z8ce4b => $q9e366){ $mc6827['tags'][$z8ce4b]['current?'] = (bool) ($mc6827['tags'][$z8ce4b]['name']==$_current_tag); } $a2e88c=$iaad65['IsPublished']?'e2m_note':'e2m_draft'; $mc6827['href']=v83c8($a2e88c, array ('*note' => $iaad65)); if ($iaad65['IsPublished']) { if ($iaad65['OriginalAlias']) { $mc6827['href-original']=v83c8('e2m_note', array ('alias' => $iaad65['OriginalAlias'])); } else { $s010d9=$iaad65; $s010d9['__noalias!']=true; $mc6827['href-original']=v83c8('e2m_note', array ('*note' => $s010d9)); } } $mc6827=array_merge($mc6827,v1a48($iaad65,true)); $mc6827['comments-link?'] = (bool) ( $iaad65['IsPublished'] && (sb387($iaad65) or ($mc6827['comments-count'] > 0)) && ('e2m_note'!=$_candy) ); if (ee852()) { $afe9e2=q3ce7($iaad65['ID']); $mc6827['new-comments-count']=$afe9e2; $mc6827['new-comments-count-text']=e2l_get_string('gs--comments-n-new', array ( 'number' => $afe9e2 )); if ($iaad65['IsPublished']) { if ($iaad65['IsFavourite']) { $mc6827['favourite-toggle-href']=v83c8( 'e2m_note_flag_favourite', array ('*note' => $iaad65,'value' => 0) ); } else { $mc6827['favourite-toggle-href']=v83c8( 'e2m_note_flag_favourite', array ('*note' => $iaad65,'value' => 1) ); } } if (!@$_config['read_only']) { $mc6827['edit-href']=v83c8( 'e2m_note_edit', array ('*note' => $iaad65) ); $v9920c=$mc6827['edit-href']; } } if($settings['appearance']['show_sharing_buttons']) { $beb769=$_config['share_to']; $e21bdd='|twitter|facebook|gplus|vkontakte|telegram|linkedin|whatsapp|'; if (@$_config['share_to_twitter_via']) { $p8d777['twitter']['via']=$_config['share_to_twitter_via']; } if(count($mc6827['og-images']) > 0){ $n62933=$mc6827['og-images'][0]; $e21bdd.='pinterest|'; $p8d777['pinterest']['media']=$n62933; } $mc6827['shareable?']=false; foreach(explode(',',$beb769) as $n5a9d3){ $n5a9d3=trim($n5a9d3); if(strstr($e21bdd,'|'. $n5a9d3. '|')) { $mc6827['shareable?']=true; $mc6827['share-to'][$n5a9d3]['share?']=true; if ($p8d777[$n5a9d3]) { $mc6827['share-to'][$n5a9d3]['data']=$p8d777[$n5a9d3]; } } } } if(array_key_exists('_',$iaad65))$mc6827['_']=$iaad65['_']; if(__LOG)__log('Notes: package note done in '. round(w7f78()-$be919a,3)); return $mc6827; } function h4627($sb80bb){ global$_strings,$_config; if (s0738( "SELECT * FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `ID` = '".$sb80bb."'" )) { $bfa816=z0d6b(); if(count($bfa816) > 0){ return $bfa816[0]; } else { return false; } } else { p8a40($_strings['er--cannot-get-post-from-db'],E2E_DATABASE_ERROR); s4930(); die; } } function wc37f($z21158,$action){ global$_config; if (s0738( "SELECT SUM(`". $action ."`) ". $action ." ". "FROM `". $_config['db_table_prefix']."Actions` ". "WHERE `EntityID` = ". $z21158 )) { $bfa816=z0d6b(); if(count($bfa816) > 0){ return $bfa816[0][$action]; } else { return false; } } else { return false; } } function jcca7($iaad65,$lb4ca4,$z8f888=1){ global$_strings,$_config; $j7ffc4=($lb4ca4=='next')?'>':'<'; $c9b272=($lb4ca4=='next')?'':'DESC '; if (s0738( "SELECT * FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `IsPublished`=". $z8f888 ." ". "AND `Stamp` ". $j7ffc4 ." '". $iaad65['Stamp'] ."' ". a6f32(ee852()). "ORDER BY STAMP ". $c9b272 . "LIMIT 1" )) { $bfa816=z0d6b(); if(count($bfa816) > 0) return $bfa816[0]; else return FALSE; } else { p8a40($_strings['er--cannot-get-post-from-db'],E2E_DATABASE_ERROR); s4930(); die; } } function na2d8($wddf82){ global$_config; if(__LOG)__log('Lastmodifieds for Local Copier'); if(CACHE_LASTMODIFIEDS and is_file(CACHE_FILENAME_LASTMODIFIEDS)) { $m84636=@unserialize(file_get_contents(CACHE_FILENAME_LASTMODIFIEDS)); if ($m84636['ids_csv']==$wddf82){ if(__LOG)__log('Returned from cache'); return $m84636['lastmodifieds_json']; } } $f56790='WHERE `ID`='. str_replace(',',' OR `ID`=',$wddf82); $eb7d96=array(); if (s0738( "SELECT `ID`, `LastModified` ". "FROM `". $_config['db_table_prefix']."Notes` ". $f56790 )) { if(__LOG)__log('Requested from DB'); $result=z0d6b(); foreach($result as $z8ce4b => $q9e366){ $eb7d96[(int)$q9e366['ID']] = (int)$q9e366['LastModified']; } } $n08bb9=json_encode($eb7d96); if ($n08bb9=='[]')$n08bb9='{}'; $m84636=array ( 'ids_csv' => $wddf82, 'lastmodifieds_json' => $n08bb9, ); if(CACHE_LASTMODIFIEDS){ x6e52(CACHE_FILENAME_LASTMODIFIEDS,serialize($m84636)); } return $n08bb9; } function zd864($p8d777){ global$settings,$x71860,$_strings; $z7694f=$p8d777['query']; if (isset ($p8d777['page']) and $p8d777['page'] < 1) return e2_error404_mode(); $vd7e5d=$settings['appearance']['notes_per_page']; $ub3b32=array(); $mfbb44=false; if (isset ($p8d777['page'])) { $x71860=$p8d777['page']; $z7694f.=' LIMIT '.($p8d777['page']-1)*$vd7e5d.', '.$vd7e5d; $o61e23=str_replace('SELECT *','SELECT count(*)',$p8d777['query']); if (s0738($o61e23)) { $result=z0d6b(); $mfbb44=$result[0]['count(*)']; $kae0fe=ceil($mfbb44/$vd7e5d); if ($x71860 > $kae0fe and $x71860!=1){ return e2_error404_mode(); } $ub3b32['count']=$kae0fe; $ub3b32['this']=$x71860; $ub3b32['timeline?']=true; $ub3b32['earlier-title']=$_strings['gs--earlier']; $ub3b32['later-title']=$_strings['gs--later']; $w920fa=$p8d777['parameters']; if ($x71860 < $kae0fe){ $w920fa['page']=$x71860+1; $ub3b32['earlier-href']=v83c8($p8d777['candy'],$w920fa); } if ($x71860 > 1){ $w920fa['page']=$x71860-1; $ub3b32['later-href']=v83c8($p8d777['candy'],$w920fa); } } else { return array (); } } $b4358b=array(); if (s0738($z7694f)) { $result=$pe5b87=z0d6b(); if (@$p8d777['query-returns-only-ids']) { $result=array(); $m15514=ee852(); foreach ($pe5b87 as $iaad65){ $iaad65=h4627($iaad65['ID']); if ($iaad65['IsPublished'] and jb44b($iaad65,$m15514)) { $result[] = $iaad65; } } } foreach($result as $z8ce4b => $iaad65){ $iaad65['_']['_id']=$iaad65['ID']; $iaad65['_']['_ord']=$z8ce4b; $iaad65['_']['_ord_max']=count($result)-1; $b4358b[] = r6791($iaad65); } } else { return array (); } $b05a16=$b4358b; if (!isset ($p8d777['show-all-notes']) or @$p8d777['show-all-notes']!=true){ $b05a16=array_slice($b4358b,0,$vd7e5d); } if ($mfbb44===false)$mfbb44=count($b05a16); if (!count($b4358b) and array_key_exists('nothing',$p8d777)) { $x2cb9d['nothing']=$p8d777['nothing']; } $pcd0fd=array ( 'class', 'superheading', 'heading', 'title', 'search-related-tag', ); foreach ($pcd0fd as $qf97bf){ if(array_key_exists($qf97bf,$p8d777)) { $x2cb9d[$qf97bf]=$p8d777[$qf97bf]; } } if ($mfbb44){ $i5cde2=e2l_get_string( 'pt--n-posts', array ('number' => $mfbb44) ); } else { $i5cde2=$_strings['pt--no-posts']; } if(array_key_exists('maximum-notes',$p8d777) and $mfbb44 >= $p8d777['maximum-notes']) { $i5cde2=$_strings['gs--many-posts']; } foreach (array ('title','heading','superheading') as $w4b24c){ if(strstr($p8d777[$w4b24c],'%total%')) { $x2cb9d[$w4b24c]=str_replace('%total%', $i5cde2,$p8d777[$w4b24c]); } } $x2cb9d['notes']=$b05a16; $x2cb9d['pages']=$ub3b32; return $x2cb9d; } function pf9fb($p41529,$k6f8f5,$v8277e=false){ global$_config; list ($m7b314,$va1f20)=l5273($p41529,$k6f8f5,$v8277e); if (s0738( "SELECT * FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished` AND (`Stamp` BETWEEN " .$m7b314. " AND " .$va1f20. ")". "ORDER BY Stamp" )) { $result=z0d6b(); $wb1bc2=1; $x2cb9d=array(); foreach($result as $o65afd){ if(is_numeric($v8277e)) { $c3f917=((int)$p41529) .'/'. ((int)$k6f8f5) .'/'. ((int)$v8277e) == w5a2f('Y/n/j',$o65afd['Stamp'],m0923($o65afd)); } elseif(is_numeric($k6f8f5)) { $c3f917=((int)$p41529) .'/'. ((int)$k6f8f5) == w5a2f('Y/n',$o65afd['Stamp'],m0923($o65afd)); } else { $c3f917=((int)$p41529) == w5a2f('Y',$o65afd['Stamp'],m0923($o65afd)); } if ($c3f917){ if(is_numeric($v8277e)) { $o65afd['day_number']=$wb1bc2; } $x2cb9d[] = $o65afd; $wb1bc2 ++; } } return $x2cb9d; } else { return false; } } function e2_published_noterec_with_alias_($g72487){ if ($cc45dd=e2_aliasrec_of_alias_($g72487)) { $iaad65=h4627($cc45dd['EntityID']); if ($iaad65['IsPublished']) return $iaad65; } } function e2_published_noterec_with_parameters_($parameters=array ()) { $b39a37=e2_noterec_with_parameters_($parameters); if ($b39a37['IsPublished']) return $b39a37; } function e2_noterec_with_parameters_($parameters=array ()) { global$_config; $iaad65=false; $nb5445=false; if ((string) @$parameters['oalias']!=='')$nb5445=$parameters['oalias']; if ((string)$nb5445!==''){ if (s0738( "SELECT * FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `OriginalAlias` = '". $nb5445 ."' ". "AND `IsPublished` = 0" )) { $iaad65=z0d6b(); if(count($iaad65)==1) { $iaad65=@$iaad65[0]; if ($iaad65) return $iaad65; } } } $i67e85=false; if (@$parameters['draft']!=='') $i67e85=$parameters['draft']; if (@$parameters['draft2']!=='')$i67e85=$parameters['draft2']; if ($i67e85){ $iaad65=h4627($i67e85); return $iaad65; } if ((string) @$parameters['alias']!==''){ if ($cc45dd=e2_aliasrec_of_alias_(@$parameters['alias'])) { if ($cc45dd['EntityType']==ENTITY_TYPE_NOTE){ $iaad65=h4627($cc45dd['EntityID']); if ($iaad65['IsPublished']) return $iaad65; } } } $uc2d18=pf9fb($parameters['year'],$parameters['month'],$parameters['day']); if (@$uc2d18[$parameters['day-number']-1]) { return $uc2d18[$parameters['day-number']-1]; } } function ze56b($ud5d3d,$y1cb25,$qb2c6c,$qd19c2){ global$_config; ve2f1(); @unlink(CACHE_FILENAME_DRAFTS); @unlink(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); $b39a37=array ( 'Title' => $ud5d3d, 'Text' => $y1cb25, 'FormatterID' => $_config['default_formatter'], 'OriginalAlias' => bd712('find',ENTITY_TYPE_UNSPECIFIED,'',$ud5d3d), 'Uploads' => $qd19c2, 'Stamp' => (int)time(), 'LastModified' => (int)time(), ); if ($qb2c6c and is_array($qb2c6c)) { $b39a37['Offset'] = (int)$qb2c6c['offset']; $b39a37['IsDST'] = (int)$qb2c6c['is_dst']; } if (($b39a37=f9943('Notes',$b39a37)) !== false){ return $b39a37['ID']; } } function u1630($ff2de2,$qb2c6c){ $vd17d3='/^ *(\d{1,2})\.(\d{1,2})\.(\d{2}|\d{4}) +(\d{1,2})\:(\d{1,2})\:(\d{1,2}) *$/'; if(preg_match($vd17d3,$ff2de2,$k6f8f5)) { $a96b8c=gmmktime($k6f8f5[4],$k6f8f5[5],$k6f8f5[6],$k6f8f5[2],$k6f8f5[1],$k6f8f5[3]); $a96b8c -= zb2bf($qb2c6c,$a96b8c); return $a96b8c; } else { return false; } } function ba21e($x98ea6=''){ global$_fp_error,$_config,$_e2utf8__unformat_htmlentity_neasden,$_db; $_fp_error=false; $z21158=$ud5d3d=$fd57ac=$y1cb25=$tb4960=''; if(array_key_exists('note-id',$_POST)) $z21158=$_POST['note-id']; if(array_key_exists('title',$_POST)) $ud5d3d=trim($_POST['title']); if(array_key_exists('tags',$_POST)) $fd57ac=$_POST['tags']; if(array_key_exists('text',$_POST)) $y1cb25=trim($_POST['text'],"\r\n"); if(array_key_exists('old-tags-hash',$_POST)) $tb4960=$_POST['old-tags-hash']; if(is_array($fd57ac))$fd57ac=implode(', ',$fd57ac); $fd57ac=trim($fd57ac); if ($z21158=='new'){ $_e2utf8__unformat_htmlentity_neasden=($_config['default_formatter']=='neasden'); } else { $_e2utf8__unformat_htmlentity_neasden=($_POST['formatter-id']=='neasden'); } $f1f22b=z07e3('Notes'); if(stripos($f1f22b['Collation'],'utf8mb4')!==0){ $ud5d3d=nff7c($ud5d3d); $fd57ac=nff7c($fd57ac); $y1cb25=nff7c($y1cb25,true); } $dffa71=$y1cb25; $dffa71=str_replace("\n",'\n'."\n",$dffa71); $dffa71=str_replace("\r",'\r'."\r",$dffa71); $ya6168=z163d(',',$fd57ac,'sort'); $fd57ac=implode(', ',$ya6168); $l65f31=md5($fd57ac); if(array_key_exists('browser-offset',$_POST)) { $qb2c6c=da618(@$_POST['browser-offset']); } else { $qb2c6c=false; } $z02b37=@$_POST['old-stamp']; $yaddfe=@$_POST['stamp']; $g72487=@$_POST['alias']; if ($z21158!='new'){ $g383b7=h4627($z21158); } else { $g383b7=array(); } if ($z21158){ if ((string)$ud5d3d!=='' and (string)$y1cb25!==''){ if ($z21158=='new'){ $qd19c2=''; if(is_file(USER_FOLDER.'new-uploads.psa')) { $qd19c2=@file_get_contents(USER_FOLDER.'new-uploads.psa'); } if ($z21158=ze56b($ud5d3d,$y1cb25,$qb2c6c,$qd19c2)) { @unlink(USER_FOLDER.'new-uploads.psa'); $a33dd5='e2m_draft'; $y5ce5d=array ( '*note' => h4627($z21158), ); $q1fa03='{'. '"status": "created", '. '"id": "'. $z21158 .'", '. '"note-url": "'. v83c8($a33dd5,$y5ce5d) .'", '. '"note-edit-url": "'. v83c8('e2m_note_edit',$y5ce5d) .'"'. '}'; $result=(int)$z21158; } else { $q1fa03='{"status": "error", "message": "Cannot create record"}'; $result=false; } } else { e2_drop_caches_for_note_($z21158); if (!$g383b7['IsPublished']) { @unlink(CACHE_FILENAME_DRAFTS); @unlink(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); } $k71671=$g383b7; $k71671['ID']=$z21158; $k71671['Title']=$ud5d3d; $k71671['Text']=$y1cb25; $k71671['FormatterID']=$g383b7['FormatterID']; $k71671['LastModified']=time(); $k71671['IsIndexed']='1'; if ($z02b37!=$yaddfe){ if ($a96b8c=u1630($yaddfe,$qb2c6c)) { $k71671['Stamp']=min($a96b8c,time()); } else { unset ($a96b8c); } } $x17901=$g72487; if ($g72487){ $fa7ff0=$g72487; } elseif (!$g383b7['IsPublished']) { $fa7ff0=$ud5d3d; } else { $fa7ff0=''; } if ($g383b7['IsPublished']) { $x17901=bd712( 'set',ENTITY_TYPE_NOTE,$z21158,$fa7ff0 ); $a33dd5='e2m_note'; $y5ce5d=array ( '*note' => $k71671, 'alias' => $x17901, ); } else { $p926c6=true; $x17901=bd712('find',ENTITY_TYPE_NOTE,$z21158,$fa7ff0); $k71671['OriginalAlias']=$x17901; $a33dd5='e2m_draft'; $y5ce5d=array ( '*note' => $k71671, 'alias' => $x17901, ); } $ce449c=yc0c4( $k71671['FormatterID'],$k71671['Text'],'full' ); if(count($ce449c) > 0){ j6be4($ce449c); } if (paa79('Notes',$k71671)) { if ($k71671['IsPublished']) { od2e1($k71671); i5b68($k71671); } $q1fa03='{'. '"status": "saved", '. '"new-alias": "'. $x17901 .'", '. '"note-url": "'. v83c8($a33dd5,$y5ce5d) .'", '. '"note-edit-url": "'. v83c8('e2m_note_edit',$y5ce5d) .'"'. '}'; $result=(int)$z21158; } else { $q1fa03='{"status": "error", "message": "Cannot update record ('. mysqli_error(). ')"}'; $result=false; } } if ($l65f31!=$tb4960){ v53f1(array ('NoteID' => $z21158)); foreach ($ya6168 as $me4d23){ $m70b77=p0188($me4d23); if (!$m70b77){ $m70b77['ID']=h03de($me4d23); } s0738( "INSERT INTO `". $_config['db_table_prefix']."NotesKeywords` ". "(`NoteID`, `KeywordID`) ". "VALUES (". ((int)$z21158) .", ". ((int)$m70b77['ID']). ")" ); } } if ( $x98ea6!='ajaxresult' and $result and $_POST['instant-publish']=='yes' ){ $_POST['note-id']=$z21158; e2s_note_publish(); } } else { $q1fa03='{"status":"error", "message": "Title or text is empty"}'; $_fp_error=FP_TITLE_OR_TEXT_EMPTY; $result=false; } } else { $q1fa03='{"status":"error", "message": "No note id/new specified"}'; $_fp_error=FP_NO_ID_OR_NEW; $result=false; } tcc38(v83c8('e2s_dump', array ())); if ($x98ea6=='ajaxresult') return $q1fa03; else return$result; } function d3456($c1653c,$f0604c){ global$_config; if (!($c1653c and $f0604c) and !ee852()) { die ('API MISUSE: e2_notes_count_generic cannot be called for invisible notes or drafts unsecurely :-('); } if (!is_bool($c1653c) or !is_bool($f0604c)) { die ('API MISUSE: e2_notes_count_generic must be called with bool params :-('); } if (!$c1653c and !$f0604c){ die ('API MISUSE: e2_notes_count_generic called with nonsensical parameters'); } $ed29bb=CACHES_FOLDER . 'notes-count-p'. (int)$c1653c . ($c1653c ? ('v'. (int)$f0604c):'') . '.txt'; $result=false; if(CACHE_NOTES_COUNTS and is_file($ed29bb)) { $result=@file_get_contents($ed29bb); } if(is_numeric($result) and $result > 0){ return$result; } else { s0738( "SELECT COUNT(*) As NotesCount FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished`=". (int)$c1653c. " ". ($c1653c ? ( "AND `IsVisible`=". (int)$f0604c ):"") ); $result=z0d6b(); $result=$result[0]['NotesCount']; if($result){ if(CACHE_NOTES_COUNTS)x6e52($ed29bb,$result); return$result; } else { return null; } } } function x5421($y1cb25){ $ca80da=$y1cb25; $ca80da=preg_match( '/^(\<\/div\>)?\<p( class\=\"lead\")?\>(.*)\<\/p\>$/m', $ca80da, $u9c28d ); $ca80da=$u9c28d[3]; if (!$ca80da)$ca80da=$y1cb25; $ca80da=str_replace(array ( '<p>','<blockquote>','<ul>','<ol>','<br />', ), "\n",$ca80da); $ca80da=trim(strip_tags($ca80da)); if(strpos($ca80da,"\n")!==false){ $ca80da=substr($ca80da,0,strpos($ca80da,"\n")); $ca80da=trim($ca80da,' :.()'."\n"); } if(preg_match('/^(.{100,}?)[:.!?()]|'."\n".'/s',$ca80da,$u9c28d)) { $ca80da=trim($u9c28d[0],' :.()'."\n"); } if(preg_match('/^(.{150,}?)[:.!?(),]/s',$ca80da,$u9c28d)) { $ca80da=trim($u9c28d[0],' :.()'."\n"); } if(preg_match('/^(.{200,}?)[:.!?(), ]/s',$ca80da,$u9c28d)) { $ca80da=trim($u9c28d[0],' :.()'."\n"); } if(in_array($ca80da[strlen($ca80da)-1], array (',',' '))) { $ca80da=trim($ca80da,', '). '...'; } if(mb_strlen($ca80da) > 250){ $ca80da=mb_substr($ca80da,0,250). '...'; } if ($ca80da[-1]==':')$ca80da=mb_substr($ca80da,0, -1); return $ca80da; } function jb44b($b39a37,$m15514=false){ if ($m15514) return true; return $b39a37['IsVisible'] and $b39a37['Stamp'] <= time(); } function a6f32($m15514=false){ if ($m15514){ return ''; } else { return 'AND (n.`IsVisible` = 1 AND n.`Stamp` <= '. time() .') '; } } function e2_populate_read_counts_in_notes_ctree_($r6b12c){ global$_config; $ac6b5b=array(); foreach ($r6b12c as $z8ce4b => $de244c){ if (@$de244c['_']['_id']) { $ac6b5b[] = "(`EntityID` = ". $de244c['_']['_id'].")"; } } if(count($ac6b5b)) { $ac6b5b=implode(' OR ',$ac6b5b); if (s0738( "SELECT `EntityID`, SUM(`ReadCount`) ReadCount ". "FROM `". $_config['db_table_prefix']."Actions` ". "WHERE ". $ac6b5b ." ". "GROUP BY `EntityID`" )) { $bfa816=z0d6b(); foreach ($bfa816 as $g33c9b){ $v0980a[$g33c9b['EntityID']] = $g33c9b['ReadCount']; } } foreach ($r6b12c as $z8ce4b => $de244c){ $r6b12c[$z8ce4b]['read-count']=$v0980a[$de244c['_']['_id']]; } } return $r6b12c; } define('DRAFT_PREVIEW_LENGTH',100); function e2m_drafts(){ global$_strings,$_config; if(__LOG)__log('Drafts list: Working...'); $xda48a=null; if(CACHE_DRAFTS and is_file(CACHE_FILENAME_DRAFTS)) { $xda48a=@unserialize(file_get_contents(CACHE_FILENAME_DRAFTS)); } if(CACHE_DRAFTS and is_array($xda48a)) { if(__LOG)__log('Drafts list: Retrieve cached ctree'); } else { if(__LOG)__log('Drafts list: Assemle cacheable ctree...'); $xda48a=array(); if(__LOG)__log('Drafts list: Select'); if (s0738( "SELECT * FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished`=0 ". "ORDER BY `SourceID` DESC, `LastModified` DESC ". "LIMIT 1000" )) { $result=z0d6b(); $b4358b=array(); foreach($result as $z8ce4b => $b39a37){ $iaad65=array(); $iaad65['_']['_id']=$b39a37['ID']; $iaad65['_']['_ord']=$z8ce4b; $iaad65['_']['_ord_max']=count($result)-1; $iaad65['href']=v83c8('e2m_draft', array ('*note' => $b39a37)); $iaad65['title']=i6f10(htmlspecialchars($b39a37['Title'],ENT_NOQUOTES,HSC_ENC)); if (isset ($iaad65['image-href'])) unset ($iaad65['image-href']); $b39a37['_']['_id']=$b39a37['ID']; $b39a37['_']['_ord']=0; $b39a37['_']['_ord_max']=0; $k8e4cd=r6791($b39a37,true); $iaad65['_']['_resources']=null; if ($b39a37['FormatterID']=='neasden'){ $iaad65['_']['_resources']=$k8e4cd['format-info']['resources-detected']; } elseif ($b39a37['FormatterID']=='calliope'){ $iaad65['_']['_resources']=yc0c4( $b39a37['FormatterID'],$b39a37['Text'],'full' ); } $iaad65=array_merge($iaad65,v1a48($b39a37,false)); $iaad65['text-fragment']=strip_tags($k8e4cd['text']); $c2ab2d=false; if(mb_strlen($iaad65['text-fragment']) > DRAFT_PREVIEW_LENGTH) { $c2ab2d=mb_strpos($iaad65['text-fragment'],'.',DRAFT_PREVIEW_LENGTH); } if ($c2ab2d!==false){ $iaad65['text-fragment']=mb_substr($iaad65['text-fragment'],0,$c2ab2d+1); } $xda48a[] = $iaad65; } if(CACHE_DRAFTS)x6e52(CACHE_FILENAME_DRAFTS,serialize($xda48a)); } } if(__LOG)__log('Drafts list: Put thumbnail without cache'); if ($xda48a){ foreach ($xda48a as $z8ce4b => $q9e366){ $xda48a[$z8ce4b]['thumbs']=p2e82(@$q9e366['_']['_resources']); } } if(__LOG)__log('Drafts list: Done'); $x2cb9d=array ( 'title' => $_strings['pt--drafts'], 'heading' => $_strings['pt--drafts'], ); if(count($xda48a)) { $x2cb9d['drafts']=$xda48a; } else { $x2cb9d['nothing']=$_strings['gs--no-drafts']; } return $x2cb9d; } function e2m_draft($parameters=array ()) { global$_strings,$_config,$s57de2; $iaad65=e2_noterec_with_parameters_($parameters); if (!$iaad65){ $parameters['alias']=$parameters['oalias']; unset($parameters['oalias']); $iaad65=e2_noterec_with_parameters_($parameters); if ($iaad65){ $td58c0=v83c8('e2m_note', array ('*note' => $iaad65)); return e2_go_to($td58c0); } } if (!$iaad65) return e2_error404_mode(); $iaad65['_']['_id']=$iaad65['ID']; $iaad65['_']['_ord']=0; $iaad65['_']['_ord_max']=0; $k8e4cd=r6791($iaad65); $r45513=array ( '.note-id' => $iaad65['ID'], 'form-action' => v83c8('e2s_note_publish'), 'submit-text' => $_strings['fb--publish-draft'], 'can-schedule?' => false, 'can-publish?' => !@$_config['read_only'], ); return array ( 'title' => $iaad65['Title'].' ('. $_strings['wd--draft'] .')', 'notes' => array ('only' => $k8e4cd), 'form' => 'form-note-publish', 'form-note-publish' => $r45513, ); } function e2m_draft_preview($parameters=array ()) { return e2_error404_mode(); } function e2_draft_alias_use_count($m176fe){ global$_config; if(__LOG)__log('Drafts: find duplicate OriginalAliases...'); if(CACHE_DRAFTS_ALIAS_USE_COUNTS and is_file(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS)) { $yda552=@unserialize(file_get_contents(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS)); } if(CACHE_DRAFTS_ALIAS_USE_COUNTS and is_array($yda552)) { if(__LOG)__log('Drafts: retrieve cached'); } else { if(__LOG)__log('Drafts: assemle cacheable...'); $yda552=array(); if (s0738( "SELECT `OriginalAlias` FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished`=0 ". "ORDER BY `ID`" )) { $result=z0d6b(); $b4358b=array(); foreach($result as $z8ce4b => $b39a37){ @$yda552[$b39a37['OriginalAlias']] ++; } } if(CACHE_DRAFTS_ALIAS_USE_COUNTS){ x6e52(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS,serialize($yda552)); } } return $yda552[$m176fe]; } function e2drafts__preview_key($iaad65){ return md5($iaad65['Text'].$iaad65['LastModified']); } $_url_map=array ( '@build' => 'e2://e2s_build', '@sync' => 'e2://e2s_sync', '@dump' => 'e2://e2s_dump', '@bsi' => 'e2://e2s_bsi_status', '@bsi/drop' => 'e2://e2s_bsi_drop', '@bsi/step' => 'e2://e2s_bsi_step', '@migrate' => 'e2://e2s_migrate', '@retrieve:url' => 'e2://e2s_retrieve', '@instantiate:version' => 'e2://e2s_instantiate', '@notify' => 'e2://e2s_notify', '@info' => 'e2://e2m_info', '@ajax/::' => 'e2://e2j_::', '@actions/::' => 'e2://e2s_::', '' => 'e2://e2m_frontpage?page=1', ':page' => 'e2://e2m_frontpage', 'rss' => 'e2://e2m_rss', 'json' => 'e2://e2m_json', 'sitemap.xml' => 'e2://e2m_sitemap_xml', ':year' => 'e2://e2m_year', ':year/:month' => 'e2://e2m_month', ':year/:month/:day' => 'e2://e2m_day', 'all' => 'e2://e2m_everything', ':note' => 'e2://e2m_note', ':note/edit' => 'e2://e2m_note_edit?is_published=1', ':note/favourite' => 'e2://e2m_note_flag_favourite?is_published=1&value=1', ':note/unfavourite' => 'e2://e2m_note_flag_favourite?is_published=1&value=0', ':note/show' => 'e2://e2m_note_flag?is_published=1&flag=IsVisible&value=1', ':note/hide' => 'e2://e2m_note_flag?is_published=1&flag=IsVisible&value=0', ':note/discuss' => 'e2://e2m_note_flag?is_published=1&flag=IsCommentable&value=1', ':note/quiet' => 'e2://e2m_note_flag?is_published=1&flag=IsCommentable&value=0', ':note/withdraw' => 'e2://e2m_note_withdraw?is_published=1', ':note/json' => 'e2://e2m_note_json', ':note/broadcast' => 'e2://e2m_note_broadcast', ':note/read' => 'e2://e2m_note_read', ':note/delete' => 'e2://e2m_note_delete?is_published=1', ':note/format/:formatter' => 'e2://e2m_note_use_formatter?is_published=1', ':note/:unsubscr' => 'e2://e2m_unsubscribe?is_published=1', ':note/:comnum' => 'e2://e2m_comment', ':note/:comnum/edit' => 'e2://e2m_comment_edit', ':note/:comnum/important' => 'e2://e2m_comment_flag_ajax?flag=IsFavourite&value=1', ':note/:comnum/usual' => 'e2://e2m_comment_flag_ajax?flag=IsFavourite&value=0', ':note/:comnum/replace' => 'e2://e2m_comment_flag_ajax?flag=IsVisible&value=1', ':note/:comnum/remove' => 'e2://e2m_comment_flag_ajax?flag=IsVisible&value=0', ':note/:comnum/spam' => 'e2://e2m_comment_flag?flag=IsSpamSuspect&value=1', ':note/:comnum/good' => 'e2://e2m_comment_flag?flag=IsSpamSuspect&value=0', ':note/:comnum/wipe' => 'e2://e2m_comment_delete', ':note/:comnum/reply/edit' => 'e2://e2m_comment_reply', ':note/:comnum/reply/important' => 'e2://e2m_comment_flag_ajax?flag=IsReplyFavourite&value=1', ':note/:comnum/reply/usual' => 'e2://e2m_comment_flag_ajax?flag=IsReplyFavourite&value=0', ':note/:comnum/reply/replace' => 'e2://e2m_comment_flag_ajax?flag=IsReplyVisible&value=1', ':note/:comnum/reply/remove' => 'e2://e2m_comment_flag_ajax?flag=IsReplyVisible&value=0', ':note/:comnum/reply/delete' => 'e2://e2m_comment_reply_delete', 'drafts' => 'e2://e2m_drafts', 'drafts/:draft' => 'e2://e2m_draft', 'drafts/:draft/edit' => 'e2://e2m_note_edit?is_published=0', 'drafts/:draft/show' => 'e2://e2m_note_flag?is_published=0&flag=IsVisible&value=1', 'drafts/:draft/hide' => 'e2://e2m_note_flag?is_published=0&flag=IsVisible&value=0', 'drafts/:draft/delete' => 'e2://e2m_note_delete?is_published=0', 'drafts/:draft/format/:formatter' => 'e2://e2m_note_use_formatter?is_published=0', 'drafts/:draft/:preview' => 'e2://e2m_draft_preview', 'sources' => 'e2://e2m_sources', 'sources/:source/trust' => 'e2://e2m_source_trust', 'sources/:source/premoderate' => 'e2://e2m_source_premoderate', 'sources/:source/ban' => 'e2://e2m_source_ban', 'sources/:source/forget' => 'e2://e2m_source_forget', 'tags' => 'e2://e2m_tags', 'tags/:tag' => 'e2://e2m_tag?page=1', 'tags/:tag/:page' => 'e2://e2m_tag', 'tags/:tag/rss' => 'e2://e2m_tag_rss', 'tags/:tag/json' => 'e2://e2m_tag_json', 'tags/:tag/edit' => 'e2://e2m_tag_edit', 'tags/:tag/delete' => 'e2://e2m_tag_delete', 'tags/:tag/pin' => 'e2://e2m_tag_flag_ajax?flag=IsFavourite&value=1', 'tags/:tag/unpin' => 'e2://e2m_tag_flag_ajax?flag=IsFavourite&value=0', 'untagged' => 'e2://e2m_untagged', 'hot' => 'e2://e2m_most_commented', 'selected' => 'e2://e2m_favourites?page=1', 'selected/:page' => 'e2://e2m_favourites', 'found' => 'e2://e2m_found&query=', 'found/:query' => 'e2://e2m_found', 'new' => 'e2://e2m_write', 'install' => 'e2://e2m_install', 'settings' => 'e2://e2m_settings', 'settings/name' => 'e2://e2m_name_and_author', 'settings/database' => 'e2://e2m_database', 'settings/password' => 'e2://e2m_password?recovery-key=', 'settings/password-reset' => 'e2://e2m_password_reset', 'settings/password/:reset' => 'e2://e2m_password', 'settings/timezone' => 'e2://e2m_timezone', 'settings/sessions' => 'e2://e2m_sessions', 'settings/theme-preview' => 'e2://e2m_theme_preview?theme=', 'settings/theme-preview/:theme' => 'e2://e2m_theme_preview', 'settings/get-backup' => 'e2://e2m_get_backup', 'sign-in' => 'e2://e2m_sign_in', 'sign-out' => 'e2://e2m_sign_out', 'sign-in/:provider' => 'e2://e2m_gip_sign_in', 'sign-out/:provider' => 'e2://e2m_gip_sign_out', 'sign-in-done/:provider' => 'e2://e2m_gip_sign_in_callback', ); $_url_chunks=array ( '\:page' => 'page\-(?P<page>\d+)', '\:year' => '(?P<year>\d{4})', '\:month' => '(?P<month>\d{1,2})', '\:day' => '(?P<day>\d{1,2})', '\:note' => array ( 'all\/(?P<alias>[-a-zA-Z0-9]+)', '(?P<year>\d{4})\/(?P<month>\d{1,2})\/(?P<day>\d{1,2})\/(?P<day_number>\d+)', ), '\:draft' => array ( '(?P<oalias2>[-a-zA-Z0-9]+)\/(?P<draft2>\d+)', '(?P<oalias>[-a-zA-Z0-9]+)', '-\/(?P<draft>\d+)', ), '\:comnum' => 'comment\-(?P<comment_number>[0-9]+)', '\:file' => '(?P<file>.*?)', '\:tag' => '(?P<tag_alias>[-a-zA-Z0-9]+)', '\:query' => '(?P<query>.*?)', '\:provider' => '(?P<provider>.*?)', '\:version' => '\:(?P<version>\d+)', '\:source' => '\:(?P<source>.*?)', '\:picture' => '\:(?P<picture>.*?)', '\:unsubscr' => 'unsubscribe\:(?P<unsubscribe_email>.+?)\:(?P<unsubscribe_key>[0-9a-f]{32})', '\:reset' => 'reset\:(?P<recovery_key>[0-9a-f]{40})', '\:formatter' => '(?P<formatter>.*?)', '\:alias' => '(?P<newalias>[-a-zA-Z0-9]+)', '\:preview' => 'preview\:(?P<preview_key>[0-9a-f]{32})', '\:theme' => '(?P<theme>[-a-zA-Z0-9]+)', '\:source' => '(?P<source>\d+)', '\:url' => '\:(?P<url>[a-zA-Z0-9]+\=)', ); $_url_autoredirects=array ( '/^favo(?:u?)rites(\~.+)?$/i' => 'selected\\1', '/^favo(?:u?)rites\/(.+)/i' => 'selected/\\1', '/^keywords$/i' => 'tags', '/^keywords\/(.*)/i' => 'tags/\\1', '/^everything$/i' => 'all', '/^search\/(.+)/i' => 'found/\\1', '/^(\d{4}\/\d{1,2}\/\d{1,2}\/\d+)\/comments(\/?)$/i' => '\\1', '/^\~(\d+)/i' => 'page-\\1', '/\/?\~(\d+)/i' => '/page-\\1', ); function db6b0($n572d4){ global$_url_autoredirects,$wa57c1; $n572d4=preg_replace(array_keys($_url_autoredirects),array_values($_url_autoredirects),$n572d4); if(preg_match('/^([0-9]+)[.-]([0-9]+)[.-]([0-9]+)(.*)/',$n572d4,$u9c28d)) { if(2==strlen($u9c28d[3]))$u9c28d[3]='20'.$u9c28d[3]; return ($u9c28d[3].'/'.$u9c28d[2].'/'.$u9c28d[1].$u9c28d[4]); } if(preg_match('/^tags\-rss\/(.*?)\/?$/',$n572d4,$u9c28d)) { $me4d23=substr($u9c28d[1],strrpos($u9c28d[1],'/')+1); return ('tags/'. $me4d23.'/rss/'); } return $n572d4; } function b7059(){ global$__synthetic_urls,$_config,$_superconfig; $__synthetic_urls=false; if($_config['url_composition']=='auto'){ if(function_exists('apache_get_modules')) { if(in_array('mod_rewrite',apache_get_modules())) { $__synthetic_urls=true; } } } if($_config['url_composition']=='synthetic'){ $__synthetic_urls=true; } if (@$_superconfig['url_composition']=='synthetic'){ $__synthetic_urls=true; } if (@$_superconfig['url_composition']=='real'){ $__synthetic_urls=false; } } function v83c8($xc48ba,$parameters=array ()) { global$_url_map,$_url_chunks,$_config,$__synthetic_urls,$_protocol,$s57de2,$wa57c1; $ec2bd7=array_flip($_url_map); if ( @$_config['preferred_domain_name'] and $_SERVER['HTTP_HOST']!=$_config['preferred_domain_name'] ) { $s57de2=$_config['preferred_domain_name']; } $n572d4=$_protocol .'://'. $s57de2.$wa57c1 .'/'; $n9c464='e2://'. $xc48ba; if(array_key_exists('page',$parameters)) { $x71860=$parameters['page']; } else { $x71860=1; } if($parameters){ $n9c464.='?'; $v1c61f=array(); $j21711=array(); foreach($parameters as $y3c6e0 => $o2063c){ if ($y3c6e0=='*note'){ $j21711[] = $y3c6e0; $v1c61f[] = e2urls__expand_tricky_parameters_for_note_($o2063c); } if ($y3c6e0=='*tags'){ $j21711[] = $y3c6e0; $v1c61f[] = e2urls__expand_tricky_parameters_for_tags_($o2063c); } if ($y3c6e0=='*tag'){ $j21711[] = $y3c6e0; $v1c61f[] = e2urls__expand_tricky_parameters_for_tags_(array ($o2063c)); } } foreach ($j21711 as $y3c6e0) unset($parameters[$y3c6e0]); foreach ($v1c61f as $o58e2a){ $parameters=array_merge($parameters,$o58e2a); } foreach($parameters as $y3c6e0 => $o2063c){ if (@$y3c6e0[0]!='_'){ $n9c464.=$y3c6e0 .'='. urlencode($o2063c) .'&'; } } $n9c464=substr($n9c464,0, -1); } if(array_key_exists($n9c464,$ec2bd7)) { if ($ec2bd7[$n9c464]!=='')$n572d4.=$ec2bd7[$n9c464] .'/'; return $n572d4; } else { $e44907=false; foreach ($ec2bd7 as $s45ea8 => $y9ea44){ $sb7365=$s45ea8; $sb7365=preg_quote($sb7365,'/'); $ced015=parse_url($s45ea8); $h2f532=$ced015['host']; $gebe09=parse_url($n9c464); if(strstr($s45ea8,'::')) { $lffd6b=$gebe09['scheme'] .'://'. $gebe09['host']; $sb7365=str_replace('\:\:','(.*)',$sb7365); $sb7365='/^'. $sb7365 .'$/s'; if(preg_match($sb7365,$lffd6b,$u9c28d)) { $kd6fe1=str_replace('::',$u9c28d[1],$y9ea44); $kd6fe1=str_replace('_','-',$kd6fe1); $p1b1cc=$gebe09['query']; if($__synthetic_urls and $p1b1cc){ $n572d4.=$kd6fe1 .'/?'. $p1b1cc; } elseif($__synthetic_urls){ $n572d4.=$kd6fe1 .'/'; } elseif ($p1b1cc){ $n572d4.='?go='. $kd6fe1 .'/&'. $p1b1cc; } else { $n572d4.='?go='. $kd6fe1 .'/'; } return $n572d4; } } $v54435=false; if ($xc48ba===$h2f532){ $e44907=true; if ($ced015['query']) { $b22c38=explode('&',$ced015['query']); foreach ($b22c38 as $p8822b){ list ($y3c6e0,$o2063c)=explode('=',$p8822b); $o2063c=urldecode($o2063c); $y3c6e0=str_replace('_','-',$y3c6e0); if ( array_key_exists($y3c6e0,$parameters) and $parameters[$y3c6e0]!=$o2063c ){ $v54435=true; break; } } } if (!$v54435){ if(preg_match_all('/\:[\-a-z]+/i',$y9ea44,$u9c28d)) { foreach ($u9c28d[0] as $kfc413){ $vb0f75=$_url_chunks['\\'. $kfc413]; if (!is_array($vb0f75)) { $vb0f75=array ($vb0f75); } $p05f62=$vb0f75[0]; foreach ($vb0f75 as $p05f62){ $xeab03='/\(\?P\<(.*?)\>.*?\)/'; $x4274e=true; if (@preg_match_all($xeab03,$p05f62,$u9c28d)) { $u9c28d=$u9c28d[1]; $x4274e=true; for ($v865c0=0; $v865c0 < count($u9c28d); ++ $v865c0){ if ( !array_key_exists(str_replace("_","-",$u9c28d[$v865c0]), $parameters) or $parameters[str_replace("_","-",$u9c28d[$v865c0])] === '' ){ $x4274e=false; break; } } } if (!$x4274e) continue; $zf9e1e=@preg_replace_callback( $xeab03, function ($u9c28d) use ($parameters){ return$parameters[str_replace("_","-",$u9c28d[1])]; }, $p05f62 ); $zf9e1e=stripslashes($zf9e1e); $fc5d91=str_replace($kfc413,$zf9e1e,$y9ea44); break; } $y9ea44=$fc5d91; } } $d15214=array(); if ($y9ea44){ if($__synthetic_urls){ $n572d4.=$y9ea44 .'/'; } else { $d15214[] = 'go='. $y9ea44 .'/'; } } foreach($_GET as $z8ce4b => $q9e366) if(in_array($z8ce4b, array ('result','themeless'))) { $d15214[] = $z8ce4b . ($q9e366? ('='. urlencode($q9e366)) : ''); } if(count($d15214)) { $n572d4.='?'. implode('&',$d15214); } return $n572d4; } } } if ($e44907){ return $n572d4; } else { die ('Cannot compose url for candy '. $xc48ba); } } } function mb7e9($n572d4){ global$_url_map,$_url_chunks,$_config,$_current_url,$__synthetic_urls,$_protocol,$s57de2,$wa57c1; $j196c2=$n572d4; $n572d4=trim($n572d4,'/'); $n572d4=db6b0($n572d4); $parameters=array(); foreach($_url_map as $p12a24 => $s45ea8){ $ld532d=$p12a24; $ld532d=preg_quote($ld532d,'/'); if(strstr($p12a24,'::')) { $ld532d=str_replace('\:\:','(.*)',$ld532d); $ld532d='/^'. $ld532d .'$/s'; if(preg_match($ld532d,$n572d4,$u9c28d)) { $g53b9e=str_replace('-','_',$u9c28d[1]); $n9c464=str_replace('::',$g53b9e,$s45ea8); } } elseif(strstr($p12a24,':')) { $a1e380=array(); foreach($_url_chunks as $z8ce4b => $q9e366){ if(is_array($q9e366)) { $a1e380[$z8ce4b]='(?:(?:'. implode(')|(?:',$q9e366) .'))'; } else { $a1e380[$z8ce4b]=$q9e366; } } $ld532d=str_replace( array_keys($a1e380), array_values($a1e380), $ld532d ); $ld532d='/^'. $ld532d .'$/s'; if(preg_match($ld532d,$n572d4,$u9c28d)) { $n9c464=$s45ea8; foreach ($u9c28d as $y3c6e0 => $o2063c) if (!is_numeric($y3c6e0)) { $y3c6e0=str_replace('_','-',$y3c6e0); $parameters[$y3c6e0]=$o2063c; } } } else { if ($p12a24==$n572d4){ $n9c464=$s45ea8; break; } } } $jfafdd=(bool)$n9c464; if (!$n9c464)$n9c464='e2://e2m_404'; $gebe09=parse_url($n9c464); $xc48ba=$gebe09['host']; if ($gebe09['query']) { $b22c38=explode('&',$gebe09['query']); foreach ($b22c38 as $p8822b){ list ($y3c6e0,$o2063c)=explode('=',$p8822b); $o2063c=urldecode($o2063c); $y3c6e0=str_replace('_','-',$y3c6e0); $parameters[$y3c6e0]=$o2063c; } } $x2cb9d=false; $parameters=e2urls__consolidate_tricky_parameters_($parameters); if ($jfafdd){ if($_config['force_canonical_urls']) { $l95d32=v83c8($xc48ba,$parameters); list ($sa4c3a,$dab96c)=explode('?',$_SERVER['REQUEST_URI'],2); $ha37bf=$_protocol .'://'.$_SERVER['HTTP_HOST'].$sa4c3a; $w5d6ba=$_protocol .'://'.$_SERVER['HTTP_HOST'].urldecode($sa4c3a); $dab96c=explode('&',$dab96c); foreach ($dab96c as $b6c0d0){ list ($c5c5e7, ) = explode('=',$b6c0d0); if ($c5c5e7=='go'){ $ha37bf.='?'. $b6c0d0; $w5d6ba.='?'. urldecode($b6c0d0); } } $_current_url=$ha37bf; if ($ha37bf!=$l95d32 and $w5d6ba!=$l95d32){ e2_go_to($l95d32); } } if(is_callable($xc48ba)) { $x2cb9d=array ($xc48ba,$parameters); } else { $x2cb9d=array (null, array ()); } } else { $x2cb9d=array (null, array ()); } return $x2cb9d; } function e2urls__expand_tricky_parameters_for_note_($b39a37){ global $wa57c1,$_config; if (!isset ($b39a37['IsPublished'])) { return array (); } if (!$b39a37['IsPublished']) { if ($b39a37['OriginalAlias']===''){ $parameters['draft']=$b39a37['ID']; } elseif(e2_draft_alias_use_count($b39a37['OriginalAlias']) == 1){ $parameters['oalias']=$b39a37['OriginalAlias']; } else { $parameters['draft2']=$b39a37['ID']; $parameters['oalias2']=$b39a37['OriginalAlias']; } $parameters['is-published']=0; return$parameters; } $parameters['is-published']=1; $sb80bb=$b39a37['ID']; $a96b8c=$b39a37['Stamp']; $qb2c6c=m0923($b39a37); if (!isset ($b39a37['__noalias!'])) { if (isset ($b39a37['alias'])) { $parameters['alias']=$b39a37['alias']; } else { $parameters['alias']=e2_active_alias_for_page_(ENTITY_TYPE_NOTE,$b39a37['ID']); if($parameters['alias']===null) unset($parameters['alias']); } } if(array_key_exists('alias',$parameters)) return$parameters; list ($p41529,$k6f8f5,$v8277e)=explode('/', w5a2f('Y/m/d',$a96b8c,$qb2c6c) ); $parameters['year']=$p41529; $parameters['month']=$k6f8f5; $parameters['day']=$v8277e; if (isset ($b39a37['day_number'])) { $parameters['day-number']=$b39a37['day_number']; } else { list ($zd9d0f, ) = l5273($p41529,$k6f8f5,$v8277e); if (s0738( "SELECT `ID`, `Stamp`, `Offset`, `IsDST` ". "FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished` = 1 AND (`Stamp` BETWEEN " .$zd9d0f. " AND " .$a96b8c. ") ". "ORDER BY `Stamp`" )) { $result=z0d6b(); $wb1bc2=1; foreach($result as $o65afd){ if ( $p41529.'/'.$k6f8f5.'/'.$v8277e == w5a2f('Y/m/d',$o65afd['Stamp'],m0923($o65afd)) ) { if ($o65afd['ID']==$sb80bb){ $d444bc=1; break; } $wb1bc2 ++; } } if (@$d444bc!=1){ header('HTTP/1.1 503 Service Unavailable'); die ('Candidates enumeration failed.'); } } $parameters['day-number']=$wb1bc2; } return$parameters; } function e2urls__expand_tricky_parameters_for_tags_($k0dff3){ $p9299d=array(); $parameters=array(); foreach ($k0dff3 as $sb19ad){ $g72487=''; if (!isset ($sb19ad['__noalias!'])) { if (isset ($sb19ad['tag-alias'])) { $g72487=$sb19ad['tag-alias']; } else { $g72487=e2_active_alias_for_page_(ENTITY_TYPE_TAG,$sb19ad['ID']); } } $p9299d[] = $g72487? $g72487:$sb19ad['OriginalAlias']; } if(count($k0dff3)) { $parameters['tag-alias']=implode(',',$p9299d); } return$parameters; } function e2urls__consolidate_tricky_parameters_($parameters){ if ( (string) @$parameters['alias']!=='' or ( (string) @$parameters['year']!=='' and (string) @$parameters['month']!=='' and (string) @$parameters['day']!=='' and (string) @$parameters['day-number']!=='' ) ) { if ($iaad65=e2_published_noterec_with_parameters_($parameters)) { $parameters['*note']=$iaad65; } } if ( (string) @$parameters['oalias']!=='' or (string) @$parameters['draft']!=='' or (string) @$parameters['oalias2']!=='' or (string) @$parameters['draft2']!=='' ){ if ($iaad65=e2_noterec_with_parameters_($parameters)) { $parameters['*note']=$iaad65; } } if ( (string) @$parameters['tag-alias']!=='' ){ $parameters['*tags']=e2_tagrecs_with_parameters_($parameters); if(count($parameters['*tags']) == 1){ $parameters['*tag']=$parameters['*tags'][0]; } } return$parameters; } function e2m_tags(){ global$_strings; $x2cb9d['title']=$_strings['pt--tags']; $x2cb9d['heading']=$_strings['pt--tags']; $fd57ac=e5d57(); if(count($fd57ac)==0){ $x2cb9d['nothing']=$_strings['gs--no-tags']; } return $x2cb9d; } function e2m_tag($parameters=array ()) { global $settings, $_config, $_current_tag, $_strings, $x71860, $full_blog_url; if(__LOG)__log('Tag {'); if(array_key_exists('*tags',$parameters)) { $o59aeb=$parameters['*tags']; } if (!$o59aeb[0]) return e2_error404_mode(); $cd7df5=$o59aeb[0]; $w7186e=$parameters['tag-alias']; if(count($o59aeb)==1){ $_current_tag=$cd7df5['Keyword']; } $x71860=$parameters['page']; $pc2b7b=$_config['db_table_prefix']; $vd7e5d=$settings['appearance']['notes_per_page']; foreach ($o59aeb as $q9e366) if ($q9e366){ $f56790[] = "nk.KeywordID=". $q9e366['ID']; } $f56790='('.implode(' OR ',$f56790).')'; $m15514=ee852(); $f56790.='AND IsPublished=1 '; $f56790.=a6f32($m15514); $a9b0c2=count($o59aeb); $w7a86c=($x71860-1)*$vd7e5d; $iaa9f7=$vd7e5d; $zac5c7=( "SELECT SQL_CALC_FOUND_ROWS n.*, COUNT(*) ". "FROM `". $pc2b7b ."Notes` n ". "JOIN `". $pc2b7b ."NotesKeywords` nk ON nk.`NoteID` = n.`ID` ". "WHERE ". $f56790 . "GROUP BY n.ID ". "HAVING COUNT(*)>=". $a9b0c2 ." ". "ORDER BY n.`Stamp` DESC ". "LIMIT ". $w7a86c .", ". $iaa9f7 ); $result=s0738($zac5c7)?z0d6b() : []; $b67363=s0738("SELECT FOUND_ROWS() AS cnt")?z0d6b() : []; $mfbb44=$b67363 ? (int)$b67363[0]['cnt']:0; $ub3b32=array(); if ($mfbb44){ $kae0fe=ceil($mfbb44/$vd7e5d); $ub3b32['timeline?']=true; $ub3b32['count']=$kae0fe; $ub3b32['this']=$x71860; $ub3b32['earlier-title']=$_strings['gs--earlier']; $ub3b32['later-title']=$_strings['gs--later']; $w920fa=$parameters; if ($x71860 < $kae0fe){ $w920fa['page']=$x71860+1; $ub3b32['earlier-href']=v83c8('e2m_tag',$w920fa); } if ($x71860 > 1){ $w920fa['page']=$x71860-1; $ub3b32['later-href']=v83c8('e2m_tag',$w920fa); } } if ($mfbb44==0){ if (!$m15514){ return e2_error404_mode(); } if ($x71860!=1){ return e2_error404_mode(); } } foreach($result as $z8ce4b => $iaad65){ $iaad65['_']['_id']=$iaad65['ID']; $iaad65['_']['_ord']=$z8ce4b; $iaad65['_']['_ord_max']=count($result)-1; $b4358b[] = r6791($iaad65); } if ($a9b0c2==1){ if ($m15514){ $w97a59['edit-href']=v83c8( 'e2m_tag_edit', array ('tag-alias' => $w7186e) ); } if (''!=$cd7df5['Description']) { $e2bfe4=wb7f1($cd7df5['Description'],'full'); $f67daf=$e2bfe4['text-final']; $w97a59['description']=$f67daf; $w97a59['description-format-info']=$e2bfe4['meta']; } $l3ad42=v83c8('e2m_tag_rss', array ('tag-alias' => $w7186e)); $c9d19f=v83c8('e2m_tag_json', array ('tag-alias' => $w7186e)); j3010( 'rss', q6f51() .': '. $cd7df5['Keyword'], $l3ad42 ); j3010( 'json', q6f51() .': '. $cd7df5['Keyword'], $c9d19f ); $w97a59['og-images']=hdbcc( 'tag',$cd7df5['ID'], $w97a59['description-format-info']['resources-detected'] ); } $x96963=( e2l_get_string('pt--n-posts', array ('number' => $mfbb44)). ' '. $_strings['gs--tagged'] ); $of74f5=array(); foreach ($o59aeb as $q9e366){ $of74f5[] = $q9e366['Keyword']; } $of74f5=implode(', ',$of74f5); $x2cb9d=array ( 'title' => q6f51() .': '. $of74f5, 'superheading' => $x96963, 'heading' => $of74f5, 'pages' => $ub3b32, 'notes' => $b4358b, ); if ($f67daf){ $x2cb9d['summary']=x5421($f67daf); } if(count($o59aeb)==1){ $x2cb9d['tag']=$w97a59; if (ee852()) { $x2cb9d['related-edit-href']=$w97a59['edit-href']; $x2cb9d['related-edit-title']=$_strings['tt--edit-tag']; } } if(__LOG)__log('} // Tag'); return $x2cb9d; } function e2m_tag_edit($parameters=array()) { global$_strings; if(array_key_exists('*tag',$parameters)) { $cd7df5=$parameters['*tag']; } if (!$cd7df5) return e2_error404_mode(); $ce449c=yc0c4( 'neasden',$cd7df5['Description'],'full' ); $c75e1b=zf898( 'tag',$cd7df5['ID'],$ce449c ); l2f83( 'Keywords', $cd7df5, $ce449c ); $fc999b=ud10e(); $kcd831=array ( '.tag-id' => $cd7df5['ID'], '.formatter-id' => 'neasden', 'form-action' => v83c8('e2s_tag_edit'), 'form-file-upload-action' => v83c8('e2j_file_upload'), 'form-file-remove-action' => v83c8('e2j_file_remove'), 'submit-text' => $_strings['fb--save-changes'], 'tag' => htmlspecialchars($cd7df5['Keyword'],ENT_COMPAT,HSC_ENC), 'urlname' => htmlspecialchars($parameters['tag-alias'],ENT_COMPAT,HSC_ENC), 'description' => htmlspecialchars($cd7df5['Description'],ENT_COMPAT,HSC_ENC), 'uploads' => $c75e1b, 'uploads-enabled?' => o1363($fc999b), 'favourite?' => (bool)$cd7df5['IsFavourite'], 'space-usage' => gaf64($fc999b), ); $kcd831['.cache-sensitive-hash']=md5( $kcd831['tag'] . $kcd831['uploads'] . $kcd831['urlname'] ); $x2cb9d=array ( 'body-uploads-enabled?' => o1363($fc999b), 'title' => $_strings['pt--tag-edit'] .': '. $cd7df5['Keyword'], 'heading' => $_strings['pt--tag-edit'], 'form' => 'form-tag', 'form-tag' => $kcd831, 'related-delete-href' => v83c8('e2m_tag_delete', array ('*tag' => $cd7df5)), ); return $x2cb9d; } function e2m_tag_flag_ajax($parameters){ if (c2e88($parameters)) { $v67142=$parameters; $v67142['value'] = !$parameters['value']; if($parameters['value']==1){ $p99859=v83c8('e2m_tag_flag_ajax',$v67142); $q1fa03='on-rehref|'. $p99859; } else { $p99859=v83c8('e2m_tag_flag_ajax',$v67142); $q1fa03='off-rehref|'. $p99859; } } else { $q1fa03='error'; } if(array_key_exists('result',$_POST) and ($_POST['result']=='ajaxresult')) { die ($q1fa03); } else { e2_go_to(v83c8('e2m_tag',$parameters)); die; } } function c2e88($parameters){ if(array_key_exists('*tag',$parameters)) { $cd7df5=$parameters['*tag']; } if (!$cd7df5) return e2_error404_mode(); @unlink(CACHE_FILENAME_FAVTAGS); @unlink(CACHE_FILENAME_TAGS); @unlink(CACHE_FILENAME_TAGS_AUTHOR); $result=paa79('Keywords', array ( 'ID' => $cd7df5['ID'], $parameters['flag'] => (int) ($parameters['value']==1), )); return$result; } function e2m_tag_delete($parameters=array()) { global$_strings; if(array_key_exists('*tag',$parameters)) { $cd7df5=$parameters['*tag']; } if (!$cd7df5) return e2_error404_mode(); $mecc14=array ( '.tag-id' => $cd7df5['ID'], 'caution-text' => e2l_get_string('gs--tag-will-be-deleted-notes-remain', array ( 'tag' => htmlspecialchars($cd7df5['Keyword'],ENT_COMPAT,HSC_ENC) )), 'tag' => htmlspecialchars($cd7df5['Keyword'],ENT_COMPAT,HSC_ENC), 'form-action' => v83c8('e2s_tag_delete'), 'submit-text' => $_strings['fb--delete'], ); $x2cb9d=array ( 'title' => $_strings['pt--tag-delete'] .': '. $cd7df5['Keyword'], 'heading' => $_strings['pt--tag-delete'], 'form' => 'form-tag-delete', 'form-tag-delete' => $mecc14, ); return $x2cb9d; } function e2m_untagged(){ global$_strings,$_config; return zd864(array ( 'query' => "SELECT n.* FROM `". $_config['db_table_prefix']."Notes` n ". "LEFT OUTER JOIN `". $_config['db_table_prefix']."NotesKeywords` nk ". "ON nk.`NoteID` = n.`ID` ". "WHERE `IsPublished`=1 ". "AND nk.KeywordID IS NULL ". a6f32(ee852()). "ORDER BY n.`Stamp` DESC", 'title' => $_strings['pt--posts-without-tags'], 'heading' => $_strings['pt--posts-without-tags'], 'nothing' => $_strings['gs--no-posts-without-tags'], 'show-all-notes' => true, )); return $x2cb9d; } function e2s_tag_edit(){ global$_strings,$_config; $r76f09=$me4d23=$f67daf=$fa7ff0=''; if(array_key_exists('tag-id',$_POST)) $r76f09=$_POST['tag-id']; if(array_key_exists('tag',$_POST)) $me4d23=$_POST['tag']; if(array_key_exists('description',$_POST)) $f67daf=trim($_POST['description'],"\r\n"); if(array_key_exists('urlname',$_POST)) $fa7ff0=trim($_POST['urlname'],"\r\n"); if(array_key_exists('cache-sensitive-hash',$_POST)) { $u3c58b=$_POST['cache-sensitive-hash']; $dbb9a8=md5($me4d23.$fa7ff0); } $me4d23=nff7c($me4d23); $f67daf=nff7c($f67daf); if (s0738( "SELECT * FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE ID = ".((int)$r76f09)."" )) { $l53e61=z0d6b(); if(count($l53e61)!=1) die; $sb19ad=$l53e61[0]; } if (s0738( "SELECT * FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE Keyword = '". y7928($me4d23) ."' ". "AND (ID != ".((int)$r76f09).")" )) { $l53e61=z0d6b(); if(count($l53e61)==0){ if ($dbb9a8!=$u3c58b){ z7996(); } @unlink(CACHE_FILENAME_FAVTAGS); @unlink(CACHE_FILENAME_TAGS); @unlink(CACHE_FILENAME_TAGS_AUTHOR); $sb19ad['ID'] = ((int)$r76f09); $sb19ad['Keyword']=$me4d23; $sb19ad['Description']=$f67daf; if (paa79('Keywords',$sb19ad)) { $x17901=bd712( 'set',ENTITY_TYPE_TAG,$sb19ad['ID'],$fa7ff0 ); e2_go_to(v83c8('e2m_tag', array ('tag-alias' => $x17901))); } else { s4930(); } } else { p8a40($_strings['er--cannot-rename-tag'],E2E_USER_ERROR); s4930(); } } else { s4930(); } die; } function e2s_tag_delete(){ global$_strings,$_config; $sb80bb=((int)$_POST['tag-id']); z7996(); @unlink(CACHE_FILENAME_FAVTAGS); @unlink(CACHE_FILENAME_TAGS); @unlink(CACHE_FILENAME_TAGS_AUTHOR); $d444bc=( s0738( "DELETE FROM `". $_config['db_table_prefix']."Keywords` WHERE `ID`=". $sb80bb ) and s0738( "DELETE FROM `". $_config['db_table_prefix']."NotesKeywords` WHERE `KeywordID`=". $sb80bb ) ); if ($d444bc){ e2_go_to(v83c8('e2m_tags')); die; } else { s4930(); die; } } function haf16($p07f25){ global$_current_tag,$_config; $f9df9d=null; if(CACHE_FAVTAGS and is_file(CACHE_FILENAME_FAVTAGS)) { $f9df9d=@unserialize(file_get_contents(CACHE_FILENAME_FAVTAGS)); } if (!is_array($f9df9d)) { s0738( "SELECT * FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE IsFavourite = 1 ORDER BY `Keyword`" ); $y9cdff=z0d6b(); $f9df9d=array(); foreach ($y9cdff as $t04ff0){ $mc6827['tag']=htmlspecialchars($t04ff0['Keyword'],ENT_NOQUOTES,HSC_ENC); $mc6827['href']=v83c8( 'e2m_tag', array ('*tag' => $t04ff0) ); $f9df9d[] = $mc6827; } if(CACHE_FAVTAGS)x6e52(CACHE_FILENAME_FAVTAGS,serialize($f9df9d)); } $n8a4f1=false; foreach ($f9df9d as $z8ce4b => $q9e366){ $f9df9d[$z8ce4b]['current?'] = ( $f9df9d[$z8ce4b]['tag']==$_current_tag ); if ($f9df9d[$z8ce4b]['current?']) { $n8a4f1=true; $q08187=$p07f25; $q08187['flag']='IsFavourite'; $q08187['value']=0; if (ee852()) { $f9df9d[$z8ce4b]['pinnable?']=true; $f9df9d[$z8ce4b]['pinned?']=true; $f9df9d[$z8ce4b]['pinned-toggle-href'] = ( v83c8('e2m_tag_flag_ajax',$q08187) ); } } } if (ee852()) { if (!$n8a4f1 and array_key_exists('*tag',$p07f25)) { $ca55a9=$p07f25; $ca55a9['flag']='IsFavourite'; $ca55a9['value']=1; $id5a7a=array ( 'tag' => htmlspecialchars($p07f25['*tag']['Keyword'],ENT_NOQUOTES,HSC_ENC), 'href' => v83c8('e2m_tag',$p07f25), 'current?' => true, 'pinnable?' => true, 'pinned?' => false, 'pinned-toggle-href' => v83c8('e2m_tag_flag_ajax',$ca55a9), ); $f9df9d[] = $id5a7a; } } return $f9df9d; } function sce23($z21158,$parameters=''){ global$_config; $k0dff3=array(); if (s0738( "SELECT `". $_config['db_table_prefix']."Keywords`.* ". "FROM `". $_config['db_table_prefix']."Keywords`, ". "`". $_config['db_table_prefix']."NotesKeywords` ". "WHERE `". $_config['db_table_prefix']."NotesKeywords`.NoteID=". ((int)$z21158) ." ". "AND `". $_config['db_table_prefix']."Keywords`.ID=`". $_config['db_table_prefix']."NotesKeywords`.KeywordID ". "ORDER BY `Keyword`" )) { $k0dff3=z0d6b(); } return $k0dff3; } function v53f1($ueaa60){ global$_config; $z316e8=array(); foreach (array ( 'ID', 'NoteID', 'KeywordID', ) as $k06e3d) if(array_key_exists($k06e3d,$ueaa60)) { $v6a7f2[] = '`'. $k06e3d .'`'."='". y7928($ueaa60[$k06e3d]) ."'"; if ($k06e3d=='ID')$b729d6='tagbinging-id'; if ($k06e3d=='NoteID')$b729d6='tagbinging-note-id'; if ($k06e3d=='KeywordID')$b729d6='tagbinging-tag-id'; $z316e8[$b729d6]=$ueaa60[$k06e3d]; } $p1b1cc=( "DELETE FROM `". $_config['db_table_prefix']."NotesKeywords` ". "WHERE ". implode(' AND ',$v6a7f2) ); if (s0738($p1b1cc)) { return true; } } function ecbd4($ueaa60){ global$_config; if (!array_key_exists('ID',$ueaa60) or !is_numeric($ueaa60['ID'])) { die ('API MISUSE: e2q_update_tagbinding must be called with an ID field in $tagbinding_record'); } $v6a7f2=array(); foreach (array ( 'NoteID', 'KeywordID', ) as $k06e3d) if(array_key_exists($k06e3d,$ueaa60)) { $v6a7f2[] = '`'. $k06e3d .'`'."='". y7928($ueaa60[$k06e3d]) ."'"; } if(count($v6a7f2) > 0){ $p1b1cc = "UPDATE `". $_config['db_table_prefix']."NotesKeywords` ". "SET ". implode(', ',$v6a7f2) ." ". "WHERE `ID`=". $ueaa60['ID']; if (s0738($p1b1cc)) { return true; } } } function h03de($me4d23){ @unlink(CACHE_FILENAME_TAGS); @unlink(CACHE_FILENAME_TAGS_AUTHOR); $sb19ad=array ( 'Keyword' => $me4d23, 'OriginalAlias' => bd712('find',ENTITY_TYPE_UNSPECIFIED,'',$me4d23), 'Description' => '', ); if (($sb19ad=f9943('Keywords',$sb19ad)) !== false){ $h419a1=bd712( 'set',ENTITY_TYPE_TAG,$sb19ad['ID'],$me4d23 ); if ($h419a1!=$sb19ad['OriginalAlias']) { $sb19ad['OriginalAlias']=$h419a1; paa79('Keywords',$sb19ad); } return $sb19ad['ID']; } } function e5d57(){ global$_config; $m15514=ee852(); $ed29bb=CACHE_FILENAME_TAGS; if ($m15514)$ed29bb=CACHE_FILENAME_TAGS_AUTHOR; $q8da94=null; if(CACHE_TAGS and is_file($ed29bb)) { $q8da94=@unserialize(file_get_contents($ed29bb)); } if (!is_array($q8da94)) { s0738( "SELECT * FROM `". $_config['db_table_prefix']."Keywords` ". "ORDER BY `Keyword`" ); $y35016=array(); foreach (z0d6b() as $sb19ad){ $me4d23['tag']=htmlspecialchars($sb19ad['Keyword'],ENT_NOQUOTES,HSC_ENC); $me4d23['href']=v83c8('e2m_tag', array ('*tag' => $sb19ad)); $me4d23['favourite?'] = (bool)$sb19ad['IsFavourite']; $me4d23['notes-count']=0; $me4d23['last-used']=0; $me4d23['freshness']=0; $me4d23['weight']=0; $y35016[$sb19ad['ID']] = $me4d23; } s0738( "SELECT nk.KeywordID, COUNT(DISTINCT n.ID) as Count, max(n.Stamp) as LastUsed ". "FROM `". $_config['db_table_prefix']."NotesKeywords` nk, ". "`". $_config['db_table_prefix']."Notes` n ". "WHERE nk.NoteID = n.ID AND n.IsPublished ". a6f32($m15514). "GROUP BY nk.KeywordID" ); $k9fdd5=0; $k8f57c=0; $a06894=0; foreach (z0d6b() as $t28a42){ $mc6827 =& $y35016[$t28a42['KeywordID']]; $mc6827['notes-count']=$t28a42['Count']; if (@$mc6827['last-used'] < $t28a42['LastUsed']) { $mc6827['last-used']=$t28a42['LastUsed']; $h452b4=(time()-$mc6827['last-used']) / SECONDS_IN_A_YEAR; $mc6827['freshness']=pow(1/2,$h452b4); } $k9fdd5=max($k9fdd5,$mc6827['notes-count']); $k8f57c=max($k8f57c,$mc6827['freshness']); $a06894=max($a06894,$mc6827['notes-count']*$mc6827['freshness']); } $q8da94=array(); foreach ($y35016 as $v865c0 => $q9e366){ if (!$m15514 and $q9e366['notes-count']==0) continue; $f95e80=mb_strtolower($q9e366['tag']); $q8da94[$f95e80]=$q9e366; if ($k8f57c!=0){ $q8da94[$f95e80]['freshness']=$q9e366['freshness']/$k8f57c; } else { $q8da94[$f95e80]['freshness']=0; } if ($a06894!=0){ $q8da94[$f95e80]['weight'] = ( $q9e366['freshness']*$q9e366['notes-count']/$a06894 ); } else { $q8da94[$f95e80]['weight']=0; } if ($q8da94[$f95e80]['favourite?'])$q8da94[$f95e80]['weight']=1; } if(CACHE_TAGS)x6e52($ed29bb,serialize($q8da94)); } return $q8da94; } function za463($z21158,$bda3ad='Keyword'){ global$_config; if (s0738( "SELECT `". $_config['db_table_prefix']."Keywords`.* ". "FROM `". $_config['db_table_prefix']."Keywords`, ". "`". $_config['db_table_prefix']."NotesKeywords` ". "WHERE `". $_config['db_table_prefix']."NotesKeywords`.NoteID=".((int)$z21158)." AND ". "`". $_config['db_table_prefix']."Keywords`.ID=". "`". $_config['db_table_prefix']."NotesKeywords`.KeywordID ". "ORDER BY `".$bda3ad."`" ))$bfa816=z0d6b(); else $bfa816=array(); $o59aeb=array(); foreach ($bfa816 as $oe358e)$o59aeb[] = $oe358e; return $o59aeb; } function p0188($cd7df5){ global$_config; if (s0738( "SELECT * FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `Keyword`='".y7928($cd7df5)."'" )) { $z8ce4b=z0d6b(); if (isset ($z8ce4b[0])) return $z8ce4b[0]; } return null; } function p8770($nd7ca3){ global$_config; if (s0738( "SELECT * FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `OriginalAlias`='".y7928($nd7ca3)."'" )) $bfa816=z0d6b(); else $bfa816=array(); if (isset ($bfa816[0])) return $bfa816[0]; else return FALSE; } function s4e28($sb80bb){ global$_config; if (s0738( "SELECT * FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `ID`='".((int)$sb80bb)."'" )) { $z8ce4b=z0d6b(); if (isset ($z8ce4b[0])) { $z8ce4b=$z8ce4b[0]; return $z8ce4b; } else { return NULL; } } return NULL; } function e2_tagrecs_with_parameters_($parameters){ $sbdcf3=array(); if (@$parameters['tag-alias'] or $parameters['tag-alias']==='0'){ $sbdcf3=explode(',',$parameters['tag-alias']); } $k0dff3=array(); foreach ($sbdcf3 as $nd7ca3) if ($nd7ca3 or $nd7ca3==='0'){ if ( $cc45dd=e2_aliasrec_of_alias_(@$nd7ca3) and ($cc45dd['EntityType']==ENTITY_TYPE_TAG) and ($sb19ad=s4e28($cc45dd['EntityID'])) ) { $k0dff3[] = $sb19ad; } else { if ($s3ee3f=p8770($nd7ca3)) { $k0dff3[] = $s3ee3f; } } } return $k0dff3; } function n2e04(){ global$full_blog_url; static $p0d5f1; $y3c6e0=y7874(); if (empty ($p0d5f1)) { $p0d5f1=md5($full_blog_url .'email'. $y3c6e0); } return $p0d5f1; } function fd8c5(){ global$full_blog_url; static $s05fa8; $y3c6e0=y7874(); if (empty ($s05fa8)) { $s05fa8=md5($full_blog_url .'nospam'. $y3c6e0.date('n-Y')); } return $s05fa8; } function te7ec(){ global$full_blog_url; static $r6f410; $y3c6e0=y7874(); if(empty($r6f410)) { $r6f410=md5($full_blog_url .'nospam'. $y3c6e0.date('n-Y',strtotime('-1 month'))); } return $r6f410; } function f41f3($z21158){ global$full_blog_url; $y3c6e0=y7874(); return p8c3b('comment_'. md5($full_blog_url .'nospam_cookie'. $y3c6e0.$z21158)); } function y7c9d(){ global$full_blog_url; $b83647=$_SERVER['HTTP_USER_AGENT']; $y3c6e0=y7874(); return md5($full_blog_url .'nospam_cookie'. $y3c6e0.$b83647); } function peb9a(){ if ( array_key_exists('email',$_POST) and $_POST['email']!=='' ) return true; $s05fa8=fd8c5(); $r6f410=te7ec(); if ( !array_key_exists($s05fa8,$_POST) and !array_key_exists($r6f410,$_POST) ) return true; if ( ( array_key_exists($s05fa8,$_POST) and $_POST[$s05fa8]!=='' ) or ( array_key_exists($r6f410,$_POST) and $_POST[$r6f410]!=='' ) ) return true; if ( !array_key_exists('comment',$_POST) or (strlen($_POST['comment']) > 6) ) return true; return false; } function e2_cookie_data_is_spam_suspicios_for_note_id_($z21158){ if ( !array_key_exists(f41f3($z21158),$_COOKIE) or ($_COOKIE[f41f3($z21158)] !== y7c9d()) ) return true; return false; } function e2m_comment($parameters=array ()) { e2_go_to(v83c8('e2m_note',$parameters)); die; } function e2m_comment_edit($parameters=array ()) { return w4fb7('edit',$parameters); } function w4fb7($m60cd8,$parameters=array ()) { global$_config,$_strings,$full_blog_url; $ud5d3d=$of74f5=$_strings['pt--new-comment']; $l69b97='new'; if ($m60cd8=='edit'){ $h4032b=e2_commentrec_with_parameters_($parameters); $rc50d0=$_strings['fb--save-changes']; $b39a37=$h4032b['noterec']; $ud5d3d=$of74f5=$_strings['pt--edit-comment']; $c1aec6=v86f8($b39a37,$h4032b,$parameters['comment-number']); $l69b97=$yaca8d['ID']; if (!$h4032b){ return e2_error404_mode(); } $e80f02=array ( '.note-id' => $h4032b['NoteID'], '.comment-id' => $h4032b['ID'], '.comment-number' => $parameters['comment-number'], '.already-subscribed?' => false, '.gip' => $h4032b['GIP'], '.from' => substr($_SERVER['HTTP_REFERER'],strlen($full_blog_url)+1), 'create:edit?' => false, 'form-action' => v83c8('e2s_comment_process'), 'submit-text' => $rc50d0, 'show-subscribe?' => true, 'subscribe?' => (bool)$h4032b['IsSubscriber'], 'name' => htmlspecialchars($h4032b['AuthorName'],ENT_COMPAT,HSC_ENC), 'email' => htmlspecialchars($h4032b['AuthorEmail'],ENT_COMPAT,HSC_ENC), 'text' => htmlspecialchars($h4032b['Text'],ENT_COMPAT,HSC_ENC), 'email-field-name' => n2e04(), ); if (''!=trim($h4032b['IP'])) { $e80f02['ip']=$h4032b['IP']; $e80f02['ip-href']=$_config['whois_service'].$e80f02['ip']; } } $x2cb9d=array ( 'title' => $ud5d3d, 'heading' => $of74f5, 'form' => 'form-comment', 'form-comment' => $e80f02, ); if (!empty ($c1aec6)) { $x2cb9d['comments'] = array ('each' => array ('only' => $c1aec6)); } return $x2cb9d; } function e2m_comment_reply($parameters=array ()) { global$_strings; $h4032b=e2_commentrec_with_parameters_($parameters); if (!$h4032b){ return e2_error404_mode(); } $b39a37=$h4032b['noterec']; $c1aec6=v86f8($b39a37,$h4032b,$parameters['comment-number']); $c1aec6['_']['_id']=$h4032b['ID']; $c1aec6['_']['_ord']=0; $c1aec6['_']['_ord_max']=0; $c1aec6['replying?'] = (bool)true; $f817c7=($h4032b['Reply']=='' or !$h4032b['IsReplyVisible']); $ud5d3d=$f817c7? $_strings['pt--reply-to-comment']:$_strings['pt--edit-reply-to-comment']; $g4dc70=array ( '.note-id' => $b39a37['ID'], '.comment-id' => $h4032b['ID'], '.reply-action' => $f817c7? 'new':'edit', 'form-action' => v83c8('e2s_comment_edit_reply'), 'submit-text' => $f817c7? $_strings['fb--publish']:$_strings['fb--save-changes'], 'create:edit?' => (bool) ($f817c7), 'reply-text' => htmlspecialchars($h4032b['Reply'],ENT_COMPAT,HSC_ENC), 'mail-back?' => (bool) ($f817c7), ); return array ( 'title' => $ud5d3d, 'heading' => $ud5d3d, 'comments' => array ('each' => array ('only' => $c1aec6)), 'form' => 'form-comment-reply', 'form-comment-reply' => $g4dc70, ); } function e2m_comment_delete($parameters=array ()) { global$_strings,$settings,$zcbcce,$_config; $h4032b=e2_commentrec_with_parameters_($parameters); $z21158=$h4032b['NoteID']; if (!$h4032b){ return e2_error404_mode(); } e2_drop_caches_for_note_($z21158); @unlink(USER_FOLDER. '/last-comment.psa'); s0738( "DELETE FROM `". $_config['db_table_prefix']."Comments` ". "WHERE `ID` = '".((int)$h4032b['ID'])."'" ); s4930(); die; } function e2m_comment_reply_delete($parameters=array ()) { global$_strings,$settings,$_config; $h4032b=e2_commentrec_with_parameters_($parameters); if (!$h4032b){ return e2_error404_mode(); } s0738( "UPDATE `". $_config['db_table_prefix']."Comments` SET ". "`Reply`='', ". "`IsReplyFavourite`='0' ". "WHERE `ID`=".((int)$h4032b['ID']) ); s4930(); die; } function e2m_unsubscribe($parameters){ global$_strings,$_config; $e70a17="ORDER BY `ID` DESC"; $b39a37=$parameters['*note']; $z21158=$b39a37['ID']; $z0c83f=$parameters['unsubscribe-email']; $g1bc29=$parameters['unsubscribe-key']; $z0c83f=str_replace(' ','+',$z0c83f); if ($z21158){ if (s0738( "SELECT `ID`, `Stamp` FROM `". $_config['db_table_prefix']."Comments` ". "WHERE `NoteID`=". $z21158 ." AND `IsSubscriber`=1 AND `AuthorEmail`='". $z0c83f ."' ". $e70a17 )) { $result=z0d6b(); if(count($result) < 1) { $x2cb9d['unsubscribe']['success?']=false; $x2cb9d['unsubscribe']['error-message']=$_strings['gs--you-are-not-subscribed']; } else { $f06d4c=@$result[0]; $p97f69=md5($f06d4c['ID'].$f06d4c['Stamp'] .'x'); $t260ca=false; if ($g1bc29==$p97f69){ if (s0738( "UPDATE `". $_config['db_table_prefix']."Comments` SET `IsSubscriber`=0 ". "WHERE `NoteID`=". $z21158 ." AND `AuthorEmail` = '".y7928($z0c83f)."'" )) { $t260ca=true; $x2cb9d['unsubscribe']['success?']=true; $x2cb9d['unsubscribe']['note-title']=i6f10( htmlspecialchars($b39a37['Title'],ENT_COMPAT,HSC_ENC) ); $x2cb9d['unsubscribe']['note-href']=v83c8( 'e2m_note', array ('*note' => $b39a37) ); } } if (!$t260ca){ $x2cb9d['unsubscribe']['success?']=false; $x2cb9d['unsubscribe']['error-message']=$_strings['gs--unsubscription-didnt-work']; } } } else { $x2cb9d['unsubscribe']['success?']=false; $x2cb9d['unsubscribe']['error-message']=$_strings['gs--comment-not-found']; } } else { $x2cb9d['unsubscribe']['success?']=false; $x2cb9d['unsubscribe']['error-message']=$_strings['gs--post-not-found']; } return $x2cb9d; } function e2m_comment_flag($parameters){ v6e30($parameters); e2_go_to(v83c8('e2m_note',$parameters)); die; } function e2m_comment_flag_ajax($parameters){ if (v6e30($parameters)) { $v67142=$parameters; $v67142['value'] = !$parameters['value']; if($parameters['value']==1){ $p99859=v83c8('e2m_comment_flag_ajax',$v67142); $q1fa03='on-rehref|'. $p99859; } else { $p99859=v83c8('e2m_comment_flag_ajax',$v67142); $q1fa03='off-rehref|'. $p99859; } } else { $q1fa03='error'; } if(array_key_exists('result',$_POST) and ($_POST['result']=='ajaxresult')) { die ($q1fa03); } else { e2_go_to(v83c8('e2m_note',$parameters)); die; } } function v6e30($parameters){ $h4032b=e2_commentrec_with_parameters_($parameters); $z21158=$h4032b['NoteID']; $result=false; if ($h4032b){ $result=paa79('Comments', array ( 'ID' => $h4032b['ID'], $parameters['flag'] => (int) ($parameters['value']==1), )); e2_drop_caches_for_note_($z21158); } return$result; } function e2s_comment_process(){ global$_strings,$_fp_error; list ($z21158,$l69b97,$z9d090)=c1a90(); if(__LOG)__log('Comments: processed, noteid <'. $z21158 .'>, commentid <'. $l69b97 .'>'); if (!$l69b97){ $v05c36=''; if($_fp_error==FP_NOT_COMMENTABLE){ p8a40($_strings['er--post-not-commentable'],E2E_USER_ERROR); } elseif($_fp_error==FP_EMPTY_FIELD){ p8a40($_strings['er--name-email-text-required'],E2E_USER_ERROR); } elseif($_fp_error==FP_COMMENT_TOO_LONG){ $daa731=$_strings['gs--comment-too-long']; $v05c36=$_strings['gs--comment-too-long-description']; } elseif($_fp_error==FP_COMMENT_DOUBLE_POST){ $daa731=$_strings['gs--comment-double-post']; $v05c36=$_strings['gs--comment-double-post-description']; } elseif($_fp_error==FP_COMMENT_SPAM_SUSPECT){ $daa731=$_strings['gs--comment-spam-suspect']; $v05c36=$_strings['gs--comment-spam-suspect-description']; } else { p8a40($_strings['er--error-occurred'].' ('. $_fp_error .')'); } if ($v05c36){ $x2cb9d['title']=$daa731; $x2cb9d['heading']=$daa731; $x2cb9d['form']='form-unaccepted-comment'; $x2cb9d['form-unaccepted-comment'] = array ( 'reason' => $v05c36, 'text' => @htmlspecialchars($z9d090['text'],ENT_COMPAT,HSC_ENC), ); return $x2cb9d; } } if ($z21158){ e2_go_to(v83c8('e2m_note', array ('*note' => h4627($z21158)))); } else { e2_go_to(); } die; } function e2s_comment_edit_reply(){ global$_strings,$s57de2,$_config; $ge84af=@$_POST['text']; if(trim($ge84af)=='')$ge84af=''; $z21158=@$_POST['note-id']; $iaad65=h4627($z21158); $l69b97=@$_POST['comment-id']; $f06d4c=nb559($l69b97); $r54eb6=isset ($_POST['mail-back']); $f54fa9=time(); if (@$_POST['reply-action']=='new'){ $ve0e30=time(); } @unlink(e2_note_cache_filename_with_id_($z21158 .'-comments')); @unlink(e2_note_cache_filename_with_id_($z21158 .'-comments-author')); if ($f06d4c and s0738( "UPDATE `". $_config['db_table_prefix']."Comments` SET ". "`Reply`='". y7928($ge84af) ."', ". ( isset ($ve0e30)? ( "`ReplyStamp`='". $ve0e30 ."', " ) : ( "" ) ). "`ReplyLastModified`='". $f54fa9 ."', ". "`IsReplyVisible`='1' ". "WHERE `ID`=".((int)$l69b97) )) { $td58c0=v83c8('e2m_note', array ('*note' => $iaad65)); if ($r54eb6 and $ge84af!=''){ $mc6827['comment-time'] = array ($f06d4c['Stamp'],e5c05()); $mc6827['commenter']=$f06d4c['AuthorName']; $mc6827['commenter-email']=$f06d4c['AuthorEmail']; $mc6827['comment-text']=$f06d4c['Text']; $mc6827['note-title']=i6f10($iaad65['Title']); $mc6827['reply-time'] = array (time(),e5c05()); $mc6827['blog-author']=u2640(); $mc6827['note-href']=$td58c0; $mc6827['comment-href']=$td58c0; $mc6827['reply-text']=$ge84af; if(1){ $hde7a3=b3e5c( 'comment-reply',$mc6827 ); $cb904c=e2l_get_string( 'em--comment-reply', $mc6827 ); $v77613=$f06d4c['AuthorEmail']; $d1a49b='From: '. yaed2(); ia41b($v77613,$cb904c,$hde7a3,$d1a49b); } if(1){ unset ($mc6827['commenter-email']); $d1a49b='From: '. yaed2(); foreach (u4975($iaad65,$f06d4c['AuthorEmail']) as $u39c63){ $iba570=$u39c63['AuthorEmail']; $e6fd85=md5($u39c63['ID'].$u39c63['Stamp'].'x'); $mc6827['unsubscribe-href']=v83c8('e2m_unsubscribe', array ( '*note' => $iaad65, 'unsubscribe-email' => $iba570, 'unsubscribe-key' => $e6fd85, ) ); $v77613=$iba570; $hde7a3=b3e5c('comment-reply-to-public',$mc6827); $cb904c=e2l_get_string( 'em--comment-reply-to-public-subject', $mc6827 ); ia41b($v77613,$cb904c,$hde7a3,$d1a49b); } } } e2_go_to($td58c0); } else { s4930(); } die; } function v86f8($iaad65,$f06d4c,$wb1bc2){ global$_config,$full_blog_url; if(__LOG)__log('Comments: package comment <'. $f06d4c['ID'] .'>...'); if ($iaad65===null){ $iaad65=h4627($f06d4c['NoteID']); } $mc6827['number']=$wb1bc2; $u7b397=!empty ($f06d4c['IsGIPUsed']); $mc6827['gip-used?']=$u7b397; $mc6827['gip']=$mc6827['gip-used?']?$f06d4c['GIP']:''; $mc6827['name']=htmlspecialchars($f06d4c['AuthorName'],ENT_NOQUOTES,HSC_ENC); $mc6827['userpic-href']=DEFAULT_USERPIC_FILENAME; if ($u7b397){ $g51c69=AVATARS_FOLDER.$f06d4c['GIP'] .'-'. $f06d4c['GIPAuthorID'] .'.jpg'; if(is_file(MEDIA_ROOT_FOLDER.$g51c69)) { $mc6827['userpic-href']=$full_blog_url .'/'. $g51c69; } } $mc6827['name-href']=''; if ( $u7b397 and $v020fc=e2_get_user_profile_url($f06d4c['GIP'],$f06d4c['AuthorProfileLink']) ) { $mc6827['name-href']=$v020fc; } if (ee852()) { $mc6827['email']=htmlspecialchars($f06d4c['AuthorEmail'],ENT_NOQUOTES,HSC_ENC); if (''!=trim($f06d4c['IP'])) { $mc6827['ip']=$f06d4c['IP']; $mc6827['ip-href']=$_config['whois_service'].$mc6827['ip']; } } $mc6827['author-name']=u2640(); $mc6827['important?'] = (bool)$f06d4c['IsFavourite']; $mc6827['reply-visible?'] = (bool) ($f06d4c['IsVisible'] && $f06d4c['IsReplyVisible']); $mc6827['reply-important?'] = (bool)$f06d4c['IsReplyFavourite']; $mc6827['spam-suspect?'] = (bool)$f06d4c['IsSpamSuspect']; $x10a7e=array ((int)$f06d4c['Stamp'],m0923($iaad65)); $mc6827['time']=$x10a7e; $mc6827['last-modified']=$x10a7e; if ($f06d4c['LastModified']) $mc6827['last-modified'] = array ((int)$f06d4c['LastModified'],m0923($iaad65)); if ($f06d4c['ReplyStamp']) $mc6827['reply-time'] = array ((int)$f06d4c['ReplyStamp'],m0923($iaad65)); if ($f06d4c['ReplyLastModified']) $mc6827['reply-last-modified'] = array ((int)$f06d4c['ReplyLastModified'],m0923($iaad65)); if (ee852()) { $mc6827['subscriber?'] = (bool)$f06d4c['IsSubscriber']; $mc6827['new?'] = (bool)$f06d4c['IsNew']; $mc6827['first-new?']=false; if (!@$_config['read_only']) { if ($f06d4c['IsFavourite']) { $mc6827['important-toggle-href']=v83c8( 'e2m_comment_flag_ajax', array ('*note' => $iaad65,'comment-number' => $wb1bc2,'flag' => 'IsFavourite','value' => 0) ); } else { $mc6827['important-toggle-href']=v83c8( 'e2m_comment_flag_ajax', array ('*note' => $iaad65,'comment-number' => $wb1bc2,'flag' => 'IsFavourite','value' => 1) ); } if ($f06d4c['IsReplyFavourite']) { $mc6827['reply-important-toggle-href']=v83c8( 'e2m_comment_flag_ajax', array ( '*note' => $iaad65,'comment-number' => $wb1bc2,'flag' => 'IsReplyFavourite','value' => 0 ) ); } else { $mc6827['reply-important-toggle-href']=v83c8( 'e2m_comment_flag_ajax', array ( '*note' => $iaad65,'comment-number' => $wb1bc2,'flag' => 'IsReplyFavourite','value' => 1 ) ); } $mc6827['edit-href']=v83c8( 'e2m_comment_edit', array ('*note' => $iaad65,'comment-number' => $wb1bc2) ); $mc6827['removed-toggle-href']=v83c8( 'e2m_comment_flag_ajax', array ( '*note' => $iaad65,'comment-number' => $wb1bc2, 'flag' => 'IsVisible','value' => !$f06d4c['IsVisible'] ) ); $mc6827['removed-reply-toggle-href']=v83c8( 'e2m_comment_flag_ajax', array ( '*note' => $iaad65,'comment-number' => $wb1bc2, 'flag' => 'IsReplyVisible','value' => !$f06d4c['IsReplyVisible'] ) ); $ue36ef=v83c8( 'e2m_comment_reply', array ('*note' => $iaad65,'comment-number' => $wb1bc2) ); if ($f06d4c['Reply']=='' or !$f06d4c['IsReplyVisible']) { $mc6827['reply-href']=$ue36ef; } else { $mc6827['edit-reply-href']=$ue36ef; } } } if(mb_strlen($f06d4c['Text']) > $_config['max_comment_length']) { $f06d4c['Text']=mb_substr($f06d4c['Text'],0,$_config['max_comment_length']); } $gb64b8=$iaad65['FormatterID']==='raw'?'neasden':$iaad65['FormatterID']; $e2bfe4=q154e($gb64b8,$f06d4c['Text'],'simple'); $mc6827['text']=$e2bfe4['text-final']; $mc6827['replying?'] = (bool)false; $mc6827['replied?'] = (bool) ( (trim($f06d4c['Reply']) != '') && ($f06d4c['IsReplyVisible']) ); $e2bfe4=q154e($iaad65['FormatterID'],$f06d4c['Reply'],'full'); $mc6827['reply']=$e2bfe4['text-final']; if(array_key_exists('_',$f06d4c))$mc6827['_']=$f06d4c['_']; if(__LOG)__log('Comments: done'); return $mc6827; } function nb559($sb80bb){ global$_config; if (s0738( "SELECT * FROM `". $_config['db_table_prefix']."Comments` ". "WHERE `ID` = '".$sb80bb."'" )) { $bfa816=z0d6b(); if(count($bfa816) > 0) return $bfa816[0]; } return false; } function je5b6($f0604c){ e2_comment_set_flag('IsVisible',$f0604c); } function y3183($z0dd2c){ e2_comment_set_flag('IsReplyVisible',$z0dd2c); } function d66aa($pea59a){ global$_strings,$_config,$settings; $we3cb9=@$_COOKIE[p8c3b('commenter_name')]; $kf92ee=@$_COOKIE[p8c3b('commenter_email')]; $q3d682=@$_COOKIE[p8c3b('commenter_ph')]; $o92399=false; if ($kf92ee and $q3d682){ foreach (u4975($pea59a) as $u39c63){ $p97f69=md5($u39c63['ID'].$u39c63['Stamp'] .'x'); if ( $u39c63['AuthorEmail']==$kf92ee and $q3d682==$p97f69 ){ $o92399=true; break; } } } $rc50d0=$_strings['fb--submit']; $s05fa8=fd8c5(); $e80f02=array ( '.note-id' => $pea59a['ID'], '.comment-id' => 'new', '.already-subscribed?' => (bool)$o92399, 'cookie-name' => f41f3($pea59a['ID']), 'cookie-value' => y7c9d(), 'email-field-name' => n2e04(), 'nospam-field-name-part-1' => substr($s05fa8,0,4), 'nospam-field-name-part-2' => substr($s05fa8,4), 'create:edit?' => true, 'form-action' => v83c8('e2s_comment_process'), 'submit-text' => $rc50d0, 'show-subscribe?' => (bool) !$o92399, 'subscribe?' => (bool)$o92399, 'subscription-status' => $o92399? $_strings['gs--you-are-already-subscribed']:'', 'name' => htmlspecialchars($we3cb9,ENT_COMPAT,HSC_ENC), 'email' => htmlspecialchars($kf92ee,ENT_COMPAT,HSC_ENC), 'text' => htmlspecialchars($f06d4c['Text'],ENT_COMPAT,HSC_ENC), 'email-comments-enabled?' => empty ($settings['comments']['require_gip']), 'gips' => array (), ); $e73ce1=false; $uafda1=''; foreach(e2_list_gips() as $g48e15){ if (!is_file(SYSTEM_FOLDER .'gips/'. $g48e15 .'.json')) { continue; } $u2ce07=e2_is_logged_in($g48e15); $e80f02['gips'][$g48e15] = ( e2_get_gip_auth_url($g48e15) ); if ($u2ce07){ $e73ce1=true; $ia64f4=e2_get_gip_session($g48e15); $uafda1=$ia64f4['GIP']; $e80f02['name']=htmlspecialchars( $ia64f4['AuthorName'],ENT_COMPAT,HSC_ENC ); } } if (!$e80f02['email-comments-enabled?'] and !count($e80f02['gips'])) { return false; } $e80f02['email-comments-only?'] = (count($e80f02['gips']) === 0); $e80f02['logged-in?']=$e73ce1; $e80f02['logged-in-gip']=$uafda1; $e80f02['logout-url']=$e73ce1?v83c8('e2m_gip_sign_out', array('provider' => E2GIP::get_logout_key())) : ''; return $e80f02; } function q3ce7($z21158){ return hb23e($z21158,'`IsNew` = 1'); } function p254f($z21158){ return hb23e($z21158,'`IsVisible` = 1'); } function r8085($z21158){ return hb23e($z21158,'1'); } function hb23e($z21158,$f56790){ global$_config; if (!is_numeric($z21158)) return 0; $zbc751=0; if (s0738( "SELECT count(*) FROM `". $_config['db_table_prefix']."Comments` ". "WHERE `NoteID`=". $z21158 ." ". "AND (". $f56790. ")" )) { $result=z0d6b(); $result=(int)$result[0]['count(*)']; $zbc751=$result; } return (int)$zbc751; } function c2a6b(){ global$_config; $re2942=0; $l7ec7e=''; $fe8fab=''; if (s0738( "SELECT `NoteID`, `Text` FROM `". $_config['db_table_prefix']."Comments` ". "WHERE `IsNew`=1 ORDER BY `Stamp`" )) { $result=z0d6b(); $re2942=count($result); if ($re2942){ $z21158=$result[0]['NoteID']; $fe8fab=v83c8( 'e2m_note', array ('*note' => h4627($z21158)) ); } else { $fe8fab=''; } } return array ((int)$re2942,$l7ec7e,$fe8fab); } function i70a7($z21158){ global$_config; if(__LOG)__log('Comments: getting comments for note '. $z21158); if (s0738( "SELECT * FROM `". $_config['db_table_prefix']."Comments` ". "WHERE `NoteID`=". @$z21158." ". "ORDER BY `Stamp`" )) { $result=z0d6b(); return$result; } return array (); } function u4975($iaad65,$dd1cc6=''){ global$_config; $e70a17="ORDER BY `ID` DESC"; $x2cb9d=$haf67c=array(); if (s0738( "SELECT DISTINCT `ID`, `Text`, `IsSubscriber`, `AuthorName`, `AuthorEmail`, `Stamp` ". "FROM `". $_config['db_table_prefix']."Comments` ". "WHERE `NoteID`=". @$iaad65['ID'] ." ". "AND `IsSubscriber`=1 ". "AND `AuthorEmail`!='". y7928($dd1cc6) ."' ". $e70a17 )) { $result=z0d6b(); foreach($result as $u39c63){ if (!in_array($u39c63['AuthorEmail'],$haf67c)) { $x2cb9d[] = $u39c63; } $haf67c[] = $u39c63['AuthorEmail']; } } return $x2cb9d; } function sb387($iaad65,$c3f917=NOTE_COMMENTABLE_NOW){ global$settings,$_config; $ybdb20=true; if (@$settings['comments']['fresh_only']) if (isset ($_config['comment_freshness_days'])) if ($iaad65['Stamp'] < time()-$_config['comment_freshness_days']*SECONDS_IN_A_DAY) $ybdb20=false; $hc770a=$iaad65['IsCommentable']; if ($c3f917==NOTE_COMMENTABLE_NOW_CONDITIONALLY){ $hc770a=true; } return ( $iaad65['IsPublished'] and jb44b($iaad65) and $ybdb20 and $hc770a ); } function e2_commentrec_with_parameters_($parameters=array ()) { $b39a37=$parameters['*note']; $ja5d49=i70a7($b39a37['ID']); $h4032b=@$ja5d49[$parameters['comment-number']-1]; if ($h4032b){ $h4032b['noterec']=$b39a37; return $h4032b; } } function c1a90($x98ea6=''){ global$settings,$zcbcce,$_config,$_fp_error; $_fp_error=false; $p0d5f1=n2e04(); $z21158=$l69b97=$ub0689=$z0c83f=$y1cb25=''; if(array_key_exists('note-id',$_POST)) $z21158=trim(@$_POST['note-id']); if(array_key_exists('comment-id',$_POST)) $l69b97=trim(@$_POST['comment-id']); if(array_key_exists('comment-number',$_POST)) $wb1bc2=trim(@$_POST['comment-number']); if(array_key_exists('name',$_POST)) $ub0689=trim(@$_POST['name']); if(array_key_exists($p0d5f1,$_POST)) $z0c83f=trim(@$_POST[$p0d5f1]); if(array_key_exists('text',$_POST)) $y1cb25=trim(@$_POST['text']); $se3a2d=z07e3('Comments'); if(stripos($se3a2d['Collation'],'utf8mb4')!==0){ $ub0689=nff7c($ub0689); $y1cb25=nff7c($y1cb25); } if ($l69b97=='new'){ $l396a4=e2_get_logged_gip_name(); if ($l396a4){ $ia64f4=e2_get_gip_session($l396a4); $ub0689=trim($ia64f4['AuthorName']); $z0c83f=''; $kdec42=$ia64f4['GIPAuthorID']; } } else { if(array_key_exists('gip',$_POST))$l396a4=trim(@$_POST['gip']); } $y07d3d=( (array_key_exists('already-subscribed',$_POST) and $_POST['already-subscribed']) or (array_key_exists('subscribe',$_POST) and $_POST['subscribe']) ); $b20612=time(); $z9d090['text']=$y1cb25; if ($l69b97=='new' and !$l396a4){ rc64a('commenter_name',$ub0689); rc64a('commenter_email',$z0c83f); } $s848b5=($l69b97=='new' and ( peb9a() or e2_cookie_data_is_spam_suspicios_for_note_id_($z21158) )); $dc2b1a=1; $result=false; if (!is_numeric($z21158)) { $_fp_error=FP_NO_ID_OR_NEW; } elseif (!is_numeric($l69b97) and !($l69b97=='new')) { $_fp_error=FP_NO_ID_OR_NEW; } else { if ( $y1cb25=='' or ( !$l396a4 and ($ub0689=='' or $z0c83f=='') ) ) { $_fp_error=FP_EMPTY_FIELD; } if ($l69b97=='new'){ $o795f1=@unserialize(file_get_contents(USER_FOLDER. '/last-comment.psa')); if(md5($ub0689.$z0c83f.$y1cb25)==$o795f1['md5']) { $_fp_error=FP_COMMENT_DOUBLE_POST; } if ( isset ($_config['max_comment_length']) and strlen(@$_POST['text']) > ($_config['max_comment_length']) ){ $_fp_error=FP_COMMENT_TOO_LONG; } $b39a37=h4627($z21158); if ($l69b97=='new' and !sb387($b39a37)) { $_fp_error=FP_NOT_COMMENTABLE; } if ($s848b5){ $_fp_error=FP_COMMENT_SPAM_SUSPECT; } } } if (!$_fp_error){ e2_drop_caches_for_note_($z21158); if ($l69b97=='new'){ $h4032b=array ( 'NoteID' => (int)$z21158, 'AuthorName' => $ub0689, 'AuthorEmail' => $z0c83f, 'Text' => $y1cb25, 'Reply' => '', 'IsVisible' => 1, 'IsAnswerAware' => 1, 'IsSubscriber' => (int)$y07d3d, 'IsSpamSuspect' => (int)$s848b5, 'IsNew' => (int)$dc2b1a, 'Stamp' => (int)time(), 'LastModified' => (int)time(), 'IP' => y7928($_SERVER['REMOTE_ADDR']), 'IsGIPUsed' => intval(!empty ($l396a4) && !empty ($kdec42)), 'GIP' => !empty ($l396a4)?y7928($l396a4):'', 'GIPAuthorID' => !empty ($kdec42)?y7928($kdec42):'', ); if (($h4032b=f9943('Comments',$h4032b)) !== false){ $l69b97=$h4032b['ID']; $o795f1=array ( 'id' => $l69b97, 'md5' => md5($ub0689.$z0c83f.$y1cb25), ); @x6e52(USER_FOLDER. 'last-comment.psa',serialize($o795f1)); $result=(int)$l69b97; $b303ee=md5($h4032b['ID'].$h4032b['Stamp'].'x'); rc64a('commenter_ph',$b303ee); $iaad65=h4627($z21158); $td58c0=v83c8('e2m_note', array ('*note' => $iaad65)); $mc6827['comment-time'] = array ($b20612,e5c05()); $mc6827['commenter']=$ub0689; $mc6827['commenter-email']=$z0c83f; $mc6827['comment-text']=$y1cb25; $mc6827['note-title']=$iaad65['Title']; $mc6827['note-href']=$td58c0; $mc6827['comment-href']=$td58c0; $mc6827['comments-disable-href']=v83c8('e2m_note_flag', array ( '*note' => $iaad65, 'flag' => 'IsCommentable', 'value' => 0 )); $mc6827['reply-href']=v83c8( 'e2m_comment_reply', array ( '*note' => $iaad65, 'comment-number' => $wb1bc2 ) ); if (isset ($settings['user']['email']) and @$settings['notifications']['new_comments']) { $hde7a3=b3e5c( 'comment-new-to-author',$mc6827 ); $cb904c=e2l_get_string( 'em--comment-new-to-author-subject', $mc6827 ); $v77613=$settings['user']['email']; $d1a49b = 'From: '. yaed2() ."\r\n". 'Reply-to: '. $ub0689 .' <'. $z0c83f .">"; ia41b($v77613,$cb904c,$hde7a3,$d1a49b); } if (!$s848b5){ unset ($mc6827['commenter-email']); $d1a49b='From: '. yaed2(); foreach (u4975($iaad65,$z0c83f) as $u39c63){ $iba570=$u39c63['AuthorEmail']; $e6fd85=md5($u39c63['ID'].$u39c63['Stamp'].'x'); $mc6827['unsubscribe-href']=v83c8('e2m_unsubscribe', array ( '*note' => $iaad65, 'unsubscribe-email' => $iba570, 'unsubscribe-key' => $e6fd85 ) ); $v77613=$iba570; $hde7a3=b3e5c('comment-new-to-public',$mc6827); $cb904c=e2l_get_string( 'em--comment-new-to-public-subject', $mc6827 ); ia41b($v77613,$cb904c,$hde7a3,$d1a49b); } } } else { $_fp_error=FP_INSERT_ERROR; } } else { $lfd6f3=array ( 'ID' => $l69b97, 'Text' => $y1cb25, 'IsSubscriber' => ((int)$y07d3d), 'LastModified' => time(), ); if (!empty ($ub0689))$lfd6f3['AuthorName']=$ub0689; if (!empty ($z0c83f))$lfd6f3['AuthorEmail']=$z0c83f; if (paa79('Comments',$lfd6f3)) { $result=(int)$l69b97; } else { $_fp_error=FP_UPDATE_ERROR; }; } } if ($x98ea6=='ajaxresult') return $q1fa03; else return array ((int)$z21158,$result,$z9d090); } function e2m_most_commented(){ global$settings,$_strings,$_config; $la0acf=@$_GET['period']; if ($la0acf=='')$la0acf=$_config['hot_period']; $g632a2=time()-h35c3($la0acf); return zd864(array ( 'query' => "SELECT `IsVisible`, `Stamp`, `NoteID` ID, count(*) quantity ". "FROM `". $_config['db_table_prefix']."Comments` c ". "WHERE (`Stamp` > ". $g632a2.") ". "AND c.`IsVisible` = 1 ". "GROUP BY ID ". "ORDER BY quantity ". "DESC ". "LIMIT ".$settings['appearance']['notes_per_page'], 'query-returns-only-ids' => 1, 'limit' => $settings['appearance']['notes_per_page'], 'title' => e2l_get_string('pt--most-commented', array ('period' => $la0acf)), 'heading' => e2l_get_string('pt--most-commented', array ('period' => $la0acf)), 'nothing' => $_strings['gs--no-such-notes'], )); } function e2m_favourites($parameters=array ()) { global$_config,$_strings; return zd864(array ( 'query' => "SELECT * FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `IsPublished`=1 AND `IsFavourite`=1 ". a6f32(ee852()). "ORDER BY `Stamp` DESC", 'page' => $parameters['page'], 'candy' => 'e2m_favourites', 'parameters' => $parameters, 'title' => $_strings['pt--favourites'], 'heading' => $_strings['pt--favourites'], 'nothing' => $_strings['gs--no-favourites'], )); } function h35c3($la0acf){ if ('year'==$la0acf) return SECONDS_IN_A_YEAR; elseif ('month'==$la0acf) return SECONDS_IN_A_MONTH; elseif ('week'==$la0acf) return SECONDS_IN_A_DAY*7; elseif ('day'==$la0acf) return SECONDS_IN_A_DAY; else return PHP_INT_MAX; } function d8696($p8d777){ global$_current_url; if(__LOG)__log('Arbitrary list ('. $p8d777['_log'] .') {'); $be919a=w7f78(); $hf4ac8=null; if ($p8d777['cache'] and is_file($p8d777['cache-filename'])) { $hf4ac8=@unserialize(file_get_contents($p8d777['cache-filename'])); } $yf957e=true; if ($p8d777['cache-filename-expires']) { if ($p8d777['cache'] and is_file($p8d777['cache-filename-expires'])) { $i07cc6=time(); $o09bcb=(int) @file_get_contents($p8d777['cache-filename-expires']); if(__LOG)__log('List expires '. date('r',$o09bcb) .', now '. date('r',$i07cc6)); $yf957e=($i07cc6 < $o09bcb); } } $hdbb0c=array(); if ($p8d777['cache'] and is_array($hf4ac8) and $yf957e){ if(__LOG)__log('Retrieve cached ctree'); $hdbb0c=$hf4ac8; } else { if(__LOG)__log('Assemle cacheable ctree...'); $b4358b=array(); if (s0738($p8d777['query'])) { $result=z0d6b(); foreach($result as $z8ce4b => $b39a37){ $b39a37=h4627($b39a37['ID']); if (jb44b($b39a37) and $b39a37['IsPublished']) { $iaad65['_']['_id']=$b39a37['ID']; $iaad65['_']['_ord']=$z8ce4b; $iaad65['_']['_ord_max']=count($result)-1; $iaad65['href']=v83c8('e2m_note', array ('*note' => $b39a37)); $iaad65['time'] = array ($b39a37['Stamp'],m0923($b39a37)); $iaad65['title']=i6f10(htmlspecialchars($b39a37['Title'],ENT_NOQUOTES,HSC_ENC)); $hdbb0c[] = $iaad65; } } $hf4ac8=$hdbb0c; if ($p8d777['cache']) { @x6e52($p8d777['cache-filename'],serialize($hf4ac8)); if ($p8d777['cache-filename-expires']) { @x6e52($p8d777['cache-filename-expires'],time()+$p8d777['expires-after']); } } } } foreach ($hdbb0c as $z8ce4b => $q9e366){ $hdbb0c[$z8ce4b]['current?'] = ($hdbb0c[$z8ce4b]['href']==$_current_url); } if(__LOG)__log('} // Arbitrary list in '. round(w7f78()-$be919a,3)); return $hdbb0c; } function t0256(){ global$_config; $g632a2=time()-h35c3($_config['popular_period']); return d8696(array ( '_log' => 'most_read', 'cache' => CACHE_POPULAR, 'cache-filename' => CACHE_FILENAME_POPULAR, 'cache-filename-expires' => CACHE_FILENAME_POPULAR_EXPIRES, 'expires-after' => SECONDS_IN_A_DAY, 'query' => ( "SELECT n.`ID`, n.`Title`, n.`IsFavourite`, a.`EntityID`, SUM(a.`ReadCount`) ReadCount ". "FROM `". $_config['db_table_prefix']."Actions` a, ". "`". $_config['db_table_prefix']."Notes` n  ". "WHERE a.`Stamp` > ". $g632a2 ." ". a6f32(). "AND a.`EntityID` = n.`ID` ". "GROUP BY a.`EntityID` ". "ORDER BY `IsFavourite` DESC, ReadCount DESC ". "LIMIT 10" ), )); } function e2m_password_reset(){ global$_strings,$_superconfig,$settings; if (!is_file(USER_FOLDER. 'password-reset.psa')) { $y3c6e0=d4c49(rand()); $n572d4=v83c8('e2m_password', array ('recovery-key' => $y3c6e0)); @x6e52(USER_FOLDER. 'password-reset.psa',$n572d4); } $x2cb9d['title']=$_strings['pt--password-reset']; $x2cb9d['heading']=$_strings['pt--password-reset']; $k5bef8=(bool) ($v77613=$settings['user']['email']); $x2cb9d['form']='form-password-reset-email'; $x2cb9d['form-password-reset-email'] = array ( 'form-action' => v83c8('e2s_password_reset_email'), 'show-controls?' => $k5bef8, 'submit-text' => $_strings['fb--send-link-by-email'], ); if (!@$_superconfig['user_has_no_access_to_files']) { $x2cb9d['form-password-reset-email']['reset-info']=$_strings['gs--password-reset-link-saved']; } elseif (!$k5bef8){ p8a40($_strings['er--cannot-reset-password']); } return $x2cb9d; } function e2s_password_reset_email(){ global$_strings,$settings; if($_SERVER['REQUEST_METHOD']!='POST') return e2_go_to(); if(array_key_exists('email',$_POST))$z0c83f=trim($_POST['email']); if (!$z0c83f){ p8a40($_strings['er--cannot-send-link-email-empty']); e2_go_to(v83c8('e2m_password_reset')); die; } $r22207=@file_get_contents(USER_FOLDER. 'password-reset.psa'); if(strlen($r22207)==0){ p8a40($_strings['er--error-occurred']); e2_go_to(v83c8('e2m_password_reset')); die; } if ($v77613=$settings['user']['email']) { if ($z0c83f==$v77613){ $hde7a3=b3e5c( 'password-reset', array ('reset-href' => $r22207) ); $cb904c=$_strings['em--password-reset-subject']; $d1a49b='From: '. yaed2(); ia41b($v77613,$cb904c,$hde7a3,$d1a49b); } p8a40($_strings['gs--password-reset-link-sent-maybe'],E2E_MESSAGE); e2_go_to(v83c8('e2m_password_reset')); die; } die; } function e2m_password($parameters){ global$settings,$_strings; $l2d832=false; $y3c6e0=''; if(array_key_exists('recovery-key',$parameters)) { $y3c6e0=$parameters['recovery-key']; $n572d4=v83c8('e2m_password', array ('recovery-key' => $y3c6e0)); $r22207=@file_get_contents(USER_FOLDER. 'password-reset.psa'); if(strlen($r22207) > 0){ $l2d832=($n572d4==$r22207); } } if (ee852() or $l2d832){ $x2cb9d['title']=$_strings['pt--password']; $x2cb9d['heading']=$_strings['pt--password-for-blog']; if ($l2d832){ $x2cb9d['title']=$_strings['pt--password-reset']; $x2cb9d['heading']=$_strings['pt--password-reset']; } $x2cb9d['form']='form-password'; $x2cb9d['form-password'] = array ( 'form-action' => v83c8('e2s_password_save'), '.recovery-key' => $y3c6e0, 'recovering?' => $l2d832, 'submit-text' => $_strings['fb--change'], ); return $x2cb9d; } else { e2_go_to(); } } function e2m_sessions(){ global$settings,$_strings; $v2d6d8=a7785(); $x2cb9d['title']=$_strings['pt--sessions']; $x2cb9d['heading']=$_strings['pt--sessions']; $p161bc=array(); $y3c6e0=$_COOKIE[p8c3b('key')]; foreach ($v2d6d8['sessions'] as $z8ce4b => $q9e366){ $p161bc[] = array ( 'current?' => d4c49($y3c6e0)===$q9e366['key_hash'], 'opened' => array ((int)$q9e366['stamp'],n3211()), 'ip-address' => $q9e366['remote_ip'], 'source' => ($q9e366['remote_ip']=='127.0.0.1')? $_strings['gs--locally']:$q9e366['remote_ip'], 'title' => fcc31($q9e366['ua']), 'user-agent' => $q9e366['ua']? $q9e366['ua']:$_strings['gs--unknown'], ); } $p161bc=array_reverse($p161bc); $x2cb9d['sessions']['each']=$p161bc; if(count($p161bc) > 1){ $x2cb9d['form']='form-sessions'; $x2cb9d['form-sessions'] = array ( 'form-action' => v83c8('e2s_drop_other_sessions'), 'submit-text' => $_strings['fb--end-all-sessions-but-this'], ); } return $x2cb9d; } function e2m_sign_in(){ if (ee852()) { e2_go_to(v83c8('e2m_frontpage', array ('page' => 1))); } else { return array (); } } function e2m_sign_out(){ global$_strings; $v2d6d8=a7785(); $p48bb9=-1; if(array_key_exists('sessions',$v2d6d8) and is_array($v2d6d8['sessions'])) { foreach ($v2d6d8['sessions'] as $z8ce4b => $q9e366){ $y3c6e0=$_COOKIE[p8c3b('key')]; if (d4c49($y3c6e0)===$q9e366['key_hash']) { $p48bb9=$z8ce4b; break; } } } if ($p48bb9 > -1) unset ($v2d6d8['sessions'][$p48bb9]); if (!f1d21($v2d6d8)) { p8a40($_strings['er--cannot-write-auth-data'],E2E_PERMISSIONS_ERROR); } rc64a('key',''); e2_go_to(); die; } function e2s_password_save(){ global$settings,$_strings; $l2d832=false; $l0512f=trim($_POST['old-password']); if ($y3c6e0=trim($_POST['recovery-key'])) { $n572d4=v83c8('e2m_password', array ('recovery-key' => $y3c6e0)); $r22207=@file_get_contents(USER_FOLDER. 'password-reset.psa'); if(strlen($r22207) > 0){ $l2d832=($n572d4==$r22207); } } if (ga8cf($l0512f) or $l2d832){ $d88162=trim($_POST['new-password']); if ($d88162!=''){ if (@x6e52(USER_FOLDER. '/password-hash.psa',serialize(d4c49($d88162)))) { @unlink(USER_FOLDER. 'password-reset.psa'); p8a40($_strings['gs--password-changed'],E2E_MESSAGE); e2_go_to(); } else { p8a40($_strings['er--could-not-change-password'],E2E_PERMISSIONS_ERROR); e2_go_to(v83c8('e2m_password', array ('recovery-key' => ''))); } } else { p8a40($_strings['er--no-password-entered'],E2E_USER_ERROR); e2_go_to(v83c8('e2m_password', array ('recovery-key' => ''))); } } else { p8a40($_strings['er--wrong-password'],E2E_USER_ERROR); e2_go_to(v83c8('e2m_password', array ('recovery-key' => ''))); } die; } function e2s_sign_in_necessary(){ e2_go_to(v83c8('e2m_sign_in')); die; } function e2s_sign_in(){ global$_strings; $v2d6d8=a7785(); if($_SERVER['REQUEST_METHOD']=='POST'){ $n5f4dc=@$_POST['password']; $m6bc8e=@$_POST['is_public_pc']; } else { $n5f4dc=@$_GET['password']; $m6bc8e=false; } if (ga8cf($n5f4dc)) { @unlink(USER_FOLDER. 'password-reset.psa'); $q21d6f=array ( 'stamp' => time(), 'remote_ip' => $_SERVER['REMOTE_ADDR'], 'key_hash' => ne8ed($m6bc8e), 'ua' => $_SERVER['HTTP_USER_AGENT'], ); $v2d6d8['sessions'][] = $q21d6f; } elseif(strlen(trim($n5f4dc)) > 0){ ya711(); p8a40($_strings['er--wrong-password'],E2E_USER_ERROR); } if (!f1d21($v2d6d8)) { p8a40($_strings['er--cannot-write-auth-data'],E2E_PERMISSIONS_ERROR); e2_go_to(); die; } s4930(); die; } function e2s_drop_other_sessions(){ global$_strings; $v2d6d8=a7785(); foreach ($v2d6d8['sessions'] as $z8ce4b => $q9e366){ $y3c6e0=$_COOKIE[p8c3b('key')]; if (d4c49($y3c6e0)===$q9e366['key_hash']) { $q21d6f=$q9e366; break; } } $v2d6d8['sessions'] = array ($q21d6f); if (!f1d21($v2d6d8)) { p8a40($_strings['er--cannot-write-auth-data'],E2E_PERMISSIONS_ERROR); } s4930(); die; } function ga8cf($n5f4dc){ $w8e9a8=@unserialize(file_get_contents(USER_FOLDER. '/password-hash.psa')); return (d4c49($n5f4dc)===$w8e9a8 and trim($n5f4dc)!=''); } function ne8ed($u2a2a4=false){ global$settings; $y3c6e0=l2a24(); $z3f363=d4c49($y3c6e0); rc64a('key',$y3c6e0, !$u2a2a4); return $z3f363; } function ee852(){ global $w1c0b7,$settings,$_auth_sessions; if (isset ($w1c0b7)) return $w1c0b7; $w1c0b7=false; if (isset ($_COOKIE[p8c3b('key')])) { $y3c6e0=$_COOKIE[p8c3b('key')]; $v2d6d8=a7785(); $m0f83b=array(); if(array_key_exists('sessions',$v2d6d8) and is_array($v2d6d8['sessions'])) { foreach ($v2d6d8['sessions'] as $q21d6f){ $m0f83b[] = $q21d6f['key_hash']; } $_auth_sessions['count']=count($v2d6d8['sessions']); } if(1){ $w1c0b7=(bool)in_array(d4c49($y3c6e0),$m0f83b,true); } if (!$w1c0b7){ rc64a('key',''); } } return $w1c0b7; } function d4c49($x25d90){ if(function_exists('sha1')) { return sha1($x25d90); } else { return substr(md5($x25d90).md5(' '.$x25d90),0,40); } } function a7785(){ if(is_file(USER_FOLDER.'auth.psa')) { $v2d6d8=unserialize(@file_get_contents(USER_FOLDER.'auth.psa')); if ($v2d6d8) return $v2d6d8; } return array (); } function f1d21($v2d6d8){ return x6e52(USER_FOLDER.'auth.psa',serialize($v2d6d8)); } function rc3fb(){ if ($y3c6e0=$_COOKIE[p8c3b('key')]) { return p8c3b('key') .'='. $y3c6e0 .""; } } function kff2e(){ if ($y3c6e0=$_COOKIE[p8c3b('key')]) { return 'Cookie: '. p8c3b('key') .'='. $y3c6e0 ."\r\n"; } return "\r\n"; } function fcc31($a5269f){ global$_strings; if(strstr($a5269f,'iPhone')) return$_strings['gs--ua-iphone']; if(strstr($a5269f,'iPad')) return$_strings['gs--ua-ipad']; if(strstr($a5269f,'Opera'))$x2cb9d=$_strings['gs--ua-opera']; if(strstr($a5269f,'Firefox'))$x2cb9d=$_strings['gs--ua-firefox']; if(strstr($a5269f,'Chrome'))$x2cb9d=$_strings['gs--ua-chrome']; if(strstr($a5269f,'Safari') and !strstr($a5269f,'Chrome'))$x2cb9d=$_strings['gs--ua-safari']; if (!$x2cb9d)$x2cb9d=$_strings['gs--ua-unknown']; if(strstr($a5269f,'Macintosh')) { if ($x2cb9d)$x2cb9d.=' '. $_strings['gs--ua-for-mac']; } return $x2cb9d; } function e2j_check_password(){ $w8e9a8=@unserialize(file_get_contents(USER_FOLDER. '/password-hash.psa')); $n5f4dc=''; if(array_key_exists('password',$_POST))$n5f4dc=$_POST['password']; ya711(); if (d4c49($n5f4dc)===$w8e9a8 and trim($n5f4dc)!=''){ die ('password-correct'); } die ('password-wrong'); } function l2a24(){ $bb04ec=''; $zb8d1b='0123456789abcdef'; for ($v865c0=0; $v865c0 < 40; $v865c0++)$bb04ec.=$zb8d1b[mt_rand(0,15)]; $bb04ec.=time(); $bb04ec=d4c49($bb04ec); return $bb04ec; } function ya711(){ if(is_file(USER_FOLDER. 'password-wait.psa')) { $faf788=unserialize( file_get_contents(USER_FOLDER. '/password-wait.psa') ); if ($faf788['delay'] < 5){ $faf788['delay'] ++; } if(time()-$faf788['time'] > SECONDS_IN_A_MINUTE){ $faf788['delay']=0; } $faf788['time']=time(); } else { $faf788=array ( 'time' => time(), 'delay' => 5, ); } x6e52(USER_FOLDER.'password-wait.psa',serialize($faf788)); sleep($faf788['delay']); } function y7874(){ static $q34e51; if(empty($q34e51))$q34e51=md5('seсret'); return $q34e51; } function j1305($lb45cf){ $y3c6e0=y7874(); $w16ec1=strlen($y3c6e0); $p2db95=strlen($lb45cf); $x2cb9d=''; for ($v865c0=0; $v865c0 < $p2db95+rand(16,64); ++ $v865c0){ if ($v865c0 > $p2db95){ $m462e1=rand(0,127); } elseif ($v865c0==$p2db95){ $m462e1=0; } else { $m462e1=ord($lb45cf[$v865c0]); } $w18e1b=chr(($m462e1+ord($y3c6e0[$v865c0%$w16ec1])) % 256); $x2cb9d.=$w18e1b; } $x2cb9d=base64_encode($x2cb9d); return $x2cb9d; } function kee85($lb45cf){ $y3c6e0=y7874(); $w16ec1=strlen($y3c6e0); $lb45cf=base64_decode($lb45cf); $p2db95=strlen($lb45cf); $x2cb9d=''; for ($v865c0=0; $v865c0 < $p2db95; ++ $v865c0){ $vd9468=(ord($lb45cf[$v865c0]) + 256-ord($y3c6e0[$v865c0%$w16ec1])) % 256; if ($vd9468===0) break; $x2cb9d.=chr($vd9468); } return $x2cb9d; } $_candies_installer=array ( 'e2s_build', 'e2m_info', 'e2m_install', 'e2j_check_db_config', 'e2j_list_databases', 'e2s_instantiate', 'e2s_install', 'e2s_update_perform', ); $_candies_public=array ( 'e2m_info', 'e2m_frontpage', 'e2m_rss', 'e2m_json', 'e2m_note', 'e2m_note_json', 'e2m_note_read', 'e2m_draft_preview', 'e2m_tags', 'e2m_tag', 'e2m_tag_rss', 'e2m_tag_json', 'e2m_favourites', 'e2m_most_commented', 'e2m_found', 'e2m_comments', 'e2m_everything', 'e2m_sitemap_xml', 'e2m_year', 'e2m_month', 'e2m_day', 'e2m_unsubscribe', 'e2m_theme_preview', 'e2m_password_reset', 'e2s_password_reset_email', 'e2m_password', 'e2s_password_save', 'e2s_sign_in', 'e2m_sign_out', 'e2m_gip_sign_in', 'e2m_gip_sign_in_callback', 'e2m_gip_sign_out', 'e2s_comment_process', 'e2s_search', 'e2s_bsi_step', 'e2j_check_password', 'e2s_notify', ); $_candies_to_disallow_in_read_only=array ( 'e2m_write', 'e2m_note_edit', 'e2s_note_process', 'e2s_note_publish', 'e2s_note_delete', 'e2m_note_flag_favourite', 'e2m_note_flag', 'e2m_comment_edit', 'e2m_comment_delete', 'e2m_comment_reply', 'e2m_comment_reply_delete', 'e2m_comment_flag', 'e2m_comment_flag_ajax', 'e2m_unsubscribe', 'e2s_comment_process', 'e2m_settings', 'e2m_timezone', ); $_candies_public=array_merge($_candies_public,$_candies_installer); $_candies_indexable=array ( 'e2m_note', ); $_candies_indexable_conditionally=array ( 'e2m_frontpage', 'e2m_tag', 'e2m_favourites', 'e2m_most_commented', 'e2m_found', 'e2m_tags', 'e2m_everything', ); $_candies_ajax=array ( 'e2j_check_db_config', 'e2j_list_databases', 'e2j_check_password', 'e2j_userpic_upload', 'e2j_file_upload', 'e2j_file_remove', 'e2j_note_livesave', 'e2m_note_flag_favourite', 'e2m_comment_flag_ajax', 'e2m_tag_flag_ajax', ); function e2_modes($parameters){ global$content,$_strings; if (!is_array($parameters))$parameters=array(); if(array_key_exists('~',$parameters)) { $x71860=$parameters['~']; } if(e2_is_installed()) { if(__LOG)__log('Popular and tags menu {'); if (!$content['popular']) { $content['popular'] = array ( 'title' => $_strings['nm--most-read'], ); $content['popular']['each']=t0256(); } if(count($content['popular']['each']) < 10) unset($content['popular']['each']); if (!$content['tags']) { $content['tags']['each']=e5d57(); $content['tags']['menu-each']=haf16($parameters); } if(__LOG)__log('} // Popular and tags menu'); } } function q6f51(){ global$settings,$_strings; if ( array_key_exists('site_title',$settings) and trim($settings['site_title']) != '' ){ return trim($settings['site_title']); } else { return$_strings['e2--default-blog-title']; } } function u2640(){ global$settings,$_strings; if ( array_key_exists('author',$settings) and trim($settings['author']) != '' ){ return trim($settings['author']); } else { return$_strings['e2--default-blog-author']; } } function u2461(){ global$full_blog_url; if(is_file(USER_FOLDER .'userpic@2x.png')) { return$full_blog_url .'/'. USER_FOLDER .'userpic@2x.png'; } elseif(is_file(USER_FOLDER .'userpic@2x.jpg')) { return$full_blog_url .'/'. USER_FOLDER .'userpic@2x.jpg'; } else { return false; } } function e2m_info(){ global$settings,$_config,$s57de2,$wa57c1,$_template; $gf1f71=array ( 'E2_VERSION' => E2_VERSION, 'E2_RELEASE' => E2_RELEASE, 'E2_UA_STRING' => E2_UA_STRING, '---', 'PHP_VERSION' => PHP_VERSION, '---', 'installed' => (bool)e2_is_installed(), 'server_name' => $s57de2, 'folder_on_server' => $wa57c1, '---', 'request_logging' => $_config['request_logging'], 'default formatter' => $_config['default_formatter'], '---', 'theme' => $settings['template'], '---', 'Olba name' => $_template['name'], 'Olba max_image_width' => $_template['max_image_width'], 'Olba stack' => $_template['stack'], '---', 'Neasden' => substr(md5(file_get_contents('system/neasden/neasden.php')), 0,4), '---', ); echo '<pre>'; foreach ($gf1f71 as $z8ce4b => $q9e366){ if ($q9e366=='---'){ echo "\n"; continue; } echo str_pad($z8ce4b,24); echo '\''; print_r($q9e366); echo '\''; echo "\n"; } echo '</pre>'; die; } function e2s_notify(){ global$_config; if($_config['holborn']) { $z4de32=@$_GET['src']; if ($z4de32==''){ if(__LOG)__log('Holborn: No src URL'); die; } $o466de=file_get_contents($z4de32); $o466de=w09a6($o466de); $xe13b0=json_decode($o466de,true); if (!$xe13b0){ if(__LOG)__log('Holborn: No meaningful info from '. $z4de32 .' ('. json_last_error() .')'); if ($w13bc3=qdd69($z4de32)) { if(__LOG)__log('Holborn: Delete note with ID '. $w13bc3['ID']); ue268($w13bc3['ID']); } die; } q927d($xe13b0,$z4de32); } die; } function e2m_sources($parameters){ global$_config; $e8bef1=$_GET['ord']; if (!$e8bef1)$e8bef1='ID'; $e8bef1="`". y7928($e8bef1) ."`"; s0738( "SELECT *, REPLACE(REPLACE(REPLACE(`URL`, 'http://', ''), 'https://', ''), 'www.', '') AS _URLX ". "FROM `". $_config['db_table_prefix']."Sources` " . "ORDER BY ". $e8bef1 ); $result=z0d6b(); foreach($result as $f447b7){ $pc615c=$f447b7['ID']; if ($f447b7['ID']!=$f447b7['TrueID'])$pc615c.='<br />'. $f447b7['TrueID']; $r36cd3=array ( 'id' => $pc615c, 'userpic-href' => $f447b7['PictureURL'], 'href' => $f447b7['URL'], 'href-display' => str_replace('/','/<wbr>',$f447b7['URL']), 'href-filtered' => str_replace('/','/<wbr>',$f447b7['_URLX']), 'title' => $f447b7['Title'], 'author' => $f447b7['AuthorName'], 'true?' => $f447b7['ID']==$f447b7['TrueID'], 'whitelisted?' => $f447b7['IsWhiteListed'], 'trusted?' => $f447b7['IsTrusted'], ); if (!$f447b7['IsTrusted']) { $r36cd3['trust-url']=v83c8( 'e2m_source_trust', array ('source' => $f447b7['ID']) ); } if ($f447b7['IsTrusted']) { $r36cd3['premoderate-url']=v83c8( 'e2m_source_premoderate', array ('source' => $f447b7['ID']) ); } $r36cd3['ban-url']=v83c8( 'e2m_source_ban', array ('source' => $f447b7['ID']) ); $r36cd3['forget-url']=v83c8( 'e2m_source_forget', array ('source' => $f447b7['ID']) ); $rf2ab5[] = $r36cd3; } $x2cb9d=array ( 'title' => 'Sources', 'heading' => 'Sources', ); if(count($rf2ab5)) { $x2cb9d['sources']=$rf2ab5; } else { $x2cb9d['nothing']='No sources'; } return $x2cb9d; } function e2m_source_trust($parameters){ global$_config; $y0afd9=$parameters['source']; s0738( "UPDATE  ". $_config['db_table_prefix']."Sources ". "SET `IsWhitelisted`=1, `IsTrusted`=1 ". "WHERE `ID`=". $y0afd9 ); s0738( "UPDATE  ". $_config['db_table_prefix']."Notes ". "SET `IsPublished`=1 ". "WHERE `SourceID`=". $y0afd9 ); q198f(); z7996(); @unlink(CACHE_FILENAME_DRAFTS); @unlink(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); e2_go_to(''); die; } function e2m_source_premoderate($parameters){ global$_config; $y0afd9=$parameters['source']; s0738( "UPDATE  ". $_config['db_table_prefix']."Sources ". "SET `IsTrusted`=0 ". "WHERE `ID`=". $y0afd9 ); z7996(); e2_go_to(''); die; } function e2m_source_ban($parameters){ global$_config; $y0afd9=$parameters['source']; s0738( "UPDATE  ". $_config['db_table_prefix']."Sources ". "SET `IsWhiteListed`=0, `IsTrusted`=0 ". "WHERE `ID`=". $y0afd9 ); s0738( "DELETE FROM  ". $_config['db_table_prefix']."Notes ". "WHERE `SourceID`=". $y0afd9 ); z7996(); @unlink(CACHE_FILENAME_DRAFTS); @unlink(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); e2_go_to(''); die; } function e2m_source_forget($parameters){ global$_config; $y0afd9=$parameters['source']; s0738( "DELETE FROM  ". $_config['db_table_prefix']."Sources ". "WHERE `ID`=". $y0afd9 ); s0738( "DELETE FROM  ". $_config['db_table_prefix']."Notes ". "WHERE `SourceID`=". $y0afd9 ); z7996(); @unlink(CACHE_FILENAME_DRAFTS); @unlink(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); e2_go_to(''); die; } function q927d($xe13b0,$z4de32){ if(__LOG)__log('Holborn: Note info == '. print_r($xe13b0,true)); if (@$xe13b0['items']) { if(__LOG)__log('Holborn: JSON feed format'); $xa4a84=x10cd(array ( 'author' => $xe13b0['author']['name'], 'title' => $xe13b0['title'], 'href' => $xe13b0['author']['url'], 'userpic-href' => $xe13b0['author']['avatar'], )); if (!$xa4a84['IsWhiteListed']) return; if(preg_match('/\+(\d\d)\:(\d\d)/',$xe13b0['items'][0]['date_published'],$u9c28d)) { $w7a86c=$u9c28d[1]*SECONDS_IN_AN_HOUR+$u9c28d[2]*SECONDS_IN_A_MINUTE; } $p929cf=@$xe13b0['items'][0]['_e2_data'] or $p929cf=array(); $p929cf=json_encode($p929cf); $b39a37=array ( 'Title' => $xe13b0['items'][0]['title'], 'Text' => $xe13b0['items'][0]['content_html'], 'FormatterID' => 'raw', 'OriginalAlias' => '', 'Uploads' => '', 'Stamp' => strtotime($xe13b0['items'][0]['date_published']), 'Offset' => (int)$w7a86c, 'IsDST' => 0, 'LastModified' => strtotime($xe13b0['items'][0]['date_modified']), 'IsCommentable' => 0, 'IsPublished' => $xa4a84['IsTrusted'], 'IsExternal' => 1, 'SourceID' => $xa4a84['ID'], 'SourceNoteID' => $xe13b0['items'][0]['id'], 'SourceNoteURL' => $xe13b0['items'][0]['url'], 'SourceNoteJSONURL' => $z4de32, 'SourceNoteData' => $p929cf, ); $z21158=$xe13b0['items'][0]['id']; } else { if(__LOG)__log('Holborn: legacy custom format'); $q03396=@$xe13b0['blog']; $xa4a84=x10cd($q03396); if (!$xa4a84['IsWhiteListed']) return; $p929cf=@$xe13b0['note']['og-images'] or $p929cf=array(); $p929cf['og_images']=$p929cf; $p929cf=json_encode($p929cf); $b39a37=array ( 'Title' => $xe13b0['note']['title'], 'Text' => $xe13b0['note']['text'], 'FormatterID' => 'raw', 'OriginalAlias' => '', 'Uploads' => '', 'Stamp' => $xe13b0['note']['time'][0], 'Offset' => (int)$xe13b0['note']['time'][1]['offset'], 'IsDST' => (int)$xe13b0['note']['time'][1]['is_dst'], 'LastModified' => $xe13b0['note']['last-modified'][0], 'IsCommentable' => 0, 'IsPublished' => $xa4a84['IsTrusted'], 'IsExternal' => 1, 'SourceID' => $xa4a84['ID'], 'SourceNoteID' => $xe13b0['note']['id'], 'SourceNoteURL' => $xe13b0['note']['href'], 'SourceNoteJSONURL' => $z4de32, 'SourceNoteData' => $p929cf, ); $z21158=$xe13b0['note']['id']; } if ( $w13bc3=vf25e($xa4a84['ID'],$z21158) ) { $b39a37['ID']=$w13bc3['ID']; paa79('Notes',$b39a37); } else { $b39a37=f9943('Notes',$b39a37); } od2e1($b39a37); e2_drop_caches_for_note_($b39a37['ID']); @unlink(CACHE_FILENAME_DRAFTS); @unlink(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); } function qdd69($z4de32){ global$_config; $result=s0738( "SELECT `ID` FROM ". $_config['db_table_prefix']."Notes ". "WHERE `SourceNoteJSONURL`='". $z4de32 ."' ". "LIMIT 1" ); $result=z0d6b(); return$result[0]; } function vf25e($y0afd9,$obb971){ global$_config; $result=s0738( "SELECT `ID` FROM ". $_config['db_table_prefix']."Notes ". "WHERE `SourceID`= '". $y0afd9 ."' ". "AND `SourceNoteID`= '". $obb971 ."' ". "LIMIT 1" ); $result=z0d6b(); return$result[0]; } function w09a6($o466de){ for ($v865c0=0; $v865c0 <= 31; ++$v865c0){ $o466de=str_replace(chr($v865c0),'',$o466de); } $o466de=str_replace(chr(127),'',$o466de); if(0===strpos(bin2hex($o466de),'efbbbf')) { $o466de=substr($o466de,3); } return $o466de; } function x10cd($q03396){ global$_config; $z305c2=false; $result=s0738( "SELECT * FROM ". $_config['db_table_prefix']."Sources ". "WHERE `URL`= '". $q03396['href'] ."' ". "LIMIT 1" ); $result=z0d6b(); if(count($result)) { $z305c2=$result[0]; if ($z305c2['ID']!=$z305c2['TrueID']) { $result=s0738( "SELECT * FROM ". $_config['db_table_prefix']."Sources ". "WHERE `ID`= '". $z305c2['TrueID'] ."' ". "LIMIT 1" ); $result=z0d6b(); if(count($result)) { $z305c2=$result[0]; } } } $xa4a84=array ( 'Title' => $q03396['title'], 'AuthorName' => $q03396['author'], 'PictureURL' => $q03396['userpic-href'], ); if ($z305c2!==false){ if ( $z305c2['Title']!==$q03396['title'] or $z305c2['AuthorName']!==$q03396['author'] or $z305c2['PictureURL']!==$q03396['userpic-href'] ) { $xa4a84['ID']=$z305c2['ID']; paa79('Sources',$xa4a84); } return $z305c2; } else { $xa4a84['URL']=$q03396['href']; $xa4a84['IsWhiteListed']=1; $xa4a84['IsTrusted']=0; $xa4a84=f9943('Sources',$xa4a84); $xa4a84['TrueID']=$xa4a84['ID']; paa79('Sources',$xa4a84); return $xa4a84; } } function v1a48($b39a37,$x34d5a=false){ global$_config; $mc6827=array(); if (@$b39a37['IsExternal']) { if(array_key_exists('SourceID',$b39a37)) { if (s0738( "SELECT * FROM `". $_config['db_table_prefix']."Sources` ". "WHERE `ID` = '". $b39a37['SourceID'] ."'" )) { $bfa816=z0d6b(); } $mc6827['source']=$bfa816[0]['Title']; $mc6827['source-id']=$b39a37['SourceID']; $mc6827['source-true-id']=$bfa816[0]['TrueID']; $mc6827['source-whitelisted?']=$bfa816[0]['IsWhiteListed']; $mc6827['source-trusted?']=$bfa816[0]['IsTrusted']; if (!$bfa816[0]['IsTrusted']) { $mc6827['source-trust-url']=v83c8( 'e2m_source_trust', array ('source' => $b39a37['SourceID']) ); } if ($bfa816[0]['IsTrusted']) { $mc6827['source-premoderate-url']=v83c8( 'e2m_source_premoderate', array ('source' => $b39a37['SourceID']) ); } $mc6827['source-ban-url']=v83c8( 'e2m_source_ban', array ('source' => $b39a37['SourceID']) ); $mc6827['source-forget-url']=v83c8( 'e2m_source_forget', array ('source' => $b39a37['SourceID']) ); $mc6827['author']=$bfa816[0]['AuthorName']; $mc6827['author-href']=$bfa816[0]['URL']; $mc6827['userpic-href']=$bfa816[0]['PictureURL']; } if ($x34d5a){ if(array_key_exists('SourceNoteURL',$b39a37) and @$b39a37['SourceNoteURL']!=''){ $mc6827['href']=$b39a37['SourceNoteURL']; $mc6827['href-original']=$b39a37['SourceNoteURL']; } } } return $mc6827; } function e2m_frontpage($parameters=array ()) { global$settings,$_config,$_strings; $x71860=$parameters['page']; $vd7e5d=$settings['appearance']['notes_per_page']; $h06d2e=d3456(true,true); if (ee852())$h06d2e+=d3456(true,false); $kae0fe=ceil($h06d2e/$vd7e5d); $ed29bb=CACHE_FILENAME_FRONTPAGE; if (ee852())$ed29bb=CACHE_FILENAME_FRONTPAGE_AUTHOR; if ($x71860 < 1) return e2_error404_mode(); if(CACHE_FRONTPAGE and $x71860==1 and is_file($ed29bb)) { $b4358b=@unserialize(file_get_contents($ed29bb)); } if(CACHE_FRONTPAGE and $x71860==1 and is_array($b4358b)) { } else { if (($result=y7573($x71860)) === false){ p8a40($_strings['er--cannot-show-latest-notes'],E2E_DATABASE_ERROR); return array ( 'title' => htmlspecialchars(q6f51(),ENT_NOQUOTES,HSC_ENC), ); } $b4358b=array(); if(count($result) > 0){ foreach($result as $z8ce4b => $iaad65){ $iaad65['_']['_id']=$iaad65['ID']; $iaad65['_']['_title']=$iaad65['Title']; $iaad65['_']['_ord']=$z8ce4b; $iaad65['_']['_ord_max']=count($result)-1; $de244c=r6791($iaad65); $b4358b[] = $de244c; } } else { if ($x71860!=1) return e2_error404_mode(); } if(CACHE_FRONTPAGE and $x71860==1)x6e52($ed29bb,serialize($b4358b)); } $ub3b32['timeline?']=true; $ub3b32['count']=$kae0fe; $ub3b32['this'] = (int)$x71860; if ($kae0fe > 1){ if ($x71860 < $kae0fe)$ub3b32['earlier-href']=v83c8('e2m_frontpage', array ('page' => $x71860+1)); if ($x71860 > 1)$ub3b32['later-href']=v83c8('e2m_frontpage', array ('page' => $x71860-1)); $ub3b32['earlier-title']=$_strings['gs--earlier']; $ub3b32['later-title']=$_strings['gs--later']; } $ud5d3d=q6f51(); return array ( 'frontpage?' => (bool) ($x71860==1), 'title' => $ud5d3d, 'notes' => $b4358b, 'pages' => $ub3b32, ); } function y7573($x71860=1){ global$settings,$_config; $f19ee4=($x71860-1)*$settings['appearance']['notes_per_page']; $iaa9f7=$f19ee4 .', '. $settings['appearance']['notes_per_page']; if (s0738( "SELECT * FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `IsPublished`=1 ". a6f32(ee852()). "ORDER BY `Stamp` DESC ". "LIMIT ". $iaa9f7 )) { $result=z0d6b(); return$result; } else { return false; } } function e2m_json($parameters=array ()) { list ($nb9076,$b20612)=qab26(); $o466de=json_encode($nb9076,E2_JSON_STYLE); m8ec5($o466de,$b20612,'json'); } function e2m_rss($parameters=array ()) { list ($nb9076,$b20612)=qab26(); $g8bb85=e2feeds__rss_using_jsonfeed_array_($nb9076); m8ec5($g8bb85,$b20612,'rss'); } function e2m_tag_json($parameters=array ()) { if(array_key_exists('*tag',$parameters)) { $sb19ad=$parameters['*tag']; } else { return e2_error404_mode(); } list ($nb9076,$b20612)=be229($sb19ad); $o466de=json_encode($nb9076,E2_JSON_STYLE); m8ec5($o466de,$b20612,'json'); } function e2m_tag_rss($parameters=array ()) { global$settings,$_config,$_strings; if(array_key_exists('*tag',$parameters)) { $sb19ad=$parameters['*tag']; } else { return e2_error404_mode(); } list ($nb9076,$b20612)=be229($sb19ad); $g8bb85=e2feeds__rss_using_jsonfeed_array_($nb9076); m8ec5($g8bb85,$b20612,'rss'); } function e2m_note_json($parameters=array ()) { global$settings,$_current_url; $b39a37=$parameters['*note']; if ($b39a37==false){ return e2_error404_mode(); } if (!jb44b($b39a37,ee852())) { return e2_error404_mode(); } $b39a37['_']['_id']=$b39a37['ID']; $b20612=$b39a37['Stamp']; $v7da21=e2_jsonfeed_item_array_from_noterec_($b39a37); $d0bf08=array ($v7da21); $nb9076=e2_jsonfeed_array_stub_from_jsonfeed_item_arrays_($d0bf08); $nb9076['title']=$settings['site_title']; $nb9076['home_page_url']=v83c8('e2m_frontpage', array ('page' => 1)); $nb9076['feed_url']=$_current_url; m8ec5(json_encode($nb9076,E2_JSON_STYLE),$b20612,'json'); } function e2_jsonfeed_array_stub_from_jsonfeed_item_arrays_($d0bf08){ return array ( 'version' => 'https://jsonfeed.org/version/1', 'title' => null, 'home_page_url' => null, 'feed_url' => null, 'icon' => u2461(), 'author' => array ( 'name' => u2640(), 'url' => v83c8('e2m_frontpage', array ('page' => 1)), 'avatar' => u2461(), ), 'items' => $d0bf08, '_e2_version' => E2_VERSION, '_e2_ua_string' => E2_UA_STRING, ); } function e2_jsonfeed_item_array_from_noterec_($b39a37){ global$settings; $b39a37['_']['_id']=$b39a37['ID']; $n572d4=v83c8('e2m_note', array ('*note' => $b39a37)); $s803d0=( ba846('Y-m-d\TH:i:s',$b39a37['Stamp']) . hd536($b39a37['Stamp'],':') ); $oade16=( ba846('Y-m-d\TH:i:s',$b39a37['LastModified']) . hd536($b39a37['LastModified'],':') ); $x316ec=( ba846('D, d M Y H:i:s ',$b39a37['Stamp']) . hd536($b39a37['Stamp']) ); $e2bfe4=q154e($b39a37['FormatterID'], @$b39a37['Text'],'full-rss'); $jad965=hdbcc( 'note',$b39a37['_']['_id'], $e2bfe4['meta']['resources-detected'] ); $pe70c4=array ( 'id' => (string)$b39a37['ID'], 'url' => $n572d4, 'title' => i6f10(htmlspecialchars($b39a37['Title'],ENT_NOQUOTES)), 'content_html' => $e2bfe4['text-final'], 'date_published' => $s803d0, 'date_modified' => $oade16, ); if ($b39a37['IsExternal']) { $c60d40=v1a48($b39a37,true); $pe70c4['url']=$c60d40['href']; $pe70c4['author'] = array ( 'name' => $c60d40['author'], 'url' => $c60d40['author-href'], 'avatar' => $c60d40['userpic-href'], ); } if(count($jad965) > 0){ $pe70c4['image']=$jad965[0]; } $pe70c4['_date_published_rfc2822']=$x316ec; if ($b39a37['Stamp'] < $settings['v3223_rss_permalinks_before_stamp']) { $pe70c4['_rss_guid_is_permalink']='true'; $pe70c4['_rss_guid']=$pe70c4['url']; } else { $pe70c4['_rss_guid_is_permalink']='false'; $pe70c4['_rss_guid'] = (string)$b39a37['ID']; } $pe70c4['_e2_data'] = array ( 'is_favourite' => (bool)$b39a37['IsFavourite'], 'links_required' => $e2bfe4['meta']['links-required'], 'og_images' => $jad965, ); return $pe70c4; } function j3010($j7a402,$ud5d3d,$fe8fab){ global$_newsfeeds; $jfc0f6=''; if ($j7a402=='rss')$jfc0f6='application/rss+xml'; if ($j7a402=='json')$jfc0f6='application/json'; $i336a4=array ( 'type' => $jfc0f6, 'title' => htmlspecialchars($ud5d3d,ENT_NOQUOTES,HSC_ENC), 'href' => $fe8fab ); $_newsfeeds[] = $i336a4; } function med63(){ global$_config; if (s0738( "SELECT * FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `IsPublished`=1 ". a6f32(). "ORDER BY `Stamp` DESC ". "LIMIT ". $_config['rss_items'] )) { $result=z0d6b(); return$result; } } function qab26(){ global$settings,$_current_url; $b20612=0; $d0bf08=array(); $nb9076=array(); $ed29bb=CACHE_FILENAME_FRONTPAGE_FEED; if(CACHE_FRONTPAGE_FEED and is_file($ed29bb)) { if(__LOG)__log('Feed array (RSS, JSON): cached'); $nb9076=@unserialize(file_get_contents($ed29bb)); $b20612=filemtime($ed29bb); } else { if(__LOG)__log('Feed array (RSS, JSON): not cached, will need to build'); if (($uc2d18=med63()) !== false){ foreach ($uc2d18 as $b39a37){ $d0bf08[] = e2_jsonfeed_item_array_from_noterec_($b39a37); $b20612=max($b20612,$b39a37['Stamp']); } $nb9076=e2_jsonfeed_array_stub_from_jsonfeed_item_arrays_($d0bf08); $nb9076['title']=$settings['site_title']; $nb9076['home_page_url']=v83c8('e2m_frontpage', array ('page' => 1)); $nb9076['feed_url']=$_current_url; if(CACHE_FRONTPAGE_FEED)x6e52($ed29bb,serialize($nb9076)); } } return array ($nb9076,$b20612); } function be229($sb19ad){ global$settings,$_config,$_strings,$_current_url; $b20612=0; $d0bf08=array(); if ((s0738( "SELECT n.* ". "FROM `". $_config['db_table_prefix']."Notes` n ". "INNER JOIN `". $_config['db_table_prefix']."NotesKeywords` nk ". "ON nk.`NoteID` = n.`ID` ". "WHERE (nk.`KeywordID` = ". $sb19ad['ID'] .") ". "AND n.`IsPublished` = 1 ". a6f32(ee852()). "ORDER BY n.`Stamp` DESC ". "LIMIT ". $_config['rss_items'] )) !== false){ $uc2d18=z0d6b(); foreach ($uc2d18 as $b39a37){ $d0bf08[] = e2_jsonfeed_item_array_from_noterec_($b39a37); $b20612=max($b20612,$b39a37['Stamp']); } $nb9076=e2_jsonfeed_array_stub_from_jsonfeed_item_arrays_($d0bf08); $nb9076['title'] = ( $settings['site_title'] .', '. $_strings['gs--posts-tagged'] .': '. $sb19ad['Keyword'] ); $nb9076['home_page_url']=v83c8('e2m_tag', array ('*tag' => $sb19ad)); $nb9076['feed_url']=$_current_url; } return array ($nb9076,$b20612); } function e2feeds__rss_using_jsonfeed_array_($content){ $d92eac=DEFAULTS_FOLDER.'rss/rss.tmpl.php'; if(is_file($d92eac)) { ob_start(); include $d92eac; $g8bb85=ob_get_contents(); ob_end_clean(); } return $g8bb85; } function o99a9($g8bb85){ $g8bb85=str_replace("\x0",'',$g8bb85); for ($v865c0=0; $v865c0 < strlen($g8bb85); ++$v865c0){ if(ord($g8bb85[$v865c0]) < 32 and !in_array(ord($g8bb85[$v865c0]), array (10,13))) { $g8bb85[$v865c0]=''; } } return $g8bb85; } function m8ec5($t321c3,$b20612,$j7a402){ $s69a10=gmdate('r',$b20612); $d1872a=md5($b20612); if ($j7a402=='rss'){ if(XML_AS_TEXT){ header('Content-Type: text/plain'); } else { header('Content-type: application/xml; charset=utf-8'); } } elseif ($j7a402=='json'){ header('Content-Type: application/json'); } else { header('Content-Type: text/plain'); } header('Last-modified: '. $s69a10); header('Etag: '. $d1872a); header('Cache-Control: public'); header('Expires: '. date('r',$b20612+SECONDS_IN_A_DAY)); $m0c3cd=isset($_SERVER['HTTP_IF_MODIFIED_SINCE'])? stripslashes($_SERVER['HTTP_IF_MODIFIED_SINCE']) : false; $bc3522=isset($_SERVER['HTTP_IF_NONE_MATCH'])? stripslashes($_SERVER['HTTP_IF_NONE_MATCH']) : false; if ( !$m0c3cd && !$bc3522 or $bc3522 && $bc3522!=$d1872a or $m0c3cd && $m0c3cd!=$s69a10 ){ if ($j7a402=='rss'){ $g8bb85=o99a9($g8bb85); } echo $t321c3; } else { header('HTTP/1.1 304 Not Modified'); } die; } function e2m_year($parameters=array ()) { global$_strings,$_config; $t84cdc=$parameters['year']; $t09d6c=e2l_get_string('pt--nth-year', array ('year' => $t84cdc)); if (!y1665($t84cdc)) { return e2_error404_mode(); } $ge6e7d=gmmktime(0,0,0,1,1,$t84cdc-1); $d029bd=gmmktime(0,0,0,1,1,$t84cdc+1); list ($h8aebd,$k5a7f3)=e2__fruitful_neighbours_with_ymd_($t84cdc); $za6d40='e2m_year'; if ($h8aebd){ $ub3b32['prev-href']=v83c8( $za6d40,e2__parameters_with_timestamp_($h8aebd) ); $ub3b32['prev-jump?'] = (bool) (gmdate('Y',$ge6e7d)!=gmdate('Y',$h8aebd)); $ub3b32['prev-title']=gmdate('Y',$h8aebd); } if ($k5a7f3){ $ub3b32['next-href']=v83c8( $za6d40,e2__parameters_with_timestamp_($k5a7f3) ); $ub3b32['next-jump?'] = (bool) (gmdate('Y',$d029bd)!=gmdate('Y',$k5a7f3)); $ub3b32['next-title']=gmdate('Y',$k5a7f3); } $ub3b32['timeline?']=false; $ub3b32['this']=$t84cdc; $ub3b32['this-title']=$t84cdc; $ob2442=ycc02('start'); $j8dbc7=ycc02('end'); if ( $t84cdc==w5a2f('Y',$ob2442['stamp'],$ob2442['timezone']) ) { $vfa098=w5a2f('m',$ob2442['stamp'],$ob2442['timezone']); } else { $vfa098=1; } if ( $t84cdc==ba846('Y',time()) ) { $qfd384=ba846('m',time()); } else { $qfd384=12; } $n6eac3=v9737($t84cdc); for ($k7436f=1; $k7436f <= 12; ++ $k7436f){ $d7f769=gmmktime(0,0,0,$k7436f,1,$t84cdc); $dd039b[$k7436f] = array ( 'number' => $k7436f, 'start-time' => array ($d7f769,n3211()), 'href' => gmdate('Y/m/',$d7f769), 'real?' => $k7436f >= $vfa098 and $k7436f <= $qfd384, 'fruitful?' => @in_array(gmdate('n',$d7f769),$n6eac3), ); } list ($m7b314,$va1f20)=l5273($t84cdc); s0738( "SELECT * FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `IsPublished` = 1 ". a6f32(ee852()). "AND `Stamp` BETWEEN ". $m7b314 ." ". "AND ". $va1f20 ." ". "ORDER BY `Stamp`" ); $result=z0d6b(); $b4358b=t28df($result,$t84cdc); $x2cb9d=array ( 'title' => $t09d6c, 'heading' => $t09d6c, 'pages' => $ub3b32, 'year' => (int)$t84cdc, 'year-months' => $dd039b, ); if(count($b4358b)) { $x2cb9d['notes-list']=$b4358b; } else { $x2cb9d['nothing']=$_strings['gs--no-such-notes']; } return $x2cb9d; } function e2m_month($parameters=array ()) { global$_strings,$_config; $t84cdc= $parameters['year']; $k7436f=$parameters['month']; $t09d6c=e2l_get_string( 'pt--nth-month-of-nth-year', array ('year' => $t84cdc,'month' => $k7436f) ); if (!y1665($t84cdc,$k7436f)) { return e2_error404_mode(); } $ge6e7d=gmmktime(0,0,0,$k7436f-1,1,$t84cdc); $d029bd=gmmktime(0,0,0,$k7436f+1,1,$t84cdc); list ($h8aebd,$k5a7f3)=e2__fruitful_neighbours_with_ymd_($t84cdc,$k7436f); $za6d40='e2m_month'; if ($h8aebd){ $ub3b32['prev-href']=v83c8( $za6d40,e2__parameters_with_timestamp_($h8aebd) ); $ub3b32['prev-jump?'] = (bool) (gmdate('Y/m',$ge6e7d)!=gmdate('Y/m',$h8aebd)); $ub3b32['prev-title']=e2l_get_string( 'gs--nth-month-of-nth-year', array ( 'year' => gmdate('Y',$h8aebd),'month' => gmdate('n',$h8aebd) ) ); } if ($k5a7f3){ $ub3b32['next-href']=v83c8( $za6d40,e2__parameters_with_timestamp_($k5a7f3) ); $ub3b32['next-jump?'] = (bool) (gmdate('Y/m',$d029bd)!=gmdate('Y/m',$k5a7f3)); $ub3b32['next-title']=e2l_get_string( 'gs--nth-month-of-nth-year', array ( 'year' => gmdate('Y',$k5a7f3),'month' => gmdate('n',$k5a7f3) ) ); } $ub3b32['timeline?']=false; $ub3b32['this-title']=$t09d6c; list ($m7b314,$va1f20)=l5273($t84cdc,$k7436f); s0738( "SELECT * FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `IsPublished` = 1 ". a6f32(ee852()). "AND `Stamp` BETWEEN ". $m7b314 ." ". "AND ". $va1f20 ." ". "ORDER BY `Stamp`" ); $result=z0d6b(); $b4358b=t28df($result,$t84cdc,$k7436f); $pe70c4['title']=$t09d6c; $pe70c4['heading']=$t09d6c; $pe70c4['pages']=$ub3b32; $pe70c4['year'] = (int)$t84cdc; $pe70c4['month'] = (int)$k7436f; $pe70c4['month-days']=e2_pack_month_days_with_ymd_($t84cdc,$k7436f,false); if(count($b4358b)) { $pe70c4['notes-list']=$b4358b; } else { $pe70c4['nothing']=$_strings['gs--no-such-notes']; } return $pe70c4; } function e2m_day($parameters=array ()) { global$_strings; $t84cdc= (int)$parameters['year']; $k7436f=(int)$parameters['month']; $w628b7= (int)$parameters['day']; if (!(y1665($t84cdc,$k7436f,$w628b7))) { return e2_error404_mode(); } $t09d6c=e2l_get_string( 'pt--nth-day-of-nth-month-of-nth-year', array ('year' => $t84cdc,'month' => $k7436f,'day' => $w628b7) ); $ge6e7d=gmmktime(0,0,0,$k7436f,$w628b7-1,$t84cdc); $d029bd=gmmktime(0,0,0,$k7436f,$w628b7+1,$t84cdc); list ($h8aebd,$k5a7f3)=e2__fruitful_neighbours_with_ymd_($t84cdc,$k7436f,$w628b7); $za6d40='e2m_day'; if ($h8aebd){ $ub3b32['prev-href']=v83c8( $za6d40,e2__parameters_with_timestamp_($h8aebd) ); $ub3b32['prev-jump?'] = (bool) (gmdate('Y/m/d',$ge6e7d)!=gmdate('Y/m/d',$h8aebd)); $ub3b32['prev-title']=e2l_get_string( 'gs--nth-day-of-nth-month-of-nth-year', array ( 'year' => gmdate('Y',$h8aebd),'month' => gmdate('n',$h8aebd),'day' => gmdate('j',$h8aebd), ) ); } if ($k5a7f3){ $ub3b32['next-href']=v83c8( $za6d40,e2__parameters_with_timestamp_($k5a7f3) ); $ub3b32['next-jump?'] = (bool) (gmdate('Y/m/d',$d029bd)!=gmdate('Y/m/d',$k5a7f3)); $ub3b32['next-title']=e2l_get_string( 'gs--nth-day-of-nth-month-of-nth-year', array ( 'year' => gmdate('Y',$k5a7f3),'month' => gmdate('n',$k5a7f3),'day' => gmdate('j',$k5a7f3), ) ); } $ub3b32['timeline?']=false; $ub3b32['this-title']=$t09d6c; if (($result=pf9fb($t84cdc,$k7436f,$w628b7)) !== false){ $result=array_reverse($result); $m15514=ee852(); foreach($result as $z8ce4b => $b39a37){ if (jb44b($b39a37,$m15514)) { $b39a37['_']['_id']=$b39a37['ID']; $b39a37['_']['_ord']=k; $b39a37['_']['_ord_max']=count($result)-1; $b4358b[] = r6791($b39a37); } } } $pe70c4['title']=$t09d6c; $pe70c4['heading']=$t09d6c; $pe70c4['pages']=$ub3b32; $pe70c4['month-days']=e2_pack_month_days_with_ymd_($t84cdc,$k7436f,$w628b7); if(count($b4358b)) { $pe70c4['notes']=$b4358b; } else { $pe70c4['nothing']=$_strings['gs--no-such-notes']; } return $pe70c4; } function q71d9(){ global$_config; $b4358b=null; if(CACHE_FULLLIST and is_file(CACHE_FILENAME_FULLLIST)) { $b4358b=@unserialize(file_get_contents(CACHE_FILENAME_FULLLIST)); if(__LOG)__log('Everything: retrieving from cache...'); } if (!is_array($b4358b)) { if(__LOG)__log('Everything: retrieving from database...'); s0738( "SELECT `ID`, `Title`, `Stamp`, `LastModified`, `Offset`, `IsDST`, ". "`IsFavourite`, `IsPublished`, `IsVisible`, `SourceNoteURL`, `OriginalAlias` ". "FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `IsPublished` = 1 ". a6f32(). "ORDER BY `Stamp`" ); $result=z0d6b(); if(__LOG)__log('Everything: preparing notes list...'); $b4358b=t28df($result); if(__LOG)__log('Everything: saving cache...'); if(CACHE_FULLLIST)x6e52(CACHE_FILENAME_FULLLIST,serialize($b4358b)); } return $b4358b; } function e2m_everything($parameters=array ()) { global$_strings; $b4358b=q71d9(); $m1f525=count($b4358b); $t09d6c=e2l_get_string('pt--n-posts', array ('number' => $m1f525)); if(array_key_exists('part',$_GET) and array_key_exists('of',$_GET)) { if(__LOG)__log('Everything: splitting into parts...'); $vf4c93=$_GET['part']; $f8bf88=$_GET['of']; $t09d6c.=' ('. e2l_get_string('gs--part-x-of-y', array ('part' => $vf4c93,'of' => $f8bf88)) .')'; $y895e3=$m1f525/$f8bf88; $ld98a0=($vf4c93-1)*$y895e3; $f01b6e=$vf4c93*$y895e3; $b4358b=array_slice($b4358b,round($ld98a0),round($f01b6e-round($ld98a0))); } if(__LOG)__log('Everything: done, returning'); $pe70c4['title']=$t09d6c; $pe70c4['heading']=$t09d6c; if(count($b4358b)) { $pe70c4['notes-list']=$b4358b; } else { $pe70c4['nothing']=$_strings['gs--no-notes']; } return $pe70c4; } function e2m_sitemap_xml($parameters=array ()) { if(XML_AS_TEXT){ header('Content-Type: text/plain'); } else { header('Content-type: application/xml; charset=utf-8'); } echo '<?xml version="1.0" encoding="UTF-8"?>'."\r\n"; echo '<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">'."\r\n"; $b4358b=q71d9(); if(count($b4358b)) { $b20612=@$b4358b[0]['last-modified']; echo '<url>'."\r\n"; echo '<loc>'. v83c8('e2m_frontpage', array ('page' => 1)) .'</loc>'."\r\n"; echo '<lastmod>'; echo w5a2f('Y-m-dH:i:s',$b20612[0],$b20612[1]); echo '</lastmod>'."\r\n"; echo '<changefreq>hourly</changefreq>'; echo '</url>'."\r\n"; foreach ($b4358b as $iaad65){ echo '<url>'."\r\n"; echo '<loc>'; echo $iaad65['href']; echo '</loc>'."\r\n"; echo '<lastmod>'; echo w5a2f('Y-m-dH:i:s',$iaad65['last-modified'][0],$iaad65['last-modified'][1]); echo '</lastmod>'."\r\n"; echo '</url>'."\r\n"; } } echo '</urlset>'."\r\n"; die; } function e2_pack_month_days_with_ymd_($t84cdc,$k7436f,$w628b7){ $qa6933=w5a2f('t',gmmktime(0,0,0,$k7436f,1,$t84cdc),n3211()); $ob2442=ycc02('start'); $j8dbc7=ycc02('end'); if ( $t84cdc .'/'. $k7436f == w5a2f('Y/n',$ob2442['stamp'],$ob2442['timezone']) ) { $c42eb4=w5a2f('d',$ob2442['stamp'],$ob2442['timezone']); } else { $c42eb4=1; } if ( $t84cdc .'/'. $k7436f == ba846('Y/n',time()) ) { $ud5f50=ba846('d',time()); } else { $ud5f50=$qa6933; } $de4602=kae09($t84cdc,$k7436f); for ($v865c0=1; $v865c0 <= $qa6933; ++ $v865c0){ $d7f769=gmmktime(0,0,0,$k7436f,$v865c0,$t84cdc); $l271c1[$v865c0] = array ( 'number' => $v865c0, 'start-time' => array ($d7f769,n3211()), 'href' => gmdate('Y/m/d/',$d7f769), 'this?' => (bool) ($v865c0==$w628b7), 'real?' => $v865c0 >= $c42eb4 and $v865c0 <= $ud5f50, 'fruitful?' => @in_array(gmdate('d',$d7f769),$de4602), ); } return $l271c1; } function y1665($t84cdc,$k7436f=false,$w628b7=false){ $ob2442=ycc02('start'); if ($ob2442===false){ return false; } $zc1f1e=w5a2f('Y',$ob2442['stamp'],$ob2442['timezone']); $vebeb3=ba846('Y',time()); if ($k7436f===false){ return (bool) ( $t84cdc >= $zc1f1e and $t84cdc <= $vebeb3 ); } else { $w782fc=w5a2f('n',$ob2442['stamp'],$ob2442['timezone']); $w13dd1=ba846('n',time()); if ($w628b7===false){ return (bool) ( $k7436f >= 1 and $k7436f <= 12 and ( ($t84cdc > $zc1f1e and $t84cdc < $vebeb3) or ($t84cdc==$zc1f1e and $k7436f >= $w782fc) or ($t84cdc==$vebeb3 and $k7436f <= $w13dd1) ) ); } else { $w7a9c0=w5a2f('j',$ob2442['stamp'],$ob2442['timezone']); $k23209=ba846('j',time()); if(1){ return (bool) ( checkdate($k7436f,$w628b7,$t84cdc) and ( ($t84cdc > $zc1f1e and $t84cdc < $vebeb3) or ($t84cdc==$zc1f1e and $k7436f > $w782fc) or ($t84cdc==$zc1f1e and $k7436f==$w782fc and $w628b7 >= $w7a9c0) or ($t84cdc==$vebeb3 and $k7436f < $w13dd1) or ($t84cdc==$vebeb3 and $k7436f==$w13dd1 and $w628b7 <= $k23209) ) ); } } } } function e2__fruitful_neighbours_with_ymd_($p41529,$k6f8f5=false,$v8277e=false){ global$_db,$_config; list ($i3d2fa,$l9468c)=l5273($p41529,$k6f8f5,$v8277e); $eada4b=SECONDS_IN_A_DAY; if ($v8277e===false)$eada4b=SECONDS_IN_A_MONTH; if ($k6f8f5===false)$eada4b=SECONDS_IN_A_YEAR; if (x0f7c()) { $_db['result']=mysqli_query( $_db['link'], "SELECT `Stamp`, `Offset`, `IsDST` ". "FROM `". $_config['db_table_prefix']. "Notes` n ". "WHERE `IsPublished`=1 ". "AND `Stamp` < '". ($l9468c-$eada4b) ."' ". a6f32(ee852()). "ORDER BY Stamp DESC" ); while ($u6438c=@mysqli_fetch_array($_db['result'],MYSQLI_ASSOC)) { list ($t84cdc,$k7436f,$w628b7)=explode('/', w5a2f('Y/n/j',$u6438c['Stamp'],m0923($u6438c)) ); $i7474d=$p41529*10000 + ($k6f8f5? ($k6f8f5*100):0) + ($v8277e? $v8277e:0); $rbd8da=$t84cdc*10000 + ($k6f8f5? ($k7436f*100):0) + ($v8277e? $w628b7:0); if ($rbd8da < $i7474d){ $ibf025=gmmktime(0,0,0,$k7436f,$w628b7,$t84cdc); break; } } $_db['result']=mysqli_query( $_db['link'], "SELECT `Stamp`, `Offset`, `IsDST` ". "FROM `". $_config['db_table_prefix']. "Notes` n ". "WHERE `IsPublished`=1 ". "AND `Stamp` > '". ($i3d2fa+$eada4b) ."' ". a6f32(ee852()). "ORDER BY Stamp" ); while ($u6438c=@mysqli_fetch_array($_db['result'],MYSQLI_ASSOC)) { list ($t84cdc,$k7436f,$w628b7)=explode('/', w5a2f('Y/n/j',$u6438c['Stamp'],m0923($u6438c)) ); $i7474d=$p41529*10000 + ($k6f8f5? ($k6f8f5*100):0) + ($v8277e? $v8277e:0); $rbd8da=$t84cdc*10000 + ($k6f8f5? ($k7436f*100):0) + ($v8277e? $w628b7:0); if ($rbd8da > $i7474d){ $z8dc98=gmmktime(0,0,0,$k7436f,$w628b7,$t84cdc); break; } } return array ($ibf025,$z8dc98); } } function e2__parameters_with_timestamp_($a96b8c){ list ( $parameters['year'], $parameters['month'], $parameters['day'] ) = explode('/',gmdate('Y/m/d',$a96b8c)); return$parameters; } function t28df($uc2d18,$t84cdc=false,$k7436f=false){ $m229c3=0; $b4358b=array(); $mf09d8=''; $b4358b=array(); $gcc73f=array(); foreach ($uc2d18 as $z8ce4b => $b39a37){ $iaad65['href'] = v83c8('e2m_note', array ('*note' => $b39a37)); $iaad65['time'] = array ((int)min($b39a37['Stamp'],time()), m0923($b39a37)); $iaad65['last-modified'] = array ((int)min($b39a37['LastModified'],time()), m0923($b39a37)); $iaad65['favourite?'] = (bool) ($b39a37['IsFavourite'] && $b39a37['IsPublished']); $iaad65['visible?'] = jb44b($b39a37); if(array_key_exists('SourceNoteURL',$b39a37) and @$b39a37['SourceNoteURL']!=''){ $iaad65['href']=$b39a37['SourceNoteURL']; $iaad65['href-original']=$b39a37['SourceNoteURL']; } if ( ($t84cdc and $k7436f and ( ((int)$t84cdc) .'/'. ((int)$k7436f) == w5a2f('Y/n',$b39a37['Stamp'],m0923($b39a37)) )) or ($t84cdc and !$k7436f and ( (int)$t84cdc == w5a2f('Y',$b39a37['Stamp'],m0923($b39a37)) )) or (!$t84cdc and !$k7436f) ) { array_unshift($b4358b,$iaad65); array_unshift($gcc73f,str_replace("\n",' ',$b39a37['Title'])); } } $f789f1=implode("\n",$gcc73f); $f789f1=i6f10(htmlspecialchars($f789f1,ENT_NOQUOTES,HSC_ENC)); $gcc73f=explode("\n",$f789f1); foreach ($b4358b as $z8ce4b => $q9e366){ $b4358b[$z8ce4b]['title']=$gcc73f[$z8ce4b]; } return $b4358b; } function v9737($p41529){ global$_config; list ($j5a603,$ac2b31)=l5273($p41529); if (s0738( "SELECT `Stamp`, `Offset`, `IsDST` ". "FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `IsPublished`=1 ". "AND `Stamp` BETWEEN '". $j5a603. "' AND '". $ac2b31 ."' ". a6f32(ee852()) )) { $result=z0d6b(); $rda36c=array(); foreach($result as $o65afd){ if ( ((int)$p41529) == w5a2f('Y',$o65afd['Stamp'],m0923($o65afd)) ) { $rda36c[] = (int)w5a2f('n',$o65afd['Stamp'],m0923($o65afd)); } } $rda36c=@array_unique($rda36c); sort($rda36c); return $rda36c; } else { return false; } } function kae09($p41529,$k6f8f5){ global$_config; list ($ofc6b2,$i10df4)=l5273($p41529,$k6f8f5); if (s0738( "SELECT `Stamp`, `Offset`, `IsDST` ". "FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `IsPublished`=1 ". "AND `Stamp` BETWEEN '". $ofc6b2 ."' AND '". $i10df4 ."' ". a6f32(ee852()) )) { $result=z0d6b(); $u44fde=array(); foreach($result as $o65afd){ if ( ((int)$p41529) .'/'. ((int)$k6f8f5) == w5a2f('Y/n',$o65afd['Stamp'],m0923($o65afd)) ) { $u44fde[] = (int)w5a2f('j',$o65afd['Stamp'],m0923($o65afd)); } } $u44fde=@array_unique($u44fde); sort($u44fde); return $u44fde; } else { return false; } } function ycc02($s92c58){ global$_config; $i8b7af='p1'; if (!ee852()) { $i8b7af='p1v1'; } $ed29bb=CACHES_FOLDER.$s92c58 .'-stamp-'. $i8b7af .'.e2time.psa'; if(CACHE_EDGE_TIMEINFO and is_file($ed29bb)) { $result=@unserialize(file_get_contents($ed29bb)); } if(is_array($result)) { return$result; } else { if ($s92c58=='start'){ s0738( "SELECT `Stamp`, `Offset`, `IsDST` ". "FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `IsPublished`=1 ". a6f32(ee852()). "ORDER BY `Stamp` LIMIT 1" ); } elseif ($s92c58=='end'){ s0738( "SELECT `Stamp`, `Offset`, `IsDST` ". "FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `IsPublished`=1 ". a6f32(ee852()). "ORDER BY `Stamp` DESC LIMIT 1" ); } $result=z0d6b(); if(count($result)) { $result=array ( 'stamp' => $result[0]['Stamp'], 'timezone' => m0923($result[0]), ); if(CACHE_EDGE_TIMEINFO)x6e52($ed29bb,serialize($result)); return$result; } else { return array (); } } } function e2s_sync(){ e2_drop_all_kinds_of_cache(); die ('All caches clean.'); } function e2_note_cache_filename_with_id_($sb80bb){ return str_replace('*',$sb80bb,CACHE_FILENAMES_NOTES); } function e2_drop_caches_for_note_($z21158){ if(is_numeric($z21158)) { if(__LOG)__log('Caches: Drop caches for note id '. $z21158); @unlink(e2_note_cache_filename_with_id_($z21158)); @unlink(e2_note_cache_filename_with_id_($z21158 .'-comments')); @unlink(e2_note_cache_filename_with_id_($z21158 .'-comments-author')); } else { fc5a6(CACHE_FILENAMES_NOTES); fc5a6(CACHE_FILENAMES_NOTES_COMMENTS); fc5a6(CACHE_FILENAMES_NOTES_COMMENTS_AUTHOR); } ve2f1(); b22e7(); @unlink(CACHE_FILENAME_HOT); @unlink(CACHE_FILENAME_POPULAR); @unlink(CACHE_FILENAME_FRONTPAGE); @unlink(CACHE_FILENAME_FRONTPAGE_AUTHOR); @unlink(CACHE_FILENAME_FRONTPAGE_FEED); @unlink(CACHE_FILENAME_FULLLIST); @unlink(CACHE_FILENAME_TAGS); @unlink(CACHE_FILENAME_TAGS_AUTHOR); @unlink(CACHE_FILENAME_LASTMODIFIEDS); } function z7996(){ if(__LOG)__log('Caches: Drop notes caches'); e2_drop_caches_for_note_(null); } function ve2f1(){ if(__LOG)__log('Caches: Drop notes counts cache'); fc5a6(CACHE_FILENAMES_NOTES_COUNTS); } function b22e7(){ if(__LOG)__log('Caches: Drop egde time info cache'); fc5a6(CACHE_FILENAMES_EDGE_TIMEINFO); } function e2_drop_all_kinds_of_cache(){ if(__LOG)__log('Caches: Drop all kinds of caches'); fc5a6(CACHES_FOLDER.'*'); return true; } function u4e27($e139c8){ global$_template,$_config; if(__LOG)__log('Olba: Prepare template <'. $e139c8 .'>'); $zaf10b=array(); $a8598c=$e139c8; $x620f7=TEMPLATES_FOLDER.$a8598c .'/'; $w1b14d=false; $oa5fca=false; $t37c8a=false; if ( $e139c8!='' ){ if ( is_dir($x620f7) and is_file($x620f7 .'/theme-info.php') ) { while (1){ $x620f7=TEMPLATES_FOLDER.$a8598c .'/'; array_push($zaf10b,$x620f7); $i38226=include $x620f7 .'/theme-info.php'; $t4e502[$x620f7]=$i38226; if(array_key_exists('max_image_width',$i38226)) { if ($w1b14d===false){ $w1b14d=$i38226['max_image_width']; } } if(array_key_exists('meta_viewport',$i38226)) { if ($oa5fca===false){ $oa5fca=$i38226['meta_viewport']; } } if(array_key_exists('use_likely_light',$i38226)) { if ($t37c8a===false){ $t37c8a=$i38226['use_likely_light']; } } if(array_key_exists('based_on',$i38226)) { $a8598c=$i38226['based_on']; } else { break; } } } else { } } $x620f7=SYSTEM_TEMPLATE_FOLDER; array_push($zaf10b,$x620f7); if ($w1b14d===false){ $w1b14d=$_config['max_image_width']; } $_template['name']=$e139c8; $_template['max_image_width']=$w1b14d; $_template['meta_viewport']=$oa5fca; $_template['use_likely_light']=$t37c8a; $_template['stack']=$zaf10b; $_template['infos']=$t4e502; }; function d53ee($gd436e){ global$content; ++ $_olba_includes; include $gd436e; } function s6a97($s52678){ if(0){ echo '<div style="background: #ff0">'.$s52678.'</div>'; } if(is_dir(EXTRAS_FOLDER)) { $d71cae=EXTRAS_FOLDER.$s52678 .'.tmpl.php'; if(is_file($d71cae)) { d53ee($d71cae); } } return ''; } function q166b($s52678){ global$_template,$_olba_includes; $d71cae='templates/'. $s52678 .'.tmpl.php'; if ($gd436e=e2o__usable_file_with_basename_($d71cae)) { if(__LOG)__log('Olba: Apply template <'. $gd436e .'>'); d53ee($gd436e); } else { m1928($d71cae); } } function mbc21(){ global$_config; if ( @$_config['raw_template_data'] or @$_config['raw_template_data_with_param'] and array_key_exists('raw',$_GET) ) { $n3f7d9='raw'; } else { $n3f7d9='main'; } return q166b($n3f7d9); } function m1928($i8b7af){ zf1da($i8b7af,'_olba_missing_templates'); } function ud4c1($t45ac4){ zf1da($t45ac4 .'.css','_olba_used_stylesheets'); } function hd00a($t3205c){ zf1da($t3205c .'.js','_olba_used_scripts'); } function g16f0($de8acc){ foreach (array (SYSTEM_LIBRARY_FOLDER,USER_LIBRARY_FOLDER) as $x71379){ foreach(glob($x71379.$de8acc .'/*') as $o8c7dd){ $pabf77=pathinfo($o8c7dd,PATHINFO_EXTENSION); if ($pabf77=='js'){ zf1da($o8c7dd,'_olba_used_scripts'); } if ($pabf77=='css'){ zf1da($o8c7dd,'_olba_used_stylesheets'); } } } } function ge655(){ global$_olba_missing_templates; if (isset ($_olba_missing_templates)) { return array_unique($_olba_missing_templates); } } function k94dd(){ global$_template,$_config,$settings; if ($ue1260=@opendir(TEMPLATES_FOLDER)) { while (false !== ($x1f769=readdir($ue1260))) { if(is_dir(TEMPLATES_FOLDER. $x1f769) and $x1f769!='.' and $x1f769!='..'){ if(is_file(TEMPLATES_FOLDER.$x1f769 .'/theme-info.php')) { $cccf6b[$x1f769]=TEMPLATES_FOLDER.$x1f769 .'/'; } } } closedir($ue1260); } $o10ae9=array(); $r2e3a2=1000; foreach ($cccf6b as $ub0689 => $a85114){ $i38226=include $a85114 .'theme-info.php'; $rc2657=@$i38226['display_name']; if (!$rc2657) continue; if(is_array($rc2657)) { if(array_key_exists($settings['language'],$rc2657)) { $rc2657=$rc2657[$settings['language']]; } else { $rc2657=array_shift($rc2657); } } $z6a992=@$i38226['index'] or $z6a992=$r2e3a2 ++; $t62848=@$i38226['colors']; if (!$t62848)$t62848=array ( 'background' => 'transparent', 'headings' => 'rgba(128,128,128,.2)', 'text' => 'rgba(128,128,128,.2)', 'link' => 'rgba(128,128,128,.2)', ); $u16e25=(bool) ($ub0689==$_template['name']); if ($u16e25){ $gcd143=v83c8('e2m_theme_preview', array ('theme' => '')); } else { $gcd143=v83c8('e2m_theme_preview', array ('theme' => $ub0689)); } $o10ae9[$z6a992] = array ( 'name' => $ub0689, 'display-name' => $rc2657, 'colors' => $t62848, 'current?' => $u16e25, 'preview-url' => $gcd143, ); } ksort($o10ae9); return $o10ae9; } function d1492($v435ed){ return e2o__usable_file_with_basename_('images/'. $v435ed); } function if42c($fb1197){ return file_get_contents(e2o__usable_file_with_basename_('images/'. $fb1197 .'.svg')); } function k576f($t45ac4){ global$_template; $s954eb='styles/'. $t45ac4 .'.css'; $u95aa1=array(); foreach($_template['stack'] as $x620f7){ if(is_file($v435ed=$x620f7.$s954eb)) { $u95aa1[] = $v435ed; } if ( array_key_exists('reset_styles',$_template['infos'][$x620f7]) and in_array($t45ac4,$_template['infos'][$x620f7]['reset_styles']) ) { break; } } $u95aa1=array_reverse($u95aa1); } function n37ca(){ global$_olba_used_stylesheets,$_template; if (!isset ($_olba_used_stylesheets)) return; $_olba_used_stylesheets=array_unique($_olba_used_stylesheets); $ac7f50=array(); foreach($_olba_used_stylesheets as $t45ac4){ if(is_file($t45ac4)) { $ac7f50[] = $t45ac4; continue; } if(is_file($v435ed=USER_FOLDER .'js/'. $t45ac4)) { $ac7f50[] = $v435ed; } $s954eb='styles/'. $t45ac4; $u95aa1=array(); foreach($_template['stack'] as $x620f7){ if(is_file($v435ed=$x620f7.$s954eb)) { $u95aa1[] = $v435ed; } if ( array_key_exists('reset_styles',$_template['infos'][$x620f7]) and in_array($t45ac4,$_template['infos'][$x620f7]['reset_styles']) ) { break; } } $u95aa1=array_reverse($u95aa1); $ac7f50=array_merge($ac7f50,$u95aa1); } foreach ($ac7f50 as $z8ce4b => $q9e366){ $lbc7b3=stat($q9e366); $ac7f50[$z8ce4b].='?'. $lbc7b3['mtime']; } return $ac7f50; } function d4753(){ global$_olba_used_scripts; if (!isset ($_olba_used_scripts)) return; $_olba_used_scripts=array_unique($_olba_used_scripts); $pd6c58=array(); foreach($_olba_used_scripts as $t3205c){ if ( substr($t3205c,0,7)=='http://' or substr($t3205c,0,8)=='https://' or substr($t3205c,0,2)=='//' ){ $pd6c58[] = $t3205c; continue; } if(is_file($t3205c)) { $pd6c58[] = $t3205c; continue; } if(is_file($d9d679=USER_FOLDER .'js/'. $t3205c)) { $pd6c58[] = $d9d679; } $s954eb='js/'. $t3205c; if ($d9d679=e2o__usable_file_with_basename_($s954eb)) { $pd6c58[] = $d9d679; } } foreach ($pd6c58 as $z8ce4b => $q9e366){ $lbc7b3=stat($q9e366); if ($lbc7b3['mtime']) { $pd6c58[$z8ce4b].='?'. $lbc7b3['mtime']; } } return $pd6c58; } function zf1da($o2063c,$gf1f71){ if (!isset ($GLOBALS[$gf1f71])) { $GLOBALS[$gf1f71] = array ($o2063c); } else { $GLOBALS[$gf1f71][] = $o2063c; } } function e2o__usable_file_with_basename_($s954eb){ global$_template; foreach($_template['stack'] as $x620f7){ if(is_file($v435ed=$x620f7.$s954eb)) { return $v435ed; } } return ''; } function e2m_theme_preview($parameters){ global$_lang,$_strings,$_superconfig,$_template; if (@$_superconfig['disallow_themes_preview']) { return e2_error404_mode(); } if($parameters['theme']==$_template['name']) { e2_go_to(v83c8('e2m_theme_preview', array ('theme' => ''))); } if($parameters['theme']) { u4e27($parameters['theme']); } $q75725=$_lang; if (!is_file($o8c7dd='system/preview/'. $q75725 .'.php')) { $q75725=$_strings['--secondary-language']; $o8c7dd='system/preview/'. $q75725 .'.php'; } if (!is_file($o8c7dd='system/preview/'. $q75725 .'.php')) { $o8c7dd='system/preview/'. DEFAULT_LANGUAGE .'.php'; } $pe70c4=include $o8c7dd; return $pe70c4; } define('SEARCH_EXTRA_PREFIX','Rose'); define('SEARCH_LIMIT',20); define('SEARCH_SNIPPETS_LIMIT',20); define('SEARCH_USE_ROSE',1); define('SEARCH_USE_MYSQL',1); use S2\Rose\Storage\Exception\EmptyIndexException; use S2\Rose\Storage\Database\PdoStorage; use S2\Rose\Stemmer\PorterStemmerRussian; use S2\Rose\Indexer; use S2\Rose\Entity\Indexable; use S2\Rose\Entity\Query; use S2\Rose\Finder; use S2\Rose\SnippetBuilder; function e2m_found($parameters=array ()) { global$_strings,$_config,$settings,$full_blog_url; $parameters['query']=trim($parameters['query']); $p1b1cc=$parameters['query']; if (!$p1b1cc){ return array ( 'title' => $_strings['pt--search-query-empty'], 'heading' => $_strings['pt--search'], 'nothing' => $_strings['gs--search-query-empty'], ); } $v11128=false; if (s0738( "SELECT * FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `Keyword`='". y7928($p1b1cc)."'" )) { $bfa816=z0d6b(); if (isset ($bfa816[0]['ID'])) { $v11128=array ( 'href' => v83c8('e2m_tag', array ('*tag' => $bfa816[0])), 'name' => htmlspecialchars($p1b1cc,ENT_NOQUOTES,HSC_ENC), ); } } $q4dd42=z163d(' ',$parameters['query']); $qfce9c=new PorterStemmerRussian(); foreach ($q4dd42 as $z8ce4b => $q9e366){ $q4dd42[$z8ce4b]=$qfce9c -> stemWord($q4dd42[$z8ce4b]); } $d8e830=array(); $q5d481=ee852(); if(SEARCH_USE_ROSE){ try { $addece=g476c(); $y5b9bd=new Finder($addece,$qfce9c); $y5b9bd -> setHighlightTemplate('<mark>%s</mark>'); $ff7de9=new Query($p1b1cc); $ff7de9 -> setLimit(SEARCH_LIMIT); $resultSet=$y5b9bd -> find($ff7de9); foreach($resultSet -> getFoundExternalIds() as $s0e684){ if ($s0e684[0]=='n'){ $z21158=substr($s0e684,1); $iaad65=h4627($z21158); if ($iaad65['IsFavourite']) { $resultSet->setRelevanceRatio($s0e684, @$_config['search_favourites_boost']); } } } $snippetBuilder=new SnippetBuilder($qfce9c); $snippetBuilder -> setSnippetLineSeparator(' · '); $snippetBuilder -> attachSnippets($resultSet, function (array $qbf516){ $result=array(); foreach(array_slice($qbf516,0,SEARCH_SNIPPETS_LIMIT) as $s0e684){ if ($s0e684[0]=='n'){ $z21158=substr($s0e684,1); $b39a37=@h4627($z21158); if ($b39a37){ $b39a37['_']['_id']=$z21158; $iaad65=r6791($b39a37); $result[$s0e684]=$iaad65['text']; } } } return$result; }); foreach($resultSet -> getItems() as $s0e684 => $f447b7){ if ($s0e684[0]=='n'){ $z21158=substr($s0e684,1); $iaad65=h4627($z21158); $iaad65['_']['_id']=$z21158; $iaad65['_']['_srprovider']='rose'; $iaad65['_']['_rose_relevance']=$f447b7 -> getRelevance(); $iaad65['_']['_rose_title']=$f447b7 -> getHighlightedTitle($qfce9c); $iaad65['_']['_rose_snippet']=$f447b7 -> getSnippet(); if ($iaad65['IsPublished'] and jb44b($iaad65,$q5d481)) { $d8e830[] = $iaad65; } } } if($_config['rose_debug_info']) { $o1e441=print_r($resultSet -> getTrace(),true); } } catch (EmptyIndexException $e){} } if(1 and SEARCH_USE_MYSQL){ $p36a38=y7928(preg_quote($p1b1cc)); $ueb31b=( "SELECT * FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `IsPublished`=1 AND MATCH (`Title`, `Text`) AGAINST ('". $p36a38 ."')". a6f32($q5d481). "LIMIT ". SEARCH_LIMIT ); if (s0738($ueb31b)) { $result=z0d6b(); foreach($result as $z8ce4b => $iaad65){ $iaad65['_']['_id']=$iaad65['ID']; $iaad65['_']['_srprovider']='mysql'; $d8e830[] = $iaad65; } } } $sfbdf2=array(); $b4358b=array(); $v865c0=0; foreach ($d8e830 as $b39a37){ if (!in_array($b39a37['ID'],$sfbdf2)) { $iaad65=r6791($b39a37); if (@$iaad65['_']['_rose_title']) { $iaad65['title']=$iaad65['_']['_rose_title']; } else { $iaad65['title']=c4c2d($iaad65['title'],$q4dd42); } $iaad65['title']=i6f10($iaad65['title']); if (@$iaad65['_']['_rose_snippet']) { $iaad65['text']='<p>'. $iaad65['_']['_rose_snippet'] .'</p>'; } else { $y1cb25=$iaad65['text']; $y1cb25=preg_replace('/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/i','',$y1cb25); $y1cb25=preg_replace('/<style\b[^<]*(?:(?!<\/style>)<[^<]*)*<\/style>/i','',$y1cb25); $y1cb25=str_replace( array ( '<br>', '<br/>', '<br />', '</h1>', '</h2>', '</h3>', '</h4>', '</h5>', '</h6>', '</p>', '</pre>', '</blockquote>', '</li>', ), ' ', $y1cb25 ); $y1cb25=strip_tags($y1cb25); $cad7ba=array(); $n9cc49=preg_split('/[\\n\(\)\[\]]|[.:;?!](\s|$)/uis',$y1cb25); $j363b1=0; $r02db3=''; foreach ($n9cc49 as $xd866f){ $xd866f=trim($xd866f); if (!$xd866f) continue; if (!$r02db3)$r02db3=$xd866f; $s870c2=$xd866f; $s870c2=c4c2d($s870c2,$q4dd42); if ($s870c2!=$xd866f){ $cad7ba[] = c48d8($s870c2); $j363b1 ++; if ($j363b1 > 3) break; } } if(count($cad7ba)) { $iaad65['text']='<p>'. implode(' · ',$cad7ba) .'</p>'; } else { $iaad65['text']='<p>'. $r02db3 .'</p>'; } } $iaad65['has-highlighed-thumbs?']=false; if ($o55b55=@$iaad65['format-info']['resources-detected']) { $x750fa=p2e82($o55b55); foreach ($x750fa as $z8ce4b => $q9e366){ $x750fa[$z8ce4b]['highlighted?'] = ( strstr($q9e366['original-filename'],$p1b1cc)!==false ); if ($x750fa[$z8ce4b]['highlighted?']) { $iaad65['has-highlighted-thumbs?']=true; } } $iaad65['thumbs']=$x750fa; } $b4358b[] = $iaad65; $sfbdf2[] = $b39a37['ID']; $v865c0 ++; if ($v865c0 >= SEARCH_LIMIT) break; } } $mfbb44=count($b4358b); if ($mfbb44){ $i5cde2=e2l_get_string( 'pt--n-posts', array ('number' => $mfbb44) ); } else { $i5cde2=$_strings['pt--no-posts']; $x2cb9d['nothing']=$_strings['gs--nothing-found']; } if ($v865c0 >= SEARCH_LIMIT){ $i5cde2=$_strings['gs--many-posts']; } if ($v11128){ $x2cb9d['search-related-tag']=$v11128; } $x2cb9d['notes']=$b4358b; $x2cb9d['pages'] = array (); $x2cb9d['title']=$i5cde2 .' '. $_strings['gs--found-for-query'] .': '. htmlspecialchars($p1b1cc,ENT_NOQUOTES,HSC_ENC); $x2cb9d['superheading']=$i5cde2 .' '. $_strings['gs--found-for-query']; $x2cb9d['heading']=$p1b1cc; if (@$o1e441){ $x2cb9d['rose-debug-info']=$o1e441; } return $x2cb9d; } function e2s_search(){ $p1b1cc=@$_POST['query']; $p1b1cc=str_replace('?',urlencode('?'),$p1b1cc); $p1b1cc=str_replace('/',' ',$p1b1cc); $p1b1cc=trim($p1b1cc); $p1b1cc=str_replace(' ','+',$p1b1cc); e2_go_to(v83c8('e2m_found', array ('query' => $p1b1cc))); die; } function e2s_bsi_status(){ global$_db,$_config; echo '<pre>'; echo '/@bsi/step/ — Make one step of indexing<br />'; echo '/@bsi/drop/ — Drop indexes<br /><br />'; $oe1fab=@unserialize(file_get_contents(USER_FOLDER.'indexing.psa')); if (!is_array($oe1fab))$oe1fab=array ('spent' => '?'); if (x0f7c() and $_db['link']) { $g34421=$ze0d69='?'; if (s0738( "SELECT count(*) c FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished`=1 " )) { $w9b207=z0d6b(); $g34421=$w9b207[0]['c']; } if (s0738( "SELECT count(*) c FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsIndexed`=1 AND `IsPublished`=1 " )) { $w9b207=z0d6b(); $ze0d69=$w9b207[0]['c']; } $id1647=round($ze0d69/$g34421*100); echo 'Indexed '. $ze0d69 .' notes of '. $g34421 .' ('. $id1647 .'%)<br />'; echo 'Spent '. $oe1fab['spent'] .' s (or more)'; } else { echo 'DB unaccessible'; } die ('</pre>'); } function e2s_bsi_step(){ global$_db,$_config,$_strings; if(__LOG)__log('BSI step'); if (!p3b97()) { die ('Not indexing</pre>'); } $oe1fab=@unserialize(file_get_contents(USER_FOLDER.'indexing.psa')); if (!is_array($oe1fab))$oe1fab=array ('spent' => '?'); if ( !isset ($oe1fab['lock']) or $oe1fab['lock'] < time() - (BSI_GIVE_UP_TIMEOUT+BSI_UNLOCK_TIMEOUT) ) { if (isset ($oe1fab['lock'])) { echo 'Old lock: '. $oe1fab['lock'] .'<br />'; } else { echo 'No old lock<br />'; } $oe1fab['lock']=time(); if (!@x6e52(USER_FOLDER.'indexing.psa',serialize($oe1fab))) { echo 'Can’t get a new lock<br />'; die; } echo 'New lock: '. $oe1fab['lock'] .'<br /><br />'; if (x0f7c() and $_db['link']) { $v865c0=0; $m680a2=0; $nce2fc=w7f78(); $k30d94=false; while ($m680a2 < BSI_GIVE_UP_TIMEOUT){ if (s0738( "SELECT * FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsIndexed`=0 AND `IsPublished`=1 ". "ORDER BY `Stamp` DESC ". "LIMIT ". BSI_SELECT_PORTION )) { $w9b207=z0d6b(); } if(count($w9b207)) { echo 'Portion '. ++$v865c0 .'<br />'; foreach ($w9b207 as $pea59a){ echo 'Indexing: '. $pea59a['Title'] .'<br />'; $pea59a['IsIndexed']='1'; if (paa79('Notes',$pea59a)) { od2e1($pea59a); if($_config['broadcast_on_indexing']) { web3b($pea59a); } } } $m680a2=round(w7f78()-$nce2fc,3); echo 'Done '. count($w9b207) .', spent '. $m680a2 .' ms so far<br /><br />'; } else { $k30d94=true; break; } } if ($k30d94){ echo 'Indexing done<br /><br />'; @unlink(USER_FOLDER.'indexing.psa'); } else { echo 'Time out<br />'; unset ($oe1fab['lock']); $oe1fab['done']=count($w9b207); if ($oe1fab['spent']!='?')$oe1fab['spent']+=$m680a2; @x6e52(USER_FOLDER.'indexing.psa',serialize($oe1fab)); } } else { echo 'DB unaccessible<br />'; } } else { echo 'Locked<br />'; } die ('</pre>'); } function e2s_bsi_drop(){ global$_db,$_config; if (x0f7c() and $_db['link']) { echo '<pre>'; if (oa521()) { echo 'All notes marked for reindexing<br />'; $addece=g476c(); try { $addece -> erase(); echo 'Indexes dropped<br />'; } catch (\S2\Rose\Exception\RuntimeException $e){ echo 'Rose not available<br />'; } } else { echo 'DB error: '. mysqli_error($_db['link']).'<br />'; } q198f(); die ('</pre>'); } die ('<pre>DB unaccessible</pre>'); } define('BSI_SELECT_PORTION',10); define('BSI_GIVE_UP_TIMEOUT',10); define('BSI_UNLOCK_TIMEOUT',10); function q198f(){ $oe1fab=array(); @x6e52(USER_FOLDER.'indexing.psa',serialize($oe1fab)); } function p3b97(){ return (is_file(USER_FOLDER.'indexing.psa')); } function od2e1($b39a37){ if(__LOG)__log('Indexer: index noterec'); static $af4540=null; try { if ($af4540===null){ $qfce9c=new PorterStemmerRussian(); $af4540=new Indexer(g476c(),$qfce9c); } $e2bfe4=q154e($b39a37['FormatterID'], @$b39a37['Text'],'full-rss'); ifc4d($b39a37,$e2bfe4); $y1cb25=strip_tags($e2bfe4['text-final']); $s3e961=new Indexable( 'n'. $b39a37['ID'], $b39a37['Title'], $y1cb25 ); return $af4540 -> index($s3e961); } catch (Exception $e){ return false; } } function i10fe($sb80bb){ static $af4540=null; try { if ($af4540===null){ $qfce9c=new PorterStemmerRussian(); $af4540=new Indexer(g476c(),$qfce9c); } return $af4540 -> removeById('n'. $sb80bb); } catch (Exception $e){ return false; } } function r713e($wa2f2e){ $t851f5='S2\\Rose\\'; $a32fcc=__DIR__.'/library/rose/'; $ff5a8e=strlen($t851f5); if(strncmp($t851f5,$wa2f2e,$ff5a8e)!==0) return; $re1cb9=substr($wa2f2e,$ff5a8e); $o8c7dd=$a32fcc.str_replace('\\','/',$re1cb9).'.php'; if(file_exists($o8c7dd)) require $o8c7dd; } function bd372(){ return array ( 'TOC' => 'Contents', 'WORD' => 'Word', 'FULLTEXT_INDEX' => 'Fulltext', 'KEYWORD_INDEX' => 'Keyword', 'KEYWORD_MULTIPLE_INDEX' => 'KeywordMultiple', ); } function g476c(){ global$_config,$settings; static $p88131=null; if ($p88131===null){ $fcf66e=new \PDO( 'mysql:'. 'host='. $settings['db']['server'] .';'. 'dbname='. $settings['db']['name'], $settings['db']['user_name'], kee85($settings['db']['passw']) ); $h2af72=$fcf66e -> getAttribute(\PDO::ATTR_SERVER_VERSION); $o84bea=version_compare($h2af72,'5.5.3','>=')?'utf8mb4':'utf8'; $fcf66e -> exec('SET NAMES '.$o84bea); $fcf66e -> setAttribute(\PDO::ATTR_ERRMODE, \PDO::ERRMODE_EXCEPTION); $j44b61=bd372(); $p88131=new PdoStorage( $fcf66e, $_config['db_table_prefix'].SEARCH_EXTRA_PREFIX, array ( PdoStorage::TOC => $j44b61['TOC'], PdoStorage::WORD => $j44b61['WORD'], PdoStorage::FULLTEXT_INDEX => $j44b61['FULLTEXT_INDEX'], PdoStorage::KEYWORD_INDEX => $j44b61['KEYWORD_INDEX'], PdoStorage::KEYWORD_MULTIPLE_INDEX => $j44b61['KEYWORD_MULTIPLE_INDEX'], ) ); } return $p88131; } function c4c2d($y1cb25,$q4dd42){ foreach ($q4dd42 as $b2510c){ if ($b2510c=='-') continue; $b2510c=preg_quote($b2510c,'/'); $b2510c=str_replace('е','[её]',$b2510c); $b2510c=str_replace('Е','[ЕЁ]',$b2510c); $y1cb25=preg_replace('/(?<=^|\W)('.$b2510c.'[\w\p{M}]*)/iu','<mark>$1</mark>',$y1cb25); } $y1cb25=str_replace('</mark> <mark>',' ',$y1cb25); $y1cb25=str_replace('</mark> <mark>',' ',$y1cb25); return $y1cb25; } function c48d8($x341be){ $te05fe=mb_strtoupper(mb_substr($x341be,0,1)); return $te05fe.mb_substr($x341be,1); } function oa521(){ global$_config; return s0738( "UPDATE `". $_config['db_table_prefix']."Notes` ". "SET `IsIndexed`=0" ); } function e2_check_timeout(){ static $r90272; if(is_null($r90272)) { $ff48ef=ini_get('max_execution_time'); if ($ff48ef){ $r90272=time()+$ff48ef-5; } else { $r90272=0; } } return ($r90272==0)?true:$r90272 >= time(); } function e2_write_dump_header($o8c7dd){ $g099fb=( 'SET SQL_MODE="NO_AUTO_VALUE_ON_ZERO";' .PHP_EOL. 'SET AUTOCOMMIT=0;' .PHP_EOL. 'START TRANSACTION;' .PHP_EOL. "/*!40101 SET @OLD_CHARACTER_SET_CLIENT=@@CHARACTER_SET_CLIENT */;" .PHP_EOL. "/*!40101 SET @OLD_CHARACTER_SET_RESULTS=@@CHARACTER_SET_RESULTS */;" .PHP_EOL. "/*!40101 SET @OLD_COLLATION_CONNECTION=@@COLLATION_CONNECTION */;" .PHP_EOL. "/*!40014 SET @OLD_UNIQUE_CHECKS=@@UNIQUE_CHECKS, UNIQUE_CHECKS=0 */;" .PHP_EOL. "/*!40014 SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0 */;" .PHP_EOL. "/*!40101 SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE=NO_AUTO_VALUE_ON_ZERO */;" .PHP_EOL. "/*!40101 SET NAMES utf8 */;" .PHP_EOL. "/*!50503 SET NAMES utf8mb4 */;" .PHP_EOL. '' ); fwrite($o8c7dd,$g099fb); return true; } function e2_write_dump_footer($o8c7dd){ $k251d1='COMMIT;' .PHP_EOL; $k251d1 .= "/*!40101 SET SQL_MODE=@OLD_SQL_MODE */;" .PHP_EOL ."/*!40014 SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS */;" .PHP_EOL ."/*!40014 SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS */;" .PHP_EOL ."/*!40101 SET CHARACTER_SET_RESULTS=@OLD_CHARACTER_SET_RESULTS */;".PHP_EOL ."/*!40101 SET COLLATION_CONNECTION=@OLD_COLLATION_CONNECTION */;" .PHP_EOL ."/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;" .PHP_EOL; fwrite($o8c7dd,$k251d1); return true; } function e2_get_table_definition($i0c1d0,$vaab9e){ $b5c286=null; $result=mysqli_query($i0c1d0,"SHOW CREATE TABLE `{$vaab9e}`"); if($result){ $a47c80=mysqli_fetch_array($result); $b5c286=$a47c80['Create Table']; } return $b5c286; } function e2_write_table_definition($o8c7dd,$i0c1d0,$vaab9e){ $s30618=e2_get_table_definition($i0c1d0,$vaab9e); if(e2_check_timeout() && $s30618){ fwrite($o8c7dd,$s30618); fwrite($o8c7dd,';'); fwrite($o8c7dd,PHP_EOL.PHP_EOL); return true; } return false; } function e2_get_table_data($i0c1d0,$vaab9e,$w7a86c,$iaa9f7){ $p1b1cc="SELECT * FROM `{$vaab9e}` LIMIT {$w7a86c}, {$iaa9f7}"; $result=mysqli_query($i0c1d0,$p1b1cc); if (!$result){ return false; } $m66e9c=''; $r3c41a="INSERT INTO `{$vaab9e}` VALUES"; while ($if1965=mysqli_fetch_assoc($result)) { $g691d5=array(); foreach($if1965 as $o2063c){ $g691d5[] = is_null($o2063c)?"NULL":"'".mysqli_real_escape_string($i0c1d0,$o2063c)."'"; } $m66e9c.=$r3c41a.'('.join(', ',$g691d5).');'.PHP_EOL; } return $m66e9c; } function e2_table_disable_keys($vaab9e){ return "ALTER TABLE `{$vaab9e}` DISABLE KEYS;".PHP_EOL; } function e2_table_enable_keys($vaab9e){ return "ALTER TABLE `{$vaab9e}` ENABLE KEYS;".PHP_EOL; } function e2_get_total_records($i0c1d0,$vaab9e){ $z8ce4b=mysqli_fetch_row(mysqli_query($i0c1d0,"SELECT COUNT(*) FROM `{$vaab9e}`")); return $z8ce4b[0]; } function e2_write_table_data($o8c7dd,$i0c1d0,$vaab9e){ $mfbb44=e2_get_total_records($i0c1d0,$vaab9e); $w7a86c=0; $iaa9f7=1000; $result=true; $q47495=20000; $x80fc1=30; if ($mfbb44){ $gfbda5=e2_table_disable_keys($vaab9e); fwrite($o8c7dd,$gfbda5); } $m66e9c="INSERT INTO `{$vaab9e}` VALUES"; $hde57a=$mfbb44; while ($hde57a > 0){ $p1b1cc="SELECT * FROM `{$vaab9e}` LIMIT {$w7a86c}, {$iaa9f7}"; $result=mysqli_query($i0c1d0,$p1b1cc); $yb428d=mysqli_num_rows($result); if (!$result || !e2_check_timeout()) { $result=false; break; } $sdf347=array(); $r4b3a6=0; $vb6539=0; while ($if1965=mysqli_fetch_assoc($result)) { if (!e2_check_timeout()) { $result=false; break; } $yb428d--; $l54ca8=array(); foreach($if1965 as $o2063c){ $l54ca8[] = is_null($o2063c)?"NULL":"'".mysqli_real_escape_string($i0c1d0,$o2063c)."'"; } $p8d777='('.join(', ',$l54ca8).')'; $r4b3a6+=strlen($p8d777); $sdf347[] = $p8d777; $vb6539++; if ( ($r4b3a6 >= $q47495) || ($vb6539 >= $x80fc1) || ($yb428d==0)) { $p1b1cc=$m66e9c.join(', ',$sdf347).';'; fwrite($o8c7dd,$p1b1cc); fwrite($o8c7dd,PHP_EOL); $r4b3a6=0; $vb6539=0; $sdf347=array(); } } $w7a86c+=$iaa9f7; $hde57a -= $iaa9f7; } if ($mfbb44){ $h6bfc4=e2_table_enable_keys($vaab9e); fwrite($o8c7dd,$h6bfc4); } return$result; } function e2_backup($i0c1d0,$o9ab2e,$pa9745,$i93da6=array()) { $p2beda=tmpfile(); e2_write_dump_header($p2beda); if(__LOG)__log('DB Backup: wrote header'); $h75101=true; foreach($o9ab2e as $vaab9e){ if(__LOG)__log('DB Backup: table '. $vaab9e); $g91e7e=e2_write_table_definition($p2beda,$i0c1d0,$vaab9e); if(__LOG)__log('DB Backup: wrote table definition with result '. (int)$g91e7e); $e35285=e2_write_table_data($p2beda,$i0c1d0,$vaab9e); if(__LOG)__log('DB Backup: wrote table data with result '. (int)$e35285); $h75101=$g91e7e && $e35285; if ($h75101===false){ break; } } if(__LOG)__log('DB Backup: wrote data with running == '. (int)$h75101); if ($h75101){ e2_write_dump_footer($p2beda); fseek($p2beda,0); $o8c7dd=fopen($pa9745,'w+'); while ($h75101 && ($p8d777=fread($p2beda,1024))) { if(e2_check_timeout()) { fwrite($o8c7dd,$p8d777); } else { $h75101=false; } } fclose($o8c7dd); } fclose($p2beda); return $h75101; } function b3e5c($r0c426,$content){ $o52766=MTMPL_FOLDER.$r0c426 .'.mtmpl.php'; if(is_file($o52766)) { ob_start(); include $o52766; $hde7a3=ob_get_contents(); ob_end_clean(); return trim($hde7a3); } } function yaed2(){ global$_config,$_superconfig; $g9e35a=$_config['mail_from']; if (@$_superconfig['mail_from']) { $g9e35a=$_superconfig['mail_from']; } if ($g9e35a[strlen($g9e35a)-1]=='@'){ $g9e35a.=$_SERVER['HTTP_HOST']; } return $g9e35a; } function ia41b($f01b6e,$subject,$e78e73,$y145a2=''){ global$_superconfig; if (@$_superconfig['mail_debug']) { $m8fa14=tempnam('mail-debug',''); $y1cb25=( 'To:       '.$f01b6e ."\n". 'Subject:  '.$subject ."\n". $y145a2 ."\n". "--------------------------------------------------\n". $e78e73 ); x6e52($m8fa14,$y1cb25); chmod($m8fa14,NEW_FILES_RIGHTS); rename($m8fa14,$m8fa14.'.txt'); } $subject='=?UTF-8?B?'. base64_encode($subject) .'?='; $y145a2.="\r\nContent-Type: text/plain; charset=utf-8"; mail($f01b6e,$subject,$e78e73,trim($y145a2)); } function _A($y1cb25){ global$_candy,$_protocol,$s57de2,$wa57c1,$_current_url; if ( preg_match('/\<a href\=\"(.*?)\"[^>]*\>(.*?)\<\/a\>/si',$y1cb25,$u9c28d) and ( $u9c28d[1]=='' or $u9c28d[1]==$_current_url or $_protocol .'://'. $s57de2.$u9c28d[1]==$_current_url or $_protocol .'://'. $s57de2.$wa57c1 .'/'. $u9c28d[1]==$_current_url or $_candy=='e2m_install' ) ) { return $u9c28d[2]; } else { return $y1cb25; } } function _AT($fe8fab){ global$_candy,$s57de2,$wa57c1,$_current_url; return ( $fe8fab=='' or $fe8fab==$_current_url or $_protocol .'://'. $s57de2.$fe8fab==$_current_url or $_protocol .'://'. $s57de2.$wa57c1 .'/'. $fe8fab==$_current_url ); } function _IMGSRC($v435ed){ return d1492($v435ed); } function _SVG($v435ed){ return if42c($v435ed); } function _COLOR($jf97c5,$fb8a9f,$xcc321,$e4efa2=1){ if(strlen($jf97c5)!=3 and strlen($jf97c5)!=6) return 'f0f'; if(strlen($fb8a9f)!=3 and strlen($fb8a9f)!=6) return 'f0f'; if(strlen($jf97c5)==3)$jf97c5=$jf97c5{0}.$jf97c5{0}.$jf97c5{1}.$jf97c5{1}.$jf97c5{2}.$jf97c5{2}; if(strlen($fb8a9f)==3)$fb8a9f=$fb8a9f{0}.$fb8a9f{0}.$fb8a9f{1}.$fb8a9f{1}.$fb8a9f{2}.$fb8a9f{2}; $bf09cc=array ( $jf97c5{0}.$jf97c5{1}, $jf97c5{2}.$jf97c5{3}, $jf97c5{4}.$jf97c5{5}, $fb8a9f{0}.$fb8a9f{1}, $fb8a9f{2}.$fb8a9f{3}, $fb8a9f{4}.$fb8a9f{5}, ); foreach ($bf09cc as $z8ce4b => $q9e366){ $bf09cc[$z8ce4b]=hexdec($q9e366); } $g22af6=array ( $bf09cc[0]+pow($xcc321,$e4efa2) * ($bf09cc[3]-$bf09cc[0]), $bf09cc[1]+pow($xcc321,$e4efa2) * ($bf09cc[4]-$bf09cc[1]), $bf09cc[2]+pow($xcc321,$e4efa2) * ($bf09cc[5]-$bf09cc[2]), ); $e70dda=''; foreach ($g22af6 as $z8ce4b => $q9e366){ $e70dda.=str_pad(dechex($q9e366),2,'0',STR_PAD_LEFT); } return $e70dda; } function _DT($s1ddcb,$rb35c6){ if (!$rb35c6) return ''; list ($a96b8c,$qb2c6c)=$rb35c6; $x2cb9d=$s1ddcb; $k7436f=w5a2f('m',$a96b8c,$qb2c6c); $x2cb9d=str_replace('{zone}',e2__escape_all(w9515($qb2c6c['offset'])), $x2cb9d); $x2cb9d=str_replace('{month}',e2__escape_all(e2l_get_string('um--month', array ('month' => $k7436f))), $x2cb9d); $x2cb9d=str_replace('{month-short}',e2__escape_all(e2l_get_string('um--month-short', array ('month' => $k7436f))), $x2cb9d); $x2cb9d=str_replace('{month-g}',e2__escape_all(e2l_get_string('um--month-g', array ('month' => $k7436f))), $x2cb9d); $x2cb9d=w5a2f($x2cb9d,$a96b8c,$qb2c6c); return $x2cb9d; } function _AGO($rb35c6){ return a9093($rb35c6[0], array ('offset' => $rb35c6[1]['offset'],'is_dst' => $rb35c6[1]['is_dst']) ); } function _NUM($y1cb25){ return e2_decline_for_number($y1cb25); } function _FIRST($y437b9){ return ($y437b9['_']['_ord']==0); } function _LAST($y437b9){ return ($y437b9['_']['_ord']==$y437b9['_']['_ord_max']); } function _CSS($uc7a62){ return ud4c1($uc7a62); } function _CSS_HREF($uc7a62){ return k576f($uc7a62); } function _JS($t32981){ return hd00a($t32981); } function _LIB($de8acc){ return g16f0($de8acc); } function _T($s52678){ return q166b($s52678); } function _X($s52678){ return s6a97($s52678); } function _T_FOR($s52678,$cd5566=null){ global$content; if ($cd5566===null)$cd5566=$s52678; if(array_key_exists($cd5566,$content)) { q166b($s52678); } else { return ''; } } function _GUIDES($oeca07=false){ global$_olba_guides; if(is_array($oeca07))$_olba_guides=$oeca07; if (!is_array($_olba_guides)) return; $a88408='<div style="position: fixed; width: 100%; height: 100%; z-index: -100">'; $o1d623=0; $l07d43=$_olba_guides; $l07d43[] = 100; foreach ($l07d43 as $v865c0 => $id89e2){ if ($id89e2==100) break; $o1d623+=$id89e2; $a88408.='<div style="position: fixed; left: '. $id89e2 .'%; width: 0; height: 100%; border-left: 1px #000 dotted; opacity: .2; -webkit-opacity: .2; -moz-opacity: .2"></div>'; $ta1b01='position: absolute; padding: 2px 3px; top: 0; font-size: 9px; background: #ccc; color: #000; font-family: "Verdana", sans-serif; opacity: .8; -webkit-opacity: .8; -moz-opacity: .8'; if ($l07d43[$v865c0+1]-$l07d43[$v865c0] < 4){ $a88408.='<div style="'. $ta1b01.'; right: '. (100-$id89e2) .'%; border-bottom-left-radius: .5em; -webkit-border-bottom-left-radius: .5em; -moz-border-bottom-left-radius: .5em;">'. $id89e2 .'%</div>'; } else { $a88408.='<div style="'. $ta1b01.'; left: '. $id89e2 .'%; border-bottom-right-radius: .5em; -webkit-border-bottom-right-radius: .5em; -moz-border-bottom-right-radius: .5em;">'. $id89e2 .'%</div>'; } } $a88408.='</div>'; $_olba_current_col=0; return $a88408; } function _S($lb45cf){ global$_strings; return$_strings[$lb45cf]; } function _SHORTCUT($ub0689){ return mbb8d($ub0689); } function e2__escape_all($lb45cf){ $x2cb9d=''; for ($v865c0=0; $v865c0 < mb_strlen($lb45cf); ++ $v865c0){ $x2cb9d.='\\'. mb_substr($lb45cf,$v865c0,1); } return $x2cb9d; } function e2l_get_string($yfa206,$p8d777){ global$_strings; $ub0689=$_strings[$yfa206]; if(preg_match_all('/\$\[(.+?)\]/u',$ub0689,$u9c28d,PREG_SET_ORDER)) { foreach ($u9c28d as $ze3cc9){ $xb2145=$ze3cc9[1]; $mf2ffc=''; if(strstr($xb2145,'.')) list ($xb2145,$mf2ffc)=explode('.',$xb2145,2); if(array_key_exists($xb2145,$p8d777)) { if ($mf2ffc){ $ub0689=str_replace($ze3cc9[0],e2l__format_value($mf2ffc,$p8d777[$xb2145],$yfa206),$ub0689); } else { $ub0689=str_replace($ze3cc9[0],$p8d777[$xb2145],$ub0689); } } } } return $ub0689; } function e2l_transliterate($lb45cf){ $oe358e=array(); if(is_file(DEFAULTS_FOLDER.'translit.txt')) { $oe358e=file(DEFAULTS_FOLDER.'translit.txt'); } $ld98a0=$f01b6e=''; foreach ($oe358e as $v865c0 => $u6438c){ if (!($v865c0%2))$ld98a0.=rtrim($u6438c) .' '; else $f01b6e.=rtrim($u6438c) .' '; if ($v865c0%2){ while (mb_strlen($f01b6e) < mb_strlen($ld98a0))$f01b6e.=' '; while (mb_strlen($f01b6e) > mb_strlen($ld98a0))$ld98a0.=' '; } } $l60ae1=''; $sde2e7=-1; for ($v865c0=0; $v865c0 < mb_strlen($ld98a0); ++ $v865c0){ $s4a8a0=mb_substr($ld98a0,$v865c0,1); if ($s4a8a0!=' '){ $l60ae1.=$s4a8a0; if ($sde2e7 == -1)$sde2e7=$v865c0; } elseif ($l60ae1){ $n52ac1=trim(mb_substr($f01b6e,$sde2e7,mb_strpos($f01b6e,' ',$sde2e7+1)-$sde2e7)); $g33c9b=array ($l60ae1,$n52ac1); $dce83f[mb_strlen($l60ae1)][] = $g33c9b; $l60ae1=''; $sde2e7=-1; } } $w1d78d=array(); for ($v865c0=count($dce83f); $v865c0 > 0; -- $v865c0){ foreach ($dce83f[$v865c0] as $g33c9b)$w1d78d[$g33c9b[0]] = $g33c9b[1]; } return strtr($lb45cf,$w1d78d); } function e2l__format_value($mf2ffc,$o2063c,$yfa206){ list ($mf2ffc,$v3ad73)=explode('.',$mf2ffc,2); $re6875='e2lstr_'. $mf2ffc; if(function_exists($re6875)) { return call_user_func($re6875,$o2063c,$v3ad73,$yfa206); } else { return $o2063c; } return $o2063c; } abstract class E2GIP { protected $gip_cookie_name='gip'; protected $gip_token_cookie_name='gip_access_token'; protected $gip_token=null; abstract public function get_auth_url(); abstract public static function get_profile_url($sb80bb); abstract public function callback(); public static function set_session_data($y3c6e0,$o2063c){ if(session_status()==PHP_SESSION_NONE){ session_start(); } $_SESSION[$y3c6e0]=$o2063c; } public static function get_session_data($y3c6e0,$pe2181=false){ if(session_status()==PHP_SESSION_NONE){ session_start(); } if(!isset($_SESSION[$y3c6e0])) { return null; } $o2063c=$_SESSION[$y3c6e0]; if($pe2181){ unset($_SESSION[$y3c6e0]); } return $o2063c; } public function get_config($y3c6e0){ $vcbb14='gips/'. $this->type .'.json'; if(is_file(USER_FOLDER.$vcbb14)) { $o466de=@file_get_contents(USER_FOLDER.$vcbb14); } else { $o466de=@file_get_contents(SYSTEM_FOLDER.$vcbb14); } if ($o466de!==false){ $x2cb9d=json_decode($o466de,true,512,JSON_BIGINT_AS_STRING)[$y3c6e0]; if ($x2cb9d) return $x2cb9d; } return null; } public function get_callback_url(){ return v83c8('e2m_gip_sign_in_callback', array('provider' => $this->type)); } protected function get_proxy_param(){ global$settings; return '?language='.$settings['language'].'&type='.$this->type.'&callback_url='.urlencode($this->get_callback_url()); } public function get_gip_session_data(){ global$_config; $b94a08=$this->gip_token?$this->gip_token:$_COOKIE[p8c3b($this->gip_token_cookie_name)]; s0738( "SELECT * FROM `". $_config['db_table_prefix']."GIPsSessions` ". "WHERE `GIP` = '". $this->type ."' AND `SessionToken` = '".y7928($b94a08)."'ORDER BY `ID` DESC LIMIT 1" ); $result=z0d6b(); return$result?$result[0] : array(); } public function is_logged_in(){ if(empty($_COOKIE[p8c3b($this->gip_cookie_name)]) || !in_array($_COOKIE[p8c3b($this->gip_cookie_name)], e2_list_gips()) || $_COOKIE[p8c3b($this->gip_cookie_name)] != $this->type || empty($_COOKIE[p8c3b($this->gip_token_cookie_name)])) { return false; } $p8d777=$this->get_gip_session_data(); return (bool)$p8d777; } protected function save_session($sb80bb,$ub0689,$accessToken,$wb974d='',$userEmail='',$userLink=''){ $a96b8c=time(); f9943( 'GIPsSessions', array ( 'GIP' => $this->type, 'GIPAuthorID' => $sb80bb, 'AuthorName' => $ub0689, 'AuthorEmail' => $userEmail, 'AuthorProfileLink' => $userLink, 'SessionToken' => $accessToken, 'Stamp' => $a96b8c, ), 'INSERT', 'ON DUPLICATE KEY UPDATE '. '`SessionToken` = "'.y7928($accessToken).'", '. '`AuthorName` = "'.y7928($ub0689).'", '. '`Stamp` = "'.$a96b8c.'"' ); rc64a($this->gip_cookie_name,$this->type); rc64a($this->gip_token_cookie_name,$accessToken); if(isset($userEmail) && !empty($userEmail))rc64a('commenter_email',$userEmail); $this->gip_token=$accessToken; } public static function get_logout_key(){ if ($g4a73c=self::get_session_data('logout_key')) { return $g4a73c; } $g4a73c=md5(microtime()); self::set_session_data('logout_key',$g4a73c); return $g4a73c; } public static function is_valid_logout_key($y3c6e0){ $reb1de=self::get_session_data('logout_key',true); if (empty($reb1de) || empty($y3c6e0) || $reb1de!=$y3c6e0){ return false; } return true; } public function logout(){ global$_config; rc64a($this->gip_cookie_name); rc64a($this->gip_token_cookie_name); return s0738( "DELETE FROM `". $_config['db_table_prefix']."GIPsSessions` ". "WHERE `GIP` = '".$this->type."' AND `SessionToken` = '".y7928($_COOKIE[p8c3b($this->gip_token_cookie_name)]) . "'" ); } public function get_avatar_width(){ return USERPIC_WIDTH; } public function get_avatar_height(){ return USERPIC_HEIGHT; } public function save_avatar($sb80bb,$g3d02b){ global$_config; @saf42(MEDIA_ROOT_FOLDER.AVATARS_FOLDER); @chmod(MEDIA_ROOT_FOLDER.AVATARS_FOLDER,$_config['uploaded_files_mode']); $v435ed=MEDIA_ROOT_FOLDER.AVATARS_FOLDER.$this->type .'-'. $sb80bb .'.jpg'; if ($h5b860=file_get_contents($g3d02b)) { file_put_contents($v435ed,$h5b860); } return $v435ed; } } function e2m_gip_sign_in($p8d777){ global$_config,$settings; $type=$p8d777['provider']; $c7123a=e2_get_gip_instance($type); if (!$c7123a){ s4930(); die; } header('Location: '.$c7123a->get_auth_url()); die; } function e2m_gip_sign_in_callback($p8d777){ global$_config; $type=$p8d777['provider']; $c7123a=e2_get_gip_instance($type); if (!$c7123a){ die($type.' is not defined'); } $y73797=$c7123a->callback(); echo '<script>'; if ($y73797===true){ $ia64f4=$c7123a->get_gip_session_data(); $k78506=[ 'name' => $ia64f4['AuthorName'], 'gipIcon' => _SVG($type), 'logoutUrl' => v83c8('e2m_gip_sign_out', array('provider' => E2GIP::get_logout_key())), ]; echo 'window.opener.oauthAuthorized('.json_encode($k78506).');'; } else { echo 'alert (\''. $y73797. '\');'; } echo 'window.close();</script>'; die; } function e2m_gip_sign_out($p8d777){ global$_config; $g4a73c=$p8d777['provider']; if (!E2GIP::is_valid_logout_key($g4a73c)) { die('invalid logout key'); } $c7123a=e2_get_logged_gip(); if($c7123a){ $c7123a->logout(); } s4930(); die; } function e2_list_gips(){ static $f2d168=null; if(!is_null($f2d168)) { return $f2d168; } $w1c05f=SYSTEM_FOLDER. 'gips/'; $h700f6=opendir($w1c05f); $f2d168=[]; while (($o8c7dd=readdir($h700f6)) !== false){ if(pathinfo($o8c7dd,PATHINFO_EXTENSION)!='php') continue; $f2d168[] = pathinfo($o8c7dd,PATHINFO_FILENAME); } closedir($h700f6); return $f2d168; } function e2_get_gip_class_name($type){ return "E2GIP".ucfirst($type); } function e2_get_gip_instance($type){ if (!in_array($type,e2_list_gips())) { return false; } $e38c9b=e2_get_gip_class_name($type); $c7123a=new $e38c9b; return $c7123a; } function e2_get_gip_auth_url($type){ return v83c8('e2m_gip_sign_in', array('provider' => $type)); } function e2_is_logged_in($type=''){ $rd14a8=!$type?e2_list_gips() : array($type); foreach($rd14a8 as$type){ $c7123a=e2_get_gip_instance($type); if ($c7123a && $c7123a->is_logged_in()) { return true; } } return false; } function e2_get_logged_gip(){ foreach(e2_list_gips() as$type){ $c7123a=e2_get_gip_instance($type); if ($c7123a && $c7123a->is_logged_in()) { return $c7123a; } } return false; } function e2_get_logged_gip_name(){ foreach(e2_list_gips() as$type){ $c7123a=e2_get_gip_instance($type); if ($c7123a && $c7123a->is_logged_in()) { return$type; } } return false; } function e2_get_user_profile_url($type,$l2a304){ $e38c9b=e2_get_gip_class_name($type); return $e38c9b::get_profile_url($l2a304); } function e2_get_gip_session($type){ $c7123a=e2_get_gip_instance($type); if (!$c7123a || !$c7123a->is_logged_in()) { return false; } return $c7123a->get_gip_session_data(); } foreach(e2_list_gips() as $g48e15){ require_once 'system/gips/'.$g48e15.'.php'; } spl_autoload_register(r713e); if($_config['write_log_reset'])__log(null); if(__LOG)__log('System: loaded'); if(is_file($b2d354=LANGUAGES_FOLDER.$settings['language'] .'.php')) { $_lang=$settings['language']; include $b2d354; } elseif(is_file($b2d354=LANGUAGES_FOLDER.DEFAULT_LANGUAGE .'.php')) { $_lang=DEFAULT_LANGUAGE; include $b2d354; } else { die ('Language file missing: '. $b2d354); } $_strings=e2l_load_strings(); if(!$x589b3) @include 'builder.php'; function e2(){ global $s57de2,$settings,$errors,$content, $wa57c1,$full_blog_url,$stopwatch,$p11755, $_current_url, $_newsfeeds, $_instance, $_candy, $_config, $_superconfig, $_route, $_strings, $_lang, $_candies_installer, $_candies_public, $_candies_indexable, $_candies_indexable_conditionally, $_candies_ajax, $_candies_to_disallow_in_read_only, $_user_folder_name, $_template, $_olba_includes, $_diagnose; i269a(); if(__LOG)__log('System: go'); $errors=array(); header('Content-type: text/html; charset='. OUTPUT_CHARSET); $_instance=false; if (@is_file(USER_FOLDER.'instance.psa')) { $c0d149=@file_get_contents(USER_FOLDER.'instance.psa') or $c0d149=false; if ($c0d149){ $c0d149=@unserialize($c0d149) or $c0d149=false; if ($c0d149){ $_instance=$c0d149; } } } $i66f61=@$settings['template'] or $i66f61=DEFAULT_TEMPLATE; u4e27($i66f61); $n572d4=urldecode($_GET['go']); if(__LOG)__log('System: Resolve <'. $n572d4 .'> {'); b7059(); list ($xc48ba,$parameters)=mb7e9($n572d4); foreach($_GET as $y3c6e0 => $o2063c){ $parameters[$y3c6e0]=$o2063c; } if(__LOG)__log('} // Resolve'); if(__LOG)__log( 'System: Candy <'. $xc48ba .'> {' ); if(__LOG)__log('Parameters: <'. print_r($parameters,true).'>'); $_candy=$xc48ba; $content=array(); if ( @$_config['debug_slow_ajax'] and ( in_array($xc48ba,$_candies_ajax) ) ) { sleep(1+2 * (rand()/getrandmax())); } if (!in_array($xc48ba,$_candies_installer)) { e2_make_sure_that_installed(); } if (@$_config['read_only'] and in_array($xc48ba,$_candies_to_disallow_in_read_only)) { $xc48ba='e2m_error404'; } $i58387=(bool)ee852(); $z0b448=!in_array($xc48ba,$_candies_public); $n49ecc=$z0b448 && !$i58387; if(__LOG)__log('System: signed in? '. (int)$i58387); $xc1f6f=array ( 'done?' => $i58387, 'required?' => $z0b448, 'necessary?' => $n49ecc, ); $_newsfeeds=false; j3010('rss',q6f51(),v83c8('e2m_rss')); j3010('json',q6f51(),v83c8('e2m_json')); if(is_callable($xc48ba)) { if ($n49ecc){ if(substr($xc48ba,0,4)=='e2s_'){ $content=call_user_func('e2s_sign_in_necessary'); } else { $content['title']=$_strings['pt--sign-in']; } } else { if(__LOG)__log('System: candy call'); $content=call_user_func($xc48ba,$parameters); if(__LOG)__log('System: candy return'); } } else { $xc1f6f['required?']=false; $xc1f6f['necessary?']=false; $content=e2_error404_mode(); } if(__LOG)__log('} // Candy'); if (!is_array($content))$content=array(); if (!array_key_exists('notes',$content))$content['notes'] = array (); if (!array_key_exists('drafts',$content))$content['drafts'] = array (); if (!array_key_exists('comments',$content))$content['comments'] = array (); if (!array_key_exists('notes-list',$content))$content['notes-list'] = array (); if (!array_key_exists('tags',$content))$content['tags'] = array (); if (!array_key_exists('class',$content)) { $content['class']=str_replace('_','-',str_replace('e2m_','',$xc48ba)); } $content['sign-in']=$xc1f6f; $content['sign-in-prompt']=$_strings['gs--need-password']; if(e2_is_installed()) { if(__LOG)__log('System: nav and pages'); $content['navigation-links'] = array (array ( 'rel' => 'index', 'href' => v83c8('e2m_frontpage', array ('page' => 1)), 'id' => 'link-index', )); if(array_key_exists('pages',$content)) { foreach (array ('prev','next','earlier','later') as $wc47d1){ if(array_key_exists($wc47d1 .'-href',$content['pages'])) { $j7ffc4=$wc47d1; if ($wc47d1=='earlier')$j7ffc4='prev'; if ($wc47d1=='later')$j7ffc4='next'; $content['navigation-links'][] = array ( 'rel' => $j7ffc4, 'href' => $content['pages'][$wc47d1 .'-href'], 'id' => 'link-'. $wc47d1, ); } } } if(__LOG)__log('System: search form'); if(array_key_exists('query',$parameters)) { $p1b1cc=trim($parameters['query']); } else { $p1b1cc=''; } $content['search'] = array ( 'form-action' => v83c8('e2s_search'), 'query' => htmlspecialchars(@$p1b1cc,ENT_COMPAT,HSC_ENC), ); if(__LOG)__log('System: blog information'); $content['blog']['author']=htmlspecialchars(u2640(),ENT_NOQUOTES,HSC_ENC); if(array_key_exists('description',$settings)) { $e2bfe4=wb7f1($settings['description'],'full'); $f67daf=$e2bfe4['text-final']; $content['blog']['description']=$f67daf; $content['blog']['description-format-info']=$e2bfe4['meta']; } $content['blog']['title']=htmlspecialchars(q6f51(),ENT_NOQUOTES,HSC_ENC); $content['blog']['userpic-set?']=false; if($content['blog']['userpic-href']=u2461()) { $content['blog']['userpic-changeable-href']=$content['blog']['userpic-href']; $content['blog']['userpic-set?']=true; } else { $content['blog']['userpic-href']=DEFAULT_USERPIC_FILENAME; if (ee852()) { $content['blog']['userpic-changeable-href']=DEFAULT_USERPIC_PLACEHOLDER_FILENAME; } } $content['blog']['favicon-type']='image/x-icon'; $content['blog']['favicon-href']='favicon.ico'; if (ee852()) { $content['blog']['userpic-upload-action']=v83c8('e2j_userpic_upload'); } $content['blog']['href']=v83c8('e2m_frontpage', array ('page' => 1)); $content['blog']['rss-href']=v83c8('e2m_rss'); $content['blog']['jsonfeed-href']=v83c8('e2m_json'); $content['blog']['language']=$_lang; $content['blog']['show-subscribe-button?']=false; $content['template']['use-likely-light?']=$_template['use_likely_light']; if(__LOG)__log('System: edge timeinfo'); $z97bc5=array (time(),e5c05()); $w5f36b=ba846('Y',$z97bc5[0]); $content['blog']['now']=$z97bc5; $eaa103=$w5f36b; $o33b09=ycc02('start'); if(array_key_exists('stamp',$o33b09)) { $eaa103=ba846('Y',$o33b09['stamp']); $content['blog']['start-time'] = array ((int)$o33b09['stamp'],$o33b09['timezone']); } $s40d73=(int)d3456(true,true); if (ee852()) { if(__LOG)__log('System: stuff for logged in user'); $content['blog']['drafts-count'] = (int)d3456(false,true); $content['admin-hrefs'] = array ( 'new-note' => v83c8('e2m_write'), 'drafts' => v83c8('e2m_drafts'), 'settings' => v83c8('e2m_settings'), 'theme-preview' => v83c8('e2m_theme_preview', array ('theme' => '')), 'password' => v83c8('e2m_password', array ('recovery-key' => '')), 'database' => v83c8('e2m_database'), 'timezone' => v83c8('e2m_timezone'), 'logout' => v83c8('e2m_sign_out'), ); if (rda67()) { $content['admin-hrefs']['get-backup']=v83c8('e2m_get_backup'); } if (@$_config['read_only']) { unset($content['admin-hrefs']['new-note']); unset($content['admin-hrefs']['settings']); unset($content['admin-hrefs']['timezone']); } if (@$_superconfig['disallow_themes_preview']) { unset($content['admin-hrefs']['theme-preview']); } if (@$_superconfig['disallow_db_config']) { unset($content['admin-hrefs']['database']); } list ($afe9e2,$d85ee4,$h20699)=c2a6b(); if ($afe9e2)$content['new-comments'] = array ( 'count' => $afe9e2, 'href' => $h20699, ); } else { if(__LOG)__log('System: login form'); $content['form-login']['form-action']=v83c8('e2s_sign_in'); $content['form-login']['form-check-password-action']=v83c8('e2j_check_password'); $content['form-login']['login-name'] = @$settings['author']; $content['form-login']['public-pc?']=false; $content['form-login']['reset-href']=v83c8('e2m_password_reset'); if(array_key_exists('_login_request_message',$content)) { $content['form-login']['request']=$content['_login_request_message']; } } if (ee852()) { $wd0a87=(($s40d73 + (int)d3456(true,false)) == 0); } else { $wd0a87=($s40d73==0); } if($_db_error){ $wd0a87=false; } $y9fbfe=$_config['years_range_separator']? $_config['years_range_separator']:'&mdash;'; $content['blog']['years-range']=$eaa103 . (($eaa103==$w5f36b)? '':($y9fbfe.$w5f36b)); $content['blog']['notes-count']=$s40d73; $content['blog']['virgin?']=$wd0a87; if ($wa57c1){ $content['blog']['parent-site-href']=substr($wa57c1, (int)strpos('/',$wa57c1)); } $content['hrefs'] = array ( 'sign-in' => v83c8('e2m_sign_in'), 'tags' => v83c8('e2m_tags'), 'everything' => v83c8('e2m_everything'), ); } $j1e2ad='noindex, follow'; if (@$_config['index_follow_everything']) { $j1e2ad='index, follow'; } if(in_array($xc48ba,$_candies_indexable)) { $content['robots']='index, follow'; } if(in_array($xc48ba,$_candies_indexable_conditionally)) { $content['robots']=$j1e2ad; } $content['output-charset']=OUTPUT_CHARSET; $content['base-href']=$full_blog_url. '/'; $content['current-href']=$_current_url; if (!array_key_exists('summary',$content)) { $content['summary']=strip_tags($content['blog']['description']); } $content['title']=strip_tags(i6f10(htmlspecialchars($content['title'],ENT_NOQUOTES,HSC_ENC))); if (@$content['heading']) { $content['heading']=strip_tags(i6f10(htmlspecialchars($content['heading'],ENT_NOQUOTES,HSC_ENC))); } if(__LOG)__log('System: e2_modes {'); e2_modes($parameters); if(__LOG)__log('} // e2_modes'); if (@$_config['request_logging']) { $m8fa14=fopen(USER_FOLDER. 'log-'. date('Y-m-d') .'.txt','a'); fwrite($m8fa14,date('d.m.Y H:i:s') ."\tT = ". $content['pgt'] ."\tQ = ". $content['total_queries'] ."\tIP = ". $_SERVER['REMOTE_ADDR'] ."\tRequest = ". $_SERVER['REQUEST_URI'] ."\r\n"); fclose($m8fa14); } $content['misc']['sape-link']='http://www.sape.ru/r.206a4276c2.php'; $bc8542=round(w7f78()-$stopwatch,3); $leccd7='http://'. $_strings['e2--website-host'] .'/'; $content['engine']['pgt']=str_replace('.',',',$bc8542); if(function_exists('memory_get_peak_usage')) { $content['engine']['mp']=str_replace('.',',',round((memory_get_peak_usage()/1024/1024)*100)/100); } $content['engine']['qc'] = (int) @$p11755; $content['engine']['built?']=$x589b3; $content['engine']['installed?']=e2_is_installed(); $content['engine']['version']='v'. E2_VERSION; $v68966='('. $_strings['e2--release'] .' '. E2_RELEASE .', v'. E2_VERSION .')'; $content['engine']['version-description']=$_strings['e2--vname-aegea'] .' '. $v68966; $content['engine']['user-folder-name']=$_user_folder_name; $content['engine']['cookie-prefix']=p8c3b(); $content['engine']['href']=$leccd7; $content['engine']['about']='<span title="E2 '.$v68966 .'">'. $_strings['e2--powered-by'] .' <a href="'. $leccd7 .'" class="nu"><u>'. $_strings['e2--vname-aegea'] .'</u> <span class="e2-svgi">'. _SVG('aegea') .'</span></a></span>'; $content['meta-viewport']=$_template['meta_viewport']; $content['stylesheets']=n37ca(); $content['scripts']=d4753(); if(is_file(MEDIA_ROOT_FOLDER.'manifest.json')) { $content['manifest-href']=$full_blog_url. '/manifest.json'; } if (!@isset ($_diagnose['ok?'])) { if (@$_COOKIE[p8c3b('diagnose')] or @$_diagnose['need?']) { c8739(); } } if ($qe1671=qec07()) { $content['message']=$qe1671; } if (ee852()) { $content['last-modifieds-by-id']='{}'; if (@$_COOKIE[p8c3b('local_copies')]) { $content['last-modifieds-by-id'] = ( na2d8($_COOKIE[p8c3b('local_copies')]) ); } } $content['og-images'] = array (); if(is_array($content['notes']['only']['og-images'])) { $content['og-images']=$content['notes']['only']['og-images']; $content['twitter-card']='summary_large_image'; } if(is_array($content['tag']['og-images'])) { $content['og-images']=$content['tag']['og-images']; $content['twitter-card']='summary_large_image'; } if (!count($content['og-images'])) { $content['twitter-card']='summary'; $content['og-images'] = array ($content['blog']['userpic-href']); } if(count($content['notes']) > 0){ $content['notes']=e2_populate_read_counts_in_notes_ctree_($content['notes']); } ob_start(); mbc21(); $e78e62=ob_get_contents(); ob_end_clean(); if(is_array($content['notes'])) { foreach($content['notes'] as $iaad65){ if(is_array($iaad65['format-info']['links-required'])) { foreach ($iaad65['format-info']['links-required'] as $l2a304){ if(substr($l2a304, -3)=='.js'){ hd00a(substr($l2a304,0, -3)); } if(substr($l2a304, -4)=='.css'){ ud4c1(substr($l2a304,0, -4)); } } } } } $content['stylesheets']=n37ca(); $content['scripts']=d4753(); if($_newsfeeds)$content['newsfeeds']=$_newsfeeds; ob_start(); q166b('head'); $m61ef8=ob_get_contents(); ob_end_clean(); ob_start(); q166b('scripts'); $kee59b=ob_get_contents(); ob_end_clean(); $e78e62=str_replace('<e2:head-data />',$m61ef8,$e78e62); $e78e62=str_replace('<e2:scripts-data />',$kee59b,$e78e62); $sfa6a9=false; if (p3b97()) { if(is_writable(USER_FOLDER.'indexing.psa')) { $sfa6a9=true; } else { $_diagnose['need?']=true; rc64a('diagnose','1'); } } if ( $wa0856=ge655() and !$_config['ignore_missing_template_files'] ) { echo '<h1>Templates missing</h1>'; echo '<ul>'; foreach ($wa0856 as $q380ec){ echo '<li>'. $q380ec.' </li>'; } echo '</ul>'; echo '<pre>'; print_r($content); echo '</pre>'; } else { echo $e78e62; } if ($sfa6a9){ if(__LOG)__log('System: spawn BSI step'); tcc38(v83c8('e2s_bsi_step', array ())); } if(__LOG)__log('} // System'); if(DEV_TRACK_TIME and $s57de2==DEV_HOST){ $i06bc4=str_replace('.',',',round(w7f78()-$stopwatch,3)-$bc8542); echo '<div style="font-size: 300%; text-align: center; position: fixed; bottom: 0; width: 100%; background: #ffc; opacity: .88">'. '<span style="color: #f80">'. $content['engine']['pgt'] .' '. '<small>'. $content['engine']['qc'] .'q</small></span>'. '<span style="color: #08f"> + '. $i06bc4.' '. '<small>'. $_olba_includes .'i</small></span>'. '</div>'; } } if(__LOG)__log(''); ?>