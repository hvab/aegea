<?php $_stopwatch=microtime(); define('E2_VERSION',3565); define('E2_RELEASE','2.9'); define('E2_UA_STRING','E2 (v'. E2_VERSION .'; Aegea)'); define('E2_MINIMUM_PHP','5.4'); define('E2_MINIMUM_MYSQL',4.1); define('BUILDER_OBFUSCATE',1); define('BUILDER_FLATTEN',1); define('E2_NEW_FILES_RIGHTS',0777); define('E2_JSON_STYLE',JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE); define('E2_RUN_ID',chr(rand(65,90))); define('HSC_ENC','UTF-8'); define('SECONDS_IN_A_MINUTE',60); define('SECONDS_IN_AN_HOUR',3600); define('SECONDS_IN_A_DAY',86400); define('SECONDS_IN_A_MONTH',2592000); define('SECONDS_IN_A_YEAR',31536000); if(version_compare(PHP_VERSION,E2_MINIMUM_PHP) < 0){ die ('PHP version must be '. E2_MINIMUM_PHP .' or later, you are running '. PHP_VERSION); } if(!function_exists('getimagesize')) { die ('Function getimagesize is not defined, php_gd not installed?'); } if(!function_exists('mb_internal_encoding')) { die ('Function mb_internal_encoding is not defined, php_mbstring not installed?'); } error_reporting(E_ALL); setlocale(LC_CTYPE,'ru_RU.UTF'); mb_internal_encoding('UTF-8'); date_default_timezone_set('GMT'); if(version_compare(PHP_VERSION,'7.0') < 0){ error_reporting(E_ALL & ~E_STRICT); } if(is_file('superconfig.php')) { include 'superconfig.php'; } $_protocol=( !empty ($_SERVER['HTTPS']) && $_SERVER['HTTPS']!=='off' or $_SERVER['SERVER_PORT']==443 or isset ($_SERVER['HTTP_X_FORWARDED_PROTO']) && $_SERVER['HTTP_X_FORWARDED_PROTO']=='https' or isset ($_SERVER['HTTP_X_HTTPS']) && ($_SERVER['HTTP_X_HTTPS']) ) ? 'https':'http'; if(is_file('force-https')) { $_protocol='https'; } $ja57c1=substr( $_SERVER['PHP_SELF'],0,strpos($_SERVER['PHP_SELF'],'/index.php') ); list ($o57de2, ) = explode(':',$_SERVER['HTTP_HOST']); $full_blog_url=$_protocol. '://'. $o57de2.$ja57c1; $_user_folder_name=str_replace('/','--',$o57de2.$ja57c1); if(substr($_user_folder_name,0,4)=='www.'){ $_user_folder_name=substr($_user_folder_name,4); } if(is_file('multiuser')) { if ( !empty ($_superconfig) and array_key_exists('rewrites',$_superconfig) and array_key_exists($_user_folder_name,$_superconfig['rewrites']) ) { $_user_folder_name=$_superconfig['rewrites'][$_user_folder_name]; } define('USER_FOLDER','users/'. $_user_folder_name .'/'); } else { define('USER_FOLDER','user/'); } if( !empty ($_superconfig) and array_key_exists('store_files_by_users',$_superconfig) and $_superconfig['store_files_by_users'] ) { define('MEDIA_ROOT_FOLDER',USER_FOLDER .'files/'); } else { define('MEDIA_ROOT_FOLDER',''); } define('EXTRAS_FOLDER',USER_FOLDER.'extras/'); define('BACKUP_FOLDER',USER_FOLDER.'backup/'); define('CACHES_FOLDER',USER_FOLDER.'caches/'); define('USER_LIBRARY_FOLDER',USER_FOLDER.'library/'); define('LOG_FOLDER',USER_FOLDER.'logs/'); define('PICTURES_FOLDER','pictures/'); define('THUMBNAILS_FOLDER','pictures/thumbs/'); define('AVATARS_FOLDER','pictures/avatars/'); define('AUDIO_FOLDER','audio/'); define('TEMPLATES_FOLDER','themes/'); define('SYSTEM_FOLDER','system/'); define('SCRIPTS_FOLDER','system/js/'); define('SYSTEM_LIBRARY_FOLDER','system/library/'); define('SYSTEM_TEMPLATE_FOLDER','system/theme/'); define('AUDIO_ICON_IMAGE','system/theme/images/audio.svg'); define('AUDIO_ICON_WIDTH',80); define('AUDIO_ICON_HEIGHT',80); define('LANGUAGES_FOLDER','system/languages/'); define('DEFAULTS_FOLDER','system/default/'); define('MTMPL_FOLDER','system/default/mail/'); define('DEFAULT_TEMPLATE','plain'); if(!is_file(DEFAULTS_FOLDER. 'config.php')) die ('System config missing'); include DEFAULTS_FOLDER.'config.php'; $_default_config=$_config; if(is_file(USER_FOLDER. 'config.php')) { include USER_FOLDER.'config.php'; $_config=array_merge($_default_config,$_config); } define('E2E_STRANGE_ERROR',10); define('E2E_USER_ERROR',20); define('E2E_PERMISSIONS_ERROR',30); define('E2E_MESSAGE',100); define('E2E_DIAGNOSTICS_MESSAGE',110); define('DEFAULT_ITEMS_PER_PAGE',10); define('MAX_ITEMS_PER_PAGE',100); define('FP_NO_ID_OR_NEW', -1); define('FP_INSERT_ERROR', -10); define('FP_UPDATE_ERROR', -11); define('FP_EMPTY_FIELD', -20); define('FP_TITLE_OR_TEXT_EMPTY', -21); define('FP_NOT_COMMENTABLE', -30); define('FP_COMMENT_DOUBLE_POST', -101); define('FP_COMMENT_TOO_LONG', -102); define('FP_COMMENT_SPAM_SUSPECT', -103); define('NOTE_COMMENTABLE_NOW', -1); define('NOTE_COMMENTABLE_NOW_CONDITIONALLY', -2); define('ENTITY_TYPE_UNSPECIFIED',''); define('ENTITY_TYPE_NOTE','n'); define('ENTITY_TYPE_TAG','t'); define('THUMB_WIDTH',200); define('THUMB_HEIGHT',160); define('THUMB_JPG_QUALITY',90); define('SCALED_IMAGE_JPG_QUALITY',80); define('USERPIC_WIDTH',80); define('USERPIC_HEIGHT',80); define('USERPIC_JPG_QUALITY',95); define('RESOURCES_ALL',0); define('RESOURCES_LOCAL',1); $_fp_error=false; if(strstr(__FILE__,'all.php')) { define('BUILT',0); } else { define('BUILT',1); } function e2_go_to($y56790=''){ global$_protocol,$errors,$o57de2,$ja57c1; @session_start(); $_SESSION['errors']=$errors; if(substr($y56790,0,strlen($_protocol)+3)!=$_protocol .'://'){ header('Location: '. $_protocol .'://'. $o57de2.$ja57c1 .'/'. $y56790); } else { header('Location: '. $y56790); } flush(); return true; } function i4930(){ $g469bb=$_SERVER['HTTP_REFERER']; return e2_go_to($g469bb); } function u4924($y56790){ if($_SERVER['HTTP_REFERER'])$y56790=$_SERVER['HTTP_REFERER']; return e2_go_to($y56790); } function v8c3b($bb2145=''){ $e9dd4e=substr_count($_SERVER['HTTP_HOST'],'.'); $z2cb9d=@str_repeat('_',$e9dd4e).$bb2145; return $z2cb9d; } function kc64a($bb2145,$o2063c='',$wb0b70=true){ $mcd91e=$wb0b70? (time()+3600*24*365) : (0); $zad5f8=$_SERVER['HTTP_HOST']; $le9c6c=substr_count($zad5f8,'.'); if ($le9c6c < 3)$zad5f8=str_repeat('.',3-$le9c6c).$zad5f8; $e9dd4e=setcookie(v8c3b($bb2145),$o2063c,$mcd91e,'/'); } function c163d($r183d6,$ab45cf,$vcadc8=''){ if(trim($ab45cf)!=''){ $ab45cf=explode($r183d6,$ab45cf); foreach ($ab45cf as $d865c0 => $o8ce4b)$ab45cf[$d865c0]=trim($o8ce4b); foreach ($ab45cf as $d865c0 => $o8ce4b) if ($o8ce4b=='') unset ($ab45cf[$d865c0]); $h7b774=array_unique($ab45cf); if ('sort'==$vcadc8)sort($h7b774); return $h7b774; } else return array (); } function n2183($ab45cf){ $me358e=array(); if(is_file(DEFAULTS_FOLDER.'romanize.txt')) { $me358e=file(DEFAULTS_FOLDER.'romanize.txt'); } $pd98a0=$d01b6e=''; foreach ($me358e as $d865c0 => $x6438c){ if (!($d865c0%2))$pd98a0.=rtrim($x6438c) .' '; else $d01b6e.=rtrim($x6438c) .' '; if ($d865c0%2){ while (mb_strlen($d01b6e) < mb_strlen($pd98a0))$d01b6e.=' '; while (mb_strlen($d01b6e) > mb_strlen($pd98a0))$pd98a0.=' '; } } $r60ae1=''; $mde2e7=-1; for ($d865c0=0; $d865c0 < mb_strlen($pd98a0); ++ $d865c0){ $f4a8a0=mb_substr($pd98a0,$d865c0,1); if ($f4a8a0!=' '){ $r60ae1.=$f4a8a0; if ($mde2e7 == -1)$mde2e7=$d865c0; } elseif ($r60ae1){ $c52ac1=trim(mb_substr($d01b6e,$mde2e7,mb_strpos($d01b6e,' ',$mde2e7+1)-$mde2e7)); $c33c9b=array ($r60ae1,$c52ac1); $uce83f[mb_strlen($r60ae1)][] = $c33c9b; $r60ae1=''; $mde2e7=-1; } } $a1d78d=array(); for ($d865c0=count($uce83f); $d865c0 > 0; -- $d865c0){ foreach ($uce83f[$d865c0] as $c33c9b)$a1d78d[$c33c9b[0]] = $c33c9b[1]; } return strtr($ab45cf,$a1d78d); } function ie1e7($mcdaee,$action,$f4a202){ if (!is_array($mcdaee))$mcdaee=array(); if($action=='add'){ $mcdaee=array_unique(array_merge($mcdaee,$f4a202)); } if($action=='remove'){ unset ($mcdaee[array_search($f4a202,$mcdaee)]); } if (!is_array($mcdaee))$mcdaee=array(); return $mcdaee; } function r705b($i8d777){ $parameters=$i8d777['parameters']; $sd1fc8=[ 'success' => false ]; try { $i8d777['flipping-function'] ($parameters); $l67142=$parameters; $l67142['value'] = !$parameters['value']; $sd1fc8=[ 'success' => true, 'data' => [ 'flag-now-on' => ($parameters['value']==1), 'new-href' => d83c8($i8d777['candy-name'],$l67142), ] ]; } catch (AeMySQLException $e){ e12f6($e,'Could not set '. $i8d777['flag-name'] .' flag'); } if(array_key_exists('result',$_POST) and ($_POST['result']=='ajaxresult')) { $sd1fc8=json_encode($sd1fc8); die ($sd1fc8); } else { e2_go_to(d83c8('e2m_tag',$parameters)); die; } } function ybb8d($ab45cf){ $n5269f=@$_SERVER['HTTP_USER_AGENT'] or $n5269f=''; $s8f0c7=strstr($n5269f,'iPhone') || strstr($n5269f,'iPad'); $u8bf10=strstr($n5269f,'Macintosh'); if ($s8f0c7) return ''; if ($ab45cf=='submit'){ if ($u8bf10){ return '&#x2303; &#x21a9;'; } else { return 'Ctrl + Enter'; } } if ($ab45cf=='livesave'){ if ($u8bf10){ return '&#x2318; S'; } else { return 'Ctrl + S'; } } if ($ab45cf=='navigation'){ if ($u8bf10){ return '&#x2325;'; } else { return 'Ctrl'; } } if ($ab45cf=='navigation-later'){ if ($u8bf10){ return '&#x2325; &uarr;'; } else { return 'Ctrl + &uarr;'; } } if ($ab45cf=='navigation-earlier'){ if ($u8bf10){ return '&#x2325; &darr;'; } else { return 'Ctrl + &darr;'; } } } function v7b91($l1cb25){ $l1cb25=str_replace('<','&lt;',$l1cb25); $l1cb25=str_replace('>','&gt;',$l1cb25); return $l1cb25; } function qc4b6($l1cb25){ $l1cb25=str_replace('"','&quot;',$l1cb25); return $l1cb25; } function dd056($o2063c,$m5d6db){ return str_replace('.',',',round($o2063c,$m5d6db)); } function e2_stripslashes_array($tf1f71){ return is_array($tf1f71)?array_map('e2_stripslashes_array',$tf1f71):stripslashes($tf1f71); } function iabdd(){ if(version_compare(PHP_VERSION,'7.4') >= 0) return; if(get_magic_quotes_runtime()) { set_magic_quotes_runtime(0); } if(get_magic_quotes_gpc()) { $_GET=e2_stripslashes_array($_GET); $_POST=e2_stripslashes_array($_POST); $_COOKIE=e2_stripslashes_array($_COOKIE); $_REQUEST=e2_stripslashes_array($_REQUEST); } } function m0786($u957b5){ return sprintf('%u',ip2long($u957b5)); } function p7c85($bb1bc2){ return long2ip(sprintf('%d',$bb1bc2)); } function e2_decline_for_number($l1cb25,$bb1bc2=null){ $t2f713=$l1cb25; if ($bb1bc2===null){ $bb1bc2=substr($l1cb25,0,strpos($l1cb25,' ')); $t2f713=substr($l1cb25,strpos($l1cb25,' ')+1); } $hf07c9=strpos($t2f713,'('); $r46901=strpos($t2f713,')'); if ($r46901 > $hf07c9)$l22b9f=substr($t2f713,$hf07c9,$r46901-$hf07c9+1); $h93da6=explode(',',trim(@$l22b9f,'()')); if(count($h93da6)==2)array_unshift($h93da6,''); $mc78bd=array (2,0,1,1,1,2,2,2,2,2); if ($bb1bc2%100 > 10 and $bb1bc2%100 < 20)$acd14c=2; else $acd14c=$mc78bd[$bb1bc2%10]; $aef3e3=$h93da6[$acd14c]; $l1cb25=str_replace($l22b9f,$aef3e3,$l1cb25); if(strstr($l1cb25,'(') and strstr($l1cb25,')')) { return e2_decline_for_number($l1cb25,$bb1bc2); } else { return $l1cb25; } } function bc5a6($wf2ce1){ $r87e9e=glob($wf2ce1,GLOB_NOSORT); if(is_array($r87e9e)) { foreach ($r87e9e as $x435ed){ @unlink($x435ed); } } } function t74dc($f73600){ $r87e9e=glob($f73600 .'*',GLOB_NOSORT); if(is_array($r87e9e)) { foreach ($r87e9e as $x435ed){ if(basename($x435ed)!='.' and basename($x435ed)!='..'){ if(is_dir($x435ed)) { if (t74dc($x435ed .'/')) { if (!rmdir($x435ed)) { return false; } } else { return false; } } else { @unlink($x435ed); } } } return true; } else { return false; } } function caf42($vd6fe1){ $vd6fe1=trim($vd6fe1,'/'); $vd6fe1=explode('/',$vd6fe1); $f73600=''; foreach ($vd6fe1 as $s83878){ $f73600=$f73600.$s83878; if (!is_dir($f73600)) { if (@mkdir($f73600)) { @chmod($f73600,E2_NEW_FILES_RIGHTS); } else { return false; } } $f73600=$f73600.'/'; } return true; } function a4d36($vd6fe1){ return preg_replace('/\/([^\/]+?)\/\.\./','',$vd6fe1); } function wce9b($ab45cf){ $acee6f=get_html_translation_table(HTML_ENTITIES); $acee6f=array_flip($acee6f); return strtr($ab45cf,$acee6f); } function j7f78($n32c11=NULL){ if(NULL==$n32c11)$n32c11=microtime(); list ($g6021b,$j74459)=explode(' ',$n32c11); return ((float)$g6021b + (float)$j74459); } function f74e0(){ global$settings; if (!isset ($settings))$settings=array(); $rfa816=array(); if(is_file(USER_FOLDER.'settings.json')) { $rfa816=json_decode(file_get_contents(USER_FOLDER.'settings.json'),true); $x098f6=13; } elseif(is_file(USER_FOLDER.'settings.psa')) { $rfa816=unserialize(file_get_contents(USER_FOLDER.'settings.psa')); } if (!is_array($rfa816))$rfa816=array(); $settings=array_merge($settings,$rfa816); if ( !array_key_exists('appearance',$settings) or !array_key_exists('notes_per_page',$settings['appearance']) or !is_numeric($settings['appearance']['notes_per_page']) or $settings['appearance']['notes_per_page'] < 1 ){ $settings['appearance']['notes_per_page']=DEFAULT_ITEMS_PER_PAGE; } if($settings['appearance']['notes_per_page'] > MAX_ITEMS_PER_PAGE){ $settings['appearance']['notes_per_page']=MAX_ITEMS_PER_PAGE; } if ( !array_key_exists('comments',$settings) or !array_key_exists('default_on', @$settings['comments']) ) { $settings['comments']['default_on']=false; } return true; } function e2m_settings(){ global$settings,$_template,$_strings; $yf3e33=array(); $c5e107=DEFAULT_LANGUAGE; if(array_key_exists('language',$settings)) { $c5e107=$settings['language']; } foreach(glob(LANGUAGES_FOLDER. '*.php') as $x435ed){ $m5b54c=substr(basename($x435ed),0,2); $y98bf7=file_get_contents($x435ed); if(preg_match( '/^ *\/\/ *display_name *\= *(.*?) *$/ismu',$y98bf7,$z9c28d )) { $ec2657=$z9c28d[1]; } else { $ec2657=$m5b54c; } $yf3e33[$m5b54c] = array ( 'selected?' => (bool) ($c5e107==$m5b54c), 'display-name' => $ec2657, ); } $z2cb9d['title']=$_strings['pt--settings']; $z2cb9d['heading']=$_strings['pt--settings']; $z2cb9d['form']='form-preferences'; $z2cb9d['form-preferences'] = array ( 'blog-title-default' => htmlspecialchars($_strings['e2--default-blog-title'],ENT_COMPAT,HSC_ENC), 'blog-title' => htmlspecialchars(f6f51(),ENT_COMPAT,HSC_ENC), 'blog-description' => htmlspecialchars(@$settings['description'],ENT_COMPAT,HSC_ENC), 'blog-author-default' => htmlspecialchars($_strings['e2--default-blog-author'],ENT_COMPAT,HSC_ENC), 'blog-author' => htmlspecialchars(@$settings['author'],ENT_COMPAT,HSC_ENC), 'languages' => $yf3e33, 'language' => $c5e107, 'form-action' => d83c8('e2s_settings_save'), 'userpic-href' => m2461('square'), 'notes-per-page' => $settings['appearance']['notes_per_page'], 'email-notify?' => (bool) @$settings['notifications']['new_comments'], 'email' => htmlspecialchars(@$settings['user']['email'],ENT_NOQUOTES,HSC_ENC), 'comments-default-on?' => (bool) @$settings['comments']['default_on'], 'comments-require-gip?' => (bool) @$settings['comments']['require_gip'], 'comments-fresh-only?' => (bool) @$settings['comments']['fresh_only'], 'show-view-counts?' => (bool)$settings['appearance']['show_view_counts'], 'show-sharing-buttons?' => (bool)$settings['appearance']['show_sharing_buttons'], 'includes-google-analytics?' => false, 'includes-yandex-metrika?' => false, 'template-name' => $_template['name'], 'templates' => t94dd(), 'respond-to-dark-mode?' => (bool) @$settings['appearance']['respond_to_dark_mode'], 'submit-text' => $_strings['fb--save-changes'], 'space-usage' => zaf64(pd10e(),true), ); return $z2cb9d; } function e2s_settings_save(){ global$settings,$_strings; if($_SERVER['REQUEST_METHOD']!='POST') return e2_go_to(d83c8('e2m_settings')); $q05df2=$f67daf=''; if(array_key_exists('blog-title',$_POST)) { $q05df2=trim($_POST['blog-title']); } if(array_key_exists('blog-description',$_POST)) { $f67daf=trim($_POST['blog-description']); } if(array_key_exists('blog-author',$_POST)) { $q02bd9=trim($_POST['blog-author']); } if(array_key_exists('language',$_POST)) $w8512a=$_POST['language']; if(array_key_exists('email',$_POST)) $k0c83f=trim($_POST['email']); $b0c2bd=(int)$_POST['notes-per-page']; $settings['site_title']=$q05df2; $settings['site_title']=f6f51(); $settings['description']=$f67daf; $settings['author']=$q02bd9; $settings['user']['email']=$k0c83f; $settings['notifications']['new_comments'] = isset ($_POST['email-notify']); if(array_key_exists('template',$_POST)) { $settings['template']=trim($_POST['template']); } $settings['comments']['default_on'] = isset ($_POST['comments-default-on']); $settings['comments']['require_gip'] = isset ($_POST['comments-require-gip']); $settings['appearance']['show_view_counts'] = isset ($_POST['show-view-counts']); if ( !array_key_exists('language',$settings) or $settings['language']!=$w8512a or $settings['appearance']['notes_per_page']!=$b0c2bd or $settings['appearance']['show_sharing_buttons'] != isset ($_POST['show-sharing-buttons']) or $settings['appearance']['respond_to_dark_mode'] != isset ($_POST['respond-to-dark-mode']) or $settings['comments']['fresh_only'] != isset ($_POST['comments-fresh-only']) ) { @unlink(CACHE_FILENAME_FRONTPAGE); @unlink(CACHE_FILENAME_FRONTPAGE_AUTHOR); $settings['language']=$w8512a; $settings['appearance']['notes_per_page']=$b0c2bd; $settings['appearance']['show_sharing_buttons'] = isset ($_POST['show-sharing-buttons']); $settings['appearance']['respond_to_dark_mode'] = isset ($_POST['respond-to-dark-mode']); $settings['comments']['fresh_only'] = isset ($_POST['comments-fresh-only']); } bc5a6(CACHE_FILENAMES_NOTES_COMMENTS); if (!@n6e52(USER_FOLDER.'settings.json',json_encode($settings,E2_JSON_STYLE))) { x8a40($_strings['er--settings-not-saved'],E2E_PERMISSIONS_ERROR); e2_go_to(d83c8('e2m_settings')); die; } e2_go_to(d83c8('e2m_frontpage', array ('page' => 1))); die; } function e2m_database(){ global$settings,$_strings,$_superconfig; if (@$_superconfig['disallow_db_config']) { return e2_error404_mode(); } $z2cb9d['title']=$_strings['pt--database']; $z2cb9d['heading']=$_strings['pt--database']; $z2cb9d['form']='form-database'; $z2cb9d['form-database'] = array ( 'form-action' => d83c8('e2s_database_save'), 'db-server' => htmlspecialchars(@$settings['db']['server']? $settings['db']['server']:'localhost'), 'db-user' => htmlspecialchars(@$settings['db']['user_name']? $settings['db']['user_name']:'root'), 'db-password' => htmlspecialchars(see85(@$settings['db']['passw'])), 'db-database' => htmlspecialchars(@$settings['db']['name']), 'submit-text' => $_strings['fb--connect-to-this-db'], ); return $z2cb9d; } function e2s_database_save(){ global$settings,$_db,$_superconfig,$_strings,$_config; if($_SERVER['REQUEST_METHOD']!='POST') return e2_go_to(d83c8('e2m_database')); if (@$_superconfig['disallow_db_config']) { return e2_error404_mode(); } $t78940['server'] = @$_POST['db-server']; $t78940['user_name'] = @$_POST['db-user']; $t78940['passw'] = r1305(@$_POST['db-password']); $t78940['name'] = @$_POST['db-database']; $fad3da=false; try { h985b('check database from HTTP post',$t78940); $zaae42=e2_model_data_check($t78940['name']); if (!$zaae42['occupied'] or !$zaae42['migrateable']) { x8a40($_strings['er--db-data-incomplete']); e2_go_to(d83c8('e2m_database')); die; } kbb8d(); $fad3da=true; } catch (AeMySQLCannotConnectException $e){ x8a40( $_strings['er--cannot-connect-to-db']. ':<br />'. mysqli_connect_error() .' ('. mysqli_connect_errno() .')' ); } catch (AeMySQLTooOldException $e){ x8a40(e2l_get_string('er--mysql-version-too-old', [ 'v1' => $_db['version'], 'v2' => E2_MINIMUM_MYSQL, ])); } catch (AeMySQLException $e){ x8a40($_strings['er--cannot-find-db'] .' '. $t78940['name']); } if (!$fad3da){ e2_go_to(d83c8('e2m_database')); die; } $settings['db']=$t78940; if (!@n6e52(USER_FOLDER.'settings.json',json_encode($settings,E2_JSON_STYLE))) { x8a40($_strings['er--settings-not-saved'],E2E_PERMISSIONS_ERROR); e2_go_to(d83c8('e2m_database')); die; } e2_drop_all_kinds_of_cache(); if (!$_config['retain_search_indexes_on_db_switch']) { $jddece=l476c(); try { $jddece -> erase(); } catch (\S2\Rose\Exception\RuntimeException $e){ if(Log::$ped2b5)__log('Rose not available'); } u198f(); } ecc38(d83c8('e2s_bsi_step')); e2_go_to(d83c8('e2m_settings')); die; } function pda67(){ return class_exists('ZipArchive'); } function e2m_get_backup(){ if (pda67()) { $qfbade=new ZipArchive(); $j979eb=BACKUP_FOLDER .'backup.zip'; if ($qfbade -> open($j979eb,ZIPARCHIVE::CREATE)) { @ $qfbade -> addEmptyDir('backup'); @ $qfbade -> addEmptyDir('backup/db'); @ $qfbade -> addFile(USER_FOLDER.'userpic@2x.jpg','backup/files/userpic@2x.jpg'); @ $qfbade -> addFile(USER_FOLDER.'userpic@2x.png','backup/files/userpic@2x.png'); foreach(glob(BACKUP_FOLDER .'backup-*.sql') as $b8c7dd); $qfbade -> addFile($b8c7dd,'backup/db/'. basename($b8c7dd)); $qfbade -> close(); } if(is_file($j979eb)) { header('Content-Type: application/zip'); header('Content-Disposition: attachment; filename="backup.zip"'); readfile($j979eb); unlink($j979eb); } else { die ('Cannot get backup'); } die; } else { die ('Cannot get backup'); } } if(substr(@$_SERVER['HTTP_ACCEPT_LANGUAGE'],0,2)=='ru'){ define('DEFAULT_LANGUAGE','ru'); } else { define('DEFAULT_LANGUAGE','en'); } function e2l_get_string($kfa206,$i8d777){ global$_strings; $sb0689=$_strings[$kfa206]; if(preg_match_all('/\$\[(.+?)\]/u',$sb0689,$z9c28d,PREG_SET_ORDER)) { foreach ($z9c28d as $ze3cc9){ $bb2145=$ze3cc9[1]; $jf2ffc=''; if(strstr($bb2145,'.')) list ($bb2145,$jf2ffc)=explode('.',$bb2145,2); if(array_key_exists($bb2145,$i8d777)) { if ($jf2ffc){ $sb0689=str_replace($ze3cc9[0],e2l__format_value($jf2ffc,$i8d777[$bb2145],$kfa206),$sb0689); } else { $sb0689=str_replace($ze3cc9[0],$i8d777[$bb2145],$sb0689); } } } } return $sb0689; } function e2l__format_value($jf2ffc,$o2063c,$kfa206){ list ($jf2ffc,$q3ad73)=explode('.',$jf2ffc,2); $ve6875='e2lstr_'. $jf2ffc; if(function_exists($ve6875)) { return call_user_func($ve6875,$o2063c,$q3ad73,$kfa206); } else { return $o2063c; } return $o2063c; } function sfc91(){ global$_lang,$settings; if ( array_key_exists('language',$settings) and is_file($f2d354=LANGUAGES_FOLDER.$settings['language'] .'.php') ) { $_lang=$settings['language']; include $f2d354; } elseif(is_file($f2d354=LANGUAGES_FOLDER.DEFAULT_LANGUAGE .'.php')) { $_lang=DEFAULT_LANGUAGE; include $f2d354; } else { die ('Language file missing: '. $f2d354); } return e2l_load_strings(); } define('LOG_FILE',LOG_FOLDER.'main.log'); define('LOG_DEBUG_FILE',LOG_FOLDER.'debug.log'); class Log { public static $ped2b5=false; public static $w34a72=false; } function h372b(){ global$_config; if ( $_config['write_log'] and ($_config['write_log_create'] or is_file(LOG_FILE)) ) { Log::$ped2b5=true; Log::$w34a72=true; } else { Log::$ped2b5=false; Log::$w34a72=false; } if (!Log::$ped2b5) return; @caf42(LOG_FOLDER); if($_config['write_log_reset']) { @file_put_contents(LOG_FILE,''); @chmod(LOG_FILE,E2_NEW_FILES_RIGHTS); } if (@$_config['write_log_limit'] and is_file(LOG_FILE)) { $pbc7b3=@stat(LOG_FILE); $pbc7b3=$pbc7b3['size']; if ($pbc7b3 > $_config['write_log_limit']) { @rename(LOG_FILE,LOG_FILE .'.bak'); @chmod(LOG_FILE .'.bak',E2_NEW_FILES_RIGHTS); @file_put_contents(LOG_FILE,''); } } __log('────────────────────────────────────────────────────────────────────────────────'); } function y714a($d22af6=false) { static $x197b1=false; if ($d22af6===false) return $x197b1; if ($d22af6==='') return $x197b1=false; $x435ed=str_replace( '$',gmdate('Y-m-d-\a\t-H-i-s'),$d22af6 ); return $x197b1= $x435ed; } function __log($l1cb25){ static $a12a05; global$_stopwatch; $rd8367=y714a(); $m605ac=''; $caf240=str_pad(round(j7f78()-$_stopwatch,5),10,' ',STR_PAD_RIGHT); if ($l1cb25[0]=='}'){ -- $a12a05; if ($a12a05 < 0)$a12a05=0; } $g8e13f=( E2_RUN_ID .' '. $m605ac .''. $caf240 .' '. str_repeat(' ',$a12a05*2). $l1cb25."\n" ); if ($l1cb25[strlen($l1cb25)-1]=='{'){ ++ $a12a05; } $u15d61=FILE_APPEND; if(Log::$w34a72){ @file_put_contents(LOG_FILE,$g8e13f,$u15d61); @chmod(LOG_FILE,E2_NEW_FILES_RIGHTS); } if ($rd8367!==false){ $x435ed=LOG_FOLDER.$rd8367 .'.log'; @caf42(LOG_FOLDER); @file_put_contents($x435ed,$g8e13f,$u15d61); @chmod($rd8367,E2_NEW_FILES_RIGHTS); } if ($l1cb25[0]=='#'){ @caf42(dirname(LOG_DEBUG_FILE). '/'); @file_put_contents(LOG_DEBUG_FILE,$g8e13f,$u15d61); @chmod(LOG_DEBUG_FILE,E2_NEW_FILES_RIGHTS); } } function nce80($r6bf76){ @n6e52( USER_FOLDER .'ctree.php', "<?php\r\n\r\n". var_export($r6bf76,true). "\r\n\r\n?>php" ); } function e2s_log(){ @caf42(LOG_FOLDER); @file_put_contents(LOG_FILE,''); @chmod(LOG_FILE,E2_NEW_FILES_RIGHTS); die ('Log file created.'); } function x8a40($f67daf,$type=E2E_STRANGE_ERROR){ global$errors,$settings, $_config, $_strings, $_diagnose; if (!isset ($errors))$errors=[]; $l1897a=(!de852()+1 <= (int)$_config['show_call_stack']); if ($f67daf){ if ($f67daf[0]!='<')$f67daf='<p>'.$f67daf .'</p>'; $ecd1dd=array ( 'description' => $f67daf, 'type' => $type, ); if($type==E2E_STRANGE_ERROR and $l1897a){ $ecd1dd['backtrace']=debug_backtrace(); } $errors[] = $ecd1dd; } if($type==E2E_PERMISSIONS_ERROR){ $_diagnose['need?']=true; kc64a('diagnose','1'); } return true; } function r8739(){ global$errors,$m1c0b7,$_strings,$_diagnose; $c7287a=eea70(); if(count($c7287a)==0){ kc64a('diagnose',''); unset($_COOKIE['diagnose']); $_diagnose['need?']=false; $_diagnose['ok?']=true; return true; } else { $c6e2ba=''; $c6e2ba.='<p>'. $_strings['gs--enable-write-permissions-for-the-following'] .'</p>'; $c6e2ba.='<ul>'; foreach ($c7287a as $a8fa14){ if ($a8fa14=='.')$a8fa14=''; $c6e2ba.='<li><tt>./'. $a8fa14 .'</tt></li>'; if(Log::$ped2b5)__log('Diagnostics: cannot write <'. $a8fa14 .'>'); } $c6e2ba.='</ul>'; $ecd1dd=array ( 'title' => $_strings['et--fix-permissions-on-server'], 'description' => $c6e2ba, 'type' => E2E_DIAGNOSTICS_MESSAGE, 'class' => 'serious', ); $errors[] = $ecd1dd; $_diagnose['ok?']=false; return false; } } function xe1c4($ic1336,$f67daf,$q1407f,$rc2d4b,$t4f62c){ global$errors; if(0==error_reporting() or ($ic1336 & 8)) return; $q1407f=str_replace(__DIR__,'',$q1407f); x8a40($q1407f .', line '. $rc2d4b .'<br />Error '. $ic1336 .': '. $f67daf); $errors[count($errors)-1]['phpcode']=$ic1336; } function y2982($tf6cdd,$z78e73,$b8c7dd,$x6438c){ if (!(error_reporting() & $tf6cdd)) return; throw new ErrorException($z78e73,0,$tf6cdd,$b8c7dd,$x6438c); } function z0955(){ global$errors,$settings,$_config; if (!isset ($errors))$errors=[]; @session_start(); if(is_array(@$_SESSION['errors'])) { $e=array_merge(@$_SESSION['errors'],$errors); } else { $e=$errors; } $l1897a=(!de852()+1 <= (int)$_config['show_call_stack']); if (@$_config['store_backtrace'] and $l1897a and $e!=NULL){ @n6e52('backtrace.psa',serialize($e)); } else { @unlink('backtrace.psa'); } if (isset ($_SESSION['errors'])) unset($_SESSION['errors']); $z2cb9d=array(); $jb8735=false; if(count($e) > 0){ foreach($e as $d865c0 => $p08a44){ if ($p08a44['type']==E2E_STRANGE_ERROR){ $p08a44['class']='serious'; $jb8735=true; if ($l1897a){ $p08a44['backtrace']=s2616($p08a44['backtrace']); } } if ($p08a44['type']==E2E_MESSAGE){ $p08a44['class']='info'; } $e[$d865c0]=$p08a44; } $z2cb9d['each']=$e; if ( $jb8735 and @$_config['store_backtrace'] and $l1897a and is_file('debug.php') ) { $z2cb9d['debug-link']='debug.php'; } } return $z2cb9d; } function q4006(){ $errors=z0955(); foreach($errors['each'] as $tcb5e1){ echo '<p>'. $tcb5e1['description'] .'</p>'; } die; } function s2616($x69206){ global $ja57c1; if (!is_array($x69206)) return 'No backtrace info'; $x69206=array_reverse($x69206); $x69206=array_splice($x69206,0,count($x69206)-1); $e='<p style="background: #fea; padding: .25em .5em; line-height: 1em; overflow: hidden">'; foreach ($x69206 as $d865c0 => $me358e){ $b195df=@$me358e['args'] or $b195df=array(); $ga956a=array(); foreach ($b195df as $v5919c){ $ga956a[] = var_export($v5919c,true); } $b8c7dd=@$me358e['file']; $b8c7dd=str_replace($_SERVER['DOCUMENT_ROOT'],'',$b8c7dd); $x6438c=(@$me358e['line']? (' #'. $me358e['line']) : '?'); $e.='<div style="margin: .25em 0 .5em '. $d865c0*3 .'em">'; $e.='<span style="float: right; color: #666"> '. $b8c7dd.$x6438c .'</span>'; $e.='<tt><b>'. @$me358e['function'] .' (</b>'; if(count($ga956a)) { $ceb84a=str_replace("array (\n)",'array ()',$ga956a); $ceb84a=implode(', ',$ceb84a); if(0){ $ceb84a=highlight_string('<?'. $ceb84a .'?'.'>',true); $ceb84a=substr($ceb84a,77, -28); } $ceb84a=str_replace('&nbsp;',' ',$ceb84a); $ceb84a=nl2br($ceb84a); $e.='<div style="margin: 0 0 0 1.12em">'. $ceb84a .'</div>'; } $e.='<b>)</b> &rarr;</tt></div>'; } $e.='</p>'; return$e; } class AeException extends \Exception {} class AeMySQLException extends AeException {} class AeMySQLNotFoundException extends AeMySQLException {} class AeMySQLTooOldException extends AeMySQLException {} class AeMySQLCannotConnectException extends AeMySQLException {} class AeMySQLAccessDeniedException extends AeMySQLCannotConnectException {} class AeMySQLQueryException extends AeMySQLException {} class AeMySQLCorruptedUpdateRecordCallException extends AeMySQLException {} class AeInstallException extends AeException {} class AeInstallAlreadyInstalledException extends AeInstallException {} class AeInstallDatabaseOccupiedException extends AeInstallException {} class AeNotSavedException extends AeException {} class AePasswordHashNotSavedException extends AeNotSavedException {} class AeSettingsNotSavedException extends AeNotSavedException {} class AeModelUnknownTableException extends AeException {} class AeOlbaException extends AeException {} class AeOlbaTemplateMissingException extends AeOlbaException {} class AeNotAndCannotBeInstalledException extends AeException {} function zd0c8($i42552,$o44fb5=false){ $a5ee24=substr(__DIR__,0,strrpos(__DIR__,'/')); $d70261=''; $n04a75=[]; foreach(array_reverse($i42552 -> getTrace()) as $h447b7){ $zb25b3['where']=str_replace( $a5ee24 .'/','',$h447b7['file'] ) .':'. $h447b7['line']; $t97346=[]; foreach ($h447b7['args'] as $e61dd8){ $t97346[] = htmlspecialchars( str_replace("\n","\n  ",var_export($e61dd8,true)), ENT_NOQUOTES,HSC_ENC ); } $t5eaa0=''; if(count($t97346)) { $t5eaa0=("\n". '  '. implode(",\n  ",$t97346). "\n" ); } $zb25b3['call']=$h447b7['function'] .' ('. $t5eaa0 .')'; $n04a75[] = $zb25b3; } if ((string)$i42552 -> getMessage()!==''){ $d70261.=$i42552 -> getMessage() ."\n"; } $d70261.="\n";; $d70261 .= ( get_class($i42552) .' in '. str_replace( $a5ee24 .'/','',$i42552 -> getFile() ) .':'. $i42552 -> getLine(). "\n" ); if ($i42552 -> getCode()) { $d70261.='Code: '. $i42552 -> getCode() ."\n"; } $x98594=''; $d865c0=1; foreach ($n04a75 as $x6438c){ $x98594.=$d865c0++ .'. '. $x6438c['where'] .' '. $x6438c['call']. "\n"; if (!$o44fb5)$x98594.="\n";; } $d70261.="\n";; if ($o44fb5){ $x98594=preg_replace('/^.*?$/smu','│            $0',$x98594); $d70261.='┌─'. "\n"; $d70261.=$x98594; $d70261.='└─'; } else { $d70261.=$x98594; } return $d70261; } function e12f6($i42552,$z78e73=''){ global$_config; if(__DEV)x8a40('<pre>'. zd0c8($i42552) .'</pre>'); if($_config['log_errors']) { Log::$ped2b5=true; if(Log::$ped2b5)y714a('error-$'); } if(Log::$ped2b5)__log('Exception caught: '. zd0c8($i42552,true)); if(Log::$ped2b5)y714a(''); if ((string)$z78e73!==''){ if(Log::$ped2b5)__log($z78e73); } } function y4aff($i42552){ global$_config,$content,$ja57c1; $content['title']=':-('; if(__DEV)$content['exception-string']=zd0c8($i42552); if($_config['log_errors']) { Log::$ped2b5=true; if(Log::$ped2b5)y714a('error-$'); } if(Log::$ped2b5)__log('Panic: '. zd0c8($i42552,true)); $z2cb9d=k166b('panic',true); if(Log::$ped2b5)__log(':-('); echo $z2cb9d; die; } function saefe($i42552){ y4aff($i42552); } $_url_map=array ( '@build' => 'e2://e2s_build', '@sync' => 'e2://e2s_sync', '@log' => 'e2://e2s_log', '@dump' => 'e2://e2s_dump', '@bsi' => 'e2://e2s_bsi_status', '@bsi/drop' => 'e2://e2s_bsi_drop', '@bsi/step' => 'e2://e2s_bsi_step', '@migrate' => 'e2://e2s_migrate', '@retrieve:url' => 'e2://e2s_retrieve', '@instantiate:version' => 'e2://e2s_instantiate', '@notify' => 'e2://e2s_notify', '@info' => 'e2://e2m_info', '@ajax/::' => 'e2://e2j_::', '@actions/::' => 'e2://e2s_::', '' => 'e2://e2m_frontpage?page=1', ':page' => 'e2://e2m_frontpage', 'rss' => 'e2://e2m_rss', 'json' => 'e2://e2m_json', 'sitemap.xml' => 'e2://e2m_sitemap_xml', ':year' => 'e2://e2m_year', ':year/:month' => 'e2://e2m_month', ':year/:month/:day' => 'e2://e2m_day', 'all' => 'e2://e2m_everything', ':note' => 'e2://e2m_note', ':note/edit' => 'e2://e2m_note_edit?is_published=1', ':note/favourite' => 'e2://e2m_note_flag_favourite?is_published=1&value=1', ':note/unfavourite' => 'e2://e2m_note_flag_favourite?is_published=1&value=0', ':note/show' => 'e2://e2m_note_flag?is_published=1&flag=IsVisible&value=1', ':note/hide' => 'e2://e2m_note_flag?is_published=1&flag=IsVisible&value=0', ':note/discuss' => 'e2://e2m_note_flag?is_published=1&flag=IsCommentable&value=1', ':note/quiet' => 'e2://e2m_note_flag?is_published=1&flag=IsCommentable&value=0', ':note/withdraw' => 'e2://e2m_note_withdraw?is_published=1', ':note/json' => 'e2://e2m_note_json', ':note/broadcast' => 'e2://e2m_note_broadcast', ':note/read' => 'e2://e2m_note_read', ':note/delete' => 'e2://e2m_note_delete?is_published=1', ':note/format/:formatter' => 'e2://e2m_note_use_formatter?is_published=1', ':note/:unsubscr' => 'e2://e2m_unsubscribe?is_published=1', ':note/:comnum' => 'e2://e2m_comment', ':note/:comnum/edit' => 'e2://e2m_comment_edit', ':note/:comnum/important' => 'e2://e2m_comment_flag_ajax?flag=IsFavourite&value=1', ':note/:comnum/usual' => 'e2://e2m_comment_flag_ajax?flag=IsFavourite&value=0', ':note/:comnum/replace' => 'e2://e2m_comment_flag_ajax?flag=IsVisible&value=1', ':note/:comnum/remove' => 'e2://e2m_comment_flag_ajax?flag=IsVisible&value=0', ':note/:comnum/spam' => 'e2://e2m_comment_flag?flag=IsSpamSuspect&value=1', ':note/:comnum/good' => 'e2://e2m_comment_flag?flag=IsSpamSuspect&value=0', ':note/:comnum/wipe' => 'e2://e2m_comment_delete', ':note/:comnum/reply/edit' => 'e2://e2m_comment_reply', ':note/:comnum/reply/important' => 'e2://e2m_comment_flag_ajax?flag=IsReplyFavourite&value=1', ':note/:comnum/reply/usual' => 'e2://e2m_comment_flag_ajax?flag=IsReplyFavourite&value=0', ':note/:comnum/reply/replace' => 'e2://e2m_comment_flag_ajax?flag=IsReplyVisible&value=1', ':note/:comnum/reply/remove' => 'e2://e2m_comment_flag_ajax?flag=IsReplyVisible&value=0', ':note/:comnum/reply/delete' => 'e2://e2m_comment_reply_delete', 'drafts' => 'e2://e2m_drafts', 'drafts/:draft' => 'e2://e2m_draft', 'drafts/:draft/edit' => 'e2://e2m_note_edit?is_published=0', 'drafts/:draft/show' => 'e2://e2m_note_flag?is_published=0&flag=IsVisible&value=1', 'drafts/:draft/hide' => 'e2://e2m_note_flag?is_published=0&flag=IsVisible&value=0', 'drafts/:draft/delete' => 'e2://e2m_note_delete?is_published=0', 'drafts/:draft/format/:formatter' => 'e2://e2m_note_use_formatter?is_published=0', 'drafts/:draft/:preview' => 'e2://e2m_draft_preview', 'sources' => 'e2://e2m_sources', 'sources/:source/trust' => 'e2://e2m_source_trust', 'sources/:source/premoderate' => 'e2://e2m_source_premoderate', 'sources/:source/ban' => 'e2://e2m_source_ban', 'sources/:source/forget' => 'e2://e2m_source_forget', 'tags' => 'e2://e2m_tags', 'tags/:tag' => 'e2://e2m_tag?page=1', 'tags/:tag/:page' => 'e2://e2m_tag', 'tags/:tag/rss' => 'e2://e2m_tag_rss', 'tags/:tag/json' => 'e2://e2m_tag_json', 'tags/:tag/edit' => 'e2://e2m_tag_edit', 'tags/:tag/delete' => 'e2://e2m_tag_delete', 'tags/:tag/pin' => 'e2://e2m_tag_flag_ajax?flag=IsFavourite&value=1', 'tags/:tag/unpin' => 'e2://e2m_tag_flag_ajax?flag=IsFavourite&value=0', 'untagged' => 'e2://e2m_untagged', 'hot' => 'e2://e2m_most_commented', 'selected' => 'e2://e2m_favourites?page=1', 'selected/:page' => 'e2://e2m_favourites', 'found' => 'e2://e2m_found&query=', 'found/:query' => 'e2://e2m_found', 'new' => 'e2://e2m_write', 'install' => 'e2://e2m_install', 'settings' => 'e2://e2m_settings', 'settings/name' => 'e2://e2m_name_and_author', 'settings/database' => 'e2://e2m_database', 'settings/password' => 'e2://e2m_password?recovery-key=', 'settings/password-reset' => 'e2://e2m_password_reset', 'settings/password/:reset' => 'e2://e2m_password', 'settings/timezone' => 'e2://e2m_timezone', 'settings/sessions' => 'e2://e2m_sessions', 'settings/theme-preview' => 'e2://e2m_theme_preview?theme=', 'settings/theme-preview/:theme' => 'e2://e2m_theme_preview', 'settings/get-backup' => 'e2://e2m_get_backup', 'sign-in' => 'e2://e2m_sign_in', 'sign-out' => 'e2://e2m_sign_out', 'sign-in/:provider' => 'e2://e2m_gip_sign_in', 'sign-out/:provider' => 'e2://e2m_gip_sign_out', 'sign-in-done/:provider' => 'e2://e2m_gip_sign_in_callback', ); $_url_chunks=array ( '\:page' => 'page\-(?P<page>\d+)', '\:year' => '(?P<year>\d{4})', '\:month' => '(?P<month>\d{1,2})', '\:day' => '(?P<day>\d{1,2})', '\:note' => array ( 'all\/(?P<alias>[-a-zA-Z0-9]+)', '(?P<year>\d{4})\/(?P<month>\d{1,2})\/(?P<day>\d{1,2})\/(?P<day_number>\d+)', ), '\:draft' => array ( '(?P<oalias2>[-a-zA-Z0-9]+)\/(?P<draft2>\d+)', '(?P<oalias>[-a-zA-Z0-9]+)', '-\/(?P<draft>\d+)', ), '\:comnum' => 'comment\-(?P<comment_number>[0-9]+)', '\:file' => '(?P<file>.*?)', '\:tag' => '(?P<tag_alias>[-a-zA-Z0-9]+)', '\:query' => '(?P<query>.*?)', '\:provider' => '(?P<provider>.*?)', '\:version' => '\:(?P<version>\d+)', '\:source' => '\:(?P<source>.*?)', '\:picture' => '\:(?P<picture>.*?)', '\:unsubscr' => 'unsubscribe\:(?P<unsubscribe_email>.+?)\:(?P<unsubscribe_key>[0-9a-f]{32})', '\:reset' => 'reset\:(?P<recovery_key>[0-9a-f]{40})', '\:formatter' => '(?P<formatter>.*?)', '\:alias' => '(?P<newalias>[-a-zA-Z0-9]+)', '\:preview' => 'preview\:(?P<preview_key>[0-9a-f]{32})', '\:theme' => '(?P<theme>[-a-zA-Z0-9]+)', '\:source' => '(?P<source>\d+)', '\:url' => '\:(?P<url>[a-zA-Z0-9]+\=)', ); $_url_autoredirects=array ( '/^favo(?:u?)rites(\~.+)?$/i' => 'selected\\1', '/^favo(?:u?)rites\/(.+)/i' => 'selected/\\1', '/^keywords$/i' => 'tags', '/^keywords\/(.*)/i' => 'tags/\\1', '/^everything$/i' => 'all', '/^search\/(.+)/i' => 'found/\\1', '/^(\d{4}\/\d{1,2}\/\d{1,2}\/\d+)\/comments(\/?)$/i' => '\\1', '/^\~(\d+)/i' => 'page-\\1', '/\/?\~(\d+)/i' => '/page-\\1', ); function wb6b0($y572d4){ global$_url_autoredirects,$ja57c1; $y572d4=preg_replace(array_keys($_url_autoredirects),array_values($_url_autoredirects),$y572d4); if(preg_match('/^([0-9]+)[.-]([0-9]+)[.-]([0-9]+)(.*)/',$y572d4,$z9c28d)) { if(2==strlen($z9c28d[3]))$z9c28d[3]='20'.$z9c28d[3]; return ($z9c28d[3].'/'.$z9c28d[2].'/'.$z9c28d[1].$z9c28d[4]); } if(preg_match('/^tags\-rss\/(.*?)\/?$/',$y572d4,$z9c28d)) { $ce4d23=substr($z9c28d[1],strrpos($z9c28d[1],'/')+1); return ('tags/'. $ce4d23.'/rss/'); } return $y572d4; } function y7059(){ static $i6b2de=false; global$__synthetic_urls,$_config,$_superconfig; if ($i6b2de) return; $ad0e31=$_config['url_composition']; if (!empty ($_superconfig) and array_key_exists('url_composition',$_superconfig)) { $ad0e31=$_superconfig['url_composition']; } $__synthetic_urls=false; if ($ad0e31=='synthetic'){ $__synthetic_urls=true; } if ($ad0e31=='auto'){ if(function_exists('apache_get_modules')) { if(in_array('mod_rewrite',apache_get_modules())) { $__synthetic_urls=true; } } } $i6b2de=true; } function d83c8($qc48ba,$parameters=array ()) { global$_url_map,$_url_chunks,$_config,$__synthetic_urls,$_protocol,$o57de2,$ja57c1; $yc2bd7=array_flip($_url_map); if ( @$_config['preferred_domain_name'] and $_SERVER['HTTP_HOST']!=$_config['preferred_domain_name'] ) { $o57de2=$_config['preferred_domain_name']; } $y572d4=$_protocol .'://'. $o57de2.$ja57c1 .'/'; $k9c464='e2://'. $qc48ba; if(array_key_exists('page',$parameters)) { $b71860=$parameters['page']; } else { $b71860=1; } if($parameters){ $k9c464.='?'; $a1c61f=array(); $l21711=array(); foreach($parameters as $f3c6e0 => $o2063c){ if ($f3c6e0=='*note'){ $l21711[] = $f3c6e0; $a1c61f[] = e2urls__expand_tricky_parameters_for_note_($o2063c); } if ($f3c6e0=='*tags'){ $l21711[] = $f3c6e0; $a1c61f[] = e2urls__expand_tricky_parameters_for_tags_($o2063c); } if ($f3c6e0=='*tag'){ $l21711[] = $f3c6e0; $a1c61f[] = e2urls__expand_tricky_parameters_for_tags_(array ($o2063c)); } } foreach ($l21711 as $f3c6e0) unset($parameters[$f3c6e0]); foreach ($a1c61f as $u58e2a){ $parameters=array_merge($parameters,$u58e2a); } foreach($parameters as $f3c6e0 => $o2063c){ if (@$f3c6e0[0]!='_'){ $k9c464.=$f3c6e0 .'='. urlencode($o2063c) .'&'; } } $k9c464=substr($k9c464,0, -1); } if ($qc48ba=='e2m_draft' and $parameters['is-published']===1)$qc48ba='e2m_note'; if ($qc48ba=='e2m_note' and $parameters['is-published']===0)$qc48ba='e2m_draft'; if(array_key_exists($k9c464,$yc2bd7)) { if ($yc2bd7[$k9c464]!=='')$y572d4.=$yc2bd7[$k9c464] .'/'; return $y572d4; } else { $z44907=false; foreach ($yc2bd7 as $b45ea8 => $o9ea44){ $pb7365=$b45ea8; $pb7365=preg_quote($pb7365,'/'); $ved015=parse_url($b45ea8); $h2f532=$ved015['host']; $xebe09=parse_url($k9c464); if(strstr($b45ea8,'::')) { $jffd6b=$xebe09['scheme'] .'://'. $xebe09['host']; $pb7365=str_replace('\:\:','(.*)',$pb7365); $pb7365='/^'. $pb7365 .'$/s'; if(preg_match($pb7365,$jffd6b,$z9c28d)) { $vd6fe1=str_replace('::',$z9c28d[1],$o9ea44); $vd6fe1=str_replace('_','-',$vd6fe1); $w1b1cc=$xebe09['query']; if($__synthetic_urls and $w1b1cc){ $y572d4.=$vd6fe1 .'/?'. $w1b1cc; } elseif($__synthetic_urls){ $y572d4.=$vd6fe1 .'/'; } elseif ($w1b1cc){ $y572d4.='?go='. $vd6fe1 .'/?'. $w1b1cc; } else { $y572d4.='?go='. $vd6fe1 .'/'; } return $y572d4; } } $l54435=false; if ($qc48ba===$h2f532){ $z44907=true; if ($ved015['query']) { $a22c38=explode('&',$ved015['query']); foreach ($a22c38 as $a8822b){ list ($f3c6e0,$o2063c)=explode('=',$a8822b); $o2063c=urldecode($o2063c); $f3c6e0=str_replace('_','-',$f3c6e0); if ( array_key_exists($f3c6e0,$parameters) and $parameters[$f3c6e0]!=$o2063c ){ $l54435=true; break; } } } if (!$l54435){ if(preg_match_all('/\:[\-a-z]+/i',$o9ea44,$z9c28d)) { foreach ($z9c28d[0] as $bfc413){ $jb0f75=$_url_chunks['\\'. $bfc413]; if (!is_array($jb0f75)) { $jb0f75=array ($jb0f75); } $g05f62=$jb0f75[0]; foreach ($jb0f75 as $g05f62){ $leab03='/\(\?P\<(.*?)\>.*?\)/'; $c4274e=true; if (@preg_match_all($leab03,$g05f62,$z9c28d)) { $z9c28d=$z9c28d[1]; $c4274e=true; for ($d865c0=0; $d865c0 < count($z9c28d); ++ $d865c0){ if ( !array_key_exists(str_replace("_","-",$z9c28d[$d865c0]), $parameters) or $parameters[str_replace("_","-",$z9c28d[$d865c0])] === '' ){ $c4274e=false; break; } } } if (!$c4274e) continue; $ff9e1e=@preg_replace_callback( $leab03, function ($z9c28d) use ($parameters){ return$parameters[str_replace("_","-",$z9c28d[1])]; }, $g05f62 ); $ff9e1e=stripslashes($ff9e1e); $oc5d91=str_replace($bfc413,$ff9e1e,$o9ea44); break; } $o9ea44=$oc5d91; } } $m15214=array(); if ($o9ea44){ if($__synthetic_urls){ $y572d4.=$o9ea44 .'/'; } else { $m15214[] = 'go='. $o9ea44 .'/'; } } foreach($_GET as $o8ce4b => $l9e366) if(in_array($o8ce4b, array ('result','themeless'))) { $m15214[] = $o8ce4b . ($l9e366? ('='. urlencode($l9e366)) : ''); } if(count($m15214)) { $y572d4.='?'. implode('&',$m15214); } return $y572d4; } } } if ($z44907){ return $y572d4; } else { die ('Cannot compose url for candy '. $qc48ba); } } } function qb7e9($y572d4=null){ global$_url_map,$_url_chunks,$_config,$_current_url,$__synthetic_urls,$_protocol,$o57de2,$ja57c1; if ($y572d4===null) $y572d4=urldecode($_GET['go']); if(Log::$ped2b5)__log('Resolve "'. $y572d4 .'"'); y7059(); $m196c2=$y572d4; $y572d4=trim($y572d4,'/'); $y572d4=wb6b0($y572d4); $parameters=array(); foreach($_url_map as $p12a24 => $b45ea8){ $hd532d=$p12a24; $hd532d=preg_quote($hd532d,'/'); if(strstr($p12a24,'::')) { $hd532d=str_replace('\:\:','(.*)',$hd532d); $hd532d='/^'. $hd532d .'$/s'; if(preg_match($hd532d,$y572d4,$z9c28d)) { $p53b9e=str_replace('-','_',$z9c28d[1]); $k9c464=str_replace('::',$p53b9e,$b45ea8); } } elseif(strstr($p12a24,':')) { $g1e380=array(); foreach($_url_chunks as $o8ce4b => $l9e366){ if(is_array($l9e366)) { $g1e380[$o8ce4b]='(?:(?:'. implode(')|(?:',$l9e366) .'))'; } else { $g1e380[$o8ce4b]=$l9e366; } } $hd532d=str_replace( array_keys($g1e380), array_values($g1e380), $hd532d ); $hd532d='/^'. $hd532d .'$/s'; if(preg_match($hd532d,$y572d4,$z9c28d)) { $k9c464=$b45ea8; foreach ($z9c28d as $f3c6e0 => $o2063c) if (!is_numeric($f3c6e0)) { $f3c6e0=str_replace('_','-',$f3c6e0); $parameters[$f3c6e0]=$o2063c; } } } else { if ($p12a24==$y572d4){ $k9c464=$b45ea8; break; } } } $afafdd=(bool)$k9c464; if (!$k9c464)$k9c464='e2://e2_error404_mode'; $xebe09=parse_url($k9c464); $qc48ba=$xebe09['host']; if ($xebe09['query']) { $a22c38=explode('&',$xebe09['query']); foreach ($a22c38 as $a8822b){ list ($f3c6e0,$o2063c)=explode('=',$a8822b); $o2063c=urldecode($o2063c); $f3c6e0=str_replace('_','-',$f3c6e0); $parameters[$f3c6e0]=$o2063c; } } $z2cb9d=false; $parameters=e2urls__consolidate_tricky_parameters_($parameters); if ($afafdd){ if($_config['force_canonical_urls']) { foreach (['draft2','oalias2'] as $rf4975){ if(array_key_exists($rf4975,$parameters)) { unset($parameters[$rf4975]); } } $s95d32=d83c8($qc48ba,$parameters); list ($ra4c3a,$bab96c)=explode('?',$_SERVER['REQUEST_URI'],2); $ba37bf=$_protocol .'://'.$_SERVER['HTTP_HOST'].$ra4c3a; $l5d6ba=$_protocol .'://'.$_SERVER['HTTP_HOST'].urldecode($ra4c3a); $bab96c=explode('&',$bab96c); foreach ($bab96c as $e6c0d0){ list ($u5c5e7, ) = explode('=',$e6c0d0); if ($u5c5e7=='go'){ $ba37bf.='?'. $e6c0d0; $l5d6ba.='?'. urldecode($e6c0d0); } } $_current_url=$ba37bf; if ($ba37bf!=$s95d32 and $l5d6ba!=$s95d32){ e2_go_to($s95d32); } } if(is_callable($qc48ba)) { $z2cb9d=array ($qc48ba,$parameters); } else { $z2cb9d=array (null, array ()); } } else { $z2cb9d=array (null, array ()); } foreach($_GET as $f3c6e0 => $o2063c){ if ($f3c6e0!=='go')$z2cb9d[1][$f3c6e0]=$o2063c; } if(Log::$ped2b5){ if(count($z2cb9d[1]) > 0){ $ff8cea=print_r($z2cb9d[1],true); $ff8cea=substr($ff8cea,8, -2); $ff8cea='    '. trim($ff8cea); $ff8cea=preg_replace('/^.*?$/smu','         $0',$ff8cea); $ff8cea=' with parameters:'."\r\n". $ff8cea; } __log( 'Resolved to candy "'. $z2cb9d[0] .'"'. $ff8cea ); } return $z2cb9d; } function e2urls__expand_tricky_parameters_for_note_($d39a37){ global $ja57c1,$_config,$_e2_day_numbers_by_note_id; if (!isset ($d39a37['IsPublished'])) { return array (); } if (!$d39a37['IsPublished']) { if ($d39a37['OriginalAlias']===''){ $parameters['draft']=$d39a37['ID']; } elseif(e2_draft_alias_use_count($d39a37['OriginalAlias']) == 1){ $parameters['oalias']=$d39a37['OriginalAlias']; } else { $parameters['draft2']=$d39a37['ID']; $parameters['oalias2']=$d39a37['OriginalAlias']; } $parameters['is-published']=0; return$parameters; } $parameters['is-published']=1; $sb80bb=$d39a37['ID']; $w96b8c=$d39a37['Stamp']; $xb2c6c=e0923($d39a37); if (!isset ($d39a37['__noalias!'])) { if (isset ($d39a37['alias'])) { $parameters['alias']=$d39a37['alias']; } else { $parameters['alias']=e2_active_alias_for_page_(ENTITY_TYPE_NOTE,$d39a37['ID']); if($parameters['alias']=='') unset($parameters['alias']); } } if(array_key_exists('alias',$parameters)) return$parameters; list ($q41529,$s6f8f5,$q8277e)=explode('/', e5a2f('Y/m/d',$w96b8c,$xb2c6c) ); $parameters['year']=$q41529; $parameters['month']=$s6f8f5; $parameters['day']=$q8277e; if (isset ($d39a37['day_number'])) { $parameters['day-number']=$d39a37['day_number']; } elseif (isset ($_e2_day_numbers_by_note_id[$d39a37['ID']])) { $parameters['day-number']=$_e2_day_numbers_by_note_id[$d39a37['ID']]; } else { list ($id9d0f, ) = f5273($q41529,$s6f8f5,$q8277e); p0738( "SELECT `ID`, `Stamp`, `Offset`, `IsDST` ". "FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished` = 1 AND (`Stamp` BETWEEN " .$id9d0f. " AND " .$w96b8c. ") ". "ORDER BY `Stamp`", 'get all notes that could be on this date even in different timezones for legacy url resolution' ); $result=g0d6b(); $bb1bc2=1; foreach($result as $c65afd){ if ( $q41529.'/'.$s6f8f5.'/'.$q8277e == e5a2f('Y/m/d',$c65afd['Stamp'],e0923($c65afd)) ) { if ($c65afd['ID']==$sb80bb){ $j444bc=1; break; } $bb1bc2 ++; } } if (@$j444bc!=1){ header('HTTP/1.1 503 Service Unavailable'); die ('Candidates enumeration failed.'); } $parameters['day-number']=$bb1bc2; $_e2_day_numbers_by_note_id[$d39a37['ID']] = $bb1bc2; } return$parameters; } function e2urls__expand_tricky_parameters_for_tags_($k0dff3){ $p9299d=array(); $parameters=array(); foreach ($k0dff3 as $pb19ad){ $c72487=''; if (!isset ($pb19ad['__noalias!'])) { if (isset ($pb19ad['tag-alias'])) { $c72487=$pb19ad['tag-alias']; } else { $c72487=e2_active_alias_for_page_(ENTITY_TYPE_TAG,$pb19ad['ID']); } } $p9299d[] = $c72487? $c72487:$pb19ad['OriginalAlias']; } if(count($k0dff3)) { $parameters['tag-alias']=implode(',',$p9299d); } return$parameters; } function e2urls__consolidate_tricky_parameters_($parameters){ if ( (string) @$parameters['alias']!=='' or ( (string) @$parameters['year']!=='' and (string) @$parameters['month']!=='' and (string) @$parameters['day']!=='' and (string) @$parameters['day-number']!=='' ) ) { if ($taad65=e2_published_noterec_with_parameters_($parameters)) { $parameters['*note']=$taad65; } } if ( (string) @$parameters['oalias']!=='' or (string) @$parameters['draft']!=='' or (string) @$parameters['oalias2']!=='' or (string) @$parameters['draft2']!=='' ){ if ($taad65=e2_noterec_with_parameters_($parameters)) { $parameters['*note']=$taad65; } } if ( (string) @$parameters['tag-alias']!=='' ){ $parameters['*tags']=e2_tagrecs_with_parameters_($parameters); if(count($parameters['*tags']) == 1){ $parameters['*tag']=$parameters['*tags'][0]; } } return$parameters; } function p3aa5($e9dd4e){ global$_e2utf8__unformat_htmlentity_neasden; if($_e2utf8__unformat_htmlentity_neasden){ return $e9dd4e; } else { return '((html '. $e9dd4e .'))'; } } function pedd9($re98a6,$f98df3=false){ $l80a41=''; $mf5a8e=strlen($re98a6); for ($d865c0=0; $d865c0 < 256; ++ $d865c0){ $nf3d13[$d865c0]=0; $m0fc3c=$d865c0; while ($m0fc3c & 0x00000080){ $m0fc3c <<= 1; ++ $nf3d13[$d865c0]; } } for ($d865c0=0xd090; $d865c0 <= 0xd0bf; $d865c0++)$q84a26[$d865c0]=chr(($d865c0 & 0x000000ff)+48); for ($d865c0=0xd180; $d865c0 <= 0xd18f; $d865c0++)$q84a26[$d865c0]=chr(($d865c0 & 0x000000ff)+112); $q84a26[0xd081]="\xa8"; $q84a26[0xd191]="\xb8"; $q84a26[0xc299]="\x99"; $q84a26[0xc2a9]="\xa9"; $q84a26[0xc2ae]="\xae"; $q84a26[0xc2ab]="\xab"; $q84a26[0xc2bb]="\xbb"; $q84a26[0xc2a0]="\xa0"; $d865c0=0; while ($d865c0 < $mf5a8e){ $wac558=$re98a6[$d865c0]; $qc267c=ord($wac558); if ($nf3d13[$qc267c]==0){ $l80a41.=$wac558; ++ $d865c0; } elseif ($nf3d13[$qc267c]==2){ $l06214=$q84a26[($qc267c << 8) | ord($re98a6[$d865c0+1])]; $l80a41 .= ($l06214!=null)? $l06214 : ( $f98df3? (p3aa5( hebe5(substr($re98a6,$d865c0,2)) )) : '?' ); $d865c0+=2; } else { $cdfbc9=substr($re98a6,$d865c0,$nf3d13[$qc267c]); if ($cdfbc9=="\xe2\x84\x96")$l80a41.="\xb9"; elseif ($cdfbc9=="\xe2\x80\x93")$l80a41.="\x96"; elseif ($cdfbc9=="\xe2\x80\x94")$l80a41.="\x97"; elseif ($cdfbc9=="\xe2\x80\x98")$l80a41.="\x91"; elseif ($cdfbc9=="\xe2\x80\x99")$l80a41.="\x92"; elseif ($cdfbc9=="\xe2\x80\x9a")$l80a41.="\x82"; elseif ($cdfbc9=="\xe2\x80\x9c")$l80a41.="\x93"; elseif ($cdfbc9=="\xe2\x80\x9d")$l80a41.="\x94"; elseif ($cdfbc9=="\xe2\x80\x9e")$l80a41.="\x84"; elseif ($cdfbc9=="\xe2\x80\xa6")$l80a41.="\x85"; elseif ($cdfbc9=="\xe2\x80\xb9")$l80a41.="\x8b"; elseif ($cdfbc9=="\xe2\x80\xba")$l80a41.="\x9b"; elseif ($cdfbc9=="\xe2\x82\xac")$l80a41.="\x88"; elseif ($cdfbc9=="\xe2\x84\xa2")$l80a41.="\x99"; else $l80a41.=$f98df3? (p3aa5( hebe5($cdfbc9) )) : '?'; $d865c0+=$nf3d13[$qc267c]; } } return $l80a41; } function hebe5($f4a8a0){ $occ411=''; $mf5a8e=strlen($f4a8a0); for ($d865c0=0; $d865c0 < $mf5a8e; ++ $d865c0){ $occ411.=preg_replace('/^1*0/','',decbin(ord($f4a8a0[$d865c0]))); } return '&#'. bindec($occ411) .';'; } function ufd97($t341be) { $z2cb9d=$t341be; $z2cb9d=preg_replace_callback('/([\x80-\xFF])/','e2_utf_from_windows_1251_char',$z2cb9d); return $z2cb9d; } function e2_utf_from_windows_1251_char($f4a8a0){ list (, $f4a8a0)=$f4a8a0; if ($f4a8a0=="\xa8") return "\xd0\x81"; if ($f4a8a0=="\xb8") return "\xd1\x91"; if ($f4a8a0 >= "\xc0" && $f4a8a0 <= "\xef") return "\xd0".chr(ord($f4a8a0)-48); if ($f4a8a0 >= "\xf0") return "\xd1".chr(ord($f4a8a0)-112); if ($f4a8a0=="\x85") return "\xe2\x80\xa6"; if ($f4a8a0=="\x96") return "\xe2\x80\x93"; if ($f4a8a0=="\x97") return "\xe2\x80\x94"; if ($f4a8a0=="\xab") return "\xc2\xab"; if ($f4a8a0=="\xbb") return "\xc2\xbb"; if ($f4a8a0=="\x91") return "\xe2\x80\x98"; if ($f4a8a0=="\x92") return "\xe2\x80\x99"; if ($f4a8a0=="\x93") return "\xe2\x80\x9c"; if ($f4a8a0=="\x94") return "\xe2\x80\x9d"; if ($f4a8a0=="\x84") return "\xe2\x80\x9e"; if ($f4a8a0=="\x99") return "\xe2\x84\xa2"; if ($f4a8a0=="\xb9") return "\xe2\x84\x96"; if ($f4a8a0=="\xa0") return "\xc2\xa0"; return '?'; }; function e2_utf8_version_of_array_($tf1f71){ foreach ($tf1f71 as $o8ce4b => $l9e366){ if (!array_key_exists($o8ce4b.'.u?',$tf1f71)) { if(is_string($tf1f71[$o8ce4b])) { $tf1f71[$o8ce4b]=ufd97($tf1f71[$o8ce4b]); } elseif(is_array($tf1f71[$o8ce4b])) { $tf1f71[$o8ce4b]=e2_utf8_version_of_array_($tf1f71[$o8ce4b]); } } } return $tf1f71; } function r869e($s6f8f5){ return mb_convert_encoding($s6f8f5[0],'HTML-ENTITIES','UTF-8'); } function gff7c($t341be,$c22019=false){ if ($c22019){ return preg_replace_callback( '/[\x{10000}-\x{fffff}]/u','e2_question_long_utf8_chars_helper',$t341be ); } else { return preg_replace('/[\x{10000}-\x{fffff}]/u','?',$t341be); } } function e2img_filename_by_processing( $sfce75,$e1c925, $a26635,$ecff96,$vd6663 ){ global$_config; if(Log::$ped2b5)__log('Process image: "'. $sfce75 .'" -> "'. $e1c925 .'"'); if (!is_file($sfce75)) return false; $k9c26d=stat($sfce75)['size']; if (!zb6c5($sfce75)) { if(Log::$ped2b5)__log('Process image: SVG, no processing'); return $sfce75; } if(is_file($e1c925) and !i4f9d($sfce75,$e1c925)) { if(Log::$ped2b5)__log('Process image: Already exists'); return $e1c925; } if (!extension_loaded('gd')) return false; $n7ae08=pathinfo($e1c925); if (!@caf42($n7ae08['dirname'])) { if(Log::$ped2b5)__log( 'Process image: Can’t create directory <'. $n7ae08['dirname'] .'>' ); return false; } if(Log::$ped2b5)__log('Process image: Detecting image type'); $type=e2img__type_of_file($sfce75); if (!$type) return false; $x94ba2='imagecreatefrom'. $type; if (!function_exists($x94ba2)) return false; if(Log::$ped2b5)__log('Process image: Opening original image ('. $x94ba2 .')'); $c1ccee=call_user_func($x94ba2,$sfce75); if (!$c1ccee) return false; if ($e89918=e2img__orientation_of_file($sfce75)) { if(Log::$ped2b5)__log('Process image: Needs orientation fix'); $c1ccee=e2img__res_rotate($c1ccee, -$e89918); } $t6af77=[imagesx($c1ccee),imagesy($c1ccee)]; $vb3e38=$t6af77; $bac50f=[0,0,0,0]; if ($ecff96==CROP_SQUARE){ if(Log::$ped2b5)__log('Process image: Needs crop'); list ($vb3e38,$bac50f) = ( e2img__crop_metrics_to_square($vb3e38) ); } $vb3e38=e2_fit_metrics_to_constraints( $vb3e38,$a26635 ); if ( $e89918===0 and $vb3e38===$t6af77 ){ if(Log::$ped2b5)__log('Process image: No changes necessary, leaving original'); return $sfce75; } if(Log::$ped2b5)__log(var_export($vb3e38,true)); if(Log::$ped2b5)__log(var_export($bac50f,true)); $z26ea7=e2img__create_copy_resampled( $c1ccee, $vb3e38, $bac50f, $type ); imagejpeg($z26ea7,$e1c925,$vd6663); if (!is_file($e1c925)) { if(Log::$ped2b5)__log('Process image: File not created by imagejpeg'); return false; } if ($e89918===0){ $t46c12=stat($e1c925)['size']; if ($t46c12 >= $k9c26d){ if(Log::$ped2b5)__log('Process image: Conversion to JPEG made file bigger, back up'); unlink($e1c925); $e1c925=$sfce75; } } @chmod($e1c925,$_config['uploaded_files_mode']); if(Log::$ped2b5)__log('Process image: Done'); return $e1c925; } function e2img__create_copy_resampled( $c1ccee,$vb3e38,$bac50f,$type ){ list ($xd4d55,$e455ce)=$vb3e38; list ($h98453,$x2aaef,$yb40c7,$m0a71b)=$bac50f; $z26ea7=imagecreatetruecolor($xd4d55,$e455ce); if($type==='png'){ imagefill($z26ea7,0,0,imagecolorallocate($z26ea7,255,255,255)); imagealphablending($z26ea7,true); } $t2097d=imagesx($c1ccee); $a97874=imagesy($c1ccee); imagecopyresampled( $z26ea7, $c1ccee, 0,0, 0+$h98453,0+$x2aaef, $xd4d55,$e455ce, $t2097d-$yb40c7,$a97874-$m0a71b ); imageinterlace($z26ea7,1); return $z26ea7; } function e2img__type_of_file($x435ed){ $hcaf9b=@getimagesize($x435ed); if (!$hcaf9b or $hcaf9b[2] > 3) return false; if ($hcaf9b[2]==IMAGETYPE_GIF) return 'gif'; if ($hcaf9b[2]==IMAGETYPE_JPEG) return 'jpeg'; if ($hcaf9b[2]==IMAGETYPE_PNG) return 'png'; return false; } function e2img__orientation_of_file($x435ed){ if (!function_exists('exif_read_data')) return 0; if (($p9beff=@exif_read_data($x435ed)) === false) return 0; if ($p9beff['Orientation']==3) return -180; if ($p9beff['Orientation']==6) return -270; if ($p9beff['Orientation']==8) return -90; return 0; } function e2img__res_rotate($k9b207,$e89918){ $q65370=imagerotate($k9b207,$e89918,0); if ($q65370!==false){ imagedestroy($k9b207); $k9b207=$q65370; } return $k9b207; } function e2_fit_metrics_to_constraints( $z0b73d,$a26635 ){ if ($a26635===false)$a26635=[0,0]; list ($beaae2,$zb435e)=$z0b73d; list ($mdb99b,$d4278c)=$a26635; $b8e7bb=[1]; if ($mdb99b)$b8e7bb[] = $mdb99b/$beaae2; if ($d4278c)$b8e7bb[] = $d4278c/$zb435e; $h0cb47=min($b8e7bb); if ($h0cb47 < 1){ $beaae2=(int)round($beaae2*$h0cb47); $zb435e=(int)round($zb435e*$h0cb47); } return [$beaae2,$zb435e]; } function e2img__crop_metrics_to_square($z0b73d){ $f81188=$qb2835=$d4505c=$ue6dec=0; list ($beaae2,$zb435e)=$z0b73d; if ($beaae2 > $zb435e){ $d4505c=$beaae2-$zb435e; $f81188=floor($d4505c/2); $zb435e=$beaae2; } elseif ($beaae2 < $zb435e){ $ue6dec=$zb435e-$beaae2; $qb2835=floor($d4505c/2); $beaae2=$zb435e; } $bac50f=[$f81188,$qb2835,$d4505c,$ue6dec]; $t27e5c=[$beaae2,$zb435e]; return [$t27e5c,$bac50f]; } $_folders_written=array ( '.', USER_FOLDER, CACHES_FOLDER, BACKUP_FOLDER, LOG_FOLDER, MEDIA_ROOT_FOLDER.PICTURES_FOLDER, MEDIA_ROOT_FOLDER.THUMBNAILS_FOLDER, MEDIA_ROOT_FOLDER.PICTURES_FOLDER .'remote/', MEDIA_ROOT_FOLDER.THUMBNAILS_FOLDER .'remote/', MEDIA_ROOT_FOLDER.AUDIO_FOLDER, MEDIA_ROOT_FOLDER.AVATARS_FOLDER, ); $_files_written=array ( USER_FOLDER.'password-hash.psa', USER_FOLDER.'password-wait.psa', USER_FOLDER.'last-comment.psa', USER_FOLDER.'new-uploads.psa', USER_FOLDER.'settings.json', USER_FOLDER.'indexing.psa', USER_FOLDER.'auth.psa', USER_FOLDER.'scheduled.psa', ); define('CROP_NONE',0); define('CROP_SQUARE',1); define('PROVIDE_DATA_SPAWN',10); define('PROVIDE_DATA_NOW',20); function eea70(){ global$_folders_written,$_files_written; clearstatcache(); $e10ae9=array(); foreach($_folders_written as $a8fa14){ if(is_dir($a8fa14) and !is_writable($a8fa14)) { $e10ae9[] = $a8fa14; } } foreach($_files_written as $a8fa14){ if(is_file($a8fa14) and !is_writable($a8fa14)) { $e10ae9[] = $a8fa14; } } return $e10ae9; } function n6e52($b8c7dd,$ab45cf){ @caf42(dirname($b8c7dd)); if (!@file_put_contents($b8c7dd,$ab45cf,LOCK_EX)) { return false; } @chmod($b8c7dd,E2_NEW_FILES_RIGHTS); return true; } function l1cae($k954eb){ if(preg_match('/^https?\:\/\//iu',$k954eb)) { $z6efa1=$k954eb; $z6efa1=preg_replace('/^https?\:\/\//iu','',$z6efa1); $z6efa1=str_replace('/','--',$z6efa1); $z6efa1=MEDIA_ROOT_FOLDER.THUMBNAILS_FOLDER.$z6efa1; } else { $z6efa1=MEDIA_ROOT_FOLDER.THUMBNAILS_FOLDER.$k954eb; } $z6efa1=e2files__add_ext_prefix($z6efa1,'thumb@2x'); return $z6efa1; } function d6e61($k954eb){ if(preg_match('/^https?\:\/\//iu',$k954eb)) { $maf721=$k954eb; } else { $maf721=MEDIA_ROOT_FOLDER.PICTURES_FOLDER.$k954eb; } $z6efa1=e2img_filename_by_processing( $maf721, l1cae($k954eb), [THUMB_WIDTH,THUMB_HEIGHT], CROP_NONE, THUMB_JPG_QUALITY ); if ($z6efa1===false) return false; $mf5a8e=strlen(MEDIA_ROOT_FOLDER); if(substr($z6efa1,0,$mf5a8e)==MEDIA_ROOT_FOLDER){ $z85133=substr($z6efa1,$mf5a8e); } return $z85133; } function t30f2($maf721){ $j8743c=pathinfo($maf721); $habf77=$j8743c['extension']; return (in_array(strtolower($habf77), array ('jpg','jpeg','gif','png','svg'))); } function zb6c5($maf721){ $j8743c=pathinfo($maf721); $habf77=$j8743c['extension']; return (in_array(strtolower($habf77), array ('jpg','jpeg','gif','png'))); } function gef67($maf721){ $j8743c=pathinfo($maf721); $habf77=$j8743c['extension']; if ($habf77=='png') return IMAGETYPE_PNG; if ($habf77=='gif') return IMAGETYPE_GIF; if ($habf77=='jpg' or $habf77=='jpeg') return IMAGETYPE_JPEG; } function ac952($maf721){ $j8743c=pathinfo($maf721); $habf77=$j8743c['extension']; if ($habf77=='png') return 'image/png'; if ($habf77=='gif') return 'image/gif'; if ($habf77=='jpg' or $habf77=='jpeg') return 'image/jpeg'; if ($habf77=='mp3') return 'audio/mpeg'; } function l19a4($x435ed){ if (zb6c5($x435ed)) { list ($beaae2,$zb435e)=getimagesize($x435ed); } else { $ze2da9=simplexml_load_string(file_get_contents($x435ed)); if ($ze2da9){ $td0a5e=$ze2da9->attributes(); list ($beaae2,$zb435e) = array ((string)$td0a5e -> width, (string)$td0a5e -> height); } else { return false; } } if(substr($x435ed,strrpos($x435ed,'.')-3,3)=='@2x'){ $beaae2=(int)floor($beaae2/2); $zb435e=(int)floor($zb435e/2); } return array ($beaae2,$zb435e); } function e2s_retrieve($parameters){ $o36cd3=urldecode(base64_decode($parameters['url'])); if(Log::$ped2b5)__log('Retrieve: '. $o36cd3); a1066($o36cd3,PROVIDE_DATA_NOW); } function kd222($h447b7){ global$full_blog_url; $h78f08=parse_url($h447b7); if (isset ($h78f08['scheme'])) { if ($h78f08['host']=='www.youtube.com'){ $sb80bb=basename($h78f08['path']); $r15ba8='remote/youtube-'. $sb80bb .'-cover.jpg'; return array ( 'type' => 'online-video', 'is-local?' => false, 'is-rss-enclosure?' => false, 'video-service' => 'youtube', 'video-id' => $sb80bb, 'local-cover-name' => $r15ba8, 'local-cover-href' => $full_blog_url .'/'. PICTURES_FOLDER.$r15ba8, 'local-full-filename' => MEDIA_ROOT_FOLDER.PICTURES_FOLDER.$r15ba8, 'local-full-failname' => MEDIA_ROOT_FOLDER.PICTURES_FOLDER.$r15ba8.'.failed', ); } elseif ($h78f08['host']=='player.vimeo.com'){ $sb80bb=basename($h78f08['path']); $r15ba8='remote/vimeo-'. $sb80bb .'-cover.jpg'; return array ( 'type' => 'online-video', 'is-local?' => false, 'is-rss-enclosure?' => false, 'video-service' => 'vimeo', 'video-id' => $sb80bb, 'local-cover-name' => $r15ba8, 'local-cover-href' => $full_blog_url .'/'. PICTURES_FOLDER.$r15ba8, 'local-full-filename' => MEDIA_ROOT_FOLDER.PICTURES_FOLDER.$r15ba8, 'local-full-failname' => MEDIA_ROOT_FOLDER.PICTURES_FOLDER.$r15ba8.'.failed', ); } elseif (t30f2($h78f08['path'])) { return array ( 'type' => 'remote-image', 'is-local?' => false, 'is-rss-enclosure?' => false, 'url' => $h447b7, 'mime-type' => ac952($h78f08['path']), 'length' => '', ); } else { return array ( 'type' => 'remote-non-image', 'is-local?' => false, 'is-rss-enclosure?' => true, 'url' => $h447b7, 'mime-type' => ac952($h78f08['path']), 'length' => '', ); } } else { if (t30f2($h78f08['path'])) { $bb6d7a=MEDIA_ROOT_FOLDER.PICTURES_FOLDER.$h78f08['path']; return array ( 'type' => 'local-image', 'is-local?' => true, 'is-rss-enclosure?' => false, 'url' => $full_blog_url .'/'. PICTURES_FOLDER.$h78f08['path'], 'mime-type' => ac952($h78f08['path']), 'length' => @stat($bb6d7a)['size'], 'local-href' => $full_blog_url .'/'. PICTURES_FOLDER.$h78f08['path'], 'local-full-filename' => $bb6d7a, ); } else { $bb6d7a=MEDIA_ROOT_FOLDER.AUDIO_FOLDER.$h78f08['path']; return array ( 'type' => 'local-non-image', 'is-local?' => true, 'is-rss-enclosure?' => true, 'url' => $full_blog_url .'/'. AUDIO_FOLDER.$h78f08['path'], 'mime-type' => ac952($h78f08['path']), 'length' => @stat($bb6d7a)['size'], 'local-href' => $full_blog_url .'/'. AUDIO_FOLDER.$h78f08['path'], 'local-full-filename' => $bb6d7a, ); } } } function a1066($h447b7,$edb88a){ $c1c149=kd222($h447b7); if ($c1c149['type']=='remote-image'){ } elseif ($c1c149['type']=='online-video'){ if(is_file($c1c149['local-full-filename'])) { if(Log::$ped2b5)__log('Already exists: '. $c1c149['local-full-filename']); } elseif(is_file($c1c149['local-full-failname'])) { if(Log::$ped2b5)__log('Already tried and failed: '. $c1c149['local-full-filename']); } else { if(Log::$ped2b5)__log($h447b7.' is missing a cover, retrieving'); if ($edb88a==PROVIDE_DATA_SPAWN){ ecc38(d83c8('e2s_retrieve', array ( 'url' => urlencode(base64_encode($h447b7)), ))); } if ($edb88a==PROVIDE_DATA_NOW){ if ($c1c149['video-service']=='youtube') { $g5f89d=array ( 'maxresdefault','hqdefault','mqdefault','sddefault','default' ); foreach ($g5f89d as $od7d16){ $y572d4='http://img.youtube.com/vi/'. $c1c149['video-id'] .'/'. $od7d16 .'.jpg'; if(Log::$ped2b5)__log('Getting '.$y572d4 .' as '. $c1c149['local-full-filename']); $t6c43d=file_get_contents($y572d4); if ($t6c43d!==false) break; } } if ($c1c149['video-service']=='vimeo') { $jc4a72=unserialize( file_get_contents('http://vimeo.com/api/v2/video/'. $c1c149['video-id'] .'.php') ); if (isset ($jc4a72[0]['thumbnail_large'])) { $t6c43d=file_get_contents($jc4a72[0]['thumbnail_large']); } } if ($t6c43d!==false){ n6e52($c1c149['local-full-filename'],$t6c43d); } else { n6e52($c1c149['local-full-failname'],''); } } } if ($edb88a==PROVIDE_DATA_NOW){ if(is_file($c1c149['local-full-filename'])) { d6e61($c1c149['local-cover-name']); } } } elseif ($c1c149['type']=='local-image'){ if(Log::$ped2b5)__log($h447b7.' is a local image'); d6e61($h447b7); } elseif ($c1c149['type']=='local-non-image'){ if(Log::$ped2b5)__log($h447b7.' is a local non-image'); } } function e6be4($e10ae9){ if (!is_array($e10ae9)) return; if(Log::$ped2b5)__log('Provide data for resources {'); foreach ($e10ae9 as $h447b7){ a1066($h447b7,PROVIDE_DATA_SPAWN); } if(Log::$ped2b5)__log('}'); } function uf898($y89111,$tdffc4,$je449c){ $t5128f=m1722($y89111,$tdffc4); $x55b55=array_merge($t5128f,$je449c); $x55b55=array_reverse($x55b55); $x55b55=array_unique($x55b55); $x55b55=array_reverse($x55b55); return l2e82($x55b55,RESOURCES_LOCAL); } function wfc4d($sd430b,$z2bfe4){ $q84841=array(); if(is_array($z2bfe4['meta']['resources-detected'])) { $je449c=$z2bfe4['meta']['resources-detected']; $q84841=gdc5a($je449c); } $e16137=@unserialize( $sd430b['Uploads'] ) or $e16137=array(); $d08204=array_diff($q84841,$e16137); if(count($d08204) > 0){ u2cf0('note',$sd430b['ID'],'add',$d08204); } return $d08204; } function gdc5a($od7f81){ $e10ae9=array(); foreach ($od7f81 as $y1993e){ $c1c149=kd222($y1993e); if ($c1c149['is-local?'])$e10ae9[] = $y1993e; } return $e10ae9; } function l2e82($x55b55,$i8b7af=RESOURCES_ALL){ global$full_blog_url,$_strings; $ief067=array(); $q59b51=array(); if (!is_array($x55b55)) return $q59b51; e6be4($x55b55); foreach ($x55b55 as $y96ab4){ $c1c149=kd222($y96ab4); $s11b42=''; if ($c1c149['is-local?'] and is_file($c1c149['local-full-filename'])) { $s11b42=stat($c1c149['local-full-filename'])[7]; $s11b42=round($s11b42/1024) .' '. $_strings['gs--kb']; } if ($i8b7af==RESOURCES_LOCAL and !$c1c149['is-local?']) continue; if ($c1c149['type']=='remote-image'){ } elseif ($c1c149['type']=='remote-non-image'){ } elseif ($c1c149['type']=='online-video'){ if ($k742c4=d6e61($c1c149['local-cover-name'])) { $size=l19a4(MEDIA_ROOT_FOLDER.$k742c4); list ($beaae2,$zb435e)=$size; if (!in_array($y96ab4,$ief067)) { $ief067[] = $y96ab4; $q59b51[] = array ( 'original-filename' => $y96ab4, 'href' => $full_blog_url .'/'. $k742c4, 'width' => $beaae2, 'height' => $zb435e, ); } } } elseif ($c1c149['type']=='local-image'){ if ($k742c4=d6e61($y96ab4)) { $size=l19a4(MEDIA_ROOT_FOLDER.$k742c4); list ($beaae2,$zb435e)=$size; if (!$beaae2)$beaae2=THUMB_WIDTH/2; if (!$zb435e)$zb435e=THUMB_HEIGHT/2; list ($beaae2,$zb435e)=e2_fit_metrics_to_constraints( [$beaae2,$zb435e], [THUMB_WIDTH/2,THUMB_HEIGHT/2] ); if (!in_array($y96ab4,$ief067)) { $ief067[] = $y96ab4; $q59b51[] = array ( 'original-filename' => $y96ab4, 'original-filesize' => $s11b42, 'href' => $full_blog_url .'/'. $k742c4, 'width' => $beaae2, 'height' => $zb435e, ); } } else { if (!in_array($y96ab4,$ief067)) { $ief067[] = $y96ab4; $q59b51[] = array ( 'original-filename' => $y96ab4, 'original-filesize' => '', 'href' => $full_blog_url .'/'. l1cae($y96ab4), 'width' => 0, 'height' => 0, ); } } } elseif ($c1c149['type']=='local-non-image'){ if(is_file(MEDIA_ROOT_FOLDER.AUDIO_FOLDER.$y96ab4)) { if (!in_array($y96ab4,$ief067)) { $ief067[] = $y96ab4; $q59b51[] = array ( 'original-filename' => $y96ab4, 'original-filesize' => $s11b42, 'href' => $full_blog_url .'/'. AUDIO_ICON_IMAGE, 'width' => AUDIO_ICON_WIDTH, 'height' => AUDIO_ICON_HEIGHT, ); } } else { if (!in_array($y96ab4,$ief067)) { $ief067[] = $y96ab4; $q59b51[] = array ( 'original-filename' => $y96ab4, 'original-filesize' => '', 'href' => $full_blog_url .'/'. AUDIO_ICON_IMAGE, 'width' => 0, 'height' => 0, ); } } } } return $q59b51; } function sdbcc($y89111,$tdffc4,$x55b55){ global$full_blog_url; $e10ae9=array(); if(is_array($x55b55)) { $e10ae9=e2files__list_og_images_for_resources_($x55b55); } $t5128f=m1722($y89111,$tdffc4); if(is_array($t5128f)) { foreach ($t5128f as $o8ce4b => $l9e366){ if(is_file(MEDIA_ROOT_FOLDER.PICTURES_FOLDER.$l9e366)) { $t5128f[$o8ce4b]=$full_blog_url .'/'. PICTURES_FOLDER.$l9e366; } else { unset ($t5128f[$o8ce4b]); } } $e10ae9=array_merge($t5128f,$e10ae9); } $e10ae9=array_reverse($e10ae9); $e10ae9=array_unique($e10ae9); $e10ae9=array_reverse($e10ae9); return $e10ae9; } function e2files__list_og_images_for_resources_($x55b55){ $q59b51=array(); e6be4($x55b55); foreach ($x55b55 as $y96ab4){ $c1c149=kd222($y96ab4); if ($c1c149['type']=='remote-image'){ } elseif ($c1c149['type']=='remote-non-image'){ } elseif ($c1c149['type']=='online-video'){ if(is_file($c1c149['local-full-filename'])) { $q59b51[] = $c1c149['local-cover-href']; } } elseif ($c1c149['type']=='local-image'){ if(is_file($c1c149['local-full-filename'])) { $q59b51[] = $c1c149['local-href']; } } elseif ($c1c149['type']=='local-non-image'){ } } return $q59b51; } function w9c0a($sb0689,$y12e09){ $sb0689=n2183($sb0689); if(preg_match('//u',$sb0689))$sb0689=pedd9($sb0689,false); if ($y12e09=='image'){ $g85114=MEDIA_ROOT_FOLDER.PICTURES_FOLDER; } elseif ($y12e09=='audio'){ $g85114=MEDIA_ROOT_FOLDER.AUDIO_FOLDER; } else { return false; } $w96704=''; for ($d865c0=0; $d865c0 < strlen($sb0689); $d865c0++) { if ($sb0689[$d865c0]=='?'){ $w96704.=''; } elseif ($sb0689[$d865c0]==' '){ $w96704.='-'; } elseif(ord($sb0689[$d865c0]) <= 127){ $w96704.=$sb0689[$d865c0]; } } if ($w96704=='')$w96704=$y12e09; if ($w96704[0]=='.')$w96704=$y12e09.$w96704; return $w96704; } function gf0fb($z76ee3){ global$_config; if(Log::$ped2b5)__log('Count references for upload <'. $z76ee3 .'>'); if(is_file(USER_FOLDER.'new-uploads.psa')) { $a7cd94=@unserialize(file_get_contents(USER_FOLDER.'new-uploads.psa')); } $e5a976='%'. str_replace('%','#%',$z76ee3) .'%'; p0738( "SELECT `ID`, `Text`, `FormatterID`, `Uploads` ". "FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND (`Text` LIKE '". $e5a976 ."' ESCAPE '#' ". "OR `Uploads` LIKE '". $e5a976 ."' ESCAPE '#')", 'get notes where uploads may be referenced' ); $result=g0d6b(); $ebe270=@unserialize($result[0]['Uploads']); if (!is_array($ebe270)) { foreach($result as $d39a37){ $z2bfe4=b154e( $d39a37['FormatterID'], @$d39a37['Text'],'full-rss' ); $ebe270=wfc4d($d39a37,$z2bfe4); } } p0738( "SELECT `ID`, `Description`, `Uploads` ". "FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND (`Description` LIKE '". $e5a976 ."' ESCAPE '#' ". "OR `Uploads` LIKE '". $e5a976 ."' ESCAPE '#')", 'get tags where uploads may be referenced' ); $result=g0d6b(); $v6ae44=@unserialize($result[0]['Uploads']); if (!is_array($v6ae44)) { foreach($result as $pb19ad){ $z2bfe4=db7f1( @$pb19ad['Description'],'full-rss' ); $v6ae44=wfc4d($pb19ad,$z2bfe4); } } if (!is_array($a7cd94))$a7cd94=[]; if (!is_array($ebe270))$ebe270=[]; if (!is_array($v6ae44))$v6ae44=[]; $t5128f=array_merge($a7cd94,$ebe270,$v6ae44); if(Log::$ped2b5)__log('References found in relevant entries: '. var_export($t5128f,true)); if(in_array($z76ee3,$t5128f)) { if(Log::$ped2b5)__log('Still referenced, do not delete file'); return true; } return false; } function m1722($of5e63,$sb80bb){ global$_config; if ($of5e63=='note' and $sb80bb=='new'){ if(is_file(USER_FOLDER.'new-uploads.psa')) { $t5128f=@unserialize(file_get_contents(USER_FOLDER.'new-uploads.psa')); } } elseif ($of5e63=='note'){ p0738( "SELECT `Uploads` FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID`=". $sb80bb ); $result=g0d6b(); $t5128f=@unserialize($result[0]['Uploads']); } elseif ($of5e63=='tag'){ p0738( "SELECT `Uploads` FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID`=". $sb80bb ); $result=g0d6b(); $t5128f=@unserialize($result[0]['Uploads']); } if (!is_array($t5128f))$t5128f=array(); return $t5128f; } function kcbba($of5e63,$sb80bb,$t5128f){ global$_config; if ($of5e63=='note' and $sb80bb=='new'){ if (!@n6e52(USER_FOLDER.'new-uploads.psa',serialize($t5128f))) { x8a40('ERROR',E2E_PERMISSIONS_ERROR); } } elseif ($of5e63=='note'){ p0738( "UPDATE `". $_config['db_table_prefix']."Notes` ". "SET `Uploads`='". serialize($t5128f) ."' ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID`=". $sb80bb ); } elseif ($of5e63=='tag'){ p0738( "UPDATE `". $_config['db_table_prefix']."Keywords` ". "SET `Uploads`='". serialize($t5128f) ."' ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID`=". $sb80bb ); } else { return false; } if (!is_array($t5128f))$t5128f=array(); return $t5128f; } function u2cf0($of5e63,$sb80bb,$action,$f4a202){ global$_config; $t5128f=array(); if(Log::$ped2b5)__log('Register upload: <'. $of5e63.', '. $sb80bb.', '. $action.', '. $f4a202 .'>'); $t5128f=m1722($of5e63,$sb80bb); $t5128f=ie1e7($t5128f,$action,$f4a202); kcbba($of5e63,$sb80bb,$t5128f); } function j2f83($h4b27b,$fde17f,$je449c){ $e16137=@unserialize($fde17f['Uploads']) or $e16137=array(); $c28a47=gdc5a($je449c); $t5128f=ie1e7($e16137,'add',$c28a47); $t5128f=serialize($t5128f); if ($t5128f!=$fde17f['Uploads']) { $fde17f['Uploads']=$t5128f; kaa79($h4b27b,$fde17f); } } function e2j_file_upload($parameters=array ()) { global$_config,$full_blog_url,$_strings; @caf42(MEDIA_ROOT_FOLDER.PICTURES_FOLDER); @chmod(MEDIA_ROOT_FOLDER.PICTURES_FOLDER,$_config['uploaded_files_mode']); @caf42(MEDIA_ROOT_FOLDER.AUDIO_FOLDER); @chmod(MEDIA_ROOT_FOLDER.AUDIO_FOLDER,$_config['uploaded_files_mode']); $sd1fc8=[ 'success' => false ]; if(count($_FILES) > 0){ foreach($_FILES as $b8c7dd){ if (!$b8c7dd['error']) { if(Log::$ped2b5)__log('Ajax file upload: <'. $b8c7dd['name'].'>'); $sd1fc8['data']['file-kind']='image'; $g85114=MEDIA_ROOT_FOLDER.PICTURES_FOLDER; if(substr($b8c7dd['name'],strrpos($b8c7dd['name'],'.')) == '.mp3'){ $sd1fc8['data']['file-kind']='audio'; $g85114=MEDIA_ROOT_FOLDER.AUDIO_FOLDER; } $s77dce=( array_key_exists('overwrite',$_GET) and is_file($g85114.$b8c7dd['name']) ); $q6f4b5=false; $sd1fc8['data']['overwrite'] = (int)$s77dce; if(Log::$ped2b5)__log('Ajax file upload: Overwrite is resolved to <'. (int)$s77dce.'>'); $w96704=w9c0a($b8c7dd['name'],$sd1fc8['data']['file-kind']); if(Log::$ped2b5)__log('Ajax file upload: Safe name is <'. $w96704.'>'); if(is_file($g85114.$w96704)) { if(file_get_contents($g85114.$w96704)==file_get_contents($b8c7dd['tmp_name'])) { if(Log::$ped2b5)__log('Ajax file upload: Existing file is the same'); $q6f4b5=true; } elseif (!$s77dce){ $w96704=e2files__find_free_filename($g85114,$w96704); } } if (!$q6f4b5){ move_uploaded_file($b8c7dd['tmp_name'],$g85114.$w96704); @chmod($g85114.$w96704,$_config['uploaded_files_mode']); } if(Log::$ped2b5)__log('Ajax file upload: File kind is <'. $sd1fc8['data']['file-kind'].'>'); if ($sd1fc8['data']['file-kind']=='image'){ $ma28be=e2files__find_free_filename_with_added_ext( MEDIA_ROOT_FOLDER.PICTURES_FOLDER, $w96704,'jpg' ); $sb1cee=MEDIA_ROOT_FOLDER.PICTURES_FOLDER.$w96704; $p093b5=MEDIA_ROOT_FOLDER.PICTURES_FOLDER.$ma28be; if(Log::$ped2b5)__log('Ajax file upload: Process uploaded image <'. $sb1cee.'>'. ' to possibly <'. $p093b5.'>'); $p093b5=e2img_filename_by_processing( $sb1cee, $p093b5, [ $_config['fit_uploaded_images'], $_config['fit_uploaded_images'], ], CROP_NONE, SCALED_IMAGE_JPG_QUALITY ); $s11b42=$b8c7dd['size']; if (!i4f9d($p093b5,$sb1cee)) { @unlink($sb1cee); $w96704=$ma28be; $s11b42=stat($p093b5)['size']; } if ($s77dce){ @unlink(l1cae($w96704)); } if ($k742c4=d6e61($w96704)) { if(Log::$ped2b5)__log('Ajax file upload: thumbnail, done'); list ($beaae2,$zb435e)=l19a4(MEDIA_ROOT_FOLDER.$k742c4); if (!$beaae2)$beaae2=THUMB_WIDTH/2; if (!$zb435e)$zb435e=THUMB_HEIGHT/2; list ($beaae2,$zb435e)=e2_fit_metrics_to_constraints( [$beaae2,$zb435e], [THUMB_WIDTH/2,THUMB_HEIGHT/2] ); $sd1fc8['success']=true; $sd1fc8['data']['new-name']=$w96704; $sd1fc8['data']['filesize']=round($s11b42/1024) .' '. $_strings['gs--kb']; $sd1fc8['data']['thumb']=$full_blog_url .'/'. $k742c4; $sd1fc8['data']['width']=$beaae2; $sd1fc8['data']['height']=$zb435e; u2cf0($parameters['entity'],$parameters['entity-id'],'add', array ($w96704)); } else { if(Log::$ped2b5)__log('Ajax file upload: couldn’t create thumbnail'); @unlink($g85114.$w96704); $sd1fc8['error']['message']=_S('er--cannot-create-thumbnail'); } } if ($sd1fc8['data']['file-kind']=='audio'){ if(Log::$ped2b5)__log('Ajax file upload: audio, done'); $sd1fc8['success']=true; $sd1fc8['data']['new-name']=$w96704; $sd1fc8['data']['filesize']=round($b8c7dd['size']/1024) .' '. $_strings['gs--kb']; $sd1fc8['data']['thumb']=AUDIO_ICON_IMAGE; $sd1fc8['data']['width']=AUDIO_ICON_WIDTH; $sd1fc8['data']['height']=AUDIO_ICON_HEIGHT; u2cf0($parameters['entity'],$parameters['entity-id'],'add', array ($w96704)); } } elseif(4!=$b8c7dd['error']) { if ($b8c7dd['error']==1){ $sd1fc8['error']['message']='too-big'; } elseif ($b8c7dd['error']==2){ $sd1fc8['error']['message']='too-big'; } elseif ($b8c7dd['error']==3){ $sd1fc8['error']['message']='partial'; } else { $sd1fc8['error']=$b8c7dd['error']; } } } } else { if(Log::$ped2b5)__log('Ajax file upload error: no files'); $sd1fc8['error']['message']='no-files'; } $sd1fc8=json_encode($sd1fc8); die ($sd1fc8); } function v8bd1(){ @unlink(USER_FOLDER.'userpic@2x.png'); @unlink(USER_FOLDER.'userpic@2x.jpg'); @unlink(USER_FOLDER.'userpic-large@2x.jpg'); @unlink(USER_FOLDER.'userpic-square@2x.jpg'); } function e2j_userpic_remove(){ if($_SERVER['REQUEST_METHOD']!='POST') return e2_go_to(d83c8('e2m_settings')); v8bd1(); $sd1fc8=json_encode([ 'success' => true ]); die ($sd1fc8); } function e2j_userpic_upload(){ global$_config; $sd1fc8=[ 'success' => false ]; if(count($_FILES)!=1){ if(Log::$ped2b5)__log('Ajax userpic upload error: no or too many files'); $sd1fc8['error']['message']='No or too many files'; $sd1fc8=json_encode($sd1fc8); die ($sd1fc8); } $b8c7dd=array_pop($_FILES); if (!$b8c7dd['error']) { if(Log::$ped2b5)__log('Ajax userpic upload: <'. $b8c7dd['name'].'>'); $fa93b8=pathinfo($b8c7dd['name']); $habf77=strtolower($fa93b8['extension']); if ($habf77!='png')$habf77='jpg'; $x435ed='userpic.original.'. $habf77; move_uploaded_file($b8c7dd['tmp_name'],USER_FOLDER.$x435ed); @chmod(USER_FOLDER.$x435ed,$_config['uploaded_files_mode']); v8bd1(); copy( USER_FOLDER.$x435ed, USER_FOLDER .'userpic-large@2x.jpg' ); $e48295=e2img_filename_by_processing( USER_FOLDER .'userpic-large@2x.jpg', USER_FOLDER .'userpic-large@2x.jpg', [$_config['max_image_width'],$_config['max_image_width']], CROP_NONE, USERPIC_JPG_QUALITY ); copy( USER_FOLDER.$x435ed, USER_FOLDER .'userpic-square@2x.jpg' ); $v7d332=e2img_filename_by_processing( USER_FOLDER .'userpic-square@2x.jpg', USER_FOLDER .'userpic-square@2x.jpg', [$_config['max_image_width'],$_config['max_image_width']], CROP_SQUARE, USERPIC_JPG_QUALITY ); $ef1210=e2img_filename_by_processing( USER_FOLDER.$x435ed, USER_FOLDER .'userpic@2x.jpg', [USERPIC_WIDTH,USERPIC_HEIGHT], CROP_SQUARE, USERPIC_JPG_QUALITY ); if ($v7d332){ $sd1fc8=[ 'success' => true, 'data' => [ 'new-image-src' => $v7d332, ] ]; } else { $sd1fc8['error']['message']=_S('er--unsupported-file-image'); } } elseif(4!=$b8c7dd['error']) { if ($b8c7dd['error']==1){ $sd1fc8['error']['message']='File too big'; } elseif ($b8c7dd['error']==2){ $sd1fc8['error']['message']='File too big'; } elseif ($b8c7dd['error']==3){ $sd1fc8['error']['message']='File upload is partial'; } else { $sd1fc8['error']['message']='File upload error '. $b8c7dd['error']; } } $sd1fc8=json_encode($sd1fc8); die ($sd1fc8); } function e2j_file_remove($parameters){ if (!array_key_exists('file',$_POST)) { $sd1fc8=[ 'success' => false ]; $sd1fc8=json_encode($sd1fc8); die ($sd1fc8); } $b8c7dd=$_POST['file']; $sd1fc8=[ 'success' => true ]; $sd1fc8=json_encode($sd1fc8); u2cf0($parameters['entity'],$parameters['entity-id'],'remove',$b8c7dd); if (!gf0fb($b8c7dd)) { if(substr($b8c7dd,strrpos($b8c7dd,'.')) == '.mp3'){ @unlink(MEDIA_ROOT_FOLDER.AUDIO_FOLDER.$b8c7dd); } else { $ef1210=e2files__add_ext_prefix($b8c7dd,'thumb@2x'); $tf6347=@unlink(MEDIA_ROOT_FOLDER.PICTURES_FOLDER.$b8c7dd); $w8f458=@unlink(MEDIA_ROOT_FOLDER.THUMBNAILS_FOLDER.$ef1210); } } die ($sd1fc8); } function pd10e(){ global$_config; if (!$_config['files_total_size_limit']) return false; $v70a36=0; foreach(glob(MEDIA_ROOT_FOLDER.PICTURES_FOLDER .'/*') as $b8c7dd){ $e9dd4e=stat($b8c7dd); $v70a36+=$e9dd4e['size']; } foreach(glob(MEDIA_ROOT_FOLDER.AUDIO_FOLDER .'/*') as $b8c7dd){ $e9dd4e=stat($b8c7dd); $v70a36+=$e9dd4e['size']; } $nd515a=$_config['files_total_size_limit']; $s354f0=round($v70a36/$nd515a*100); if ($v70a36 > 0 and $s354f0==0)$s354f0=1; if ($v70a36 < $nd515a and $s354f0==100)$s354f0=99; return array ($v70a36,$nd515a,$s354f0); } function i4f9d($pbd198,$f3667f){ return strcasecmp($pbd198,$f3667f)===0; } function t1363($kc999b){ $w85faf=true; if (list ($v70a36,$nd515a,$s354f0)=$kc999b){ $w85faf=($nd515a-$v70a36) > 0; } return $w85faf; } function zaf64($kc999b,$if9f90=false){ $uf3ecb=''; if (list ($v70a36,$nd515a,$s354f0)=$kc999b){ $kc999b=array ( 'used' => round($v70a36/1024/1024), 'total' => round($nd515a/1024/1024), 'percent' => $s354f0 ); if ($if9f90 or ($nd515a-$v70a36) < 1024*1024*10){ if ($v70a36 < $nd515a){ $uf3ecb=e2l_get_string('gs--used',$kc999b); } else { $uf3ecb=e2l_get_string('gs--used-all',$kc999b); } } } return $uf3ecb; } function e2files__find_free_filename($g85114,$x435ed){ if (!is_file($g85114.$x435ed)) return $x435ed; $ke12a7=e2files__extless($x435ed); $habf77=substr($x435ed,strrpos($x435ed,'.')); $d865c0=0; while (is_file($g85114.$ke12a7 .'-'. (++$d865c0).$habf77)); $x435ed=$ke12a7 .'-'. $d865c0.$habf77; return $x435ed; } function e2files__add_ext_prefix($x435ed,$d3dbb8){ if ($d3dbb8){ $b80127=explode('/',$x435ed); $k954eb=array_pop($b80127); $q35b88=explode('.',$k954eb); if(count($q35b88) < 2)$q35b88[] = ''; $habf77=array_pop($q35b88); $q35b88[] = $d3dbb8; if ($habf77)$q35b88[] = $habf77; $k954eb=implode('.',$q35b88); $b80127[] = $k954eb; $x435ed=implode('/',$b80127); } return $x435ed; } function e2files__extless($x435ed){ return substr($x435ed,0,strrpos($x435ed,'.')); } function e2files__find_free_filename_with_added_ext($g85114,$x435ed,$p3cedd){ $habf77=pathinfo($x435ed,PATHINFO_EXTENSION); if (!strcasecmp($habf77,$p3cedd)) return $x435ed; return e2files__find_free_filename($g85114,$x435ed .'.'. $p3cedd); } function e2_error404_mode(){ global$_config,$_strings; if($_config['try_redirect_to_all']) { $l4a7dc='all/'. urldecode($_GET['go']); qb7e9($l4a7dc); } header('HTTP/1.1 404 Not found'); $ue70c4['class']='404'; $ue70c4['heading']=$_strings['pt--page-not-found']; $ue70c4['title']=$_strings['pt--page-not-found']; return $ue70c4; } function z6f10($l1cb25){ include_once 'neasden/neasden.php'; $Nn=new Neasden; $Nn->profile_name='kavychki'; return$Nn->format($l1cb25); } function xc0c4($jf2ffc,$l1cb25,$k5c18e){ include_once 'neasden/neasden.php'; if ($l1cb25==='') return array (); if ($jf2ffc=='calliope'){ preg_match_all('/\(\(([^ ]*)( |\)\))/',$l1cb25,$z9c28d); return $z9c28d[1]; } elseif ($jf2ffc=='neasden'){ $Nn=new Neasden; $Nn->profile_name=$k5c18e; $Nn->format($l1cb25); return$Nn->resources_detected; } else { return array (); } } function b154e($jf2ffc,$l1cb25,$k5c18e){ include_once 'neasden/neasden.php'; if(Log::$ped2b5)__log('Format: format with formatter "'. $jf2ffc .'" in context "'. $k5c18e.'"'); if ($jf2ffc=='calliope'){ $l1cb25=pedd9($l1cb25); $l1cb25=k5599($l1cb25,$k5c18e); $meta=array(); $l1cb25=ufd97($l1cb25); $l1cb25='<div class="e2-text-calliope-formatted">'. z6f10($l1cb25) .'</div>'; } elseif ($jf2ffc=='neasden'){ $Nn=new Neasden; $Nn->profile_name=$k5c18e; $l1cb25=$Nn->format($l1cb25); $meta=array ( 'links-required' => $Nn->links_required, 'resources-detected' => $Nn->resources_detected ); } return array ( 'text-final' => $l1cb25, 'meta' => $meta, ); } function db7f1($l1cb25,$k5c18e){ global$_config; return b154e($_config['default_formatter'],$l1cb25,$k5c18e); } function k5599($l1cb25,$k5c18e){ global$_config,$settings,$full_blog_url,$_template; @ (list ($k5c18e,$ze8fab)=explode('|',$k5c18e)); require_once 'calliope/WikiFormatter.php'; if ('full'==$k5c18e)$cad910=WF_FULL_MODE; elseif ('full-rss'==$k5c18e)$cad910=WF_FULL_MODE; elseif ('simple'==$k5c18e)$cad910=WF_SIMPLE_MODE; elseif ('simple-rss'==$k5c18e)$cad910=WF_SIMPLE_MODE; else return $l1cb25; $a0a1d3=new WikiFormatter(); $a0a1d3 -> replace=array ( '/' => 'i', '+' => 'small', '-' => 's', '*' => 'b', '^' => 'sup', 'v' => 'sub', '#' => 'tt', '!' => 'blockquote', ); $a0a1d3 -> settings=array ( 'hrefSize' => 100, 'localImgDir' => $full_blog_url .'/'. PICTURES_FOLDER, 'maxImgWidth' => $_template['max_image_width'], 'mode' => $cad910, 'enableShrinkLongHref' => 1, 'enableHr' => 0, 'enableBr' => 1, 'enableHeaders' => 1, 'headersStartWith' => 1, 'enableTables' => 1, 'simpleTableCSSClass' => 'e2-text-table', 'enableAutoAcronymEngine' => 0, 'enableAcronym' => 0, 'acronymBase' => '', 'enableList' => 1, 'mailSafe' => "<a href=\"\" onmouseover=\"this.href='mailto:'+{email}\">{icon}<script language=\"JavaScript\">document.write({name});</script></a>", 'ljUserTag' => '<a href="http://livejournal.com/users/{name}/">{name}</a>', 'fullVersionURL' => $ze8fab, 'enableTagIcons' => 0, 'outerUrlInNewWindow' => 0, 'lineBreak' => "\n", 'extLinkHrefPrefix' => '', ); $l1cb25=$a0a1d3 -> Wiki2HTML($l1cb25); return $l1cb25; } function ecc38($y572d4){ if(Log::$ped2b5)__log('Spawn: Curl '. $y572d4 .'...'); if(function_exists('curl_init')) { $kf6e57=curl_init(); $f80e25=!ini_get('open_basedir'); curl_setopt_array($kf6e57, array ( CURLOPT_URL => $y572d4, CURLOPT_CONNECTTIMEOUT => 300, CURLOPT_TIMEOUT => 1, CURLOPT_MAXREDIRS => 1, CURLOPT_COOKIE => jc3fb(), CURLOPT_SSL_VERIFYPEER => false, CURLOPT_FOLLOWLOCATION => $f80e25, CURLOPT_RETURNTRANSFER => true, CURLOPT_AUTOREFERER => true, CURLOPT_USERAGENT => E2_UA_STRING, )); $content=curl_exec($kf6e57); $a70106=curl_errno($kf6e57); $l809b1=curl_error($kf6e57); $o099fb=curl_getinfo($kf6e57); curl_close($kf6e57); if(Log::$ped2b5)__log('Spawn: Curl returns: ['. print_r($o099fb,true) .'] ['. $content .'], (errno='. $a70106 .', errstr='. $l809b1 .')...'); } else { if(Log::$ped2b5)__log('Spawn: Curl functions are not available'); } } function r5b68($qea59a){ global$_config; if (@$_config['broadcast_url'] and !$qea59a['IsExternal']) { if($_config['log_broadcast']) { Log::$ped2b5=true; if(Log::$ped2b5)y714a('broadcast'); } if(Log::$ped2b5)__log('Broadcast-async note: '. $qea59a['Title']); $y572d4=d83c8('e2m_note_broadcast', array ('*note' => $qea59a)); if(Log::$ped2b5)__log('Broadcast will spawn url: '. $y572d4); ecc38($y572d4); } } function i0d22($ccffbb){ global$_config; if (!$ccffbb) return false; $y572d4=$_config['broadcast_url']; $y572d4.='?src='. urlencode($ccffbb); if($_config['log_broadcast']) { Log::$ped2b5=true; if(Log::$ped2b5)y714a('broadcast'); } if(Log::$ped2b5)__log('Broadcast: Curl '. $y572d4 .'...'); if(function_exists('curl_init')) { $kf6e57=curl_init(); $f80e25=!ini_get('open_basedir'); curl_setopt_array($kf6e57, array ( CURLOPT_URL => $y572d4, CURLOPT_CONNECTTIMEOUT => 300, CURLOPT_TIMEOUT => 1, CURLOPT_MAXREDIRS => 1, CURLOPT_COOKIE => jc3fb(), CURLOPT_SSL_VERIFYPEER => false, CURLOPT_FOLLOWLOCATION => $f80e25, CURLOPT_RETURNTRANSFER => true, CURLOPT_AUTOREFERER => true, CURLOPT_USERAGENT => E2_UA_STRING, )); $content=curl_exec($kf6e57); $a70106=curl_errno($kf6e57); $l809b1=curl_error($kf6e57); $o099fb=curl_getinfo($kf6e57); curl_close($kf6e57); if(Log::$ped2b5)__log('Broadcast: Curl returns: ['. print_r($o099fb,true) .'] ['. $content .'], (errno='. $a70106 .', errstr='. $l809b1 .')...'); if ($a70106===0) return true; } else { if(Log::$ped2b5)__log('Spawn: Curl functions are not available'); } return false; } function meb3b($qea59a){ if (!$qea59a) return false; $ccffbb=d83c8('e2m_note_json', array ('*note' => $qea59a)); return i0d22($ccffbb); } function e2m_note_broadcast($parameters=array ()) { global$_config; if (@$_config['broadcast_url']) { if(array_key_exists('*note',$parameters)) { $ccffbb=d83c8('e2m_note_json', array ('*note' => $parameters['*note'])); } elseif(array_key_exists('alias',$parameters)) { $ccffbb=d83c8('e2m_note_json', array ('alias' => $parameters['alias'])); } if (i0d22($ccffbb)) { die ('Broadcasted.'); } } else { return e2_error404_mode(); } } function e2m_timezone(){ global$_strings,$settings; $ede2fd=array ( 'form-action' => d83c8('e2s_select_timezone'), 'submit-text' => $_strings['fb--select'], 'timezone-selector' => g9fe5($settings['timezone']['offset'],1), 'dst?' => $settings['timezone']['is_dst'], ); return array ( 'title' => $_strings['pt--default-timezone'], 'heading' => $_strings['pt--default-timezone'], 'form' => 'form-timezone', 'form-timezone' => $ede2fd, ); } function e4c37(){ global$_strings; $q5cacd=array ( -720 => '', -660 => '', -600 => '', -540 => '', -480 => $_strings['tt--zone-pt'], -420 => $_strings['tt--zone-mt'], -360 => $_strings['tt--zone-ct'], -300 => $_strings['tt--zone-et'], -240 => '', -210 => '', -180 => '', -120 => '', -60 => '', 0 => $_strings['tt--zone-gmt'], 60 => $_strings['tt--zone-cet'], 120 => $_strings['tt--zone-eet'], 180 => '', 210 => '', 240 => $_strings['tt--zone-msk'], 270 => '', 300 => '', 330 => '', 345 => '', 360 => $_strings['tt--zone-ekt'], 390 => '', 420 => '', 480 => '', 540 => '', 570 => '', 600 => '', 660 => '', 720 => '', 780 => '', 840 => '', ); return $q5cacd; } function e82a3($m7a86c){ $q5cacd=e4c37(); return @$q5cacd[(int)$m7a86c/SECONDS_IN_A_MINUTE]; } function e9515($m7a86c){ $x04b29='+'; if ($m7a86c < 0)$x04b29='&ndash;'; $m73cdd=str_pad((int) (abs($m7a86c)/3600),2,'0',STR_PAD_LEFT); $c640fd=str_pad(abs($m7a86c)/60 % 60,2,'0',STR_PAD_LEFT); return 'GMT'. $x04b29.$m73cdd .':'. $c640fd; } function g9fe5($q0743a,$v5784d=''){ global$_strings; $q5cacd=e4c37(); $z2cb9d=''; if (!$v5784d)$v5784d=count($q5cacd); $z2cb9d.='<select class="e2-select" name="offset" size="'. $v5784d .'">'; foreach ($q5cacd as $m7a86c => $d83bce){ $xc03a8=''; if ($m7a86c*SECONDS_IN_A_MINUTE==$q0743a)$xc03a8=' selected="selected"'; $z2cb9d.='<option'. $xc03a8 .' value="'.$m7a86c.'">'; $x04b29=''; if ($m7a86c < 0)$x04b29='−'; if ($m7a86c > 0)$x04b29='+'; $m73cdd=(int) (abs($m7a86c*SECONDS_IN_A_MINUTE)/3600); $c640fd=(int) (abs($m7a86c*SECONDS_IN_A_MINUTE)/60 % 60); if ($m73cdd){ $z2cb9d .= ( $x04b29 .' '. $m73cdd .' '. $_strings['gs--timezone-offset-hours'] .' '. ($c640fd? ($c640fd .' '. $_strings['gs--timezone-offset-minutes']) : '') ); if ($d83bce){ $z2cb9d .= ' ('. $d83bce. ')'; } } else { $z2cb9d .= $d83bce; } $z2cb9d.='</option>'; } $z2cb9d.='</select>'; return $z2cb9d; } function e2s_select_timezone(){ global$settings,$_strings; if (@$_POST['offset'] >= -720 and @$_POST['offset'] <= 780){ $settings['timezone']['offset'] = @$_POST['offset']*SECONDS_IN_A_MINUTE; $settings['timezone']['is_dst'] = isset ($_POST['is_dst']); } if (!@n6e52(USER_FOLDER.'settings.json',json_encode($settings,E2_JSON_STYLE))) { x8a40($_strings['er--settings-not-saved'],E2E_PERMISSIONS_ERROR); e2_go_to(d83c8('e2m_timezone')); die; } e2_go_to(d83c8('e2m_settings')) and die (); } function e0923($taad65){ return array ( 'offset' => (int)$taad65['Offset'], 'is_dst' => (bool)$taad65['IsDST'], ); } function d3211(){ return array ( 'offset' => 0, 'is_dst' => false, ); } function f5c05(){ global$settings; if(array_key_exists('timezone',$settings)) { return$settings['timezone']; } else { return d3211(); } } function j7770($xb2c6c,$mdf491){ if (@$xb2c6c['is_dst']) { $w30481=(int)date('I',$mdf491); $e6b7ea=date('Z',$mdf491)-$w30481*SECONDS_IN_AN_HOUR; $c3e61a=$xb2c6c['offset']; $l178ae=$c3e61a-$e6b7ea; $w75b02=date('I',$mdf491+$l178ae); return $w75b02; } else { return 0; } } function ib2bf($xb2c6c,$mdf491){ global$settings; if ($xb2c6c and is_array($xb2c6c)) { return ( $xb2c6c['offset'] + j7770($xb2c6c,$mdf491)*SECONDS_IN_AN_HOUR ); } } function u8afe($mdf491){ return ib2bf(f5c05(),$mdf491); } function e5a2f($z1ddcb,$f4a202,$xb2c6c){ return gmdate($z1ddcb,$f4a202+ib2bf($xb2c6c,$f4a202)); } function ua846($z1ddcb,$f4a202){ return e5a2f($z1ddcb,$f4a202,f5c05()); } function p66cd($q41529,$s6f8f5=false,$q8277e=false){ if(is_numeric($q8277e)) { $wea2b2=gmmktime(0,0,0,$s6f8f5,$q8277e,$q41529); $t7f021=gmmktime(0,0,0,$s6f8f5,$q8277e+1,$q41529)-1; } elseif(is_numeric($s6f8f5)) { $wea2b2=gmmktime(0,0,0,$s6f8f5,1,$q41529); $t7f021=gmmktime(0,0,0,$s6f8f5+1,1,$q41529)-1; } else { $wea2b2=gmmktime(0,0,0,1,1,$q41529); $t7f021=gmmktime(0,0,0,1,1,$q41529+1)-1; } return array ($wea2b2,$t7f021); } function z2143($xb2c6c,$q41529,$s6f8f5=false,$q8277e=false){ list ($wea2b2,$t7f021)=p66cd($q41529,$s6f8f5,$q8277e); $wea2b2 -= ib2bf($xb2c6c,$wea2b2); $t7f021 -= ib2bf($xb2c6c,$t7f021); return array ($wea2b2,$t7f021); } function aac5b($q41529,$s6f8f5=false,$q8277e=false){ return z2143(f5c05(),$q41529,$s6f8f5,$q8277e); } function f5273($q41529,$s6f8f5=false,$q8277e=false){ $g32038=13; $qda4f0=-12; $g32038+=1; $qda4f0 -= 1; list ($wea2b2,$t7f021)=p66cd($q41529,$s6f8f5,$q8277e); $wea2b2 -= $g32038*3600; $t7f021 -= $qda4f0*3600; return array ($wea2b2,$t7f021); } function od17a($m7a86c){ if ((int) @$m7a86c > 0) return (string)'+'.abs(@$m7a86c); elseif ((int) @$m7a86c < 0) return (string)'-'.abs(@$m7a86c); else return ''; } function ud536($mdf491,$xa0f0b=''){ $f2ab64=u8afe($mdf491); $x04b29=($f2ab64 >= 0)?'+':'-'; $f2ab64=abs($f2ab64); $g03c7c=$f2ab64 % 60; $f2ab64 -= $g03c7c; $s6f8f5=$f2ab64 % 3600/60; $f2ab64 -= $s6f8f5*60; $x2510c=$f2ab64/3600; if ($x2510c < 10)$x2510c='0'.$x2510c; if ($s6f8f5 < 10)$s6f8f5='0'.$s6f8f5; return $x04b29.$x2510c.$xa0f0b.$s6f8f5; } function la618($waa759){ global$settings; if(is_numeric($waa759)) { $result['offset']=SECONDS_IN_A_MINUTE*$waa759; $result['is_dst']=false; $jd8935=SECONDS_IN_A_MINUTE*$waa759-SECONDS_IN_AN_HOUR; $ra6cfc=array ('offset' => $jd8935,'is_dst' => true); $ra6cfc=(int)ib2bf($ra6cfc,time()); if($result['offset']==$ra6cfc){ $result['offset']=$jd8935; $result['is_dst']=true; } } else { if(array_key_exists('timezone',$settings)) { $result=$settings['timezone']; } else { $result['offset']=0; $result['is_dst']=false; } } return$result; } function v692f($w96b8c){ $x2510c=ua846('H',$w96b8c); if ($x2510c <= 4) return 4; elseif ($x2510c <= 10) return 1; elseif ($x2510c <= 16) return 2; elseif ($x2510c <= 22) return 3; else return 4; } function t7a0b($b0e524,$ab65f7=null){ global$_strings; if ($ab65f7===null)$ab65f7=f5c05(); $hdb42a=e5a2f('d.m.Y',$q97bc5,$ab65f7); $v33284=e5a2f('d.m.Y',$b0e524,$ab65f7); $xed79a=SECONDS_IN_A_MINUTE; $y77cbc=SECONDS_IN_AN_HOUR; $q97bc5=time(); $h0b375=v692f($q97bc5); $f3dfda=v692f($b0e524); $j74459=$q97bc5-$b0e524; if ($j74459 < 0) return$_strings['tt--from-the-future']; if ($j74459 >= 0 and $j74459 < 54) return$_strings['tt--just-now']; if ($j74459 >= 54 and $j74459 < 108) return$_strings['tt--one-minute-ago']; $v7eccb=$j74459+12; $w7828e=floor($v7eccb/$xed79a); if ($j74459 >= 108 and $j74459 < 54*$xed79a) return e2l_get_string( 'tt--minutes-ago', array ('minutes' => $w7828e) ); if ($j74459 >= 54*$xed79a and $j74459 < 108*$xed79a) return$_strings['tt--one-hour-ago']; $v7eccb=$j74459+12*$xed79a; $o6b497=floor($v7eccb/$y77cbc); if ($j74459 >= 108*$xed79a and $j74459 < 4*$y77cbc) return e2l_get_string( 'tt--hours-ago', array ('hours' => $o6b497) ); $q07cc6=e5a2f('G:i',$b0e524,$ab65f7); if ($j74459 >= 4*$y77cbc and $h0b375 > $f3dfda and $hdb42a==$v33284){ return$_strings['tt--today']; } if ((($q97bc5-$b0e524) <= 7884000)) { return e2l_get_string( 'tt--date', array ( 'day' => e5a2f('j',$b0e524,$ab65f7), 'month' => e5a2f('m',$b0e524,$ab65f7), ) ); } return e5a2f('Y',$b0e524,$ab65f7); } function o9093($b0e524,$ab65f7=null){ global$_strings; $j74459=time()-$b0e524; if ($j74459 < 0) return ''; if ($j74459==0) return$_strings['tt--now']; $nb98b3=array ( array (1,'tt--seconds-short'), array (SECONDS_IN_A_MINUTE,'tt--minutes-short'), array (SECONDS_IN_AN_HOUR,'tt--hours-short'), array (SECONDS_IN_A_DAY,'tt--days-short'), array (SECONDS_IN_A_MONTH,'tt--months-short'), array (SECONDS_IN_A_YEAR,'tt--years-short'), array (SECONDS_IN_A_YEAR+SECONDS_IN_A_MONTH,''), ); for ($d865c0=0; $d865c0 < count($nb98b3); ++ $d865c0){ if ($j74459 >= $nb98b3[$d865c0][0] and $j74459 < $nb98b3[$d865c0+1][0]) { return e2l_get_string( $nb98b3[$d865c0][1], array ('value' => floor($j74459/$nb98b3[$d865c0][0])) ); } } if ($ab65f7===null)$ab65f7=f5c05(); return e5a2f('Y',$b0e524,$ab65f7); } $_model_contractions=array ( 'key' => "INT UNSIGNED AUTO_INCREMENT PRIMARY KEY", 'pkey' => "INT UNSIGNED DEFAULT '0' NOT NULL", 'int' => "INT DEFAULT '0' NOT NULL", 'uint' => "INT UNSIGNED DEFAULT '0' NOT NULL", 'time' => "INT UNSIGNED DEFAULT '0' NOT NULL", '0' => "TINYINT(1) DEFAULT '0' NOT NULL", '1' => "TINYINT(1) DEFAULT '1' NOT NULL", 'v1' => "VARCHAR(1) DEFAULT '' NOT NULL", 'v8' => "VARCHAR(8) DEFAULT '' NOT NULL", 'v15' => "VARCHAR(15) DEFAULT '' NOT NULL", 'v32' => "VARCHAR(32) DEFAULT '' NOT NULL", 'v64' => "VARCHAR(64) DEFAULT '' NOT NULL", 'fid' => "VARCHAR(32) DEFAULT '". $_config['default_formatter'] ."' NOT NULL", 'v255' => "VARCHAR(255) DEFAULT '' NOT NULL", 'text' => "MEDIUMTEXT", ); $_model=array ( 'Actions' => array ( array ('ID', 'key'), array ('SubsetID', 'pkey'), array ('EntityID', 'pkey'), array ('Stamp', 'time'), array ('ReadCount', 'int'), ), 'Aliases' => array ( array ('ID', 'key'), array ('SubsetID', 'pkey'), array ('EntityType', 'v1'), array ('EntityID', 'pkey'), array ('Alias', 'v64'), array ('Stamp', 'time'), ), 'Comments' => array ( array ('ID', 'key'), array ('SubsetID', 'pkey'), array ('NoteID', 'pkey'), array ('AuthorName', 'v255'), array ('AuthorEmail', 'v255'), array ('Text', 'text'), array ('Reply', 'text'), array ('IsVisible', '1'), array ('IsFavourite', '0'), array ('IsReplyVisible', '0'), array ('IsReplyFavourite', '0'), array ('IsAnswerAware', '1'), array ('IsSubscriber', '0'), array ('IsSpamSuspect', '0'), array ('IsNew', '0'), array ('Stamp', 'time'), array ('LastModified', 'time'), array ('ReplyStamp', 'time'), array ('ReplyLastModified', 'time'), array ('IP', 'v15'), array ('IsGIPUsed', '0'), array ('GIP', 'v15'), array ('GIPAuthorID', 'v64'), ), 'Keywords' => array ( array ('ID', 'key'), array ('SubsetID', 'pkey'), array ('Keyword', 'v255'), array ('OriginalAlias', 'v64'), array ('PageTitle', 'v255'), array ('Description', 'text'), array ('Uploads', 'text'), array ('IsFavourite', '0'), ), 'Notes' => array ( array ('ID', 'key'), array ('SubsetID', 'pkey'), array ('Title', 'v255'), array ('Text', 'text'), array ('FormatterID', 'fid'), array ('OriginalAlias', 'v64'), array ('Uploads', 'text'), array ('IsPublished', '0'), array ('IsCommentable', '0'), array ('IsVisible', '1'), array ('IsFavourite', '0'), array ('Stamp', 'time'), array ('LastModified', 'time'), array ('Offset', 'int'), array ('IsDST', '0'), array ('IsIndexed', '0'), array ('IsExternal', '0'), array ('SourceID', 'pkey'), array ('SourceNoteID', 'pkey'), array ('SourceNoteURL', 'v255'), array ('SourceNoteJSONURL', 'v255'), array ('SourceNoteData', 'text'), ), 'NotesKeywords' => array ( array ('ID', 'key'), array ('SubsetID', 'pkey'), array ('NoteID', 'pkey'), array ('KeywordID', 'pkey'), ), 'GIPsSessions' => array ( array ('ID', 'key'), array ('SubsetID', 'pkey'), array ('GIP', 'v15'), array ('GIPAuthorID', 'v64'), array ('AuthorName', 'v255'), array ('AuthorEmail', 'v255'), array ('AuthorProfileLink', 'v255'), array ('SessionToken', 'v255'), array ('Stamp', 'time'), ), 'Sources' => array ( array ('ID', 'key'), array ('SubsetID', 'pkey'), array ('TrueID', 'pkey'), array ('Title', 'v255'), array ('AuthorName', 'v255'), array ('URL', 'v255'), array ('PictureURL', 'v255'), array ('IsWhiteListed', '0'), array ('IsTrusted', '0'), ), ); $_model_indexes=array ( 'Actions' => array ( "UNIQUE INDEX (`EntityID`, `Stamp`)", ), 'Aliases' => array ( "INDEX (`Alias`)", "INDEX (`EntityID`)", ), 'Comments' => array ( "INDEX (`NoteID`)", ), 'Keywords' => array (), 'GIPsSessions' => array ( "UNIQUE INDEX (`GIP`, `GIPAuthorID`)" ), 'Notes' => array ( "FULLTEXT (`Title`, `Text`)", "INDEX (`Stamp`)", "INDEX (`SourceID`)", "INDEX (`SourceNoteID`)", ), 'NotesKeywords' => array ( "INDEX (`NoteID`)", ), ); $_model_minimal_table_list=array ( 'Comments', 'Keywords', 'Notes', 'NotesKeywords', ); function e2_model_data_check($t11e0e){ global$_db,$_model,$_model_minimal_table_list,$_config; $p08cfc=false; $v35f9b=array(); $pac5c7='SHOW TABLES FROM `'. mysqli_real_escape_string($_db['link'],$t11e0e). '`'; $result=mysqli_query($_db['link'],$pac5c7); if($result){ while ($nf1965=mysqli_fetch_row($result)) { foreach(array_keys($_model) as $cd2ffa){ if(strcasecmp($nf1965[0],$_config['db_table_prefix'].$cd2ffa)===0){ $p08cfc=true; $v35f9b[] = $cd2ffa; } } } } $ud9a22=true; foreach(array_keys($_model) as $cd2ffa){ if (!in_array($cd2ffa,$v35f9b)) { $ud9a22=false; } } $e7ec6f=true; foreach($_model_minimal_table_list as $cd2ffa){ if (!in_array($cd2ffa,$v35f9b)) { $e7ec6f=false; } } return array ( 'occupied' => $p08cfc, 'complete' => $ud9a22, 'migrateable' => $e7ec6f, ); } function ib154($wcf1e8,$see11c,$g5f4dc){ global $h11755; if (($o2a304=mysqli_connect($wcf1e8,$see11c,$g5f4dc)) === false) return []; $ee61ce=[]; $n00a90=[ 'information_schema', 'performance_schema', 'sys', 'mysql' ]; @$h11755 ++; $w1b1cc='SHOW DATABASES'; if(Log::$ped2b5)__log('DB ['. $h11755 .']: '. $w1b1cc); $result=mysqli_query($o2a304,$w1b1cc); while ($nf1965=mysqli_fetch_row($result)) { if(mysqli_select_db($o2a304,$nf1965[0]) and !in_array($nf1965[0],$n00a90)) { $ee61ce[] = $nf1965[0]; } } return $ee61ce; } function e4e1c($paab9e){ global$_config; p0738( "SHOW TABLES LIKE '". $_config['db_table_prefix'].$paab9e . "'" ); $k9b207=g0d6b(); return count($k9b207) > 0; } function z07e3($paab9e,$f851f5=null){ global$_config; if ($f851f5===null){ $f851f5=$_config['db_table_prefix']; } p0738( "SHOW TABLE STATUS LIKE '". $f851f5.$paab9e . "'" ); $result=g0d6b(); return$result?$result[0] : []; } function lf1ac($paab9e){ global$_model,$_model_contractions,$_model_indexes,$_config,$_db; if (!array_key_exists($paab9e,$_model)) throw new AeModelUnknownTableException(); if (e4e1c($paab9e)) return; $f851f5=$_config['db_table_prefix']; $x54ca8=array(); foreach($_model[$paab9e] as $d1afd3){ list ($sb0689,$type)=$d1afd3; $x54ca8[] = "`". $sb0689 ."` ". $_model_contractions[$type]; } p0738( "CREATE TABLE `". $f851f5.$paab9e ."` ". "(". implode(" ,",$x54ca8) .") ". "ENGINE=MyISAM DEFAULT CHARSET=". $_db['charset'] ); if(is_array(@$_model_indexes[$paab9e])) { foreach($_model_indexes[$paab9e] as $m6a992){ p0738( "ALTER TABLE `". $f851f5.$paab9e ."` ". "ADD ". $m6a992 ); } } } function p9943($paab9e,$fde17f,$rb512d='INSERT',$a07ccf=''){ global$_config,$_db; $x8688e['SubsetID']=$_config['db_table_subset']; foreach ($fde17f as $o8ce4b => $l9e366){ $x8688e[$o8ce4b]="'". u7928($l9e366) ."'"; } $wd05b6="`". implode("`, `",array_keys($x8688e)). "`"; $lf09cc=implode(", ",array_values($x8688e)); p0738( $rb512d ." INTO `". $_config['db_table_prefix'].$paab9e ."` ". "(".$wd05b6 .") VALUES (". $lf09cc .")". ($a07ccf? (' '. $a07ccf):'') ); $fde17f['ID']=mysqli_insert_id($_db['link']); return $fde17f; } function kaa79($paab9e,$fde17f,$b7692d=false,$t0f543=false){ global$_config,$_e2_day_numbers_by_note_id; $_e2_day_numbers_by_note_id=[]; if(Log::$ped2b5)__log('Model: update record in table '. $paab9e .' {'); $w6a7f2=array(); foreach(e2model__soft_fields_for_table_($paab9e) as $f06e3d){ if(array_key_exists($f06e3d,$fde17f)) { $w6a7f2[] = '`'. $f06e3d .'`'."='". u7928($fde17f[$f06e3d]) ."'"; } } $sb5b39=array(); if(is_array($b7692d)) { foreach(e2model__soft_fields_for_table_($paab9e) as $f06e3d){ if(array_key_exists($f06e3d,$b7692d)) { $sb5b39[] = '`'. $f06e3d .'`'."='". u7928($b7692d[$f06e3d]) ."'"; } } } if(count($sb5b39)) { $y56790=implode(" AND ",$sb5b39); } else { if (!array_key_exists('ID',$fde17f) or !is_numeric($fde17f['ID'])) { if(Log::$ped2b5)__log('Error: e2_update_record must be called with an ID field in $record when updating single row'); return false; } $y56790="`ID`=". $fde17f['ID']; } if(count($w6a7f2) > 0){ $z91179=$t0f543? 'LOW_PRIORITY ':''; p0738( "UPDATE ". $z91179 ."`". $_config['db_table_prefix'].$paab9e ."` ". "SET ". implode(', ',$w6a7f2) ." ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND (". $y56790 .")" ); } if(Log::$ped2b5)__log('}'); return true; } function e2model__soft_fields_for_table_($paab9e){ global$_model; $z2cb9d=array(); if(array_key_exists($paab9e,$_model)) { foreach($_model[$paab9e] as $f06e3d){ if (!in_array($f06e3d[1], array ('key'))) { $z2cb9d[] = $f06e3d[0]; } } } return $z2cb9d; } function e2m_install(){ global$_strings,$_superconfig,$_files_written,$_diagnose; if (h2ac5()!==null)e2_go_to() and die; qdb82(DEFAULT_TEMPLATE); $z2cb9d=array(); if($_superconfig['disallow_installer']) { die ('Installer disabled by superconfig'); } if(Log::$ped2b5)__log('Installer: not installed, present user with form'); $ye26af=true; $qd77d5['server'] = @$_COOKIE[v8c3b('install_db_server')]; $qd77d5['user_name'] = @$_COOKIE[v8c3b('install_db_user_name')]; $qd77d5['passw']=see85(@$_COOKIE[v8c3b('install_db_passw')]); $qd77d5['name'] = @$_COOKIE[v8c3b('install_db_name')]; if (!@isset ($_diagnose['ok?']))r8739(); if (!$_diagnose['ok?']) { if(Log::$ped2b5)__log('Installer: problems, tell user'); $ye26af=false; } $z2cb9d=[ 'title' => $_strings['pt--install'], 'heading' => $_strings['pt--install'], 'form-install' => [ 'form-action' => d83c8('e2s_install'), 'form-check-db-config-action' => d83c8('e2j_check_db_config'), 'form-list-databases-action' => d83c8('e2j_list_databases'), 'installation-possible?' => $ye26af, 'submit-text' => $_strings['fb--begin'], 'retry-href' => d83c8('e2m_install'), 'retry-text' => $_strings['fb--retry'], 'db-server' => htmlspecialchars(@$qd77d5['server']? $qd77d5['server']:'localhost'), 'db-user' => htmlspecialchars(@$qd77d5['user_name']? $qd77d5['user_name']:'root'), 'db-password' => '', 'db-database' => htmlspecialchars(@$qd77d5['name']), ] ]; return $z2cb9d; } function h2ac5(){ static $t7123a=null; if ($t7123a===null){ $t7123a=@unserialize( @file_get_contents(USER_FOLDER.'instance.psa') ) or $t7123a=null; } return $t7123a; } function m5be8($t2af72){ static $t7123a=null; $t7123a=h2ac5(); $t7123a['version']=$t2af72; if (n6e52(USER_FOLDER. '/instance.psa',serialize($t7123a))) { return $t7123a; } else { die ('Cannot instantiate v'. $t2af72 .': probably permission denied'); } } function e2s_instantiate($parameters){ global$_strings; if (h2ac5()!==null){ die ('Remove the file "'. USER_FOLDER .'instance.psa" first'); } else { if(is_numeric($parameters['version'])) { if (m5be8($parameters['version'])) { x8a40($_strings['gs--instantiated-version'] .' v'. $parameters['version'],E2E_MESSAGE); e2_go_to(d83c8('e2m_frontpage', array ('page' => 1))); die; } } } die ('Could not create instance of engine'); } function e2_install($i8d777){ global$_folders_written,$_strings,$_config,$settings; if (h2ac5()!==null){ throw new AeInstallAlreadyInstalledException('Instance already created'); } if($_config['log_installs']) { Log::$ped2b5=true; if(Log::$ped2b5)y714a('install-$'); } if(Log::$ped2b5)__log('Installer: force directories'); foreach($_folders_written as $c45684){ @caf42($c45684); } if(Log::$ped2b5)__log('Installer: write password hash'); if (!@n6e52(USER_FOLDER.'password-hash.psa',serialize(sha1($i8d777['password'])))) { throw new AePasswordHashNotSavedException; } if(array_key_exists('plain_password',$i8d777['db_params'])) { $i8d777['db_params']['passw']=r1305($i8d777['db_params']['plain_password']); unset ($i8d777['db_params']['plain_password']); } $settings['db']=$i8d777['db_params']; $settings['template']=DEFAULT_TEMPLATE; $settings['language']=DEFAULT_LANGUAGE; h985b('check database during installation',$i8d777['db_params']); $zaae42=e2_model_data_check($i8d777['db_params']['name']); $xf2b28=false; if ($zaae42['occupied']) { if ($zaae42['migrateable'] and $i8d777['allow_migration']) { $xf2b28=true; if(Log::$ped2b5)__log('Installer: data exists and migrateable'); } else { if(Log::$ped2b5)__log('Installer: incomplete data in the database'); throw new AeInstallDatabaseOccupiedException('Database already has some data'); } } if ($xf2b28){ if(Log::$ped2b5)__log('Installer: no need to create tables, will migrate'); try { kbb8d(); } catch (AeMySQLException $e){ e12f6($e,'Could not migrate'); x8a40($_strings['er--double-check-db-params']); } } else { if(Log::$ped2b5)__log('Installer: create tables'); lf1ac('Notes'); lf1ac('Comments'); lf1ac('Keywords'); lf1ac('NotesKeywords'); lf1ac('Aliases'); lf1ac('Actions'); lf1ac('Sources'); lf1ac('GIPsSessions'); } if(Log::$ped2b5)__log('Installer: write settings'); if (!@n6e52(USER_FOLDER.'settings.json',json_encode($settings,E2_JSON_STYLE))) { throw new AeSettingsNotSavedException; } e2_drop_all_kinds_of_cache(); if(Log::$ped2b5)__log('Installer: search index'); $jddece=l476c(); try { $jddece -> erase(); } catch (\S2\Rose\Exception\RuntimeException $e){ if(Log::$ped2b5)__log('Installer: Rose not available'); } u198f(); if(Log::$ped2b5)__log('Installer: instantiate'); m5be8(E2_VERSION); if(Log::$ped2b5)__log('Installer: complete'); } function z91a0(){ $t78940['server']=$t78940['user_name'] = $t78940['passw']=$t78940['name']=''; if(array_key_exists('db-server',$_POST)) $t78940['server']=$_POST['db-server']; if(array_key_exists('db-user',$_POST)) $t78940['user_name']=$_POST['db-user']; if(array_key_exists('db-password',$_POST))$t78940['passw']=$_POST['db-password']; if(array_key_exists('db-database',$_POST))$t78940['name']=$_POST['db-database']; return $t78940; } function e2s_install(){ global$_strings,$_config,$_db; if (h2ac5()!==null)e2_go_to() and die; $t78940=z91a0(); foreach ($t78940 as $o8ce4b => $l9e366){ kc64a('install_db_'. $o8ce4b,$l9e366); } if (!array_key_exists('password',$_POST) or trim($_POST['password']) == ''){ x8a40($_strings['er--no-password-entered'],E2E_USER_ERROR); e2_go_to(d83c8('e2m_install')); die; } $s88162=trim($_POST['password']); @session_start(); $fad3da=false; try { e2_install([ 'allow_migration' => true, 'password' => $s88162, 'db_params' => $t78940, ]); $fad3da=true; } catch (AeMySQLCannotConnectException $e){ x8a40( $_strings['er--cannot-connect-to-db']. ':<br />'. mysqli_connect_error() .' ('. mysqli_connect_errno() .')' ); } catch (AeMySQLTooOldException $e){ x8a40(e2l_get_string('er--mysql-version-too-old', [ 'v1' => $_db['version'], 'v2' => E2_MINIMUM_MYSQL, ])); } catch (AeMySQLException $e){ x8a40($_strings['er--cannot-find-db'] .' '. $t78940['name']); } catch (AeInstallDatabaseOccupiedException $e){ x8a40($_strings['er--db-data-incomplete-install']); } catch (AeNotSavedException $e){ x8a40($_strings['er--settings-not-saved'],E2E_PERMISSIONS_ERROR); } catch (AeInstallException $e){ } if (!$fad3da){ e2_go_to(d83c8('e2m_install')); die; } $k2d6d8['sessions'] = [[ 'stamp' => time(), 'remote_ip' => w1668(), 'key_hash' => ge8ed(true), 'ua' => $_SERVER['HTTP_USER_AGENT'], ]]; if (!p1d21($k2d6d8)) { x8a40($_strings['er--cannot-write-auth-data'],E2E_PERMISSIONS_ERROR); } ecc38(d83c8('e2s_bsi_step', array ())); e2_go_to(); die; } function jd660(){ global $o57de2,$ja57c1,$_superconfig,$_config; $t7123a=h2ac5(); if (h2ac5()!==null){ if(E2_VERSION < $t7123a ['version']) { if (@$_config['dev_ignore_version_mismatch']) return; if(Log::$ped2b5)__log('Installer: cannot downdate'); header('HTTP/1.1 503 Service Unavailable'); die ('E2 does not support automatic downgrade.'); } elseif(E2_VERSION > $t7123a ['version']) { if(Log::$ped2b5)__log('Installer: need to update'); header('Location: http://'. $o57de2.$ja57c1 .'/perform_update/'); header('Location: '. d83c8('e2s_update_perform')); die; } else { return; } } if(Log::$ped2b5)__log('Installer: not installed {'); if ((strpos($_SERVER['SERVER_SOFTWARE'],'Apache')===0)) { if(Log::$ped2b5)__log('Installer: running on Apache'); $mefe79=DEFAULTS_FOLDER.'default.htaccess'; $zd5c54=false; if (!is_file($mefe79)) { echo 'File not found: '.$mefe79. '. Please use the full E2 installation package.'; die; } if(is_file('.htaccess')) { if(Log::$ped2b5)__log('Installer: there is a .htaccess file in the installation directory'); $de6f97=file_get_contents($mefe79); $lc6680=file_get_contents('.htaccess'); if ($lc6680!=$de6f97){ $zd5c54=true; $r6a9d4=$fd1813='.htaccess.old'; $s3c549=1; while (is_file($fd1813)) { $fd1813=$r6a9d4 .'.'. $s3c549 ++; } if(Log::$ped2b5)__log('Installer: existing .htaccess wrong, backing up as <'. $fd1813 .'>'); if (!@rename('.htaccess',$fd1813)) { if(Log::$ped2b5)__log('Installer: fuck'); echo 'Looks like you are using Apache and have put an incorrect ".htaccess" file in the installation directory. Additionally, the installer was not able to back up your existing ".htaccess" file in order to replace it with the correct one. Please use the full E2 installation package and grant write access on the installation target directory, all the files and subdirectories.'; die; } } } else { $zd5c54=true; } if ($zd5c54){ if(Log::$ped2b5)__log('Installer: writing a correct .htaccess file'); if (!@copy($mefe79,'.htaccess')) { if(Log::$ped2b5)__log('Installer: fuck'); echo 'The installer was not able to create a correct ".htaccess" file. Please grant write access on the installation target directory.'; die; } } } if($_superconfig['disallow_installer']) { if(Log::$ped2b5)__log('Installer: disallowed in superconfig'); y4aff(new AeNotAndCannotBeInstalledException); } else { $c601f0=d83c8('e2m_install'); if(Log::$ped2b5)__log('Installer: will need to install, going to '. $c601f0); if(Log::$ped2b5)__log('}'); e2_go_to($c601f0); die; } } function e2j_check_db_config(){ global$_db,$_strings; $t78940=z91a0(); $sd1fc8=[ 'success' => true, 'data' => [ 'message' => '', 'db-responding' => false, 'db-connected' => false, 'db-compatible' => false, 'db-occupied' => false, 'db-migrateable' => false, ] ]; try { $t78940['passw']=r1305($t78940['passw']); h985b('connect to check DB config (try 1)',$t78940); } catch (AeMySQLAccessDeniedException $e){ $sd1fc8['data']['db-responding']=true; $sd1fc8=json_encode($sd1fc8); die ($sd1fc8); } catch (AeMySQLCannotConnectException $e){ $sd1fc8['data']['message']='no-connect'; $sd1fc8=json_encode($sd1fc8); die ($sd1fc8); } catch (AeMySQLTooOldException $e){ $sd1fc8['data']['db-responding']=true; $sd1fc8['data']['db-connected']=true; $sd1fc8['data']['message']=e2l_get_string('er--mysql-version-too-old', [ 'v1' => $_db['version'], 'v2' => E2_MINIMUM_MYSQL, ]); $sd1fc8=json_encode($sd1fc8); die ($sd1fc8); } catch (AeMySQLNotFoundException $e){ $sd1fc8['data']['db-responding']=true; $sd1fc8['data']['db-connected']=true; if (!$t78940['name']) { $ee61ce=ib154( $t78940['server'],$t78940['user_name'],$t78940['passw'] ); if(count($ee61ce) > 0){ $t78940['name']=$ee61ce[0]; } else { $sd1fc8['data']['db-responding']=true; $sd1fc8=json_encode($sd1fc8); die ($sd1fc8); } } } $sd1fc8['data']['db-responding']=true; $sd1fc8['data']['db-connected']=true; $sd1fc8['data']['db-compatible']=true; try { h985b('connect to check DB config (try 2)',$t78940); } catch (AeMySQLException $e){ $sd1fc8=json_encode($sd1fc8); die ($sd1fc8); } $sd1fc8['data']['db-good']=true; $zaae42=e2_model_data_check($t78940['name']); if ($zaae42['occupied']) { if ($zaae42['migrateable']) { $sd1fc8['data']['message']=$_strings['gs--data-exists']; } else { $sd1fc8['data']['db-good']=false; $sd1fc8['data']['message']=$_strings['er--db-data-incomplete-install']; } } $sd1fc8=json_encode($sd1fc8); die ($sd1fc8); } function e2j_list_databases(){ $t78940=z91a0(); $ee61ce=ib154( $t78940['server'],$t78940['user_name'],$t78940['passw'] ); $sd1fc8=[ 'success' => true, 'data' => [ 'databases-list' => $ee61ce, ] ]; $sd1fc8=json_encode($sd1fc8); die ($sd1fc8); } function kbb8d(){ global$_db,$_config,$_model; $f851f5=$_config['db_table_prefix']; p0738('SET sql_quote_show_create=1'); if($_db['charset']==='utf8mb4'){ if(Log::$ped2b5)__log('Convert tables to utf8 or utf8mb4 {'); lb01c($f851f5); if(Log::$ped2b5)__log('}'); } else { if(Log::$ped2b5)__log('Convert tables to utf8 or utf8 {'); ddb59($f851f5); if(Log::$ped2b5)__log('}'); } if(Log::$ped2b5)__log('Get existing table information {'); foreach(array_keys($_model) as $paab9e){ lf1ac($paab9e); try { p0738("SHOW CREATE TABLE `". $f851f5.$paab9e ."`"); $s4fded[$paab9e]=g0d6b(); $s4fded[$paab9e]=$s4fded[$paab9e][0]['Create Table']; } catch (AeMySQLException $e){ e12f6($e); die ('Database table "'. $f851f5 .$paab9e .'" not accessible during migration. Check your database availability'); } p0738("SHOW INDEX FROM `". $f851f5.$paab9e ."`"); $n62699=g0d6b(); $u43eef=array(); foreach ($n62699 as $m6a992){ $m6a992=$m6a992['Key_name']; if(preg_match('/\_[0-9]+$/',$m6a992)) { $u43eef[] = 'DROP INDEX '. $m6a992; } } if(count($u43eef)) { $u43eef=implode(', ',array_unique($u43eef)); p0738( "ALTER TABLE  `". $f851f5.$paab9e ."` ". $u43eef ); } } if(Log::$ped2b5)__log('}'); if (!strstr($s4fded['Notes'],'`FormatterID`')) { p0738( "ALTER TABLE `". $f851f5."Notes` ". "ADD `FormatterID` VARCHAR( 32 ) DEFAULT 'calliope' NOT NULL AFTER `Text`" ); } if (!strstr($s4fded['Notes'],'`OriginalAlias`')) { p0738( "ALTER TABLE `". $f851f5."Notes` ". "CHANGE `URLName` `OriginalAlias` VARCHAR( 64 ) DEFAULT '' NOT NULL AFTER `FormatterID`" ); } if (!strstr($s4fded['Notes'],'KEY `Stamp` (`Stamp`)')) { p0738( "ALTER TABLE `". $f851f5."Notes` ". "ADD INDEX (`Stamp`);" ); } if(strstr($s4fded['Notes'],'`IP`')) { p0738( "ALTER TABLE `". $f851f5."Notes` ". "DROP `IP`" ); } if (!stristr($s4fded['Notes'],'`Text` MEDIUMTEXT')) { p0738( "ALTER TABLE `". $f851f5."Notes` ". "CHANGE `Text` `Text` MEDIUMTEXT" ); } if (!strstr($s4fded['Notes'],'`IsIndexed`')) { p0738( "ALTER TABLE `". $f851f5."Notes` ". "ADD `IsIndexed` TINYINT( 1 ) DEFAULT '0' NOT NULL AFTER `IsDST`" ); } if (!strstr($s4fded['Notes'],'`Uploads`')) { p0738( "ALTER TABLE `". $f851f5."Notes` ". "ADD `Uploads` MEDIUMTEXT AFTER `OriginalAlias`" ); } if (!stristr($s4fded['Notes'],'`Uploads` MEDIUMTEXT')) { p0738( "ALTER TABLE `". $f851f5."Notes` ". "CHANGE `Uploads` `Uploads` MEDIUMTEXT" ); } if (!strstr($s4fded['Notes'],'`IsExternal`')) { p0738( "ALTER TABLE `". $f851f5."Notes` ". "ADD `IsExternal` TINYINT(1) DEFAULT '0' NOT NULL AFTER `IsIndexed`" ); } if (!strstr($s4fded['Notes'],'`SourceID`')) { p0738( "ALTER TABLE `". $f851f5."Notes` ". "ADD `SourceID` INT UNSIGNED DEFAULT '0' NOT NULL AFTER `IsExternal`" ); } if (!strstr($s4fded['Notes'],'`SourceNoteID`')) { p0738( "ALTER TABLE `". $f851f5."Notes` ". "ADD `SourceNoteID` INT UNSIGNED DEFAULT '0' NOT NULL AFTER `SourceID`" ); } if (!strstr($s4fded['Notes'],'`SourceNoteURL`')) { p0738( "ALTER TABLE `". $f851f5."Notes` ". "ADD `SourceNoteURL` VARCHAR(255) DEFAULT '' NOT NULL AFTER `SourceNoteID`" ); } if (!strstr($s4fded['Notes'],'`SourceNoteData`')) { p0738( "ALTER TABLE `". $f851f5."Notes` ". "ADD `SourceNoteData` MEDIUMTEXT AFTER `SourceNoteURL`" ); } if (!strstr($s4fded['Notes'],'`SourceNoteJSONURL`')) { p0738( "ALTER TABLE `". $f851f5."Notes` ". "ADD `SourceNoteJSONURL` VARCHAR(255) DEFAULT '' NOT NULL AFTER `SourceNoteData`" ); } if(strstr($s4fded['Notes'],'`SourceMainImageURL`')) { p0738( "ALTER TABLE `". $f851f5."Notes` ". "DROP `SourceMainImageURL`" ); } if (!strstr($s4fded['Notes'],'`SubsetID`')) { p0738( "ALTER TABLE `". $f851f5."Notes` ". "ADD `SubsetID` INT UNSIGNED DEFAULT '0' NOT NULL AFTER `ID`" ); } if(strstr($s4fded['Notes'],'`IsIssue`')) { p0738( "ALTER TABLE `". $f851f5."Notes` ". "DROP `IsIssue`" ); } if (!strstr($s4fded['Notes'],'KEY `SourceID` (`SourceID`)')) { p0738( "ALTER TABLE `". $f851f5."Notes` ". "ADD INDEX (`SourceID`);" ); } if (!strstr($s4fded['Notes'],'KEY `SourceNoteID` (`SourceNoteID`)')) { p0738( "ALTER TABLE `". $f851f5."Notes` ". "ADD INDEX (`SourceNoteID`);" ); } if (!strstr($s4fded['Comments'],'KEY `NoteID` (`NoteID`)')) { p0738( "ALTER TABLE `". $f851f5."Comments` ". "ADD INDEX (`NoteID`);" ); } if (!stristr($s4fded['Comments'],'`Text` MEDIUMTEXT')) { p0738( "ALTER TABLE `". $f851f5."Comments` ". "CHANGE `Text` `Text` MEDIUMTEXT" ); } if (!stristr($s4fded['Comments'],'`Reply` MEDIUMTEXT')) { p0738( "ALTER TABLE `". $f851f5."Comments` ". "CHANGE `Reply` `Reply` MEDIUMTEXT" ); } if (!strstr($s4fded['Comments'],'`IsGIPUsed`')) { p0738( "ALTER TABLE `". $f851f5."Comments` ". "ADD `IsGIPUsed` TINYINT(1) DEFAULT '0' NOT NULL AFTER `IP`" ); } if (!strstr($s4fded['Comments'],'`GIP`')) { p0738( "ALTER TABLE `". $f851f5."Comments` ". "ADD `GIP` VARCHAR(15) DEFAULT '' NOT NULL AFTER `IsGIPUsed`" ); } if (!strstr($s4fded['Comments'],'`GIPAuthorID`')) { p0738( "ALTER TABLE `". $f851f5."Comments` ". "ADD `GIPAuthorID` VARCHAR(64) DEFAULT '' NOT NULL AFTER `GIP`" ); } if (!strstr($s4fded['Comments'],'`SubsetID`')) { p0738( "ALTER TABLE `". $f851f5."Comments` ". "ADD `SubsetID` INT UNSIGNED DEFAULT '0' NOT NULL AFTER `ID`" ); } if(strstr($s4fded['Comments'],'`SocialType`')) { p0738( "ALTER TABLE `". $f851f5."Comments` ". "DROP `SocialType`" ); } if(strstr($s4fded['Comments'],'`SocialID`')) { p0738( "ALTER TABLE `". $f851f5."Comments` ". "DROP `SocialID`" ); } if (!strstr($s4fded['Keywords'],'`OriginalAlias`')) { p0738( "ALTER TABLE `". $f851f5."Keywords` ". "CHANGE `URLName` `OriginalAlias` VARCHAR( 64 ) DEFAULT '' NOT NULL AFTER `Keyword`" ); } if (!stristr($s4fded['Keywords'],'`Description` MEDIUMTEXT')) { p0738( "ALTER TABLE `". $f851f5."Keywords` ". "CHANGE `Description` `Description` MEDIUMTEXT" ); } if (!strstr($s4fded['Keywords'],'`Uploads`')) { p0738( "ALTER TABLE `". $f851f5."Keywords` ". "ADD `Uploads` MEDIUMTEXT AFTER `Description`" ); } if (!strstr($s4fded['Keywords'],'`SubsetID`')) { p0738( "ALTER TABLE `". $f851f5."Keywords` ". "ADD `SubsetID` INT UNSIGNED DEFAULT '0' NOT NULL AFTER `ID`" ); } if (!strstr($s4fded['Keywords'],'`PageTitle`')) { p0738( "ALTER TABLE `". $f851f5."Keywords` ". "ADD `PageTitle` VARCHAR(255) DEFAULT '' NOT NULL AFTER `OriginalAlias`" ); } if (!stristr($s4fded['Keywords'],'`Uploads` MEDIUMTEXT')) { p0738( "ALTER TABLE `". $f851f5."Keywords` ". "CHANGE `Uploads` `Uploads` MEDIUMTEXT" ); } if(strstr($s4fded['Keywords'],'`ParentKeywordID`')) { p0738( "ALTER TABLE `". $f851f5."Keywords` ". "DROP `ParentKeywordID`" ); } if (!strstr($s4fded['NotesKeywords'],'`SubsetID`')) { p0738( "ALTER TABLE `". $f851f5."NotesKeywords` ". "ADD `SubsetID` INT UNSIGNED DEFAULT '0' NOT NULL AFTER `ID`" ); } if (!strstr($s4fded['Aliases'],'KEY `Alias` (`Alias`)')) { p0738( "ALTER TABLE `". $f851f5."Aliases` ". "ADD INDEX (`Alias`);" ); } if (!strstr($s4fded['Aliases'],'KEY `EntityID` (`EntityID`)')) { p0738( "ALTER TABLE `". $f851f5."Aliases` ". "ADD INDEX (`EntityID`);" ); } if (!strstr($s4fded['Aliases'],'`EntityType`')) { p0738( "ALTER TABLE `". $f851f5."Aliases` ". "ADD `EntityType` VARCHAR( 1 ) DEFAULT '' NOT NULL AFTER `ID`" ); } if (!strstr($s4fded['Aliases'],'`SubsetID`')) { p0738( "ALTER TABLE `". $f851f5."Aliases` ". "ADD `SubsetID` INT UNSIGNED DEFAULT '0' NOT NULL AFTER `ID`" ); } p0738( "UPDATE `". $f851f5."Aliases` ". "SET `EntityType` = 'n' ". "WHERE `EntityType` = ''" ); if (!strstr($s4fded['Actions'],'`ReadCount`')) { p0738( "ALTER TABLE `". $f851f5."Actions` ". "ADD `ReadCount` INT DEFAULT '0' NOT NULL" ); } if (!strstr($s4fded['Actions'],'`SubsetID`')) { p0738( "ALTER TABLE `". $f851f5."Actions` ". "ADD `SubsetID` INT UNSIGNED DEFAULT '0' NOT NULL AFTER `ID`" ); } if(strstr($s4fded['Actions'],'`HitCount`')) { p0738( "ALTER TABLE `". $f851f5."Actions` ". "DROP `HitCount`" ); p0738( "DELETE FROM `". $f851f5."Actions` ". "WHERE `ReadCount` = 0" ); } if (!strstr($s4fded['GIPsSessions'],'`AuthorEmail`')) { p0738( "ALTER TABLE `". $f851f5."GIPsSessions` ". "ADD `AuthorEmail` VARCHAR(255) DEFAULT '' NOT NULL AFTER `AuthorName`" ); } if (!strstr($s4fded['GIPsSessions'],'`AuthorProfileLink`')) { p0738( "ALTER TABLE `". $f851f5."GIPsSessions` ". "ADD `AuthorProfileLink` VARCHAR(255) DEFAULT '' NOT NULL AFTER `AuthorEmail`" ); } if (!strstr($s4fded['GIPsSessions'],'`SubsetID`')) { p0738( "ALTER TABLE `". $f851f5."GIPsSessions` ". "ADD `SubsetID` INT UNSIGNED DEFAULT '0' NOT NULL AFTER `ID`" ); } if (!strstr($s4fded['Sources'],'`TrueID`')) { p0738( "ALTER TABLE `". $f851f5."Sources` ". "ADD `TrueID` INT UNSIGNED DEFAULT '0' NOT NULL AFTER `ID`" ); p0738( "UPDATE `". $f851f5."Sources` ". "SET `TrueID` = `ID`" ); } if (!strstr($s4fded['Sources'],'`SubsetID`')) { p0738( "ALTER TABLE `". $f851f5."Sources` ". "ADD `SubsetID` INT UNSIGNED DEFAULT '0' NOT NULL AFTER `ID`" ); } return true; } function ddb59($f851f5){ global$_model; foreach(array_keys($_model) as $cd2ffa){ $b4b43b=z07e3($cd2ffa,$f851f5); if ($b4b43b){ $ud89e2=$b4b43b['Collation']; if ($ud89e2!='utf8_general_ci'){ if(Log::$ped2b5)__log('Migrate: Convert table '. $cd2ffa. ' to utf8'); p0738( "ALTER TABLE `". $f851f5.$cd2ffa ."` ". "CONVERT TO CHARACTER SET utf8 COLLATE utf8_general_ci" ); } } } } function e2mig__queries_to_recreate_indexes_for_table_($paab9e){ $bf78dd=$u4f12d=[]; $o7694f=( "SELECT s.column_name, s.table_name, s.index_name, s.non_unique ". "FROM information_schema.statistics s ". " JOIN information_schema.columns USING (table_name, table_schema, column_name) ". " JOIN information_schema.tables USING (table_name, table_schema) ". "WHERE s.table_schema = DATABASE() AND engine = 'InnoDB' ". " AND column_type like '%varchar%' AND table_name='".$paab9e."'" ); p0738($o7694f); foreach (g0d6b() as $nf1965){ $bf78dd[] = sprintf( "DROP INDEX %s ON %s", $nf1965['index_name'], $nf1965['table_name'] ); $u4f12d[] = sprintf( "CREATE %s INDEX %s ON %s(%s(191))", $nf1965['non_unique']?'':'UNIQUE', $nf1965['index_name'], $nf1965['table_name'], $nf1965['column_name'] ); } return array ($bf78dd,$u4f12d); } function lb01c($f851f5){ global$_model,$_db; $q752cb=id372(); foreach ($q752cb as $o8ce4b => $l9e366){ $q752cb[$o8ce4b]=SEARCH_EXTRA_PREFIX. $l9e366; } $u0b95a=array_merge( array_keys($_model), array_values($q752cb) ); $bf78dd=$u4f12d=null; foreach ($u0b95a as $cd2ffa){ if(Log::$ped2b5)__log('Migrate: Convert table '. $cd2ffa. ' to utf8mb4?'); $b4b43b=z07e3($cd2ffa,$f851f5); if ($b4b43b){ $ud89e2=$b4b43b['Collation']; if(stripos($ud89e2,'utf8mb4')!==0){ list ( $bf78dd, $u4f12d )=e2mig__queries_to_recreate_indexes_for_table_($f851f5.$cd2ffa); if ($bf78dd!==null){ if(Log::$ped2b5){ __log('Migrate: Drop indexes of table '. $cd2ffa); } foreach ($bf78dd as $ceaf65){ p0738($ceaf65); } } if(Log::$ped2b5){ __log('Migrate: Convert table '. $cd2ffa. ' to UTF8MB4'); } p0738( "ALTER TABLE `". $f851f5.$cd2ffa ."` ". "CONVERT TO CHARACTER SET utf8mb4" ); if ($u4f12d!==null){ if(Log::$ped2b5){ __log('Migrate: Recreate indexes of table '.$cd2ffa); } foreach ($u4f12d as $s2464f){ p0738($s2464f); } } } } } } function e2s_migrate(){ kbb8d(); die ('Database migration finished.'); } function e2s_update_perform(){ global$_model,$settings,$_config,$_diagnose; $t7123a=h2ac5(); $pd98a0=max((int) ($t7123a['version']), 2285); if ($t7123a['version']==E2_VERSION){ i4930(); die; } if($_config['log_updates']) { Log::$ped2b5=true; if(Log::$ped2b5)y714a('update-$'); } if(Log::$ped2b5)__log('Update from v'. $pd98a0 .' to v'. E2_VERSION.' {'); if ($pd98a0 < 2587){ bc5a6('caches/*'); rmdir('caches'); } if ($pd98a0 < 2691){ $settings=e2_utf8_version_of_array_($settings); if (!@n6e52(USER_FOLDER.'settings.json',json_encode($settings,E2_JSON_STYLE))) { x8a40($_strings['er--cannot-save-data'],E2E_PERMISSIONS_ERROR); q4006(); } } if ($pd98a0 < 2921){ $settings['template']='plain'; } if ($pd98a0 < 3223){ $settings['v3223_rss_permalinks_before_stamp']=time(); } if ($pd98a0 < 3354){ @rename('pictures/userpics/',AVATARS_FOLDER); @unlink(USER_FOLDER. 'password-reset.txt'); } if ($pd98a0 < 3496){ $settings['appearance']['respond_to_dark_mode']=true; } @unlink(USER_FOLDER. 'last-update.psa'); @unlink(CACHES_FOLDER.'index.xml'); @caf42(CACHES_FOLDER); @caf42(BACKUP_FOLDER); @caf42(MEDIA_ROOT_FOLDER.PICTURES_FOLDER .'remote/'); @caf42(MEDIA_ROOT_FOLDER.THUMBNAILS_FOLDER .'remote/'); if (@$settings['template']=='')$settings['template']=DEFAULT_TEMPLATE; if (isset ($settings['appearance']['hot_frontpage'])) { unset($settings['appearance']['hot_frontpage']); } if (isset ($settings['db']['table_prefix'])) { if($settings['db']['table_prefix'] != @$_config['db_table_prefix']) { die ('You’ve been using a database with a table prefix “'. $settings['db']['table_prefix'] .'”. Now this should be set in the configuration. Please add the following line to the file user/config.php:<br /><br />$_config[\'db_table_prefix\'] = \''. $settings['db']['table_prefix'] .'\';<br /><br />Then refresh this page.'); } else { unset($settings['db']['table_prefix']); } } if (isset ($settings['comments']['on'])) { if (!$settings['comments']['on']) { try { p0738( "UPDATE LOW_PRIORITY `". $_config['db_table_prefix']."Notes` ". "SET `IsCommentable`=0 ". "WHERE `SubsetID`=". $_config['db_table_subset'] ); } catch (AeMySQLException $e){} } $settings['comments']['default_on'] = (bool)$settings['comments']['on']; unset($settings['comments']['on']); } if ( is_file(USER_FOLDER.'settings.json') and is_file(USER_FOLDER.'settings.psa') ) { @unlink(USER_FOLDER.'settings.psa'); } if (!@n6e52(USER_FOLDER.'settings.json',json_encode($settings,E2_JSON_STYLE))) { x8a40($_strings['er--cannot-save-data'],E2E_PERMISSIONS_ERROR); } e2_drop_all_kinds_of_cache(); kbb8d(); if ($pd98a0 < 3386){ if (za521()) { $jddece=l476c(); try { $jddece -> erase(); } catch (\S2\Rose\Exception\RuntimeException $e){ if(Log::$ped2b5)__log('Rose not available'); } } u198f(); } $_diagnose['need?']=true; kc64a('diagnose','1'); $t7123a=m5be8(E2_VERSION); if(Log::$ped2b5)__log('}'); if (de852()) { x8a40(e2l_get_string('gs--updated-successfully', array ( 'from' => 'v'. $pd98a0, 'to' => 'v'. $t7123a['version'], )), E2E_MESSAGE); } e2_go_to(); die; } define('E2_MYSQL_CONNECT_TIMEOUT',5); function h985b($ufa48c='',$t78940=null){ static $t060d3=false; global$settings,$_db,$h11755,$_config; if ($t060d3) return; if ($t78940===null)$t78940=$settings['db']; $nd51e8=mysqli_init(); $nd51e8 -> options(MYSQLI_OPT_CONNECT_TIMEOUT,E2_MYSQL_CONNECT_TIMEOUT); if($_config['dev_chaos'] and !rand(0, (1/$_config['dev_chaos']) - 1)) { throw new AeMySQLCannotConnectException('Could not '. $ufa48c ."\n\nChaos in e2_mysql_ensure"); } $l06aa6=@mysqli_real_connect( $nd51e8, 'p:'. $t78940['server'], $t78940['user_name'], see85($t78940['passw']) ); if (!$l06aa6){ $a70106=mysqli_connect_errno(); if ($a70106==1045){ $l06aa6=@mysqli_real_connect( $nd51e8, 'p:'. $t78940['server'], $t78940['user_name'], $t78940['passw'] ); if ($l06aa6){ $t78940['passw']=r1305($t78940['passw']); $settings['db']=$t78940; if(Log::$ped2b5)__log('Storing encrypted password'); @n6e52(USER_FOLDER.'settings.json',json_encode($settings,E2_JSON_STYLE)); } else { throw new AeMySQLAccessDeniedException('Could not '. $ufa48c); } } else { throw new AeMySQLCannotConnectException('Could not '. $ufa48c); } } $_db['version']=mysqli_get_server_info($nd51e8); if(version_compare($_db['version'],E2_MINIMUM_MYSQL,'<')) { throw new AeMySQLTooOldException('Could not '. $ufa48c); } if (!@mysqli_select_db($nd51e8,$t78940['name'])) { throw new AeMySQLNotFoundException('Could not '. $ufa48c); } $_db['link']=$nd51e8; $_db['charset']=version_compare($_db['version'],'5.5.3','>=')?'utf8mb4':'utf8'; $w1b1cc='SET NAMES '. $_db['charset']; mysqli_query($nd51e8,$w1b1cc); @$h11755 ++; if(Log::$ped2b5)__log('DB ['. $h11755 .']: '. $w1b1cc); $t060d3=true; } function p0738($w1b1cc,$ufa48c='run some query'){ global $h11755,$_db,$_strings,$_config; h985b($ufa48c); if($_config['dev_chaos'] and !rand(0, (1/$_config['dev_chaos']) - 1)) { throw new AeMySQLQueryException('Could not '. $ufa48c ."\n\nChaos in e2_mysql_query"); } @$h11755 ++; if(Log::$ped2b5) if ($ufa48c)__log('Will '. $ufa48c); if(Log::$ped2b5)__log('DB ['. $h11755 .']: '. $w1b1cc); $_db['result'] = @mysqli_query($_db['link'],$w1b1cc); if (!$_db['result']) { throw new AeMySQLQueryException('Could not '. $ufa48c ."\n\nMySQL says:\n". mysqli_error($_db['link'])); } } function g0d6b($type=MYSQLI_ASSOC){ global$_db; $z2cb9d=array(); while ($r0cc17=@mysqli_fetch_array($_db['result'],$type)) { foreach ($r0cc17 as $d865c0 => $r4921c){ if(is_string($r4921c)) { $r0cc17[$d865c0]=$r4921c; } } $z2cb9d[] = $r0cc17; } return $z2cb9d; } function u7928($ab45cf){ global$_db; h985b('escape string'); return mysqli_real_escape_string($_db['link'],$ab45cf); } function ib488(){ echo '<pre>'; echo 'Sifting backups...<br>'; $e10ae9=array(); foreach(glob(BACKUP_FOLDER. '*.sql') as $b8c7dd){ if(preg_match('/^backup\-(\d+)\-(\d+)\-(\d+)\-at\-(\d+)\-(\d+)\-(\d+)\.sql$/is',basename($b8c7dd),$z9c28d)) { list (, $q41529,$s6f8f5,$q8277e,$x2510c,$d865c0,$g03c7c)=$z9c28d; $w96b8c=gmmktime($x2510c,$d865c0,$g03c7c,$s6f8f5,$q8277e,$q41529); $e10ae9[$w96b8c]=$b8c7dd; } } if(count($e10ae9) > 3){ echo 'More than 3 backups, time to sift...<br>'; $t536a1=-1; $nf46c9=array (SECONDS_IN_A_MINUTE,SECONDS_IN_AN_HOUR,SECONDS_IN_A_DAY, -1); $d865c0=0; foreach(array_reverse($e10ae9,true) as $w96b8c => $b8c7dd){ echo '-> '. $b8c7dd .' ('. gmdate('r',$w96b8c) .')<br>'; if ($t536a1 == -1){ echo '   latest, leave<br>'; $t536a1=$w96b8c; } elseif ($nf46c9[$d865c0] == -1){ echo '   too old, remove<br>'; unlink($b8c7dd); } else { if ($t536a1-$w96b8c < $nf46c9[$d865c0]) { echo '   no need (not long ago), remove<br>'; unlink($b8c7dd); } else { $d865c0 ++; echo '   ok, leave, set interval to '. $nf46c9[$d865c0] .'<br>'; $t536a1=$w96b8c; } } } } else { echo 'No need to sift<br>'; } echo '</pre>'; return; } function e2s_dump(){ global$_model,$_db,$_config; try { h985b('make backup'); if($_db['link']) { $o68720=time() - (SECONDS_IN_A_DAY); $r9ab2e=array(); foreach(array_keys($_model) as $paab9e){ $r9ab2e[] = $_config['db_table_prefix'].$paab9e; } $q07cc6=time(); $x435ed=BACKUP_FOLDER .'backup-'.gmdate('Y-m-d-\a\t-H-i-s',$q07cc6).'.sql'; e2_backup( $_db['link'], $r9ab2e, $x435ed ); ib488(); die ('Backed up.'); } } catch (AeMySQLException $e){ e12f6($e,'Could not do backup'); die ('Could not do backup.'); } } define('ALIAS_MAX_LENGTH',64); function e2ali__alias_from_title_($o36cd3){ global$_config; $m3e891=$o36cd3; if(array_key_exists('autoreplace_for_aliases',$_config)) { $m3e891=strtr( $m3e891, $_config['autoreplace_for_aliases'] ); } $m3e891=n2183($m3e891); $m3e891=str_replace('\'','',$m3e891); $m3e891=str_replace('’','',$m3e891); $m3e891=str_replace(chr(146),'',$m3e891); $e17901=''; for ($d865c0=0; $d865c0 < strlen($m3e891); ++ $d865c0){ if ( (ord($m3e891[$d865c0]) >= 48 and ord($m3e891[$d865c0]) <= 57) or (ord($m3e891[$d865c0]) >= 65 and ord($m3e891[$d865c0]) <= 90) or (ord($m3e891[$d865c0]) >= 97 and ord($m3e891[$d865c0]) <= 122) or 0 ){ $e17901.=$m3e891[$d865c0]; } else { $e17901.='-'; } } $e17901=preg_replace('/\-+/','-',$e17901); $e17901=trim($e17901,'-'); $e17901=strtolower($e17901); if ($e17901=='-')$e17901=''; $e17901=substr($e17901,0,ALIAS_MAX_LENGTH); return $e17901; } function e2_aliasrec_of_alias_($c72487){ global$_config; if ((string)$c72487==='') return false; p0738( "SELECT * FROM `". $_config['db_table_prefix']."Aliases` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `Alias` = '". $c72487 ."' ". "ORDER BY `Stamp` LIMIT 1", 'get database record for alias "'. $c72487 .'"' ); $result=g0d6b(); if(count($result)==1){ return$result[0]; } else { return false; } } function e2_active_alias_for_page_($y89111,$tdffc4){ global$_config,$_e2_active_aliases; if ($tdffc4){ if ( is_array($_e2_active_aliases) and array_key_exists($y89111.$tdffc4,$_e2_active_aliases) ) { if(Log::$ped2b5)__log( 'Aliases: alias of entity "'. $y89111 .'" id "'. $tdffc4 .'" '. 'is livecached as "'. @$_e2_active_aliases[$y89111.$tdffc4] .'"' ); return @$_e2_active_aliases[$y89111.$tdffc4]; } else { p0738( "SELECT `Alias` ". "FROM `". $_config['db_table_prefix']."Aliases` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `EntityType` = '". $y89111 ."' ". "AND `EntityID` = ". $tdffc4 ." ". "ORDER BY `Stamp` DESC LIMIT 1", 'get alias record for entity "'. $y89111 .'" id '. $tdffc4.' to detect active alias' ); $result=g0d6b(); $c72487=$result[0]['Alias']; if (!$c72487 and $y89111==ENTITY_TYPE_TAG){ p0738( "SELECT OriginalAlias ". "FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID` = '". ((int)$tdffc4)."'", 'get orginial alias for tag id '. $tdffc4.' to detect active alias' ); $result=g0d6b(); $c72487=$result[0]['OriginalAlias']; } $_e2_active_aliases[$y89111.$tdffc4]=$c72487; } if(Log::$ped2b5)__log('Got alias "'. @$_e2_active_aliases[$y89111.$tdffc4] .'"'); return @$_e2_active_aliases[$y89111.$tdffc4]; } } function vd712($u15d61,$y89111,$tdffc4,$o36cd3,$ufb873=1){ global$_e2_active_aliases; if(Log::$ped2b5)__log('Aliases: "'. $u15d61 .'" available alias for source "'. $o36cd3. '"'); if ($u15d61=='set' and (!$y89111 or !$tdffc4)) return false; $e17901=e2ali__alias_from_title_($o36cd3); if ($o36cd3!=='' and $e17901===''){ $e17901=(string)$ufb873; } elseif ($ufb873 > 1){ $u9f626='-'. $ufb873; $e17901=substr($e17901,0,ALIAS_MAX_LENGTH-strlen($u9f626)) . $u9f626; } if ($tc45dd=e2_aliasrec_of_alias_($e17901)) { $y6bae4=$tc45dd['EntityType']; $x1123c=$tc45dd['EntityID']; if ( (($tdffc4 and $x1123c==$tdffc4) and ($y89111 and $y6bae4==$y89111)) or $e17901!=e2_active_alias_for_page_($y6bae4,$x1123c) ) { if ($u15d61=='find'){ return $e17901; } if ($u15d61=='set'){ if(Log::$ped2b5)__log('Aliases: update alias timestamp'); kaa79('Aliases', array ( 'ID' => $tc45dd['ID'], 'EntityType' => $y89111, 'EntityID' => $tdffc4, 'Alias' => $e17901, 'Stamp' => time(), )); return$_e2_active_aliases[$y89111.$tdffc4]=$e17901; } } else { return vd712($u15d61,$y89111,$tdffc4,$o36cd3,$ufb873+1); } } else { if ($y89111 and $tdffc4 and $e17901==''){ if(e2_active_alias_for_page_($y89111,$tdffc4)==''){ return ''; } } if(Log::$ped2b5)__log('Aliases: it’s an empty alias, and it was not being used for this entity'); if ( $y89111==ENTITY_TYPE_TAG and $vd62e3=d8770($e17901) ) { if ($vd62e3['ID']!=$tdffc4){ return vd712($u15d61,$y89111,$tdffc4,$o36cd3,$ufb873+1); } } if ($u15d61=='find'){ return $e17901; } if ($u15d61=='set'){ p9943('Aliases', array ( 'EntityType' => $y89111, 'EntityID' => $tdffc4, 'Alias' => $e17901, 'Stamp' => time(), )); return$_e2_active_aliases[$y89111.$tdffc4]=$e17901; } } return ''; } function e2m_note($parameters=array ()) { global $settings, $o57de2, $_config, $_superconfig, $_strings; if(Log::$ped2b5)__log('Note {'); $taad65=$parameters['*note']; if ($taad65==false){ return e2_error404_mode(); } if (!db44b($taad65,de852())) { return e2_error404_mode(); } $td58c0=d83c8('e2m_note',$parameters); if(Log::$ped2b5)__log('Navigation {'); $wfcb08=pcca7($taad65,'prev'); $ud0cab=pcca7($taad65,'next'); if ($wfcb08){ $mb3b32['prev-href']=d83c8('e2m_note', array ('*note' => $wfcb08)); $mb3b32['prev-title']=z6f10(htmlspecialchars($wfcb08['Title'],ENT_NOQUOTES,HSC_ENC)); } if ($ud0cab){ $mb3b32['next-href']=d83c8('e2m_note', array ('*note' => $ud0cab)); $mb3b32['next-title']=z6f10(htmlspecialchars($ud0cab['Title'],ENT_NOQUOTES,HSC_ENC)); } $mb3b32['title']=$_strings['nm--posts']; $mb3b32['timeline?']=false; $mb3b32['this-title']=z6f10(htmlspecialchars($taad65['Title'],ENT_NOQUOTES,HSC_ENC)); if(Log::$ped2b5)__log('}'); if(Log::$ped2b5)__log('Packaging...'); $taad65['_']['_id']=$taad65['ID']; $taad65['_']['_ord']=0; $taad65['_']['_ord_max']=0; $w8e4cd=h6791($taad65); $se35b1=''; $c33ff2=false; $u905f7=false; $x7bae4=array(); $ld09b4=''; if (de852()) { $w83625=e2_note_cache_filename_with_id_($taad65['_']['_id'] .'-comments-author'); } else { $w83625=e2_note_cache_filename_with_id_($taad65['_']['_id'] .'-comments'); } $w1e8cc=null; if(CACHE_NOTES_COMMENTS and is_file($w83625)) { $w1e8cc=@unserialize(file_get_contents($w83625)); } if(Log::$ped2b5)__log('Comments {'); if(is_array($w1e8cc)) { if(Log::$ped2b5)__log('retrieve cached ctree'); $se35b1=$w1e8cc; } else { if(Log::$ped2b5)__log('assemble ctree...'); $zc1fdc=n70a7($taad65['ID']); $ua5d49=array(); $u04c25=true; foreach ($zc1fdc as $o8ce4b => $c4032b){ if ($c4032b['IsVisible']) { $c4032b['_']['_id']=$c4032b['ID']; $c4032b['_']['_ord']=$o8ce4b; $c4032b['_']['_ord_max']=count($zc1fdc)-1; $e06d4c=g86f8( $taad65, $c4032b, $o8ce4b+1 ); if ($e06d4c['new?'] and $u04c25){ $e06d4c['first-new?']=true; $u04c25=false; } $ua5d49[] = $e06d4c; } } $se35b1=$ua5d49; if(CACHE_NOTES_COMMENTS)n6e52($w83625,serialize($se35b1)); } if(Log::$ped2b5)__log('} // Comments'); if (!@$_config['read_only'] and $w8e4cd['commentable-now?']) { $r80f02=a66aa($taad65); $r80f02['.comment-number']=count($se35b1)+1; } if (de852() and rb387($taad65,NOTE_COMMENTABLE_NOW_CONDITIONALLY)) { if ($taad65['IsCommentable']) { $x7bae4['href']=d83c8('e2m_note_flag', array ( '*note' => $taad65, 'flag' => 'IsCommentable', 'value' => 0, )); $x7bae4['text']=$_strings['bt--close-comments-to-post']; } else { $x7bae4['href']=d83c8('e2m_note_flag', array ( '*note' => $taad65, 'flag' => 'IsCommentable', 'value' => 1, )); $x7bae4['text']=$_strings['bt--open-comments-to-post']; } } if ( de852() and array_key_exists('new-comments-count',$w8e4cd) and $w8e4cd['new-comments-count'] ) { if(Log::$ped2b5)__log('mark comments as not new'); e2_drop_caches_for_note_($v21158); kaa79('Comments', array ('IsNew' => 0), array ('NoteID' => $taad65['_']['_id'])); } if(Log::$ped2b5)__log('more work...'); $ue70c4['title']=$taad65['Title']; $ue70c4['pages']=$mb3b32; $ue70c4['summary']=$w8e4cd['summary']; $ue70c4['notes'] = array ('only' => $w8e4cd); if ($se35b1) $ue70c4['comments']['each']=$se35b1; if ($x7bae4) $ue70c4['comments']['toggle']=$x7bae4; $ue70c4['comments']['count']=$w8e4cd['comments-count']; $ue70c4['comments']['count-text']=$w8e4cd['comments-count-text']; $ue70c4['comments']['new-count']=$w8e4cd['new-comments-count']; $ue70c4['comments']['new-count-text']=$w8e4cd['new-comments-count-text']; $ue70c4['comments']['commentable-now?']=$w8e4cd['commentable-now?']; if ($r80f02){ $ue70c4['form-comment']=$r80f02; } if(Log::$ped2b5)__log('} // Note'); return $ue70c4; } function e2m_note_read($parameters=array ()) { if(Log::$ped2b5)__log('Note read {'); $taad65=$parameters['*note']; $nff089=time(); $nff089=$nff089 - ($nff089 % SECONDS_IN_AN_HOUR); p9943( 'Actions', array ( 'EntityID' => $taad65['ID'], 'Stamp' => $nff089, 'ReadCount' => 1, ), 'INSERT LOW_PRIORITY', 'ON DUPLICATE KEY UPDATE `ReadCount` = `ReadCount` + 1' ); if(Log::$ped2b5)__log('}'); e2_go_to(d83c8('e2m_note',$parameters)); } function e2m_note_withdraw($parameters=array ()) { global$_strings; $qea59a=$parameters['*note']; if (!$qea59a) return e2_error404_mode(); if($_SERVER['REQUEST_METHOD']!='POST'){ return e2_go_to(d83c8('e2m_note', array ('*note' => $qea59a))); } $a22db1=d83c8('e2m_note_broadcast', array ('*note' => $qea59a)); $qea59a['IsPublished']=0; $qea59a['IsCommentable']=0; $qea59a['IsVisible']=1; $qea59a['Stamp']=time(); $qea59a['IP']=w1668(); if($parameters['alias']) { $qea59a['OriginalAlias']=$parameters['alias']; } else { $qea59a['OriginalAlias']=vd712( 'find',ENTITY_TYPE_NOTE,$qea59a['ID'],$qea59a['Title'] ); } e2_drop_caches_for_note_($qea59a['ID']); @unlink(CACHE_FILENAME_DRAFTS); @unlink(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); if ($qea59a['IsFavourite']) { @unlink(CACHE_FILENAME_FAVS); } kaa79('Notes',$qea59a); w10fe($qea59a['ID']); ecc38($a22db1); vd712('set',ENTITY_TYPE_NOTE,$qea59a['ID'],''); e2_go_to(d83c8('e2m_draft', array ( '*note' => $qea59a, ))); } function e2m_note_delete($parameters=array()) { global$_strings; $qea59a=$parameters['*note']; if (!$qea59a) return e2_error404_mode(); $ef91b2=!$qea59a['IsPublished']; if ($ef91b2){ $l72bd7=e2l_get_string('gs--draft-will-be-deleted', array ( 'draft' => htmlspecialchars($qea59a['Title'],ENT_NOQUOTES,HSC_ENC), )); } else { $l72bd7=e2l_get_string('gs--post-will-be-deleted', array ( 'post' => htmlspecialchars($qea59a['Title'],ENT_NOQUOTES,HSC_ENC), )); } $qd5d3d=$ef91b2? $_strings['pt--draft-deletion']:$_strings['pt--post-deletion']; $q57529=array ( '.note-id' => $qea59a['ID'], '.is-draft' => (int)$ef91b2, 'note-title' => htmlspecialchars($qea59a['Title'],ENT_COMPAT,HSC_ENC), 'caution-text' => $l72bd7, 'form-action' => d83c8('e2s_note_delete'), 'submit-text' => $_strings['fb--delete'], 'draft?' => (int)$ef91b2, ); if ($qea59a['IsPublished']) { $q57529['withdraw-href']=d83c8( 'e2m_note_withdraw',$parameters ); } $z2cb9d=array ( 'title' => $qd5d3d. ': '. htmlspecialchars($qea59a['Title'],ENT_NOQUOTES,HSC_ENC), 'heading' => $qd5d3d, 'form' => 'form-note-delete', 'form-note-delete' => $q57529, ); return $z2cb9d; } function e2m_note_flag_favourite($parameters){ global$_config; $parameters['flag']='IsFavourite'; r705b([ 'flag-name' => 'favourite', 'candy-name' => 'e2m_note_flag_favourite', 'parameters' => $parameters, 'flipping-function' => function () use ($parameters){ h7e6c($parameters); }, ]); } function e2m_note_flag($parameters){ h7e6c($parameters); if(array_key_exists('draft',$parameters)) { e2_go_to(d83c8('e2m_draft',$parameters)); } else { e2_go_to(d83c8('e2m_note',$parameters)); } die; } function h7e6c($parameters){ $v21158=$parameters['*note']['ID']; if (!is_numeric($v21158)) { return e2_error404_mode(); } e2_drop_caches_for_note_($v21158); if($parameters['flag']=='IsFavourite'){ @unlink(CACHE_FILENAME_FAVS); } if($parameters['flag']=='IsVisible'){ x7996(); } kaa79('Notes', array ( 'ID' => $v21158, $parameters['flag'] => (int) ($parameters['value']==1), )); try { $d39a37=r4627($v21158); r5b68($d39a37); } catch (AeMySQLException $e){ e12f6($e,'Could not broadcast note flag change'); } return true; } function e2m_note_use_formatter($parameters){ $v21158=$parameters['*note']['ID']; if (!is_numeric($v21158)) { return e2_error404_mode(); } e2_drop_caches_for_note_($v21158); if (!$parameters['*note']['IsPublished']) { @unlink(CACHE_FILENAME_DRAFTS); } if(in_array($parameters['formatter'], array ('calliope','raw','neasden'))) { kaa79('Notes', array ( 'ID' => $v21158, 'FormatterID' => $parameters['formatter'], )); echo 'formatter set to '. $parameters['formatter']; } else { echo 'unknown formatter'; } die; } function g7dd3($y60cd8,$parameters=array ()) { global$full_blog_url,$_strings,$_config; $qd5d3d=$_strings['pt--new-post']; $xf74f5=$_strings['pt--new-post']; $v21158='new'; $w9763c=$_config['default_formatter']; if ($y60cd8=='edit'){ $qea59a=$parameters['*note']; if (!$qea59a) return e2_error404_mode(); if ($qea59a){ if ($qea59a['IsPublished']) { $xf74f5=$_strings['pt--edit-post']; $g3aa13=''; $c72487=$parameters['alias']; } else { $xf74f5=$_strings['pt--edit-draft']; $g3aa13=vd712( 'find',ENTITY_TYPE_NOTE,$qea59a['ID'],$qea59a['Title'] ); if (@$qea59a['OriginalAlias']) { $c72487=$qea59a['OriginalAlias']; } else { $c72487=$g3aa13; } } } $v21158=$qea59a['ID']; $w9763c=$qea59a['FormatterID']; $qd5d3d=$qea59a['Title']; } $t04868=mbb5b(); $r77b75=array(); if ($t04868!==null) foreach ($t04868 as $td7df5){ $r77b75[] = $td7df5['tag']; } $yd2e3e=array(); if ($y60cd8=='edit' and count($r77b75)) { $t04868=kce23($qea59a['ID']); foreach ($t04868 as $td7df5){ $yd2e3e[] = htmlspecialchars($td7df5['Keyword'],ENT_NOQUOTES,HSC_ENC); } } $bc93df=array(); foreach ($r77b75 as $td7df5){ $efd2ef['name']=$td7df5; $efd2ef['selected?']=in_array($td7df5,$yd2e3e); $bc93df[] = $efd2ef; } $p9dbb8=''; $yd2e3e=implode(', ',$yd2e3e); if ($yd2e3e)$p9dbb8=$yd2e3e; if ($y60cd8=='write'){ $oc50d0=$_strings['fb--save-and-preview']; } if ($y60cd8=='edit'){ if(array_key_exists('draft',$parameters)) { $oc50d0=$_strings['fb--save-and-preview']; } else { $oc50d0=$_strings['fb--save-changes']; } } $je449c=array(); if ($y60cd8=='edit'){ $je449c=xc0c4( $qea59a['FormatterID'],$qea59a['Text'],'full' ); } $y75e1b=uf898( 'note',$v21158,$je449c ); if ($y60cd8=='edit'){ j2f83( 'Notes', $qea59a, $je449c ); } $w96b8c=min($qea59a['Stamp'],time()); $kc999b=pd10e(); $w85faf=t1363($kc999b); $z2cb9d['title']=$qd5d3d; $z2cb9d['heading']=$xf74f5; $z2cb9d['form']='form-note'; $z2cb9d['uploads'] = [ 'enabled?' => $w85faf, 'each' => $y75e1b, 'upload-action' => d83c8('e2j_file_upload'), 'remove-action' => d83c8('e2j_file_remove'), ]; $z2cb9d['form-note'] = array ( '.note-id' => $v21158, '.formatter-id' => $w9763c, '.from' => substr($_SERVER['HTTP_REFERER'],strlen($full_blog_url)+1), '.old-tags-hash' => md5($p9dbb8), '.action' => $y60cd8, 'form-action' => d83c8('e2s_note_process'), 'form-note-livesave-action' => d83c8('e2j_note_livesave'), 'create:edit?' => (bool) ($y60cd8=='write'), 'title' => htmlspecialchars($qea59a['Title'],ENT_COMPAT,HSC_ENC), 'tags' => $p9dbb8, 'tags-info' => $bc93df, 'text' => htmlspecialchars($qea59a['Text'],ENT_NOQUOTES,HSC_ENC), 'all-tags' => $r77b75, 'stamp-formatted' => e5a2f('d.m.Y H:i:s',$w96b8c,e0923($qea59a)), 'time' => $qea59a['IsPublished']? array ((int)$w96b8c,e0923($qea59a)) : false, 'alias-autogenerated' => $g3aa13, 'uploads-enabled?' => $w85faf, 'alias' => $c72487, 'submit-text' => $oc50d0, 'space-usage' => zaf64($kc999b), ); if ($y60cd8=='edit'){ $z2cb9d['related-delete-href']=d83c8( 'e2m_note_delete', array ('*note' => $qea59a) ); if (!array_key_exists('draft',$parameters)) { $qea59a['_']['_id']=$qea59a['ID']; $qea59a['_']['_ord']=0; $qea59a['_']['_ord_max']=0; $z2cb9d['form-note']['note']=h6791($qea59a); } } return $z2cb9d; } function e2m_note_edit($parameters=array ()) { return g7dd3('edit',$parameters); } function e2m_write(){ return g7dd3('write'); } function e2s_note_process(){ global$_fp_error,$_strings; $v21158=aa21e(); if (!$v21158){ if($_fp_error==FP_TITLE_OR_TEXT_EMPTY){ x8a40($_strings['er--post-must-have-title-and-text'],E2E_USER_ERROR); } elseif($_fp_error==FP_NO_ID_OR_NEW){ } else { x8a40($_strings['er--error-occurred']); } e2_go_to(d83c8('e2m_write')); die; } try { $taad65=r4627($v21158); if ($taad65['IsPublished']) { e2_go_to(d83c8('e2m_note', array ('*note' => $taad65))); } else { e2_go_to(d83c8('e2m_draft', array ('*note' => $taad65))); } } catch (AeMySQLException $e){ e12f6($e,'Could not get note by ID'); e2_go_to(); } die; } function e2s_note_publish(){ global$_strings,$_config,$settings; $v21158=false; if(array_key_exists('note-id',$_POST)) { $v21158=$_POST['note-id']; $raddfe=false; $qea59a=r4627($v21158); $d82b30=$qea59a['OriginalAlias']; $m098ae=$qea59a['Stamp']; $vbb4fe=!$qea59a['IsExternal']; $qea59a['ID']=$v21158; $qea59a['IsVisible']=1; $qea59a['IsPublished']=1; $qea59a['IsCommentable'] = (int)$settings['comments']['default_on']; $qea59a['IsFavourite']=0; if(array_key_exists('browser-offset',$_POST)) { $xb2c6c=la618(@$_POST['browser-offset']); } else { $xb2c6c=f5c05(); } if ($raddfe and $w96b8c=p1630($raddfe,$xb2c6c)) { $qea59a['Stamp']=$w96b8c; } elseif ($vbb4fe){ $qea59a['Stamp']=time(); } else { $qea59a['Stamp']=$m098ae; } if (kd2e1($qea59a)) { $qea59a['IsIndexed']='1'; } if ($xb2c6c){ $qea59a['Offset'] = (int)$xb2c6c['offset']; $qea59a['IsDST'] = (int)$xb2c6c['is_dst']; } e2_drop_caches_for_note_($v21158); @unlink(CACHE_FILENAME_DRAFTS); @unlink(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); kaa79('Notes',$qea59a); $c72487=''; if ($d82b30 or $d82b30==='0'){ $c72487=vd712('set',ENTITY_TYPE_NOTE,$v21158,$d82b30); $qea59a['OriginalAlias']=$c72487; } if ($c72487!=$d82b30){ kaa79('Notes',$qea59a); } if (db44b($qea59a)) { r5b68($qea59a); } e2_go_to(d83c8('e2m_note', array ('*note' => $qea59a))); die; } e2_go_to(); die; } function ge268($v21158,$f9a92d=-1){ global$_config; e2_drop_caches_for_note_($v21158); if ($f9a92d or $f9a92d === -1){ @unlink(CACHE_FILENAME_DRAFTS); @unlink(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); } if (!$f9a92d or $f9a92d === -1) { @unlink(CACHE_FILENAME_FAVS); } p0738( "DELETE FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID` = '". ((int)$v21158) ."'", 'delete note by ID' ); w10fe($v21158); p0738( "DELETE FROM `". $_config['db_table_prefix']."Aliases` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `EntityID`=". ((int)$v21158), 'delete aliases after deleting note' ); p0738( "DELETE FROM `". $_config['db_table_prefix']."NotesKeywords` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `NoteID`=". ((int)$v21158), 'delete tag bindings after deleting note' ); } function e2s_note_delete(){ global$_strings,$_config; $v21158=$_POST['note-id']; $f9a92d=(bool)$_POST['is-draft']; $qea59a=r4627($v21158); $a22db1=d83c8('e2m_note_broadcast', array ('*note' => $qea59a)); ge268($v21158,$f9a92d); ecc38($a22db1); if ($f9a92d){ e2_go_to(d83c8('e2m_drafts')); } else { e2_go_to(); } die; } function e2j_note_livesave(){ die (aa21e('ajaxresult')); } function h6791($taad65,$x8698e=false){ global $settings, $_config, $_superconfig, $_candy, $_current_tag, $o57de2, $pe5564, $full_blog_url; if (!is_numeric($taad65['_']['_id'])) return false; $tda497=e2_note_cache_filename_with_id_($taad65['_']['_id']); $le244c=null; if(CACHE_NOTES and is_file($tda497)) { $le244c=@unserialize(file_get_contents($tda497)); } if(Log::$ped2b5)__log('Notes: package note <'. $taad65['_']['_id'] .'>...'); $me919a=j7f78(); if(CACHE_NOTES and is_array($le244c)) { if(Log::$ped2b5)__log('Notes: retrieve cached ctree'); $dc6827=$le244c; } else { if(Log::$ped2b5)__log('Notes: assemle cacheable ctree...'); if(Log::$ped2b5)__log('Notes: formatter ID = '. $taad65['FormatterID']); $z2bfe4=b154e($taad65['FormatterID'], @$taad65['Text'],'full'); $dc6827['title'] = z6f10(htmlspecialchars($taad65['Title'],ENT_NOQUOTES,HSC_ENC)); $dc6827['text'] = $z2bfe4['text-final']; $dc6827['summary'] = u5421($dc6827['text']); $dc6827['format-info'] = $z2bfe4['meta']; $dc6827['time'] = array ((int)$taad65['Stamp'],e0923($taad65)); $dc6827['last-modified'] = array ((int)$taad65['LastModified'],e0923($taad65)); $dc6827['last-ip'] = $taad65['IP']; $dc6827['published?'] = (bool)$taad65['IsPublished']; $dc6827['commentable?'] = (bool) ($taad65['IsCommentable'] && $taad65['IsPublished']); $dc6827['favourite?'] = (bool) ($taad65['IsFavourite'] && $taad65['IsPublished']); $dc6827['visible?'] = db44b($taad65); $dc6827['scheduled?'] = false; $od972d=@$taad65['SourceNoteData']; $od972d=@json_decode($od972d,true); $dc6827['source-main-image-url'] = @$od972d['og_images'][0]; if(is_array($z2bfe4['meta']['resources-detected'])) { e6be4($z2bfe4['meta']['resources-detected']); } if (!$dc6827['published?'])$dc6827['time']=$dc6827['last-modified']; $dc6827['og-images']=sdbcc( 'note',$taad65['_']['_id'], $dc6827['format-info']['resources-detected'] ); $k0dff3=kce23($taad65['ID']); $td57ac=array(); foreach ($k0dff3 as $d865c0 => $pb19ad){ $dc6827['og-images']=array_merge( $dc6827['og-images'], sdbcc('tag',$pb19ad['ID'], array ()) ); $ce4d23['name']=htmlspecialchars($pb19ad['Keyword'],ENT_NOQUOTES,HSC_ENC); $ce4d23['href']=d83c8('e2m_tag', array ('*tag' => $pb19ad)); $td57ac[] = $ce4d23; } $dc6827['tags']=$td57ac; $u905f7=u254f($taad65['ID']); if ($dc6827['published?']) { $dc6827['comments-count']=$u905f7; } $le244c=$dc6827; if(CACHE_NOTES) @n6e52($tda497,serialize($le244c)); } if ($x8698e){ if(Log::$ped2b5)__log('Notes: short-track package for caching only'); if(Log::$ped2b5)__log('Notes: package note done in '. round(j7f78()-$me919a,3)); return $dc6827; } if(Log::$ped2b5)__log('Notes: continue with the uncacheable, '. round(j7f78()-$me919a,3) .' so far...'); $dc6827['commentable-now?']=rb387($taad65); if(array_key_exists('comments-count',$dc6827)) { $dc6827['comments-count-text']=e2l_get_string('gs--n-comments', array ( 'number' => $dc6827['comments-count'] )); } foreach ($dc6827['tags'] as $o8ce4b => $l9e366){ $dc6827['tags'][$o8ce4b]['current?'] = (bool) ($dc6827['tags'][$o8ce4b]['name']==$_current_tag); } $f2e88c=$taad65['IsPublished']?'e2m_note':'e2m_draft'; $dc6827['href']=d83c8($f2e88c, array ('*note' => $taad65)); if ($taad65['IsPublished']) { if ($taad65['OriginalAlias']) { $dc6827['href-original']=d83c8('e2m_note', array ('alias' => $taad65['OriginalAlias'])); } else { $m010d9=$taad65; $m010d9['__noalias!']=true; $dc6827['href-original']=d83c8('e2m_note', array ('*note' => $m010d9)); } } $dc6827=array_merge($dc6827,l1a48($taad65,true)); $dc6827['comments-link?'] = (bool) ( $taad65['IsPublished'] && (rb387($taad65) or ($dc6827['comments-count'] > 0)) && ('e2m_note'!=$_candy) ); if (de852()) { $ufe9e2=g3ce7($taad65['ID']); $dc6827['new-comments-count']=$ufe9e2; $dc6827['new-comments-count-text']=e2l_get_string('gs--comments-n-new', array ( 'number' => $ufe9e2 )); if ($taad65['IsPublished']) { if ($taad65['IsFavourite']) { $dc6827['favourite-toggle-href']=d83c8( 'e2m_note_flag_favourite', array ('*note' => $taad65,'value' => 0) ); } else { $dc6827['favourite-toggle-href']=d83c8( 'e2m_note_flag_favourite', array ('*note' => $taad65,'value' => 1) ); } } if (!@$_config['read_only']) { $dc6827['edit-href']=d83c8( 'e2m_note_edit', array ('*note' => $taad65) ); $l9920c=$dc6827['edit-href']; } } if($settings['appearance']['show_sharing_buttons']) { $heb769=$_config['share_to']; $l21bdd='|twitter|facebook|vkontakte|telegram|linkedin|whatsapp|'; if (@$_config['share_to_twitter_via']) { $i8d777['twitter']['via']=$_config['share_to_twitter_via']; } if(count($dc6827['og-images']) > 0){ $n62933=$dc6827['og-images'][0]; $l21bdd.='pinterest|'; $i8d777['pinterest']['media']=$n62933; } $dc6827['shareable?']=false; foreach(explode(',',$heb769) as $y5a9d3){ $y5a9d3=trim($y5a9d3); if(strstr($l21bdd,'|'. $y5a9d3. '|')) { $dc6827['shareable?']=true; $dc6827['share-to'][$y5a9d3]['share?']=true; if ($i8d777[$y5a9d3]) { $dc6827['share-to'][$y5a9d3]['data']=$i8d777[$y5a9d3]; } } } } if(array_key_exists('_',$taad65))$dc6827['_']=$taad65['_']; if(Log::$ped2b5)__log('Notes: package note done in '. round(j7f78()-$me919a,3)); return $dc6827; } function r4627($sb80bb){ global$_config; p0738( "SELECT * FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID` = '". $sb80bb ."'" ); $rfa816=g0d6b(); if(count($rfa816) > 0){ return $rfa816[0]; } else { return false; } } function pcca7($taad65,$bb4ca4,$v8f888=1){ global$_strings,$_config; $z7ffc4=($bb4ca4=='next')?'>':'<'; $n9b272=($bb4ca4=='next')?'':'DESC '; try { p0738( "SELECT * FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished`=". $v8f888 ." ". "AND `Stamp` ". $z7ffc4 ." '". $taad65['Stamp'] ."' ". f6f32(de852()). "ORDER BY STAMP ". $n9b272 . "LIMIT 1", 'get '. $bb4ca4 .' note' ); $rfa816=g0d6b(); if(count($rfa816) > 0) return $rfa816[0]; else return false; } catch (AeMySQLException $e){ e12f6($e,'Could not get '. $bb4ca4 .' note'); return null; } } function na2d8($nddf82){ global$_config; if(Log::$ped2b5)__log('Lastmodifieds for Local Copier'); if(CACHE_LASTMODIFIEDS and is_file(CACHE_FILENAME_LASTMODIFIEDS)) { $n84636=@unserialize(file_get_contents(CACHE_FILENAME_LASTMODIFIEDS)); if ($n84636['ids_csv']==$nddf82){ if(Log::$ped2b5)__log('Returned from cache'); return $n84636['lastmodifieds_json']; } } $y56790='`ID`='. str_replace(',',' OR `ID`=',$nddf82); $gb7d96=array(); p0738( "SELECT `ID`, `LastModified` ". "FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND (". $y56790 .")", 'get lastmodifieds for Local Copier' ); if(Log::$ped2b5)__log('Requested from DB'); $result=g0d6b(); foreach($result as $o8ce4b => $l9e366){ $gb7d96[(int)$l9e366['ID']] = (int)$l9e366['LastModified']; } $b08bb9=json_encode($gb7d96); if ($b08bb9=='[]')$b08bb9='{}'; $n84636=array ( 'ids_csv' => $nddf82, 'lastmodifieds_json' => $b08bb9, ); if(CACHE_LASTMODIFIEDS){ n6e52(CACHE_FILENAME_LASTMODIFIEDS,serialize($n84636)); } return $b08bb9; } function vd864($i8d777){ global$settings,$b71860,$_strings; $o7694f=$i8d777['query']; if (isset ($i8d777['page']) and $i8d777['page'] < 1) return e2_error404_mode(); $yd7e5d=$settings['appearance']['notes_per_page']; $mb3b32=array(); $cfbb44=false; if (isset ($i8d777['page'])) { $b71860=$i8d777['page']; $o7694f.=' LIMIT '.($i8d777['page']-1)*$yd7e5d.', '.$yd7e5d; $h61e23=str_replace('SELECT *','SELECT count(*)',$i8d777['query']); p0738($h61e23,'count notes by criteria'); $result=g0d6b(); $cfbb44=$result[0]['count(*)']; $fae0fe=ceil($cfbb44/$yd7e5d); if ($b71860 > $fae0fe and $b71860!=1){ return e2_error404_mode(); } $mb3b32['count']=$fae0fe; $mb3b32['this']=$b71860; $mb3b32['timeline?']=true; $mb3b32['earlier-title']=$_strings['gs--earlier']; $mb3b32['later-title']=$_strings['gs--later']; $d920fa=$i8d777['parameters']; if ($b71860 < $fae0fe){ $d920fa['page']=$b71860+1; $mb3b32['earlier-href']=d83c8($i8d777['candy'],$d920fa); } if ($b71860 > 1){ $d920fa['page']=$b71860-1; $mb3b32['later-href']=d83c8($i8d777['candy'],$d920fa); } } $j4358b=array(); p0738($o7694f,'get notes by criteria'); $result=$ne5b87=g0d6b(); if (@$i8d777['query-returns-only-ids']) { $result=array(); $f15514=de852(); foreach ($ne5b87 as $taad65){ $taad65=r4627($taad65['ID']); if ($taad65['IsPublished'] and db44b($taad65,$f15514)) { $result[] = $taad65; } } } foreach($result as $o8ce4b => $taad65){ $taad65['_']['_id']=$taad65['ID']; $taad65['_']['_ord']=$o8ce4b; $taad65['_']['_ord_max']=count($result)-1; $j4358b[] = h6791($taad65); } $f05a16=$j4358b; if (!isset ($i8d777['show-all-notes']) or @$i8d777['show-all-notes']!=true){ $f05a16=array_slice($j4358b,0,$yd7e5d); } if ($cfbb44===false)$cfbb44=count($f05a16); if (!count($j4358b) and array_key_exists('nothing',$i8d777)) { $z2cb9d['nothing']=$i8d777['nothing']; } $ocd0fd=array ( 'class', 'superheading', 'heading', 'title', 'search-related-tag', ); foreach ($ocd0fd as $of97bf){ if(array_key_exists($of97bf,$i8d777)) { $z2cb9d[$of97bf]=$i8d777[$of97bf]; } } if ($cfbb44){ $w5cde2=e2l_get_string( 'pt--n-posts', array ('number' => $cfbb44) ); } else { $w5cde2=$_strings['pt--no-posts']; } if(array_key_exists('maximum-notes',$i8d777) and $cfbb44 >= $i8d777['maximum-notes']) { $w5cde2=$_strings['gs--many-posts']; } foreach (array ('title','heading','superheading') as $m4b24c){ if(strstr($i8d777[$m4b24c],'%total%')) { $z2cb9d[$m4b24c]=str_replace('%total%', $w5cde2,$i8d777[$m4b24c]); } } $z2cb9d['notes']=$f05a16; $z2cb9d['pages']=$mb3b32; return $z2cb9d; } function of9fb($q41529,$s6f8f5,$q8277e=false){ global$_config; list ($l7b314,$ia1f20)=f5273($q41529,$s6f8f5,$q8277e); p0738( "SELECT * FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished` AND (`Stamp` BETWEEN " .$l7b314. " AND " .$ia1f20. ") ". "ORDER BY Stamp", 'get all notes for the date '. $q8277e .'.'. $s6f8f5 .'.'. $q41529 ); $result=g0d6b(); $bb1bc2=1; $z2cb9d=array(); foreach($result as $c65afd){ if(is_numeric($q8277e)) { $j3f917=((int)$q41529) .'/'. ((int)$s6f8f5) .'/'. ((int)$q8277e) == e5a2f('Y/n/j',$c65afd['Stamp'],e0923($c65afd)); } elseif(is_numeric($s6f8f5)) { $j3f917=((int)$q41529) .'/'. ((int)$s6f8f5) == e5a2f('Y/n',$c65afd['Stamp'],e0923($c65afd)); } else { $j3f917=((int)$q41529) == e5a2f('Y',$c65afd['Stamp'],e0923($c65afd)); } if ($j3f917){ if(is_numeric($q8277e)) { $c65afd['day_number']=$bb1bc2; } $z2cb9d[] = $c65afd; $bb1bc2 ++; } } return $z2cb9d; } function e2_published_noterec_with_parameters_($parameters=array ()) { $d39a37=e2_noterec_with_parameters_($parameters); if ($d39a37['IsPublished']) return $d39a37; } function e2_noterec_with_parameters_($parameters=array ()) { global$_config; $taad65=false; $wb5445=false; if ((string) @$parameters['oalias']!=='')$wb5445=$parameters['oalias']; if ((string)$wb5445!==''){ p0738( "SELECT * FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `OriginalAlias` = '". $wb5445 ."' ". "AND `IsPublished` = 0", 'get note record by original alias' ); $taad65=g0d6b(); if(count($taad65)==1) { $taad65=@$taad65[0]; if ($taad65) return $taad65; } } $n67e85=false; if (@$parameters['draft']!=='') $n67e85=$parameters['draft']; if (@$parameters['draft2']!=='')$n67e85=$parameters['draft2']; if ($n67e85){ $taad65=r4627($n67e85); return $taad65; } if ((string) @$parameters['alias']!==''){ if ($tc45dd=e2_aliasrec_of_alias_(@$parameters['alias'])) { if ($tc45dd['EntityType']==ENTITY_TYPE_NOTE){ $taad65=r4627($tc45dd['EntityID']); if ($taad65['IsPublished']) return $taad65; } } } $ac2d18=of9fb($parameters['year'],$parameters['month'],$parameters['day']); if (@$ac2d18[$parameters['day-number']-1]) { return $ac2d18[$parameters['day-number']-1]; } } function ie56b($qd5d3d,$l1cb25,$xb2c6c,$hd19c2){ global$_config; re2f1(); @unlink(CACHE_FILENAME_DRAFTS); @unlink(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); $d39a37=array ( 'Title' => $qd5d3d, 'Text' => $l1cb25, 'FormatterID' => $_config['default_formatter'], 'OriginalAlias' => vd712('find',ENTITY_TYPE_UNSPECIFIED,'',$qd5d3d), 'Uploads' => $hd19c2, 'Stamp' => (int)time(), 'LastModified' => (int)time(), ); if ($xb2c6c and is_array($xb2c6c)) { $d39a37['Offset'] = (int)$xb2c6c['offset']; $d39a37['IsDST'] = (int)$xb2c6c['is_dst']; } $d39a37=p9943('Notes',$d39a37); return $d39a37['ID']; } function p1630($yf2de2,$xb2c6c){ $ed17d3='/^ *(\d{1,2})\.(\d{1,2})\.(\d{2}|\d{4}) +(\d{1,2})\:(\d{1,2})\:(\d{1,2}) *$/'; if(preg_match($ed17d3,$yf2de2,$s6f8f5)) { $w96b8c=gmmktime($s6f8f5[4],$s6f8f5[5],$s6f8f5[6],$s6f8f5[2],$s6f8f5[1],$s6f8f5[3]); $w96b8c -= ib2bf($xb2c6c,$w96b8c); return $w96b8c; } else { return false; } } function aa21e($d98ea6=''){ global$_fp_error,$_config,$_e2utf8__unformat_htmlentity_neasden,$_db; if(Log::$ped2b5)__log('Process note form'); try { $_fp_error=false; $v21158=$qd5d3d=$td57ac=$l1cb25=$ib4960=''; if(array_key_exists('note-id',$_POST)) $v21158=$_POST['note-id']; if(array_key_exists('title',$_POST)) $qd5d3d=trim($_POST['title']); if(array_key_exists('tags',$_POST)) $td57ac=$_POST['tags']; if(array_key_exists('text',$_POST)) $l1cb25=trim($_POST['text'],"\r\n"); if(array_key_exists('old-tags-hash',$_POST)) $ib4960=$_POST['old-tags-hash']; if(is_array($td57ac))$td57ac=implode(', ',$td57ac); $td57ac=trim($td57ac); if ($v21158=='new'){ $_e2utf8__unformat_htmlentity_neasden=($_config['default_formatter']=='neasden'); } else { $_e2utf8__unformat_htmlentity_neasden=($_POST['formatter-id']=='neasden'); } $y73f92=z07e3('Notes'); if(stripos($y73f92['Collation'],'utf8mb4')!==0){ $qd5d3d=gff7c($qd5d3d); $td57ac=gff7c($td57ac); $l1cb25=gff7c($l1cb25,true); } $wffa71=$l1cb25; $wffa71=str_replace("\n",'\n'."\n",$wffa71); $wffa71=str_replace("\r",'\r'."\r",$wffa71); $na6168=c163d(',',$td57ac,'sort'); $td57ac=implode(', ',$na6168); $k65f31=md5($td57ac); if(array_key_exists('browser-offset',$_POST)) { $xb2c6c=la618(@$_POST['browser-offset']); } else { $xb2c6c=f5c05(); } $j02b37=@$_POST['old-stamp']; $raddfe=@$_POST['stamp']; $c72487=@$_POST['alias']; if ($v21158!='new'){ $q383b7=r4627($v21158); } else { $q383b7=array(); } if ($v21158){ if ((string)$qd5d3d!=='' and (string)$l1cb25!==''){ if ($v21158=='new'){ $hd19c2=''; if(is_file(USER_FOLDER.'new-uploads.psa')) { $hd19c2=@file_get_contents(USER_FOLDER.'new-uploads.psa'); } try { $v21158=ie56b($qd5d3d,$l1cb25,$xb2c6c,$hd19c2); @unlink(USER_FOLDER.'new-uploads.psa'); $h33dd5='e2m_draft'; $a5ce5d=array ( '*note' => r4627($v21158), ); $x1fa03=[ 'success' => true, 'data' => [ 'status' => 'created', 'id' => $v21158, 'note-url' => d83c8($h33dd5,$a5ce5d), 'note-edit-url' => d83c8('e2m_note_edit',$a5ce5d) ] ]; $result=(int)$v21158; } catch (AeMySQLException $e){ e12f6($e,'Could not insert note'); $x1fa03=[ 'success' => false, 'error' => [ 'message' => 'Cannot create record' ] ]; $result=false; } } else { e2_drop_caches_for_note_($v21158); if (!$q383b7['IsPublished']) { @unlink(CACHE_FILENAME_DRAFTS); @unlink(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); } $u71671=$q383b7; $u71671['ID']=$v21158; $u71671['Title']=$qd5d3d; $u71671['Text']=$l1cb25; $u71671['FormatterID']=$q383b7['FormatterID']; $u71671['LastModified']=time(); $u71671['IsIndexed']='1'; if ($j02b37!=$raddfe){ if ($w96b8c=p1630($raddfe,$xb2c6c)) { $u71671['Stamp']=min($w96b8c,time()); } else { unset ($w96b8c); } } $e17901=$c72487; if ((string)$c72487!==''){ $ra7ff0=$c72487; } elseif (!$q383b7['IsPublished']) { $ra7ff0=$qd5d3d; } else { $ra7ff0=''; } if ($q383b7['IsPublished']) { $e17901=vd712( 'set',ENTITY_TYPE_NOTE,$v21158,$ra7ff0 ); $h33dd5='e2m_note'; $a5ce5d=array ( '*note' => $u71671, 'alias' => $e17901, ); } else { $u926c6=true; $e17901=vd712('find',ENTITY_TYPE_NOTE,$v21158,$ra7ff0); $u71671['OriginalAlias']=$e17901; $h33dd5='e2m_draft'; $a5ce5d=array ( '*note' => $u71671, 'alias' => $e17901, ); } $je449c=xc0c4( $u71671['FormatterID'],$u71671['Text'],'full' ); if(count($je449c) > 0){ e6be4($je449c); } try { kaa79('Notes',$u71671); if ($u71671['IsPublished']) { if (kd2e1($u71671)) { $u71671['IsIndexed']='1'; kaa79('Notes',$u71671); } r5b68($u71671); } $x1fa03=[ 'success' => true, 'data' => [ 'status' => 'saved', 'new-alias' => $e17901, 'note-url' => d83c8($h33dd5,$a5ce5d), 'note-edit-url' => d83c8('e2m_note_edit',$a5ce5d) ] ]; $result=(int)$v21158; } catch (AeMySQLException $e){ e12f6($e,'Could not update record'); $x1fa03=[ 'success' => false, 'error' => [ 'message' => 'Cannot update record ('. mysqli_error(). ')' ] ]; $result=false; } } if ($k65f31!=$ib4960){ h53f1(array ('NoteID' => $v21158)); foreach ($na6168 as $ce4d23){ $i70b77=o0188($ce4d23); if (!$i70b77){ $i70b77['ID']=f03de($ce4d23); } p0738( "INSERT INTO `". $_config['db_table_prefix']."NotesKeywords` ". "(`SubsetID`, `NoteID`, `KeywordID`) ". "VALUES (". ((int)$_config['db_table_subset']) .", ". ((int)$v21158) .", ". ((int)$i70b77['ID']). ")", 'add new tag bindings' ); } } if ( $d98ea6!='ajaxresult' and $result and $_POST['instant-publish']=='yes' ){ $_POST['note-id']=$v21158; e2s_note_publish(); } } else { $x1fa03=[ 'success' => false, 'error' => [ 'message' => 'Title or text is empty' ] ]; $_fp_error=FP_TITLE_OR_TEXT_EMPTY; $result=false; } } else { $x1fa03=[ 'success' => false, 'error' => [ 'message' => 'No note id/new specified' ] ]; $_fp_error=FP_NO_ID_OR_NEW; $result=false; } ecc38(d83c8('e2s_dump', array ())); } catch (AeMySQLException $e){ e12f6($e); $x1fa03=[ 'success' => false, 'error' => [ 'message' => 'Database error' ] ]; $result=false; } if ($d98ea6=='ajaxresult') return json_encode($x1fa03); else return$result; } function l3456($d1653c,$y0604c){ global$_config; if (!($d1653c and $y0604c) and !de852()) { if(Log::$ped2b5)__log('Error: e2_notes_count_generic called for invisible items unsecurely'); return null; } if (!is_bool($d1653c) or !is_bool($y0604c)) { if(Log::$ped2b5)__log ('Error: e2_notes_count_generic called with non-bool params'); return null; } if (!$d1653c and !$y0604c){ if(Log::$ped2b5)__log ('Error: e2_notes_count_generic called with nonsensical parameters'); return null; } $ud29bb=( CACHES_FOLDER . 'notes-count-p'. (int)$d1653c . ($d1653c ? ('v'. (int)$y0604c):'') . '.txt' ); $result=false; if(CACHE_NOTES_COUNTS and is_file($ud29bb)) { $result=@file_get_contents($ud29bb); } if(is_numeric($result) and $result > 0){ return$result; } else { $result=null; try { p0738( "SELECT COUNT(*) As NotesCount FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished`=". (int)$d1653c. " ". ($d1653c ? ( "AND `IsVisible`=". (int)$y0604c ):""), 'count notes with flags p'. (int)$d1653c . ($d1653c ? ('v'. (int)$y0604c):'') ); $result=g0d6b(); $result=$result[0]['NotesCount']; if(CACHE_NOTES_COUNTS)n6e52($ud29bb,$result); } catch (AeMySQLException $e){ e12f6($e); if(Log::$ped2b5)__log('Could not count notes'); } return$result; } } function u5421($l1cb25){ $qa80da=$l1cb25; $qa80da=preg_match( '/^(\<\/div\>)?\<p( class\=\"lead\")?\>(.*)\<\/p\>$/m', $qa80da, $z9c28d ); $qa80da=$z9c28d[3]; if (!$qa80da)$qa80da=$l1cb25; $qa80da=str_replace(array ( '<p>','<blockquote>','<ul>','<ol>','<br />', ), "\n",$qa80da); $qa80da=trim(strip_tags($qa80da)); if(strpos($qa80da,"\n")!==false){ $qa80da=substr($qa80da,0,strpos($qa80da,"\n")-1); $qa80da=trim($qa80da,' :.()'."\n"); } if(preg_match('/^(.{100,}?)[:.!?()]|'."\n".'/s',$qa80da,$z9c28d)) { $qa80da=trim($z9c28d[0],' :.()'."\n"); } if(preg_match('/^(.{150,}?)[:.!?(),]/s',$qa80da,$z9c28d)) { $qa80da=trim($z9c28d[0],' :.()'."\n"); } if(preg_match('/^(.{200,}?)[:.!?(), ]/s',$qa80da,$z9c28d)) { $qa80da=trim($z9c28d[0],' :.()'."\n"); } if(in_array($qa80da[strlen($qa80da)-1], array (',',' '))) { $qa80da=trim($qa80da,', '). '...'; } if(mb_strlen($qa80da) > 250){ $qa80da=mb_substr($qa80da,0,250). '...'; } if ($qa80da[-1]=='.')$qa80da=mb_substr($qa80da,0, -1); if ($qa80da[-1]==':')$qa80da=mb_substr($qa80da,0, -1); if ($qa80da[-1]=='!')$qa80da=mb_substr($qa80da,0, -1); return $qa80da; } function db44b($d39a37,$f15514=false){ if ($f15514) return true; return $d39a37['IsVisible'] and $d39a37['Stamp'] <= time(); } function f6f32($f15514=false){ if ($f15514){ return ''; } else { return 'AND (n.`IsVisible` = 1 AND n.`Stamp` <= '. time() .') '; } } function e2_populate_read_counts_in_notes_ctree_($i6b12c){ global$_config; $uc6b5b=array(); foreach ($i6b12c as $o8ce4b => $le244c){ if (@$le244c['_']['_id']) { $uc6b5b[] = "(`EntityID` = ". $le244c['_']['_id'].")"; } } if(count($uc6b5b)) { $uc6b5b=implode(' OR ',$uc6b5b); try { p0738( "SELECT `EntityID`, SUM(`ReadCount`) ReadCount ". "FROM `". $_config['db_table_prefix']."Actions` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND (". $uc6b5b .") ". "GROUP BY `EntityID`", 'get read counts to populate notes CTree' ); $rfa816=g0d6b(); foreach ($rfa816 as $c33c9b){ $s0980a[$c33c9b['EntityID']] = $c33c9b['ReadCount']; } foreach ($i6b12c as $o8ce4b => $le244c){ $i6b12c[$o8ce4b]['read-count']=$s0980a[$le244c['_']['_id']]; } } catch (AeMySQLException $e){ e12f6($e); if(Log::$ped2b5)__log('Could not populate read counts in notes ctree'); } } return $i6b12c; } define('DRAFT_PREVIEW_LENGTH',100); function e2m_drafts(){ global$_strings,$_config; if(Log::$ped2b5)__log('Drafts list: Working...'); $gda48a=null; if(CACHE_DRAFTS and is_file(CACHE_FILENAME_DRAFTS)) { $gda48a=@unserialize(file_get_contents(CACHE_FILENAME_DRAFTS)); } if(CACHE_DRAFTS and is_array($gda48a)) { if(Log::$ped2b5)__log('Drafts list: Retrieve cached ctree'); } else { if(Log::$ped2b5)__log('Drafts list: Assemle cacheable ctree...'); $gda48a=array(); if(Log::$ped2b5)__log('Drafts list: Select'); $a3f2a5=''; if($_config['limit_drafts']) { $a3f2a5="LIMIT ". ((int)$_config['limit_drafts']); } p0738( "SELECT * FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished`=0 ". "ORDER BY `SourceID` DESC, `LastModified` DESC ". $a3f2a5, 'get drafts to display on Drafts page' ); $result=g0d6b(); $j4358b=array(); foreach($result as $o8ce4b => $d39a37){ $taad65=array(); $taad65['_']['_id']=$d39a37['ID']; $taad65['_']['_ord']=$o8ce4b; $taad65['_']['_ord_max']=count($result)-1; $taad65['href']=d83c8('e2m_draft', array ('*note' => $d39a37)); $taad65['title']=z6f10(htmlspecialchars($d39a37['Title'],ENT_NOQUOTES,HSC_ENC)); if (isset ($taad65['image-href'])) unset ($taad65['image-href']); $d39a37['_']['_id']=$d39a37['ID']; $d39a37['_']['_ord']=0; $d39a37['_']['_ord_max']=0; $w8e4cd=h6791($d39a37,true); $taad65['_']['_resources']=null; if ($d39a37['FormatterID']=='neasden'){ $taad65['_']['_resources']=$w8e4cd['format-info']['resources-detected']; } elseif ($d39a37['FormatterID']=='calliope'){ $taad65['_']['_resources']=xc0c4( $d39a37['FormatterID'],$d39a37['Text'],'full' ); } $taad65=array_merge($taad65,l1a48($d39a37,false)); $taad65['text-fragment']=strip_tags($w8e4cd['text']); $f2ab2d=false; if(mb_strlen($taad65['text-fragment']) > DRAFT_PREVIEW_LENGTH) { $f2ab2d=mb_strpos($taad65['text-fragment'],'.',DRAFT_PREVIEW_LENGTH); } if ($f2ab2d!==false){ $taad65['text-fragment']=mb_substr($taad65['text-fragment'],0,$f2ab2d+1); } $gda48a[] = $taad65; } if(CACHE_DRAFTS)n6e52(CACHE_FILENAME_DRAFTS,serialize($gda48a)); } if(Log::$ped2b5)__log('Drafts list: Put thumbnail without cache'); if ($gda48a){ foreach ($gda48a as $o8ce4b => $l9e366){ $gda48a[$o8ce4b]['thumbs']=l2e82(@$l9e366['_']['_resources']); } } if(Log::$ped2b5)__log('Drafts list: Done'); $z2cb9d=array ( 'title' => $_strings['pt--drafts'], 'heading' => $_strings['pt--drafts'], ); if(count($gda48a)) { $z2cb9d['drafts']=$gda48a; } else { $z2cb9d['nothing']=$_strings['gs--no-drafts']; } return $z2cb9d; } function e2m_draft($parameters=array ()) { global$_strings,$_config,$o57de2; $taad65=$parameters['*note']; if (!$taad65 or $taad65['IsPublished']) { $parameters['alias']=$parameters['oalias']; unset($parameters['oalias']); $taad65=e2_noterec_with_parameters_($parameters); if ($taad65){ $td58c0=d83c8('e2m_note', array ('*note' => $taad65)); return e2_go_to($td58c0); } } if (!$taad65) return e2_error404_mode(); $taad65['_']['_id']=$taad65['ID']; $taad65['_']['_ord']=0; $taad65['_']['_ord_max']=0; $w8e4cd=h6791($taad65); $x45513=array ( '.note-id' => $taad65['ID'], 'form-action' => d83c8('e2s_note_publish'), 'submit-text' => $_strings['fb--publish-draft'], 'can-schedule?' => false, 'can-publish?' => !@$_config['read_only'], ); return array ( 'title' => $taad65['Title'].' ('. $_strings['wd--draft'] .')', 'notes' => array ('only' => $w8e4cd), 'form' => 'form-note-publish', 'form-note-publish' => $x45513, ); } function e2m_draft_preview($parameters=array ()) { return e2_error404_mode(); } function e2_draft_alias_use_count($h176fe){ global$_config; if(Log::$ped2b5)__log('Drafts: find duplicate OriginalAliases...'); if(CACHE_DRAFTS_ALIAS_USE_COUNTS and is_file(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS)) { $fda552=@unserialize(file_get_contents(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS)); } if(CACHE_DRAFTS_ALIAS_USE_COUNTS and is_array($fda552)) { if(Log::$ped2b5)__log('Drafts: retrieve cached'); } else { if(Log::$ped2b5)__log('Drafts: assemle cacheable...'); $fda552=array(); p0738( "SELECT `OriginalAlias` FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished`=0 ". "ORDER BY `ID`", 'get original aliases of drafts to calculate use counts' ); $result=g0d6b(); $j4358b=array(); foreach($result as $o8ce4b => $d39a37){ @$fda552[$d39a37['OriginalAlias']] ++; } if(CACHE_DRAFTS_ALIAS_USE_COUNTS){ n6e52(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS,serialize($fda552)); } } return $fda552[$h176fe]; } function e2drafts__preview_key($taad65){ return md5($taad65['Text'].$taad65['LastModified']); } function m29a1(){ global$_strings,$_user_folder_name; $veccd7='http://'. $_strings['e2--website-host'] .'/'; $p68966='('. $_strings['e2--release'] .' '. E2_RELEASE .', v'. E2_VERSION .')'; return [ 'built?' => BUILT, 'installed?' => (h2ac5()!==null), 'version' => 'v'. E2_VERSION, 'version-description' => $_strings['e2--vname-aegea'] .' '. $p68966, 'user-folder-name' => $_user_folder_name, 'cookie-prefix' => v8c3b(), 'href' => $veccd7, 'about' => ( '<span title="E2 '.$p68966 .'">'. $_strings['e2--powered-by'] .' '. '<a href="'. $veccd7 .'" class="nu"><u>'. $_strings['e2--vname-aegea'] .'</u> '. '<span class="e2-svgi">'. ef42c('aegea') .'</span></a></span>' ), ]; } function sc4da($qc48ba,$i6b12c,$v89650,$vcadc1,$te22d5){ global$full_blog_url,$content, $_config, $_candies_indexable, $_candies_indexable_conditionally, $_template, $_newsfeeds, $_current_url; $meta['base-href']=$full_blog_url. '/'; $meta['current-href']=$_current_url; $meta['stylesheets']=q37ca(); $meta['scripts']=b4753(); $meta['newsfeeds']=$_newsfeeds; $meta['favicon-type']='image/x-icon'; $meta['favicon-href']='favicon.ico'; if ($oa01d9=m2461()) { $meta['favicon-type']=ac952($oa01d9); $meta['favicon-href']=$oa01d9; $meta['apple-touch-icon-href']=m2461('square'); } $meta['navigation-links'] = [[ 'rel' => 'index', 'href' => d83c8('e2m_frontpage', ['page' => 1]), 'id' => 'link-index', ]]; if (!empty ($te22d5)) { foreach (['prev','next','earlier','later'] as $gc47d1){ if(array_key_exists($gc47d1 .'-href',$te22d5)) { $z7ffc4=$gc47d1; if ($gc47d1=='earlier')$z7ffc4='prev'; if ($gc47d1=='later')$z7ffc4='next'; $meta['navigation-links'][] = [ 'rel' => $z7ffc4, 'href' => $te22d5[$gc47d1 .'-href'], 'id' => 'link-'. $gc47d1, ]; } } } $d1e2ad='noindex, follow'; if (@$_config['index_follow_everything']) { $d1e2ad='index, follow'; } if(in_array($qc48ba,$_candies_indexable)) { $meta['robots']='index, follow'; } if(in_array($qc48ba,$_candies_indexable_conditionally)) { $meta['robots']=$d1e2ad; } $meta['viewport']=$_template['meta_viewport']; if(is_file(MEDIA_ROOT_FOLDER.'manifest.json')) { $meta['manifest-href']=$full_blog_url. '/manifest.json'; } $meta['og-images'] = array (); if(is_array($i6b12c['only']['og-images'])) { $meta['og-images']=$i6b12c['only']['og-images']; $meta['twitter-card']='summary_large_image'; } if(is_array($v89650['og-images'])) { $meta['og-images']=$v89650['og-images']; $meta['twitter-card']='summary_large_image'; } if (!count($meta['og-images'])) { $meta['og-images'] = array ($vcadc1['userpic-large-href']); $meta['twitter-card']='summary'; } return$meta; } function k5e47(){ global$_superconfig,$_config; $c34a31=[ 'new-note-href' => d83c8('e2m_write'), 'drafts-href' => d83c8('e2m_drafts'), 'drafts-count' => (int)l3456(false,true), 'settings-href' => d83c8('e2m_settings'), 'theme-preview-href' => d83c8('e2m_theme_preview', array ('theme' => '')), 'password-href' => d83c8('e2m_password', array ('recovery-key' => '')), 'database-href' => d83c8('e2m_database'), 'timezone-href' => d83c8('e2m_timezone'), 'sessions-href' => d83c8('e2m_sessions'), 'sign-out-href' => d83c8('e2m_sign_out'), ]; if (pda67()) { $c34a31['get-backup-href']=d83c8('e2m_get_backup'); } if (@$_config['read_only']) { unset ($c34a31['new-note-href']); unset ($c34a31['settings-href']); unset ($c34a31['timezone-href']); } if (@$_superconfig['disallow_themes_preview']) { unset ($c34a31['theme-preview-href']); } if (@$_superconfig['disallow_db_config']) { unset ($c34a31['database-href']); } list ($ufe9e2,$i85ee4,$j20699)=n2a6b(); if ($ufe9e2){ $c34a31['new-comments-count']=$ufe9e2; $c34a31['new-comments-href']=$j20699; } return $c34a31; } function e2m_tags(){ global$_strings; $z2cb9d['title']=$_strings['pt--tags']; $z2cb9d['heading']=$_strings['pt--tags']; $z2cb9d['tags']=ge531([]); $mcd342=mbb5b(true); if ($mcd342===null){ $z2cb9d['unavailable?']=true; } else { $z2cb9d['tags']['each']=$mcd342; if(count($mcd342)==0){ $z2cb9d['nothing']=$_strings['gs--no-tags']; } } return $z2cb9d; } function e2m_tag($parameters=array ()) { global $settings, $_config, $_current_tag, $_strings, $b71860, $full_blog_url; if(Log::$ped2b5)__log('Tag {'); if(array_key_exists('*tags',$parameters)) { $t59aeb=$parameters['*tags']; } if (!$t59aeb[0]) return e2_error404_mode(); $td7df5=$t59aeb[0]; $n7186e=$parameters['tag-alias']; if(count($t59aeb)==1){ $_current_tag=$td7df5['Keyword']; } $b71860=$parameters['page']; $rc2b7b=$_config['db_table_prefix']; $yd7e5d=$settings['appearance']['notes_per_page']; foreach ($t59aeb as $l9e366) if ($l9e366){ $y56790[] = "nk.KeywordID=". $l9e366['ID']; } $y56790='('.implode(' OR ',$y56790).')'; $f15514=de852(); $y56790.='AND IsPublished=1 '; $y56790.=f6f32($f15514); $w9b0c2=count($t59aeb); $m7a86c=($b71860-1)*$yd7e5d; $waa9f7=$yd7e5d; $pac5c7=( "SELECT SQL_CALC_FOUND_ROWS n.*, COUNT(*) ". "FROM `". $rc2b7b ."Notes` n ". "JOIN `". $rc2b7b ."NotesKeywords` nk ON nk.`NoteID` = n.`ID` ". "WHERE n.`SubsetID`=". $_config['db_table_subset'] ." ". "AND nk.`SubsetID`=". $_config['db_table_subset'] ." ". "AND ". $y56790 . "GROUP BY n.ID ". "HAVING COUNT(*)>=". $w9b0c2 ." ". "ORDER BY n.`Stamp` DESC ". "LIMIT ". $m7a86c .", ". $waa9f7 ); p0738($pac5c7); $result=g0d6b(); p0738("SELECT FOUND_ROWS() AS cnt"); $e67363=g0d6b(); $cfbb44=$e67363 ? (int)$e67363[0]['cnt']:0; $mb3b32=array(); if ($cfbb44){ $fae0fe=ceil($cfbb44/$yd7e5d); $mb3b32['timeline?']=true; $mb3b32['count']=$fae0fe; $mb3b32['this']=$b71860; $mb3b32['earlier-title']=$_strings['gs--earlier']; $mb3b32['later-title']=$_strings['gs--later']; $d920fa=$parameters; if ($b71860 < $fae0fe){ $d920fa['page']=$b71860+1; $mb3b32['earlier-href']=d83c8('e2m_tag',$d920fa); } if ($b71860 > 1){ $d920fa['page']=$b71860-1; $mb3b32['later-href']=d83c8('e2m_tag',$d920fa); } } if ($b71860 > $fae0fe){ return e2_error404_mode(); } if ($cfbb44==0){ if (!$f15514){ return e2_error404_mode(); } if ($b71860!=1){ return e2_error404_mode(); } } $j4358b=[]; foreach($result as $o8ce4b => $taad65){ $taad65['_']['_id']=$taad65['ID']; $taad65['_']['_ord']=$o8ce4b; $taad65['_']['_ord_max']=count($result)-1; $j4358b[] = h6791($taad65); } if ($w9b0c2==1){ if ($f15514){ $e97a59['edit-href']=d83c8( 'e2m_tag_edit', array ('tag-alias' => $n7186e) ); } if ((string)$td7df5['Description']!==''){ $z2bfe4=db7f1($td7df5['Description'],'full'); $f67daf=$z2bfe4['text-final']; $e97a59['description']=$f67daf; $e97a59['description-format-info']=$z2bfe4['meta']; p57ad(@$z2bfe4['meta']['links-required']); } $a3ad42=d83c8('e2m_tag_rss', array ('tag-alias' => $n7186e)); $b9d19f=d83c8('e2m_tag_json', array ('tag-alias' => $n7186e)); r3010( 'rss', f6f51() .': '. $td7df5['Keyword'], $a3ad42 ); r3010( 'json', f6f51() .': '. $td7df5['Keyword'], $b9d19f ); $e97a59['og-images']=sdbcc( 'tag',$td7df5['ID'], $e97a59['description-format-info']['resources-detected'] ); } $d96963=( e2l_get_string('pt--n-posts', array ('number' => $cfbb44)). ' '. $_strings['gs--tagged'] ); $n8235e=array(); foreach ($t59aeb as $l9e366){ $n8235e[] = htmlspecialchars($l9e366['Keyword'],ENT_COMPAT,HSC_ENC); } $n8235e=implode(', ',$n8235e); $wb73b1=htmlspecialchars($td7df5['PageTitle'],ENT_COMPAT,HSC_ENC); if ((string)$wb73b1!==''){ $qd5d3d=$wb73b1; $qd6b14=$d96963 .' '. $n8235e; $xf74f5=$wb73b1; } else { $qd5d3d=f6f51() .': '. $d96963 .' '. $n8235e; $qd6b14=$d96963; $xf74f5=$n8235e; } $z2cb9d=array ( 'title' => $qd5d3d, 'superheading' => $qd6b14, 'heading' => $xf74f5, 'pages' => $mb3b32, 'notes' => $j4358b, 'tags' => ge531($parameters), ); if ($f67daf){ $z2cb9d['summary']=u5421($f67daf); } if(count($t59aeb)==1){ $z2cb9d['tag']=$e97a59; if (de852()) { $z2cb9d['related-edit-href']=$e97a59['edit-href']; $z2cb9d['related-edit-title']=$_strings['tt--edit-tag']; } } if(Log::$ped2b5)__log('} // Tag'); return $z2cb9d; } function e2m_tag_edit($parameters=array()) { global$_strings; if(array_key_exists('*tag',$parameters)) { $td7df5=$parameters['*tag']; } if (!$td7df5) return e2_error404_mode(); $je449c=xc0c4( 'neasden',$td7df5['Description'],'full' ); $y75e1b=uf898( 'tag',$td7df5['ID'],$je449c ); j2f83( 'Keywords', $td7df5, $je449c ); $kc999b=pd10e(); $z480ee=[ 'enabled?' => t1363($kc999b), 'each' => $y75e1b, 'upload-action' => d83c8('e2j_file_upload'), 'remove-action' => d83c8('e2j_file_remove'), ]; $icd831=array ( '.tag-id' => $td7df5['ID'], '.formatter-id' => 'neasden', 'form-action' => d83c8('e2s_tag_edit'), 'submit-text' => $_strings['fb--save-changes'], 'tag' => htmlspecialchars($td7df5['Keyword'],ENT_COMPAT,HSC_ENC), 'page-title' => htmlspecialchars($td7df5['PageTitle'],ENT_COMPAT,HSC_ENC), 'page-title-placeholder' => htmlspecialchars($td7df5['Keyword'],ENT_COMPAT,HSC_ENC), 'urlname' => htmlspecialchars($parameters['tag-alias'],ENT_COMPAT,HSC_ENC), 'description' => htmlspecialchars($td7df5['Description'],ENT_COMPAT,HSC_ENC), 'favourite?' => (bool)$td7df5['IsFavourite'], 'space-usage' => zaf64($kc999b), ); $icd831['.cache-sensitive-hash']=md5( $icd831['tag'] . $icd831['uploads'] . $icd831['urlname'] ); $z2cb9d=array ( 'body-uploads-enabled?' => t1363($kc999b), 'title' => $_strings['pt--tag-edit'] .': '. $td7df5['Keyword'], 'heading' => $_strings['pt--tag-edit'], 'form' => 'form-tag', 'form-tag' => $icd831, 'uploads' => $z480ee, 'related-delete-href' => d83c8('e2m_tag_delete', array ('*tag' => $td7df5)), ); return $z2cb9d; } function e2m_tag_flag_ajax($parameters){ r705b([ 'flag-name' => 'tag', 'candy-name' => 'e2m_tag_flag_ajax', 'parameters' => $parameters, 'flipping-function' => function () use ($parameters){ k2e88($parameters); }, ]); } function k2e88($parameters){ if(array_key_exists('*tag',$parameters)) { $td7df5=$parameters['*tag']; } if (!$td7df5) return e2_error404_mode(); @unlink(CACHE_FILENAME_FAVTAGS); @unlink(CACHE_FILENAME_TAGS); @unlink(CACHE_FILENAME_TAGS_FULL); @unlink(CACHE_FILENAME_TAGS_AUTHOR); @unlink(CACHE_FILENAME_TAGS_AUTHOR_FULL); kaa79('Keywords', array ( 'ID' => $td7df5['ID'], $parameters['flag'] => (int) ($parameters['value']==1), )); return true; } function e2m_tag_delete($parameters=array()) { global$_strings; if(array_key_exists('*tag',$parameters)) { $td7df5=$parameters['*tag']; } if (!$td7df5) return e2_error404_mode(); $vecc14=array ( '.tag-id' => $td7df5['ID'], 'caution-text' => e2l_get_string('gs--tag-will-be-deleted-notes-remain', array ( 'tag' => htmlspecialchars($td7df5['Keyword'],ENT_COMPAT,HSC_ENC) )), 'tag' => htmlspecialchars($td7df5['Keyword'],ENT_COMPAT,HSC_ENC), 'form-action' => d83c8('e2s_tag_delete'), 'submit-text' => $_strings['fb--delete'], ); $z2cb9d=array ( 'title' => $_strings['pt--tag-delete'] .': '. $td7df5['Keyword'], 'heading' => $_strings['pt--tag-delete'], 'form' => 'form-tag-delete', 'form-tag-delete' => $vecc14, ); return $z2cb9d; } function e2m_untagged(){ global$_strings,$_config; return vd864(array ( 'query' => "SELECT n.* FROM `". $_config['db_table_prefix']."Notes` n ". "LEFT OUTER JOIN `". $_config['db_table_prefix']."NotesKeywords` nk ". "ON nk.`NoteID` = n.`ID` ". "WHERE n.`SubsetID`=". $_config['db_table_subset'] ." ". "AND nk.`SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished`=1 ". "AND nk.`KeywordID` IS NULL ". f6f32(de852()). "ORDER BY n.`Stamp` DESC", 'title' => $_strings['pt--posts-without-tags'], 'heading' => $_strings['pt--posts-without-tags'], 'nothing' => $_strings['gs--no-posts-without-tags'], 'show-all-notes' => true, )); return $z2cb9d; } function e2s_tag_edit(){ global$_strings,$_config; $r76f09=$ce4d23=$f67daf=$ra7ff0=''; if(array_key_exists('tag-id',$_POST)) $r76f09=$_POST['tag-id']; if(array_key_exists('tag',$_POST)) $ce4d23=$_POST['tag']; if(array_key_exists('page-title',$_POST)) $wb73b1=trim($_POST['page-title'],"\r\n"); if(array_key_exists('description',$_POST)) $f67daf=trim($_POST['description'],"\r\n"); if(array_key_exists('urlname',$_POST)) $ra7ff0=trim($_POST['urlname'],"\r\n"); if(array_key_exists('cache-sensitive-hash',$_POST)) { $m3c58b=$_POST['cache-sensitive-hash']; $obb9a8=md5($ce4d23.$ra7ff0); } $y73f92=z07e3('Notes'); if(stripos($y73f92['Collation'],'utf8mb4')!==0){ $ce4d23=gff7c($ce4d23); $wb73b1=gff7c($wb73b1); $f67daf=gff7c($f67daf,true); } p0738( "SELECT * FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID` = ".((int)$r76f09)."", 'get tag record to update' ); $u53e61=g0d6b(); if(count($u53e61)!=1) die; $pb19ad=$u53e61[0]; p0738( "SELECT * FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `Keyword` = '". u7928($ce4d23) ."' ". "AND (`ID` != ".((int)$r76f09).")", 'make sure new tag name does not conflict with existing ones' ); $u53e61=g0d6b(); if(count($u53e61)==0){ if ($obb9a8!=$m3c58b){ x7996(); } @unlink(CACHE_FILENAME_FAVTAGS); @unlink(CACHE_FILENAME_TAGS); @unlink(CACHE_FILENAME_TAGS_FULL); @unlink(CACHE_FILENAME_TAGS_AUTHOR); @unlink(CACHE_FILENAME_TAGS_AUTHOR_FULL); $pb19ad['ID'] = ((int)$r76f09); $pb19ad['Keyword']=$ce4d23; $pb19ad['PageTitle']=$wb73b1; $pb19ad['Description']=$f67daf; kaa79('Keywords',$pb19ad); $e17901=vd712( 'set',ENTITY_TYPE_TAG,$pb19ad['ID'],$ra7ff0 ); e2_go_to(d83c8('e2m_tag', array ('tag-alias' => $e17901))); } else { x8a40($_strings['er--cannot-rename-tag'],E2E_USER_ERROR); i4930(); } die; } function e2s_tag_delete(){ global$_strings,$_config; $sb80bb=((int)$_POST['tag-id']); x7996(); @unlink(CACHE_FILENAME_FAVTAGS); @unlink(CACHE_FILENAME_TAGS); @unlink(CACHE_FILENAME_TAGS_FULL); @unlink(CACHE_FILENAME_TAGS_AUTHOR); @unlink(CACHE_FILENAME_TAGS_AUTHOR_FULL); p0738( "DELETE FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID`=". $sb80bb ); p0738( "DELETE FROM `". $_config['db_table_prefix']."NotesKeywords` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `KeywordID`=". $sb80bb ); e2_go_to(d83c8('e2m_tags')); die; } function oaf16($t07f25){ global$_current_tag,$_config; $h9df9d=null; if(CACHE_FAVTAGS and is_file(CACHE_FILENAME_FAVTAGS)) { $h9df9d=@unserialize(file_get_contents(CACHE_FILENAME_FAVTAGS)); } if (!is_array($h9df9d)) { try { p0738( "SELECT * FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND IsFavourite = 1 ORDER BY `Keyword`", 'get favorite tags for tags menu' ); $l9cdff=g0d6b(); $h9df9d=array(); foreach ($l9cdff as $q04ff0){ $dc6827['tag']=htmlspecialchars($q04ff0['Keyword'],ENT_NOQUOTES,HSC_ENC); $dc6827['href']=d83c8( 'e2m_tag', array ('*tag' => $q04ff0) ); $h9df9d[] = $dc6827; } if(CACHE_FAVTAGS)n6e52(CACHE_FILENAME_FAVTAGS,serialize($h9df9d)); } catch (AeMySQLException $e){ e12f6($e); if(Log::$ped2b5)__log('Count not get tags menu from database'); } } if (!is_array($h9df9d)) return null; $m8a4f1=false; foreach ($h9df9d as $o8ce4b => $l9e366){ $h9df9d[$o8ce4b]['current?'] = ( $h9df9d[$o8ce4b]['tag']==$_current_tag ); if ($h9df9d[$o8ce4b]['current?']) { $m8a4f1=true; $u08187=$t07f25; $u08187['flag']='IsFavourite'; $u08187['value']=0; if (de852()) { $h9df9d[$o8ce4b]['pinnable?']=true; $h9df9d[$o8ce4b]['pinned?']=true; $h9df9d[$o8ce4b]['pinned-toggle-href'] = ( d83c8('e2m_tag_flag_ajax',$u08187) ); } } } if (de852()) { if (!$m8a4f1 and array_key_exists('*tag',$t07f25)) { $wa55a9=$t07f25; $wa55a9['flag']='IsFavourite'; $wa55a9['value']=1; $fd5a7a=array ( 'tag' => htmlspecialchars($t07f25['*tag']['Keyword'],ENT_NOQUOTES,HSC_ENC), 'href' => d83c8('e2m_tag',$t07f25), 'current?' => true, 'pinnable?' => true, 'pinned?' => false, 'pinned-toggle-href' => d83c8('e2m_tag_flag_ajax',$wa55a9), ); $h9df9d[] = $fd5a7a; } } return $h9df9d; } function kce23($v21158){ global$_config; $k0dff3=array(); p0738( "SELECT k.* ". "FROM `". $_config['db_table_prefix']."Keywords` k, ". "`". $_config['db_table_prefix']."NotesKeywords` nk ". "WHERE k.`SubsetID`=". $_config['db_table_subset'] ." ". "AND nk.`SubsetID`=". $_config['db_table_subset'] ." ". "AND nk.`NoteID`=". ((int)$v21158) ." ". "AND k.`ID`=nk.`KeywordID` ". "ORDER BY `Keyword`", 'get tag records for note by id' ); $k0dff3=g0d6b(); return $k0dff3; } function h53f1($seaa60){ global$_config; $b316e8=array(); foreach (array ( 'ID', 'NoteID', 'KeywordID', ) as $f06e3d) if(array_key_exists($f06e3d,$seaa60)) { $w6a7f2[] = '`'. $f06e3d .'`'."='". u7928($seaa60[$f06e3d]) ."'"; if ($f06e3d=='ID')$k729d6='tagbinging-id'; if ($f06e3d=='NoteID')$k729d6='tagbinging-note-id'; if ($f06e3d=='KeywordID')$k729d6='tagbinging-tag-id'; $b316e8[$k729d6]=$seaa60[$f06e3d]; } $w1b1cc=( "DELETE FROM `". $_config['db_table_prefix']."NotesKeywords` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND ". implode(' AND ',$w6a7f2) ); p0738($w1b1cc); } function f03de($ce4d23){ @unlink(CACHE_FILENAME_TAGS); @unlink(CACHE_FILENAME_TAGS_FULL); @unlink(CACHE_FILENAME_TAGS_AUTHOR); @unlink(CACHE_FILENAME_TAGS_AUTHOR_FULL); $pb19ad=array ( 'Keyword' => $ce4d23, 'OriginalAlias' => vd712('find',ENTITY_TYPE_UNSPECIFIED,'',$ce4d23), 'Description' => '', ); $pb19ad=p9943('Keywords',$pb19ad); $a419a1=vd712( 'set',ENTITY_TYPE_TAG,$pb19ad['ID'],$ce4d23 ); if ($a419a1!=$pb19ad['OriginalAlias']) { $pb19ad['OriginalAlias']=$a419a1; kaa79('Keywords',$pb19ad); } return $pb19ad['ID']; } function ge531($parameters){ if (($u933dd=mbb5b()) === null) return []; $ec6ce7['each']=$u933dd; if(count($ec6ce7['each']) > 0){ $ec6ce7['href']=d83c8('e2m_tags'); } if (($bbd876=oaf16($parameters)) !== null){ $ec6ce7['menu-each']=$bbd876; } return $ec6ce7; } function mbb5b($ne9dc9=false){ global$_config; $f15514=de852(); $ud29bb=CACHE_FILENAME_TAGS; if ($f15514)$ud29bb=CACHE_FILENAME_TAGS_AUTHOR; if ($ne9dc9){ $ud29bb=CACHE_FILENAME_TAGS_FULL; if ($f15514)$ud29bb=CACHE_FILENAME_TAGS_AUTHOR_FULL; } $r8da94=null; if(CACHE_TAGS and is_file($ud29bb)) { $r8da94=@unserialize(file_get_contents($ud29bb)); } if (!is_array($r8da94)) { try { p0738( "SELECT * FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "ORDER BY `Keyword`", 'get all tags' ); $r35016=array(); foreach (g0d6b() as $pb19ad){ $ce4d23['tag']=htmlspecialchars($pb19ad['Keyword'],ENT_NOQUOTES,HSC_ENC); $ce4d23['favourite?'] = (bool)$pb19ad['IsFavourite']; $ce4d23['notes-count']=0; $ce4d23['last-used']=0; $ce4d23['freshness']=0; $ce4d23['weight']=0; if ($ne9dc9){ $ce4d23['href']=d83c8('e2m_tag', array ('*tag' => $pb19ad)); } $r35016[$pb19ad['ID']] = $ce4d23; } p0738( "SELECT nk.KeywordID, COUNT(DISTINCT n.ID) as Count, max(n.Stamp) as LastUsed ". "FROM `". $_config['db_table_prefix']."NotesKeywords` nk, ". "`". $_config['db_table_prefix']."Notes` n ". "WHERE nk.`SubsetID`=". $_config['db_table_subset'] ." ". "AND n.`SubsetID`=". $_config['db_table_subset'] ." ". "AND n.`IsPublished` = 1 ". f6f32($f15514). "AND nk.`NoteID` = n.`ID` ". "GROUP BY nk.KeywordID", 'get tags ordering info' ); $o9fdd5=0; $f8f57c=0; $m06894=0; foreach (g0d6b() as $c28a42){ $dc6827 =& $r35016[$c28a42['KeywordID']]; $dc6827['notes-count']=$c28a42['Count']; if (@$dc6827['last-used'] < $c28a42['LastUsed']) { $dc6827['last-used']=$c28a42['LastUsed']; $l452b4=(time()-$dc6827['last-used']) / SECONDS_IN_A_YEAR; $dc6827['freshness']=pow(1/2,$l452b4); } $o9fdd5=max($o9fdd5,$dc6827['notes-count']); $f8f57c=max($f8f57c,$dc6827['freshness']); $m06894=max($m06894,$dc6827['notes-count']*$dc6827['freshness']); } $r8da94=array(); foreach ($r35016 as $d865c0 => $l9e366){ if (!$f15514 and $l9e366['notes-count']==0) continue; $m95e80=mb_strtolower($l9e366['tag']); $r8da94[$m95e80]=$l9e366; if ($f8f57c!=0){ $r8da94[$m95e80]['freshness']=$l9e366['freshness']/$f8f57c; } else { $r8da94[$m95e80]['freshness']=0; } if ($m06894!=0){ $r8da94[$m95e80]['weight'] = ( $l9e366['freshness']*$l9e366['notes-count']/$m06894 ); } else { $r8da94[$m95e80]['weight']=0; } if ($r8da94[$m95e80]['favourite?'])$r8da94[$m95e80]['weight']=1; } if(CACHE_TAGS)n6e52($ud29bb,serialize($r8da94)); } catch (AeMySQLException $e){ e12f6($e); if(Log::$ped2b5)__log('Could not get tags from database'); } } return $r8da94; } function o0188($td7df5){ global$_config; p0738( "SELECT * FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `Keyword`='". u7928($td7df5) ."'", 'get tag by name' ); $o8ce4b=g0d6b(); if (isset ($o8ce4b[0])) { return $o8ce4b[0]; } else { return null; } } function d8770($hd7ca3){ global$_config; p0738( "SELECT * FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `OriginalAlias`='".u7928($hd7ca3)."'", 'get tag by legacy urlname name' ); $rfa816=g0d6b(); if (isset ($rfa816[0])) { return $rfa816[0]; } else { return null; } } function n4e28($sb80bb){ global$_config; p0738( "SELECT * FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID`='".((int)$sb80bb)."'", 'get tag by id' ); $rfa816=g0d6b(); if (isset ($rfa816[0])) { return $rfa816[0]; } else { return null; } } function e2_tagrecs_with_parameters_($parameters){ $fbdcf3=array(); if (@$parameters['tag-alias'] or $parameters['tag-alias']==='0'){ $fbdcf3=explode(',',$parameters['tag-alias']); } $k0dff3=array(); foreach ($fbdcf3 as $hd7ca3) if ($hd7ca3 or $hd7ca3==='0'){ if ( $tc45dd=e2_aliasrec_of_alias_(@$hd7ca3) and ($tc45dd['EntityType']==ENTITY_TYPE_TAG) and ($pb19ad=n4e28($tc45dd['EntityID'])) ) { $k0dff3[] = $pb19ad; } else { if ($r3ee3f=d8770($hd7ca3)) { $k0dff3[] = $r3ee3f; } } } return $k0dff3; } function h2e04(){ global$full_blog_url; static $t0d5f1; $f3c6e0=e7874(); if (empty ($t0d5f1)) { $t0d5f1=md5($full_blog_url .'email'. $f3c6e0); } return $t0d5f1; } function zd8c5(){ global$full_blog_url; static $b05fa8; $f3c6e0=e7874(); if (empty ($b05fa8)) { $b05fa8=md5($full_blog_url .'nospam'. $f3c6e0.date('n-Y')); } return $b05fa8; } function re7ec(){ global$full_blog_url; static $o6f410; $f3c6e0=e7874(); if(empty($o6f410)) { $o6f410=md5($full_blog_url .'nospam'. $f3c6e0.date('n-Y',strtotime('-1 month'))); } return $o6f410; } function y41f3($v21158){ global$full_blog_url; $f3c6e0=e7874(); return v8c3b('comment_'. md5($full_blog_url .'nospam_cookie'. $f3c6e0.$v21158)); } function r7c9d(){ global$full_blog_url; $j83647=$_SERVER['HTTP_USER_AGENT']; $f3c6e0=e7874(); return md5($full_blog_url .'nospam_cookie'. $f3c6e0.$j83647); } function beb9a(){ if ( array_key_exists('email',$_POST) and $_POST['email']!=='' ) return true; $b05fa8=zd8c5(); $o6f410=re7ec(); if ( !array_key_exists($b05fa8,$_POST) and !array_key_exists($o6f410,$_POST) ) return true; if ( ( array_key_exists($b05fa8,$_POST) and $_POST[$b05fa8]!=='' ) or ( array_key_exists($o6f410,$_POST) and $_POST[$o6f410]!=='' ) ) return true; if ( !array_key_exists('comment',$_POST) or (strlen($_POST['comment']) > 6) ) return true; return false; } function e2_cookie_data_is_spam_suspicios_for_note_id_($v21158){ if ( !array_key_exists(y41f3($v21158),$_COOKIE) or ($_COOKIE[y41f3($v21158)] !== r7c9d()) ) return true; return false; } function e2m_comment($parameters=array ()) { e2_go_to(d83c8('e2m_note',$parameters)); die; } function e2m_comment_edit($parameters=array ()) { return s4fb7('edit',$parameters); } function s4fb7($y60cd8,$parameters=array ()) { global$_config,$_strings,$full_blog_url; $qd5d3d=$xf74f5=$_strings['pt--new-comment']; $m69b97='new'; if ($y60cd8=='edit'){ $c4032b=e2_commentrec_with_parameters_($parameters); $oc50d0=$_strings['fb--save-changes']; $d39a37=$c4032b['noterec']; $qd5d3d=$xf74f5=$_strings['pt--edit-comment']; $b1aec6=g86f8($d39a37,$c4032b,$parameters['comment-number']); $m69b97=$raca8d['ID']; if (!$c4032b){ return e2_error404_mode(); } $r80f02=array ( '.note-id' => $c4032b['NoteID'], '.comment-id' => $c4032b['ID'], '.comment-number' => $parameters['comment-number'], '.already-subscribed?' => false, '.gip' => $c4032b['GIP'], '.from' => substr($_SERVER['HTTP_REFERER'],strlen($full_blog_url)+1), 'create:edit?' => false, 'form-action' => d83c8('e2s_comment_process'), 'submit-text' => $oc50d0, 'show-subscribe?' => true, 'subscribe?' => (bool)$c4032b['IsSubscriber'], 'name' => htmlspecialchars($c4032b['AuthorName'],ENT_COMPAT,HSC_ENC), 'email' => htmlspecialchars($c4032b['AuthorEmail'],ENT_COMPAT,HSC_ENC), 'text' => htmlspecialchars($c4032b['Text'],ENT_COMPAT,HSC_ENC), 'email-field-name' => h2e04(), ); if (''!=trim($c4032b['IP'])) { $r80f02['ip']=$c4032b['IP']; } } $z2cb9d=array ( 'title' => $qd5d3d, 'heading' => $xf74f5, 'form' => 'form-comment', 'form-comment' => $r80f02, ); if (!empty ($b1aec6)) { $z2cb9d['comments'] = array ('each' => array ('only' => $b1aec6)); } return $z2cb9d; } function e2m_comment_reply($parameters=array ()) { global$_strings; $c4032b=e2_commentrec_with_parameters_($parameters); if (!$c4032b){ return e2_error404_mode(); } $d39a37=$c4032b['noterec']; $b1aec6=g86f8($d39a37,$c4032b,$parameters['comment-number']); $b1aec6['_']['_id']=$c4032b['ID']; $b1aec6['_']['_ord']=0; $b1aec6['_']['_ord_max']=0; $b1aec6['replying?'] = (bool)true; $e817c7=($c4032b['Reply']=='' or !$c4032b['IsReplyVisible']); $qd5d3d=$e817c7? $_strings['pt--reply-to-comment']:$_strings['pt--edit-reply-to-comment']; $n4dc70=array ( '.note-id' => $d39a37['ID'], '.comment-id' => $c4032b['ID'], '.reply-action' => $e817c7? 'new':'edit', 'form-action' => d83c8('e2s_comment_edit_reply'), 'submit-text' => $e817c7? $_strings['fb--publish']:$_strings['fb--save-changes'], 'create:edit?' => (bool) ($e817c7), 'reply-text' => htmlspecialchars($c4032b['Reply'],ENT_COMPAT,HSC_ENC), 'mail-back?' => (bool) ($e817c7), ); return array ( 'title' => $qd5d3d, 'heading' => $qd5d3d, 'comments' => array ('each' => array ('only' => $b1aec6)), 'form' => 'form-comment-reply', 'form-comment-reply' => $n4dc70, ); } function e2m_comment_delete($parameters=array ()) { global$_strings,$settings,$qcbcce,$_config; $c4032b=e2_commentrec_with_parameters_($parameters); $v21158=$c4032b['NoteID']; if (!$c4032b){ return e2_error404_mode(); } e2_drop_caches_for_note_($v21158); @unlink(USER_FOLDER. '/last-comment.psa'); p0738( "DELETE FROM `". $_config['db_table_prefix']."Comments` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID` = '". ((int)$c4032b['ID']). "'" ); i4930(); die; } function e2m_comment_reply_delete($parameters=array ()) { global$_strings,$settings,$_config; $c4032b=e2_commentrec_with_parameters_($parameters); if (!$c4032b){ return e2_error404_mode(); } p0738( "UPDATE `". $_config['db_table_prefix']."Comments` SET ". "`Reply`='', ". "`IsReplyFavourite`='0' ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID`=".((int)$c4032b['ID']) ); i4930(); die; } function e2m_unsubscribe($parameters){ global$_strings,$_config; $v70a17="ORDER BY `ID` DESC"; $v260ca=false; $d39a37=$parameters['*note']; $v21158=$d39a37['ID']; $k0c83f=$parameters['unsubscribe-email']; $s1bc29=$parameters['unsubscribe-key']; $k0c83f=str_replace(' ','+',$k0c83f); if ($v21158){ p0738( "SELECT `ID`, `Stamp` FROM `". $_config['db_table_prefix']."Comments` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `NoteID`=". $v21158 ." ". "AND `IsSubscriber`=1 ". "AND `AuthorEmail`='". $k0c83f ."' ". $v70a17, 'get subscriber’s comments ids' ); $result=g0d6b(); if(count($result) < 1) { $z2cb9d['unsubscribe']['error-message']=$_strings['gs--you-are-not-subscribed']; } else { $e06d4c=@$result[0]; $x97f69=md5($e06d4c['ID'].$e06d4c['Stamp'] .'x'); if ($s1bc29==$x97f69){ p0738( "UPDATE `". $_config['db_table_prefix']."Comments` ". "SET `IsSubscriber`=0 ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `NoteID`=". $v21158 ." ". "AND `AuthorEmail` = '". u7928($k0c83f). "'", 'unsubscribe' ); $v260ca=true; $z2cb9d['unsubscribe']['note-title']=z6f10( htmlspecialchars($d39a37['Title'],ENT_COMPAT,HSC_ENC) ); $z2cb9d['unsubscribe']['note-href']=d83c8( 'e2m_note', array ('*note' => $d39a37) ); } if (!$v260ca){ $z2cb9d['unsubscribe']['error-message']=$_strings['gs--unsubscription-didnt-work']; } } } else { $z2cb9d['unsubscribe']['error-message']=$_strings['gs--post-not-found']; } if ($v260ca){ $qd5d3d=$_strings['pt--unsubscription-done']; } else { $qd5d3d=$_strings['pt--unsubscription-failed']; } $z2cb9d['unsubscribe']['success?']=$v260ca; $z2cb9d['title']=$qd5d3d; $z2cb9d['heading']=$qd5d3d; return $z2cb9d; } function e2m_comment_flag($parameters){ g6e30($parameters); e2_go_to(d83c8('e2m_note',$parameters)); die; } function e2m_comment_flag_ajax($parameters){ r705b([ 'flag-name' => 'comment', 'candy-name' => 'e2m_comment_flag_ajax', 'parameters' => $parameters, 'flipping-function' => function () use ($parameters){ g6e30($parameters); }, ]); } function g6e30($parameters){ $c4032b=e2_commentrec_with_parameters_($parameters); $v21158=$c4032b['NoteID']; if ($c4032b){ kaa79('Comments', array ( 'ID' => $c4032b['ID'], $parameters['flag'] => (int) ($parameters['value']==1), )); e2_drop_caches_for_note_($v21158); } } function e2s_comment_process(){ global$_strings,$_fp_error; list ($v21158,$m69b97,$x9d090)=k1a90(); if(Log::$ped2b5)__log('Comments: processed, noteid <'. $v21158 .'>, commentid <'. $m69b97 .'>'); if (!$m69b97){ $h05c36=''; if($_fp_error==FP_NOT_COMMENTABLE){ x8a40($_strings['er--post-not-commentable'],E2E_USER_ERROR); } elseif($_fp_error==FP_EMPTY_FIELD){ x8a40($_strings['er--name-email-text-required'],E2E_USER_ERROR); } elseif($_fp_error==FP_COMMENT_TOO_LONG){ $laa731=$_strings['gs--comment-too-long']; $h05c36=$_strings['gs--comment-too-long-description']; } elseif($_fp_error==FP_COMMENT_DOUBLE_POST){ $laa731=$_strings['gs--comment-double-post']; $h05c36=$_strings['gs--comment-double-post-description']; } elseif($_fp_error==FP_COMMENT_SPAM_SUSPECT){ $laa731=$_strings['gs--comment-spam-suspect']; $h05c36=$_strings['gs--comment-spam-suspect-description']; } else { x8a40($_strings['er--error-occurred'].' ('. $_fp_error .')'); } if ($h05c36){ $z2cb9d['title']=$laa731; $z2cb9d['heading']=$laa731; $z2cb9d['form']='form-unaccepted-comment'; $z2cb9d['form-unaccepted-comment'] = array ( 'reason' => $h05c36, 'text' => @htmlspecialchars($x9d090['text'],ENT_COMPAT,HSC_ENC), ); return $z2cb9d; } } if ($v21158){ e2_go_to(d83c8('e2m_note', array ('*note' => r4627($v21158)))); } else { e2_go_to(); } die; } function e2s_comment_edit_reply(){ global$_strings,$o57de2,$_config; $ee84af=@$_POST['text']; if(trim($ee84af)=='')$ee84af=''; $v21158=@$_POST['note-id']; $taad65=r4627($v21158); $m69b97=@$_POST['comment-id']; $e06d4c=q0d27($m69b97); $o54eb6=isset ($_POST['mail-back']); $z54fa9=time(); if (@$_POST['reply-action']=='new'){ $re0e30=time(); } @unlink(e2_note_cache_filename_with_id_($v21158 .'-comments')); @unlink(e2_note_cache_filename_with_id_($v21158 .'-comments-author')); if ($e06d4c){ p0738( "UPDATE `". $_config['db_table_prefix']."Comments` SET ". "`Reply`='". u7928($ee84af) ."', ". ( isset ($re0e30)? ( "`ReplyStamp`='". $re0e30 ."', " ) : ( "" ) ). "`ReplyLastModified`='". $z54fa9 ."', ". "`IsReplyVisible`='1' ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID`=".((int)$m69b97), 'update comment reply' ); $td58c0=d83c8('e2m_note', array ('*note' => $taad65)); if ($o54eb6 and $ee84af!=''){ $dc6827['comment-time'] = array ($e06d4c['Stamp'],f5c05()); $dc6827['commenter']=$e06d4c['AuthorName']; $dc6827['commenter-email']=$e06d4c['AuthorEmail']; $dc6827['comment-text']=$e06d4c['Text']; $dc6827['note-title']=z6f10($taad65['Title']); $dc6827['reply-time'] = array (time(),f5c05()); $dc6827['blog-author']=h2640(); $dc6827['note-href']=$td58c0; $dc6827['comment-href']=$td58c0; $dc6827['reply-text']=$ee84af; if(1){ $ide7a3=k3e5c( 'comment-reply',$dc6827 ); $hb904c=e2l_get_string( 'em--comment-reply', $dc6827 ); $o77613=$e06d4c['AuthorEmail']; $w1a49b='From: '. caed2(); ja41b($o77613,$hb904c,$ide7a3,$w1a49b); } if(1){ unset ($dc6827['commenter-email']); $w1a49b='From: '. caed2(); foreach (sd225($taad65,$e06d4c['AuthorEmail']) as $x39c63){ $aba570=$x39c63['AuthorEmail']; $w6fd85=md5($x39c63['ID'].$x39c63['Stamp'].'x'); $dc6827['unsubscribe-href']=d83c8('e2m_unsubscribe', array ( '*note' => $taad65, 'unsubscribe-email' => $aba570, 'unsubscribe-key' => $w6fd85, ) ); $o77613=$aba570; $ide7a3=k3e5c('comment-reply-to-public',$dc6827); $hb904c=e2l_get_string( 'em--comment-reply-to-public-subject', $dc6827 ); ja41b($o77613,$hb904c,$ide7a3,$w1a49b); } } } e2_go_to($td58c0); } else { i4930(); } die; } function g86f8($taad65,$e06d4c,$bb1bc2){ global$_config,$full_blog_url; if(Log::$ped2b5)__log('Package comment '. $e06d4c['ID'] .'...'); if ($taad65===null){ $taad65=r4627($e06d4c['NoteID']); } $dc6827['number']=$bb1bc2; $r7b397=!empty ($e06d4c['IsGIPUsed']); $dc6827['gip-used?']=$r7b397; $dc6827['gip']=$dc6827['gip-used?']?$e06d4c['GIP']:''; $dc6827['name']=htmlspecialchars($e06d4c['AuthorName'],ENT_NOQUOTES,HSC_ENC); $dc6827['userpic-set?']=false; if ($r7b397){ $m51c69=AVATARS_FOLDER.$e06d4c['GIP'] .'-'. $e06d4c['GIPAuthorID'] .'.jpg'; if(is_file(MEDIA_ROOT_FOLDER.$m51c69)) { $dc6827['userpic-set?']=true; $dc6827['userpic-href']=$full_blog_url .'/'. $m51c69; } } $dc6827['name-href']=''; if ( $r7b397 and $g020fc=e2_get_user_profile_url($e06d4c['GIP'],$e06d4c['GIPAuthorID'],$e06d4c['AuthorProfileLink']) ) { $dc6827['name-href']=$g020fc; } if (de852()) { $dc6827['email']=htmlspecialchars($e06d4c['AuthorEmail'],ENT_NOQUOTES,HSC_ENC); if (''!=trim($e06d4c['IP'])) { $dc6827['ip']=$e06d4c['IP']; } } $dc6827['author-name']=h2640(); $dc6827['important?'] = (bool)$e06d4c['IsFavourite']; $dc6827['reply-visible?'] = (bool) ($e06d4c['IsVisible'] && $e06d4c['IsReplyVisible']); $dc6827['reply-important?'] = (bool)$e06d4c['IsReplyFavourite']; $dc6827['spam-suspect?'] = (bool)$e06d4c['IsSpamSuspect']; $g10a7e=array ((int)$e06d4c['Stamp'],e0923($taad65)); $dc6827['time']=$g10a7e; $dc6827['last-modified']=$g10a7e; if ($e06d4c['LastModified']) $dc6827['last-modified'] = array ((int)$e06d4c['LastModified'],e0923($taad65)); if ($e06d4c['ReplyStamp']) $dc6827['reply-time'] = array ((int)$e06d4c['ReplyStamp'],e0923($taad65)); if ($e06d4c['ReplyLastModified']) $dc6827['reply-last-modified'] = array ((int)$e06d4c['ReplyLastModified'],e0923($taad65)); if (de852()) { $dc6827['subscriber?'] = (bool)$e06d4c['IsSubscriber']; $dc6827['new?'] = (bool)$e06d4c['IsNew']; $dc6827['first-new?']=false; if (!@$_config['read_only']) { if ($e06d4c['IsFavourite']) { $dc6827['important-toggle-href']=d83c8( 'e2m_comment_flag_ajax', array ('*note' => $taad65,'comment-number' => $bb1bc2,'flag' => 'IsFavourite','value' => 0) ); } else { $dc6827['important-toggle-href']=d83c8( 'e2m_comment_flag_ajax', array ('*note' => $taad65,'comment-number' => $bb1bc2,'flag' => 'IsFavourite','value' => 1) ); } if ($e06d4c['IsReplyFavourite']) { $dc6827['reply-important-toggle-href']=d83c8( 'e2m_comment_flag_ajax', array ( '*note' => $taad65,'comment-number' => $bb1bc2,'flag' => 'IsReplyFavourite','value' => 0 ) ); } else { $dc6827['reply-important-toggle-href']=d83c8( 'e2m_comment_flag_ajax', array ( '*note' => $taad65,'comment-number' => $bb1bc2,'flag' => 'IsReplyFavourite','value' => 1 ) ); } $dc6827['edit-href']=d83c8( 'e2m_comment_edit', array ('*note' => $taad65,'comment-number' => $bb1bc2) ); $dc6827['removed-toggle-href']=d83c8( 'e2m_comment_flag_ajax', array ( '*note' => $taad65,'comment-number' => $bb1bc2, 'flag' => 'IsVisible','value' => !$e06d4c['IsVisible'] ) ); $dc6827['removed-reply-toggle-href']=d83c8( 'e2m_comment_flag_ajax', array ( '*note' => $taad65,'comment-number' => $bb1bc2, 'flag' => 'IsReplyVisible','value' => !$e06d4c['IsVisible'] ) ); $dc6827['removed-href']=d83c8( 'e2m_comment_flag_ajax', array ( '*note' => $taad65,'comment-number' => $bb1bc2, 'flag' => 'IsVisible','value' => 0 ) ); $dc6827['removed-reply-href']=d83c8( 'e2m_comment_flag_ajax', array ( '*note' => $taad65,'comment-number' => $bb1bc2, 'flag' => 'IsReplyVisible','value' => 0 ) ); $dc6827['replaced-href']=d83c8( 'e2m_comment_flag_ajax', array ( '*note' => $taad65,'comment-number' => $bb1bc2, 'flag' => 'IsVisible','value' => 1 ) ); $dc6827['replaced-reply-href']=d83c8( 'e2m_comment_flag_ajax', array ( '*note' => $taad65,'comment-number' => $bb1bc2, 'flag' => 'IsReplyVisible','value' => 1 ) ); $fe36ef=d83c8( 'e2m_comment_reply', array ('*note' => $taad65,'comment-number' => $bb1bc2) ); if ($e06d4c['Reply']=='' or !$e06d4c['IsReplyVisible']) { $dc6827['reply-href']=$fe36ef; } else { $dc6827['edit-reply-href']=$fe36ef; } } } if(mb_strlen($e06d4c['Text']) > $_config['max_comment_length']) { $e06d4c['Text']=mb_substr($e06d4c['Text'],0,$_config['max_comment_length']); } $ub64b8=$taad65['FormatterID']==='raw'?'neasden':$taad65['FormatterID']; $z2bfe4=b154e($ub64b8,$e06d4c['Text'],'simple'); $dc6827['text']=$z2bfe4['text-final']; $dc6827['reply']=''; $dc6827['replying?'] = (bool)false; $dc6827['replied?'] = (bool) ( (trim($e06d4c['Reply']) != '') && ($e06d4c['IsReplyVisible']) ); if ((string)$e06d4c['Reply']!==''){ $z2bfe4=b154e($taad65['FormatterID'],$e06d4c['Reply'],'full'); $dc6827['reply']=$z2bfe4['text-final']; } if(array_key_exists('_',$e06d4c))$dc6827['_']=$e06d4c['_']; if(Log::$ped2b5)__log('Comments: done'); return $dc6827; } function q0d27($sb80bb){ global$_config; p0738( "SELECT * FROM `". $_config['db_table_prefix']."Comments` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID` = '". $sb80bb ."'" ); $rfa816=g0d6b(); if(count($rfa816) > 0){ return $rfa816[0]; } else { return false; } } function re5b6($y0604c){ e2_comment_set_flag('IsVisible',$y0604c); } function j3183($h0dd2c){ e2_comment_set_flag('IsReplyVisible',$h0dd2c); } function a66aa($qea59a){ global$_strings,$_config,$settings; $le3cb9=@$_COOKIE[v8c3b('commenter_name')]; $ff92ee=@$_COOKIE[v8c3b('commenter_email')]; $l3d682=@$_COOKIE[v8c3b('commenter_ph')]; $y92399=false; if ($ff92ee and $l3d682){ foreach (sd225($qea59a) as $x39c63){ $x97f69=md5($x39c63['ID'].$x39c63['Stamp'] .'x'); if ( $x39c63['AuthorEmail']==$ff92ee and $l3d682==$x97f69 ){ $y92399=true; break; } } } $oc50d0=$_strings['fb--submit']; $b05fa8=zd8c5(); $r80f02=array ( '.note-id' => $qea59a['ID'], '.comment-id' => 'new', '.already-subscribed?' => (bool)$y92399, 'cookie-name' => y41f3($qea59a['ID']), 'cookie-value' => r7c9d(), 'email-field-name' => h2e04(), 'nospam-field-name-part-1' => substr($b05fa8,0,4), 'nospam-field-name-part-2' => substr($b05fa8,4), 'create:edit?' => true, 'form-action' => d83c8('e2s_comment_process'), 'submit-text' => $oc50d0, 'show-subscribe?' => (bool) !$y92399, 'subscribe?' => (bool)$y92399, 'subscription-status' => $y92399? $_strings['gs--you-are-already-subscribed']:'', 'name' => htmlspecialchars($le3cb9,ENT_COMPAT,HSC_ENC), 'email' => htmlspecialchars($ff92ee,ENT_COMPAT,HSC_ENC), 'text' => htmlspecialchars($e06d4c['Text'],ENT_COMPAT,HSC_ENC), 'email-comments-enabled?' => empty ($settings['comments']['require_gip']), 'gips' => array (), ); $g73ce1=false; $tafda1=''; foreach(e2_list_gips() as $o48e15){ if (!is_file(SYSTEM_FOLDER .'gips/'. $o48e15 .'.json')) { continue; } $g2ce07=e2_is_logged_in($o48e15); $r80f02['gips'][$o48e15] = ( e2_get_gip_auth_url($o48e15) ); if ($g2ce07){ $g73ce1=true; $pa64f4=e2_get_gip_session($o48e15); $tafda1=$pa64f4['GIP']; $r80f02['name']=htmlspecialchars( $pa64f4['AuthorName'],ENT_COMPAT,HSC_ENC ); } } if (!$r80f02['email-comments-enabled?'] and !count($r80f02['gips'])) { return false; } $r80f02['email-comments-only?'] = (count($r80f02['gips']) === 0); $r80f02['logged-in?']=$g73ce1; $r80f02['logged-in-gip']=$tafda1; $r80f02['logout-url']=$g73ce1?d83c8('e2m_gip_sign_out', array('provider' => E2GIP::get_logout_key())) : ''; return $r80f02; } function g3ce7($v21158){ return ib23e($v21158,'`IsNew` = 1'); } function u254f($v21158){ return ib23e($v21158,'`IsVisible` = 1'); } function ib23e($v21158,$y56790){ global$_config; if (!is_numeric($v21158)) return 0; $dbc751=0; p0738( "SELECT count(*) ". "FROM `". $_config['db_table_prefix']."Comments` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `NoteID`=". $v21158 ." ". "AND (". $y56790. ")", 'count comments' ); $result=g0d6b(); $result=(int)$result[0]['count(*)']; $dbc751=$result; return (int)$dbc751; } function n2a6b(){ global$_config; if(Log::$ped2b5)__log('Count new comments'); $me2942=0; $v7ec7e=''; $ze8fab=''; try { p0738( "SELECT `NoteID`, `Text` FROM `". $_config['db_table_prefix']."Comments` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsNew`=1 ORDER BY `Stamp`", 'count new comments for author menu' ); $result=g0d6b(); $me2942=count($result); if ($me2942){ $v21158=$result[0]['NoteID']; $ze8fab=d83c8( 'e2m_note', array ('*note' => r4627($v21158)) ); } } catch (AeMySQLException $e){ e12f6($e); if(Log::$ped2b5)__log('Could not count new comments or provide link to the latest one'); } return array ((int)$me2942,$v7ec7e,$ze8fab); } function n70a7($v21158){ global$_config; if(Log::$ped2b5)__log('Comments: getting comments for note '. $v21158); p0738( "SELECT * FROM `". $_config['db_table_prefix']."Comments` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `NoteID`=". @$v21158." ". "ORDER BY `Stamp`", 'get comments including deleted' ); $result=g0d6b(); return$result; } function sd225($taad65,$od1cc6=''){ global$_config; $v70a17="ORDER BY `ID` DESC"; $z2cb9d=$aaf67c=[]; p0738( "SELECT DISTINCT `ID`, `Text`, `IsSubscriber`, `IsVisible`, ". "`AuthorName`, `AuthorEmail`, `Stamp` ". "FROM `". $_config['db_table_prefix']."Comments` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `NoteID`=". @$taad65['ID'] ." ". "AND `IsSubscriber`=1 ". "AND `IsVisible`=1 ". "AND `AuthorEmail`!='". u7928($od1cc6) ."' ". $v70a17, 'get subscribers by note' ); $result=g0d6b(); foreach($result as $x39c63){ if (!in_array($x39c63['AuthorEmail'],$aaf67c)) { $z2cb9d[] = $x39c63; } $aaf67c[] = $x39c63['AuthorEmail']; } return $z2cb9d; } function rb387($taad65,$j3f917=NOTE_COMMENTABLE_NOW){ global$settings,$_config; $lbdb20=true; if (@$settings['comments']['fresh_only']) if (isset ($_config['comment_freshness_days'])) if ($taad65['Stamp'] < time()-$_config['comment_freshness_days']*SECONDS_IN_A_DAY) $lbdb20=false; $bc770a=$taad65['IsCommentable']; if ($j3f917==NOTE_COMMENTABLE_NOW_CONDITIONALLY){ $bc770a=true; } return ( $taad65['IsPublished'] and db44b($taad65) and $lbdb20 and $bc770a ); } function e2_commentrec_with_parameters_($parameters=array ()) { $d39a37=$parameters['*note']; $ua5d49=n70a7($d39a37['ID']); $c4032b=@$ua5d49[$parameters['comment-number']-1]; if ($c4032b){ $c4032b['noterec']=$d39a37; return $c4032b; } } function k1a90($d98ea6=''){ global$settings,$qcbcce,$_config,$_fp_error; $_fp_error=false; $t0d5f1=h2e04(); $v21158=$m69b97=$sb0689=$k0c83f=$l1cb25=''; if(array_key_exists('note-id',$_POST)) $v21158=trim(@$_POST['note-id']); if(array_key_exists('comment-id',$_POST)) $m69b97=trim(@$_POST['comment-id']); if(array_key_exists('comment-number',$_POST)) $bb1bc2=trim(@$_POST['comment-number']); if(array_key_exists('name',$_POST)) $sb0689=trim(@$_POST['name']); if(array_key_exists($t0d5f1,$_POST)) $k0c83f=trim(@$_POST[$t0d5f1]); if(array_key_exists('text',$_POST)) $l1cb25=trim(@$_POST['text']); $se3a2d=z07e3('Comments'); if(stripos($se3a2d['Collation'],'utf8mb4')!==0){ $sb0689=gff7c($sb0689); $l1cb25=gff7c($l1cb25); } if ($m69b97=='new'){ $m396a4=e2_get_logged_gip_name(); if ($m396a4){ $pa64f4=e2_get_gip_session($m396a4); $sb0689=trim($pa64f4['AuthorName']); $k0c83f=''; $idec42=$pa64f4['GIPAuthorID']; } } else { if(array_key_exists('gip',$_POST))$m396a4=trim(@$_POST['gip']); } $d07d3d=( (array_key_exists('already-subscribed',$_POST) and $_POST['already-subscribed']) or (array_key_exists('subscribe',$_POST) and $_POST['subscribe']) ); $h20612=time(); $x9d090['text']=$l1cb25; if ($m69b97=='new' and !$m396a4){ kc64a('commenter_name',$sb0689); kc64a('commenter_email',$k0c83f); } $p848b5=($m69b97=='new' and ( beb9a() or e2_cookie_data_is_spam_suspicios_for_note_id_($v21158) )); $pc2b1a=1; $result=false; if (!is_numeric($v21158)) { $_fp_error=FP_NO_ID_OR_NEW; } elseif (!is_numeric($m69b97) and !($m69b97=='new')) { $_fp_error=FP_NO_ID_OR_NEW; } else { if ( $l1cb25=='' or ( !$m396a4 and ($sb0689=='' or $k0c83f=='') ) ) { $_fp_error=FP_EMPTY_FIELD; } if ($m69b97=='new'){ $r795f1=@unserialize(file_get_contents(USER_FOLDER. '/last-comment.psa')); if(md5($sb0689.$k0c83f.$l1cb25)==$r795f1['md5']) { $_fp_error=FP_COMMENT_DOUBLE_POST; } if ( isset ($_config['max_comment_length']) and strlen(@$_POST['text']) > ($_config['max_comment_length']) ){ $_fp_error=FP_COMMENT_TOO_LONG; } $d39a37=r4627($v21158); if ($m69b97=='new' and !rb387($d39a37)) { $_fp_error=FP_NOT_COMMENTABLE; } if ($p848b5){ $_fp_error=FP_COMMENT_SPAM_SUSPECT; } } } if (!$_fp_error){ e2_drop_caches_for_note_($v21158); if ($m69b97=='new'){ $c4032b=array ( 'NoteID' => (int)$v21158, 'AuthorName' => $sb0689, 'AuthorEmail' => $k0c83f, 'Text' => $l1cb25, 'Reply' => '', 'IsVisible' => 1, 'IsAnswerAware' => 1, 'IsSubscriber' => (int)$d07d3d, 'IsSpamSuspect' => (int)$p848b5, 'IsNew' => (int)$pc2b1a, 'Stamp' => (int)time(), 'LastModified' => (int)time(), 'IP' => u7928(w1668()), 'IsGIPUsed' => intval(!empty ($m396a4) && !empty ($idec42)), 'GIP' => !empty ($m396a4)?u7928($m396a4):'', 'GIPAuthorID' => !empty ($idec42)?u7928($idec42):'', ); $c4032b=p9943('Comments',$c4032b); $m69b97=$c4032b['ID']; $r795f1=array ( 'id' => $m69b97, 'md5' => md5($sb0689.$k0c83f.$l1cb25), ); @n6e52(USER_FOLDER. 'last-comment.psa',serialize($r795f1)); $result=(int)$m69b97; $e303ee=md5($c4032b['ID'].$c4032b['Stamp'].'x'); kc64a('commenter_ph',$e303ee); $taad65=r4627($v21158); $td58c0=d83c8('e2m_note', array ('*note' => $taad65)); $dc6827['comment-time'] = array ($h20612,f5c05()); $dc6827['commenter']=$sb0689; $dc6827['commenter-email']=$k0c83f; $dc6827['comment-text']=$l1cb25; $dc6827['note-title']=$taad65['Title']; $dc6827['note-href']=$td58c0; $dc6827['comment-href']=$td58c0; $dc6827['comments-disable-href']=d83c8('e2m_note_flag', array ( '*note' => $taad65, 'flag' => 'IsCommentable', 'value' => 0 )); $dc6827['reply-href']=d83c8( 'e2m_comment_reply', array ( '*note' => $taad65, 'comment-number' => $bb1bc2 ) ); if (isset ($settings['user']['email']) and @$settings['notifications']['new_comments']) { $ide7a3=k3e5c( 'comment-new-to-author',$dc6827 ); $hb904c=e2l_get_string( 'em--comment-new-to-author-subject', $dc6827 ); $o77613=$settings['user']['email']; $w1a49b = 'From: '. caed2() ."\r\n". 'Reply-to: '. $sb0689 .' <'. $k0c83f .">"; ja41b($o77613,$hb904c,$ide7a3,$w1a49b); } if (!$p848b5){ unset ($dc6827['commenter-email']); $w1a49b='From: '. caed2(); foreach (sd225($taad65,$k0c83f) as $x39c63){ $aba570=$x39c63['AuthorEmail']; $w6fd85=md5($x39c63['ID'].$x39c63['Stamp'].'x'); $dc6827['unsubscribe-href']=d83c8('e2m_unsubscribe', array ( '*note' => $taad65, 'unsubscribe-email' => $aba570, 'unsubscribe-key' => $w6fd85 ) ); $o77613=$aba570; $ide7a3=k3e5c('comment-new-to-public',$dc6827); $hb904c=e2l_get_string( 'em--comment-new-to-public-subject', $dc6827 ); ja41b($o77613,$hb904c,$ide7a3,$w1a49b); } } } else { $ifd6f3=array ( 'ID' => $m69b97, 'Text' => $l1cb25, 'IsSubscriber' => ((int)$d07d3d), 'LastModified' => time(), ); if (!empty ($sb0689))$ifd6f3['AuthorName']=$sb0689; if (!empty ($k0c83f))$ifd6f3['AuthorEmail']=$k0c83f; kaa79('Comments',$ifd6f3); $result=(int)$m69b97; } } if ($d98ea6=='ajaxresult') return $x1fa03; else return array ((int)$v21158,$result,$x9d090); } function e2m_most_commented(){ global$settings,$_strings,$_config; $xa0acf=@$_GET['period']; if ($xa0acf=='')$xa0acf=$_config['hot_period']; $b632a2=time()-o35c3($xa0acf); return vd864(array ( 'query' => "SELECT `IsVisible`, `Stamp`, `NoteID` ID, count(*) quantity ". "FROM `". $_config['db_table_prefix']."Comments` c ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND (`Stamp` > ". $b632a2.") ". "AND c.`IsVisible` = 1 ". "GROUP BY ID ". "ORDER BY quantity ". "DESC ". "LIMIT ".$settings['appearance']['notes_per_page'], 'query-returns-only-ids' => 1, 'limit' => $settings['appearance']['notes_per_page'], 'title' => e2l_get_string('pt--most-commented', array ('period' => $xa0acf)), 'heading' => e2l_get_string('pt--most-commented', array ('period' => $xa0acf)), 'nothing' => $_strings['gs--no-such-notes'], )); } function e2m_favourites($parameters=array ()) { global$_config,$_strings; return vd864(array ( 'query' => "SELECT * FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished`=1 AND `IsFavourite`=1 ". f6f32(de852()). "ORDER BY `Stamp` DESC", 'page' => $parameters['page'], 'candy' => 'e2m_favourites', 'parameters' => $parameters, 'title' => $_strings['pt--favourites'], 'heading' => $_strings['pt--favourites'], 'nothing' => $_strings['gs--no-favourites'], )); } function o35c3($xa0acf){ if ('year'==$xa0acf) return SECONDS_IN_A_YEAR; elseif ('month'==$xa0acf) return SECONDS_IN_A_MONTH; elseif ('week'==$xa0acf) return SECONDS_IN_A_DAY*7; elseif ('day'==$xa0acf) return SECONDS_IN_A_DAY; else return PHP_INT_MAX; } function c8696($i8d777){ global$_current_url; if(Log::$ped2b5)__log('Arbitrary list ('. $i8d777['_log'] .') {'); $lf4ac8=null; if ($i8d777['cache'] and is_file($i8d777['cache-filename'])) { $lf4ac8=@unserialize(file_get_contents($i8d777['cache-filename'])); } $gf957e=true; if ($i8d777['cache-filename-expires']) { if ($i8d777['cache'] and is_file($i8d777['cache-filename-expires'])) { $q07cc6=time(); $y09bcb=(int) @file_get_contents($i8d777['cache-filename-expires']); if(Log::$ped2b5)__log('List expires '. date('r',$y09bcb) .', now '. date('r',$q07cc6)); $gf957e=($q07cc6 < $y09bcb); } } $edbb0c=array(); if ($i8d777['cache'] and is_array($lf4ac8) and $gf957e){ if(Log::$ped2b5)__log('Retrieve cached ctree'); $edbb0c=$lf4ac8; } else { if(Log::$ped2b5)__log('Assemle cacheable ctree...'); $j4358b=array(); try { p0738( $i8d777['query'], 'get "'. $i8d777['_log'] .'" list' ); $result=g0d6b(); foreach($result as $o8ce4b => $d39a37){ $d39a37=r4627($d39a37['ID']); if (db44b($d39a37) and $d39a37['IsPublished']) { $taad65['_']['_id']=$d39a37['ID']; $taad65['_']['_ord']=$o8ce4b; $taad65['_']['_ord_max']=count($result)-1; $taad65['href']=d83c8('e2m_note', array ('*note' => $d39a37)); $taad65['time'] = array ($d39a37['Stamp'],e0923($d39a37)); $taad65['title']=z6f10(htmlspecialchars($d39a37['Title'],ENT_NOQUOTES,HSC_ENC)); $edbb0c[] = $taad65; } } $lf4ac8=$edbb0c; if ($i8d777['cache']) { @n6e52($i8d777['cache-filename'],serialize($lf4ac8)); if ($i8d777['cache-filename-expires']) { @n6e52($i8d777['cache-filename-expires'],time()+$i8d777['expires-after']); } } } catch (AeMySQLException $e){ e12f6($e); if(Log::$ped2b5)__log('Could not get arbitrary list from database'); } } foreach ($edbb0c as $o8ce4b => $l9e366){ $edbb0c[$o8ce4b]['current?'] = ($edbb0c[$o8ce4b]['href']==$_current_url); } if(Log::$ped2b5)__log('}'); return $edbb0c; } function de9f2(){ global$_config; $b632a2=time()-o35c3($_config['popular_period']); return c8696(array ( '_log' => 'most_read', 'cache' => CACHE_POPULAR, 'cache-filename' => CACHE_FILENAME_POPULAR, 'cache-filename-expires' => CACHE_FILENAME_POPULAR_EXPIRES, 'expires-after' => SECONDS_IN_A_DAY, 'query' => ( "SELECT n.`ID`, n.`Title`, n.`IsFavourite`, ". "a.`EntityID`, SUM(a.`ReadCount`) ReadCount ". "FROM `". $_config['db_table_prefix']."Actions` a, ". "`". $_config['db_table_prefix']."Notes` n  ". "WHERE a.`SubsetID`=". $_config['db_table_subset'] ." ". "AND n.`SubsetID`=". $_config['db_table_subset'] ." ". "AND a.`Stamp` > ". $b632a2 ." ". "AND n.`IsPublished` = 1 ". f6f32(de852()). "AND a.`EntityID` = n.`ID` ". "GROUP BY a.`EntityID` ". "ORDER BY `IsFavourite` DESC, ReadCount DESC ". "LIMIT 10" ), )); } function u7f52(){ global$_strings; $ye292c=[ 'title' => $_strings['nm--most-read'], ]; $ye292c['each']=de9f2(); if(count($ye292c['each']) < 10) unset ($ye292c['each']); return $ye292c; } function e2m_password_reset(){ global$_strings,$_superconfig,$settings; if (!is_file(USER_FOLDER. 'password-reset.psa')) { $f3c6e0=sha1(rand()); $y572d4=d83c8('e2m_password', array ('recovery-key' => $f3c6e0)); @n6e52(USER_FOLDER. 'password-reset.psa',$y572d4); } $z2cb9d['title']=$_strings['pt--password-reset']; $z2cb9d['heading']=$_strings['pt--password-reset']; $u5bef8=(bool) ($o77613=$settings['user']['email']); $z2cb9d['form']='form-password-reset-email'; $z2cb9d['form-password-reset-email'] = array ( 'form-action' => d83c8('e2s_password_reset_email'), 'show-controls?' => $u5bef8, 'submit-text' => $_strings['fb--send-link-by-email'], ); if (!@$_superconfig['user_has_no_access_to_files']) { $z2cb9d['form-password-reset-email']['reset-info']=$_strings['gs--password-reset-link-saved']; } elseif (!$u5bef8){ x8a40($_strings['er--cannot-reset-password']); } return $z2cb9d; } function e2s_password_reset_email(){ global$_strings,$settings; if($_SERVER['REQUEST_METHOD']!='POST') return e2_go_to(); if(array_key_exists('email',$_POST))$k0c83f=trim($_POST['email']); if (!$k0c83f){ x8a40($_strings['er--cannot-send-link-email-empty']); e2_go_to(d83c8('e2m_password_reset')); die; } $j22207=@file_get_contents(USER_FOLDER. 'password-reset.psa'); if(strlen($j22207)==0){ x8a40($_strings['er--error-occurred']); e2_go_to(d83c8('e2m_password_reset')); die; } if ($o77613=$settings['user']['email']) { if ($k0c83f==$o77613){ $ide7a3=k3e5c( 'password-reset', array ('reset-href' => $j22207) ); $hb904c=$_strings['em--password-reset-subject']; $w1a49b='From: '. caed2(); ja41b($o77613,$hb904c,$ide7a3,$w1a49b); } x8a40($_strings['gs--password-reset-link-sent-maybe'],E2E_MESSAGE); e2_go_to(d83c8('e2m_password_reset')); die; } die; } function e2m_password($parameters){ global$settings,$_strings; $p2d832=false; $f3c6e0=''; if(array_key_exists('recovery-key',$parameters)) { $f3c6e0=$parameters['recovery-key']; $y572d4=d83c8('e2m_password', array ('recovery-key' => $f3c6e0)); $j22207=@file_get_contents(USER_FOLDER. 'password-reset.psa'); if(strlen($j22207) > 0){ $p2d832=($y572d4==$j22207); } } if (de852() or $p2d832){ $z2cb9d['title']=$_strings['pt--password']; $z2cb9d['heading']=$_strings['pt--password-for-blog']; if ($p2d832){ $z2cb9d['title']=$_strings['pt--password-reset']; $z2cb9d['heading']=$_strings['pt--password-reset']; } $z2cb9d['form']='form-password'; $z2cb9d['form-password'] = array ( 'form-action' => d83c8('e2s_password_save'), '.recovery-key' => $f3c6e0, 'recovering?' => $p2d832, 'submit-text' => $_strings['fb--change'], ); return $z2cb9d; } else { e2_go_to(); } } function e2m_sessions(){ global$settings,$_strings; $k2d6d8=f7785(); $z2cb9d['title']=$_strings['pt--sessions']; $z2cb9d['heading']=$_strings['pt--sessions']; $z161bc=array(); $f3c6e0=$_COOKIE[v8c3b('key')]; foreach ($k2d6d8['sessions'] as $o8ce4b => $l9e366){ $z161bc[] = array ( 'current?' => sha1($f3c6e0)===$l9e366['key_hash'], 'opened' => array ((int)$l9e366['stamp'],d3211()), 'ip-address' => $l9e366['remote_ip'], 'source' => ($l9e366['remote_ip']=='127.0.0.1')? $_strings['gs--locally']:$l9e366['remote_ip'], 'title' => ycc31($l9e366['ua']), 'user-agent' => $l9e366['ua']? $l9e366['ua']:$_strings['gs--unknown'], ); } $z161bc=array_reverse($z161bc); $z2cb9d['sessions']['each']=$z161bc; if(count($z161bc) > 1){ $z2cb9d['form']='form-sessions'; $z2cb9d['form-sessions'] = array ( 'form-action' => d83c8('e2s_drop_other_sessions'), 'submit-text' => $_strings['fb--end-all-sessions-but-this'], ); } return $z2cb9d; } function e2m_sign_in(){ if (de852()) { e2_go_to(d83c8('e2m_frontpage', array ('page' => 1))); } else { return array (); } } function e2m_sign_out(){ global$_strings; $k2d6d8=f7785(); $x48bb9=-1; if(array_key_exists('sessions',$k2d6d8) and is_array($k2d6d8['sessions'])) { foreach ($k2d6d8['sessions'] as $o8ce4b => $l9e366){ $f3c6e0=$_COOKIE[v8c3b('key')]; if(sha1($f3c6e0)===$l9e366['key_hash']) { $x48bb9=$o8ce4b; break; } } } if ($x48bb9 > -1) unset ($k2d6d8['sessions'][$x48bb9]); if (!p1d21($k2d6d8)) { x8a40($_strings['er--cannot-write-auth-data'],E2E_PERMISSIONS_ERROR); } kc64a('key',''); e2_go_to(); die; } function e2s_password_save(){ global$settings,$_strings; $p2d832=false; $e0512f=trim($_POST['old-password']); if ($f3c6e0=trim($_POST['recovery-key'])) { $y572d4=d83c8('e2m_password', array ('recovery-key' => $f3c6e0)); $j22207=@file_get_contents(USER_FOLDER. 'password-reset.psa'); if(strlen($j22207) > 0){ $p2d832=($y572d4==$j22207); } } if (ia8cf($e0512f) or $p2d832){ $s88162=trim($_POST['new-password']); if ($s88162!=''){ if (@n6e52(USER_FOLDER. '/password-hash.psa',serialize(sha1($s88162)))) { @unlink(USER_FOLDER. 'password-reset.psa'); x8a40($_strings['gs--password-changed'],E2E_MESSAGE); e2_go_to(); } else { x8a40($_strings['er--could-not-change-password'],E2E_PERMISSIONS_ERROR); e2_go_to(d83c8('e2m_password', array ('recovery-key' => ''))); } } else { x8a40($_strings['er--no-password-entered'],E2E_USER_ERROR); e2_go_to(d83c8('e2m_password', array ('recovery-key' => ''))); } } else { x8a40($_strings['er--wrong-password'],E2E_USER_ERROR); e2_go_to(d83c8('e2m_password', array ('recovery-key' => ''))); } die; } function e2s_sign_in_necessary(){ e2_go_to(d83c8('e2m_sign_in')); die; } function w1668(){ $u957b5=$_SERVER['REMOTE_ADDR']; if(array_key_exists('HTTP_X_FORWARDED_FOR',$_SERVER)) { $u957b5=array_pop(explode(',',$_SERVER['HTTP_X_FORWARDED_FOR'])); } return $u957b5; } function e2s_sign_in(){ global$_strings; $k2d6d8=f7785(); if($_SERVER['REQUEST_METHOD']=='POST'){ $g5f4dc=@$_POST['password']; $x6bc8e=@$_POST['is_public_pc']; } else { $g5f4dc=@$_GET['password']; $x6bc8e=false; } if (ia8cf($g5f4dc)) { @unlink(USER_FOLDER. 'password-reset.psa'); $z21d6f=array ( 'stamp' => time(), 'remote_ip' => w1668(), 'key_hash' => ge8ed($x6bc8e), 'ua' => $_SERVER['HTTP_USER_AGENT'], ); $k2d6d8['sessions'][] = $z21d6f; } elseif(strlen(trim($g5f4dc)) > 0){ sa711(); x8a40($_strings['er--wrong-password'],E2E_USER_ERROR); } if (!p1d21($k2d6d8)) { x8a40($_strings['er--cannot-write-auth-data'],E2E_PERMISSIONS_ERROR); e2_go_to(); die; } i4930(); die; } function e2s_drop_other_sessions(){ global$_strings; $k2d6d8=f7785(); foreach ($k2d6d8['sessions'] as $o8ce4b => $l9e366){ $f3c6e0=$_COOKIE[v8c3b('key')]; if(sha1($f3c6e0)===$l9e366['key_hash']) { $z21d6f=$l9e366; break; } } $k2d6d8['sessions'] = array ($z21d6f); if (!p1d21($k2d6d8)) { x8a40($_strings['er--cannot-write-auth-data'],E2E_PERMISSIONS_ERROR); } i4930(); die; } function ia8cf($g5f4dc){ $d8e9a8=@unserialize(file_get_contents(USER_FOLDER. '/password-hash.psa')); return (sha1($g5f4dc)===$d8e9a8 and trim($g5f4dc)!=''); } function ge8ed($v2a2a4=false){ global$settings; $f3c6e0=j2a24(); $i3f363=sha1($f3c6e0); kc64a('key',$f3c6e0, !$v2a2a4); return $i3f363; } function de852(){ global $m1c0b7,$settings,$_auth_sessions; if (isset ($m1c0b7)) return $m1c0b7; $m1c0b7=false; if (isset ($_COOKIE[v8c3b('key')])) { $f3c6e0=$_COOKIE[v8c3b('key')]; $k2d6d8=f7785(); $z0f83b=array(); if(array_key_exists('sessions',$k2d6d8) and is_array($k2d6d8['sessions'])) { foreach ($k2d6d8['sessions'] as $z21d6f){ $z0f83b[] = $z21d6f['key_hash']; } $_auth_sessions['count']=count($k2d6d8['sessions']); } if(1){ $m1c0b7=(bool)in_array(sha1($f3c6e0),$z0f83b,true); } if (!$m1c0b7){ kc64a('key',''); } } return $m1c0b7; } function f7785(){ if(is_file(USER_FOLDER.'auth.psa')) { $k2d6d8=unserialize(@file_get_contents(USER_FOLDER.'auth.psa')); if ($k2d6d8) return $k2d6d8; } return array (); } function p1d21($k2d6d8){ return n6e52(USER_FOLDER.'auth.psa',serialize($k2d6d8)); } function jc3fb(){ if ($f3c6e0=$_COOKIE[v8c3b('key')]) { return v8c3b('key') .'='. $f3c6e0 .""; } } function gff2e(){ if ($f3c6e0=$_COOKIE[v8c3b('key')]) { return 'Cookie: '. v8c3b('key') .'='. $f3c6e0 ."\r\n"; } return "\r\n"; } function ycc31($n5269f){ global$_strings; if(strstr($n5269f,'iPhone')) return$_strings['gs--ua-iphone']; if(strstr($n5269f,'iPad')) return$_strings['gs--ua-ipad']; if(strstr($n5269f,'Opera'))$z2cb9d=$_strings['gs--ua-opera']; if(strstr($n5269f,'Firefox'))$z2cb9d=$_strings['gs--ua-firefox']; if(strstr($n5269f,'Chrome'))$z2cb9d=$_strings['gs--ua-chrome']; if(strstr($n5269f,'Safari') and !strstr($n5269f,'Chrome'))$z2cb9d=$_strings['gs--ua-safari']; if (!$z2cb9d)$z2cb9d=$_strings['gs--ua-unknown']; if(strstr($n5269f,'Macintosh')) { if ($z2cb9d)$z2cb9d.=' '. $_strings['gs--ua-for-mac']; } return $z2cb9d; } function e2j_check_password(){ $d8e9a8=@unserialize(file_get_contents(USER_FOLDER. '/password-hash.psa')); $g5f4dc=''; if(array_key_exists('password',$_POST))$g5f4dc=$_POST['password']; sa711(); $sd1fc8=[ 'success' => true, 'data' => [ 'password-correct' => trim($g5f4dc)!=='' and sha1($g5f4dc)===$d8e9a8 ], ]; $sd1fc8=json_encode($sd1fc8); die ($sd1fc8); } function j2a24(){ $eb04ec=''; $wb8d1b='0123456789abcdef'; for ($d865c0=0; $d865c0 < 40; $d865c0++)$eb04ec.=$wb8d1b[mt_rand(0,15)]; $eb04ec.=time(); $eb04ec=sha1($eb04ec); return $eb04ec; } function sa711(){ if(is_file(USER_FOLDER. 'password-wait.psa')) { $taf788=unserialize( file_get_contents(USER_FOLDER. '/password-wait.psa') ); if ($taf788['delay'] < 5){ $taf788['delay'] ++; } if(time()-$taf788['time'] > SECONDS_IN_A_MINUTE){ $taf788['delay']=0; } $taf788['time']=time(); } else { $taf788=array ( 'time' => time(), 'delay' => 5, ); } n6e52(USER_FOLDER.'password-wait.psa',serialize($taf788)); sleep($taf788['delay']); } function e7874(){ static $k34e51; if(empty($k34e51))$k34e51=md5('seсret'); return $k34e51; } function r1305($ab45cf){ $f3c6e0=e7874(); $h16ec1=strlen($f3c6e0); $i2db95=strlen($ab45cf); $z2cb9d=''; for ($d865c0=0; $d865c0 < $i2db95+rand(16,64); ++ $d865c0){ if ($d865c0 > $i2db95){ $y462e1=rand(0,127); } elseif ($d865c0==$i2db95){ $y462e1=0; } else { $y462e1=ord($ab45cf[$d865c0]); } $s18e1b=chr(($y462e1+ord($f3c6e0[$d865c0%$h16ec1])) % 256); $z2cb9d.=$s18e1b; } $z2cb9d=base64_encode($z2cb9d); return $z2cb9d; } function see85($ab45cf){ $f3c6e0=e7874(); $h16ec1=strlen($f3c6e0); $ab45cf=base64_decode($ab45cf); $i2db95=strlen($ab45cf); $z2cb9d=''; for ($d865c0=0; $d865c0 < $i2db95; ++ $d865c0){ $kd9468=(ord($ab45cf[$d865c0]) + 256-ord($f3c6e0[$d865c0%$h16ec1])) % 256; if ($kd9468===0) break; $z2cb9d.=chr($kd9468); } return $z2cb9d; } function r126f(){ global$settings; if (de852()) { return []; } else { return [ 'form-action' => d83c8('e2s_sign_in'), 'form-check-password-action' => d83c8('e2j_check_password'), 'login-name' => @$settings['author'], 'public-pc?' => false, 'reset-href' => d83c8('e2m_password_reset'), ]; } } $_candies_installer=array ( 'e2s_build', 'e2m_info', 'e2m_install', 'e2j_check_db_config', 'e2j_list_databases', 'e2s_instantiate', 'e2s_install', 'e2s_update_perform', ); $_candies_public=array ( 'e2m_info', 'e2m_frontpage', 'e2m_rss', 'e2m_json', 'e2m_note', 'e2m_note_json', 'e2m_note_read', 'e2m_draft_preview', 'e2m_tags', 'e2m_tag', 'e2m_tag_rss', 'e2m_tag_json', 'e2m_favourites', 'e2m_most_commented', 'e2m_found', 'e2m_comments', 'e2m_everything', 'e2m_sitemap_xml', 'e2m_year', 'e2m_month', 'e2m_day', 'e2m_unsubscribe', 'e2m_theme_preview', 'e2m_password_reset', 'e2s_password_reset_email', 'e2m_password', 'e2s_password_save', 'e2s_sign_in', 'e2m_sign_out', 'e2m_gip_sign_in', 'e2m_gip_sign_in_callback', 'e2m_gip_sign_out', 'e2s_comment_process', 'e2s_search', 'e2s_bsi_step', 'e2j_check_password', 'e2s_notify', ); $_candies_to_disallow_in_read_only=array ( 'e2m_write', 'e2m_note_edit', 'e2s_note_process', 'e2s_note_publish', 'e2s_note_delete', 'e2m_note_flag_favourite', 'e2m_note_flag', 'e2m_comment_edit', 'e2m_comment_delete', 'e2m_comment_reply', 'e2m_comment_reply_delete', 'e2m_comment_flag', 'e2m_comment_flag_ajax', 'e2m_unsubscribe', 'e2s_comment_process', 'e2m_settings', 'e2m_timezone', ); $_candies_public=array_merge($_candies_public,$_candies_installer); $_candies_indexable=array ( 'e2m_note', ); $_candies_indexable_conditionally=array ( 'e2m_frontpage', 'e2m_tag', 'e2m_favourites', 'e2m_most_commented', 'e2m_found', 'e2m_tags', 'e2m_everything', ); $_candies_ajax=array ( 'e2j_check_db_config', 'e2j_list_databases', 'e2j_check_password', 'e2j_userpic_upload', 'e2j_userpic_remove', 'e2j_file_upload', 'e2j_file_remove', 'e2j_note_livesave', 'e2m_note_flag_favourite', 'e2m_comment_flag_ajax', 'e2m_tag_flag_ajax', ); function o3020(){ global$settings,$_lang,$_config,$_strings,$ja57c1; if(Log::$ped2b5)__log('Blog information'); $p126ac['author']=htmlspecialchars(h2640(),ENT_NOQUOTES,HSC_ENC); if(array_key_exists('description',$settings)) { $z2bfe4=db7f1($settings['description'],'full'); $f67daf=$z2bfe4['text-final']; $p126ac['description']=$f67daf; $p126ac['description-format-info']=$z2bfe4['meta']; p57ad(@$z2bfe4['meta']['links-required']); } $p126ac['title']=htmlspecialchars(f6f51(),ENT_NOQUOTES,HSC_ENC); $p126ac['userpic-set?']=false; $p126ac['userpic-changeable?']=de852(); if ($p126ac['userpic-href']=m2461()) { $p126ac['userpic-set?']=true; $p126ac['userpic-large-href']=m2461('large'); $p126ac['userpic-square-href']=m2461('square'); $p126ac['userpic-changeable-href']=$p126ac['userpic-href']; } else { unset ($p126ac['userpic-href']); } if (de852()) { $p126ac['userpic-upload-action']=d83c8('e2j_userpic_upload'); $p126ac['userpic-remove-action']=d83c8('e2j_userpic_remove'); } $p126ac['href']=d83c8('e2m_frontpage', array ('page' => 1)); $p126ac['rss-href']=d83c8('e2m_rss'); $p126ac['jsonfeed-href']=d83c8('e2m_json'); $p126ac['language']=$_lang; $p126ac['show-subscribe-button?']=false; $q97bc5=array (time(),f5c05()); $f5f36b=ua846('Y',$q97bc5[0]); $p126ac['now']=$q97bc5; $naa103=$f5f36b; $i33b09=ycc02('start'); if(array_key_exists('stamp',$i33b09)) { $naa103=ua846('Y',$i33b09['stamp']); $p126ac['start-time'] = array ((int)$i33b09['stamp'],$i33b09['timezone']); } $dd0a87=false; $r40d73=l3456(true,true); if ($r40d73!==null){ if (de852()) { $fa4f0c=l3456(true,false); if ($fa4f0c!==null){ $dd0a87=($r40d73+$fa4f0c==0); } } else { $dd0a87=($r40d73==0); } } $p126ac['notes-count'] = (int)$r40d73; $p126ac['virgin?']=$dd0a87; $f9fbfe=$_config['years_range_separator']? $_config['years_range_separator']:$_strings['gs--range-separator']; $p126ac['years-range']=$naa103 . (($naa103==$f5f36b)? '':($f9fbfe.$f5f36b)); if ($ja57c1){ $p126ac['parent-site-href']=substr($ja57c1, (int)strpos('/',$ja57c1)); } return $p126ac; } function f6f51(){ global$settings,$_strings; if ( array_key_exists('site_title',$settings) and trim($settings['site_title']) != '' ){ return trim($settings['site_title']); } else { return$_strings['e2--default-blog-title']; } } function h2640(){ global$settings,$_strings; if ( array_key_exists('author',$settings) and trim($settings['author']) != '' ){ return trim($settings['author']); } else { return$_strings['e2--default-blog-author']; } } function m2461($size=''){ global$full_blog_url; if (!is_file($x435ed=USER_FOLDER .'userpic@2x.png')) { if (!is_file($x435ed=USER_FOLDER .'userpic@2x.jpg')) { return false; } } if($size=='large' and is_file(USER_FOLDER .'userpic-large@2x.jpg')) { $x435ed=USER_FOLDER .'userpic-large@2x.jpg'; } if($size=='square' and is_file(USER_FOLDER .'userpic-square@2x.jpg')) { $x435ed=USER_FOLDER .'userpic-square@2x.jpg'; } $pbc7b3=stat($x435ed); if ($pbc7b3['mtime']) { $x435ed.='?'. $pbc7b3['mtime']; } $lc315c=$full_blog_url .'/'. $x435ed; return $lc315c; } function u6442(){ global$_config,$_stopwatch,$h11755; $ac8542=round(j7f78()-$_stopwatch,3); return [ 'show?' => ($_config['display_stat'] > (int) !de852()), 'generation-time' => str_replace('.',',',$ac8542), 'peak-memory-mb' => str_replace('.',',',round((memory_get_peak_usage()/1024/1024)*100)/100), 'db-query-count' => (int) @$h11755, ]; } function e2m_info(){ global$settings,$_config,$o57de2,$ja57c1,$_template; $tf1f71=array ( 'E2_VERSION' => E2_VERSION, 'E2_RELEASE' => E2_RELEASE, 'E2_UA_STRING' => E2_UA_STRING, '---', 'PHP_VERSION' => PHP_VERSION, '---', 'installed' => (h2ac5()!==null), 'server_name' => $o57de2, 'folder_on_server' => $ja57c1, '---', 'default formatter' => $_config['default_formatter'], '---', 'theme' => $settings['template'], '---', 'Olba name' => $_template['name'], 'Olba max_image_width' => $_template['max_image_width'], 'Olba stack' => $_template['stack'], '---', 'Neasden' => substr(md5(file_get_contents('system/neasden/neasden.php')), 0,4), '---', ); echo '<pre>'; foreach ($tf1f71 as $o8ce4b => $l9e366){ if ($l9e366=='---'){ echo "\n"; continue; } echo str_pad($o8ce4b,24); echo '\''; print_r($l9e366); echo '\''; echo "\n"; } echo '</pre>'; die; } function e2s_notify(){ global$_config; if($_config['holborn']) { $c4de32=@$_GET['src']; if ($c4de32==''){ if(Log::$ped2b5)__log('Holborn: No src URL'); die; } $b466de=file_get_contents($c4de32); $b466de=e09a6($b466de); $fe13b0=json_decode($b466de,true); if (!$fe13b0){ if(Log::$ped2b5)__log('Holborn: No meaningful info from '. $c4de32 .' ('. json_last_error() .')'); if ($b13bc3=ndd69($c4de32)) { if(Log::$ped2b5)__log('Holborn: Delete note with ID '. $b13bc3['ID']); ge268($b13bc3['ID']); } die; } j927d($fe13b0,$c4de32); } die; } function e2m_sources($parameters){ global$_config; $r8bef1=$_GET['ord']; if (!$r8bef1)$r8bef1='ID'; $r8bef1="`". u7928($r8bef1) ."`"; p0738( "SELECT *, REPLACE(REPLACE(REPLACE(`URL`, 'http://', ''), 'https://', ''), 'www.', '') AS _URLX ". "FROM `". $_config['db_table_prefix']."Sources` " . "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "ORDER BY ". $r8bef1 ); $result=g0d6b(); foreach($result as $h447b7){ $tc615c=$h447b7['ID']; if ($h447b7['ID']!=$h447b7['TrueID'])$tc615c.='<br />'. $h447b7['TrueID']; $o36cd3=array ( 'id' => $tc615c, 'userpic-href' => $h447b7['PictureURL'], 'href' => $h447b7['URL'], 'href-display' => str_replace('/','/<wbr>',$h447b7['URL']), 'href-filtered' => str_replace('/','/<wbr>',$h447b7['_URLX']), 'title' => $h447b7['Title'], 'author' => $h447b7['AuthorName'], 'true?' => $h447b7['ID']==$h447b7['TrueID'], 'whitelisted?' => $h447b7['IsWhiteListed'], 'trusted?' => $h447b7['IsTrusted'], ); if (!$h447b7['IsTrusted']) { $o36cd3['trust-url']=d83c8( 'e2m_source_trust', array ('source' => $h447b7['ID']) ); } if ($h447b7['IsTrusted']) { $o36cd3['premoderate-url']=d83c8( 'e2m_source_premoderate', array ('source' => $h447b7['ID']) ); } $o36cd3['ban-url']=d83c8( 'e2m_source_ban', array ('source' => $h447b7['ID']) ); $o36cd3['forget-url']=d83c8( 'e2m_source_forget', array ('source' => $h447b7['ID']) ); $vf2ab5[] = $o36cd3; } $z2cb9d=array ( 'title' => 'Sources', 'heading' => 'Sources', ); if(count($vf2ab5)) { $z2cb9d['sources']=$vf2ab5; } else { $z2cb9d['nothing']='No sources'; } return $z2cb9d; } function e2m_source_trust($parameters){ global$_config; $a0afd9=$parameters['source']; p0738( "UPDATE  ". $_config['db_table_prefix']."Sources ". "SET `IsWhitelisted`=1, `IsTrusted`=1 ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID`=". $a0afd9, 'trust source' ); p0738( "UPDATE  ". $_config['db_table_prefix']."Notes ". "SET `IsPublished`=1 ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `SourceID`=". $a0afd9, 'publish all notes from the just trusted source' ); u198f(); x7996(); @unlink(CACHE_FILENAME_DRAFTS); @unlink(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); e2_go_to(''); die; } function e2m_source_premoderate($parameters){ global$_config; $a0afd9=$parameters['source']; p0738( "UPDATE  ". $_config['db_table_prefix']."Sources ". "SET `IsTrusted`=0 ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID`=". $a0afd9, 'distrust source, set to premoderation' ); x7996(); e2_go_to(''); die; } function e2m_source_ban($parameters){ global$_config; $a0afd9=$parameters['source']; p0738( "UPDATE  ". $_config['db_table_prefix']."Sources ". "SET `IsWhiteListed`=0, `IsTrusted`=0 ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID`=". $a0afd9, 'ban source' ); p0738( "DELETE FROM  ". $_config['db_table_prefix']."Notes ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `SourceID`=". $a0afd9, 'delete all notes from the just banned source' ); x7996(); @unlink(CACHE_FILENAME_DRAFTS); @unlink(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); e2_go_to(''); die; } function e2m_source_forget($parameters){ global$_config; $a0afd9=$parameters['source']; p0738( "DELETE FROM  ". $_config['db_table_prefix']."Sources ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID`=". $a0afd9, 'forget source' ); p0738( "DELETE FROM  ". $_config['db_table_prefix']."Notes ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `SourceID`=". $a0afd9, 'delete all notes from the just forgotten source' ); x7996(); @unlink(CACHE_FILENAME_DRAFTS); @unlink(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); e2_go_to(''); die; } function j927d($va7251,$c4de32){ if(Log::$ped2b5)__log('Holborn: Note info == '. print_r($va7251,true)); $sa4a84=k10cd(array ( 'author' => $va7251['author']['name'], 'title' => $va7251['title'], 'href' => $va7251['author']['url'], 'userpic-href' => $va7251['author']['avatar'], )); if (!$sa4a84['IsWhiteListed']) return; if(preg_match('/\+(\d\d)\:(\d\d)/',$va7251['items'][0]['date_published'],$z9c28d)) { $m7a86c=$z9c28d[1]*SECONDS_IN_AN_HOUR+$z9c28d[2]*SECONDS_IN_A_MINUTE; } $i929cf=@$va7251['items'][0]['_e2_data'] or $i929cf=array(); $i929cf=json_encode($i929cf); $d39a37=array ( 'Title' => $va7251['items'][0]['title'], 'Text' => $va7251['items'][0]['content_html'], 'FormatterID' => 'raw', 'OriginalAlias' => '', 'Uploads' => '', 'Stamp' => strtotime($va7251['items'][0]['date_published']), 'Offset' => (int)$m7a86c, 'IsDST' => 0, 'LastModified' => strtotime($va7251['items'][0]['date_modified']), 'IsCommentable' => 0, 'IsPublished' => $sa4a84['IsTrusted'], 'IsExternal' => 1, 'SourceID' => $sa4a84['ID'], 'SourceNoteID' => $va7251['items'][0]['id'], 'SourceNoteURL' => $va7251['items'][0]['url'], 'SourceNoteJSONURL' => $c4de32, 'SourceNoteData' => $i929cf, ); $v21158=$va7251['items'][0]['id']; if ( $b13bc3=rf25e($sa4a84['ID'],$v21158) ) { $d39a37['ID']=$b13bc3['ID']; kaa79('Notes',$d39a37); } else { $d39a37=p9943('Notes',$d39a37); } if (kd2e1($d39a37)) { $d39a37['IsIndexed']='1'; kaa79('Notes',$d39a37); } e2_drop_caches_for_note_($d39a37['ID']); @unlink(CACHE_FILENAME_DRAFTS); @unlink(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); } function ndd69($c4de32){ global$_config; p0738( "SELECT `ID` FROM ". $_config['db_table_prefix']."Notes ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `SourceNoteJSONURL`='". $c4de32 ."' ". "LIMIT 1", 'get note ID by source JSON URL' ); $result=g0d6b(); return$result[0]; } function rf25e($a0afd9,$fbb971){ global$_config; p0738( "SELECT `ID` FROM ". $_config['db_table_prefix']."Notes ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `SourceID`= '". $a0afd9 ."' ". "AND `SourceNoteID`= '". $fbb971 ."' ". "LIMIT 1", 'get note ID by source ID and source note ID' ); $result=g0d6b(); return$result[0]; } function e09a6($b466de){ for ($d865c0=0; $d865c0 <= 31; ++$d865c0){ $b466de=str_replace(chr($d865c0),'',$b466de); } $b466de=str_replace(chr(127),'',$b466de); if(0===strpos(bin2hex($b466de),'efbbbf')) { $b466de=substr($b466de,3); } return $b466de; } function k10cd($p03396){ global$_config; $m305c2=false; p0738( "SELECT * FROM ". $_config['db_table_prefix']."Sources ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `URL`= '". $p03396['href'] ."' ". "LIMIT 1", 'get source record by the URL from blog info' ); $result=g0d6b(); if(count($result)) { $m305c2=$result[0]; if ($m305c2['ID']!=$m305c2['TrueID']) { p0738( "SELECT * FROM ". $_config['db_table_prefix']."Sources ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID`= '". $m305c2['TrueID'] ."' ". "LIMIT 1", 'get true source record by using the TrueID of just found record' ); $result=g0d6b(); if(count($result)) { $m305c2=$result[0]; } } } $sa4a84=array ( 'Title' => $p03396['title'], 'AuthorName' => $p03396['author'], 'PictureURL' => $p03396['userpic-href'], ); if ($m305c2!==false){ if ( $m305c2['Title']!==$p03396['title'] or $m305c2['AuthorName']!==$p03396['author'] or $m305c2['PictureURL']!==$p03396['userpic-href'] ) { $sa4a84['ID']=$m305c2['ID']; kaa79('Sources',$sa4a84); } return $m305c2; } else { $sa4a84['URL']=$p03396['href']; $sa4a84['IsWhiteListed']=1; $sa4a84['IsTrusted']=0; $sa4a84=p9943('Sources',$sa4a84); $sa4a84['TrueID']=$sa4a84['ID']; kaa79('Sources',$sa4a84); return $sa4a84; } } function l1a48($d39a37,$e34d5a=false){ global$_config; $dc6827=array(); if (@$d39a37['IsExternal']) { if(array_key_exists('SourceID',$d39a37)) { p0738( "SELECT * FROM `". $_config['db_table_prefix']."Sources` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID` = '". $d39a37['SourceID'] ."'", 'get source by id' ); $rfa816=g0d6b(); $dc6827['source']=$rfa816[0]['Title']; $dc6827['source-id']=$d39a37['SourceID']; $dc6827['source-true-id']=$rfa816[0]['TrueID']; $dc6827['source-whitelisted?']=$rfa816[0]['IsWhiteListed']; $dc6827['source-trusted?']=$rfa816[0]['IsTrusted']; if (!$rfa816[0]['IsTrusted']) { $dc6827['source-trust-url']=d83c8( 'e2m_source_trust', array ('source' => $d39a37['SourceID']) ); } if ($rfa816[0]['IsTrusted']) { $dc6827['source-premoderate-url']=d83c8( 'e2m_source_premoderate', array ('source' => $d39a37['SourceID']) ); } $dc6827['source-ban-url']=d83c8( 'e2m_source_ban', array ('source' => $d39a37['SourceID']) ); $dc6827['source-forget-url']=d83c8( 'e2m_source_forget', array ('source' => $d39a37['SourceID']) ); $dc6827['author']=$rfa816[0]['AuthorName']; $dc6827['author-href']=$rfa816[0]['URL']; $dc6827['userpic-href']=$rfa816[0]['PictureURL']; } if ($e34d5a){ if(array_key_exists('SourceNoteURL',$d39a37) and @$d39a37['SourceNoteURL']!=''){ $dc6827['href']=$d39a37['SourceNoteURL']; $dc6827['href-original']=$d39a37['SourceNoteURL']; } } } return $dc6827; } function e2m_frontpage($parameters=array ()) { global$settings,$_config,$_strings; $b71860=$parameters['page']; $fae0fe=1; $yd7e5d=$settings['appearance']['notes_per_page']; $c06d2e=l3456(true,true); if ($c06d2e!==null){ if (de852()) { $z90953=l3456(true,false); if ($z90953!==null)$c06d2e+=$z90953; } $fae0fe=ceil($c06d2e/$yd7e5d); } $ud29bb=CACHE_FILENAME_FRONTPAGE; if (de852())$ud29bb=CACHE_FILENAME_FRONTPAGE_AUTHOR; if ($b71860 < 1) return e2_error404_mode(); if(CACHE_FRONTPAGE and $b71860==1 and is_file($ud29bb)) { $j4358b=@unserialize(file_get_contents($ud29bb)); } if(CACHE_FRONTPAGE and $b71860==1 and is_array($j4358b)) { } else { try { $result=z7573($b71860); $j4358b=array(); if(count($result) > 0){ foreach($result as $o8ce4b => $taad65){ $taad65['_']['_id']=$taad65['ID']; $taad65['_']['_title']=$taad65['Title']; $taad65['_']['_ord']=$o8ce4b; $taad65['_']['_ord_max']=count($result)-1; $le244c=h6791($taad65); $j4358b[] = $le244c; } } else { if ($b71860!=1) return e2_error404_mode(); } if(CACHE_FRONTPAGE and $b71860==1)n6e52($ud29bb,serialize($j4358b)); } catch (AeMySQLException $e){ e12f6($e,'Could not get latest notes for page '. $b71860); return array ( 'unavailable?' => true, 'title' => htmlspecialchars(f6f51(),ENT_NOQUOTES,HSC_ENC), ); } } $mb3b32['timeline?']=true; $mb3b32['count']=$fae0fe; $mb3b32['this'] = (int)$b71860; if ($fae0fe > 1){ if ($b71860 < $fae0fe)$mb3b32['earlier-href']=d83c8('e2m_frontpage', array ('page' => $b71860+1)); if ($b71860 > 1)$mb3b32['later-href']=d83c8('e2m_frontpage', array ('page' => $b71860-1)); $mb3b32['earlier-title']=$_strings['gs--earlier']; $mb3b32['later-title']=$_strings['gs--later']; } $qd5d3d=f6f51(); return array ( 'frontpage?' => (bool) ($b71860==1), 'title' => $qd5d3d, 'notes' => $j4358b, 'pages' => $mb3b32, ); } function z7573($b71860=1){ global$settings,$_config; $v19ee4=($b71860-1)*$settings['appearance']['notes_per_page']; $waa9f7=$v19ee4 .', '. $settings['appearance']['notes_per_page']; p0738( "SELECT * FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished`=1 ". f6f32(de852()). "ORDER BY `Stamp` DESC ". "LIMIT ". $waa9f7, 'get latest notes for page '. $b71860 ); return g0d6b(); } function e2m_json($parameters=array ()) { list ($jb9076,$h20612)=uab26(); $b466de=json_encode($jb9076,E2_JSON_STYLE); q8ec5($b466de,$h20612,'json'); } function e2m_rss($parameters=array ()) { list ($jb9076,$h20612)=uab26(); $y8bb85=e2feeds__rss_using_jsonfeed_array_($jb9076); q8ec5($y8bb85,$h20612,'rss'); } function e2m_tag_json($parameters=array ()) { if(array_key_exists('*tag',$parameters)) { $pb19ad=$parameters['*tag']; } else { return e2_error404_mode(); } list ($jb9076,$h20612)=fe229($pb19ad); $b466de=json_encode($jb9076,E2_JSON_STYLE); q8ec5($b466de,$h20612,'json'); } function e2m_tag_rss($parameters=array ()) { global$settings,$_config,$_strings; if(array_key_exists('*tag',$parameters)) { $pb19ad=$parameters['*tag']; } else { return e2_error404_mode(); } list ($jb9076,$h20612)=fe229($pb19ad); $y8bb85=e2feeds__rss_using_jsonfeed_array_($jb9076); q8ec5($y8bb85,$h20612,'rss'); } function e2m_note_json($parameters=array ()) { global$settings,$_current_url; $d39a37=$parameters['*note']; if ($d39a37==false){ return e2_error404_mode(); } if (!db44b($d39a37,de852())) { return e2_error404_mode(); } $d39a37['_']['_id']=$d39a37['ID']; $h20612=$d39a37['Stamp']; $w7da21=e2_jsonfeed_item_array_from_noterec_($d39a37); $k0bf08=array ($w7da21); $jb9076=e2_jsonfeed_array_stub_from_jsonfeed_item_arrays_($k0bf08); $jb9076['title']=f6f51(); $jb9076['home_page_url']=d83c8('e2m_frontpage', array ('page' => 1)); $jb9076['feed_url']=$_current_url; q8ec5(json_encode($jb9076,E2_JSON_STYLE),$h20612,'json'); } function e2_jsonfeed_array_stub_from_jsonfeed_item_arrays_($k0bf08){ global$_lang,$_config,$settings; $z2cb9d=[ 'version' => 'https://jsonfeed.org/version/1', 'title' => null, '_rss_description' => null, '_rss_language' => $_lang, '_itunes_email' => '', '_itunes_categories_xml' => '', '_itunes_image' => '', '_itunes_explicit' => '', 'home_page_url' => null, 'feed_url' => null, 'icon' => m2461(), 'author' => array ( 'name' => h2640(), 'url' => d83c8('e2m_frontpage', array ('page' => 1)), 'avatar' => m2461(), ), 'items' => $k0bf08, '_e2_version' => E2_VERSION, '_e2_ua_string' => E2_UA_STRING, ]; return $z2cb9d; } function e2_jsonfeed_item_array_from_noterec_($d39a37){ global$settings; $d39a37['_']['_id']=$d39a37['ID']; $y572d4=d83c8('e2m_note', array ('*note' => $d39a37)); $m803d0=( ua846('Y-m-d\TH:i:s',$d39a37['Stamp']) . ud536($d39a37['Stamp'],':') ); $vade16=( ua846('Y-m-d\TH:i:s',$d39a37['LastModified']) . ud536($d39a37['LastModified'],':') ); $t316ec=( ua846('D, d M Y H:i:s ',$d39a37['Stamp']) . ud536($d39a37['Stamp']) ); $z2bfe4=b154e($d39a37['FormatterID'], @$d39a37['Text'],'full-rss'); $gad965=sdbcc( 'note',$d39a37['_']['_id'], $z2bfe4['meta']['resources-detected'] ); $ue70c4=array ( 'id' => (string)$d39a37['ID'], 'url' => $y572d4, 'title' => z6f10(htmlspecialchars($d39a37['Title'],ENT_NOQUOTES)), 'content_html' => $z2bfe4['text-final'], 'date_published' => $m803d0, 'date_modified' => $vade16, ); if ($d39a37['IsExternal']) { $x60d40=l1a48($d39a37,true); $ue70c4['url']=$x60d40['href']; $ue70c4['author'] = array ( 'name' => $x60d40['author'], 'url' => $x60d40['author-href'], 'avatar' => $x60d40['userpic-href'], ); } if(count($gad965) > 0){ $ue70c4['image']=$gad965[0]; } $ue70c4['_date_published_rfc2822']=$t316ec; if ($d39a37['Stamp'] < $settings['v3223_rss_permalinks_before_stamp']) { $ue70c4['_rss_guid_is_permalink']='true'; $ue70c4['_rss_guid']=$ue70c4['url']; } else { $ue70c4['_rss_guid_is_permalink']='false'; $ue70c4['_rss_guid'] = (string)$d39a37['ID']; } $ue70c4['_e2_data'] = array ( 'is_favourite' => (bool)$d39a37['IsFavourite'], 'links_required' => $z2bfe4['meta']['links-required'], 'og_images' => $gad965, ); return $ue70c4; } function r3010($r7a402,$qd5d3d,$ze8fab){ global$_newsfeeds; if (!isset ($_newsfeeds))$_newsfeeds=[]; $kfc0f6=''; if ($r7a402=='rss')$kfc0f6='application/rss+xml'; if ($r7a402=='json')$kfc0f6='application/json'; $_newsfeeds[] = [ 'type' => $kfc0f6, 'title' => htmlspecialchars($qd5d3d,ENT_NOQUOTES,HSC_ENC), 'href' => $ze8fab ]; } function hed63(){ global$_config; p0738( "SELECT * FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished`=1 ". f6f32(). "ORDER BY `Stamp` DESC ". "LIMIT ". $_config['rss_items'], 'get recent public noterecs for RSS or JSONFeed' ); return g0d6b(); } function uab26(){ global$settings,$_current_url; $h20612=0; $k0bf08=array(); $jb9076=array(); $ud29bb=CACHE_FILENAME_FRONTPAGE_FEED; if(CACHE_FRONTPAGE_FEED and is_file($ud29bb)) { if(Log::$ped2b5)__log('Feed array (RSS, JSON): cached'); $jb9076=@unserialize(file_get_contents($ud29bb)); $h20612=filemtime($ud29bb); } else { if(Log::$ped2b5)__log('Feed array (RSS, JSON): not cached, will need to build'); $ac2d18=hed63(); foreach ($ac2d18 as $d39a37){ $k0bf08[] = e2_jsonfeed_item_array_from_noterec_($d39a37); $h20612=max($h20612,$d39a37['Stamp']); } $f67daf=''; if(array_key_exists('description',$settings)) { $f67daf=$settings['description']; } if ((string)$f67daf!==''){ $z2bfe4=db7f1($f67daf,'full'); $tfc882=$z2bfe4['text-final']; $tfc882=u5421($tfc882); } else { $tfc882=f6f51(); } $jb9076=e2_jsonfeed_array_stub_from_jsonfeed_item_arrays_($k0bf08); $jb9076['title']=f6f51(); $jb9076['_rss_description']=$tfc882; $jb9076['home_page_url']=d83c8('e2m_frontpage', array ('page' => 1)); $jb9076['feed_url']=$_current_url; if(CACHE_FRONTPAGE_FEED)n6e52($ud29bb,serialize($jb9076)); } return array ($jb9076,$h20612); } function fe229($pb19ad){ global$settings,$_config,$_strings,$_current_url; $h20612=0; $k0bf08=array(); p0738( "SELECT n.* ". "FROM `". $_config['db_table_prefix']."Notes` n ". "INNER JOIN `". $_config['db_table_prefix']."NotesKeywords` nk ". "ON nk.`NoteID` = n.`ID` ". "WHERE n.`SubsetID`=". $_config['db_table_subset'] ." ". "AND nk.`SubsetID`=". $_config['db_table_subset'] ." ". "AND (nk.`KeywordID` = ". $pb19ad['ID'] .") ". "AND n.`IsPublished` = 1 ". f6f32(de852()). "ORDER BY n.`Stamp` DESC ". "LIMIT ". $_config['rss_items'], 'get tag noterecs for RSS or JSONFeed' ); $ac2d18=g0d6b(); foreach ($ac2d18 as $d39a37){ $k0bf08[] = e2_jsonfeed_item_array_from_noterec_($d39a37); $h20612=max($h20612,$d39a37['Stamp']); } $f67daf=''; if ((string)$pb19ad['Description']!==''){ $f67daf=$pb19ad['Description']; } elseif(array_key_exists('description',$settings)) { $f67daf=$settings['description']; } if ((string)$f67daf!==''){ $z2bfe4=db7f1($f67daf,'full'); $tfc882=$z2bfe4['text-final']; $tfc882=u5421($tfc882); } else { $tfc882=f6f51(); } $wb73b1=htmlspecialchars($pb19ad['PageTitle'],ENT_COMPAT,HSC_ENC); if ((string)$wb73b1!==''){ $qd5d3d=$wb73b1; } else { $qd5d3d=( f6f51() .': '. $_strings['gs--posts-tagged'] .' '. htmlspecialchars($pb19ad['Keyword'],ENT_COMPAT,HSC_ENC) ); } $jb9076=e2_jsonfeed_array_stub_from_jsonfeed_item_arrays_($k0bf08); $jb9076['title']=$qd5d3d; $jb9076['_rss_description']=$tfc882; $jb9076['home_page_url']=d83c8('e2m_tag', array ('*tag' => $pb19ad)); $jb9076['feed_url']=$_current_url; return array ($jb9076,$h20612); } function e2feeds__rss_using_jsonfeed_array_($content){ $b92eac=USER_FOLDER.'rss/rss.tmpl.php'; if (!is_file($b92eac)) { $b92eac=DEFAULTS_FOLDER.'rss/rss.tmpl.php'; } if(is_file($b92eac)) { ob_start(); include $b92eac; $y8bb85=ob_get_contents(); ob_end_clean(); } return $y8bb85; } function z99a9($y8bb85){ $y8bb85=str_replace("\x0",'',$y8bb85); for ($d865c0=0; $d865c0 < strlen($y8bb85); ++$d865c0){ if(ord($y8bb85[$d865c0]) < 32 and !in_array(ord($y8bb85[$d865c0]), array (10,13))) { $y8bb85[$d865c0]=''; } } return $y8bb85; } function q8ec5($t321c3,$h20612,$r7a402){ global$_config; $e69a10=gmdate('r',$h20612); $j1872a=md5($h20612); if ($r7a402=='rss'){ if (@$_config['dev_xml_as_text']) { header('Content-Type: text/plain'); } else { header('Content-Type: application/xml; charset=utf-8'); } } elseif ($r7a402=='json'){ header('Content-Type: application/json'); } else { header('Content-Type: text/plain'); } header('Last-modified: '. $e69a10); header('Etag: '. $j1872a); header('Cache-Control: public'); header('Expires: '. date('r',$h20612+SECONDS_IN_A_DAY)); $v0c3cd=isset($_SERVER['HTTP_IF_MODIFIED_SINCE'])? stripslashes($_SERVER['HTTP_IF_MODIFIED_SINCE']) : false; $zc3522=isset($_SERVER['HTTP_IF_NONE_MATCH'])? stripslashes($_SERVER['HTTP_IF_NONE_MATCH']) : false; if ( !$v0c3cd && !$zc3522 or $zc3522 && $zc3522!=$j1872a or $v0c3cd && $v0c3cd!=$e69a10 ){ if ($r7a402=='rss'){ $y8bb85=z99a9($y8bb85); } ini_set('zlib.output_compression',0); echo $t321c3; ini_set('zlib.output_compression',1); } else { header('HTTP/1.1 304 Not Modified'); } die; } function e2m_year($parameters=array ()) { global$_strings,$_config; $b84cdc=$parameters['year']; $o09d6c=e2l_get_string('pt--nth-year', array ('year' => $b84cdc)); if (!w1665($b84cdc)) { return e2_error404_mode(); } $qe6e7d=gmmktime(0,0,0,1,1,$b84cdc-1); $f029bd=gmmktime(0,0,0,1,1,$b84cdc+1); list ($b8aebd,$h5a7f3)=e2__fruitful_neighbours_with_ymd_($b84cdc); $ha6d40='e2m_year'; if ($b8aebd){ $mb3b32['prev-href']=d83c8( $ha6d40,e2__parameters_with_timestamp_($b8aebd) ); $mb3b32['prev-jump?'] = (bool) (gmdate('Y',$qe6e7d)!=gmdate('Y',$b8aebd)); $mb3b32['prev-title']=gmdate('Y',$b8aebd); } if ($h5a7f3){ $mb3b32['next-href']=d83c8( $ha6d40,e2__parameters_with_timestamp_($h5a7f3) ); $mb3b32['next-jump?'] = (bool) (gmdate('Y',$f029bd)!=gmdate('Y',$h5a7f3)); $mb3b32['next-title']=gmdate('Y',$h5a7f3); } $mb3b32['timeline?']=false; $mb3b32['this']=$b84cdc; $mb3b32['this-title']=$b84cdc; $ab2442=ycc02('start'); $f8dbc7=ycc02('end'); if ( $b84cdc==e5a2f('Y',$ab2442['stamp'],$ab2442['timezone']) ) { $xfa098=e5a2f('m',$ab2442['stamp'],$ab2442['timezone']); } else { $xfa098=1; } if ( $b84cdc==ua846('Y',time()) ) { $sfd384=ua846('m',time()); } else { $sfd384=12; } $z6eac3=f9737($b84cdc); for ($s7436f=1; $s7436f <= 12; ++ $s7436f){ $u7f769=gmmktime(0,0,0,$s7436f,1,$b84cdc); $vd039b[$s7436f] = array ( 'number' => $s7436f, 'start-time' => array ($u7f769,d3211()), 'href' => gmdate('Y/m/',$u7f769), 'real?' => $s7436f >= $xfa098 and $s7436f <= $sfd384, 'fruitful?' => @in_array(gmdate('n',$u7f769),$z6eac3), ); } list ($l7b314,$ia1f20)=f5273($b84cdc); $z2cb9d=[ 'title' => $o09d6c, 'heading' => $o09d6c, 'pages' => $mb3b32, 'year' => (int)$b84cdc, 'year-months' => $vd039b, ]; p0738( "SELECT * FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished` = 1 ". f6f32(de852()). "AND `Stamp` BETWEEN ". $l7b314 ." ". "AND ". $ia1f20 ." ". "ORDER BY `Stamp`", 'get all notes for the year' ); $result=g0d6b(); $j4358b=l28df($result,$b84cdc); if(count($j4358b)) { $z2cb9d['notes-list']=$j4358b; } else { $z2cb9d['nothing']=$_strings['gs--no-such-notes']; } return $z2cb9d; } function e2m_month($parameters=array ()) { global$_strings,$_config; $b84cdc= $parameters['year']; $s7436f=$parameters['month']; $o09d6c=e2l_get_string( 'pt--nth-month-of-nth-year', array ('year' => $b84cdc,'month' => $s7436f) ); if (!w1665($b84cdc,$s7436f)) { return e2_error404_mode(); } $qe6e7d=gmmktime(0,0,0,$s7436f-1,1,$b84cdc); $f029bd=gmmktime(0,0,0,$s7436f+1,1,$b84cdc); list ($b8aebd,$h5a7f3)=e2__fruitful_neighbours_with_ymd_($b84cdc,$s7436f); $ha6d40='e2m_month'; if ($b8aebd){ $mb3b32['prev-href']=d83c8( $ha6d40,e2__parameters_with_timestamp_($b8aebd) ); $mb3b32['prev-jump?'] = (bool) (gmdate('Y/m',$qe6e7d)!=gmdate('Y/m',$b8aebd)); $mb3b32['prev-title']=e2l_get_string( 'gs--nth-month-of-nth-year', array ( 'year' => gmdate('Y',$b8aebd),'month' => gmdate('n',$b8aebd) ) ); } if ($h5a7f3){ $mb3b32['next-href']=d83c8( $ha6d40,e2__parameters_with_timestamp_($h5a7f3) ); $mb3b32['next-jump?'] = (bool) (gmdate('Y/m',$f029bd)!=gmdate('Y/m',$h5a7f3)); $mb3b32['next-title']=e2l_get_string( 'gs--nth-month-of-nth-year', array ( 'year' => gmdate('Y',$h5a7f3),'month' => gmdate('n',$h5a7f3) ) ); } $mb3b32['timeline?']=false; $mb3b32['this-title']=$o09d6c; list ($l7b314,$ia1f20)=f5273($b84cdc,$s7436f); $z2cb9d=[ 'title' => $o09d6c, 'heading' => $o09d6c, 'pages' => $mb3b32, 'year' => (int)$b84cdc, 'month' => (int)$s7436f, 'month-days' => e2_pack_month_days_with_ymd_($b84cdc,$s7436f,false), ]; p0738( "SELECT * FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished` = 1 ". f6f32(de852()). "AND `Stamp` BETWEEN ". $l7b314 ." ". "AND ". $ia1f20 ." ". "ORDER BY `Stamp`", 'get all notes for the month' ); $result=g0d6b(); $j4358b=l28df($result,$b84cdc,$s7436f); if(count($j4358b)) { $z2cb9d['notes-list']=$j4358b; } else { $z2cb9d['nothing']=$_strings['gs--no-such-notes']; } return $z2cb9d; } function e2m_day($parameters=array ()) { global$_strings; $b84cdc= (int)$parameters['year']; $s7436f=(int)$parameters['month']; $m628b7= (int)$parameters['day']; if (!(w1665($b84cdc,$s7436f,$m628b7))) { return e2_error404_mode(); } $o09d6c=e2l_get_string( 'pt--nth-day-of-nth-month-of-nth-year', array ('year' => $b84cdc,'month' => $s7436f,'day' => $m628b7) ); $qe6e7d=gmmktime(0,0,0,$s7436f,$m628b7-1,$b84cdc); $f029bd=gmmktime(0,0,0,$s7436f,$m628b7+1,$b84cdc); list ($b8aebd,$h5a7f3)=e2__fruitful_neighbours_with_ymd_($b84cdc,$s7436f,$m628b7); $ha6d40='e2m_day'; if ($b8aebd){ $mb3b32['prev-href']=d83c8( $ha6d40,e2__parameters_with_timestamp_($b8aebd) ); $mb3b32['prev-jump?'] = (bool) (gmdate('Y/m/d',$qe6e7d)!=gmdate('Y/m/d',$b8aebd)); $mb3b32['prev-title']=e2l_get_string( 'gs--nth-day-of-nth-month-of-nth-year', array ( 'year' => gmdate('Y',$b8aebd),'month' => gmdate('n',$b8aebd),'day' => gmdate('j',$b8aebd), ) ); } if ($h5a7f3){ $mb3b32['next-href']=d83c8( $ha6d40,e2__parameters_with_timestamp_($h5a7f3) ); $mb3b32['next-jump?'] = (bool) (gmdate('Y/m/d',$f029bd)!=gmdate('Y/m/d',$h5a7f3)); $mb3b32['next-title']=e2l_get_string( 'gs--nth-day-of-nth-month-of-nth-year', array ( 'year' => gmdate('Y',$h5a7f3),'month' => gmdate('n',$h5a7f3),'day' => gmdate('j',$h5a7f3), ) ); } $mb3b32['timeline?']=false; $mb3b32['this-title']=$o09d6c; $z2cb9d=[ 'title' => $o09d6c, 'heading' => $o09d6c, 'pages' => $mb3b32, 'month-days' => e2_pack_month_days_with_ymd_($b84cdc,$s7436f,$m628b7), ]; $result=of9fb($b84cdc,$s7436f,$m628b7); $result=array_reverse($result); $f15514=de852(); foreach($result as $o8ce4b => $d39a37){ if (db44b($d39a37,$f15514)) { $d39a37['_']['_id']=$d39a37['ID']; $d39a37['_']['_ord']=$o8ce4b; $d39a37['_']['_ord_max']=count($result)-1; $j4358b[] = h6791($d39a37); } } if(count($j4358b)) { $z2cb9d['notes']=$j4358b; } else { $z2cb9d['nothing']=$_strings['gs--no-such-notes']; } return $z2cb9d; } function s71d9(){ global$_config; $j4358b=null; if(CACHE_FULLLIST and is_file(CACHE_FILENAME_FULLLIST)) { $j4358b=@unserialize(file_get_contents(CACHE_FILENAME_FULLLIST)); if(Log::$ped2b5)__log('Retrieving full notes list from cache...'); } if (!is_array($j4358b)) { if(Log::$ped2b5)__log('Retrieving full notes list from database...'); p0738( "SELECT `ID`, `Title`, `Stamp`, `LastModified`, `Offset`, `IsDST`, ". "`IsFavourite`, `IsPublished`, `IsVisible`, `SourceNoteURL`, `OriginalAlias` ". "FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished` = 1 ". f6f32(). "ORDER BY `Stamp`", 'get full notes list' ); $result=g0d6b(); $j4358b=l28df($result); if(CACHE_FULLLIST)n6e52(CACHE_FILENAME_FULLLIST,serialize($j4358b)); } return $j4358b; } function e2m_everything($parameters=array ()) { global$_strings; $j4358b=s71d9(); $g1f525=count($j4358b); $o09d6c=e2l_get_string('pt--n-posts', array ('number' => $g1f525)); $z2cb9d=[ 'title' => $o09d6c, 'heading' => $o09d6c, ]; if(count($j4358b)) { $z2cb9d['notes-list']=$j4358b; } else { $z2cb9d['nothing']=$_strings['gs--no-notes']; } return $z2cb9d; } function e2m_sitemap_xml($parameters=array ()) { global$_config; $j4358b=s71d9(); if (@$_config['dev_xml_as_text']) { header('Content-Type: text/plain'); } else { header('Content-type: application/xml; charset=utf-8'); } echo '<?xml version="1.0" encoding="UTF-8"?>'."\r\n"; echo '<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">'."\r\n"; if(count($j4358b)) { $h20612=@$j4358b[0]['last-modified']; echo '<url>'."\r\n"; echo '<loc>'. d83c8('e2m_frontpage', array ('page' => 1)) .'</loc>'."\r\n"; echo '<lastmod>'; echo gmdate('Y-m-d\TH:i:s\Z',$h20612[0]); echo '</lastmod>'."\r\n"; echo '<changefreq>hourly</changefreq>'; echo '</url>'."\r\n"; foreach ($j4358b as $taad65){ echo '<url>'."\r\n"; echo '<loc>'; echo $taad65['href']; echo '</loc>'."\r\n"; echo '<lastmod>'; echo gmdate('Y-m-d\TH:i:s\Z',$taad65['last-modified'][0]); echo '</lastmod>'."\r\n"; echo '</url>'."\r\n"; } } echo '</urlset>'."\r\n"; die; } function e2_pack_month_days_with_ymd_($b84cdc,$s7436f,$m628b7){ $ja6933=e5a2f('t',gmmktime(0,0,0,$s7436f,1,$b84cdc),d3211()); $ab2442=ycc02('start'); $f8dbc7=ycc02('end'); if ( $b84cdc .'/'. $s7436f == e5a2f('Y/n',$ab2442['stamp'],$ab2442['timezone']) ) { $b42eb4=e5a2f('d',$ab2442['stamp'],$ab2442['timezone']); } else { $b42eb4=1; } if ( $b84cdc .'/'. $s7436f == ua846('Y/n',time()) ) { $td5f50=ua846('d',time()); } else { $td5f50=$ja6933; } $de4602=nae09($b84cdc,$s7436f); for ($d865c0=1; $d865c0 <= $ja6933; ++ $d865c0){ $u7f769=gmmktime(0,0,0,$s7436f,$d865c0,$b84cdc); $n271c1[$d865c0] = array ( 'number' => $d865c0, 'start-time' => array ($u7f769,d3211()), 'href' => gmdate('Y/m/d/',$u7f769), 'this?' => (bool) ($d865c0==$m628b7), 'real?' => $d865c0 >= $b42eb4 and $d865c0 <= $td5f50, 'fruitful?' => @in_array(gmdate('d',$u7f769),$de4602), ); } return $n271c1; } function w1665($b84cdc,$s7436f=false,$m628b7=false){ $ab2442=ycc02('start'); if ($ab2442===false){ return false; } $wc1f1e=e5a2f('Y',$ab2442['stamp'],$ab2442['timezone']); $hebeb3=ua846('Y',time()); if ($s7436f===false){ return (bool) ( $b84cdc >= $wc1f1e and $b84cdc <= $hebeb3 ); } else { $z782fc=e5a2f('n',$ab2442['stamp'],$ab2442['timezone']); $q13dd1=ua846('n',time()); if ($m628b7===false){ return (bool) ( $s7436f >= 1 and $s7436f <= 12 and ( ($b84cdc > $wc1f1e and $b84cdc < $hebeb3) or ($b84cdc==$wc1f1e and $s7436f >= $z782fc) or ($b84cdc==$hebeb3 and $s7436f <= $q13dd1) ) ); } else { $z7a9c0=e5a2f('j',$ab2442['stamp'],$ab2442['timezone']); $d23209=ua846('j',time()); if(1){ return (bool) ( checkdate($s7436f,$m628b7,$b84cdc) and ( ($b84cdc > $wc1f1e and $b84cdc < $hebeb3) or ($b84cdc==$wc1f1e and $s7436f > $z782fc) or ($b84cdc==$wc1f1e and $s7436f==$z782fc and $m628b7 >= $z7a9c0) or ($b84cdc==$hebeb3 and $s7436f < $q13dd1) or ($b84cdc==$hebeb3 and $s7436f==$q13dd1 and $m628b7 <= $d23209) ) ); } } } } function e2__fruitful_neighbours_with_ymd_($q41529,$s6f8f5=false,$q8277e=false){ global$_db,$_config; list ($s3d2fa,$l9468c)=f5273($q41529,$s6f8f5,$q8277e); $tada4b=SECONDS_IN_A_DAY; if ($q8277e===false)$tada4b=SECONDS_IN_A_MONTH; if ($s6f8f5===false)$tada4b=SECONDS_IN_A_YEAR; $lbf025=$h8dc98=null; p0738( "SELECT `Stamp`, `Offset`, `IsDST` ". "FROM `". $_config['db_table_prefix']. "Notes` n ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished`=1 ". "AND `Stamp` < '". ($l9468c-$tada4b) ."' ". f6f32(de852()). "ORDER BY Stamp DESC", 'get previous fruitful neighbour with ymd' ); while ($x6438c=mysqli_fetch_array($_db['result'],MYSQLI_ASSOC)) { list ($b84cdc,$s7436f,$m628b7)=explode('/', e5a2f('Y/n/j',$x6438c['Stamp'],e0923($x6438c)) ); $t7474d=$q41529*10000 + ($s6f8f5? ($s6f8f5*100):0) + ($q8277e? $q8277e:0); $lbd8da=$b84cdc*10000 + ($s6f8f5? ($s7436f*100):0) + ($q8277e? $m628b7:0); if ($lbd8da < $t7474d){ $lbf025=gmmktime(0,0,0,$s7436f,$m628b7,$b84cdc); break; } } p0738( "SELECT `Stamp`, `Offset`, `IsDST` ". "FROM `". $_config['db_table_prefix']. "Notes` n ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished`=1 ". "AND `Stamp` > '". ($s3d2fa+$tada4b) ."' ". f6f32(de852()). "ORDER BY Stamp", 'get next fruitful neighbour with ymd' ); while ($x6438c=mysqli_fetch_array($_db['result'],MYSQLI_ASSOC)) { list ($b84cdc,$s7436f,$m628b7)=explode('/', e5a2f('Y/n/j',$x6438c['Stamp'],e0923($x6438c)) ); $t7474d=$q41529*10000 + ($s6f8f5? ($s6f8f5*100):0) + ($q8277e? $q8277e:0); $lbd8da=$b84cdc*10000 + ($s6f8f5? ($s7436f*100):0) + ($q8277e? $m628b7:0); if ($lbd8da > $t7474d){ $h8dc98=gmmktime(0,0,0,$s7436f,$m628b7,$b84cdc); break; } } return [$lbf025,$h8dc98]; } function e2__parameters_with_timestamp_($w96b8c){ list ( $parameters['year'], $parameters['month'], $parameters['day'] ) = explode('/',gmdate('Y/m/d',$w96b8c)); return$parameters; } function l28df($ac2d18,$b84cdc=false,$s7436f=false){ $i229c3=0; $j4358b=array(); $df09d8=''; $j4358b=array(); $dcc73f=array(); foreach ($ac2d18 as $o8ce4b => $d39a37){ $taad65['href'] = d83c8('e2m_note', array ('*note' => $d39a37)); $taad65['time'] = array ((int)min($d39a37['Stamp'],time()), e0923($d39a37)); $taad65['last-modified'] = array ((int)min($d39a37['LastModified'],time()), e0923($d39a37)); $taad65['favourite?'] = (bool) ($d39a37['IsFavourite'] && $d39a37['IsPublished']); $taad65['visible?'] = db44b($d39a37); if(array_key_exists('SourceNoteURL',$d39a37) and @$d39a37['SourceNoteURL']!=''){ $taad65['href']=$d39a37['SourceNoteURL']; $taad65['href-original']=$d39a37['SourceNoteURL']; } if ( ($b84cdc and $s7436f and ( ((int)$b84cdc) .'/'. ((int)$s7436f) == e5a2f('Y/n',$d39a37['Stamp'],e0923($d39a37)) )) or ($b84cdc and !$s7436f and ( (int)$b84cdc == e5a2f('Y',$d39a37['Stamp'],e0923($d39a37)) )) or (!$b84cdc and !$s7436f) ) { array_unshift($j4358b,$taad65); array_unshift($dcc73f,str_replace("\n",' ',$d39a37['Title'])); } } $x789f1=implode("\n",$dcc73f); $x789f1=z6f10(htmlspecialchars($x789f1,ENT_NOQUOTES,HSC_ENC)); $dcc73f=explode("\n",$x789f1); foreach ($j4358b as $o8ce4b => $l9e366){ $j4358b[$o8ce4b]['title']=$dcc73f[$o8ce4b]; } return $j4358b; } function f9737($q41529){ global$_config; list ($t5a603,$ac2b31)=f5273($q41529); p0738( "SELECT `Stamp`, `Offset`, `IsDST` ". "FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished`=1 ". "AND `Stamp` BETWEEN '". $t5a603. "' AND '". $ac2b31 ."' ". f6f32(de852()), 'get all notes for the year '. $q41529 .' to list months with notes' ); $result=g0d6b(); $yda36c=array(); foreach($result as $c65afd){ if ( ((int)$q41529) == e5a2f('Y',$c65afd['Stamp'],e0923($c65afd)) ) { $yda36c[] = (int)e5a2f('n',$c65afd['Stamp'],e0923($c65afd)); } } $yda36c=@array_unique($yda36c); sort($yda36c); return $yda36c; } function nae09($q41529,$s6f8f5){ global$_config; list ($lfc6b2,$e10df4)=f5273($q41529,$s6f8f5); p0738( "SELECT `Stamp`, `Offset`, `IsDST` ". "FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished`=1 ". "AND `Stamp` BETWEEN '". $lfc6b2 ."' AND '". $e10df4 ."' ". f6f32(de852()), 'get all notes for the month '.$s6f8f5.' of the year '. $q41529 .' to list days with notes' ); $result=g0d6b(); $f44fde=array(); foreach($result as $c65afd){ if ( ((int)$q41529) .'/'. ((int)$s6f8f5) == e5a2f('Y/n',$c65afd['Stamp'],e0923($c65afd)) ) { $f44fde[] = (int)e5a2f('j',$c65afd['Stamp'],e0923($c65afd)); } } $f44fde=@array_unique($f44fde); sort($f44fde); return $f44fde; } function ycc02($f92c58){ global$_config; $i8b7af='p1'; if (!de852()) { $i8b7af='p1v1'; } $ud29bb=CACHES_FOLDER.$f92c58 .'-stamp-'. $i8b7af .'.e2time.psa'; if(CACHE_EDGE_TIMEINFO and is_file($ud29bb)) { $z2cb9d=@unserialize(file_get_contents($ud29bb)); } if(is_array($z2cb9d)) { return $z2cb9d; } else { $z2cb9d=array ( 'stamp' => time(), 'timezone' => f5c05(), ); if ($f92c58=='start'){ p0738( "SELECT `Stamp`, `Offset`, `IsDST` ". "FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished`=1 ". f6f32(de852()). "ORDER BY `Stamp` LIMIT 1", 'get blog start timestamp' ); } elseif ($f92c58=='end'){ p0738( "SELECT `Stamp`, `Offset`, `IsDST` ". "FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished`=1 ". f6f32(de852()). "ORDER BY `Stamp` DESC LIMIT 1", 'get blog latest note timestamp' ); } $result=g0d6b(); if(count($result)) { $z2cb9d=array ( 'stamp' => $result[0]['Stamp'], 'timezone' => e0923($result[0]), ); if(CACHE_EDGE_TIMEINFO)n6e52($ud29bb,serialize($z2cb9d)); return $z2cb9d; } return $z2cb9d; } } define('CACHE',true); define('CACHE_NOTES',CACHE and true); define('CACHE_NOTES_COMMENTS',CACHE and true); define('CACHE_POPULAR',CACHE and true); define('CACHE_HOT',CACHE and true); define('CACHE_FAVS',CACHE and true); define('CACHE_TAGS',CACHE and true); define('CACHE_FAVTAGS',CACHE and true); define('CACHE_NOTES_COUNTS',CACHE and true); define('CACHE_EDGE_TIMEINFO',CACHE and true); define('CACHE_FRONTPAGE',CACHE and true); define('CACHE_FRONTPAGE_FEED',CACHE and true); define('CACHE_FULLLIST',CACHE and true); define('CACHE_DRAFTS',CACHE and true); define('CACHE_DRAFTS_ALIAS_USE_COUNTS',CACHE and true); define('CACHE_LASTMODIFIEDS',CACHE and true); define('CACHE_FILENAMES_NOTES',CACHES_FOLDER.'note-*.ctree.psa'); define('CACHE_FILENAMES_NOTES_COMMENTS', CACHES_FOLDER.'note-*-comments.ctree.psa' ); define('CACHE_FILENAMES_NOTES_COMMENTS_AUTHOR', CACHES_FOLDER.'note-*-comments-author.ctree.psa' ); define('CACHE_FILENAMES_NOTES_COUNTS',CACHES_FOLDER.'notes-count-*.txt'); define('CACHE_FILENAMES_EDGE_TIMEINFO',CACHES_FOLDER.'*.e2time.psa'); define('CACHE_FILENAME_POPULAR',CACHES_FOLDER.'popular.ctree.psa'); define('CACHE_FILENAME_POPULAR_EXPIRES',CACHES_FOLDER.'popular-expires.txt'); define('CACHE_FILENAME_HOT',CACHES_FOLDER.'hot.ctree.psa'); define('CACHE_FILENAME_HOT_EXPIRES',CACHES_FOLDER.'hot-expires.txt'); define('CACHE_FILENAME_FAVS',CACHES_FOLDER.'favourites.ctree.psa'); define('CACHE_FILENAME_TAGS',CACHES_FOLDER.'tags.ctree.psa'); define('CACHE_FILENAME_TAGS_FULL',CACHES_FOLDER.'tags-full.ctree.psa'); define('CACHE_FILENAME_TAGS_AUTHOR',CACHES_FOLDER.'tags-author.ctree.psa'); define('CACHE_FILENAME_TAGS_AUTHOR_FULL',CACHES_FOLDER.'tags-author-full.ctree.psa'); define('CACHE_FILENAME_FAVTAGS',CACHES_FOLDER.'favtags.ctree.psa'); define('CACHE_FILENAME_FRONTPAGE',CACHES_FOLDER.'frontpage.ctree.psa'); define('CACHE_FILENAME_FRONTPAGE_AUTHOR',CACHES_FOLDER.'frontpage-author.ctree.psa'); define('CACHE_FILENAME_FRONTPAGE_FEED',CACHES_FOLDER.'frontpage-feed.psa'); define('CACHE_FILENAME_FULLLIST',CACHES_FOLDER.'notes-list.ctree.psa'); define('CACHE_FILENAME_DRAFTS',CACHES_FOLDER.'drafts.psa'); define('CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS',CACHES_FOLDER.'drafts-auc.psa'); define('CACHE_FILENAME_LASTMODIFIEDS',CACHES_FOLDER.'last-modifieds-by-id.psa'); function e2s_sync(){ e2_drop_all_kinds_of_cache(); die ('All caches clean.'); } function e2_note_cache_filename_with_id_($sb80bb){ return str_replace('*',$sb80bb,CACHE_FILENAMES_NOTES); } function e2_drop_caches_for_note_($v21158){ if(is_numeric($v21158)) { if(Log::$ped2b5)__log('Caches: Drop caches for note id '. $v21158); @unlink(e2_note_cache_filename_with_id_($v21158)); @unlink(e2_note_cache_filename_with_id_($v21158 .'-comments')); @unlink(e2_note_cache_filename_with_id_($v21158 .'-comments-author')); } else { bc5a6(CACHE_FILENAMES_NOTES); bc5a6(CACHE_FILENAMES_NOTES_COMMENTS); bc5a6(CACHE_FILENAMES_NOTES_COMMENTS_AUTHOR); } re2f1(); l22e7(); @unlink(CACHE_FILENAME_HOT); @unlink(CACHE_FILENAME_POPULAR); @unlink(CACHE_FILENAME_FRONTPAGE); @unlink(CACHE_FILENAME_FRONTPAGE_AUTHOR); @unlink(CACHE_FILENAME_FRONTPAGE_FEED); @unlink(CACHE_FILENAME_FULLLIST); @unlink(CACHE_FILENAME_TAGS); @unlink(CACHE_FILENAME_TAGS_FULL); @unlink(CACHE_FILENAME_TAGS_AUTHOR); @unlink(CACHE_FILENAME_TAGS_AUTHOR_FULL); @unlink(CACHE_FILENAME_LASTMODIFIEDS); } function x7996(){ if(Log::$ped2b5)__log('Caches: Drop notes caches'); e2_drop_caches_for_note_(null); } function re2f1(){ if(Log::$ped2b5)__log('Caches: Drop notes counts cache'); bc5a6(CACHE_FILENAMES_NOTES_COUNTS); } function l22e7(){ if(Log::$ped2b5)__log('Caches: Drop egde time info cache'); bc5a6(CACHE_FILENAMES_EDGE_TIMEINFO); } function e2_drop_all_kinds_of_cache(){ if(Log::$ped2b5)__log('Caches: Drop all kinds of caches'); bc5a6(CACHES_FOLDER.'*'); return true; } define('OLBA_SPECIAL_CHAR',"\x1"); define('OLBA_SPECIAL_SEQUENCE_LENGTH',6); function qdb82($r139c8=null){ global$_template,$_config,$settings; if ($r139c8===null)$r139c8=@$settings['template']; $n1b14d=null; $qa5fca=null; $g00e30=null; $x37c8a=null; $waf10b=array(); $td9ecb=$r139c8; if ($td9ecb!==null){ while (1){ if(Log::$ped2b5)__log('Prepare theme "'. $td9ecb .'"'); $b620f7=TEMPLATES_FOLDER.$td9ecb .'/'; if ( !is_dir($b620f7) or !is_file($b620f7 .'/theme-info.php') ) { if(Log::$ped2b5)__log('Theme "'. $td9ecb .'" not found, using default theme "'. DEFAULT_TEMPLATE .'"'); $td9ecb=DEFAULT_TEMPLATE; $b620f7=TEMPLATES_FOLDER.$td9ecb .'/'; } array_push($waf10b,$b620f7); $d38226=include $b620f7 .'/theme-info.php'; $v4e502[$b620f7]=$d38226; if(array_key_exists('max_image_width',$d38226)) { if ($n1b14d===null){ $n1b14d=$d38226['max_image_width']; } } if(array_key_exists('meta_viewport',$d38226)) { if ($qa5fca===null){ $qa5fca=$d38226['meta_viewport']; } } if(array_key_exists('supports_dark_mode',$d38226)) { if ($g00e30===null){ $g00e30=$d38226['supports_dark_mode']; } } if(array_key_exists('use_likely_light',$d38226)) { if ($x37c8a===null){ $x37c8a=$d38226['use_likely_light']; } } if(array_key_exists('based_on',$d38226)) { $td9ecb=$d38226['based_on']; } else { break; } } } if ($n1b14d===null){ $n1b14d=$_config['max_image_width']; } if ($qa5fca===null)$qa5fca=''; if ($g00e30===null)$g00e30=false; if ($x37c8a===null)$x37c8a=false; $b620f7=SYSTEM_TEMPLATE_FOLDER; array_push($waf10b,$b620f7); $_template['name']=$r139c8; $_template['max_image_width']=$n1b14d; $_template['meta_viewport']=$qa5fca; $_template['supports_dark_mode']=$g00e30; $_template['use_likely_light']=$x37c8a; $_template['stack']=$waf10b; $_template['infos']=$v4e502; }; function p53ee($ld436e){ global$content; if (!isset ($_olba_includes))$_olba_includes=0; ++ $_olba_includes; if(Log::$ped2b5)__log('Eat "'. $ld436e .'"'); include $ld436e; } function vf671($m6a992){ return ( OLBA_SPECIAL_CHAR. str_pad($m6a992,OLBA_SPECIAL_SEQUENCE_LENGTH,'0',STR_PAD_LEFT). OLBA_SPECIAL_CHAR ); } function zab71($sb0689){ static $m6a992=0; gf1da($sb0689,'_olba_placeholders'); echo vf671($m6a992 ++); } function b326f($b78e62){ global$_olba_placeholders; foreach($_olba_placeholders as $m6a992 => $o2063c){ $ie068c=vf671($m6a992); $m5e0bd=strpos($b78e62,$ie068c); $uf5300=k166b($o2063c,true); if ($m5e0bd!==false){ $b78e62=substr_replace( $b78e62,$uf5300,$m5e0bd,strlen($ie068c) ); } else { break; } } return $b78e62; } function t6a97($v52678){ if(is_dir(EXTRAS_FOLDER)) { $g71cae=EXTRAS_FOLDER.$v52678 .'.tmpl.php'; if(is_file($g71cae)) { p53ee($g71cae); } } return ''; } function k166b($v52678,$ue70c4=false){ global$_template,$_olba_includes; $g71cae='templates/'. $v52678 .'.tmpl.php'; if ($ld436e=e2o__usable_file_with_basename_($g71cae)) { if ($ue70c4){ ob_start(); } p53ee($ld436e); if ($ue70c4){ $z2cb9d=ob_get_contents(); ob_end_clean(); return $z2cb9d; } } else { ob_end_clean(); throw new AeOlbaTemplateMissingException('Missing: '. $g71cae); } } function sbc21(){ global$_config; if ( @$_config['raw_template_data'] or @$_config['raw_template_data_with_param'] and array_key_exists('raw',$_GET) ) { $v3f7d9='raw'; } else { $v3f7d9='main'; } return k166b($v3f7d9,true); } function kd4c1($c45ac4){ gf1da($c45ac4 .'.css','_olba_used_stylesheets'); } function ed00a($i3205c){ gf1da($i3205c .'.js','_olba_used_scripts'); } function d16f0($se8acc){ foreach (array (SYSTEM_LIBRARY_FOLDER,USER_LIBRARY_FOLDER) as $d71379){ foreach(glob($d71379.$se8acc .'/*') as $b8c7dd){ $habf77=pathinfo($b8c7dd,PATHINFO_EXTENSION); if ($habf77=='js'){ gf1da($b8c7dd,'_olba_used_scripts'); } if ($habf77=='css'){ gf1da($b8c7dd,'_olba_used_stylesheets'); } } } } function t94dd(){ global$_template,$_config,$settings; if ($oe1260=@opendir(TEMPLATES_FOLDER)) { while (false !== ($x1f769=readdir($oe1260))) { if(is_dir(TEMPLATES_FOLDER. $x1f769) and $x1f769!='.' and $x1f769!='..'){ if(is_file(TEMPLATES_FOLDER.$x1f769 .'/theme-info.php')) { $zccf6b[$x1f769]=TEMPLATES_FOLDER.$x1f769 .'/'; } } } closedir($oe1260); } $e10ae9=array(); $l2e3a2=1000; foreach ($zccf6b as $sb0689 => $g85114){ $d38226=include $g85114 .'theme-info.php'; $ec2657=@$d38226['display_name']; if (!$ec2657) continue; if(is_array($ec2657)) { if(array_key_exists($settings['language'],$ec2657)) { $ec2657=$ec2657[$settings['language']]; } else { $ec2657=array_shift($ec2657); } } $m6a992=@$d38226['index'] or $m6a992=$l2e3a2 ++; $b62848=@$d38226['colors']; if (!$b62848)$b62848=array ( 'background' => 'transparent', 'headings' => 'rgba(128,128,128,.2)', 'text' => 'rgba(128,128,128,.2)', 'link' => 'rgba(128,128,128,.2)', ); $w16e25=(bool) ($sb0689==$_template['name']); if ($w16e25){ $qcd143=d83c8('e2m_theme_preview', array ('theme' => '')); } else { $qcd143=d83c8('e2m_theme_preview', array ('theme' => $sb0689)); } $e10ae9[$m6a992] = array ( 'name' => $sb0689, 'display-name' => $ec2657, 'colors' => $b62848, 'current?' => $w16e25, 'preview-url' => $qcd143, 'supports-dark-mode?' => $d38226['supports_dark_mode'], ); } ksort($e10ae9); return $e10ae9; } function o1492($x435ed){ return e2o__usable_file_with_basename_('images/'. $x435ed); } function ef42c($kb1197){ return file_get_contents(e2o__usable_file_with_basename_('images/'. $kb1197 .'.svg')); } function k576f($c45ac4){ global$_template; $k954eb='styles/'. $c45ac4 .'.css'; $u95aa1=array(); foreach($_template['stack'] as $b620f7){ if(is_file($x435ed=$b620f7.$k954eb)) { $u95aa1[] = $x435ed; } if ( array_key_exists('reset_styles',$_template['infos'][$b620f7]) and in_array($c45ac4,$_template['infos'][$b620f7]['reset_styles']) ) { break; } } $u95aa1=array_reverse($u95aa1); } function q37ca(){ global$_olba_used_stylesheets,$_template; if (!isset ($_olba_used_stylesheets)) return; $_olba_used_stylesheets=array_unique($_olba_used_stylesheets); $pc7f50=array(); foreach($_olba_used_stylesheets as $c45ac4){ if(is_file($c45ac4)) { $pc7f50[] = $c45ac4; continue; } if(is_file($x435ed=USER_FOLDER .'js/'. $c45ac4)) { $pc7f50[] = $x435ed; } $k954eb='styles/'. $c45ac4; $u95aa1=array(); foreach($_template['stack'] as $b620f7){ if(is_file($x435ed=$b620f7.$k954eb)) { $u95aa1[] = $x435ed; } if ( array_key_exists('reset_styles',$_template['infos'][$b620f7]) and in_array($c45ac4,$_template['infos'][$b620f7]['reset_styles']) ) { break; } } $u95aa1=array_reverse($u95aa1); $pc7f50=array_merge($pc7f50,$u95aa1); } foreach ($pc7f50 as $o8ce4b => $l9e366){ $pbc7b3=stat($l9e366); $pc7f50[$o8ce4b].='?'. $pbc7b3['mtime']; } return $pc7f50; } function b4753(){ global$_olba_used_scripts; if (!isset ($_olba_used_scripts)) return; $_olba_used_scripts=array_unique($_olba_used_scripts); $bd6c58=array(); foreach($_olba_used_scripts as $i3205c){ if ( substr($i3205c,0,7)=='http://' or substr($i3205c,0,8)=='https://' or substr($i3205c,0,2)=='//' ){ $bd6c58[] = $i3205c; continue; } if(is_file($i3205c)) { $bd6c58[] = $i3205c; continue; } if(is_file($r9d679=USER_FOLDER .'js/'. $i3205c)) { $bd6c58[] = $r9d679; } $k954eb='js/'. $i3205c; if ($r9d679=e2o__usable_file_with_basename_($k954eb)) { $bd6c58[] = $r9d679; } } foreach ($bd6c58 as $o8ce4b => $l9e366){ $pbc7b3=stat($l9e366); if ($pbc7b3['mtime']) { $bd6c58[$o8ce4b].='?'. $pbc7b3['mtime']; } } return $bd6c58; } function p57ad($xb268d){ if (!is_array($xb268d)) return; foreach ($xb268d as $o2a304){ if(substr($o2a304, -3)=='.js'){ ed00a(substr($o2a304,0, -3)); } if(substr($o2a304, -4)=='.css'){ kd4c1(substr($o2a304,0, -4)); } } } function gf1da($o2063c,$tf1f71){ if (!isset ($GLOBALS[$tf1f71])) { $GLOBALS[$tf1f71] = array ($o2063c); } else { $GLOBALS[$tf1f71][] = $o2063c; } } function e2o__usable_file_with_basename_($k954eb){ global$_template; if (!isset ($_template))qdb82(); foreach($_template['stack'] as $b620f7){ if(is_file($x435ed=$b620f7.$k954eb)) { return $x435ed; } } return ''; } function e2m_theme_preview($parameters){ global$_lang,$_strings,$_superconfig,$_template; if (@$_superconfig['disallow_themes_preview']) { return e2_error404_mode(); } if($parameters['theme']==$_template['name']) { e2_go_to(d83c8('e2m_theme_preview', array ('theme' => ''))); } if($parameters['theme']) { qdb82($parameters['theme']); } $p75725=$_lang; if (!is_file($b8c7dd='system/preview/'. $p75725 .'.php')) { $p75725=$_strings['--secondary-language']; $b8c7dd='system/preview/'. $p75725 .'.php'; } if (!is_file($b8c7dd='system/preview/'. $p75725 .'.php')) { $b8c7dd='system/preview/'. DEFAULT_LANGUAGE .'.php'; } $ue70c4=include $b8c7dd; return $ue70c4; } define('SEARCH_EXTRA_PREFIX','Rose'); define('SEARCH_LIMIT',20); define('SEARCH_SNIPPETS_LIMIT',20); define('SEARCH_USE_ROSE',1); define('SEARCH_USE_MYSQL',1); define('BSI_SELECT_PORTION',10); define('BSI_GIVE_UP_TIMEOUT',10); define('BSI_UNLOCK_TIMEOUT',10); use S2\Rose\Storage\Exception\EmptyIndexException; use S2\Rose\Storage\Database\PdoStorage; use S2\Rose\Stemmer\PorterStemmerEnglish; use S2\Rose\Stemmer\PorterStemmerRussian; use S2\Rose\Indexer; use S2\Rose\Entity\Indexable; use S2\Rose\Entity\Query; use S2\Rose\Finder; use S2\Rose\SnippetBuilder; function e2m_found($parameters=array ()) { global$_strings,$_config,$settings,$full_blog_url; $parameters['query']=trim($parameters['query']); $w1b1cc=$parameters['query']; if (!$w1b1cc){ return array ( 'title' => $_strings['pt--search-query-empty'], 'heading' => $_strings['pt--search'], 'nothing' => $_strings['gs--search-query-empty'], ); } $r11128=false; try { p0738( "SELECT * FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `Keyword`='". u7928($w1b1cc) ."'", 'get tags matching the search query' ); $rfa816=g0d6b(); if (isset ($rfa816[0]['ID'])) { $r11128=array ( 'href' => d83c8('e2m_tag', array ('*tag' => $rfa816[0])), 'name' => htmlspecialchars($w1b1cc,ENT_NOQUOTES,HSC_ENC), ); } } catch (AeMySQLException $e){ e12f6($e,'Could not get tags matching the search query'); } $o4dd42=c163d(' ',$parameters['query']); if(SEARCH_USE_ROSE){ $ffce9c=new PorterStemmerRussian(new PorterStemmerEnglish()); foreach ($o4dd42 as $o8ce4b => $l9e366){ $o4dd42[$o8ce4b]=$ffce9c -> stemWord($o4dd42[$o8ce4b]); } } $r8e830=array(); $v5d481=de852(); if(SEARCH_USE_ROSE){ try { $jddece=l476c(); $s5b9bd=new Finder($jddece,$ffce9c); $s5b9bd -> setHighlightTemplate('<mark>%s</mark>'); $lf7de9=new Query($w1b1cc); $lf7de9 -> setLimit(SEARCH_LIMIT); $resultSet=$s5b9bd -> find($lf7de9); foreach($resultSet -> getFoundExternalIds() as $i0e684){ if ($i0e684[0]=='n'){ $v21158=substr($i0e684,1); $taad65=r4627($v21158); if (!empty ($_config['search_favourites_boost'])) { if ($taad65['IsFavourite']) { $resultSet->setRelevanceRatio($i0e684,$_config['search_favourites_boost']); } } } } $snippetBuilder=new SnippetBuilder($ffce9c); $snippetBuilder -> setSnippetLineSeparator(' · '); $snippetBuilder -> attachSnippets($resultSet, function (array $rbf516){ $result=array(); foreach(array_slice($rbf516,0,SEARCH_SNIPPETS_LIMIT) as $i0e684){ if ($i0e684[0]=='n'){ $v21158=substr($i0e684,1); $d39a37=@r4627($v21158); if ($d39a37){ $d39a37['_']['_id']=$v21158; $taad65=h6791($d39a37); $result[$i0e684]=$taad65['text']; } } } return$result; }); foreach($resultSet -> getItems() as $i0e684 => $h447b7){ if ($i0e684[0]=='n'){ $v21158=substr($i0e684,1); $taad65=r4627($v21158); $taad65['_']['_id']=$v21158; $taad65['_']['_srprovider']='rose'; $taad65['_']['_rose_relevance']=$h447b7 -> getRelevance(); $taad65['_']['_rose_title']=$h447b7 -> getHighlightedTitle($ffce9c); $taad65['_']['_rose_snippet']=$h447b7 -> getSnippet(); if ($taad65['IsPublished'] and db44b($taad65,$v5d481)) { $r8e830[] = $taad65; } } } if (@$_config['dev_rose_info']) { $y1e441=print_r($resultSet -> getTrace(),true); } } catch (EmptyIndexException $e){ e12f6($e,'Rose index is empty'); } catch (AeMySQLException $e){ e12f6($e,'Could not do something with the database while working on Rose search results'); } } if(SEARCH_USE_MYSQL){ $d36a38=u7928(preg_quote($w1b1cc)); $geb31b=( "SELECT * FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished`=1 AND MATCH (`Title`, `Text`) AGAINST ('". $d36a38 ."')". f6f32($v5d481). "LIMIT ". SEARCH_LIMIT ); try { p0738( $geb31b, 'search using MySQL fulltext search' ); $result=g0d6b(); foreach($result as $o8ce4b => $taad65){ $taad65['_']['_id']=$taad65['ID']; $taad65['_']['_srprovider']='mysql'; $r8e830[] = $taad65; } } catch (AeMySQLException $e){ e12f6($e,'Could not search using MySQL fulltext search'); } } $tfbdf2=array(); $j4358b=array(); $d865c0=0; foreach ($r8e830 as $d39a37){ if (!in_array($d39a37['ID'],$tfbdf2)) { $taad65=h6791($d39a37); if (@$taad65['_']['_rose_title']) { $taad65['title']=$taad65['_']['_rose_title']; } else { $taad65['title']=m4c2d($taad65['title'],$o4dd42); } $taad65['title']=z6f10($taad65['title']); if (@$taad65['_']['_rose_snippet']) { $taad65['text']='<p>'. $taad65['_']['_rose_snippet'] .'</p>'; } else { $l1cb25=$taad65['text']; $l1cb25=preg_replace('/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/i','',$l1cb25); $l1cb25=preg_replace('/<style\b[^<]*(?:(?!<\/style>)<[^<]*)*<\/style>/i','',$l1cb25); $l1cb25=str_replace( array ( '<br>', '<br/>', '<br />', '</h1>', '</h2>', '</h3>', '</h4>', '</h5>', '</h6>', '</p>', '</pre>', '</blockquote>', '</li>', ), ' ', $l1cb25 ); $l1cb25=strip_tags($l1cb25); $cad7ba=array(); $m9cc49=preg_split('/[\\n\(\)\[\]]|[.:;?!](\s|$)/uis',$l1cb25); $m363b1=0; $k02db3=''; foreach ($m9cc49 as $pd866f){ $pd866f=trim($pd866f); if (!$pd866f) continue; if (!$k02db3)$k02db3=$pd866f; $f870c2=$pd866f; $f870c2=m4c2d($f870c2,$o4dd42); if ($f870c2!=$pd866f){ $cad7ba[] = a48d8($f870c2); $m363b1 ++; if ($m363b1 > 3) break; } } if(count($cad7ba)) { $taad65['text']='<p>'. implode(' · ',$cad7ba) .'</p>'; } else { $taad65['text']='<p>'. $k02db3 .'</p>'; } } $taad65['has-highlighed-thumbs?']=false; if ($x55b55=@$taad65['format-info']['resources-detected']) { $y750fa=l2e82($x55b55); foreach ($y750fa as $o8ce4b => $l9e366){ $y750fa[$o8ce4b]['highlighted?'] = ( strstr($l9e366['original-filename'],$w1b1cc)!==false ); if ($y750fa[$o8ce4b]['highlighted?']) { $taad65['has-highlighted-thumbs?']=true; } } $taad65['thumbs']=$y750fa; } $j4358b[] = $taad65; $tfbdf2[] = $d39a37['ID']; $d865c0 ++; if ($d865c0 >= SEARCH_LIMIT) break; } } $cfbb44=count($j4358b); if ($cfbb44){ $w5cde2=e2l_get_string( 'pt--n-posts', array ('number' => $cfbb44) ); } else { $w5cde2=$_strings['pt--no-posts']; $z2cb9d['nothing']=$_strings['gs--nothing-found']; } if ($d865c0 >= SEARCH_LIMIT){ $w5cde2=$_strings['gs--many-posts']; } if ($r11128){ $z2cb9d['search-related-tag']=$r11128; } $z2cb9d['notes']=$j4358b; $z2cb9d['pages'] = array (); $z2cb9d['title']=$w5cde2 .' '. $_strings['gs--found-for-query'] .': '. htmlspecialchars($w1b1cc,ENT_NOQUOTES,HSC_ENC); $z2cb9d['superheading']=$w5cde2 .' '. $_strings['gs--found-for-query']; $z2cb9d['heading']=$w1b1cc; if (@$y1e441){ $z2cb9d['rose-debug-info']=$y1e441; } return $z2cb9d; } function l5070($parameters){ if(Log::$ped2b5)__log('Search form'); $w1b1cc=trim((string) @$parameters['query']); return [ 'form-action' => d83c8('e2s_search'), 'query' => htmlspecialchars($w1b1cc,ENT_COMPAT,HSC_ENC), ]; } function e2s_search(){ $w1b1cc=@$_POST['query']; $w1b1cc=str_replace('?',urlencode('?'),$w1b1cc); $w1b1cc=str_replace('/',' ',$w1b1cc); $w1b1cc=trim($w1b1cc); $w1b1cc=str_replace(' ','+',$w1b1cc); e2_go_to(d83c8('e2m_found', array ('query' => $w1b1cc))); die; } function e2s_bsi_status(){ global$_db,$_config; echo '<pre>'; echo '/@bsi/step/ — Make one step of indexing<br />'; echo '/@bsi/drop/ — Drop indexes<br /><br />'; $pe1fab=@unserialize(file_get_contents(USER_FOLDER.'indexing.psa')); if (!is_array($pe1fab))$pe1fab=array ('spent' => '?'); $l34421=$we0d69=$zd1647='?'; try { p0738( "SELECT count(*) c FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished`=1 ", 'count total published notes' ); $k9b207=g0d6b(); $l34421=$k9b207[0]['c']; p0738( "SELECT count(*) c FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsIndexed`=1 AND `IsPublished`=1 ", 'count indexed published notes' ); $k9b207=g0d6b(); $we0d69=$k9b207[0]['c']; $zd1647=round($we0d69/$l34421*100); echo 'Indexed '. $we0d69 .' notes of '. $l34421 .' ('. $zd1647 .'%)<br />'; echo 'Spent '. $pe1fab['spent'] .' s (or more)'; } catch (AeMySQLException $e){ e12f6($e,'Could not count some notes'); echo 'DB unaccessible'; } die ('</pre>'); } function e2s_bsi_step(){ global$_db,$_config,$_strings; echo '<pre>'; if($_config['log_bsi']) { Log::$ped2b5=true; if(Log::$ped2b5)y714a('bsi'); } if(Log::$ped2b5)__log('BSI step'); if (!k3b97()) { if(Log::$ped2b5)__log('Not indexing'); die ('Not indexing</pre>'); } $pe1fab=@unserialize(file_get_contents(USER_FOLDER.'indexing.psa')); if (!is_array($pe1fab))$pe1fab=array ('spent' => '?'); if ( !isset ($pe1fab['lock']) or $pe1fab['lock'] < time() - (BSI_GIVE_UP_TIMEOUT+BSI_UNLOCK_TIMEOUT) ) { if (isset ($pe1fab['lock'])) { if(Log::$ped2b5)__log('Indexer: old lock is '. $pe1fab['lock']); echo 'Old lock is '. $pe1fab['lock'] .'<br />'; } else { echo 'No old lock<br />'; } $pe1fab['lock']=time(); if (!@n6e52(USER_FOLDER.'indexing.psa',serialize($pe1fab))) { if(Log::$ped2b5)__log('Indexer: can’t get a new lock'); die ('Can’t get a new lock<br />'); } if(Log::$ped2b5)__log('Indexer: new lock is '. $pe1fab['lock']); echo 'New lock is '. $pe1fab['lock'] .'<br /><br />'; try { $d865c0=0; $t680a2=0; $qce2fc=j7f78(); $s30d94=false; while ($t680a2 < BSI_GIVE_UP_TIMEOUT){ p0738( "SELECT * FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsIndexed`=0 AND `IsPublished`=1 ". "ORDER BY `Stamp` DESC ". "LIMIT ". BSI_SELECT_PORTION, 'get portion of unindexed notes for indexing' ); $k9b207=g0d6b(); if(count($k9b207)) { ++ $d865c0; if(Log::$ped2b5)__log('Indexer: portion '. $d865c0); echo 'Portion '. $d865c0 .'<br />'; foreach ($k9b207 as $qea59a){ if(Log::$ped2b5)__log('Indexer: indexing "'. $qea59a['Title'].'"'); echo 'Indexing: '. $qea59a['Title'] .'<br />'; if (kd2e1($qea59a)) { $qea59a['IsIndexed']='1'; kaa79('Notes',$qea59a); } if($_config['broadcast_on_indexing']) { meb3b($qea59a); } } $t680a2=round(j7f78()-$qce2fc,3); if(Log::$ped2b5)__log('Indexer: step done '. count($k9b207) .', spent '. $t680a2 .' ms so far'); echo 'Step done '. count($k9b207) .', spent '. $t680a2 .' ms so far<br /><br />'; if(Log::$ped2b5)__log($b78e62); } else { $s30d94=true; break; } } if ($s30d94){ if(Log::$ped2b5)__log('Indexer: indexing complete'); echo 'Indexing complete<br /><br />'; @unlink(USER_FOLDER.'indexing.psa'); } else { echo 'Time out<br />'; unset ($pe1fab['lock']); $pe1fab['done']=count($k9b207); if ($pe1fab['spent']!='?')$pe1fab['spent']+=$t680a2; @n6e52(USER_FOLDER.'indexing.psa',serialize($pe1fab)); } } catch (AeMySQLException $e){ e12f6($e,'Could not index notes'); if(Log::$ped2b5)__log('Indexer: DB unaccessible'); echo 'DB unaccessible<br />'; } } else { if(Log::$ped2b5)__log('Indexer: locked'); echo 'Locked<br />'; } die ('</pre>'); } function e2s_bsi_drop(){ global$_db,$_config; try { echo '<pre>'; za521(); echo 'All notes marked for reindexing<br />'; $jddece=l476c(); try { $jddece -> erase(); echo 'Indexes dropped<br />'; } catch (\S2\Rose\Exception\RuntimeException $e){ e12f6($e,'Rose threw RuntimeException'); } u198f(); die ('</pre>'); } catch (AeMySQLException $e){ e12f6($e,'Could not make all notes for reindexing'); die ('<pre>DB unaccessible</pre>'); } } function u198f(){ $pe1fab=array(); @n6e52(USER_FOLDER.'indexing.psa',serialize($pe1fab)); } function k3b97(){ return (is_file(USER_FOLDER.'indexing.psa')); } function kd2e1($d39a37){ if(Log::$ped2b5)__log('Indexer: index noterec'); static $bf4540=null; try { if ($bf4540===null){ $ffce9c=new PorterStemmerRussian(new PorterStemmerEnglish()); $bf4540=new Indexer(l476c(),$ffce9c); } $z2bfe4=b154e($d39a37['FormatterID'], @$d39a37['Text'],'full-rss'); wfc4d($d39a37,$z2bfe4); $l1cb25=strip_tags($z2bfe4['text-final']); $o3e961=new Indexable( 'n'. $d39a37['ID'], $d39a37['Title'], $l1cb25 ); $bf4540 -> index($o3e961); return true; } catch (\Exception $e){ return false; } } function w10fe($sb80bb){ static $bf4540=null; try { if ($bf4540===null){ $ffce9c=new PorterStemmerRussian(new PorterStemmerEnglish()); $bf4540=new Indexer(l476c(),$ffce9c); } return $bf4540 -> removeById('n'. $sb80bb); } catch (\Exception $e){ return false; } } function w713e($ua2f2e){ $f851f5='S2\\Rose\\'; $r32fcc=__DIR__.'/library/rose/'; $mf5a8e=strlen($f851f5); if(strncmp($f851f5,$ua2f2e,$mf5a8e)!==0) return; $pe1cb9=substr($ua2f2e,$mf5a8e); $b8c7dd=$r32fcc.str_replace('\\','/',$pe1cb9).'.php'; if(file_exists($b8c7dd)) require $b8c7dd; } function id372(){ return array ( 'TOC' => 'Contents', 'WORD' => 'Word', 'FULLTEXT_INDEX' => 'Fulltext', 'KEYWORD_INDEX' => 'Keyword', 'KEYWORD_MULTIPLE_INDEX' => 'KeywordMultiple', ); } function l476c(){ global$_config,$settings; static $p88131=null; if ($p88131===null and SEARCH_USE_ROSE){ $pcf66e=new \PDO( 'mysql:'. 'host='. $settings['db']['server'] .';'. 'dbname='. $settings['db']['name'], $settings['db']['user_name'], see85($settings['db']['passw']) ); $t2af72=$pcf66e -> getAttribute(\PDO::ATTR_SERVER_VERSION); $s84bea=version_compare($t2af72,'5.5.3','>=')?'utf8mb4':'utf8'; $pcf66e -> exec('SET NAMES '.$s84bea); $pcf66e -> setAttribute(\PDO::ATTR_ERRMODE, \PDO::ERRMODE_EXCEPTION); $j44b61=id372(); $p88131=new PdoStorage( $pcf66e, $_config['db_table_prefix'].SEARCH_EXTRA_PREFIX, array ( PdoStorage::TOC => $j44b61['TOC'], PdoStorage::WORD => $j44b61['WORD'], PdoStorage::FULLTEXT_INDEX => $j44b61['FULLTEXT_INDEX'], PdoStorage::KEYWORD_INDEX => $j44b61['KEYWORD_INDEX'], PdoStorage::KEYWORD_MULTIPLE_INDEX => $j44b61['KEYWORD_MULTIPLE_INDEX'], ) ); } return $p88131; } function m4c2d($l1cb25,$o4dd42){ foreach ($o4dd42 as $x2510c){ if ($x2510c=='-') continue; $x2510c=preg_quote($x2510c,'/'); $x2510c=str_replace('е','[её]',$x2510c); $x2510c=str_replace('Е','[ЕЁ]',$x2510c); $l1cb25=preg_replace('/(?<=^|\W)('.$x2510c.'[\w\p{M}]*)/iu','<mark>$1</mark>',$l1cb25); } $l1cb25=str_replace('</mark> <mark>',' ',$l1cb25); $l1cb25=str_replace('</mark> <mark>',' ',$l1cb25); return $l1cb25; } function a48d8($t341be){ $ze05fe=mb_strtoupper(mb_substr($t341be,0,1)); return $ze05fe.mb_substr($t341be,1); } function za521(){ global$_config; p0738( "UPDATE `". $_config['db_table_prefix']."Notes` ". "SET `IsIndexed`=0 ". "WHERE `SubsetID`=". $_config['db_table_subset'], 'mark all notes for reindexing' ); } function e2_check_timeout(){ static $q90272; if(is_null($q90272)) { $bf48ef=ini_get('max_execution_time'); if ($bf48ef){ $q90272=time()+$bf48ef-5; } else { $q90272=0; } } return ($q90272==0)?true:$q90272 >= time(); } function e2_write_dump_header($b8c7dd){ $o099fb=( 'SET SQL_MODE="NO_AUTO_VALUE_ON_ZERO";' .PHP_EOL. 'SET AUTOCOMMIT=0;' .PHP_EOL. 'START TRANSACTION;' .PHP_EOL. "/*!40101 SET @OLD_CHARACTER_SET_CLIENT=@@CHARACTER_SET_CLIENT */;" .PHP_EOL. "/*!40101 SET @OLD_CHARACTER_SET_RESULTS=@@CHARACTER_SET_RESULTS */;" .PHP_EOL. "/*!40101 SET @OLD_COLLATION_CONNECTION=@@COLLATION_CONNECTION */;" .PHP_EOL. "/*!40014 SET @OLD_UNIQUE_CHECKS=@@UNIQUE_CHECKS, UNIQUE_CHECKS=0 */;" .PHP_EOL. "/*!40014 SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0 */;" .PHP_EOL. "/*!40101 SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE=NO_AUTO_VALUE_ON_ZERO */;" .PHP_EOL. "/*!40101 SET NAMES utf8 */;" .PHP_EOL. "/*!50503 SET NAMES utf8mb4 */;" .PHP_EOL. '' ); fwrite($b8c7dd,$o099fb); return true; } function e2_write_dump_footer($b8c7dd){ $k251d1='COMMIT;' .PHP_EOL; $k251d1 .= "/*!40101 SET SQL_MODE=@OLD_SQL_MODE */;" .PHP_EOL ."/*!40014 SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS */;" .PHP_EOL ."/*!40014 SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS */;" .PHP_EOL ."/*!40101 SET CHARACTER_SET_RESULTS=@OLD_CHARACTER_SET_RESULTS */;".PHP_EOL ."/*!40101 SET COLLATION_CONNECTION=@OLD_COLLATION_CONNECTION */;" .PHP_EOL ."/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;" .PHP_EOL; fwrite($b8c7dd,$k251d1); return true; } function e2_get_table_definition($h0c1d0,$paab9e){ $w5c286=null; $result=mysqli_query($h0c1d0,"SHOW CREATE TABLE `{$paab9e}`"); if($result){ $e47c80=mysqli_fetch_array($result); $w5c286=$e47c80['Create Table']; } return $w5c286; } function e2_write_table_definition($b8c7dd,$h0c1d0,$paab9e){ $d30618=e2_get_table_definition($h0c1d0,$paab9e); if(e2_check_timeout() && $d30618){ fwrite($b8c7dd,$d30618); fwrite($b8c7dd,';'); fwrite($b8c7dd,PHP_EOL.PHP_EOL); return true; } return false; } function e2_get_table_data($h0c1d0,$paab9e,$m7a86c,$waa9f7){ $w1b1cc="SELECT * FROM `{$paab9e}` LIMIT {$m7a86c}, {$waa9f7}"; $result=mysqli_query($h0c1d0,$w1b1cc); if (!$result){ return false; } $f66e9c=''; $p3c41a="INSERT INTO `{$paab9e}` VALUES"; while ($nf1965=mysqli_fetch_assoc($result)) { $n691d5=array(); foreach($nf1965 as $o2063c){ $n691d5[] = is_null($o2063c)?"NULL":"'".mysqli_real_escape_string($h0c1d0,$o2063c)."'"; } $f66e9c.=$p3c41a.'('.join(', ',$n691d5).');'.PHP_EOL; } return $f66e9c; } function e2_table_disable_keys($paab9e){ return "ALTER TABLE `{$paab9e}` DISABLE KEYS;".PHP_EOL; } function e2_table_enable_keys($paab9e){ return "ALTER TABLE `{$paab9e}` ENABLE KEYS;".PHP_EOL; } function e2_get_total_records($h0c1d0,$paab9e){ $o8ce4b=mysqli_fetch_row(mysqli_query($h0c1d0,"SELECT COUNT(*) FROM `{$paab9e}`")); return $o8ce4b[0]; } function e2_write_table_data($b8c7dd,$h0c1d0,$paab9e){ $cfbb44=e2_get_total_records($h0c1d0,$paab9e); $m7a86c=0; $waa9f7=1000; $result=true; $g47495=20000; $h80fc1=30; if ($cfbb44){ $afbda5=e2_table_disable_keys($paab9e); fwrite($b8c7dd,$afbda5); } $f66e9c="INSERT INTO `{$paab9e}` VALUES"; $nde57a=$cfbb44; while ($nde57a > 0){ $w1b1cc="SELECT * FROM `{$paab9e}` LIMIT {$m7a86c}, {$waa9f7}"; $result=mysqli_query($h0c1d0,$w1b1cc); $ib428d=mysqli_num_rows($result); if (!$result || !e2_check_timeout()) { $result=false; break; } $wdf347=array(); $g4b3a6=0; $db6539=0; while ($nf1965=mysqli_fetch_assoc($result)) { if (!e2_check_timeout()) { $result=false; break; } $ib428d--; $x54ca8=array(); foreach($nf1965 as $o2063c){ $x54ca8[] = is_null($o2063c)?"NULL":"'".mysqli_real_escape_string($h0c1d0,$o2063c)."'"; } $i8d777='('.join(', ',$x54ca8).')'; $g4b3a6+=strlen($i8d777); $wdf347[] = $i8d777; $db6539++; if ( ($g4b3a6 >= $g47495) || ($db6539 >= $h80fc1) || ($ib428d==0)) { $w1b1cc=$f66e9c.join(', ',$wdf347).';'; fwrite($b8c7dd,$w1b1cc); fwrite($b8c7dd,PHP_EOL); $g4b3a6=0; $db6539=0; $wdf347=array(); } } $m7a86c+=$waa9f7; $nde57a -= $waa9f7; } if ($cfbb44){ $y6bfc4=e2_table_enable_keys($paab9e); fwrite($b8c7dd,$y6bfc4); } return$result; } function e2_backup($h0c1d0,$r9ab2e,$aa9745,$h93da6=array()) { $v2beda=tmpfile(); e2_write_dump_header($v2beda); if(Log::$ped2b5)__log('Backup: wrote header'); $h75101=true; foreach($r9ab2e as $paab9e){ if(Log::$ped2b5)__log('Backup: table '. $paab9e); $m91e7e=e2_write_table_definition($v2beda,$h0c1d0,$paab9e); if(Log::$ped2b5)__log('Backup: wrote table definition with result '. (int)$m91e7e); $v35285=e2_write_table_data($v2beda,$h0c1d0,$paab9e); if(Log::$ped2b5)__log('Backup: wrote table data with result '. (int)$v35285); $h75101=$m91e7e && $v35285; if ($h75101===false){ break; } } if(Log::$ped2b5)__log('Backup: wrote data with running == '. (int)$h75101); if ($h75101){ e2_write_dump_footer($v2beda); fseek($v2beda,0); $b8c7dd=fopen($aa9745,'w+'); while ($h75101 && ($i8d777=fread($v2beda,1024))) { if(e2_check_timeout()) { fwrite($b8c7dd,$i8d777); } else { $h75101=false; } } fclose($b8c7dd); } fclose($v2beda); return $h75101; } function k3e5c($c0c426,$content){ $r52766=MTMPL_FOLDER.$c0c426 .'.mtmpl.php'; if(is_file($r52766)) { ob_start(); include $r52766; $ide7a3=ob_get_contents(); ob_end_clean(); return trim($ide7a3); } } function caed2(){ global$_config,$_superconfig; $k9e35a=$_config['mail_from']; if (@$_superconfig['mail_from']) { $k9e35a=$_superconfig['mail_from']; } if ($k9e35a[strlen($k9e35a)-1]=='@'){ $k9e35a.=$_SERVER['HTTP_HOST']; } return $k9e35a; } function ja41b($d01b6e,$subject,$z78e73,$r145a2=''){ global$_superconfig; if (@$_superconfig['mail_debug']) { $g85114='mail-debug'; $a8fa14=basename(tempnam($g85114,'m-')); $l1cb25=( 'To:       '.$d01b6e ."\n". 'Subject:  '.$subject ."\n". $r145a2 ."\n". "--------------------------------------------------\n". $z78e73 ); n6e52($g85114 .'/'. $a8fa14,$l1cb25); chmod($g85114 .'/'. $a8fa14,E2_NEW_FILES_RIGHTS); rename($g85114 .'/'. $a8fa14,$g85114 .'/'. $a8fa14.'.txt'); } $subject='=?UTF-8?B?'. base64_encode($subject) .'?='; $r145a2.="\r\nContent-Type: text/plain; charset=utf-8"; mail($d01b6e,$subject,$z78e73,trim($r145a2)); } function _A($l1cb25){ global$_candy,$_protocol,$o57de2,$ja57c1,$_current_url; if ( preg_match('/\<a href\=\"(.*?)\"[^>]*\>(.*?)\<\/a\>/si',$l1cb25,$z9c28d) and ( $z9c28d[1]==='' or $z9c28d[1]===$_current_url or $_protocol .'://'. $o57de2.$z9c28d[1]===$_current_url or $_protocol .'://'. $o57de2.$ja57c1 .'/'. $z9c28d[1]===$_current_url or $_candy=='e2m_install' ) ) { return $z9c28d[2]; } else { return $l1cb25; } } function _AT($ze8fab){ global$_candy,$o57de2,$ja57c1,$_current_url; return ( $ze8fab==='' or $ze8fab===$_current_url or $_protocol .'://'. $o57de2.$ze8fab===$_current_url or $_protocol .'://'. $o57de2.$ja57c1 .'/'. $ze8fab===$_current_url ); } function _IMGSRC($x435ed){ return o1492($x435ed); } function _SVG($x435ed){ return ef42c($x435ed); } function _COLOR($wf97c5,$ub8a9f,$wcc321,$c4efa2=1){ if(strlen($wf97c5)!=3 and strlen($wf97c5)!=6) return 'f0f'; if(strlen($ub8a9f)!=3 and strlen($ub8a9f)!=6) return 'f0f'; if(strlen($wf97c5)==3)$wf97c5=$wf97c5[0].$wf97c5[0].$wf97c5[1].$wf97c5[1].$wf97c5[2].$wf97c5[2]; if(strlen($ub8a9f)==3)$ub8a9f=$ub8a9f[0].$ub8a9f[0].$ub8a9f[1].$ub8a9f[1].$ub8a9f[2].$ub8a9f[2]; $lf09cc=array ( $wf97c5[0].$wf97c5[1],$wf97c5[2].$wf97c5[3],$wf97c5[4].$wf97c5[5], $ub8a9f[0].$ub8a9f[1],$ub8a9f[2].$ub8a9f[3],$ub8a9f[4].$ub8a9f[5], ); foreach ($lf09cc as $o8ce4b => $l9e366){ $lf09cc[$o8ce4b]=hexdec($l9e366); } $d22af6=array ( $lf09cc[0]+pow($wcc321,$c4efa2) * ($lf09cc[3]-$lf09cc[0]), $lf09cc[1]+pow($wcc321,$c4efa2) * ($lf09cc[4]-$lf09cc[1]), $lf09cc[2]+pow($wcc321,$c4efa2) * ($lf09cc[5]-$lf09cc[2]), ); $q70dda=''; foreach ($d22af6 as $o8ce4b => $l9e366){ $q70dda.=str_pad(dechex($l9e366),2,'0',STR_PAD_LEFT); } return $q70dda; } function _DT($z1ddcb,$mb35c6){ if (!$mb35c6) return ''; list ($w96b8c,$xb2c6c)=$mb35c6; $z2cb9d=$z1ddcb; $s7436f=e5a2f('m',$w96b8c,$xb2c6c); $z2cb9d=str_replace('{zone}',e2__escape_all(e9515($xb2c6c['offset'])), $z2cb9d); $z2cb9d=str_replace('{month}',e2__escape_all(e2l_get_string('um--month', array ('month' => $s7436f))), $z2cb9d); $z2cb9d=str_replace('{month-short}',e2__escape_all(e2l_get_string('um--month-short', array ('month' => $s7436f))), $z2cb9d); $z2cb9d=str_replace('{month-g}',e2__escape_all(e2l_get_string('um--month-g', array ('month' => $s7436f))), $z2cb9d); $z2cb9d=e5a2f($z2cb9d,$w96b8c,$xb2c6c); return $z2cb9d; } function _AGO($mb35c6){ return o9093($mb35c6[0], array ('offset' => $mb35c6[1]['offset'],'is_dst' => $mb35c6[1]['is_dst']) ); } function _NUM($l1cb25){ return e2_decline_for_number($l1cb25); } function _FIRST($l437b9){ return ($l437b9['_']['_ord']==0); } function _LAST($l437b9){ return ($l437b9['_']['_ord']==$l437b9['_']['_ord_max']); } function _CSS($ic7a62){ return kd4c1($ic7a62); } function _CSS_HREF($ic7a62){ return k576f($ic7a62); } function _JS($k32981){ return ed00a($k32981); } function _LIB($se8acc){ return d16f0($se8acc); } function _T($v52678){ return k166b($v52678); } function _T_DEFER($sb0689){ return zab71($sb0689); } function _X($v52678){ return t6a97($v52678); } function _T_FOR($v52678,$ud5566=null){ global$content; if ($ud5566===null)$ud5566=$v52678; if(array_key_exists($ud5566,$content)) { k166b($v52678); } } function _GUIDES($heca07=false){ global$_olba_guides; if(is_array($heca07))$_olba_guides=$heca07; if (!is_array($_olba_guides)) return; $k88408='<div style="position: fixed; width: 100%; height: 100%; z-index: -100">'; $l1d623=0; $j07d43=$_olba_guides; $j07d43[] = 100; foreach ($j07d43 as $d865c0 => $ud89e2){ if ($ud89e2==100) break; $l1d623+=$ud89e2; $k88408.='<div style="position: fixed; left: '. $ud89e2 .'%; width: 0; height: 100%; border-left: 1px #000 dotted; opacity: .2; -webkit-opacity: .2; -moz-opacity: .2"></div>'; $da1b01='position: absolute; padding: 2px 3px; top: 0; font-size: 9px; background: #ccc; color: #000; font-family: "Verdana", sans-serif; opacity: .8; -webkit-opacity: .8; -moz-opacity: .8'; if ($j07d43[$d865c0+1]-$j07d43[$d865c0] < 4){ $k88408.='<div style="'. $da1b01.'; right: '. (100-$ud89e2) .'%; border-bottom-left-radius: .5em; -webkit-border-bottom-left-radius: .5em; -moz-border-bottom-left-radius: .5em;">'. $ud89e2 .'%</div>'; } else { $k88408.='<div style="'. $da1b01.'; left: '. $ud89e2 .'%; border-bottom-right-radius: .5em; -webkit-border-bottom-right-radius: .5em; -moz-border-bottom-right-radius: .5em;">'. $ud89e2 .'%</div>'; } } $k88408.='</div>'; $_olba_current_col=0; return $k88408; } function _S($ab45cf){ global$_strings; return$_strings[$ab45cf]; } function _SHORTCUT($sb0689){ return ybb8d($sb0689); } function e2__escape_all($ab45cf){ $z2cb9d=''; for ($d865c0=0; $d865c0 < mb_strlen($ab45cf); ++ $d865c0){ $z2cb9d.='\\'. mb_substr($ab45cf,$d865c0,1); } return $z2cb9d; } abstract class E2GIP { protected $gip_cookie_name='gip'; protected $gip_token_cookie_name='gip_access_token'; protected $gip_token=null; abstract public function get_auth_url(); abstract public static function get_profile_url($sb80bb,$o2a304); abstract public function callback(); const PHP_VERSION_VK_FEATURE=70100; public static function set_session_data($f3c6e0,$o2063c){ if(session_status()==PHP_SESSION_NONE){ session_start(); } $_SESSION[$f3c6e0]=$o2063c; } public static function get_session_data($f3c6e0,$qe2181=false){ if(session_status()==PHP_SESSION_NONE){ session_start(); } if(!isset($_SESSION[$f3c6e0])) { return null; } $o2063c=$_SESSION[$f3c6e0]; if($qe2181){ unset($_SESSION[$f3c6e0]); } return $o2063c; } public static function get_gips_order(){ return [ 'twitter' => 0, 'facebook' => 1, 'vk' => 2 ]; } public function get_config($f3c6e0){ $gcbb14='gips/'. $this->type .'.json'; if(is_file(USER_FOLDER.$gcbb14)) { $b466de=@file_get_contents(USER_FOLDER.$gcbb14); } else { $b466de=@file_get_contents(SYSTEM_FOLDER.$gcbb14); } if ($b466de!==false){ $z2cb9d=json_decode($b466de,true,512,JSON_BIGINT_AS_STRING)[$f3c6e0]; if ($z2cb9d) return $z2cb9d; } return null; } public function get_callback_url(){ return d83c8('e2m_gip_sign_in_callback', array('provider' => $this->type)); } protected function get_proxy_param(){ global$settings; $p75725=DEFAULT_LANGUAGE; if(array_key_exists('language',$settings))$p75725=$settings['language']; return '?language='.$p75725.'&type='.$this->type.'&callback_url='.urlencode($this->get_callback_url()); } public function get_gip_session_data(){ global$_config; $e94a08=$this->gip_token?$this->gip_token:$_COOKIE[v8c3b($this->gip_token_cookie_name)]; p0738( "SELECT * FROM `". $_config['db_table_prefix']."GIPsSessions` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `GIP` = '". $this->type ."' ". "AND `SessionToken` = '".u7928($e94a08)."' ". "ORDER BY `ID` DESC LIMIT 1", 'get GIP session data' ); $result=g0d6b(); return$result?$result[0] : array(); } public function is_logged_in(){ if(empty($_COOKIE[v8c3b($this->gip_cookie_name)]) || !in_array($_COOKIE[v8c3b($this->gip_cookie_name)], e2_list_gips()) || $_COOKIE[v8c3b($this->gip_cookie_name)] != $this->type || empty($_COOKIE[v8c3b($this->gip_token_cookie_name)])) { return false; } $i8d777=$this->get_gip_session_data(); return (bool)$i8d777; } protected function save_session($sb80bb,$sb0689,$accessToken,$yb974d='',$userEmail='',$userLink=''){ $w96b8c=time(); p9943( 'GIPsSessions', array ( 'GIP' => $this->type, 'GIPAuthorID' => $sb80bb, 'AuthorName' => $sb0689, 'AuthorEmail' => $userEmail, 'AuthorProfileLink' => $userLink, 'SessionToken' => $accessToken, 'Stamp' => $w96b8c, ), 'INSERT', 'ON DUPLICATE KEY UPDATE '. '`SessionToken` = "'.u7928($accessToken).'", '. '`AuthorName` = "'.u7928($sb0689).'", '. '`Stamp` = "'.$w96b8c.'"' ); kc64a($this->gip_cookie_name,$this->type); kc64a($this->gip_token_cookie_name,$accessToken); if(isset($userEmail) && !empty($userEmail))kc64a('commenter_email',$userEmail); $this->gip_token=$accessToken; } public static function get_logout_key(){ if ($g4a73c=self::get_session_data('logout_key')) { return $g4a73c; } $g4a73c=md5(microtime()); self::set_session_data('logout_key',$g4a73c); return $g4a73c; } public static function is_valid_logout_key($f3c6e0){ $yeb1de=self::get_session_data('logout_key',true); if (empty($yeb1de) || empty($f3c6e0) || $yeb1de!=$f3c6e0){ return false; } return true; } public function logout(){ global$_config; kc64a($this->gip_cookie_name); kc64a($this->gip_token_cookie_name); p0738( "DELETE FROM `". $_config['db_table_prefix']."GIPsSessions` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `GIP` = '".$this->type."' ". "AND `SessionToken` = '" . u7928($_COOKIE[v8c3b($this->gip_token_cookie_name)]) . "'", 'logout' ); } public function get_avatar_width(){ return USERPIC_WIDTH; } public function get_avatar_height(){ return USERPIC_HEIGHT; } public function save_avatar($sb80bb,$u3d02b){ global$_config; @caf42(MEDIA_ROOT_FOLDER.AVATARS_FOLDER); @chmod(MEDIA_ROOT_FOLDER.AVATARS_FOLDER,$_config['uploaded_files_mode']); $x435ed=MEDIA_ROOT_FOLDER.AVATARS_FOLDER.$this->type .'-'. $sb80bb .'.jpg'; if ($a5b860=file_get_contents($u3d02b)) { file_put_contents($x435ed,$a5b860); } return $x435ed; } } function e2m_gip_sign_in($i8d777){ global$_config,$settings; $type=$i8d777['provider']; $t7123a=e2_get_gip_instance($type); if (!$t7123a){ i4930(); die; } header('Location: '.$t7123a->get_auth_url()); die; } function e2m_gip_sign_in_callback($i8d777){ global$_config; $type=$i8d777['provider']; $t7123a=e2_get_gip_instance($type); if (!$t7123a){ die($type.' is not defined'); } $a73797=$t7123a->callback(); echo '<script>'; if ($a73797===true){ $pa64f4=$t7123a->get_gip_session_data(); $z78506=[ 'name' => $pa64f4['AuthorName'], 'gipIcon' => _SVG($type), 'logoutUrl' => d83c8('e2m_gip_sign_out', array('provider' => E2GIP::get_logout_key())), ]; echo 'window.opener.oauthAuthorized('.json_encode($z78506).');'; } else { echo 'alert (\''. $a73797. '\');'; } echo 'window.close();</script>'; die; } function e2m_gip_sign_out($i8d777){ global$_config; $g4a73c=$i8d777['provider']; if (!E2GIP::is_valid_logout_key($g4a73c)) { die('invalid logout key'); } $t7123a=e2_get_logged_gip(); if($t7123a){ $t7123a->logout(); } i4930(); die; } function e2_list_gips(){ static $d2d168=null; if(!is_null($d2d168)) { return $d2d168; } $a1c05f=SYSTEM_FOLDER. 'gips/'; $q700f6=opendir($a1c05f); $d2d168=[]; $f965d3=E2GIP::get_gips_order(); $lf5f73=count($f965d3); while (($b8c7dd=readdir($q700f6)) !== false){ if(pathinfo($b8c7dd,PATHINFO_EXTENSION)!='php') continue; $j77dca=pathinfo($b8c7dd,PATHINFO_FILENAME); if ($j77dca=='vk'){ if(PHP_VERSION_ID < E2GIP::PHP_VERSION_VK_FEATURE) continue; } $f3c6e0=isset($f965d3[$j77dca]) ? $f965d3[$j77dca] : ++$lf5f73; $d2d168[$f3c6e0]=$j77dca; } closedir($q700f6); ksort($d2d168); return $d2d168; } function e2_get_gip_class_name($type){ return "E2GIP".ucfirst($type); } function e2_get_gip_instance($type){ if (!in_array($type,e2_list_gips())) { return false; } $a38c9b=e2_get_gip_class_name($type); $t7123a=new $a38c9b; return $t7123a; } function e2_get_gip_auth_url($type){ return d83c8('e2m_gip_sign_in', array('provider' => $type)); } function e2_is_logged_in($type=''){ $wd14a8=!$type?e2_list_gips() : array($type); foreach($wd14a8 as$type){ $t7123a=e2_get_gip_instance($type); if ($t7123a && $t7123a->is_logged_in()) { return true; } } return false; } function e2_get_logged_gip(){ foreach(e2_list_gips() as$type){ $t7123a=e2_get_gip_instance($type); if ($t7123a && $t7123a->is_logged_in()) { return $t7123a; } } return false; } function e2_get_logged_gip_name(){ foreach(e2_list_gips() as$type){ $t7123a=e2_get_gip_instance($type); if ($t7123a && $t7123a->is_logged_in()) { return$type; } } return false; } function e2_get_user_profile_url($type,$sb80bb,$o2a304){ $a38c9b=e2_get_gip_class_name($type); return $a38c9b::get_profile_url($sb80bb,$o2a304); } function e2_get_gip_session($type){ $t7123a=e2_get_gip_instance($type); if (!$t7123a || !$t7123a->is_logged_in()) { return false; } return $t7123a->get_gip_session_data(); } foreach(e2_list_gips() as $o48e15){ require_once 'system/gips/'.$o48e15.'.php'; } define('__DEV', (@$_config['dev_verbose'] > (int) !de852())); $_stopwatch=j7f78($_stopwatch); spl_autoload_register('w713e'); h372b(); f74e0(); $_strings=sfc91(); if(!BUILT) @include 'builder.php'; function e2(){ global$settings,$content, $_candy, $_lang, $_config, $_strings, $_candies_installer, $_candies_public, $_candies_ajax, $_candies_to_disallow_in_read_only, $_template, $_diagnose; iabdd(); set_error_handler('xe1c4'); set_exception_handler('saefe'); header('X-Powered-By: E2 Aegea v'. E2_VERSION); header('Content-type: text/html; charset=UTF-8'); list ($qc48ba,$parameters)=qb7e9(); try { $content=[]; $_candy=$qc48ba; if ( @$_config['dev_slow_ajax'] and ( in_array($qc48ba,$_candies_ajax) ) ) { sleep(1+2 * (rand()/getrandmax())); } if (!in_array($qc48ba,$_candies_installer)) { jd660(); } if (@$_config['read_only'] and in_array($qc48ba,$_candies_to_disallow_in_read_only)) { $qc48ba='e2m_error404'; } $k58387=(bool)de852(); $r0b448=!in_array($qc48ba,$_candies_public); if(Log::$ped2b5)__log('User signed in? '. ($k58387? 'Yes':'No')); $_newsfeeds=[]; r3010('rss',f6f51(),d83c8('e2m_rss')); r3010('json',f6f51(),d83c8('e2m_json')); if(substr($qc48ba,0,4)=='e2m_'){ qdb82(); } if(is_callable($qc48ba)) { if ($r0b448 && !$k58387){ if(substr($qc48ba,0,4)=='e2s_'){ $content=call_user_func('e2s_sign_in_necessary'); } else { $content['title']=$_strings['pt--sign-in']; } } else { if(Log::$ped2b5)__log('Candy call {'); $content=call_user_func($qc48ba,$parameters); if(Log::$ped2b5)__log('}'); } } else { $r0b448=false; $content=e2_error404_mode(); } } catch (AeMySQLException $e){ if(substr($qc48ba,0,4)=='e2s_'){ y4aff($e); } else { e12f6($e); $parameters=array(); $content['unavailable?']=true; } } if (!is_array($content))$content=array(); if (!array_key_exists('class',$content)) { $content['class']=str_replace('_','-',str_replace('e2m_','',$qc48ba)); } if (!array_key_exists('notes',$content))$content['notes'] = array (); if (!array_key_exists('drafts',$content))$content['drafts'] = array (); if (!array_key_exists('comments',$content))$content['comments'] = array (); if (!array_key_exists('notes-list',$content))$content['notes-list'] = array (); if (h2ac5()!==null){ if(Log::$ped2b5)__log('Stuff for installed engine {'); $content['sign-in'] = [ 'done?' => $k58387, 'required?' => $r0b448, 'necessary?' => $r0b448 && !$k58387, 'href' => d83c8('e2m_sign_in'), 'prompt' => $_strings['gs--need-password'], ]; $content['hrefs'] = array ( 'everything' => d83c8('e2m_everything'), ); if (!array_key_exists('popular',$content)) $content['popular']=u7f52(); if (!array_key_exists('tags',$content)) $content['tags']=ge531($parameters); $content['blog']=o3020(); $content['form-search']=l5070($parameters); $content['form-login']=r126f(); $content['engine']=m29a1(); $content['template']['respond-to-dark-mode?'] = ( $_template['supports_dark_mode'] and (bool) @$settings['appearance']['respond_to_dark_mode'] ); $content['template']['use-likely-light?']=$_template['use_likely_light']; if (!array_key_exists('summary',$content)) { $content['summary']=strip_tags($content['blog']['description']); } if (de852()) { $content['admin']=k5e47(); $content['last-modifieds-by-id']='{}'; if (@$_COOKIE[v8c3b('local_copies')]) { $content['last-modifieds-by-id'] = ( na2d8($_COOKIE[v8c3b('local_copies')]) ); } } if(Log::$ped2b5)__log('}'); } $content['title']=strip_tags(z6f10(htmlspecialchars($content['title'],ENT_NOQUOTES,HSC_ENC))); if (@$content['heading']) { $content['heading']=strip_tags(z6f10(htmlspecialchars($content['heading'],ENT_NOQUOTES,HSC_ENC))); } $content['language']=$_lang; if (!@isset ($_diagnose['ok?'])) { if (@$_COOKIE[v8c3b('diagnose')] or @$_diagnose['need?']) { r8739(); } } if ( $settings['appearance']['show_view_counts'] and is_array($content['notes']) and count($content['notes']) > 0 ){ $content['notes']=e2_populate_read_counts_in_notes_ctree_($content['notes']); } foreach($content['notes'] as $taad65){ p57ad($taad65['format-info']['links-required']); } $content['message']=z0955(); $b78e62=sbc21(); $content['meta']=sc4da( $qc48ba, $content['notes'], $content['tag'], $content['blog'], $content['pages'] ); $content['stat']=u6442(); $b78e62=b326f($b78e62); $wfa6a9=false; if (h2ac5()!==null and k3b97()) { if(is_writable(USER_FOLDER.'indexing.psa')) { $wfa6a9=true; } else { $_diagnose['need?']=true; kc64a('diagnose','1'); } } echo $b78e62; if (h2ac5()!==null and $wfa6a9){ if(Log::$ped2b5)__log('Spawn BSI step'); ecc38(d83c8('e2s_bsi_step', array ())); } if (@$_config['dev_dump_ctree'])nce80($content); } ?>