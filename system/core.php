<?php $_stopwatch = microtime (); define ('E2_VERSION',4079); define ('E2_RELEASE','11.0'); define ('CACHE',1); define ('BUILDER_OBFUSCATE',1); define ('BUILDER_FLATTEN',1); define ('BUILT', !strstr (__FILE__,'all.php')); define ('E2_RUN_ID',chr (rand (65,90))); function e2m_error404 () { global$_config,$_strings; if($_config['try_redirect_to_all']) { $c = 'all/'. urldecode ($_GET['go']); xq ($c); } header ('HTTP/1.1 404 Not found'); $v['class']='404'; $v['heading']=$_strings['pt--page-not-found']; $v['title']=$_strings['pt--page-not-found']; return $v; } class AeArbitraryNotesCollectionView { private $name = ''; private $isCached = false; private $hasRun = false; private $sql = null; private $currentURL = null; private $cacheFilename = null; private $cacheExpiresFilename = null; private $cacheable = []; private $viewExpiration = null; private $notesCTree = null; private $filterOutIDs = []; public function __construct ($name){ $this->name = $name; } public function setSQLRequest ($sql){ $this->sql = $sql; } public function setCurrentURL ($currentURL){ $this->currentURL = $currentURL; } public function setCacheFilename ($cacheFilename){ $this->isCached = true; $this->cacheFilename = $cacheFilename; } public function setCacheExpiresFilename ($cacheExpiresFilename){ $this->cacheExpiresFilename = $cacheExpiresFilename; } public function setViewExpiration ($viewExpiration){ $this->viewExpiration = $viewExpiration; } public function setFilterOutIDs ($filterOutIDs){ $this->filterOutIDs = $filterOutIDs; } public function orderNotesCTreeByVerticality () { if (!$this->hasRun)$this -> run (); usort ($this->notesCTree, function ($b,$y){ if (empty ($b['images'][0]['verticality']))$n = 0; else $n = $b['images'][0]['verticality']; if (empty ($y['images'][0]['verticality']))$m = 0; else $m = $y['images'][0]['verticality']; return (int)round (($m - $n)*10000); }); } public function getNotesCTree () { if (!$this->hasRun)$this -> run (); return$this->notesCTree; } private function prepareCacheableData () { $f = [ 'notes-records' => function () { $d = []; try { fm ($this->sql,'get "'. $this->name .'" list'); foreach (sm () as $s){ if (nf ($s)==='public'){ $d[] = $s; } } } catch (AeMySQLException $e){ v3 ($e); if(Log::$a)__log ('Could not get list from database'); } return $d; }, ]; if($this->isCached and is_file ($this->cacheFilename)) { $this->cacheable = @unserialize (file_get_contents ($this->cacheFilename)) or $this->cacheable = []; } $q = true; if (!empty ($this->cacheExpiresFilename)) { if($this->isCached and is_file ($this->cacheExpiresFilename)) { $l = time (); $z = (int) @file_get_contents ($this->cacheExpiresFilename); if(Log::$a)__log ('List expires '. date ('r',$z) .', now '. date ('r',$l)); $q = ($l < $z); } } $k = false; foreach ($f as $x => $e_){ if (!array_key_exists ($x,$this->cacheable) or !$q){ if(Log::$a)__log ('Build cache: "'. $x .'"'); $this->cacheable[$x]=$e_ (); $k = true; } else { if(Log::$a)__log ('Retrieved from cache: "'. $x .'"'); } } if($this->isCached and $k){ e3 ($this->cacheFilename,serialize ($this->cacheable)); if($this->cacheExpiresFilename){ @e3 ($this->cacheExpiresFilename,time () + $this->viewExpiration); } } } private function run () { $this->hasRun = true; if(Log::$a)__log ('AeArbitraryNotesCollectionView "'. $this->name .'" run {'); if(Log::$a)__log ('Cacheable data {'); $this -> prepareCacheableData (); if(Log::$a)__log ('}'); if(Log::$a)__log ('Uncacheable data {'); $this->notesCTree = []; foreach($this->cacheable['notes-records'] as $s){ if(in_array ($s['ID'],$this->filterOutIDs)) continue; $noteView = new AeNoteView ($s); $r = $noteView -> getNoteCTree (); $r['current?'] = ($r['href']==$this->currentURL); $this->notesCTree[] = $r; AeNoteReadCountsProvider :: requestDeferredReadCountForNoteID ($s['ID']); } if(Log::$a)__log ('}'); if(Log::$a)__log ('}'); } } class AeDatabaseConfiguration { public $server; public $host; public $port = null; public $user; public $password; public $name; public $source; public $backup_dir; private $prefix = null; private $subset = null; public function __construct ( string $source, string $backup_dir, string $server, string $user, string $password, string $name, string $prefix = null, string $subset = null ) { $this->source = $source; $this->backup_dir = $backup_dir; $this->server = $server; list ($this->host,$this->port)=em ($this->server); if ((string)$this->port === '') { $this->port = null; } $this->user = $user; $this->password = $password; $this->name = $name; $this->prefix = $prefix; $this->subset = $subset; } public function hasPrefixSpecified () { return$this->prefix !== null; } public function getPrefix () { if($this->prefix === null){ throw new LogicException ('Assertion failed: database configuration has no prefix'); } return$this->prefix; } public function setPrefix ($prefix){ $this->prefix = $prefix; } public function hasSubsetSpecified () { return$this->subset !== null; } public function setSubset ($subset){ $this->subset = $subset; } public function getSubset () { if($this->subset === null){ throw new LogicException ('Assertion failed: database configuration has no subset'); } return$this->subset; } public function getDatabaseParamsArray () { return [ 'server' => $this->server, 'user_name' => $this->user, 'passw' => $this->password, 'name' => $this->name, ]; } public function getServerKeyString () { return$this->user .'@'. $this->server; } public function getDatabaseKeyString () { return$this -> getServerKeyString () .'/'. $this->name; } public function getTablesKeyString () { return$this -> getDatabaseKeyString () .'/'. $this -> getPrefix () .'...'; } public function __toString () { return$this -> getTablesKeyString () .'?'. $this -> getSubset (); } } class AeEnv { private static $t = false; public static $j = ''; public static $h = 'http'; public static $g = ''; public static $server = ''; public static $w = ''; public static $u = ''; public static $i = 'http'; public static $base_url = ''; public static $o = ''; private static function updateBaseURL () { if (!self::$t) throw new LogicException ('AeEnv not initialized'); self::$base_url = self::$i. '://'. self::$server . self::$w . '/'; self::$o = self::$base_url; if(self::$u !== (string)''){ self::$o .= self::$u .'/'; } } public static function examine ($p){ list (self::$server, ) = explode (':',$p['HTTP_HOST']); self::$w = substr ( $p['PHP_SELF'], 0,strpos ($p['PHP_SELF'],'/index.php') ); self::$i = ( !empty ($p['HTTPS']) && $p['HTTPS']!=='off' or $p['SERVER_PORT']==443 or isset ($p['HTTP_X_FORWARDED_PROTO']) && $p['HTTP_X_FORWARDED_PROTO']=='https' or isset ($p['HTTP_X_HTTPS']) && ($p['HTTP_X_HTTPS']) ) ? 'https' : 'http'; if(getenv ('E2_USER_SUBPATH')) { self::$u = getenv ('E2_USER_SUBPATH'); } elseif(getenv ('REDIRECT_E2_USER_SUBPATH')) { self::$u = getenv ('REDIRECT_E2_USER_SUBPATH'); } self::$t = true; self::updateBaseURL (); self::$j = self::$server; self::$h = self::$i; self::$g = self::$base_url; } public static function setPrefersHTTPS ($cv){ if (!self::$t) throw new LogicException ('AeEnv not initialized'); if ((bool)$cv){ self::$i = 'https'; self::updateBaseURL (); } } public static function setPreferredServer ($vv){ if (!self::$t) throw new LogicException ('AeEnv not initialized'); if ($vv !== null and $_SERVER['HTTP_HOST']!==$vv){ self::$server = $vv; self::updateBaseURL (); } } public static function showDie () { if (!self::$t) throw new LogicException ('AeEnv not initialized'); echo '<pre>'; echo '<b>server</b>: "'. self::$server. '"<br />'; echo '<b>server_used</b>: "'. self::$j. '"<br />'; echo '<b>folder</b>: "'. self::$w. '"<br />'; echo '<b>user_subpath</b>: "'. self::$u. '"<br />'; echo '<b>protocol_used</b>: "'. self::$h. '"<br />'; echo '<b>protocol</b>: "'. self::$i. '"<br />'; echo '<b>base_url_used</b>: "'. self::$g. '"<br />'; echo '<b>base_url</b>: "'. self::$base_url. '"<br />'; echo '</pre>'; die; } } class AeFileManager { private static $bv = null; private static $yv = null; private static $nv = null; private static $mv = [ '.', ]; private static $fv = [ '', LOGS_DIRNAME, BACKUP_DIRNAME, ]; private static $dv = [ '', CACHES_DIRNAME, BACKUP_DIRNAME, ]; private static $sv = [ PICTURES_DIRNAME, THUMBNAILS_DIRNAME, PICTURES_DIRNAME .'remote/', THUMBNAILS_DIRNAME .'remote/', VIDEO_DIRNAME, AUDIO_DIRNAME, AVATARS_DIRNAME, USERPIC_DIRNAME, ]; private static $av = [ 'updating.psa', ]; private static $qv = [ 'password-hash.psa', 'password-wait.psa', 'last-comment.psa', 'new-uploads.psa', 'settings.json', 'bsi.psa', 'auth.psa', 'scheduled.psa', 'license.psa', 'checklist.psa', ]; private static function ready () { return self::$bv !== null and self::$yv !== null and self::$nv !== null; } public static function writtenDirectories ($yv = null,$nv = null){ if (!self::ready ()) return []; if ($yv === null)$yv = self::$yv; if ($nv === null)$nv = self::$nv; $lv = self::$mv; foreach(self::$fv as $zv){ $lv[] = self::$bv . $zv; } foreach(self::$dv as $zv){ $lv[] = $yv . $zv; } foreach(self::$sv as $zv){ $lv[] = $nv . $zv; } $lv = array_unique ($lv); return $lv; } public static function writtenFiles ($yv = null,$nv = null){ if (!self::ready ()) return []; if ($yv === null)$yv = self::$yv; if ($nv === null)$nv = self::$nv; $kv = []; foreach(self::$av as $xv){ $kv[] = self::$bv . $xv; } foreach(self::$qv as $xv){ $kv[] = $yv . $xv; } $kv = array_unique ($kv); return $kv; } public static function setInstancePath ($bv){ self::$bv = $bv; } public static function setUserPath ($yv){ self::$yv = $yv; } public static function setMediaPath ($nv){ self::$nv = $nv; } public static function forceAllDirectories () { if (!self::ready ()) return false; foreach(self::writtenDirectories () as $ev){ @bq ($ev); } } public static function forceInstanceDirectories () { if (!self::ready ()) return false; foreach(self::$fv as $zv){ @bq (self::$bv . $zv); } } public static function forceUserDirectories ($yv = null){ if (!self::ready ()) return false; if ($yv === null)$yv = self::$yv; foreach(self::$dv as $zv){ @bq ($yv . $zv); } } public static function forceMediaDirectories ($nv = null){ if (!self::ready ()) return false; if ($nv === null)$nv = self::$nv; foreach(self::$sv as $zv){ @bq ($nv . $zv); } } public static function getPathsWithNoWritePermissions ($yv = null,$nv = null){ if (!self::ready ()) return []; if ($yv === null)$yv = self::$yv; if ($nv === null)$nv = self::$nv; clearstatcache (); $rv = []; foreach(self::writtenDirectories ($yv,$nv) as $tv){ if(is_dir ($tv) and !is_writable ($tv)) { $rv[] = $tv; } } foreach(self::writtenFiles ($yv,$nv) as $tv){ if(is_file ($tv) and !is_writable ($tv)) { $rv[] = $tv; } } return $rv; } } class AeLayoutDiversityManager { private static $layoutsUseIndexes = []; private static $layoutsUseIndex = 1; private static $layoutsUseMaxIndex = 1; public static function addLayoutsUsed ($jv){ self::$layoutsUseIndexes[$jv]=self::$layoutsUseIndex; self::$layoutsUseIndex ++; self::$layoutsUseMaxIndex ++; } public static function hasLayoutBeenUsed ($jv){ if (isset (self::$layoutsUseIndexes[$jv])) return true; } public static function getLayoutsUseRecency ($jv){ if (isset (self::$layoutsUseIndexes[$jv])) { return self::$layoutsUseIndexes[$jv]-self::$layoutsUseMaxIndex; } } } class AeMainMenuManager { private static $currentTags = []; private static $parentTags = []; static $isFavouritesCurrent = false; static $isFavouritesParent = false; static $isMostCommentedCurrent = false; static $isMostCommentedParent = false; static $isPopularCurrent = false; static $isPopularParent = false; static $isTagsCurrent = false; static $isTagsParent = false; static $isCalendarCurrent = false; static $isCalendarParent = false; public static function addCurrentTag ($hv){ self::$currentTags[] = $hv; } public static function addParentTag ($hv){ self::$parentTags[] = $hv; } public static function isCurrentTag ($hv){ if (!empty (self::$currentTags)) { return in_array ($hv,self::$currentTags); } return false; } public static function isParentTag ($hv){ if (!empty (self::$parentTags)) { return in_array ($hv,self::$parentTags); } return false; } } class AeModel { private static $gv = [ 'key' => "INT UNSIGNED AUTO_INCREMENT PRIMARY KEY", 'pkey' => "INT UNSIGNED DEFAULT '0' NOT NULL", 'pkey1' => "INT UNSIGNED DEFAULT '1' NOT NULL", 'int' => "INT DEFAULT '0' NOT NULL", 'uint' => "INT UNSIGNED DEFAULT '0' NOT NULL", 'time' => "INT UNSIGNED DEFAULT '0' NOT NULL", '0' => "TINYINT(1) DEFAULT '0' NOT NULL", '1' => "TINYINT(1) DEFAULT '1' NOT NULL", 'v1' => "VARCHAR(1) DEFAULT '' NOT NULL", 'v8' => "VARCHAR(8) DEFAULT '' NOT NULL", 'v15' => "VARCHAR(15) DEFAULT '' NOT NULL", 'v32' => "VARCHAR(32) DEFAULT '' NOT NULL", 'v39' => "VARCHAR(39) DEFAULT '' NOT NULL", 'v64' => "VARCHAR(64) DEFAULT '' NOT NULL", 'fid' => "VARCHAR(32) DEFAULT '". DEFAULT_FORMATTER ."' NOT NULL", 'v255' => "VARCHAR(255) DEFAULT '' NOT NULL", 'text' => "MEDIUMTEXT", ]; private static $wv = [ 'Actions' => [ ['ID', 'key'], ['SubsetID', 'pkey1'], ['EntityID', 'pkey'], ['Stamp', 'time'], ['ReadCount', 'int'], ], 'Aliases' => [ ['ID', 'key'], ['SubsetID', 'pkey1'], ['EntityType', 'v1'], ['EntityID', 'pkey'], ['Alias', 'v64'], ['Stamp', 'time'], ], 'Comments' => [ ['ID', 'key'], ['SubsetID', 'pkey1'], ['NoteID', 'pkey'], ['AuthorName', 'v255'], ['AuthorEmail', 'v255'], ['Text', 'text'], ['Reply', 'text'], ['IsVisible', '1'], ['IsFavourite', '0'], ['IsReplyVisible', '0'], ['IsReplyFavourite', '0'], ['IsAnswerAware', '1'], ['IsSubscriber', '0'], ['IsSpamSuspect', '0'], ['IsNew', '0'], ['Stamp', 'time'], ['LastModified', 'time'], ['ReplyStamp', 'time'], ['ReplyLastModified', 'time'], ['IP', 'v39'], ['IsGIPUsed', '0'], ['GIP', 'v15'], ['GIPAuthorID', 'v64'], ], 'GIPsSessions' => [ ['ID', 'key'], ['SubsetID', 'pkey1'], ['GIP', 'v15'], ['GIPAuthorID', 'v64'], ['AuthorName', 'v255'], ['AuthorEmail', 'v255'], ['AuthorProfileLink', 'v255'], ['SessionToken', 'v255'], ['Stamp', 'time'], ], 'Keywords' => [ ['ID', 'key'], ['SubsetID', 'pkey1'], ['Keyword', 'v255'], ['OriginalAlias', 'v64'], ['PageTitle', 'v255'], ['Description', 'text'], ['Summary', 'text'], ['Uploads', 'text'], ['IsVisible', '1'], ['IsFavourite', '0'], ], 'Notes' => [ ['ID', 'key'], ['SubsetID', 'pkey1'], ['Title', 'v255'], ['Text', 'text'], ['Summary', 'text'], ['FormatterID', 'fid'], ['OriginalAlias', 'v64'], ['Uploads', 'text'], ['IsPublished', '0'], ['IsCommentable', '0'], ['IsVisible', '1'], ['IsFavourite', '0'], ['Stamp', 'time'], ['LastModified', 'time'], ['Offset', 'int'], ['IsDST', '0'], ['IsIndexed', '0'], ['IsExternal', '0'], ['ReadCount', 'uint'], ['SourceID', 'pkey'], ['SourceNoteID', 'pkey'], ['SourceNoteURL', 'v255'], ['SourceNoteJSONURL', 'v255'], ['SourceNoteData', 'text'], ], 'NotesKeywords' => [ ['ID', 'key'], ['SubsetID', 'pkey1'], ['NoteID', 'pkey'], ['KeywordID', 'pkey'], ], 'Sources' => [ ['ID', 'key'], ['SubsetID', 'pkey1'], ['TrueID', 'pkey'], ['Title', 'v255'], ['AuthorName', 'v255'], ['URL', 'v255'], ['PictureURL', 'v255'], ['IsWhiteListed', '0'], ['IsTrusted', '0'], ], ]; private static $uv = [ 'Actions' => [ ['unique', ['EntityID','Stamp']], ['index', ['SubsetID']], ], 'Aliases' => [ ['index', ['SubsetID']], ['index', ['Alias']], ['index', ['EntityID']], ], 'Comments' => [ ['index', ['SubsetID']], ['index', ['NoteID']], ], 'GIPsSessions' => [ ['unique', ['SubsetID','GIP','GIPAuthorID']], ['index', ['SubsetID']], ], 'Keywords' => [ ['index', ['SubsetID']], ], 'Notes' => [ ['fulltext', ['Title','Text']], ['index', ['SubsetID']], ['index', ['Stamp']], ['index', ['SourceID']], ['index', ['SourceNoteID']], ], 'NotesKeywords' => [ ['index', ['SubsetID']], ['index', ['NoteID']], ], 'Sources' => [ ['index', ['SubsetID']], ], ]; private static $iv = [ 'index' => 'INDEX', 'unique' => 'UNIQUE INDEX', 'fulltext' => 'FULLTEXT', ]; private static $ov = [ 'index' => 'KEY', 'unique' => 'UNIQUE KEY', 'fulltext' => 'FULLTEXT KEY', ]; public static function unprefixedCoreTablesNames () { return array_keys (self::$wv); } public static function unprefixedEssentialTablesNames () { return [ 'Comments', 'Keywords', 'Notes', 'NotesKeywords', ]; } public static function assertUnprefixedTableName ($pv){ if (!array_key_exists ($pv,self::$wv)) { throw new LogicException ('Table "'. $pv .'" is not part of the model'); } } public static function columnsByUnprefixedTableName ($pv){ self::assertUnprefixedTableName ($pv); return self::$wv[$pv]; } public static function indexesByUnprefixedTableName ($pv){ self::assertUnprefixedTableName ($pv); return self::$uv[$pv]; } public static function softFieldsByUnprefixedTableName ($pv){ self::assertUnprefixedTableName ($pv); $cb = []; foreach(self::$wv[$pv] as $x){ if (!in_array ($x[1], ['key'])) { $cb[] = $x[0]; } } return $cb; } public static function columnsAndIndexesSQLByUnprefixedTableName ($pv){ self::assertUnprefixedTableName ($pv); $vb = []; foreach(self::columnsByUnprefixedTableName ($pv) as $bb){ list ($name,$yb)=$bb; $vb[] = "`". $name ."` ". self::expandColumnDefinition ($yb); } foreach(self::indexesByUnprefixedTableName ($pv) as $nb){ list ($type,$mb)=$nb; $fb = implode ('',$mb); $db = self::indexCreateSQLByIndexType ($type).' `'. $fb .'` (`'. implode ('`, `',$mb) .'`)'; $vb[] = $db; } return "(". implode (", ",$vb) .")"; } public static function expandColumnDefinition ($sb){ return self::$gv[$sb]; } public static function indexCheckSQLByIndexType ($ab){ return self::$ov[$ab]; } public static function indexCreateSQLByIndexType ($ab){ return self::$iv[$ab]; } } class AeNoteReadCountsProvider { private static $dataByNoteID = []; private static $hasRun = false; private static $sql = null; public static function setSQLRequestTemplateToMapIDsToReadCounts ($sql){ self::$sql = $sql; } public static function requestDeferredReadCountForNoteID ($noteID){ self::$dataByNoteID[$noteID]=true; } public static function getReadCountForNoteID ($noteID){ if(self::$sql === null) return false; if (!self::$hasRun)self :: run (); if (empty (self::$dataByNoteID[$noteID])) return false; return self::$dataByNoteID[$noteID]; } private static function run () { self::$hasRun = true; $qb = []; foreach(self::$dataByNoteID as$note_id => $lb){ $qb[] = "(`ID` = ". $note_id . ")"; } if (!count ($qb)) return; $qb = implode (' OR ',$qb); try { fm ( self::$sql ." AND (". $qb .")", 'get all requested read counts for notes' ); $zb = sm (); foreach ($zb as $kb){ self::$dataByNoteID[$kb['ID']] = $kb['ReadCount']; } } catch (AeMySQLException $e){ v3 ($e); if(Log::$a)__log ('Could not get requested read counts for notes'); } } } class AeNoteView { private $noteRecord = []; private $isCached = false; private $hasRun = false; private $cacheFilename = null; private $noteCTree = null; private $highlightedTags = null; private $cacheable = []; private $OGImages = []; private $wantRichText = false; private $wantCommentsLink = false; private $wantNewCommentsCount = false; private $wantReadHref = false; private $wantPreviewHref = false; private $wantControls = false; private $wantHiddenTags = false; private $wantSharingButtons = false; private $wantRelatedNotes = false; private $filterOutRelatedNoteIDs = []; private $useLocalHref = false; public function __construct ($noteRecord){ $this->noteRecord = $noteRecord; if(CACHE_NOTES){ $this->isCached = true; $this->cacheFilename = e2_note_cache_filename_with_id_($noteRecord['ID']); } } public function setHighlightedTags ($highlightedTags){ $this->highlightedTags = $highlightedTags; } public function setWantRichText ($wantRichText){ $this->wantRichText = $wantRichText; } public function setWantCommentsLink ($wantCommentsLink){ $this->wantCommentsLink = $wantCommentsLink; } public function setWantNewCommentsCount ($wantNewCommentsCount){ $this->wantNewCommentsCount = $wantNewCommentsCount; } public function setWantReadHref ($wantReadHref){ $this->wantReadHref = $wantReadHref; } public function setWantPreviewHref ($wantPreviewHref){ $this->wantPreviewHref = $wantPreviewHref; } public function setWantControls ($wantControls){ $this->wantControls = $wantControls; } public function setWantHiddenTags ($wantHiddenTags){ $this->wantHiddenTags = $wantHiddenTags; } public function setWantSharingButtons ($wantSharingButtons){ $this->wantSharingButtons = $wantSharingButtons; } public function setWantRelatedNotes ($wantRelatedNotes){ $this->wantRelatedNotes = $wantRelatedNotes; } public function setFilterOutRelatedNoteIDs ($filterOutRelatedNoteIDs){ $this->filterOutRelatedNoteIDs = $filterOutRelatedNoteIDs; } public function setUseLocalHref ($useLocalHref){ $this->useLocalHref = $useLocalHref; } public function getNoteCTree () { if (!$this->hasRun)$this -> run (); return$this->noteCTree; } private function prepareCacheableData () { $f = [ 'title' => function () { return dy ( htmlspecialchars ($this->noteRecord['Title'],ENT_NOQUOTES,'UTF-8') ); }, 'text-format-info' => function () { return ay ( $this->noteRecord['FormatterID'], $this->noteRecord['Text'], 'full' ); }, 'summary' => function () { if ((string)$this->noteRecord['Summary']!==''){ return dy (htmlspecialchars ($this->noteRecord['Summary'],ENT_NOQUOTES,'UTF-8')); } else { return yf ($this->cacheable['text-format-info']['text-final']); } }, 'comments-count' => function () { if (!$this->noteRecord['IsPublished']) { return false; } else { return ab ($this->noteRecord['ID']); } }, 'tags-data' => function () { $xb = ca ($this->noteRecord['ID']); $eb['ctree'] = []; $eb['all-resnames-uploads'] = []; foreach ($xb as $rb => $tb){ $eb['ctree'][] = [ 'visible?' => (bool)$tb['IsVisible'], 'name' => htmlspecialchars ($tb['Keyword'],ENT_NOQUOTES,'UTF-8'), 'href' => kq ('e2m_tag', array ('*tag' => $tb)), ]; $eb['all-resnames-uploads']=array_merge ( $eb['all-resnames-uploads'], g3 ('tag',$tb['ID']) ); } $eb['all-resnames-uploads']=array_unique ( $eb['all-resnames-uploads'] ); return $eb; }, ]; if($this->isCached and is_file ($this->cacheFilename)) { $this->cacheable = @unserialize (file_get_contents ($this->cacheFilename)) or $this->cacheable = []; } $k = false; foreach ($f as $x => $e_){ if (!array_key_exists ($x,$this->cacheable)) { if(Log::$a)__log ('Build cache: "'. $x .'"'); $this->cacheable[$x]=$e_ (); $k = true; } else { if(Log::$a)__log ('Retrieved from cache: "'. $x .'"'); } } if($this->isCached and $k){ e3 ($this->cacheFilename,serialize ($this->cacheable)); } } private function run () { $this->hasRun = true; if(Log::$a)__log ('AeNoteView run {'); if(Log::$a)__log ('Cacheable data {'); $this -> prepareCacheableData (); if(Log::$a)__log ('}'); if(Log::$a)__log ('Uncacheable data {'); $jb = false; if($this->noteRecord['IsPublished']) { if ((string)$this->noteRecord['OriginalAlias']!==''){ $jb = kq ('e2m_note', ['alias' => $this->noteRecord['OriginalAlias']]); } else { $hb = $this->noteRecord; $hb['__force_ymdn']=true; $jb = kq ('e2m_note', ['*note' => $hb]); } } $gb = wa ($this->noteRecord); $wb = [(int)$this->noteRecord['LastModified'],$gb]; $l = ( $this->noteRecord['IsPublished'] ? [(int)$this->noteRecord['Stamp'],$gb]:$wb ); $ub = nf ($this->noteRecord); $ib = @$this->cacheable['text-format-info']['meta']['resources-detected']; if (!is_array ($ib))$ib = []; if(count ($ib)) { h2 ($ib); } $ob = q2 ($ib); $pb = @unserialize ($this->noteRecord['Uploads']) or $pb = []; $c3 = array_merge ( l2 ( $ib,$pb ), $this->cacheable['tags-data']['all-resnames-uploads'] ); $v3 = t3 ($c3); $b3 = q2 ($c3); $y3 = $this->noteRecord['SourceNoteData']; $y3 = @json_decode ($y3,true); $n3 = @$y3['og_images'][0] or $n3 = ''; if($this->noteRecord['IsExternal']) { $m3 = cn ($this->noteRecord); } else { $m3 = []; } $f3 = false; $s3 = $this->cacheable['tags-data']['ctree']; foreach ($s3 as $a3 => $q3){ if($this->highlightedTags !== null){ $s3[$a3]['current?']=in_array ($s3[$a3]['name'],$this->highlightedTags); } if (!$this->wantHiddenTags and !$s3[$a3]['visible?']) { unset ($s3[$a3]); } } if($this->wantSharingButtons and $ub === 'public'){ $l3 = us ($v3); } else { $l3 = false; } if($this->wantNewCommentsCount){ $z3 = sb ($this->noteRecord['ID']); } else { $z3 = false; } $this->noteCTree = [ 'id' => (int)$this->noteRecord['ID'], 'title' => (string)$this->cacheable['title'], 'href' => kq ('e2m_note', ['*note' => $this->noteRecord]), 'href-original' => $jb, 'time' => $l, 'last-modified' => $wb, 'text' => (string)$this->cacheable['text-format-info']['text-final'], 'format-info' => $this->cacheable['text-format-info']['meta'], 'summary' => (string)$this->cacheable['summary'], 'snippet-text' => (string)$this->cacheable['summary'], 'draft?' => $ub === 'draft', 'scheduled?' => $ub === 'scheduled', 'public?' => $ub === 'public', 'hidden?' => $ub === 'hidden', 'current?' => false, 'favourite?' => (bool) ($this->noteRecord['IsFavourite'] and $ub !== 'draft'), 'images' => z2 ($ob), 'thumbs' => k2 ($ob), 'source-main-image-url' => (string)$n3, 'og-images' => $v3, 'og-images-thumbs' => k2 ($b3), 'tags' => $s3, 'sharing-buttons' => $l3, 'related' => $f3, 'read-href' => ($this->wantReadHref and $this->noteRecord['IsPublished'])? kq ('e2m_note_read', ['*note' => $this->noteRecord]) : false, 'preview-href' => ($this->wantPreviewHref and ($ub !== 'public'))? kq ('e2m_note', [ '*note' => $this->noteRecord, 'preview-key' => df ($this->noteRecord) ]) : false, 'comments-count' => $this->cacheable['comments-count'], 'comments-count-text' => is_int ($this->cacheable['comments-count'])? e2l_get_string ('gs--n-comments', [ 'number' => $this->cacheable['comments-count'] ]) : '', 'new-comments-count' => $z3, 'new-comments-count-text' => is_int ($z3)? e2l_get_string ('gs--comments-n-new', [ 'number' => $z3 ]) : '', 'comments-link?' => (bool) ( $this->wantCommentsLink and $this->noteRecord['IsPublished'] and ( xb ($this->noteRecord) or ($this->cacheable['comments-count']>0) ) ), ]; if($this->noteRecord['IsExternal']) { $this->noteCTree = array_merge ($this->noteCTree,$m3); $this->noteCTree['href-original']=$this->noteCTree['href-external']; if (!$this->useLocalHref){ $this->noteCTree['href']=$this->noteCTree['href-external']; } } if($this->wantControls){ $this->noteCTree['edit-href']=kq ( 'e2m_note_edit', array ('*note' => $this->noteRecord) ); if($this->noteRecord['IsPublished'] and !$this->noteRecord['IsVisible']) { $this->noteCTree['show-action']=kq ('e2s_note_flag', [ '*note' => $this->noteRecord, 'flag' => 'IsVisible', 'value' => 1 ]); } if($this->noteRecord['IsPublished']) { $this->noteCTree['favourite-toggle-action']=kq ( 'e2s_note_flag_favourite', [ '*note' => $this->noteRecord, 'value' => !$this->noteRecord['IsFavourite'] ] ); } } $this->noteCTree['href-comments']=$this->noteCTree['href'] .'#comments'; if(Log::$a)__log ('}'); AeNoteReadCountsProvider :: requestDeferredReadCountForNoteID ($this->noteRecord['ID']); if(Log::$a)__log ('}'); } } class AePageableNotesView { private $candy; private $parameters; private $pageExists = false; private $isCached = false; private $hasRun = false; private $sql = null; private $sql_count = null; private $highlightedTags = null; private $cacheFilename = null; private $prevPageTitle = null; private $nextPageTitle = null; private $totalNotes = null; private $totalPages = null; private $notesCTree = null; private $pagesCTree = null; private $wantPaging = false; private $wantNewCommentsCount = false; private $wantReadHrefs = false; private $wantPreviewHrefs = false; private $wantControls = false; private $wantHiddenTags = false; private $wantRelatedNotes = false; private $useLocalHrefs = false; private $page = 1; private $limit = 10; public function __construct ($candy,$parameters){ $this->candy = $candy; $this->parameters = $parameters; if (empty ($parameters['page'])) { $this->page = 1; } else { $this->page = (int)$parameters['page']; } } public function setSQLCountRequest ($sql_count){ if(strpos ($sql_count,"SELECT COUNT(*) Total FROM ")!==0){ die ('AePageableNotesView: Count request must start with "SELECT COUNT(*) Total FROM "'); } $this->sql_count = $sql_count; } public function setLimitlessSQLRequest ($sql){ if(strstr ($sql,"LIMIT")) { die ('AePageableNotesView: Request must not contain "LIMIT"'); } $this->sql = $sql; if($this->sql_count === null){ if(strpos ($sql,"SELECT * ")===0){ $this->sql_count = "SELECT COUNT(*) Total ". substr ($sql,9); } else { die ('AePageableNotesView: setSQLCountRequest () must be used'); } } } public function setPortionSize ($limit){ $this->limit = abs ((int)$limit); } public function setNextPrevPageTitles ($nextPageTitle,$prevPageTitle){ $this->nextPageTitle = $nextPageTitle; $this->prevPageTitle = $prevPageTitle; } public function setHighlightedTags ($highlightedTags){ $this->highlightedTags = $highlightedTags; } public function setCacheFilename ($cacheFilename){ $this->isCached = true; $this->cacheFilename = $cacheFilename; } public function setWantPaging ($wantPaging){ $this->wantPaging = $wantPaging; } public function setWantNewCommentsCount ($wantNewCommentsCount){ $this->wantNewCommentsCount = $wantNewCommentsCount; } public function setWantReadHrefs ($wantReadHrefs){ $this->wantReadHrefs = $wantReadHrefs; } public function setWantPreviewHrefs ($wantPreviewHrefs){ $this->wantPreviewHrefs = $wantPreviewHrefs; } public function setWantControls ($wantControls){ $this->wantControls = $wantControls; } public function setWantHiddenTags ($wantHiddenTags){ $this->wantHiddenTags = $wantHiddenTags; } public function setWantRelatedNotes ($wantRelatedNotes){ $this->wantRelatedNotes = $wantRelatedNotes; } public function setUseLocalHrefs ($useLocalHrefs){ $this->useLocalHrefs = $useLocalHrefs; } public function isExistingPage () { if (!$this->hasRun)$this -> run (); return$this->pageExists; } public function isFirstPage () { return$this->page === 1; } public function isFirstPageOfEmptyView () { if (!$this->hasRun)$this -> run (); return$this->page === 1 and $this->totalPages === 0; } public function getTotalNotes () { if (!$this->hasRun)$this -> run (); return$this->totalNotes; } public function getTotalPages () { if (!$this->hasRun)$this -> run (); return$this->totalPages; } public function getNotesCTree () { if (!$this->hasRun)$this -> run (); return$this->notesCTree; } public function getPagesCTree () { if (!$this->hasRun)$this -> run (); return$this->pagesCTree; } private function prepareCacheableData () { $this->totalNotes = 0; if($this->limit){ $k3 = ($this->page - 1)*$this->limit; $this->sql .= ' LIMIT '. $k3 .', '. $this->limit; } fm ($this->sql_count,'count total notes of "'. $this->candy .'" list'); $x3 = sm (); $this->totalNotes = $x3 ? (int)$x3[0]['Total']:0; fm ($this->sql,'get limited full notes "'. $this->candy .'" list'); $e3 = sm (); $d3 = []; foreach ($e3 as $a3 => $s){ $d3[] = $s['ID']; } $this->notesCTree = []; foreach ($e3 as $a3 => $s){ $noteView = new AeNoteView ($s); $noteView -> setWantNewCommentsCount ($this->wantNewCommentsCount); $noteView -> setWantReadHref ($this->wantReadHrefs); $noteView -> setWantPreviewHref ($this->wantPreviewHrefs); $noteView -> setWantControls ($this->wantControls); $noteView -> setWantHiddenTags ($this->wantHiddenTags); $noteView -> setWantCommentsLink (true); $noteView -> setWantRelatedNotes ($this->wantRelatedNotes); $noteView -> setFilterOutRelatedNoteIDs ($d3); $noteView -> setHighlightedTags ($this->highlightedTags); $noteView -> setUseLocalHref ($this->useLocalHrefs); $this->notesCTree[] = $noteView -> getNoteCTree (); } $this->pagesCTree = []; if ( $this->limit and $this->totalPages = (int)ceil ($this->totalNotes / $this->limit) ) { $this->pagesCTree['timeline?']=true; $this->pagesCTree['count'] = (int)$this->totalPages; $this->pagesCTree['this'] = (int)$this->page; if($this->wantPaging){ $this->pagesCTree['earlier-title']=$this->nextPageTitle; $this->pagesCTree['later-title']=$this->prevPageTitle; $r3 = $this->parameters; if($this->page < $this->totalPages){ $r3['page']=$this->page + 1; $this->pagesCTree['earlier-href']=kq ($this->candy,$r3); } if($this->page > 1){ $r3['page']=$this->page - 1; $this->pagesCTree['later-href']=kq ($this->candy,$r3); } } } } private function run () { $this->hasRun = true; if($this->isCached and is_file ($this->cacheFilename)) { $t3 = @unserialize (file_get_contents ($this->cacheFilename)); $this->totalNotes = @$t3['notes_total']; $this->notesCTree = @$t3['notes_ctree']; $this->pagesCTree = @$t3['pages_ctree']; $this->totalPages = @$this->pagesCTree['count']; } if ( is_int ($this->totalNotes) and is_array ($this->notesCTree) and is_array ($this->pagesCTree) and is_int ($this->totalPages) ) { if(Log::$a)__log ('Retrieved cached CTree'); } else { $this -> prepareCacheableData (); if($this->isCached){ e3 ($this->cacheFilename,serialize ([ 'notes_total' => $this->totalNotes, 'notes_ctree' => $this->notesCTree, 'pages_ctree' => $this->pagesCTree, ])); } } foreach($this->notesCTree as $j3){ AeNoteReadCountsProvider :: requestDeferredReadCountForNoteID ($j3['id']); if (empty ($j3['related']['each'])) continue; foreach ($j3['related']['each'] as $h3){ AeNoteReadCountsProvider :: requestDeferredReadCountForNoteID ($h3['id']); } } $this->pageExists = ( $this->totalPages > 0 and $this->page >= 1 and $this->page <= $this->totalPages ); } } class AeRequest { public $method = 'GET'; public $url = ''; public $candy = ''; public $parameters = []; public function __construct ($p,$g3){ $this->method = $p['REQUEST_METHOD']; $w3 = urldecode ($g3['go']); if(substr ($w3,0,strlen (AeEnv::$u)) === AeEnv::$u){ $w3 = substr ($w3,strlen (AeEnv::$u)); } $this->url = ( AeEnv::$h .'://'. AeEnv::$j . AeEnv::$w . AeEnv::$u . '/'. $w3 ); list ($this->candy,$this->parameters)=xq ($w3); } public function toBeFulfilledByService () { return substr ($this->candy,0,4)=='e2s_'; } public function requiresInstallation () { return !in_array ($this->candy, [ 'e2s_build', 'e2m_info', 'e2m_install', 'e2j_check_db_config', 'e2j_list_databases', 'e2s_instantiate', 'e2s_install', ]); } public function requiresVersionMatch () { return$this->requiresInstallation(); } public function requiresScheduleCheckBeforeServing () { return$this->requiresInstallation(); } public function shouldSlowDownAJAXResponse () { return in_array ($this->candy, [ 'e2j_check_db_config', 'e2j_list_databases', 'e2j_check_password', 'e2j_userpic_upload', 'e2j_userpic_remove', 'e2j_file_upload', 'e2j_file_remove', 'e2j_note_livesave', 'e2s_note_flag_favourite', 'e2s_comment_flag_ajax', 'e2s_tag_flag_ajax', ]); } public function requiresSignIn () { return ( !empty ($this->candy) and is_callable ($this->candy) and $this->requiresInstallation () and !in_array ($this->candy, [ 'e2m_info', 'e2m_frontpage', 'e2m_rss', 'e2m_json', 'e2m_note', 'e2m_note_json', 'e2m_note_read', 'e2m_tags', 'e2m_tag', 'e2m_untagged', 'e2m_tag_rss', 'e2m_tag_json', 'e2m_popular', 'e2m_favourites', 'e2m_most_commented', 'e2m_found', 'e2m_comments', 'e2m_everything', 'e2m_sitemap_xml', 'e2m_year', 'e2m_month', 'e2m_day', 'e2m_unsubscribe', 'e2m_theme_preview', 'e2m_error404', 'e2m_password_reset', 'e2s_password_reset_email', 'e2m_password', 'e2s_password_save', 'e2s_sign_in', 'e2m_sign_out', 'e2m_gip_sign_in', 'e2m_gip_sign_in_callback', 'e2m_gip_sign_out', 'e2s_comment_process', 'e2s_search', 'e2s_bsi_step', 'e2j_check_password', 'e2s_retrieve', 'e2s_notify', 'e2s_dump', ]) ); } public function allowedInReadOnlyMode () { return !in_array ($this->candy, [ 'e2m_write', 'e2m_note_edit', 'e2s_note_process', 'e2s_note_publish', 'e2s_note_delete', 'e2s_note_flag_favourite', 'e2s_note_flag', 'e2m_comment_edit', 'e2m_comment_delete', 'e2m_comment_reply', 'e2m_comment_reply_delete', 'e2m_comment_flag', 'e2s_comment_flag_ajax', 'e2m_unsubscribe', 'e2s_comment_process', 'e2m_settings', 'e2m_timezone', ]); } public function replaceWith ($u3){ $this->candy = $u3; } } function c () { global$_config; $i3 = [ 'new-note-href' => kq ('e2m_write'), 'drafts-href' => kq ('e2m_drafts', ['page' => 1]), 'drafts-count' => (int)bf (false,true), 'settings-href' => kq ('e2m_settings'), 'theme-preview-href' => kq ('e2m_theme_preview', array ('theme' => '')), 'password-href' => kq ('e2m_password', array ('recovery-key' => '')), 'database-href' => kq ('e2m_database'), 'timezone-href' => kq ('e2m_timezone'), 'sessions-href' => kq ('e2m_sessions'), 'sign-out-href' => kq ('e2m_sign_out'), ]; if (gs ()) { $i3['get-backup-href']=kq ('e2m_get_backup'); } if (@$_config['read_only']) { unset ($i3['new-note-href']); unset ($i3['settings-href']); unset ($i3['timezone-href']); } if (!$_config['allow_themes_preview']) { unset ($i3['theme-preview-href']); } $databaseConfiguration = cl (); if($databaseConfiguration->source !== 'settings' or !$_config['allow_db_config']) { unset ($i3['database-href']); } list ($z3,$o3)=lb ($databaseConfiguration); if ($z3){ $i3['new-comments-count']=$z3; $i3['new-comments-href']=$o3; } return $i3; } function v ($p3,AeDatabaseConfiguration $databaseConfiguration,$cy){ static $vy = null; $by = ( $p3 === USER_DIR and $databaseConfiguration == cl () ); if ($cy){ if ($p3 !== false){ @unlink ($p3 . CACHE_FILENAME_ALIASMAP); } if ($by)$vy = null; return; } if ($by and is_array ($vy)) { return $vy; } $yy = null; if(CACHE_ALIASMAP and is_file ($p3 . CACHE_FILENAME_ALIASMAP)) { $yy = @unserialize (file_get_contents ($p3 . CACHE_FILENAME_ALIASMAP)); } if(is_array ($yy)) { if ($by)$vy = $yy; return $yy; } if(Log::$a)__log ('Build aliasmap {'); $yy = []; dm ( $databaseConfiguration, "SELECT `EntityType`, `EntityID`, `Alias` ". "FROM `". $databaseConfiguration -> getPrefix () . "Aliases` ". "WHERE `SubsetID`=". $databaseConfiguration -> getSubset () ." ". "AND `Stamp` IN (". "SELECT MAX(`Stamp`) `MaxStamp` ". "FROM `". $databaseConfiguration -> getPrefix () . "Aliases` ". "WHERE `SubsetID`=". $databaseConfiguration -> getSubset () ." ". "GROUP BY `EntityType`, `EntityID`". ")", 'get all active aliases' ); foreach (sm () as $ny){ $my = $ny['EntityType'].$ny['EntityID']; $yy[$my]=$ny['Alias']; } dm ( $databaseConfiguration, "SELECT `ID`, `Stamp`, `Offset`, `IsDST`, `OriginalAlias` ". "FROM `". $databaseConfiguration -> getPrefix () . "Notes` ". "WHERE `SubsetID`=". $databaseConfiguration -> getSubset () ." ". "AND `IsPublished` = 1 ". "ORDER BY `Stamp`", 'get all notes to cache y/d/m/n urls' ); $fy = 0; $dy = false; foreach (sm () as $sy){ $my = 'n'. $sy['ID']; $ay = v1 ( 'Y/m/d',$sy['Stamp'],wa ($sy) ); if ($ay !== $dy)$fy = 0; $fy ++; $qy = $ay .'/'. $fy; if (empty ($yy[$my])) { $yy[$my]=$qy; } else { if ((string)$sy['OriginalAlias']===''){ $yy[$my . '-ymdn']=$qy; } } $dy = $ay; } dm ( $databaseConfiguration, "SELECT `ID`, `OriginalAlias` ". "FROM `". $databaseConfiguration -> getPrefix () . "Keywords` ". "WHERE `SubsetID`=". $databaseConfiguration -> getSubset (), 'get original active aliases for tags' ); foreach (sm () as $tb){ $my = 't'. $tb['ID']; if (empty ($yy[$my])) { $yy[$my]=$tb['OriginalAlias']; } } if(CACHE_ALIASMAP)e3 ($p3 . CACHE_FILENAME_ALIASMAP,serialize ($yy)); if ($by)$vy = $yy; if(Log::$a)__log ('}'); return $yy; } function b ($cy = false){ return v (USER_DIR,cl (), $cy); } function e2_alias_of_note_with_id_($ly){ $zy = b () ['n'. $ly]; if(preg_match ( '/^(?P<year>\d{4})\/(?P<month>\d{1,2})\/(?P<day>\d{1,2})\/(?P<day_number>\d+)$/s', $zy ))$zy = ''; return $zy; } function e2ali__alias_from_title_($source){ global$_config; $ky = $source; if(array_key_exists ('autoreplace_for_aliases',$_config)) { $ky = strtr ( $ky, $_config['autoreplace_for_aliases'] ); } $ky = e1 ($ky); $ky = str_replace ('\'','',$ky); $ky = str_replace ('’','',$ky); $ky = str_replace (chr (146),'',$ky); $xy = ''; for ($rb = 0; $rb < strlen ($ky); ++ $rb){ if ( (ord ($ky[$rb]) >= 48 and ord ($ky[$rb]) <= 57) or (ord ($ky[$rb]) >= 65 and ord ($ky[$rb]) <= 90) or (ord ($ky[$rb]) >= 97 and ord ($ky[$rb]) <= 122) or 0 ) { $xy .= $ky[$rb]; } else { $xy .= '-'; } } $xy = preg_replace ('/\-+/','-',$xy); $xy = trim ($xy,'-'); $xy = strtolower ($xy); if ($xy == '-')$xy = ''; $xy = substr ($xy,0,ALIAS_MAX_LENGTH); return $xy; } function m (AeDatabaseConfiguration $databaseConfiguration,$zy){ if ((string)$zy === '') return false; dm ( $databaseConfiguration, "SELECT * FROM `". $databaseConfiguration -> getPrefix () . "Aliases` ". "WHERE `SubsetID`=". $databaseConfiguration -> getSubset () ." ". "AND `Alias` = '". $zy ."' ". "ORDER BY `Stamp` LIMIT 1", 'get alias record for alias "'. $zy .'"' ); $e3 = sm (); if(count ($e3)==1){ return $e3[0]; } else { return false; } } function f ($zy){ if ((string)$zy === '') return false; if(Log::$a)__log ('Get entity type and id from alias "'. $zy .'"'); $ey = @array_flip (b ()); $my = (string) @$ey[$zy]; if ( strlen ($my)>0 and ($my[0]=='n' or $my[0]=='t') ) { $kb = [ 'type' => $my[0], 'id' => (int)substr ($my,1) ]; return $kb; } $ny = m (cl (), $zy); if (!$ny) return false; $kb = [ 'type' => $ny['EntityType'], 'id' => (int)$ny['EntityID'], ]; if(Log::$a)__log ('Got entity type "'. $kb['type'] .'" and id "'. $kb['id'] .'"'); return $kb; } function d ( $p3,AeDatabaseConfiguration $databaseConfiguration, $hy,$jy,$ry,$source,$ty = 1 ){ if(Log::$a)__log ('Aliases: "'. $hy .'" available alias for source "'. $source. '"'); $gy = $jy . $ry; if ($hy === 'set' and $gy === '') return false; $xy = e2ali__alias_from_title_($source); if($source !== '' and $xy === ''){ $xy = (string)$ty; } elseif ($ty > 1){ $wy = '-'. $ty; $xy = substr ($xy,0,ALIAS_MAX_LENGTH - strlen ($wy)) . $wy; } $yy = v ($p3,$databaseConfiguration,false); if ($ny = m ($databaseConfiguration,$xy)) { $uy = $ny['EntityType'].$ny['EntityID']; if ( $gy === $uy or $xy !== $yy[$uy] ) { if ($hy == 'find') return $xy; if ($hy == 'set'){ if(Log::$a)__log ('Aliases: update alias timestamp'); nm ($databaseConfiguration,'Aliases', [ 'ID' => $ny['ID'], 'EntityType' => $jy, 'EntityID' => $ry, 'Alias' => $xy, 'Stamp' => time (), ]); v ($p3,$databaseConfiguration,true); return $xy; } } else { return d ($p3,$databaseConfiguration,$hy,$jy,$ry,$source,$ty + 1); } } else { if ($gy !== '' and $xy == ''){ if(preg_match ( '/(?P<year>\d{4})\/(?P<month>\d{1,2})\/(?P<day>\d{1,2})\/(?P<day_number>\d+)/', $yy [$gy] )) { if(Log::$a)__log ('Aliases: d/m/y/n was already used for this entity'); return ''; } } if(Log::$a)__log ('Aliases: it’s an empty alias, and it was not being used for this entity'); if ( $jy == 't' and $iy = sa ($databaseConfiguration,$xy) ) { if ($iy['ID']!=$ry){ return d ($p3,$databaseConfiguration,$hy,$jy,$ry,$source,$ty + 1); } } if ($hy == 'find') return $xy; if ($hy == 'set'){ ym ($databaseConfiguration,'Aliases', [ 'EntityType' => $jy, 'EntityID' => $ry, 'Alias' => $xy, 'Stamp' => time (), ]); v ($p3,$databaseConfiguration,true); return $xy; } } return ''; } function e2_delete_aliases_for_entity_($type,$ly){ global$_config; fm ( "DELETE FROM `". $_config['db_table_prefix']."Aliases` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `EntityType` = '". $type ."' ". "AND `EntityID`=". ((int)$ly), 'delete aliases of note' ); } function a () { static $oy; $py = as_ (); if (empty ($oy)) { $oy = md5 (AeEnv::$o .'email'. $py); } return $oy; } function q () { static $cn; $py = as_ (); if (empty ($cn)) { $cn = md5 (AeEnv::$o .'nospam'. $py . date ('n-Y')); } return $cn; } function l () { static $vn; $py = as_ (); if(empty($vn)) { $vn = md5 (AeEnv::$o .'nospam'. $py . date ('n-Y',strtotime('-1 month'))); } return $vn; } function z ($note_id){ $py = as_ (); return z1 ('comment_'. md5 (AeEnv::$o .'nospam_cookie'. $py . $note_id)); } function k () { $bn = $_SERVER['HTTP_USER_AGENT']; $py = as_ (); return md5 (AeEnv::$o .'nospam_cookie'. $py . $bn); } function x () { if ( array_key_exists ('email',$_POST) and $_POST['email']!=='' ) return true; $cn = q (); $vn = l (); if ( !array_key_exists ($cn,$_POST) and !array_key_exists ($vn,$_POST) ) return true; if ( ( array_key_exists ($cn,$_POST) and $_POST[$cn]!=='' ) or ( array_key_exists ($vn,$_POST) and $_POST[$vn]!=='' ) ) return true; if ( !array_key_exists ('comment',$_POST) or (strlen ($_POST['comment']) > 6) ) return true; return false; } function e2_cookie_data_is_spam_suspicios_for_note_id_($note_id){ if ( !array_key_exists (z ($note_id),$_COOKIE) or ($_COOKIE[z ($note_id)] !== k ()) ) return true; return false; } function e2m_year ($parameters = []) { global$_strings,$_config; $yn = $parameters['year']; $nn = e2l_get_string ('pt--nth-year', ['year' => $yn]); if (!j ($yn)) { return e2m_error404 (); } AeMainMenuManager :: $isCalendarCurrent = false; AeMainMenuManager :: $isCalendarParent = true; $mn = gmmktime (0,0,0,1,1,$yn - 1); $fn_ = gmmktime (0,0,0,1,1,$yn + 1); list ($dn,$sn)=e2__fruitful_neighbours_with_ymd_($yn); $an = 'e2m_year'; if ($dn){ $qn['prev-href']=kq ( $an,e2__parameters_with_timestamp_($dn) ); $qn['prev-jump?'] = (bool) (gmdate ('Y',$mn)!=gmdate ('Y',$dn)); $qn['prev-title']=gmdate ('Y',$dn); } if ($sn){ $qn['next-href']=kq ( $an,e2__parameters_with_timestamp_($sn) ); $qn['next-jump?'] = (bool) (gmdate ('Y',$fn_)!=gmdate ('Y',$sn)); $qn['next-title']=gmdate ('Y',$sn); } $qn['timeline?']=false; $qn['this']=$yn; $qn['this-title']=$yn; list ($ln,$zn)=f1 ($yn); $cb = [ 'title' => $nn, 'heading' => $nn, 'pages' => $qn, 'year' => (int)$yn, 'calendar' => t ($yn,false,false), ]; fm ( "SELECT * FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished` = 1 ". mf (vs ()). "AND `Stamp` BETWEEN ". $ln ." ". "AND ". $zn ." ". "ORDER BY `Stamp`", 'get all notes for the year' ); $e3 = sm (); $kn = w (true,$e3,$yn); if(count ($kn)) { $cb['notes-list']=$kn; } else { $cb['nothing']=$_strings['gs--no-such-notes']; } return $cb; } function e2m_month ($parameters = []) { global$_strings,$_config; $yn = $parameters['year']; $xn = $parameters['month']; $nn = e2l_get_string ( 'pt--nth-month-of-nth-year', ['year' => $yn,'month' => $xn] ); if (!j ($yn,$xn)) { return e2m_error404 (); } AeMainMenuManager :: $isCalendarCurrent = false; AeMainMenuManager :: $isCalendarParent = true; $mn = gmmktime (0,0,0,$xn - 1,1,$yn); $fn_ = gmmktime (0,0,0,$xn + 1,1,$yn); list ($dn,$sn)=e2__fruitful_neighbours_with_ymd_($yn,$xn); $an = 'e2m_month'; if ($dn){ $qn['prev-href']=kq ( $an,e2__parameters_with_timestamp_($dn) ); $qn['prev-jump?'] = (bool) (gmdate ('Y/m',$mn)!=gmdate ('Y/m',$dn)); $qn['prev-title']=e2l_get_string ( 'gs--nth-month-of-nth-year', [ 'year' => gmdate ('Y',$dn),'month' => gmdate ('n',$dn) ] ); } if ($sn){ $qn['next-href']=kq ( $an,e2__parameters_with_timestamp_($sn) ); $qn['next-jump?'] = (bool) (gmdate ('Y/m',$fn_)!=gmdate ('Y/m',$sn)); $qn['next-title']=e2l_get_string ( 'gs--nth-month-of-nth-year', [ 'year' => gmdate ('Y',$sn),'month' => gmdate ('n',$sn) ] ); } $qn['timeline?']=false; $qn['this-title']=$nn; list ($ln,$zn)=f1 ($yn,$xn); $cb = [ 'title' => $nn, 'heading' => $nn, 'calendar' => t ($yn,$xn,false), 'pages' => $qn, 'year' => (int)$yn, 'month' => (int)$xn, ]; fm ( "SELECT * FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished` = 1 ". mf (vs ()). "AND `Stamp` BETWEEN ". $ln ." ". "AND ". $zn ." ". "ORDER BY `Stamp`", 'get all notes for the month' ); $e3 = sm (); $kn = w (true,$e3,$yn,$xn); if(count ($kn)) { $cb['notes-list']=$kn; } else { $cb['nothing']=$_strings['gs--no-such-notes']; } return $cb; } function e2m_day ($parameters = []) { global$_strings,$_config,$_current_url; $yn = (int)$parameters['year']; $xn = (int)$parameters['month']; $en = (int)$parameters['day']; if (!(j ($yn,$xn,$en))) { return e2m_error404 (); } AeMainMenuManager :: $isCalendarCurrent = false; AeMainMenuManager :: $isCalendarParent = true; if($_current_url === p ()) { AeMainMenuManager :: $isCalendarCurrent = true; AeMainMenuManager :: $isCalendarParent = false; } $nn = e2l_get_string ( 'pt--nth-day-of-nth-month-of-nth-year', ['year' => $yn,'month' => $xn,'day' => $en] ); $mn = gmmktime (0,0,0,$xn,$en - 1,$yn); $fn_ = gmmktime (0,0,0,$xn,$en + 1,$yn); list ($dn,$sn)=e2__fruitful_neighbours_with_ymd_($yn,$xn,$en); $an = 'e2m_day'; if ($dn){ $qn['prev-href']=kq ( $an,e2__parameters_with_timestamp_($dn) ); $qn['prev-jump?'] = (bool) (gmdate ('Y/m/d',$mn)!=gmdate ('Y/m/d',$dn)); $qn['prev-title']=e2l_get_string ( 'gs--nth-day-of-nth-month-of-nth-year', [ 'year' => gmdate ('Y',$dn),'month' => gmdate ('n',$dn),'day' => gmdate ('j',$dn), ] ); } if ($sn){ $qn['next-href']=kq ( $an,e2__parameters_with_timestamp_($sn) ); $qn['next-jump?'] = (bool) (gmdate ('Y/m/d',$fn_)!=gmdate ('Y/m/d',$sn)); $qn['next-title']=e2l_get_string ( 'gs--nth-day-of-nth-month-of-nth-year', [ 'year' => gmdate ('Y',$sn),'month' => gmdate ('n',$sn),'day' => gmdate ('j',$sn), ] ); } $qn['timeline?']=false; $qn['this-title']=$nn; $cb = [ 'title' => $nn, 'heading' => $nn, 'pages' => $qn, 'calendar' => t ($yn,$xn,$en), ]; $e3 = um ($yn,$xn,$en); $e3 = array_reverse ($e3); $rn = vs (); $kn = []; foreach ($e3 as $a3 => $sy){ if (!( nf ($sy)==='public' or ($rn and $sy['IsPublished']) )) continue; $noteView = new AeNoteView ($sy); $noteView -> setWantNewCommentsCount ($rn); $noteView -> setWantReadHref ($_config['count_reads']); $noteView -> setWantControls ($rn and !@$_config['read_only']); $noteView -> setWantHiddenTags ($rn); $noteView -> setWantCommentsLink (true); $kn[] = $noteView -> getNoteCTree (); } if(count ($kn)) { $cb['notes']=$kn; } else { $cb['nothing']=$_strings['gs--no-such-notes']; } return $cb; } function r ($tn){ global$_config; $kn = null; if(CACHE_FULLLIST and is_file (USER_DIR . CACHE_FILENAME_FULLLIST)) { $kn = @unserialize (file_get_contents (USER_DIR . CACHE_FILENAME_FULLLIST)); if(Log::$a)__log ('Retrieving full notes list from cache...'); } if (!is_array ($kn)) { if(Log::$a)__log ('Retrieving full notes list from database...'); fm ( "SELECT `ID`, `Title`, `Stamp`, `LastModified`, `Offset`, `IsDST`, ". "`IsFavourite`, `IsPublished`, `IsVisible`, `SourceNoteURL`, `OriginalAlias` ". "FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished` = 1 ". mf (). "ORDER BY `Stamp`", 'get full notes list' ); $e3 = sm (); $kn = w ($tn,$e3); if ($tn){ if(CACHE_FULLLIST)e3 (USER_DIR . CACHE_FILENAME_FULLLIST,serialize ($kn)); } } return $kn; } function e2m_everything ($parameters = []) { global$_strings; $kn = r (true); $jn = count ($kn); $nn = e2l_get_string ('pt--n-posts', ['number' => $jn]); $cb = [ 'title' => $nn, 'heading' => $nn, ]; if(count ($kn)) { $cb['notes-list']=$kn; } else { $cb['nothing']=$_strings['gs--no-notes']; } return $cb; } function e2m_sitemap_xml ($parameters = []) { global$_config; $kn = r (false); if (@$_config['dev_xml_as_text']) { header ('Content-Type: text/plain'); } else { header ('Content-type: application/xml; charset=utf-8'); } echo '<?xml version="1.0" encoding="UTF-8"?>'."\r\n"; echo '<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">'."\r\n"; if(count ($kn)) { $hn = @$kn[0]['last-modified']; echo '<url>'."\r\n"; echo '<loc>'. kq ('e2m_frontpage', ['page' => 1]) .'</loc>'."\r\n"; echo '<lastmod>'; echo gmdate ('Y-m-d\TH:i:s\Z',$hn[0]); echo '</lastmod>'."\r\n"; echo '<changefreq>hourly</changefreq>'; echo '</url>'."\r\n"; foreach ($kn as $r){ echo '<url>'."\r\n"; echo '<loc>'; echo $r['href']; echo '</loc>'."\r\n"; echo '<lastmod>'; echo gmdate ('Y-m-d\TH:i:s\Z',$r['last-modified'][0]); echo '</lastmod>'."\r\n"; echo '</url>'."\r\n"; } } echo '</urlset>'."\r\n"; die; } function t ($yn,$xn,$en){ if(is_numeric ($xn)) { $gn = v1 ( 't',gmmktime (0,0,0,$xn,1,$yn), ua () ); } else { $gn = 0; } $wn = cv ('start'); $un = v1 ( 'Y',$wn['stamp'],$wn['timezone'] ); $in = b1 ('Y',time ()); $on = b1 ('m',time ()); if ((int)$yn == (int)$un){ $pn = v1 ('m',$wn['stamp'],$wn['timezone']); } else { $pn = 1; } if ((int)$yn == (int)$in){ $on = b1 ('m',time ()); } else { $on = 12; } if ((int)$yn == (int)$un and (int)$xn == (int)$pn){ $cm = v1 ('d',$wn['stamp'],$wn['timezone']); } else { $cm = 1; } if ((int)$yn == (int)$in and (int)$xn == (int)$on){ $vm = b1 ('d',time ()); } else { $vm = $gn; } if(1){ $bm = u (); for ($rb = $un; $rb <= $in; ++ $rb){ $ym = gmmktime (0,0,0,1,1,$rb); $nm[$rb] = [ 'number' => $rb, 'start-time' => [$ym,ua ()], 'href' => kq ('e2m_year', [ 'year' => gmdate ('Y',$ym), ]), 'this?' => (bool) ($rb == $yn), 'real?' => true, 'fruitful?' => @in_array (gmdate ('Y',$ym),$bm), ]; } $mm['years']=$nm; } if(1){ $fm = i ($yn); for ($rb = 1; $rb <= 12; ++ $rb){ $ym = gmmktime (0,0,0,$rb,1,$yn); $dm[$rb] = [ 'number' => $rb, 'start-time' => [$ym,ua ()], 'href' => kq ('e2m_month', [ 'year' => gmdate ('Y',$ym), 'month' => gmdate ('m',$ym), ]), 'this?' => (bool) ($rb == $xn), 'real?' => $rb >= $pn and $rb <= $on, 'fruitful?' => @in_array (gmdate ('n',$ym),$fm), ]; } $mm['months']=$dm; } if ($gn){ $sm = o ($yn,$xn); for ($rb = 1; $rb <= $gn; ++ $rb){ $ym = gmmktime (0,0,0,$xn,$rb,$yn); $am[$rb] = [ 'number' => $rb, 'start-time' => [$ym,ua ()], 'href' => kq ('e2m_day', [ 'year' => gmdate ('Y',$ym), 'month' => gmdate ('m',$ym), 'day' => gmdate ('d',$ym), ]), 'this?' => (bool) ($rb == $en), 'real?' => $rb >= $cm and $rb <= $vm, 'fruitful?' => @in_array (gmdate ('d',$ym),$sm), ]; } $mm['days']=$am; } return $mm; } function j ($yn,$xn = false,$en = false){ $wn = cv ('start'); if ($wn === false){ return false; } $qm = v1 ('Y',$wn['stamp'],$wn['timezone']); $lm = b1 ('Y',time ()); if ($xn === false){ return (bool) ( $yn >= $qm and $yn <= $lm ); } else { $zm = v1 ('n',$wn['stamp'],$wn['timezone']); $km = b1 ('n',time ()); if ($en === false){ return (bool) ( $xn >= 1 and $xn <= 12 and ( ($yn > $qm and $yn < $lm) or ($yn == $qm and $xn >= $zm) or ($yn == $lm and $xn <= $km) ) ); } else { $xm = v1 ('j',$wn['stamp'],$wn['timezone']); $em = b1 ('j',time ()); if(1){ return (bool) ( checkdate ($xn,$en,$yn) and ( ($yn > $qm and $yn < $lm) or ($yn == $qm and $xn > $zm) or ($yn == $qm and $xn == $zm and $en >= $xm) or ($yn == $lm and $xn < $km) or ($yn == $lm and $xn == $km and $en <= $em) ) ); } } } } function e2__fruitful_neighbours_with_ymd_($rm,$tm = false,$jm = false){ global$_db,$_config; list ($hm,$gm)=f1 ($rm,$tm,$jm); $wm = SECONDS_IN_A_DAY; if ($jm === false)$wm = SECONDS_IN_A_MONTH; if ($tm === false)$wm = SECONDS_IN_A_YEAR; $um = $im = null; fm ( "SELECT `Stamp`, `Offset`, `IsDST` ". "FROM `". $_config['db_table_prefix']. "Notes` n ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished`=1 ". "AND `Stamp` < '". ($gm - $wm) ."' ". "AND `Stamp` <= '". time () ."' ". mf (vs ()). "ORDER BY Stamp DESC", 'get previous fruitful neighbour with ymd' ); while ($om = mysqli_fetch_array ($_db['result'],MYSQLI_ASSOC)) { list ($yn,$xn,$en)=explode ('/', v1 ('Y/n/j',$om['Stamp'],wa ($om)) ); $pm = $rm * 10000 + ($tm? ($tm * 100):0) + ($jm? $jm : 0); $cf = $yn * 10000 + ($tm? ($xn * 100):0) + ($jm? $en : 0); if ($cf < $pm){ $um = gmmktime (0,0,0,$xn,$en,$yn); break; } } fm ( "SELECT `Stamp`, `Offset`, `IsDST` ". "FROM `". $_config['db_table_prefix']. "Notes` n ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished`=1 ". "AND `Stamp` > '". ($hm + $wm) ."' ". "AND `Stamp` <= '". time () ."' ". mf (vs ()). "ORDER BY Stamp", 'get next fruitful neighbour with ymd' ); while ($om = mysqli_fetch_array ($_db['result'],MYSQLI_ASSOC)) { list ($yn,$xn,$en)=explode ('/', v1 ('Y/n/j',$om['Stamp'],wa ($om)) ); $pm = $rm * 10000 + ($tm? ($tm * 100):0) + ($jm? $jm : 0); $cf = $yn * 10000 + ($tm? ($xn * 100):0) + ($jm? $en : 0); if ($cf > $pm){ $im = gmmktime (0,0,0,$xn,$en,$yn); break; } } return [$um,$im]; } function e2__parameters_with_timestamp_($vf){ list ( $parameters['year'], $parameters['month'], $parameters['day'] ) = explode ('/',gmdate ('Y/m/d',$vf)); return$parameters; } function w ($tn,$bf,$yn = false,$xn = false){ $kn = []; $yf = []; foreach ($bf as $a3 => $sy){ $r['href'] = kq ('e2m_note', ['*note' => $sy]); $r['time'] = [(int)$sy['Stamp'],wa ($sy)]; $r['last-modified'] = [(int)min ($sy['LastModified'],time ()), wa ($sy)]; $r['favourite?'] = (bool) ($sy['IsFavourite'] && $sy['IsPublished']); $nf = nf ($sy); $r['draft?'] = $nf === 'draft'; $r['scheduled?'] = $nf === 'scheduled'; $r['public?'] = $nf === 'public'; $r['hidden?'] = $nf === 'hidden'; if(array_key_exists ('SourceNoteURL',$sy) and @$sy['SourceNoteURL']!=''){ $r['href']=$sy['SourceNoteURL']; $r['href-original']=$sy['SourceNoteURL']; } if ( ($yn and $xn and ( ((int)$yn) .'/'. ((int)$xn) == v1 ('Y/n',$sy['Stamp'],wa ($sy)) )) or ($yn and !$xn and ( (int)$yn == v1 ('Y',$sy['Stamp'],wa ($sy)) )) or (!$yn and !$xn) ) { $kn[] = $r; $yf[] = str_replace ("\n",' ',$sy['Title']); } } if(Log::$a)__log ('Will do typography'); if ($tn){ $mf = implode ("\n",$yf); $mf = dy (htmlspecialchars ($mf,ENT_NOQUOTES,'UTF-8')); $yf = explode ("\n",$mf); } foreach ($kn as $a3 => $q3){ $kn[$a3]['title']=$yf[$a3]; } $kn = array_reverse ($kn); return $kn; } function u () { global$_config; fm ( "SELECT `Stamp`, `Offset`, `IsDST` ". "FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished`=1 ". "AND `Stamp` <= '". time () ."' ". mf (vs ()), 'get all notes list years with notes' ); $e3 = sm (); $ff = []; foreach ($e3 as $df){ $sf = (int)v1 ('Y',$df['Stamp'],wa ($df)); $ff[$sf]=true; } $ff = array_keys ($ff); sort ($ff); return $ff; } function i ($rm){ global$_config; list ($af,$qf)=f1 ($rm); fm ( "SELECT `Stamp`, `Offset`, `IsDST` ". "FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished`=1 ". "AND `Stamp` BETWEEN '". $af. "' AND '". $qf ."' ". "AND `Stamp` <= '". time () ."' ". mf (vs ()), 'get all notes for the year '. $rm .' to list months with notes' ); $e3 = sm (); $lf = []; foreach ($e3 as $df){ if ( ((int)$rm) == v1 ('Y',$df['Stamp'],wa ($df)) ) { $zf = (int)v1 ('n',$df['Stamp'],wa ($df)); $lf[$zf]=true; } } $lf = array_keys ($lf); sort ($lf); return $lf; } function o ($rm,$tm){ global$_config; list ($kf,$xf)=f1 ($rm,$tm); fm ( "SELECT `Stamp`, `Offset`, `IsDST` ". "FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished`=1 ". "AND `Stamp` BETWEEN '". $kf ."' AND '". $xf ."' ". "AND `Stamp` <= '". time () ."' ". mf (vs ()), 'get all notes for the month '.$tm.' of the year '. $rm .' to list days with notes' ); $e3 = sm (); $ef = []; foreach ($e3 as $df){ if ( ((int)$rm) .'/'. ((int)$tm) == v1 ('Y/n',$df['Stamp'],wa ($df)) ) { $rf = (int)v1 ('j',$df['Stamp'],wa ($df)); $ef[$rf]=true; } } $ef = array_keys ($ef); sort ($ef); return $ef; } function p () { $tf = cv ('end'); return kq ('e2m_day', [ 'year' => v1 ( 'Y',$tf['stamp'],$tf['timezone'] ), 'month' => v1 ( 'm',$tf['stamp'],$tf['timezone'] ), 'day' => v1 ( 'd',$tf['stamp'],$tf['timezone'] ), ]); } function cv ($jf){ global$_config; $hf = 'p1'; $rn = vs (); if (!$rn){ $hf = 'p1v1'; } $gf = USER_DIR . CACHES_DIRNAME . $jf .'-stamp-'. $hf .'.e2time.psa'; if(CACHE_EDGE_TIMEINFO and is_file ($gf)) { $cb = @unserialize (file_get_contents ($gf)); } if(is_array (@$cb)) { return $cb; } else { $cb = [ 'stamp' => time (), 'timezone' => ia (), ]; $wf = (($jf == 'end')? ' DESC' : ''); fm ( "SELECT `Stamp`, `Offset`, `IsDST` ". "FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished`=1 ". "AND `Stamp` <= '". time () ."' ". mf ($rn). "ORDER BY `Stamp`". $wf ." LIMIT 1", 'get '. $jf .' timestamp' ); $e3 = sm (); if(count ($e3)) { $cb = [ 'stamp' => $e3[0]['Stamp'], 'timezone' => wa ($e3[0]), ]; if(CACHE_EDGE_TIMEINFO)e3 ($gf,serialize ($cb)); return $cb; } return $cb; } } function vv ($url,$uf = false){ if($_SERVER['HTTP_USER_AGENT']===E2_UA_STRING){ if(Log::$a)__log ('Spawn not allowed when requested by Aegea itself'); return false; } if(Log::$a)__log ('Spawn: Curl '. $url .' using '. ($uf? 'post' : 'get') .'...'); if(function_exists ('curl_init')) { $if_ = curl_init (); $of = !ini_get ('open_basedir'); $of = ($of and !$uf); curl_setopt_array ($if_, array ( CURLOPT_URL => $url, CURLOPT_POST => $uf, CURLOPT_POSTREDIR => false, CURLOPT_POSTFIELDS => '', CURLOPT_CONNECTTIMEOUT => 300, CURLOPT_TIMEOUT => 1, CURLOPT_MAXREDIRS => 1, CURLOPT_COOKIE => ns (), CURLOPT_SSL_VERIFYPEER => false, CURLOPT_FOLLOWLOCATION => $of, CURLOPT_RETURNTRANSFER => true, CURLOPT_AUTOREFERER => true, CURLOPT_USERAGENT => E2_UA_STRING, )); $content = curl_exec ($if_); $pf = curl_errno ($if_); $c2 = curl_error ($if_); $v2 = curl_getinfo ($if_); curl_close ($if_); if(Log::$a)__log ('Spawn: Curl returns: ['. print_r ($v2,true) .'] ['. $content .'], (errno='. $pf .', errstr='. $c2 .')...'); return $v2; } else { if(Log::$a)__log ('Spawn: Curl functions are not available'); } } function e2_check_timeout(){ static $b2; if(is_null($b2)) { $y2 = ini_get('max_execution_time'); if ($y2){ $b2 = time()+$y2 - 5; } else { $b2 = 0; } } return ($b2 == 0)?true : $b2 >= time(); } function e2_write_dump_header($n2){ $v2 = ( 'SET SQL_MODE="NO_AUTO_VALUE_ON_ZERO";' .PHP_EOL. 'SET AUTOCOMMIT=0;' .PHP_EOL. 'START TRANSACTION;' .PHP_EOL. "/*!40101 SET @OLD_CHARACTER_SET_CLIENT=@@CHARACTER_SET_CLIENT */;" .PHP_EOL. "/*!40101 SET @OLD_CHARACTER_SET_RESULTS=@@CHARACTER_SET_RESULTS */;" .PHP_EOL. "/*!40101 SET @OLD_COLLATION_CONNECTION=@@COLLATION_CONNECTION */;" .PHP_EOL. "/*!40014 SET @OLD_UNIQUE_CHECKS=@@UNIQUE_CHECKS, UNIQUE_CHECKS=0 */;" .PHP_EOL. "/*!40014 SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0 */;" .PHP_EOL. "/*!40101 SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE=NO_AUTO_VALUE_ON_ZERO */;" .PHP_EOL. "/*!40101 SET NAMES utf8 */;" .PHP_EOL. "/*!50503 SET NAMES utf8mb4 */;" .PHP_EOL. '' ); fwrite($n2,$v2); return true; } function e2_write_dump_footer($n2){ $m2 = 'COMMIT;' .PHP_EOL; $m2 .= "/*!40101 SET SQL_MODE=@OLD_SQL_MODE */;" . PHP_EOL . "/*!40014 SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS */;" . PHP_EOL . "/*!40014 SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS */;" . PHP_EOL . "/*!40101 SET CHARACTER_SET_RESULTS=@OLD_CHARACTER_SET_RESULTS */;" . PHP_EOL . "/*!40101 SET COLLATION_CONNECTION=@OLD_COLLATION_CONNECTION */;" . PHP_EOL . "/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;" . PHP_EOL; fwrite($n2,$m2); return true; } function e2_get_table_definition($f2,$d2){ $s2 = null; $e3 = mysqli_query($f2,"SHOW CREATE TABLE `{$d2}`"); if ($e3){ $a2 = mysqli_fetch_array($e3); $s2 = $a2['Create Table']; } return $s2; } function e2_write_table_definition($n2,$f2,$d2){ $q2 = e2_get_table_definition($f2,$d2); if(e2_check_timeout() && $q2){ fwrite($n2,$q2); fwrite($n2,';'); fwrite($n2,PHP_EOL . PHP_EOL); return true; } return false; } function e2_get_table_data($f2,$d2,$k3,$limit){ $l2 = "SELECT * FROM `{$d2}` LIMIT {$k3}, {$limit}"; $e3 = mysqli_query($f2,$l2); if (!$e3){ return false; } $z2 = ''; $k2 = "INSERT INTO `{$d2}` VALUES"; while ($x2 = mysqli_fetch_row($e3)) { $e2_ = array(); foreach($x2 as $cv){ $e2_[] = is_null($cv)?"NULL" : "'" . mysqli_real_escape_string($f2,$cv)."'"; } $z2 .= $k2 . '(' . join(', ',$e2_).');' . PHP_EOL; } return $z2; } function e2_table_disable_keys($d2){ return "ALTER TABLE `{$d2}` DISABLE KEYS;" . PHP_EOL; } function e2_table_enable_keys($d2){ return "ALTER TABLE `{$d2}` ENABLE KEYS;" . PHP_EOL; } function e2_get_total_records($f2,$d2){ $a3 = mysqli_fetch_row(mysqli_query($f2,"SELECT COUNT(*) FROM `{$d2}`")); return $a3[0]; } function e2_backup_select_chuck_size_for_table_($d2){ $limit = 5000; if(substr ($d2, -7)==='Actions')$limit = 50000; if(substr ($d2, -7)==='Aliases')$limit = 20000; if(substr ($d2, -7)==='NotesKeywords')$limit = 50000; if(Log::$a)__log ('Backup: chunk size '. (int)$limit); return$limit; } function e2_write_table_data($n2,$f2,$d2,$subset){ $r2 = e2_get_total_records($f2,$d2); $k3 = 0; $limit = e2_backup_select_chuck_size_for_table_($d2); $e3 = true; $t2 = 20000; $j2 = 30; if ($r2){ $h2 = e2_table_disable_keys($d2); fwrite($n2,$h2); } $z2 = "INSERT INTO `{$d2}` VALUES"; $g2 = $r2; while ($g2 > 0){ $l2 = "SELECT * FROM `{$d2}` "; if ((int)$subset > 0){ $l2 .= "WHERE `SubsetID` = {$subset} "; } $l2 .= "ORDER BY `ID` LIMIT {$k3}, {$limit}"; $e3 = mysqli_query($f2,$l2); $w2 = mysqli_num_rows($e3); if (!$e3 || !e2_check_timeout()) { $e3 = false; break; } $u2 = array(); $i2 = 0; $o2 = 0; while ($x2 = mysqli_fetch_row($e3)) { if (!e2_check_timeout()) { $e3 = false; break; } $w2--; $mb = array(); foreach($x2 as $cv){ $mb[] = is_null($cv)?"NULL" : "'" . mysqli_real_escape_string($f2,$cv)."'"; } $lb = '(' . join(', ',$mb).')'; $i2 += strlen($lb); $u2[] = $lb; $o2++; if ( ($i2 >= $t2) || ($o2 >= $j2) || ($w2 == 0)) { $l2 = $z2 . join(', ',$u2).';'; fwrite($n2,$l2); fwrite($n2,PHP_EOL); $i2 = 0; $o2 = 0; $u2 = array(); } } $k3 += $limit; $g2 -= $limit; } if ($r2){ $p2 = e2_table_enable_keys($d2); fwrite($n2,$p2); } return $e3; } function e2_backup($f2,$cd,$subset,$vd){ $bd = tmpfile(); e2_write_dump_header($bd); if(Log::$a)__log ('Backup: wrote header'); $yd = true; foreach($cd as $d2){ if ((int)$subset > 0){ if(Log::$a)__log ('Backup: table '. $d2 .', subset '. $subset); } else { if(Log::$a)__log ('Backup: table '. $d2 .', all subsets'); } $nd = e2_write_table_definition($bd,$f2,$d2); if(Log::$a)__log ('Backup: wrote table definition with result '. @(int)$nd); $md = e2_write_table_data($bd,$f2,$d2,$subset); if(Log::$a)__log ('Backup: wrote table data with result '. @(int)$md); $yd = $nd && $md; if ($yd === false){ break; } } if(Log::$a)__log ('Backup: wrote data with running == '. (int)$yd); if ($yd){ e2_write_dump_footer($bd); fseek($bd,0); $n2 = fopen($vd,'w+'); while ($yd && ($lb = fread($bd,1024))) { if(e2_check_timeout()) { fwrite($n2,$lb); } else { $yd = false; } } fclose($n2); } fclose($bd); return $yd; } function xv () { global$settings,$_lang,$_config,$_strings; if(Log::$a)__log ('Blog information'); $fd['author']=htmlspecialchars (rv (), ENT_NOQUOTES,'UTF-8'); if(array_key_exists ('blog_subtitle',$settings)) { $dd = qy ($settings['blog_subtitle'],'full'); $sd = $dd['text-final']; $fd['subtitle']=$sd; $fd['subtitle-format-info']=$dd['meta']; y2 (@$dd['meta']['links-required']); } $fd['title']=htmlspecialchars (ev (), ENT_NOQUOTES,'UTF-8'); $fd['userpic-set?']=false; $fd['userpic-changeable?']=vs (); if ($fd['userpic-href']=tv ()) { $fd['userpic-set?']=true; $fd['userpic-large-href']=tv ('large'); $fd['userpic-square-href']=tv ('square'); $fd['userpic-changeable-href']=$fd['userpic-href']; } else { unset ($fd['userpic-href']); } if (vs ()) { $fd['userpic-upload-action']=kq ('e2j_userpic_upload'); $fd['userpic-remove-action']=kq ('e2j_userpic_remove'); } $fd['href']=kq ('e2m_frontpage', array ('page' => 1)); $fd['rss-href']=kq ('e2m_rss'); $fd['jsonfeed-href']=kq ('e2m_json'); $fd['language']=$_lang; $fd['show-follow-button?']=false; $fd['license-expired?']=false; $qd = array (time (), ia ()); $ld = b1 ('Y',$qd[0]); $fd['now']=$qd; $zd = $ld; $kd = cv ('start'); if(array_key_exists ('stamp',$kd)) { $zd = b1 ('Y',$kd['stamp']); $fd['start-time'] = array ((int)$kd['stamp'],$kd['timezone']); } $xd = false; $ed = bf (true,true); if ($ed !== null){ if (vs ()) { $rd = bf (true,false); if ($rd !== null){ $xd = ($ed + $rd == 0); } } else { $xd = ($ed == 0); } } $fd['notes-count'] = (int)$ed; if ($fd['notes-count']>0){ $fd['selected-href']=kq ('e2m_favourites', ['page' => 1]); $fd['most-commented-href']=kq ('e2m_most_commented', ['page' => 1]); $fd['popular-href']=kq ('e2m_popular', ['page' => 1]); $fd['calendar-href']=p (); $fd['random-note-href']=ff (); } $fd['virgin?']=$xd; $td = $_config['years_range_separator']? $_config['years_range_separator']:$_strings['gs--range-separator']; $fd['years-range']=$zd . (($zd == $ld)? '':($td . $ld)); if(AeEnv::$w){ $fd['parent-site-href']=substr (AeEnv::$w, (int)strpos ('/',AeEnv::$w)); } return $fd; } function ev () { global$settings,$_strings; if ( array_key_exists ('blog_title',$settings) and trim ($settings['blog_title']) != '' ) { return trim ($settings['blog_title']); } else { return$_strings['e2--default-blog-title']; } } function rv () { global$settings,$_strings; if ( array_key_exists ('author',$settings) and trim ($settings['author']) != '' ) { return trim ($settings['author']); } else { return$_strings['e2--default-blog-author']; } } function tv ($size = ''){ global$_config; $jd = false; $hd = $_config['path_media'].USERPIC_DIRNAME; if(is_file ($hd .'userpic@2x.jpg')) { $jd = 'userpic@2x.jpg'; } elseif(is_file ($hd .'userpic@2x.png')) { $jd = 'userpic@2x.png'; } if($size == 'large' and is_file ($hd .'userpic-large@2x.jpg')) { $jd = 'userpic-large@2x.jpg'; } elseif($size == 'square' and is_file ($hd .'userpic-square@2x.jpg')) { $jd = 'userpic-square@2x.jpg'; } if ($jd === false) return false; $gd = $hd . $jd; $wd = AeEnv::$base_url . USERPIC_DIRNAME . $jd; $ud = stat ($gd); if ($ud['mtime'])$wd .= '?'. $ud['mtime']; return $wd; } function jv () { global$_config,$_stopwatch,$id; $od = round (mq () - $_stopwatch,3); return [ 'show?' => ($_config['display_stat'] > (int) !vs ()), 'generation-time' => str_replace ('.',',',$od), 'peak-memory-mb' => str_replace ('.',',',round ((memory_get_peak_usage () / 1024 / 1024)*100)/100), 'db-query-count' => (int) @$id, ]; } function e2m_info () { global$settings,$_template; if (!isset ($_template))lf (); $pd = array ( 'E2_VERSION' => E2_VERSION, 'E2_RELEASE' => E2_RELEASE, 'E2_UA_STRING' => E2_UA_STRING, 'E2_EDITION' => defined ('E2_EDITION')? E2_EDITION : '0', '---', 'PHP_VERSION' => PHP_VERSION, '---', 'installed' => (vn () !== null), 'server_name' => AeEnv::$server, 'folder_on_server' => AeEnv::$w, '---', 'default formatter' => DEFAULT_FORMATTER, '---', 'theme' => $settings['template'], '---', 'Olba name' => $_template['name'], 'Olba stack' => $_template['stack'], '---', 'Neasden' => substr (md5 (file_get_contents ('system/neasden/neasden.php')), 0,4), '---', ); echo '<pre>'; foreach ($pd as $a3 => $q3){ if ($q3 == '---'){ echo "\n"; continue; } echo str_pad ($a3,24); echo '\''; print_r ($q3); echo '\''; echo "\n"; } echo '</pre>'; die; } function hv ($s){ global$_config; if (@$_config['broadcast_url'] and !$s['IsExternal']) { if($_config['log_broadcast']) { Log::$a = true; if(Log::$a)sn ('broadcast'); } if(Log::$a)__log ('Broadcast-async note: '. $s['Title']); $url = kq ('e2m_note_broadcast', array ('*note' => $s)); if(Log::$a)__log ('Broadcast will spawn url: '. $url); vv ($url); } } function gv ($cs){ global$_config; if (!$cs) return false; $url = $_config['broadcast_url']; $url .= '?src='. urlencode ($cs); if($_config['log_broadcast']) { Log::$a = true; if(Log::$a)sn ('broadcast'); } if(Log::$a)__log ('Broadcast: Curl '. $url .'...'); if(function_exists ('curl_init')) { $if_ = curl_init (); $of = !ini_get ('open_basedir'); curl_setopt_array ($if_, array ( CURLOPT_URL => $url, CURLOPT_CONNECTTIMEOUT => 300, CURLOPT_TIMEOUT => 1, CURLOPT_MAXREDIRS => 1, CURLOPT_COOKIE => ns (), CURLOPT_SSL_VERIFYPEER => false, CURLOPT_FOLLOWLOCATION => $of, CURLOPT_RETURNTRANSFER => true, CURLOPT_AUTOREFERER => true, CURLOPT_USERAGENT => E2_UA_STRING, )); $content = curl_exec ($if_); $pf = curl_errno ($if_); $c2 = curl_error ($if_); $v2 = curl_getinfo ($if_); curl_close ($if_); if(Log::$a)__log ('Broadcast: Curl returns: ['. print_r ($v2,true) .'] ['. $content .'], (errno='. $pf .', errstr='. $c2 .')...'); if ($pf === 0) return true; } else { if(Log::$a)__log ('Spawn: Curl functions are not available'); } return false; } function wv ($s){ if (!$s) return false; $cs = kq ('e2m_note_json', array ('*note' => $s)); return gv ($cs); } function e2m_note_broadcast ($parameters = array ()) { global$_config; if (@$_config['broadcast_url']) { if(array_key_exists ('*note',$parameters)) { $cs = kq ('e2m_note_json', array ('*note' => $parameters['*note'])); } elseif(array_key_exists ('alias',$parameters)) { $cs = kq ('e2m_note_json', array ('alias' => $parameters['alias'])); } if (gv ($cs)) { die ('Broadcasted.'); } else { die ('Could not broadcast.'); } } else { return e2m_error404 (); } } function e2_cache_filename_with_id_($ly,$hf){ return str_replace ('*',$ly,$hf); } function e2_note_cache_filename_with_id_($ly){ return e2_cache_filename_with_id_($ly,USER_DIR . CACHE_FILENAMES_NOTES); } function e2_drop_caches_for_note_($note_id,$vs){ if(is_numeric ($note_id)) { if(Log::$a)__log ('Caches: Drop caches for note id '. $note_id); @unlink (e2_note_cache_filename_with_id_($note_id)); @unlink (e2_note_cache_filename_with_id_($note_id .'-comments')); @unlink (e2_note_cache_filename_with_id_($note_id .'-comments-author')); } else { cq (USER_DIR . CACHE_FILENAMES_NOTES); cq (USER_DIR . CACHE_FILENAMES_NOTES_COMMENTS); cq (USER_DIR . CACHE_FILENAMES_NOTES_COMMENTS_AUTHOR); } vb (); if ($vs !== false){ bb (); cq (USER_DIR . CACHE_FILENAMES_NOTES_RELATED); cq (USER_DIR . CACHE_FILENAMES_POPULAR_WITH_TAG); cq (USER_DIR . CACHE_FILENAMES_TAG); cq (USER_DIR . CACHE_FILENAMES_TAG_AUTHOR); @unlink (USER_DIR . CACHE_FILENAME_POPULAR); @unlink (USER_DIR . CACHE_FILENAME_FRONTPAGE); @unlink (USER_DIR . CACHE_FILENAME_FRONTPAGE_AUTHOR); @unlink (USER_DIR . CACHE_FILENAME_FRONTPAGE_FEED); @unlink (USER_DIR . CACHE_FILENAME_FULLLIST); @unlink (USER_DIR . CACHE_FILENAME_TAGS); @unlink (USER_DIR . CACHE_FILENAME_TAGS_FULL); @unlink (USER_DIR . CACHE_FILENAME_TAGS_AUTHOR); @unlink (USER_DIR . CACHE_FILENAME_TAGS_AUTHOR_FULL); } if ($vs !== true){ @unlink (USER_DIR . CACHE_FILENAME_DRAFTS); @unlink (USER_DIR . CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); } @unlink (USER_DIR . CACHE_FILENAME_LASTMODIFIEDS); } function e2_drop_caches_for_tag_($bs){ if(is_numeric ($bs)) { @unlink (e2_cache_filename_with_id_($bs,USER_DIR . CACHE_FILENAMES_TAG)); @unlink (e2_cache_filename_with_id_($bs,USER_DIR . CACHE_FILENAMES_TAG_AUTHOR)); } else { cq (USER_DIR . CACHE_FILENAMES_TAG); cq (USER_DIR . CACHE_FILENAMES_TAG_AUTHOR); } @unlink (USER_DIR . CACHE_FILENAME_FAVTAGS); @unlink (USER_DIR . CACHE_FILENAME_TAGS); @unlink (USER_DIR . CACHE_FILENAME_TAGS_FULL); @unlink (USER_DIR . CACHE_FILENAME_TAGS_AUTHOR); @unlink (USER_DIR . CACHE_FILENAME_TAGS_AUTHOR_FULL); } function cb () { if(Log::$a)__log ('Caches: Drop notes caches'); e2_drop_caches_for_note_(null,null); } function vb () { if(Log::$a)__log ('Caches: Drop notes counts cache'); cq (USER_DIR . CACHE_FILENAMES_NOTES_COUNTS); } function bb () { if(Log::$a)__log ('Caches: Drop egde time info cache'); cq (USER_DIR . CACHE_FILENAMES_EDGE_TIMEINFO); } function e2_drop_all_kinds_of_cache () { if(Log::$a)__log ('Caches: Drop all kinds of caches'); cq (USER_DIR . CACHES_DIRNAME . '*'); return true; } function e2m_comment ($parameters = []) { q1 (kq ('e2m_note',$parameters)); } function e2m_comment_edit ($parameters = []) { return yb ('edit',$parameters); } function yb ($ys,$parameters = []) { global$_strings; $ns = $ms = $_strings['pt--new-comment']; $fs = 'new'; if ($ys == 'edit'){ $ds = e2_commentrec_with_parameters_($parameters); $ss = $_strings['fb--save-changes']; $sy = $ds['noterec']; $ns = $ms = $_strings['pt--edit-comment']; $as_ = mb ($sy,$ds,$parameters['comment-number']); if (!$ds){ return e2m_error404 (); } $qs = [ '.note-id' => $ds['NoteID'], '.comment-id' => $ds['ID'], '.comment-number' => $parameters['comment-number'], '.already-subscribed?' => false, '.gip' => $ds['GIP'], 'create:edit?' => false, 'form-action' => kq ('e2s_comment_process'), 'submit-text' => $ss, 'show-subscribe?' => true, 'subscribe?' => (bool)$ds['IsSubscriber'], 'name' => htmlspecialchars ($ds['AuthorName'],ENT_COMPAT,'UTF-8'), 'email' => htmlspecialchars ($ds['AuthorEmail'],ENT_COMPAT,'UTF-8'), 'text' => htmlspecialchars ($ds['Text'],ENT_COMPAT,'UTF-8'), 'email-field-name' => a (), ]; if ('' != trim ($ds['IP'])) { $qs['ip']=$ds['IP']; } } $cb = [ 'title' => $ns, 'heading' => $ms, 'form' => 'form-comment', 'form-comment' => $qs, ]; if (!empty ($as_)) { $cb['comments'] = ['each' => ['only' => $as_]]; } return $cb; } function e2m_comment_reply ($parameters = []) { global$_strings; $ds = e2_commentrec_with_parameters_($parameters); if (!$ds){ return e2m_error404 (); } $sy = $ds['noterec']; $as_ = mb ($sy,$ds,$parameters['comment-number']); $as_['replying?'] = (bool)true; $ls = ($ds['Reply']=='' or !$ds['IsReplyVisible']); $ns = $ls? $_strings['pt--reply-to-comment']:$_strings['pt--edit-reply-to-comment']; $zs = [ '.note-id' => $sy['ID'], '.comment-id' => $ds['ID'], '.reply-action' => $ls? 'new' : 'edit', 'form-action' => kq ('e2s_comment_edit_reply'), 'submit-text' => $ls? $_strings['fb--publish']:$_strings['fb--save-changes'], 'create:edit?' => (bool) ($ls), 'reply-text' => htmlspecialchars ($ds['Reply'],ENT_COMPAT,'UTF-8'), 'emailing-possible?' => MAIL_ENABLED, 'mail-back?' => (bool) ($ls), ]; return [ 'title' => $ns, 'heading' => $ns, 'comments' => ['each' => ['only' => $as_]], 'form' => 'form-comment-reply', 'form-comment-reply' => $zs, ]; } function e2m_comment_delete ($parameters = []) { global$_config; $ds = e2_commentrec_with_parameters_($parameters); $note_id = $ds['NoteID']; if (!$ds){ return e2m_error404 (); } e2_drop_caches_for_note_($note_id,true); @unlink (USER_DIR. '/last-comment.psa'); fm ( "DELETE FROM `". $_config['db_table_prefix']."Comments` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID` = '". ((int)$ds['ID']). "'" ); l1 (); } function e2m_comment_reply_delete ($parameters = []) { global$_strings,$settings,$_config; $ds = e2_commentrec_with_parameters_($parameters); if (!$ds){ return e2m_error404 (); } fm ( "UPDATE `". $_config['db_table_prefix']."Comments` SET ". "`Reply`='', ". "`IsReplyFavourite`='0' ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID`=".((int)$ds['ID']) ); l1 (); } function e2m_unsubscribe ($parameters){ global$_strings,$_config; $wf = "ORDER BY `ID` DESC"; $ks = false; $sy = $parameters['*note']; $note_id = $sy['ID']; $xs = $parameters['unsubscribe-email']; $es = $parameters['unsubscribe-key']; $xs = str_replace (' ','+',$xs); if($note_id){ fm ( "SELECT `ID`, `Stamp` FROM `". $_config['db_table_prefix']."Comments` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `NoteID`=". $note_id ." ". "AND `IsSubscriber`=1 ". "AND `AuthorEmail`='". am ($xs) ."' ". $wf, 'get subscriber’s comments ids' ); $e3 = sm (); if(count ($e3)<1) { $cb['unsubscribe']['error-message']=$_strings['gs--you-are-not-subscribed']; } else { $rs = @$e3[0]; $ts = md5 ($rs['ID'].$rs['Stamp'] .'x'); if ($es == $ts){ fm ( "UPDATE `". $_config['db_table_prefix']."Comments` ". "SET `IsSubscriber`=0 ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `NoteID`=". $note_id ." ". "AND `AuthorEmail` = '". am ($xs). "'", 'unsubscribe' ); $ks = true; $cb['unsubscribe']['note-title']=dy ( htmlspecialchars ($sy['Title'],ENT_COMPAT,'UTF-8') ); $cb['unsubscribe']['note-href']=kq ( 'e2m_note', ['*note' => $sy] ); } if (!$ks){ $cb['unsubscribe']['error-message']=$_strings['gs--unsubscription-didnt-work']; } } } else { $cb['unsubscribe']['error-message']=$_strings['gs--post-not-found']; } if ($ks){ $ns = $_strings['pt--unsubscription-done']; } else { $ns = $_strings['pt--unsubscription-failed']; } $cb['unsubscribe']['success?']=$ks; $cb['title']=$ns; $cb['heading']=$ns; return $cb; } function e2m_comment_flag ($parameters){ nb ($parameters); q1 (kq ('e2m_note',$parameters)); } function e2s_comment_flag_ajax ($parameters){ j1 ([ 'flag-name' => 'comment', 'candy-name' => 'e2s_comment_flag_ajax', 'parameters' => $parameters, 'flipping-function' => function () use ($parameters){ nb ($parameters); }, 'redirect-candy' => 'e2m_note', ]); } function nb ($parameters){ if($_SERVER['REQUEST_METHOD']!='POST'){ q1 (kq ('e2m_note',$parameters)); } ud (); $ds = e2_commentrec_with_parameters_($parameters); $note_id = $ds['NoteID']; if (!$ds) throw new AeException ('Comment record not cound from parameters'); e2_drop_caches_for_note_($note_id,true); nm ( cl (), 'Comments', [ 'ID' => $ds['ID'], $parameters['flag'] => (int) ($parameters['value']==1), ] ); } function e2s_comment_process () { global$_strings; $js = true; $hs = ''; try { $note_id = rb (); } catch (AeFormIncompleteException $e){ hb ($_strings['er--name-email-text-required'],E2E_USER_ERROR); q1 (kq ('e2m_note', ['*note' => hm ($e->note_id)])); } catch (AeFormNoteNotCommentableException $e){ $js = false; $gs = $_strings['gs--comment-post-not-commentable']; $ws = $_strings['gs--comment-post-not-commentable-description']; $hs = $e->comment_text; } catch (AeFormDuplicateCommentException $e){ $js = false; $gs = $_strings['gs--comment-double-post']; $ws = $_strings['gs--comment-double-post-description']; $hs = $e->comment_text; } catch (AeFormCommentTooLongException $e){ $js = false; $gs = $_strings['gs--comment-too-long']; $ws = $_strings['gs--comment-too-long-description']; $hs = $e->comment_text; } catch (AeFormCommentIsSpamSuspectException $e){ $js = false; $gs = $_strings['gs--comment-spam-suspect']; $ws = $_strings['gs--comment-spam-suspect-description']; $hs = $e->comment_text; } if ($js){ if($note_id){ q1 (kq ('e2m_note', ['*note' => hm ($note_id)])); } else { q1 (); } } else { $cb['title']=$gs; $cb['heading']=$gs; $cb['form']='form-unaccepted-comment'; $cb['form-unaccepted-comment'] = [ 'reason' => $ws, 'text' => @htmlspecialchars ($hs,ENT_COMPAT,'UTF-8'), ]; return $cb; } die; } function e2s_comment_edit_reply () { global$_config; ud (); $us = @$_POST['text']; if(trim ($us)=='')$us = ''; $note_id = @$_POST['note-id']; $sy = hm ($note_id); $fs = @$_POST['comment-id']; $ds = fb ($fs); $is = isset ($_POST['mail-back']); $os = time (); if (@$_POST['reply-action']=='new'){ $ps = time (); } @unlink (e2_note_cache_filename_with_id_($note_id .'-comments')); @unlink (e2_note_cache_filename_with_id_($note_id .'-comments-author')); if ($ds){ fm ( "UPDATE `". $_config['db_table_prefix']."Comments` SET ". "`Reply`='". am ($us) ."', ". ( isset ($ps)? ( "`ReplyStamp`='". $ps ."', " ) : ( "" ) ). "`ReplyLastModified`='". $os ."', ". "`IsReplyVisible`='1' ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID`=".((int)$fs), 'update comment reply' ); $ca = kq ('e2m_note', ['*note' => $sy]); if ($is and $us != ''){ $va['comment-time'] = [$ds['Stamp'],ia ()]; $va['commenter']=$ds['AuthorName']; $va['commenter-email']=$ds['AuthorEmail']; $va['comment-text']=$ds['Text']; $va['note-title']=dy ($sy['Title']); $va['reply-time'] = [time (), ia ()]; $va['blog-author']=rv (); $va['note-href']=$ca; $va['comment-href']=$ca; $va['reply-text']=$us; if(1){ $ba = ln ( 'comment-reply',$va ); $ya = e2l_get_string ( 'em--comment-reply', $va ); $na = $ds['AuthorEmail']; $ma = 'From: '. zn (); kn ($na,$ya,$ba,$ma); } if(1){ unset ($va['commenter-email']); $ma = 'From: '. zn (); foreach (kb ($sy,$ds['AuthorEmail']) as $fa){ $da = $fa['AuthorEmail']; $sa = md5 ($fa['ID'].$fa['Stamp'].'x'); $va['unsubscribe-href']=kq ('e2m_unsubscribe', [ '*note' => $sy, 'unsubscribe-email' => $da, 'unsubscribe-key' => $sa, ] ); $na = $da; $ba = ln ('comment-reply-to-public',$va); $ya = e2l_get_string ( 'em--comment-reply-to-public-subject', $va ); kn ($na,$ya,$ba,$ma); } } } q1 ($ca); } else { l1 (); } die; } function mb ($sy,$rs,$aa){ global$_config; if(Log::$a)__log ('Package comment '. $rs['ID'] .'...'); if ($sy === null){ $sy = hm ($rs['NoteID']); } $va['number']=$aa; $qa = !empty ($rs['IsGIPUsed']); $va['gip-used?']=$qa; $va['gip']=$va['gip-used?']?$rs['GIP']:''; $va['name']=htmlspecialchars ($rs['AuthorName'],ENT_NOQUOTES,'UTF-8'); $va['userpic-set?']=false; if ($qa){ $la = AVATARS_DIRNAME . $rs['GIP'] .'-'. $rs['GIPAuthorID'] .'.jpg'; if(is_file ($_config['path_media'].$la)) { $va['userpic-set?']=true; $va['userpic-href']=AeEnv::$base_url . $la; } } $va['name-href']=''; if ( $qa and $za = jy ( $rs['GIP'],$rs['GIPAuthorID'],$rs['AuthorProfileLink'] ) ) { $va['name-href']=$za; } if (vs ()) { $va['email']=htmlspecialchars ($rs['AuthorEmail'],ENT_NOQUOTES,'UTF-8'); if ('' != trim ($rs['IP'])) { $va['ip']=$rs['IP']; } } $va['author-name']=rv (); $va['new?']=false; $va['important?'] = (bool)$rs['IsFavourite']; $va['reply-visible?'] = (bool) ($rs['IsVisible'] && $rs['IsReplyVisible']); $va['reply-important?'] = (bool)$rs['IsReplyFavourite']; $va['spam-suspect?'] = (bool)$rs['IsSpamSuspect']; $ka = [(int)$rs['Stamp'],wa ($sy)]; $va['time']=$ka; $va['last-modified']=$ka; if ($rs['LastModified']) $va['last-modified'] = [(int)$rs['LastModified'],wa ($sy)]; if ($rs['ReplyStamp']) $va['reply-time'] = [(int)$rs['ReplyStamp'],wa ($sy)]; if ($rs['ReplyLastModified']) $va['reply-last-modified'] = [(int)$rs['ReplyLastModified'],wa ($sy)]; if (vs ()) { $va['subscriber?'] = (bool)$rs['IsSubscriber']; $va['new?'] = (bool)$rs['IsNew']; $va['first-new?']=false; if (!@$_config['read_only']) { $va['important-toggle-action']=kq ('e2s_comment_flag_ajax', [ '*note' => $sy,'comment-number' => $aa, 'flag' => 'IsFavourite', 'value' => !$rs['IsFavourite'] ]); $va['reply-important-toggle-action']=kq ('e2s_comment_flag_ajax', [ '*note' => $sy,'comment-number' => $aa, 'flag' => 'IsReplyFavourite', 'value' => !$rs['IsReplyFavourite'] ]); $va['edit-href']=kq ('e2m_comment_edit', [ '*note' => $sy,'comment-number' => $aa, ]); $va['removed-action']=kq ('e2s_comment_flag_ajax', [ '*note' => $sy,'comment-number' => $aa, 'flag' => 'IsVisible', 'value' => 0 ]); $va['removed-reply-action']=kq ('e2s_comment_flag_ajax', [ '*note' => $sy,'comment-number' => $aa, 'flag' => 'IsReplyVisible', 'value' => 0 ]); $va['replaced-action']=kq ('e2s_comment_flag_ajax', [ '*note' => $sy,'comment-number' => $aa, 'flag' => 'IsVisible', 'value' => 1 ]); $va['replaced-reply-action']=kq ('e2s_comment_flag_ajax', [ '*note' => $sy,'comment-number' => $aa, 'flag' => 'IsReplyVisible', 'value' => 1 ]); $xa = kq ('e2m_comment_reply', [ '*note' => $sy,'comment-number' => $aa ]); if ($rs['Reply']=='' or !$rs['IsReplyVisible']) { $va['reply-href']=$xa; } else { $va['edit-reply-href']=$xa; } } } if(mb_strlen ($rs['Text']) > $_config['max_comment_length']) { $rs['Text']=mb_substr ($rs['Text'],0,$_config['max_comment_length']); } $ea = $sy['FormatterID']==='raw' ? 'neasden' : $sy['FormatterID']; $dd = ay ($ea,$rs['Text'],'simple'); $va['text']=$dd['text-final']; $va['reply']=''; $va['replying?'] = (bool)false; $va['replied?'] = (bool) ( (trim ($rs['Reply']) != '') && ($rs['IsReplyVisible']) ); if ((string)$rs['Reply']!==''){ $dd = ay ($sy['FormatterID'],$rs['Reply'],'full'); $va['reply']=$dd['text-final']; } if(Log::$a)__log ('Comments: done'); return $va; } function fb ($ly){ global$_config; fm ( "SELECT * FROM `". $_config['db_table_prefix']."Comments` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID` = '". $ly ."'" ); $zb = sm (); if(count ($zb)>0){ return $zb[0]; } else { return false; } } function db ($s){ global$_strings,$_config,$settings; if (@$_config['read_only']) return null; if (!xb ($s)) return null; $ra = ly (); if (!count ($ra) and !empty ($settings['comments']['require_gip'])) return null; $ta = (string) @$_COOKIE[z1 ('commenter_name')]; $ja = (string) @$_COOKIE[z1 ('commenter_email')]; $ha = (string) @$_COOKIE[z1 ('commenter_ph')]; $ga = false; if ($ja and $ha){ foreach (kb ($s) as $fa){ $ts = md5 ($fa['ID'].$fa['Stamp'] .'x'); if ( $fa['AuthorEmail']==$ja and $ha == $ts ) { $ga = true; break; } } } $ss = $_strings['fb--submit']; $cn = q (); $qs = [ '.note-id' => $s['ID'], '.comment-id' => 'new', '.already-subscribed?' => (bool)$ga, 'cookie-name' => z ($s['ID']), 'cookie-value' => k (), 'email-field-name' => a (), 'nospam-field-name-part-1' => substr ($cn,0,4), 'nospam-field-name-part-2' => substr ($cn,4), 'create:edit?' => true, 'form-action' => kq ('e2s_comment_process'), 'submit-text' => $ss, 'show-subscribe?' => (bool) !$ga, 'emailing-possible?' => MAIL_ENABLED, 'subscribe?' => (bool)$ga, 'subscription-status' => $ga? $_strings['gs--you-are-already-subscribed']:'', 'name' => htmlspecialchars ($ta,ENT_COMPAT,'UTF-8'), 'email' => htmlspecialchars ($ja,ENT_COMPAT,'UTF-8'), 'text' => '', 'email-comments-enabled?' => empty ($settings['comments']['require_gip']), 'gips' => [], ]; $wa = false; $ua = ''; foreach ($ra as $ia){ if (!is_file (SYSTEM_DIR .'gips/'. $ia .'.json')) { continue; } $oa = ey ($ia); $qs['gips'][$ia]=xy ($ia); if ($oa){ $wa = true; $pa = hy ($ia); $ua = $pa['GIP']; $qs['name']=htmlspecialchars ( $pa['AuthorName'],ENT_COMPAT,'UTF-8' ); } } if (!$qs['email-comments-enabled?'] and !count ($qs['gips'])) { return false; } $qs['email-comments-only?'] = (count ($qs['gips']) === 0); $qs['logged-in?']=$wa; $qs['logged-in-gip']=$ua; $qs['logout-url']=$wa ? kq('e2m_gip_sign_out', array('provider' => E2GIP::get_logout_key())) : ''; return $qs; } function sb ($note_id){ return qb ($note_id,'`IsNew` = 1'); } function ab ($note_id){ return qb ($note_id,'`IsVisible` = 1'); } function qb ($note_id,$c1){ global$_config; if (!is_numeric ($note_id)) return 0; $v1 = 0; fm ( "SELECT count(*) ". "FROM `". $_config['db_table_prefix']."Comments` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `NoteID`=". $note_id ." ". "AND (". $c1. ")", 'count comments' ); $e3 = sm (); $e3 = (int)$e3[0]['count(*)']; $v1 = $e3; return (int)$v1; } function lb (AeDatabaseConfiguration $databaseConfiguration){ if(Log::$a)__log ('Count new comments'); $b1 = 0; $y1 = ''; fm ( "SELECT `NoteID`, `Text` FROM `". $databaseConfiguration -> getPrefix () . "Comments` ". "WHERE `SubsetID`=". $databaseConfiguration -> getSubset () ." ". "AND `IsNew`=1 ORDER BY `Stamp` DESC", 'count new comments for author menu' ); $e3 = sm (); $b1 = count ($e3); while ($b1-- > 0){ if ($sy = hm ($e3[$b1]['NoteID'])) { $y1 = kq ('e2m_note', ['*note' => $sy]); break; } } $b1 ++; return [(int)$b1,$y1]; } function zb ($note_id){ global$_config; if(Log::$a)__log ('Comments: getting comments for note '. $note_id); fm ( "SELECT c.*, g.`AuthorProfileLink` ". "FROM `". $_config['db_table_prefix']."Comments` c ". "LEFT JOIN `". $_config['db_table_prefix']."GIPsSessions` g ". "ON c.`SubsetID`=g.`SubsetID` ". "AND c.`GIP`=g.`GIP` ". "AND c.`GIPAuthorID`=g.`GIPAuthorID` ". "WHERE c.`SubsetID`=". $_config['db_table_subset'] ." ". "AND `NoteID`=". @$note_id . " ". "ORDER BY `Stamp`", 'get comments including deleted' ); $e3 = sm (); return $e3; } function kb ($sy,$n1 = ''){ global$_config; $wf = "ORDER BY `ID` DESC"; $cb = $m1 = []; fm ( "SELECT DISTINCT `ID`, `Text`, `IsSubscriber`, `IsVisible`, ". "`AuthorName`, `AuthorEmail`, `Stamp` ". "FROM `". $_config['db_table_prefix']."Comments` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `NoteID`=". @$sy['ID'] ." ". "AND `IsSubscriber`=1 ". "AND `IsVisible`=1 ". "AND `AuthorEmail`!='". am ($n1) ."' ". $wf, 'get subscribers by note' ); $e3 = sm (); foreach ($e3 as $fa){ if (!in_array ($fa['AuthorEmail'],$m1)) { $cb[] = $fa; } $m1[] = $fa['AuthorEmail']; } return $cb; } function xb ($sy,$f1 = NOTE_COMMENTABLE_NOW){ global$settings,$_config; $d1 = true; if (@$settings['comments']['fresh_only']) if (isset ($_config['comment_freshness_days'])) if ($sy['Stamp']<time () - $_config['comment_freshness_days']*SECONDS_IN_A_DAY) $d1 = false; $s1 = $sy['IsCommentable']; if ($f1 == NOTE_COMMENTABLE_NOW_CONDITIONALLY){ $s1 = true; } return ( nf ($sy)==='public' and $d1 and $s1 ); } function e2_commentrec_with_parameters_($parameters = []) { $sy = $parameters['*note']; $a1 = zb ($sy['ID']); $ds = @$a1[$parameters['comment-number']-1]; if ($ds){ $ds['noterec']=$sy; return $ds; } } function rb () { global$settings,$_config; if(Log::$a)__log ('Process comment form'); ud (); $oy = a (); $note_id = $fs = $name = $xs = $q1 = ''; if(array_key_exists ('note-id',$_POST)) $note_id = trim (@$_POST['note-id']); if(array_key_exists ('comment-id',$_POST)) $fs = trim (@$_POST['comment-id']); if(array_key_exists ('comment-number',$_POST)) $aa = trim (@$_POST['comment-number']); if(array_key_exists ('name',$_POST)) $name = trim (@$_POST['name']); if(array_key_exists ($oy,$_POST)) $xs = trim (@$_POST[$oy]); if(array_key_exists ('text',$_POST)) $q1 = trim (@$_POST['text']); if ($fs === 'new'){ $l1 = ty (); if ($l1){ $pa = hy ($l1); $name = trim ($pa['AuthorName']); $xs = ''; $z1 = $pa['GIPAuthorID']; } } else { if(array_key_exists ('gip',$_POST))$l1 = trim (@$_POST['gip']); } $k1 = ( (array_key_exists ('already-subscribed',$_POST) and $_POST['already-subscribed']) or (array_key_exists ('subscribe',$_POST) and $_POST['subscribe']) ); $hn = time (); if (!is_numeric ($note_id)) { throw new AeFormInconsistentException (); } if (!is_numeric ($fs) and $fs !== 'new'){ throw new AeFormInconsistentException (); } if ($fs !== 'new' and !vs ()) { throw new AeFormInconsistentException (); } if ( $q1 == '' or (!$l1 and ((string)$name === '' or (string)$xs === '')) ) { throw new AeFormIncompleteException ($note_id); } if ($fs == 'new' and !$l1){ k1 ('commenter_name',$name); k1 ('commenter_email',$xs); } $x1 = ($fs === 'new' and ( x () or e2_cookie_data_is_spam_suspicios_for_note_id_($note_id) )); if ($fs == 'new'){ $e1 = @unserialize (file_get_contents (USER_DIR. '/last-comment.psa')); if(md5 ($name . $xs . $q1) == @$e1['md5']) { throw new AeFormDuplicateCommentException ($q1); } if ( isset ($_config['max_comment_length']) and strlen (@$_POST['text']) > ($_config['max_comment_length']) ) { throw new AeFormCommentTooLongException ($q1); } $sy = hm ($note_id); if ($fs == 'new' and !xb ($sy)) { throw new AeFormNoteNotCommentableException ($q1); } if ($x1){ throw new AeFormCommentIsSpamSuspectException ($q1); } } e2_drop_caches_for_note_($note_id,true); if ($fs == 'new'){ $ds = [ 'NoteID' => (int)$note_id, 'AuthorName' => $name, 'AuthorEmail' => $xs, 'Text' => $q1, 'Reply' => '', 'IsVisible' => 1, 'IsAnswerAware' => 1, 'IsSubscriber' => (int)$k1, 'IsSpamSuspect' => (int)$x1, 'IsNew' => 1, 'Stamp' => (int)time (), 'LastModified' => (int)time (), 'IP' => am (id ()), 'IsGIPUsed' => intval (!empty ($l1) && !empty ($z1)), 'GIP' => !empty ($l1)?am ($l1):'', 'GIPAuthorID' => !empty ($z1)?am ($z1):'', ]; $ds = ym (cl (), 'Comments',$ds); $fs = $ds['ID']; $e1 = [ 'id' => $fs, 'md5' => md5 ($name . $xs . $q1), ]; @e3 (USER_DIR. 'last-comment.psa',serialize ($e1)); $r1 = md5 ($ds['ID'].$ds['Stamp'].'x'); k1 ('commenter_ph',$r1); $sy = hm ($note_id); $ca = kq ('e2m_note', ['*note' => $sy]); $va['comment-time'] = [$hn,ia ()]; $va['commenter']=$name; $va['commenter-email']=$xs; $va['comment-text']=$q1; $va['note-title']=$sy['Title']; $va['note-href']=$ca; $va['comment-href']=$ca; $va['comments-disable-href']=kq ('e2s_note_flag', [ '*note' => $sy, 'flag' => 'IsCommentable', 'value' => 0 ]); $va['reply-href']=kq ( 'e2m_comment_reply', [ '*note' => $sy, 'comment-number' => $aa ] ); if (isset ($settings['author_email']) and @$settings['notifications']['new_comments']) { $ba = ln ( 'comment-new-to-author',$va ); $ya = e2l_get_string ( 'em--comment-new-to-author-subject', $va ); $na = $settings['author_email']; $ma = 'From: '. zn () ."\r\n". 'Reply-to: '. $name .' <'. $xs .">"; kn ($na,$ya,$ba,$ma); } if (!$x1){ unset ($va['commenter-email']); $ma = 'From: '. zn (); foreach (kb ($sy,$xs) as $fa){ $da = $fa['AuthorEmail']; $sa = md5 ($fa['ID'].$fa['Stamp'].'x'); $va['unsubscribe-href']=kq ('e2m_unsubscribe', [ '*note' => $sy, 'unsubscribe-email' => $da, 'unsubscribe-key' => $sa ] ); $na = $da; $ba = ln ('comment-new-to-public',$va); $ya = e2l_get_string ( 'em--comment-new-to-public-subject', $va ); kn ($na,$ya,$ba,$ma); } } } else { $t1 = [ 'ID' => $fs, 'Text' => $q1, 'IsVisible' => 1, 'IsSubscriber' => ((int)$k1), 'LastModified' => time (), ]; if (!empty ($name))$t1['AuthorName']=$name; if (!empty ($xs))$t1['AuthorEmail']=$xs; nm (cl (), 'Comments',$t1); } return (int)$note_id; } define ('E2_UA_STRING','Aegea '. E2_RELEASE .' (v'. E2_VERSION . (defined ('E2_EDITION')?'e':'') .')'); define ('E2_MINIMUM_PHP','5.6'); define ('E2_MINIMUM_MYSQL','5.6'); define ('E2_MINIMUM_MARIADB','10.1'); define ('E2E_STRANGE_ERROR',10); define ('E2E_USER_ERROR',20); define ('E2E_PERMISSIONS_ERROR',30); define ('E2E_MESSAGE',100); define ('E2E_DIAGNOSTICS_MESSAGE',110); define ('DEFAULT_TEMPLATE','acute'); define ('DEFAULT_FORMATTER','neasden'); define ('E2_NEW_FILES_RIGHTS',0777); define ('E2_JSON_STYLE',JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE); define ('DEFAULT_ITEMS_PER_PAGE',10); define ('MAX_ITEMS_PER_PAGE',100); define ('SYSTEM_DIR','system/'); define ('SYSTEM_DEFAULTS_DIR','system/default/'); define ('SYSTEM_THEME_DIR','system/theme/'); define ('LANGUAGES_DIRNAME','languages/'); define ('LIBRARY_DIRNAME','library/'); define ('THEMES_DIRNAME','themes/'); define ('EXTRAS_DIRNAME','extras/'); define ('SCRIPTS_SUBDIR','js/'); define ('LOGS_DIRNAME','logs/'); define ('CACHES_DIRNAME','caches/'); define ('BACKUP_DIRNAME','backup/'); define ('MAIN_LOG_FILENAME','main.log'); define ('PICTURES_DIRNAME','pictures/'); define ('THUMBNAILS_DIRNAME','pictures/thumbs/'); define ('AVATARS_DIRNAME','pictures/avatars/'); define ('USERPIC_DIRNAME','pictures/userpic/'); define ('VIDEO_DIRNAME','video/'); define ('AUDIO_DIRNAME','audio/'); define ('LICENSE_FILENAME','license.psa'); define ('THUMB_WIDTH',180); define ('THUMB_HEIGHT',120); define ('THUMB_JPG_QUALITY',50); define ('SCALED_IMAGE_JPG_QUALITY',80); define ('USERPIC_WIDTH',80); define ('USERPIC_HEIGHT',80); define ('USERPIC_JPG_QUALITY',80); define ('VIDEO_ICON_FILENAME','images/video.svg'); define ('AUDIO_ICON_FILENAME','images/audio.svg'); define ('VIDEO_ICON_WIDTH',180); define ('VIDEO_ICON_HEIGHT',120); define ('AUDIO_ICON_WIDTH',120); define ('AUDIO_ICON_HEIGHT',120); define ('ALIAS_MAX_LENGTH',64); define ('CACHE_ALIASMAP',CACHE and true); define ('CACHE_NOTES',CACHE and true); define ('CACHE_NOTES_RELATED',CACHE and true); define ('CACHE_NOTES_COMMENTS',CACHE and true); define ('CACHE_POPULAR',CACHE and true); define ('CACHE_POPULAR_WITH_TAG',CACHE and true); define ('CACHE_RANDOM_NOTE',CACHE and true); define ('CACHE_TAGS',CACHE and true); define ('CACHE_FAVTAGS',CACHE and true); define ('CACHE_NOTES_COUNTS',CACHE and true); define ('CACHE_EDGE_TIMEINFO',CACHE and true); define ('CACHE_FRONTPAGE',CACHE and true); define ('CACHE_FRONTPAGE_FEED',CACHE and true); define ('CACHE_TAG',CACHE and true); define ('CACHE_FULLLIST',CACHE and true); define ('CACHE_DRAFTS',CACHE and true); define ('CACHE_DRAFTS_ALIAS_USE_COUNTS',CACHE and true); define ('CACHE_LASTMODIFIEDS',CACHE and true); define ('CACHE_INDEXED_FLAG',CACHE and true); define ('CACHE_FILENAME_ALIASMAP',CACHES_DIRNAME . 'aliasmap.psa'); define ('CACHE_FILENAMES_NOTES',CACHES_DIRNAME . 'note-*.psa'); define ('CACHE_FILENAMES_NOTES_RELATED',CACHES_DIRNAME . 'note-*-related.psa'); define ('CACHE_FILENAMES_NOTES_COMMENTS',CACHES_DIRNAME . 'note-*-comments.ctree.psa'); define ('CACHE_FILENAMES_NOTES_COMMENTS_AUTHOR',CACHES_DIRNAME . 'note-*-comments-author.ctree.psa'); define ('CACHE_FILENAMES_NOTES_COUNTS',CACHES_DIRNAME . 'notes-count-*.txt'); define ('CACHE_FILENAMES_EDGE_TIMEINFO',CACHES_DIRNAME . '*.e2time.psa'); define ('CACHE_FILENAME_POPULAR',CACHES_DIRNAME . 'popular.ctree.psa'); define ('CACHE_FILENAME_POPULAR_EXPIRES',CACHES_DIRNAME . 'popular-expires.txt'); define ('CACHE_FILENAME_RANDOM_NOTE',CACHES_DIRNAME . 'random-note.psa'); define ('CACHE_FILENAMES_POPULAR_WITH_TAG',CACHES_DIRNAME . 'popular-*.ctree.psa'); define ('CACHE_FILENAMES_POPULAR_WITH_TAG_EXPIRES',CACHES_DIRNAME . 'popular-*-expires.txt'); define ('CACHE_FILENAME_TAGS',CACHES_DIRNAME . 'tags.ctree.psa'); define ('CACHE_FILENAME_TAGS_FULL',CACHES_DIRNAME . 'tags-full.ctree.psa'); define ('CACHE_FILENAME_TAGS_AUTHOR',CACHES_DIRNAME . 'tags-author.ctree.psa'); define ('CACHE_FILENAME_TAGS_AUTHOR_FULL',CACHES_DIRNAME . 'tags-author-full.ctree.psa'); define ('CACHE_FILENAME_FAVTAGS',CACHES_DIRNAME . 'favtags.ctree.psa'); define ('CACHE_FILENAME_FRONTPAGE',CACHES_DIRNAME . 'frontpage.ctree.psa'); define ('CACHE_FILENAME_FRONTPAGE_AUTHOR',CACHES_DIRNAME . 'frontpage-author.ctree.psa'); define ('CACHE_FILENAME_FRONTPAGE_FEED',CACHES_DIRNAME . 'frontpage-feed.psa'); define ('CACHE_FILENAMES_TAG',CACHES_DIRNAME . 'tag-*.ctree.psa'); define ('CACHE_FILENAMES_TAG_AUTHOR',CACHES_DIRNAME . 'tag-*-author.ctree.psa'); define ('CACHE_FILENAME_FULLLIST',CACHES_DIRNAME . 'notes-list.ctree.psa'); define ('CACHE_FILENAME_DRAFTS',CACHES_DIRNAME . 'drafts.psa'); define ('CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS',CACHES_DIRNAME . 'drafts-auc.psa'); define ('CACHE_FILENAME_LASTMODIFIEDS',CACHES_DIRNAME . 'last-modifieds-by-id.psa'); define ('CACHE_FILENAME_INDEXED_FLAG',CACHES_DIRNAME . 'indexed.flag'); define ('FP_NO_ID_OR_NEW', -1); define ('FP_INSERT_ERROR', -10); define ('FP_UPDATE_ERROR', -11); define ('FP_EMPTY_FIELD', -20); define ('FP_TITLE_OR_TEXT_EMPTY', -21); define ('FP_NOT_COMMENTABLE', -30); define ('FP_COMMENT_DOUBLE_POST', -101); define ('FP_COMMENT_TOO_LONG', -102); define ('FP_COMMENT_SPAM_SUSPECT', -103); define ('NOTE_COMMENTABLE_NOW', -1); define ('NOTE_COMMENTABLE_NOW_CONDITIONALLY', -2); define ('SECONDS_IN_A_MINUTE',60); define ('SECONDS_IN_AN_HOUR',3600); define ('SECONDS_IN_A_DAY',86400); define ('SECONDS_IN_A_WEEK',604800); define ('SECONDS_IN_A_MONTH',2592000); define ('SECONDS_IN_A_YEAR',31536000); function e2m_drafts ($parameters){ global$_strings,$_config; $draftsView = new AePageableNotesView ('e2m_drafts',$parameters); $draftsView -> setPortionSize ((int)$_config['drafts_per_page']); $draftsView -> setNextPrevPageTitles ($_strings['gs--earlier'],$_strings['gs--later']); $draftsView -> setWantPaging (true); $draftsView -> setUseLocalHrefs (true); if($draftsView -> isFirstPage () and CACHE_DRAFTS){ $draftsView -> setCacheFilename (USER_DIR . CACHE_FILENAME_DRAFTS); } $draftsView -> setLimitlessSQLRequest ( "SELECT * ". "FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished`=0 ". "ORDER BY `LastModified` DESC" ); $j1 = $draftsView -> getNotesCTree (); if(count ($j1)) { if(Log::$a)__log ('Thumbnails {'); foreach ($j1 as $a3 => $q3){ $j1[$a3]['thumbs']=k2 (@$q3['format-info']['resources-detected']); } if(Log::$a)__log ('}'); } $ns = $_strings['pt--drafts']; if($parameters['page']>1){ $ns .= ' ('. $_strings['gs--page'] .' '. $parameters['page'] .')'; } $cb = [ 'title' => $ns, 'heading' => $_strings['pt--drafts'], 'notes' => $j1, 'pages' => $draftsView -> getPagesCTree (), ]; if(count ($j1) >= 5){ $cb['secret-link-promo']=e2l_get_string ( 'pm--secret-link', ['url' => $_config['paid_features_url']] ); } if($draftsView -> isFirstPageOfEmptyView ()) { $cb['nothing']=$_strings['gs--no-drafts']; } elseif (!$draftsView -> isExistingPage ()) { return e2m_error404 (); } return $cb; } function tb ($h1){ global$_config; if(Log::$a)__log ('Drafts: find duplicate OriginalAliases...'); if(CACHE_DRAFTS_ALIAS_USE_COUNTS and is_file (USER_DIR . CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS)) { $g1 = @unserialize (file_get_contents (USER_DIR . CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS)); } if(CACHE_DRAFTS_ALIAS_USE_COUNTS and @is_array ($g1)) { if(Log::$a)__log ('Drafts: retrieve cached'); } else { if(Log::$a)__log ('Drafts: assemle cacheable...'); $g1 = array (); fm ( "SELECT `OriginalAlias` FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished`=0 ". "ORDER BY `ID`", 'get original aliases of drafts to calculate use counts' ); $e3 = sm (); $kn = array (); foreach ($e3 as $a3 => $sy){ @$g1[$sy['OriginalAlias']] ++; } if(CACHE_DRAFTS_ALIAS_USE_COUNTS){ e3 (USER_DIR . CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS,serialize ($g1)); } } return $g1[$h1]; } function jb () { global$_strings; $w1 = 'https://'. $_strings['e2--website-host'] .'/'; $u1 = '('. $_strings['e2--release'] .' '. E2_RELEASE .', v'. E2_VERSION .')'; return [ 'built?' => BUILT, 'installed?' => (vn () !== null), 'version' => 'v'. E2_VERSION, 'version-description' => $_strings['e2--vname-aegea'] .' '. $u1, 'user-folder-name' => wq (), 'cookie-prefix' => z1 (), 'href' => $w1, 'about' => ( '<span title="E2 '.$u1 .'">'. $_strings['e2--powered-by'] .' '. '<a href="'. $w1 .'" class="nu"><u>'. $_strings['e2--vname-aegea'] .'</u> '. '<span class="e2-svgi">'. of ('aegea') .'</span></a></span>' ), ]; } function hb ($i1,$type = E2E_STRANGE_ERROR){ global$errors,$_config; if (!isset ($errors))$errors = []; $o1 = (!vs ()+1 <= (int)$_config['show_call_stack']); if ($i1){ if ($i1[0]!='<')$i1 = '<p>' . $i1 .'</p>'; $p1 = array ( 'description' => $i1, 'type' => $type, ); if($type == E2E_STRANGE_ERROR and $o1){ $p1['backtrace']=debug_backtrace (); } $errors[] = $p1; } return true; } function gb ($cq){ global$_strings; if(count ($cq)==0) return false; $vq = ''; $vq .= '<p>'. $_strings['gs--enable-write-permissions-for-the-following'] .'</p>'; $vq .= '<ul>'; foreach ($cq as $tv){ if ($tv == '.')$tv = ''; $vq .= '<li><tt>./'. $tv .'</tt></li>'; } $vq .= '</ul>'; return $vq; } function wb ($bq,$i1,$yq = false,$nq = false,$mq = []) { global$errors; if (!(error_reporting () & $bq) or ($bq & 8)) return; $yq = str_replace (__DIR__,'',$yq); hb ($yq .', line '. $nq .'<br />Error '. $bq .': '. $i1); $errors[count ($errors)-1]['phpcode']=$bq; } function ub ($fq,$dq,$n2,$om){ if (!(error_reporting () & $fq)) return; throw new ErrorException($dq,0,$fq,$n2,$om); } function ib () { global$errors,$_config; if (!isset ($errors))$errors = []; @session_start (); if(is_array (@$_SESSION['errors'])) { $e = array_merge (@$_SESSION['errors'],$errors); } else { $e = $errors; } $o1 = (!vs ()+1 <= (int)$_config['show_call_stack']); if (@$_config['store_backtrace'] and $o1 and $e != NULL){ @e3 ('backtrace.psa',serialize ($e)); } else { @unlink ('backtrace.psa'); } if (isset ($_SESSION['errors'])) unset($_SESSION['errors']); $cb = array (); $sq = false; if(count ($e)>0){ foreach($e as $rb => $aq){ if ($aq['type']==E2E_STRANGE_ERROR){ $aq['class']='serious'; $sq = true; if ($o1){ $aq['backtrace']=pb ($aq['backtrace']); } } if ($aq['type']==E2E_MESSAGE){ $aq['class']='info'; } $e[$rb]=$aq; } $cb['each']=$e; if ( $sq and @$_config['store_backtrace'] and $o1 and is_file ('debug.php') ) { $cb['debug-link']='debug.php'; } } return $cb; } function ob () { $errors = ib (); foreach($errors['each'] as $qq){ echo '<p>'. $qq['description'] .'</p>'; } die; } function pb ($lq){ if (!is_array ($lq)) return 'No backtrace info'; $lq = array_reverse ($lq); $lq = array_splice ($lq,0,count ($lq)-1); $e = '<p style="background: #fea; padding: .25em .5em; line-height: 1em; overflow: hidden">'; foreach ($lq as $rb => $zq){ $kq = @$zq['args'] or $kq = array (); $xq = array (); foreach ($kq as $eq){ $xq[] = var_export ($eq,true); } $n2 = @$zq['file']; $n2 = str_replace ($_SERVER['DOCUMENT_ROOT'],'',$n2); $om = (@$zq['line']? (' #'. $zq['line']) : '?'); $e .= '<div style="margin: .25em 0 .5em '. $rb*3 .'em">'; $e .= '<span style="float: right; color: #666"> '. $n2 . $om .'</span>'; $e .= '<tt><b>'. @$zq['function'] .' (</b>'; if(count ($xq)) { $rq = str_replace ("array (\n)",'array ()',$xq); $rq = implode (', ',$rq); if(0){ $rq = highlight_string ('<?'. $rq .'?'.'>',true); $rq = substr ($rq,77, -28); } $rq = str_replace ('&nbsp;',' ',$rq); $rq = nl2br ($rq); $e .= '<div style="margin: 0 0 0 1.12em">'. $rq .'</div>'; } $e .= '<b>)</b> &rarr;</tt></div>'; } $e .= '</p>'; return$e; } class AeException extends \Exception {} class AeMySQLException extends AeException {} class AeMySQLNotFoundException extends AeMySQLException {} class AeMySQLTooOldException extends AeMySQLException {} class AeMySQLCannotConnectException extends AeMySQLException {} class AeMySQLAccessDeniedException extends AeMySQLCannotConnectException {} class AeMySQLQueryException extends AeMySQLException {} class AeMySQLNoDataException extends AeMySQLException {} class AeMySQLNotMigrateableException extends AeMySQLException {} class AeMySQLCorruptedUpdateRecordCallException extends AeMySQLException {} class AeRecordNotFoundException extends AeException {} class AeInstallException extends AeException {} class AeInstallAlreadyInstalledException extends AeInstallException {} class AeInstallDatabaseOccupiedException extends AeInstallException {} class AeWritePermissionsException extends AeException {} class AeNotSavedException extends AeWritePermissionsException {} class AeTokenException extends AeException {} class AeOlbaException extends AeException {} class AeOlbaTemplateMissingException extends AeOlbaException {} class AeStubException extends AeException {} class AeFormException extends AeException {} class AeFormInconsistentException extends AeFormException {} class AeFormIncompleteException extends AeFormException { public $note_id = ''; function __construct ($note_id){ $this->note_id = $note_id; parent::__construct (); } } class AeFormCommentUnacceptableException extends AeFormException { public $comment_text = ''; function __construct ($comment_text){ $this->comment_text = $comment_text; parent::__construct (); } } class AeFormDuplicateCommentException extends AeFormCommentUnacceptableException {} class AeFormCommentTooLongException extends AeFormCommentUnacceptableException {} class AeFormNoteNotCommentableException extends AeFormCommentUnacceptableException {} class AeFormCommentIsSpamSuspectException extends AeFormCommentUnacceptableException {} function c3 ($tq,$jq = false){ $hq = substr (__DIR__,0,strrpos (__DIR__,'/')); $gq = ''; $wq = []; foreach(array_reverse ($tq -> getTrace ()) as $uq){ $iq['where']=str_replace ( $hq .'/','',$uq['file'] ) .':'. $uq['line']; $oq = []; foreach ($uq['args'] as $pq){ $oq[] = htmlspecialchars ( str_replace ("\n","\n  ",var_export ($pq,true)), ENT_NOQUOTES,'UTF-8' ); } $cl = ''; if(count ($oq)) { $cl = ("\n". '  '. implode (",\n  ",$oq). "\n" ); } $iq['call']=$uq['function'] .' ('. $cl .')'; $wq[] = $iq; } do { if ((string)$tq -> getMessage () !== ''){ $gq .= $tq -> getMessage () ."\n"; } $gq .= "\n";; $gq .= ( get_class ($tq) .' in '. str_replace ( $hq .'/','',$tq -> getFile () ) .':'. $tq -> getLine (). "\n" ); if ($tq -> getCode ()) { $gq .= 'Code: '. $tq -> getCode () ."\n"; } $vl = ''; $rb = 1; foreach ($wq as $om){ $vl .= $rb++ .'. '. $om['where'] .' '. $om['call']. "\n"; if (!$jq)$vl .= "\n";; } $gq .= "\n";; } while ($tq = $tq -> getPrevious ()); if ($jq){ $vl = preg_replace ('/^.*?$/smu','│            $0',$vl); $gq .= '┌─'. "\n"; $gq .= $vl; $gq .= '└─'; } else { $gq .= $vl; } return $gq; } function v3 ($tq,$dq = ''){ global$_config; if($_config['dev_verbose'] > (int) !vs ()) { hb ('<pre>'. c3 ($tq) .'</pre>'); } if($_config['log_errors']) { Log::$a = true; if(Log::$a)sn ('error-$'); } if(Log::$a)__log ('Exception caught: '. c3 ($tq,true)); if(Log::$a)sn (''); if ((string)$dq !== ''){ if(Log::$a)__log ($dq); } } function b3 ($tq){ global$_config,$content; $content['title']=':-('; $content['exception-message']=$tq -> getMessage (); $bl['error']['message']=':-('; if (($_config['dev_verbose'] > (int) !vs ())) { $content['exception-string']=c3 ($tq); $bl['error']['message']=nl2br (c3 ($tq)); } if($_config['log_errors']) { Log::$a = true; if(Log::$a)sn ('error-$'); } if(Log::$a)__log ('Panic: '. c3 ($tq,true)); if(Log::$a)__log (':-('); if(array_key_exists ('result',$_POST) and ($_POST['result']=='ajaxresult')) { $cb = json_encode ($bl); } else { $cb = tf ('panic',true); } echo $cb; die; } function y3 ($tq){ b3 ($tq); } function e2m_most_commented ($parameters = []) { global$settings,$_strings,$_config; $rn = vs (); $mostCommentedView = new AePageableNotesView ('e2m_most_commented',$parameters); $mostCommentedView -> setPortionSize ($settings['appearance']['notes_per_page']); $mostCommentedView -> setNextPrevPageTitles ($_strings['gs--earlier'],$_strings['gs--later']); $mostCommentedView -> setWantNewCommentsCount ($rn); $mostCommentedView -> setWantReadHrefs ($_config['count_reads']); $mostCommentedView -> setWantControls ($rn and !@$_config['read_only']); $mostCommentedView -> setWantHiddenTags ($rn); AeMainMenuManager :: $isMostCommentedCurrent = $mostCommentedView->isFirstPage (); AeMainMenuManager :: $isMostCommentedParent = !$mostCommentedView->isFirstPage (); $yl = $_config['hot_period']; $nl = time () - n3 ($_config['hot_period']); $mostCommentedView -> setLimitlessSQLRequest ( "SELECT * ". "FROM `". $_config['db_table_prefix'] ."Notes` n ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished`=1 ". mf ($rn). "AND `ID` IN ( ". "SELECT `NoteID` FROM ( ". "SELECT `NoteID`, COUNT(*) `CommentsCount` ". "FROM `". $_config['db_table_prefix']."Comments` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsVisible` = 1 ". "AND `Stamp` > ". $nl . " ". "GROUP BY `NoteID` ". "ORDER BY `CommentsCount` DESC ". ") As MostCommentedNotesIDs ". ")" ); $cb = [ 'title' => e2l_get_string ('pt--most-commented', ['period' => $yl]), 'heading' => e2l_get_string ('pt--most-commented', ['period' => $yl]), 'notes' => $mostCommentedView -> getNotesCTree (), 'pages' => $mostCommentedView -> getPagesCTree (), ]; if($mostCommentedView -> isFirstPageOfEmptyView ()) { $cb['nothing']=$_strings['gs--no-such-notes']; } elseif (!$mostCommentedView -> isExistingPage ()) { return e2m_error404 (); } return $cb; } function e2m_favourites ($parameters = []) { global$settings,$_config,$_strings; $rn = vs (); $favouritesView = new AePageableNotesView ('e2m_favourites',$parameters); $favouritesView -> setPortionSize ($settings['appearance']['notes_per_page']); $favouritesView -> setNextPrevPageTitles ($_strings['gs--earlier'],$_strings['gs--later']); $favouritesView -> setWantPaging (true); $favouritesView -> setWantNewCommentsCount ($rn); $favouritesView -> setWantReadHrefs ($_config['count_reads']); $favouritesView -> setWantControls ($rn and !@$_config['read_only']); $favouritesView -> setWantHiddenTags ($rn); AeMainMenuManager :: $isFavouritesCurrent = $favouritesView->isFirstPage (); AeMainMenuManager :: $isFavouritesParent = !$favouritesView->isFirstPage (); $favouritesView -> setLimitlessSQLRequest ( "SELECT * ". "FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished`=1 ". "AND `IsFavourite`=1 ". mf ($rn). "ORDER BY `Stamp` DESC" ); $ns = $_strings['pt--favourites']; if($parameters['page']>1){ $ns .= ' ('. $_strings['gs--page'] .' '. $parameters['page'] .')'; } $cb = [ 'title' => $ns, 'heading' => $_strings['pt--favourites'], 'notes' => $favouritesView -> getNotesCTree (), 'pages' => $favouritesView -> getPagesCTree (), ]; if($favouritesView -> isFirstPageOfEmptyView ()) { $cb['nothing']=$_strings['gs--no-favourites']; } elseif (!$favouritesView -> isExistingPage ()) { return e2m_error404 (); } return $cb; } function n3 ($yl){ if ('year' == $yl) return SECONDS_IN_A_YEAR; elseif ('month' == $yl) return SECONDS_IN_A_MONTH; elseif ('week' == $yl) return SECONDS_IN_A_DAY * 7; elseif ('day' == $yl) return SECONDS_IN_A_DAY; else return PHP_INT_MAX; } function e2m_json ($parameters = array ()) { list ($ml,$hn)=q3 (); $fl = json_encode ($ml,E2_JSON_STYLE); x3 ($fl,$hn,'json'); } function e2m_rss ($parameters = array ()) { list ($ml,$hn)=q3 (); $dl = e2feeds__rss_using_jsonfeed_array_($ml); x3 ($dl,$hn,'rss'); } function e2m_tag_json ($parameters = array ()) { if(array_key_exists ('*tag',$parameters)) { $tb = $parameters['*tag']; } else { return e2m_error404 (); } list ($ml,$hn)=l3 ($tb); $fl = json_encode ($ml,E2_JSON_STYLE); x3 ($fl,$hn,'json'); } function e2m_tag_rss ($parameters = array ()) { if(array_key_exists ('*tag',$parameters)) { $tb = $parameters['*tag']; } else { return e2m_error404 (); } list ($ml,$hn)=l3 ($tb); $dl = e2feeds__rss_using_jsonfeed_array_($ml); x3 ($dl,$hn,'rss'); } function e2m_note_json ($parameters = array ()) { global$settings,$_current_url; $sy = $parameters['*note']; if ($sy == false) return e2m_error404 (); $rn = vs (); if (!( nf ($sy)==='public' or ($rn and $sy['IsPublished']) )) return e2m_error404 (); $hn = $sy['Stamp']; $sl = e2_jsonfeed_item_array_from_noterec_($sy); $al = array ($sl); $ml = e2_jsonfeed_array_stub_from_jsonfeed_item_arrays_($al); $ml['title']=ev (); $ml['_rss_description']=a3 (); $ml['home_page_url']=kq ('e2m_frontpage', array ('page' => 1)); $ml['feed_url']=$_current_url; x3 (json_encode ($ml,E2_JSON_STYLE),$hn,'json'); } function e2_jsonfeed_array_stub_from_jsonfeed_item_arrays_($al){ global$_lang,$_config,$settings; $cb = [ 'version' => 'https://jsonfeed.org/version/1.1', 'title' => null, '_rss_description' => null, '_rss_language' => $_lang, '_itunes_email' => '', '_itunes_categories_xml' => '', '_itunes_image' => '', '_itunes_explicit' => '', 'home_page_url' => null, 'feed_url' => null, 'icon' => tv (), 'authors' => [[ 'name' => rv (), 'url' => kq ('e2m_frontpage', array ('page' => 1)), 'avatar' => tv (), ]], 'items' => $al, '_e2_version' => E2_VERSION, '_e2_ua_string' => E2_UA_STRING, ]; return $cb; } function e2_jsonfeed_item_array_from_noterec_($sy){ $url = kq ('e2m_note', array ('*note' => $sy)); $ql = ( b1 ('Y-m-d\TH:i:s',$sy['Stamp']) . s1 ($sy['Stamp'],':') ); $ll = ( b1 ('Y-m-d\TH:i:s',$sy['LastModified']) . s1 ($sy['LastModified'],':') ); $zl = ( b1 ('D, d M Y H:i:s ',$sy['Stamp']) . s1 ($sy['Stamp']) ); $dd = ay ($sy['FormatterID'], @$sy['Text'],'full-rss'); $noteView = new AeNoteView ($sy); $j3 = $noteView -> getNoteCTree (); $v3 = $j3['og-images']; $kl = []; foreach ($j3['tags'] as $hv){ $kl[] = $hv['name']; } $v = array ( 'id' => (string)$sy['ID'], 'url' => $url, 'title' => dy ($sy['Title']), 'content_html' => $dd['text-final'], 'date_published' => $ql, 'date_modified' => $ll, 'tags' => $kl ); if ($sy['IsExternal']) { $xl = cn ($sy); $v['url']=$xl['href-external']; $v['author'] = array ( 'name' => $xl['author'], 'url' => $xl['author-href'], 'avatar' => $xl['userpic-href'], ); } if(count ($v3)>0){ $v['image']=$v3[0]; } $v['_date_published_rfc2822']=$zl; $v['_rss_guid_is_permalink']='false'; $v['_rss_guid'] = (string)$sy['ID']; $v['_e2_data'] = array ( 'is_favourite' => (bool)$sy['IsFavourite'], 'links_required' => $dd['meta']['links-required'], 'og_images' => $v3, ); return $v; } function d3 ($el,$ns,$y1){ global$_newsfeeds; if (!isset ($_newsfeeds))$_newsfeeds = []; $rl = ''; if ($el == 'rss')$rl = 'application/rss+xml'; if ($el == 'json')$rl = 'application/json'; $_newsfeeds[] = [ 'type' => $rl, 'title' => htmlspecialchars ($ns,ENT_NOQUOTES,'UTF-8'), 'href' => $y1 ]; } function s3 () { global$_config; fm ( "SELECT * FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished`=1 ". mf (). "ORDER BY `Stamp` DESC ". "LIMIT ". $_config['rss_items'], 'get recent public noterecs for RSS or JSONFeed' ); return sm (); } function a3 () { global$settings; if (!empty ($settings['meta_description'])) { $tl = strip_tags (dy (htmlspecialchars ($settings['meta_description'],ENT_NOQUOTES,'UTF-8'))); } elseif (!empty ($settings['blog_subtitle'])) { $dd = qy ($settings['blog_subtitle'],'full'); $tl = $dd['text-final']; $tl = yf ($tl); } else { $tl = ev (); } return $tl; } function q3 () { global$settings,$_current_url; $hn = 0; $al = array (); $ml = array (); $gf = USER_DIR . CACHE_FILENAME_FRONTPAGE_FEED; if(CACHE_FRONTPAGE_FEED and is_file ($gf)) { if(Log::$a)__log ('Feed array (RSS, JSON): cached'); $ml = @unserialize (file_get_contents ($gf)); $hn = filemtime ($gf); } else { if(Log::$a)__log ('Feed array (RSS, JSON): not cached, will need to build'); $bf = s3 (); foreach ($bf as $sy){ $al[] = e2_jsonfeed_item_array_from_noterec_($sy); $hn = max ($hn,$sy['Stamp']); } $ml = e2_jsonfeed_array_stub_from_jsonfeed_item_arrays_($al); $ml['title']=ev (); $ml['_rss_description']=a3 (); $ml['home_page_url']=kq ('e2m_frontpage', array ('page' => 1)); $ml['feed_url']=$_current_url; if(CACHE_FRONTPAGE_FEED)e3 ($gf,serialize ($ml)); } return array ($ml,$hn); } function l3 ($tb){ global$_config,$_strings,$_current_url; $hn = 0; $al = array (); fm ( "SELECT n.* ". "FROM `". $_config['db_table_prefix']."Notes` n ". "INNER JOIN `". $_config['db_table_prefix']."NotesKeywords` nk ". "ON nk.`NoteID` = n.`ID` ". "WHERE n.`SubsetID`=". $_config['db_table_subset'] ." ". "AND nk.`SubsetID`=". $_config['db_table_subset'] ." ". "AND (nk.`KeywordID` = ". $tb['ID'] .") ". "AND n.`IsPublished` = 1 ". mf (vs ()). "ORDER BY n.`Stamp` DESC ". "LIMIT ". $_config['rss_items'], 'get tag noterecs for RSS or JSONFeed' ); $bf = sm (); foreach ($bf as $sy){ $al[] = e2_jsonfeed_item_array_from_noterec_($sy); $hn = max ($hn,$sy['Stamp']); } if ((string)$tb['Summary']!==''){ $tl = strip_tags (dy (htmlspecialchars ($tb['Summary'],ENT_NOQUOTES,'UTF-8'))); } else if ((string)$tb['Description']!==''){ $dd = qy ($tb['Description'],'full'); $tl = $dd['text-final']; $tl = yf ($tl); } else { $tl = a3 (); } $jl = htmlspecialchars ($tb['PageTitle'],ENT_COMPAT,'UTF-8'); if ((string)$jl !== ''){ $ns = $jl; } else { $ns = ( ev () .': '. $_strings['gs--posts-tagged'] .' '. htmlspecialchars ($tb['Keyword'],ENT_COMPAT,'UTF-8') ); } $ml = e2_jsonfeed_array_stub_from_jsonfeed_item_arrays_($al); $ml['title']=$ns; $ml['_rss_description']=$tl; $ml['home_page_url']=kq ('e2m_tag', array ('*tag' => $tb)); $ml['feed_url']=$_current_url; return array ($ml,$hn); } function e2feeds__rss_using_jsonfeed_array_($content){ $hl = USER_DIR . 'rss/rss.tmpl.php'; if (!is_file ($hl)) { $hl = SYSTEM_DEFAULTS_DIR . 'rss/rss.tmpl.php'; } if(is_file ($hl)) { ob_start (); include $hl; $dl = ob_get_contents (); ob_end_clean (); } return $dl; } function k3 ($dl){ $dl = str_replace ("\x0",'',$dl); for ($rb = 0; $rb < strlen ($dl); ++$rb){ if(ord ($dl[$rb]) < 32 and !in_array (ord ($dl[$rb]), array (10,13))) { $dl[$rb]=''; } } return $dl; } function x3 ($gl,$hn,$el){ global$_config; $wl = gmdate ('r',$hn); $ul = md5 ($hn); if ($el == 'rss'){ if (@$_config['dev_xml_as_text']) { header ('Content-Type: text/plain'); } else { header ('Content-Type: application/xml; charset=utf-8'); } } elseif ($el == 'json'){ header ('Content-Type: application/json'); } else { header ('Content-Type: text/plain'); } header ('Last-modified: '. $wl); header ('Etag: '. $ul); header ('Cache-Control: public'); header ('Expires: '. date ('r',$hn + SECONDS_IN_A_DAY)); $il = isset($_SERVER['HTTP_IF_MODIFIED_SINCE'])? stripslashes ($_SERVER['HTTP_IF_MODIFIED_SINCE']) : false; $ol = isset($_SERVER['HTTP_IF_NONE_MATCH'])? stripslashes ($_SERVER['HTTP_IF_NONE_MATCH']) : false; if ( !$il && !$ol or $ol && $ol != $ul or $il && $il != $wl ) { if ($el == 'rss'){ $gl = k3 ($gl); } ini_set ('zlib.output_compression',0); echo $gl; ini_set ('zlib.output_compression',1); } else { header ('HTTP/1.1 304 Not Modified'); } die; } define ('CROP_NONE',0); define ('CROP_SQUARE',1); function e3 ($n2,$pl){ @bq (dirname ($n2)); if (!@file_put_contents ($n2,$pl,LOCK_EX)) { return false; } @chmod ($n2,E2_NEW_FILES_RIGHTS); return true; } function e2s_retrieve ($parameters){ $url = base64_decode (strtr ($parameters['url'],'-_','+/')); if(Log::$a)__log ('Retrieve: '. $url); t2 ($url,PROVIDE_MEDIA_NOW); die; } function r3 ( $jy,$c4,$ib ){ $v4 = []; if(is_array ($ib)) { $v4 = a2 ($ib); } $b4 = @unserialize ( $c4['Uploads'] ) or $b4 = []; $y4 = array_diff ($v4,$b4); if(count ($y4)>0){ u3 ($jy,$c4['ID'],'add',$y4); } return $y4; } function t3 ($n4){ $rv = []; foreach (z2 ($n4) as $m4){ $rv[] = $m4['src']; } return $rv; } function j3 ($name,$f4){ global$_config; $name = e1 ($name); if(preg_match('//u',$name))$name = bl ($name,false); if ($f4 == 'image'){ $w = $_config['path_media'].PICTURES_DIRNAME; } elseif ($f4 == 'video'){ $w = $_config['path_media'].VIDEO_DIRNAME; } elseif ($f4 == 'audio'){ $w = $_config['path_media'].AUDIO_DIRNAME; } else { return false; } $d4 = ''; for ($rb = 0; $rb < strlen ($name); $rb++) { if($name[$rb]=='?'){ $d4 .= ''; } elseif($name[$rb]==' '){ $d4 .= '-'; } elseif(ord ($name[$rb]) <= 127){ $d4 .= $name[$rb]; } } if ($d4 == '')$d4 = $f4; if ($d4[0]=='.')$d4 = $f4 . $d4; return $d4; } function h3 ($s4){ global$_config; if(Log::$a)__log ('Count references for upload <'. $s4 .'>'); if(is_file (USER_DIR . 'new-uploads.psa')) { $a4 = @unserialize (file_get_contents (USER_DIR . 'new-uploads.psa')); } $q4 = '%'. str_replace ('%','#%',$s4) .'%'; fm ( "SELECT `ID`, `Text`, `FormatterID`, `Uploads` ". "FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND (`Text` LIKE '". $q4 ."' ESCAPE '#' ". "OR `Uploads` LIKE '". $q4 ."' ESCAPE '#')", 'get notes where uploads may be referenced' ); $e3 = sm (); $l4 = @unserialize ($e3[0]['Uploads']); if (!is_array ($l4)) { foreach ($e3 as $sy){ $dd = ay ( $sy['FormatterID'], @$sy['Text'],'full-rss' ); $l4 = r3 ( 'note',$sy, $dd['meta']['resources-detected'] ); } } fm ( "SELECT `ID`, `Description`, `Uploads` ". "FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND (`Description` LIKE '". $q4 ."' ESCAPE '#' ". "OR `Uploads` LIKE '". $q4 ."' ESCAPE '#')", 'get tags where uploads may be referenced' ); $e3 = sm (); $z4 = @unserialize ($e3[0]['Uploads']); if (!is_array ($z4)) { foreach ($e3 as $tb){ $dd = qy ( @$tb['Description'],'full-rss' ); $z4 = r3 ( 'tag',$tb, $dd['meta']['resources-detected'] ); } } if (!is_array ($a4))$a4 = []; if (!is_array ($l4))$l4 = []; if (!is_array ($z4))$z4 = []; $k4 = array_merge ($a4,$l4,$z4); if(Log::$a)__log ('References found in relevant entries: '. var_export ($k4,true)); if(in_array ($s4,$k4)) { if(Log::$a)__log ('Still referenced, do not delete file'); return true; } return false; } function g3 ($x4,$ly){ global$_config; if ($x4 == 'note' and $ly == 'new'){ if(is_file (USER_DIR . 'new-uploads.psa')) { $k4 = @unserialize (file_get_contents (USER_DIR . 'new-uploads.psa')); } } elseif ($x4 == 'note'){ fm ( "SELECT `Uploads` FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID`=". $ly ); $e3 = sm (); $k4 = @unserialize ($e3[0]['Uploads']); } elseif ($x4 == 'tag'){ fm ( "SELECT `Uploads` FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID`=". $ly ); $e3 = sm (); $k4 = @unserialize ($e3[0]['Uploads']); } if (!is_array ($k4))$k4 = []; return $k4; } function w3 ($x4,$ly,$k4){ global$_config; if ($x4 == 'note' and $ly == 'new'){ if (!@e3 (USER_DIR . 'new-uploads.psa',serialize ($k4))) { return false; } } elseif ($x4 == 'note'){ fm ( "UPDATE `". $_config['db_table_prefix']."Notes` ". "SET `Uploads`='". serialize ($k4) ."' ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID`=". $ly ); } elseif ($x4 == 'tag'){ fm ( "UPDATE `". $_config['db_table_prefix']."Keywords` ". "SET `Uploads`='". serialize ($k4) ."' ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID`=". $ly ); } else { return false; } if (!is_array ($k4))$k4 = []; return $k4; } function u3 ($x4,$ly,$action,$e4){ $k4 = []; if(Log::$a)__log ('Register upload: <'. $x4.', '. $ly.', '. $action.', '. $e4 .'>'); $k4 = g3 ($x4,$ly); $k4 = t1 ($k4,$action,$e4); return w3 ($x4,$ly,$k4); } function i3 ($pv,$r4,$ib){ $b4 = @unserialize ($r4['Uploads']) or $b4 = []; $t4 = a2 ($ib); $k4 = t1 ($b4,'add',$t4); $k4 = serialize ($k4); if ($k4 != $r4['Uploads']) { $r4['Uploads']=$k4; nm (cl (), $pv,$r4); } } function e2j_file_upload ($parameters = []) { global$_config,$_strings; @bq ($_config['path_media'].PICTURES_DIRNAME); @chmod ($_config['path_media'].PICTURES_DIRNAME,$_config['uploaded_files_mode']); @bq ($_config['path_media'].VIDEO_DIRNAME); @chmod ($_config['path_media'].VIDEO_DIRNAME,$_config['uploaded_files_mode']); @bq ($_config['path_media'].AUDIO_DIRNAME); @chmod ($_config['path_media'].AUDIO_DIRNAME,$_config['uploaded_files_mode']); $bl = [ 'success' => false ]; if(count ($_FILES)>0){ foreach($_FILES as $n2){ if (!$n2['error']) { if(Log::$a)__log ('Ajax file upload: <'. $n2['name'].'>'); $bl['data']['file-kind']='image'; $w = $_config['path_media'].PICTURES_DIRNAME; if (vd ($n2['name'])) { $bl['data']['file-kind']='video'; $w = $_config['path_media'].VIDEO_DIRNAME; } elseif (bd ($n2['name'])) { $bl['data']['file-kind']='audio'; $w = $_config['path_media'].AUDIO_DIRNAME; } $j4 = ( array_key_exists ('overwrite',$_GET) and is_file ($w . $n2['name']) ); $h4 = false; $bl['data']['overwrite'] = (int)$j4; if(Log::$a)__log ('Ajax file upload: Overwrite is resolved to <'. (int)$j4.'>'); $d4 = j3 ($n2['name'],$bl['data']['file-kind']); if(Log::$a)__log ('Ajax file upload: Safe name is <'. $d4.'>'); if(is_file ($w . $d4)) { if(file_get_contents ($w . $d4)==file_get_contents ($n2['tmp_name'])) { if(Log::$a)__log ('Ajax file upload: Existing file is the same'); $h4 = true; } elseif (!$j4){ $d4 = nd ($w,$d4); } } if (!$h4){ move_uploaded_file ($n2['tmp_name'],$w . $d4); @chmod ($w . $d4,$_config['uploaded_files_mode']); } if(Log::$a)__log ('Ajax file upload: File kind is <'. $bl['data']['file-kind'].'>'); if ($bl['data']['file-kind']=='image'){ $g4 = pathinfo ($d4,PATHINFO_EXTENSION); if (fd ($g4,'jpg')) { $w4 = $d4; } else { $w4 = $d4 .'.jpg'; $w4 = nd ( $_config['path_media'].PICTURES_DIRNAME,$w4 ); } $u4 = $_config['path_media'].PICTURES_DIRNAME . $d4; $i4 = $_config['path_media'].PICTURES_DIRNAME . $w4; if(Log::$a)__log ('Ajax file upload: Process uploaded image <'. $u4 .'>'. ' to possibly <'. $i4.'>'); $i4 = e2img_filename_by_processing ( $u4, $i4, [ $_config['fit_uploaded_images'], $_config['fit_uploaded_images'], ], CROP_NONE, SCALED_IMAGE_JPG_QUALITY ); $o4 = $n2['size']; if (!fd ($i4,$u4)) { @unlink ($u4); $d4 = $w4; $o4 = stat ($i4)['size']; } if ($j4){ @unlink (w2 ($d4)); } if ($p4 = e2img_filename_by_processing ( $i4, w2 ($d4), [THUMB_WIDTH,THUMB_HEIGHT], CROP_NONE, THUMB_JPG_QUALITY )) { if (u3 ($parameters['entity'],$parameters['entity-id'],'add', [$d4])) { if(Log::$a)__log ('Ajax file upload: thumbnail, done as '. $p4); list ($cz,$vz)=e2_getimagesize ($p4); if(Log::$a)__log ('Ajax file upload: image size '. $cz .'×'. $vz); if (!$cz)$cz = THUMB_WIDTH/2; if (!$vz)$vz = THUMB_HEIGHT/2; list ($cz,$vz)=e2_fit_metrics_to_constraints ( [$cz,$vz], [THUMB_WIDTH/2,THUMB_HEIGHT/2] ); $bl['success']=true; $bl['data']['new-name']=$d4; $bl['data']['filesize']=round ($o4 / 1024) .' '. $_strings['gs--kb']; $bl['data']['thumb']=o3 ($p4); $bl['data']['width']=$cz; $bl['data']['height']=$vz; } else { if(Log::$a)__log ('Ajax file upload: couldn’t register upload'); @unlink ($w . $d4); @unlink ($p4); $bl['error']['message']=_S ('er--cannot-register-upload'); } } else { if(Log::$a)__log ('Ajax file upload: couldn’t create thumbnail'); @unlink ($w . $d4); $bl['error']['message']=_S ('er--cannot-create-thumbnail'); } } if ($bl['data']['file-kind']=='video'){ if(Log::$a)__log ('Ajax file upload: video, done'); $bl['success']=true; $bl['data']['new-name']=$d4; $bl['data']['filesize']=round ($n2['size']/1024) .' '. $_strings['gs--kb']; $bl['data']['thumb']=SYSTEM_THEME_DIR . VIDEO_ICON_FILENAME; $bl['data']['width']=VIDEO_ICON_WIDTH/2; $bl['data']['height']=VIDEO_ICON_HEIGHT/2; u3 ($parameters['entity'],$parameters['entity-id'],'add', [$d4]); } if ($bl['data']['file-kind']=='audio'){ if(Log::$a)__log ('Ajax file upload: audio, done'); $bl['success']=true; $bl['data']['new-name']=$d4; $bl['data']['filesize']=round ($n2['size']/1024) .' '. $_strings['gs--kb']; $bl['data']['thumb']=SYSTEM_THEME_DIR . AUDIO_ICON_FILENAME; $bl['data']['width']=AUDIO_ICON_WIDTH/2; $bl['data']['height']=AUDIO_ICON_HEIGHT/2; u3 ($parameters['entity'],$parameters['entity-id'],'add', [$d4]); } } elseif(4 != $n2['error']) { $bl['error']['message'] = ( ny ($n2['error']) ); } } } else { if(Log::$a)__log ('Ajax file upload error: no files'); $bl['error']['message']='No files were received by server'; } $bl = json_encode ($bl); die ($bl); } function o3 ($bz){ global$_config; $yz = strlen ($_config['path_media']); if ($yz and substr ($bz,0,$yz)==$_config['path_media']) { return substr ($bz,$yz); } else { return AeEnv::$base_url . $bz; } } function p3 () { return [ 'userpic.original.png', 'userpic.original.jpg', 'userpic@2x.png', 'userpic@2x.jpg', 'userpic-large@2x.jpg', 'userpic-square@2x.jpg', ]; } function cy () { global$_config; foreach (p3 () as $jd){ @unlink ($_config['path_media'].USERPIC_DIRNAME . $jd); } } function e2j_userpic_remove () { if($_SERVER['REQUEST_METHOD']!='POST'){ q1 (kq ('e2m_settings')); } cy (); $bl = json_encode (['success' => true]); die ($bl); } function e2j_userpic_upload () { global$_config,$_strings; $bl = ['success' => false]; if(count ($_FILES)!=1){ if(Log::$a)__log ('Ajax userpic upload error: no or too many files'); $bl['error']['message']=$_strings['er--cannot-upload-no-or-too-many-files']; $bl = json_encode ($bl); die ($bl); } $n2 = array_pop ($_FILES); if (!$n2['error']) { if(Log::$a)__log ('Ajax userpic upload: <'. $n2['name'].'>'); $nz = pathinfo ($n2['name']); $g4 = strtolower ($nz['extension']); if ($g4 != 'png')$g4 = 'jpg'; $gd = 'userpic.original.'. $g4; $hd = $_config['path_media'].USERPIC_DIRNAME; cy (); move_uploaded_file ($n2['tmp_name'],$hd . $gd); @chmod ($hd . $gd,$_config['uploaded_files_mode']); copy ( $hd . $gd, $hd .'userpic-large@2x.jpg' ); $mz = e2img_filename_by_processing ( $hd .'userpic-large@2x.jpg', $hd .'userpic-large@2x.jpg', [$_config['max_image_width'],$_config['max_image_width']], CROP_NONE, USERPIC_JPG_QUALITY ); copy ( $hd . $gd, $hd .'userpic-square@2x.jpg' ); $fz = e2img_filename_by_processing ( $hd .'userpic-square@2x.jpg', $hd .'userpic-square@2x.jpg', [$_config['max_image_width'],$_config['max_image_width']], CROP_SQUARE, USERPIC_JPG_QUALITY ); $dz = e2img_filename_by_processing ( $hd . $gd, $hd .'userpic@2x.jpg', [USERPIC_WIDTH,USERPIC_HEIGHT], CROP_SQUARE, USERPIC_JPG_QUALITY ); if ($fz){ $sz = str_replace (USER_DIR,USER_URLPATH,$fz); $bl = [ 'success' => true, 'data' => [ 'new-image-src' => $sz, ] ]; } else { $bl['error']['message']=_S ('er--supported-only-png-jpg-gif'); } } elseif(4 != $n2['error']) { $bl['error']['message'] = ( ny ($n2['error']) ); } $bl = json_encode ($bl); die ($bl); } function e2j_file_remove ($parameters){ global$_config; if (!array_key_exists ('file',$_POST)) { $bl = [ 'success' => false ]; $bl = json_encode ($bl); die ($bl); } $n2 = $_POST['file']; $bl = [ 'success' => true ]; $bl = json_encode ($bl); u3 ($parameters['entity'],$parameters['entity-id'],'remove',$n2); if (!h3 ($n2)) { if (bd ($n2)) { if(Log::$a)__log ('Not referenced, deleting '. $_config['path_media'].AUDIO_DIRNAME . $n2); @unlink ($_config['path_media'].AUDIO_DIRNAME . $n2); } elseif (vd ($n2)) { if(Log::$a)__log ('Not referenced, deleting '. $_config['path_media'].VIDEO_DIRNAME . $n2); @unlink ($_config['path_media'].VIDEO_DIRNAME . $n2); } else { $dz = yd ($n2,'thumb@2x'); if(Log::$a)__log ('Not referenced, deleting '. $_config['path_media'].PICTURES_DIRNAME . $n2); @unlink ($_config['path_media'].PICTURES_DIRNAME . $n2); if(Log::$a)__log ('Not referenced, deleting '. $_config['path_media'].THUMBNAILS_DIRNAME . $n2); @unlink ($_config['path_media'].THUMBNAILS_DIRNAME . $dz); } } die ($bl); } function vy () { global$_config; if (!$_config['files_total_size_limit']) return false; $az = 0; foreach(glob ($_config['path_media'].PICTURES_DIRNAME .'/*') as $n2){ $qz = stat ($n2); $az += $qz['size']; } foreach(glob ($_config['path_media'].VIDEO_DIRNAME .'/*') as $n2){ $qz = stat ($n2); $az += $qz['size']; } foreach(glob ($_config['path_media'].AUDIO_DIRNAME .'/*') as $n2){ $qz = stat ($n2); $az += $qz['size']; } $lz = $_config['files_total_size_limit']; $zz = r1 ($az,$lz); return [$az,$lz,$zz]; } function by ($kz){ $xz = true; if (list ($az,$lz,$zz)=$kz){ $xz = ($lz - $az)>0; } return $xz; } function yy ($kz,$ez = false){ $rz = ''; if (list ($az,$lz,$zz)=$kz){ $kz = [ 'used' => round ($az / 1024 / 1024), 'total' => round ($lz / 1024 / 1024), 'percent' => $zz ]; if ($ez or ($lz - $az)<1024 * 1024 * 10){ if ($az < $lz){ $rz = e2l_get_string ('gs--used',$kz); } else { $rz = e2l_get_string ('gs--used-all',$kz); } } } return $rz; } function ny ($qq){ global$_strings; if ($qq == UPLOAD_ERR_INI_SIZE){ $dq = $_strings['er--cannot-upload-file-too-big']; } elseif ($qq == UPLOAD_ERR_FORM_SIZE){ $dq = $_strings['er--cannot-upload-file-too-big']; } else { $dq = e2l_get_string ('er--cannot-upload', ['error' => $qq]); } return $dq; } function dy ($q1){ include_once 'system/neasden/neasden.php'; $Nn = new Neasden; $Nn->profile_name = 'kavychki'; return$Nn->format ($q1); } function sy ($o7,$q1,$p7){ include_once 'system/neasden/neasden.php'; if ($q1 === '') return array (); if ($o7 == 'neasden'){ $Nn = new Neasden; $Nn->profile_name = $p7; $Nn->format ($q1); return$Nn->resources_detected; } else { return array (); } } function ay ($o7,$q1,$p7){ include_once 'system/neasden/neasden.php'; if(Log::$a)__log ('Format: format with formatter "'. $o7 .'" in context "'. $p7.'"'); $meta = []; if ($o7 == 'neasden'){ $Nn = new Neasden; $Nn->profile_name = $p7; $q1 = $Nn->format ($q1); $meta = [ 'links-required' => $Nn->links_required, 'resources-detected' => $Nn->resources_detected ]; } return array ( 'text-final' => $q1, 'meta' => $meta, ); } function qy ($q1,$p7){ return ay (DEFAULT_FORMATTER,$q1,$p7); } function e2m_frontpage ($parameters = []) { global$settings,$_strings,$_config; if(Log::$a)__log ('Frontpage {'); $rn = vs (); $frontpageView = new AePageableNotesView ('e2m_frontpage',$parameters); $frontpageView -> setPortionSize ($settings['appearance']['notes_per_page']); $frontpageView -> setNextPrevPageTitles ($_strings['gs--earlier'],$_strings['gs--later']); $frontpageView -> setWantPaging (true); $frontpageView -> setWantNewCommentsCount ($rn); $frontpageView -> setWantReadHrefs ($_config['count_reads']); $frontpageView -> setWantControls ($rn and !@$_config['read_only']); $frontpageView -> setWantHiddenTags ($rn); $frontpageView -> setWantRelatedNotes (true); if(CACHE_FRONTPAGE and $frontpageView -> isFirstPage ()) { if ($rn){ $frontpageView -> setCacheFilename (USER_DIR . CACHE_FILENAME_FRONTPAGE_AUTHOR); } else { $frontpageView -> setCacheFilename (USER_DIR . CACHE_FILENAME_FRONTPAGE); } } $frontpageView -> setLimitlessSQLRequest ( "SELECT * ". "FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished`=1 ". mf ($rn). "ORDER BY `Stamp` DESC" ); $ns = ev (); if($parameters['page']>1){ $ns .= ' ('. $_strings['gs--page'] .' '. $parameters['page'] .')'; } $cb = [ 'title' => $ns, 'heading' => '', 'notes' => $frontpageView -> getNotesCTree (), 'pages' => $frontpageView -> getPagesCTree (), 'frontpage?' => $frontpageView -> isFirstPage (), ]; if ( !$frontpageView -> isExistingPage () and !$frontpageView -> isFirstPageOfEmptyView () ) { return e2m_error404 (); } if(Log::$a)__log ('} // Frontpage'); return $cb; } abstract class E2GIP { protected $gip_cookie_name = 'gip'; protected $gip_token_cookie_name = 'gip_access_token'; protected $gip_token = null; abstract public function get_auth_url (); abstract public static function get_profile_url ($ly,$cx); abstract public function callback (); const PHP_VERSION_VK_FEATURE = 70100; public static function set_session_data ($py,$cv){ if(session_status () == PHP_SESSION_NONE){ session_start (); } $_SESSION[$py]=$cv; } public static function get_session_data ($py,$vx = false){ if(session_status () == PHP_SESSION_NONE){ session_start (); } if(!isset ($_SESSION[$py])) { return null; } $cv = $_SESSION[$py]; if ($vx) unset($_SESSION[$py]); return $cv; } public function get_config ($py){ $bx = 'gips/'. $this->type .'.json'; $fl = false; foreach ([USER_DIR,INSTANCE_DIR,SYSTEM_DIR] as $yx){ if(is_file ($yx . $bx)) { $fl = @file_get_contents ($yx . $bx); break; } } if ($fl !== false){ $cb = json_decode ($fl,true,512,JSON_BIGINT_AS_STRING)[$py]; if ($cb) return $cb; } return null; } public function get_callback_url () { return kq ('e2m_gip_sign_in_callback', ['provider' => $this->type]); } protected function get_proxy_param () { global$settings; $nx = DEFAULT_LANGUAGE; if(array_key_exists ('language',$settings))$nx = $settings['language']; return '?language=' . $nx . '&type=' . $this->type . '&callback_url=' . urlencode ($this -> get_callback_url ()); } public function get_gip_session_data () { global$_config; $mx = $this->gip_token ? $this->gip_token : $_COOKIE[z1 ($this->gip_token_cookie_name)]; fm ( "SELECT * FROM `". $_config['db_table_prefix']."GIPsSessions` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `GIP` = '". $this->type ."' ". "AND `SessionToken` = '" . am($mx)."' ". "ORDER BY `ID` DESC LIMIT 1", 'get GIP session data' ); $e3 = sm (); return $e3 ? $e3[0] : []; } public function is_logged_in () { if ( empty ($_COOKIE[z1 ($this->gip_cookie_name)]) || !in_array ($_COOKIE[z1 ($this->gip_cookie_name)], ly ()) || $_COOKIE[z1 ($this->gip_cookie_name)] != $this->type || empty ($_COOKIE[z1 ($this->gip_token_cookie_name)]) ) { return false; } $lb = $this -> get_gip_session_data (); return (bool)$lb; } protected function save_session ($ly,$name,$accessToken,$fx = '',$userEmail = '',$userLink = ''){ $vf = time (); ym ( cl (), 'GIPsSessions', [ 'GIP' => $this->type, 'GIPAuthorID' => $ly, 'AuthorName' => $name, 'AuthorEmail' => $userEmail, 'AuthorProfileLink' => $userLink, 'SessionToken' => $accessToken, 'Stamp' => $vf, ], 'INSERT', 'ON DUPLICATE KEY UPDATE '. '`SessionToken` = "' . am ($accessToken).'", '. '`AuthorName` = "' . am ($name).'", '. '`Stamp` = "' . $vf . '"' ); k1 ($this->gip_cookie_name,$this->type); k1 ($this->gip_token_cookie_name,$accessToken); if (isset ($userEmail) && !empty ($userEmail))k1 ('commenter_email',$userEmail); $this->gip_token = $accessToken; } public static function get_logout_key () { if ($dx = self::get_session_data ('logout_key')) { return $dx; } $dx = md5 (microtime ()); self::set_session_data ('logout_key',$dx); return $dx; } public static function is_valid_logout_key ($py){ $sx = self::get_session_data ('logout_key',true); if (empty ($sx) || empty ($py) || $sx != $py){ return false; } return true; } public function logout () { global$_config; k1 ($this->gip_cookie_name); k1 ($this->gip_token_cookie_name); fm ( "DELETE FROM `". $_config['db_table_prefix']."GIPsSessions` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `GIP` = '" . $this->type . "' ". "AND `SessionToken` = '" . am ($_COOKIE[z1 ($this->gip_token_cookie_name)]) . "'", 'logout' ); } public function get_avatar_width () { return USERPIC_WIDTH; } public function get_avatar_height () { return USERPIC_HEIGHT; } public function save_avatar ($ly,$ax){ global$_config; if (!preg_match ('/^https?\:\/\//i',$ax)) return; $ax = str_replace ("\0",'',$ax); $ly = preg_replace ('/[^a-zA-Z0-9._-]/','',$ly); $ly = substr ($ly,0,64); @bq ($_config['path_media'].AVATARS_DIRNAME); @chmod ($_config['path_media'].AVATARS_DIRNAME,$_config['uploaded_files_mode']); $gd = $_config['path_media'].AVATARS_DIRNAME . $this->type .'-'. $ly .'.jpg'; if ($qx = file_get_contents ($ax)) { file_put_contents ($gd,$qx); } return $gd; } } function e2m_gip_sign_in ($lb){ $type = $lb['provider']; $lx = ky ($type); if (!$lx)l1 (); header ('Location: ' . $lx -> get_auth_url ()); die; } function e2m_gip_sign_in_callback ($lb){ $type = $lb['provider']; $lx = ky ($type); if (!$lx) return e2m_error404 (); $zx = $lx -> callback (); if (!$zx) return e2m_error404 (); echo '<script>'; $pa = $lx -> get_gip_session_data (); $kx = [ 'name' => $pa['AuthorName'], 'gipIcon' => _SVG ($type), 'logoutUrl' => kq ('e2m_gip_sign_out', ['provider' => E2GIP::get_logout_key ()]), ]; echo 'window.opener.oauthAuthorized(' . json_encode ($kx).');'; echo 'window.close();</script>'; die; } function e2m_gip_sign_out ($lb){ $dx = $lb['provider']; if (!E2GIP::is_valid_logout_key ($dx)) { return e2m_error404 (); } $lx = ry (); if ($lx)$lx -> logout (); l1 (); } function ly () { global$_config; static $ra = null; if ($ra !== null) return $ra; $xx = (string) @$_config['sign_in_with']; $ex = '|twitter|facebook|vk|telegram|'; $rx = SYSTEM_DIR .'gips/'; $ra = []; foreach(explode (',',$xx) as $tx){ $tx = trim ($tx); if ($tx == 'vkontakte')$tx = 'vk'; if (!strstr ($ex,'|'. $tx. '|')) continue; if (!is_file ($rx . $tx .'.php')) continue; if(in_array ($tx,$ra)) continue; if ($tx === 'vk' and PHP_VERSION_ID < E2GIP::PHP_VERSION_VK_FEATURE) continue; $ra[] = $tx; } return $ra; } function zy ($type){ return "E2GIP" . ucfirst($type); } function ky ($type){ if (!in_array ($type,ly ())) { return false; } $jx = zy ($type); $lx = new $jx; return $lx; } function xy ($type){ return kq ('e2m_gip_sign_in', ['provider' => $type]); } function ey ($type = ''){ $hx = !$type ? ly () : [$type]; foreach ($hx as$type){ $lx = ky ($type); if ($lx && $lx -> is_logged_in ()) { return true; } } return false; } function ry () { foreach (ly () as$type){ $lx = ky ($type); if ($lx && $lx -> is_logged_in ()) { return $lx; } } return false; } function ty () { foreach (ly () as$type){ $lx = ky ($type); if ($lx && $lx -> is_logged_in ()) { return$type; } } return false; } function jy ($type,$ly,$cx){ $jx = zy ($type); if(class_exists ($jx)) { return $jx::get_profile_url ($ly,$cx); } else { return false; } } function hy ($type){ $lx = ky ($type); if (!$lx || !$lx -> is_logged_in ()) { return false; } return $lx -> get_gip_session_data (); } function gy ($gx){ $gd = SYSTEM_DIR .'gips/'. strtolower (str_replace ('E2GIP','',$gx)) .'.php'; if(is_file ($gd)) require $gd; } function e2s_notify () { global$_config; if (!$_config['holborn']) die; $wx = @$_GET['src']; if ($wx == ''){ if(Log::$a)__log ('Holborn: No src URL'); die; } $fl = file_get_contents ($wx); $fl = oy ($fl); $ux = json_decode ($fl,true); if (!$ux){ if(Log::$a)__log ('Holborn: No meaningful info from '. $wx .' ('. json_last_error () .')'); if ($ix = uy ($wx)) { if(Log::$a)__log ('Holborn: Delete note with ID '. $ix['ID']); jm ($ix['ID']); } die; } wy ($ux,$wx); } function e2m_sources ($parameters){ global$_config; if (!$_config['holborn']) return e2m_error404 (); $ox = $_GET['ord']; $px = ''; if (@$ox[0]=='!'){ $ox = substr ($ox,1); $px = ' DESC'; } if (!$ox)$ox = 'ID'; $ox = "`". am ($ox) ."`"; fm ( "SELECT S.*, ". "REPLACE(REPLACE(REPLACE(S.`URL`, 'http://', ''), 'https://', ''), 'www.', '') AS _URLX, ". "COUNT(N.`ID`) AS NotesCount, ". "MAX(N.`Stamp`) AS LastNoteStamp ". "FROM `". $_config['db_table_prefix']."Sources` AS S, " . " `". $_config['db_table_prefix']."Notes` AS N " . "WHERE S.`SubsetID`=". $_config['db_table_subset'] ." ". "AND N.`SubsetID`=". $_config['db_table_subset'] ." ". "AND S.`ID` = N.`SourceID`". "GROUP BY S.`ID` ". "ORDER BY ". $ox ." ". $px ." ". "LIMIT 100" ); $e3 = sm (); foreach ($e3 as $uq){ $ce = $uq['ID']; if ($uq['ID']!=$uq['TrueID'])$ce = '<s>'.$ce.'</s><br />='. $uq['TrueID']; $source = [ 'id' => $ce, 'userpic-href' => $uq['PictureURL'], 'href' => $uq['URL'], 'href-display' => str_replace ('/','/<wbr>',$uq['URL']), 'href-filtered' => str_replace ('/','/<wbr>',$uq['_URLX']), 'title' => $uq['Title'], 'author' => $uq['AuthorName'], 'true?' => $uq['ID']==$uq['TrueID'], 'whitelisted?' => (bool)$uq['IsWhiteListed'], 'trusted?' => (bool)$uq['IsTrusted'], 'notes-count' => $uq['NotesCount'], 'latest-note-time' => [$uq['LastNoteStamp'],0], ]; if (!$uq['IsTrusted']) { $source['trust-url']=kq ( 'e2m_source_trust', ['source' => $uq['ID']] ); } if ($uq['IsTrusted']) { $source['premoderate-url']=kq ( 'e2m_source_premoderate', ['source' => $uq['ID']] ); } $source['ban-url']=kq ( 'e2m_source_ban', ['source' => $uq['ID']] ); $source['forget-url']=kq ( 'e2m_source_forget', ['source' => $uq['ID']] ); $ve[] = $source; } $cb = [ 'title' => 'Sources', 'heading' => 'Sources', ]; if(count ($ve)) { $cb['sources']=$ve; } else { $cb['nothing']='No sources'; } return $cb; } function e2m_source_trust ($parameters){ global$_config; $be = $parameters['source']; fm ( "UPDATE  ". $_config['db_table_prefix']."Sources ". "SET `IsWhitelisted`=1, `IsTrusted`=1 ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID`=". $be, 'trust source' ); fm ( "UPDATE  ". $_config['db_table_prefix']."Notes ". "SET `IsPublished`=1 ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `SourceID`=". $be, 'publish all notes from the just trusted source' ); cb (); @unlink (USER_DIR . CACHE_FILENAME_DRAFTS); @unlink (USER_DIR . CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); @unlink (USER_DIR . CACHE_FILENAME_INDEXED_FLAG); q1 (); } function e2m_source_premoderate ($parameters){ global$_config; $be = $parameters['source']; fm ( "UPDATE  ". $_config['db_table_prefix']."Sources ". "SET `IsTrusted`=0 ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID`=". $be, 'distrust source, set to premoderation' ); cb (); q1 (); } function e2m_source_ban ($parameters){ global$_config; $be = $parameters['source']; fm ( "UPDATE  ". $_config['db_table_prefix']."Sources ". "SET `IsWhiteListed`=0, `IsTrusted`=0 ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID`=". $be, 'ban source' ); fm ( "DELETE FROM  ". $_config['db_table_prefix']."Notes ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `SourceID`=". $be, 'delete all notes from the just banned source' ); cb (); @unlink (USER_DIR . CACHE_FILENAME_DRAFTS); @unlink (USER_DIR . CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); q1 (); } function e2m_source_forget ($parameters){ global$_config; $be = $parameters['source']; fm ( "DELETE FROM  ". $_config['db_table_prefix']."Sources ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID`=". $be, 'forget source' ); fm ( "DELETE FROM  ". $_config['db_table_prefix']."Notes ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `SourceID`=". $be, 'delete all notes from the just forgotten source' ); cb (); @unlink (USER_DIR . CACHE_FILENAME_DRAFTS); @unlink (USER_DIR . CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); q1 (); } function wy ($ye,$wx){ global$_config; if (!array_key_exists ('author',$ye)) { $ye['author']=$ye['authors'][0]; } $ne = py ([ 'author' => $ye['author']['name'], 'title' => $ye['title'], 'href' => $ye['author']['url'], 'userpic-href' => $ye['author']['avatar'], ]); if (!$ne['IsWhiteListed']) return; if(preg_match ('/\+(\d\d)\:(\d\d)/',$ye['items'][0]['date_published'],$me)) { $k3 = $me[1]*SECONDS_IN_AN_HOUR + $me[2]*SECONDS_IN_A_MINUTE; } $fe = @$ye['items'][0]['_e2_data'] or $fe = []; $fe = json_encode ($fe); $de = $ne['IsTrusted']; $databaseConfiguration = cl (); $sy = [ 'Title' => $ye['items'][0]['title'], 'Text' => $ye['items'][0]['content_html'], 'FormatterID' => 'raw', 'OriginalAlias' => '', 'Uploads' => '', 'Stamp' => strtotime ($ye['items'][0]['date_published']), 'Offset' => (int)$k3, 'IsDST' => 0, 'LastModified' => strtotime ($ye['items'][0]['date_modified']), 'IsCommentable' => 0, 'IsPublished' => $de, 'IsExternal' => 1, 'SourceID' => $ne['ID'], 'SourceNoteID' => $ye['items'][0]['id'], 'SourceNoteURL' => $ye['items'][0]['url'], 'SourceNoteJSONURL' => $wx, 'SourceNoteData' => $fe, ]; $note_id = $ye['items'][0]['id']; if ( $ix = iy ($ne['ID'],$note_id) ) { $sy['ID']=$ix['ID']; nm ($databaseConfiguration,'Notes',$sy); } else { $sy = ym ($databaseConfiguration,'Notes',$sy); } if ($de){ if (zd ($sy)) { $sy['IsIndexed']='1'; nm (cl (), 'Notes',$sy); } } $se = @$ye['items'][0]['tags']; if(is_array ($se)) { va ($databaseConfiguration,$sy['ID'],$se); } e2_drop_caches_for_note_($sy['ID'],$de); if($_config['backup_automatically']) { qm (); } } function uy ($wx){ global$_config; fm ( "SELECT `ID` FROM ". $_config['db_table_prefix']."Notes ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `SourceNoteJSONURL`='". am ($wx) ."' ". "LIMIT 1", 'get note ID by source JSON URL' ); $e3 = sm (); return $e3[0]; } function iy ($be,$ae){ global$_config; fm ( "SELECT `ID` FROM ". $_config['db_table_prefix']."Notes ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `SourceID`= '". $be ."' ". "AND `SourceNoteID`= '". $ae ."' ". "LIMIT 1", 'get note ID by source ID and source note ID' ); $e3 = sm (); return $e3[0]; } function oy ($fl){ for ($rb = 0; $rb <= 31; ++$rb){ $fl = str_replace (chr ($rb),'',$fl); } $fl = str_replace (chr (127),'',$fl); if(0 === strpos (bin2hex ($fl),'efbbbf')) { $fl = substr ($fl,3); } return $fl; } function py ($qe){ global$_config; $le = false; fm ( "SELECT * FROM ". $_config['db_table_prefix']."Sources ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `URL`= '". $qe['href'] ."' ". "LIMIT 1", 'get source record by the URL from blog info' ); $e3 = sm (); if(count ($e3)) { $le = $e3[0]; if ($le['ID']!=$le['TrueID']) { fm ( "SELECT * FROM ". $_config['db_table_prefix']."Sources ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID`= '". $le['TrueID'] ."' ". "LIMIT 1", 'get true source record by using the TrueID of just found record' ); $e3 = sm (); if(count ($e3)) { $le = $e3[0]; } } } $ne = [ 'Title' => $qe['title'], 'AuthorName' => $qe['author'], 'PictureURL' => $qe['userpic-href'], ]; if ($le !== false){ if ( $le['Title']!==$qe['title'] or $le['AuthorName']!==$qe['author'] or $le['PictureURL']!==$qe['userpic-href'] ) { $ne['ID']=$le['ID']; nm (cl (), 'Sources',$ne); } return $le; } else { $ne['URL']=$qe['href']; $ne['IsWhiteListed']=1; $ne['IsTrusted']=0; $ne = ym (cl (), 'Sources',$ne); $ne['TrueID']=$ne['ID']; nm (cl (), 'Sources',$ne); return $ne; } } function cn ($sy){ global$_config; $va = []; if (@$sy['IsExternal']) { if(array_key_exists ('SourceID',$sy)) { fm ( "SELECT * FROM `". $_config['db_table_prefix']."Sources` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID` = '". $sy['SourceID'] ."'", 'get source by id' ); $zb = sm (); $va['source']=$zb[0]['Title']; $va['source-id'] = (int)$sy['SourceID']; $va['source-true-id'] = (int)$zb[0]['TrueID']; $va['source-whitelisted?'] = (bool)$zb[0]['IsWhiteListed']; $va['source-trusted?'] = (bool)$zb[0]['IsTrusted']; if (!$zb[0]['IsTrusted']) { $va['source-trust-url']=kq ( 'e2m_source_trust', ['source' => $sy['SourceID']] ); } if ($zb[0]['IsTrusted']) { $va['source-premoderate-url']=kq ( 'e2m_source_premoderate', ['source' => $sy['SourceID']] ); } $va['source-ban-url']=kq ( 'e2m_source_ban', ['source' => $sy['SourceID']] ); $va['source-forget-url']=kq ( 'e2m_source_forget', ['source' => $sy['SourceID']] ); $va['author']=$zb[0]['AuthorName']; $va['author-href']=$zb[0]['URL']; $va['userpic-href']=$zb[0]['PictureURL']; } if(array_key_exists ('SourceNoteURL',$sy) and @$sy['SourceNoteURL']!=''){ $va['href-external']=$sy['SourceNoteURL']; } } return $va; } function e2img_filename_by_processing ( $ze,$ke, $xe,$ee,$re ) { global$_config; if(Log::$a)__log ('Process image: "'. $ze .'" -> "'. $ke .'"'); if (!is_file ($ze)) return false; $te = stat ($ze)['size']; if (!p2 ($ze)) { if(Log::$a)__log ('Process image: SVG, no processing'); return $ze; } if(is_file ($ke) and !fd ($ze,$ke)) { if(Log::$a)__log ('Process image: Already exists'); return $ke; } if (!extension_loaded ('gd')) return false; $je = pathinfo ($ke); if (!@bq ($je['dirname'])) { if(Log::$a)__log ( 'Process image: Can’t create directory <'. $je['dirname'] .'>' ); return false; } if(Log::$a)__log ('Process image: Detecting image type'); $type = e2img__type_of_file ($ze); if (!$type) return false; $he = 'imagecreatefrom'. $type; if (!function_exists ($he)) { if(Log::$a)__log ('Process image: Function does not exist ('. $he .')'); return false; } if(Log::$a)__log ('Process image: Opening original image ('. $he .')'); $ge = call_user_func ($he,$ze); if (!$ge) return false; if ($we = e2img__orientation_of_file ($ze)) { if(Log::$a)__log ('Process image: Needs orientation fix'); $ge = e2img__res_rotate ($ge, -$we); } $ue = [imagesx ($ge),imagesy ($ge)]; $ie = $ue; $oe = [0,0,0,0]; if ($ee == CROP_SQUARE){ if(Log::$a)__log ('Process image: Needs crop'); list ($ie,$oe) = ( e2img__crop_metrics_to_square ($ie) ); } $ie = e2_fit_metrics_to_constraints ( $ie,$xe ); if ( $we === 0 and $ie === $ue ) { if(Log::$a)__log ('Process image: No changes necessary, leaving original'); return $ze; } if(Log::$a)__log (var_export ($ie,true)); if(Log::$a)__log (var_export ($oe,true)); $pe = e2img__create_copy_resampled ( $ge, $ie, $oe, $type ); imagejpeg ($pe,$ke,$re); if (!is_file ($ke)) { if(Log::$a)__log ('Process image: File not created by imagejpeg'); return false; } if ($ke !== $ze){ if ($we === 0){ $c6 = stat ($ke)['size']; if ($c6 >= $te){ if(Log::$a)__log ('Process image: Conversion to JPEG made file bigger, back up'); @unlink ($ke); $ke = $ze; } } } @chmod ($ke,$_config['uploaded_files_mode']); if(Log::$a)__log ('Process image: Done'); return $ke; } function e2img__create_copy_resampled ( $ge,$ie,$oe,$type ) { list ($v6,$b6)=$ie; list ($y6,$n6,$m6,$f6)=$oe; $pe = imagecreatetruecolor ($v6,$b6); if($type === 'png'){ imagefill ($pe,0,0,imagecolorallocate ($pe,255,255,255)); imagealphablending ($pe,true); } $d6 = imagesx ($ge); $s6 = imagesy ($ge); imagecopyresampled ( $pe, $ge, 0,0, 0 + $y6,0 + $n6, $v6,$b6, $d6 - $m6,$s6 - $f6 ); imageinterlace ($pe,1); return $pe; } function e2img__type_of_file ($gd){ $a6 = @getimagesize ($gd); if (!$a6) return false; if ($a6[2]==IMAGETYPE_GIF) return 'gif'; if ($a6[2]==IMAGETYPE_JPEG) return 'jpeg'; if ($a6[2]==IMAGETYPE_PNG) return 'png'; if ($a6[2]==IMAGETYPE_WEBP) return 'webp'; return false; } function e2img__orientation_of_file ($gd){ if (!function_exists ('exif_read_data')) return 0; if (($q6 = @exif_read_data ($gd)) === false) return 0; if (@$q6['Orientation']==3) return -180; if (@$q6['Orientation']==6) return -270; if (@$q6['Orientation']==8) return -90; return 0; } function e2img__res_rotate ($l6,$we){ $z6 = imagerotate ($l6,$we,0); if ($z6 !== false){ imagedestroy ($l6); $l6 = $z6; } return $l6; } function e2_fit_metrics_to_constraints ( $k6,$xe ) { if ($xe === false)$xe = [0,0]; list ($cz,$vz)=$k6; list ($x6,$e6)=$xe; $r6 = [1]; if ($x6)$r6[] = $x6 / $cz; if ($e6)$r6[] = $e6 / $vz; $t6 = min ($r6); if ($t6 < 1){ $cz = (int)round ($cz * $t6); $vz = (int)round ($vz * $t6); } return [$cz,$vz]; } function e2_getimagesize_jpeg ($gd){ $j6 = @fopen ($gd,'r'); if ($j6 === false){ throw new \RuntimeException (error_get_last ()['message']); } try { if (!flock ($j6,LOCK_SH)) { throw new \RuntimeException ('Cannot lock the file: '. $gd); } $v2 = fread ($j6,2); if ($v2 !== "\xFF\xD8"){ throw new \RuntimeException ('Unknown format: '. $gd); } for (;;) { $h6 = @unpack ('H4segment/nlen',fread ($j6,4)); if ($h6 === false){ throw new \RuntimeException ('Unknown format: '. $gd); } $yz = $h6['len']; $g6 = $h6['segment']; if(strpos ($g6,'ffc')===0){ $w6 = @unpack ('Cbits/nheight/nwidth',fread ($j6,$yz - 2)); if ($w6 === false){ throw new \RuntimeException ('Unknown format: '. $gd); } return [$w6['width'],$w6['height']]; } if(fseek($j6,$yz - 2,SEEK_CUR)!==0){ throw new \RuntimeException ('Cannot find start of frame: '. $gd); } } } finally { fclose ($j6); } } function e2_getimagesize ($gd){ $cz = $vz = 0; if (i2 ($gd)) { try { list ($cz,$vz)=e2_getimagesize_jpeg ($gd); } catch (\Exception $e){ list ($cz,$vz)=getimagesize ($gd); } } elseif (p2 ($gd)) { list ($cz,$vz)=getimagesize ($gd); } elseif (vd ($gd)) { try { require_once SYSTEM_DIR . LIBRARY_DIRNAME .'getid3/getid3.php'; $a6 = new getid3 (); $a6 = $a6->analyze ($gd); $cz = $a6['video']['resolution_x']; $vz = $a6['video']['resolution_y']; } catch (\Exception $e){} } elseif (cd ($gd)) { if(function_exists ('simplexml_load_string')) { $u6 = simplexml_load_string (file_get_contents ($gd)); if ($u6){ $i6 = $u6->attributes (); list ($cz,$vz) = [(string)$i6 -> width, (string)$i6 -> height]; } } } if(substr ($gd,strrpos ($gd,'.')-3,3)=='@2x'){ $cz = (int)floor ($cz / 2); $vz = (int)floor ($vz / 2); } $o6 = round (($vz > 0) ? ($cz / $vz):1,2); $p6 = round (($cz > 0) ? ($vz / $cz):1,2); return [$cz,$vz,$o6,$p6]; } function e2img__crop_metrics_to_square ($k6){ $cr = $vr = $br = $yr = 0; list ($cz,$vz)=$k6; if ($cz > $vz){ $br = $cz - $vz; $cr = floor ($br / 2); $vz = $cz; } elseif ($cz < $vz){ $yr = $vz - $cz; $vr = floor ($br / 2); $cz = $vz; } $oe = [$cr,$vr,$br,$yr]; $nr = [$cz,$vz]; return [$nr,$oe]; } function e2m_install () { global$_strings,$_config; lf (DEFAULT_TEMPLATE); $cb = []; if(Log::$a)__log ('Installer: not installed, present user with form'); $mr['server'] = @$_COOKIE[z1 ('install_db_server')]; $mr['user_name'] = @$_COOKIE[z1 ('install_db_user_name')]; $mr['passw']=ls (@$_COOKIE[z1 ('install_db_passw')]); $mr['name'] = @$_COOKIE[z1 ('install_db_name')]; $cb = [ 'title' => $_strings['pt--install'], 'heading' => $_strings['pt--install'], 'form-install' => [ 'form-action' => kq ('e2s_install'), 'form-check-db-config-action' => kq ('e2j_check_db_config'), 'form-list-databases-action' => kq ('e2j_list_databases'), 'submit-text' => $_strings['fb--begin'], 'db-server' => htmlspecialchars (@$mr['server']? $mr['server']:'localhost'), 'db-user' => htmlspecialchars (@$mr['user_name']? $mr['user_name']:'root'), 'db-password' => '', 'db-database' => htmlspecialchars (@$mr['name']), ] ]; return $cb; } function vn () { static $lx = null; if ($lx === null){ $lx = @unserialize ( @file_get_contents (INSTANCE_DIR . 'instance.psa') ) or $lx = null; } return $lx; } function bn ($fr){ static $lx = null; $lx = vn (); $lx['version']=$fr; if (e3 (INSTANCE_DIR . 'instance.psa',serialize ($lx))) { return $lx; } else { die ('Cannot instantiate v'. $fr .': probably permission denied'); } } function e2s_instantiate ($parameters){ global$_strings; if (vn () !== null){ die ('Remove the file "'. INSTANCE_DIR . 'instance.psa" first'); } else { if(is_numeric ($parameters['version'])) { if (bn ($parameters['version'])) { hb ($_strings['gs--instantiated-version'] .' v'. $parameters['version'],E2E_MESSAGE); q1 (kq ('e2m_frontpage', array ('page' => 1))); } } } die ('Could not create instance of engine'); } function e2_install ($databaseConfiguration,$lb){ global$_strings,$_config,$settings; if ( vn () !== null and cl () !== null and pd () ) { throw new AeInstallAlreadyInstalledException ('Instance already created and db params set'); } $databaseConfiguration -> setPrefix ($_config['db_table_prefix']); $databaseConfiguration -> setSubset ($_config['db_table_subset']); if(array_key_exists ('db_plain_password',$lb)) { $databaseConfiguration->password = qs ($lb['db_plain_password']); } if($_config['log_installs']) { Log::$a = true; if(Log::$a)sn ('install-$'); } if(Log::$a)__log ('Installer: force directories'); AeFileManager::forceAllDirectories (); if(Log::$a)__log ('Installer: write password hash'); if (!@e3 (USER_DIR . 'password-hash.psa',serialize (sha1 ($lb['password'])))) { throw new AeNotSavedException; } $settings['db']=$databaseConfiguration -> getDatabaseParamsArray (); $settings['template']=DEFAULT_TEMPLATE; $settings['language']=DEFAULT_LANGUAGE; mm ($databaseConfiguration,'check database during installation'); $dr = in ($databaseConfiguration); $sr = false; if ($dr['occupied']) { if ($dr['migrateable'] and $lb['allow_migration']) { $sr = true; if(Log::$a)__log ('Installer: data exists and migrateable'); } else { if(Log::$a)__log ('Installer: incomplete data in the database'); throw new AeInstallDatabaseOccupiedException ('Database already has some data'); } } if ($sr){ if(Log::$a)__log ('Installer: no need to create tables, will migrate'); try { hn ($databaseConfiguration); } catch (AeMySQLException $e){ v3 ($e,'Could not migrate'); hb ($_strings['er--double-check-db-params']); } hd ($databaseConfiguration); } else { if(Log::$a)__log ('Installer: create tables'); foreach(AeModel::unprefixedCoreTablesNames () as $pv){ bm ($databaseConfiguration,$pv); } } if(Log::$a)__log ('Installer: write settings'); if (!@e3 (USER_DIR . 'settings.json',json_encode ($settings,E2_JSON_STYLE))) { throw new AeNotSavedException; } if(Log::$a)__log ('Installer: search index'); $ar = rd (cl ()); try { $ar -> erase (); } catch (\S2\Rose\Exception\RuntimeException $e){ if(Log::$a)__log ('Installer: Rose not available'); } e2_drop_all_kinds_of_cache (); ad (USER_DIR); xm ($databaseConfiguration); if(Log::$a)__log ('Installer: instantiate'); bn (E2_VERSION); if(Log::$a)__log ('Installer: complete'); } function e2s_install () { global$_strings,$_db,$_config; if ( vn () !== null and cl () !== null and pd () ) { q1 (); } $databaseConfiguration = hs ( USER_DIR . BACKUP_DIRNAME, $_POST, $_config['db_table_prefix'], $_config['db_table_subset'] ); foreach($databaseConfiguration -> getDatabaseParamsArray () as $a3 => $q3){ k1 ('install_db_'. $a3,$q3); } if (!array_key_exists ('password',$_POST) or trim ($_POST['password']) == ''){ hb ($_strings['er--no-password-entered'],E2E_USER_ERROR); q1 (kq ('e2m_frontpage')); } $qr = trim ($_POST['password']); @session_start (); $lr = false; try { e2_install ($databaseConfiguration, [ 'allow_migration' => true, 'password' => $qr, ]); $lr = true; } catch (AeMySQLCannotConnectException $e){ hb ( $_strings['er--cannot-connect-to-db']. ':<br />'. mysqli_connect_error () .' ('. mysqli_connect_errno () .')' ); } catch (AeMySQLTooOldException $e){ hb (e2l_get_string ('er--dbs-version-too-old', [ 'dbs' => $_db['software'], 'v1' => $_db['version'], 'v2' => $_db['version-minimum'], ])); } catch (AeMySQLException $e){ hb ($_strings['er--cannot-find-db'] .' '. $databaseConfiguration->name); } catch (AeInstallDatabaseOccupiedException $e){ hb ($_strings['er--db-data-incomplete-install']); } catch (AeNotSavedException $e){ hb ($_strings['er--settings-not-saved'],E2E_PERMISSIONS_ERROR); } catch (AeInstallException $e){ } yn (); if (!$lr)q1 (kq ('e2m_frontpage', ['page' => 1])); $zr['sessions'] = [[ 'stamp' => time (), 'remote_ip' => id (), 'key_hash' => cs (true), 'ua' => $_SERVER['HTTP_USER_AGENT'], ]]; if (!ys ($zr)) { hb ($_strings['er--cannot-write-auth-data'],E2E_PERMISSIONS_ERROR); } vv (kq ('e2s_bsi_step', array ())); q1 (); } function yn () { if ((strpos ($_SERVER['SERVER_SOFTWARE'],'Apache')!==0)) return; if(Log::$a)__log ('Running on Apache'); $kr = SYSTEM_DEFAULTS_DIR . 'default.htaccess'; $xr = false; if (!is_file ($kr)) { echo 'File not found: '.$kr. '. Please use the full Aegea installation package.'; die; } if(is_file ('.htaccess')) { if(Log::$a)__log ('There is an .htaccess file in the installation directory'); $er = file_get_contents ($kr); $rr = file_get_contents ('.htaccess'); if ($rr != $er){ $xr = true; $tr = $jr = '.htaccess.old'; $hr = 1; while (is_file ($jr)) { $jr = $tr .'.'. $hr ++; } if(Log::$a)__log ('Existing .htaccess wrong, backing up as <'. $jr .'>'); if (!@rename ('.htaccess',$jr)) { if(Log::$a)__log ('Installer: fuck'); echo 'Looks like you are using Apache and have put an incorrect ".htaccess" file in the installation directory. Additionally, the installer was not able to back up your existing ".htaccess" file in order to replace it with the correct one. Please use the full E2 installation package and grant write access on the installation target directory, all the files and subdirectories.'; die; } } } else { $xr = true; } if ($xr){ if(Log::$a)__log ('Writing a correct .htaccess file'); if (!@copy ($kr,'.htaccess')) { if(Log::$a)__log ('Fuck'); echo 'The installer was not able to create a correct ".htaccess" file. Please grant write access on the installation target directory.'; die; } @chmod ('.htaccess',E2_NEW_FILES_RIGHTS); } } function e2j_check_db_config () { global$_db,$_strings,$_config; $databaseConfiguration = hs ( USER_DIR . BACKUP_DIRNAME, $_POST, $_config['db_table_prefix'], $_config['db_table_subset'] ); $bl = [ 'success' => true, 'data' => [ 'message' => '', 'db-responding' => false, 'db-connected' => false, 'db-found' => false, 'db-compatible' => false, 'db-occupied' => false, 'db-migrateable' => false, ] ]; try { mm ($databaseConfiguration,'connect to check DB config (try 1)'); } catch (AeMySQLAccessDeniedException $e){ $bl['data']['db-responding']=true; $bl = json_encode ($bl); die ($bl); } catch (AeMySQLCannotConnectException $e){ $bl = json_encode ($bl); die ($bl); } catch (AeMySQLTooOldException $e){ $bl['data']['db-responding']=true; $bl['data']['db-connected']=true; $bl['data']['message']=e2l_get_string ('er--dbs-version-too-old', [ 'dbs' => $_db['software'], 'v1' => $_db['version'], 'v2' => $_db['version-minimum'], ]); $bl = json_encode ($bl); die ($bl); } catch (AeMySQLNotFoundException $e){ $bl['data']['db-responding']=true; $bl['data']['db-connected']=true; if($databaseConfiguration->name){ $bl = json_encode ($bl); die ($bl); } else { $gr = pn ($databaseConfiguration); if(count ($gr)>0){ $bl['data']['db-found']=true; $databaseConfiguration->name = $gr[0]; } else { $bl = json_encode ($bl); die ($bl); } } } $bl['data']['db-responding']=true; $bl['data']['db-connected']=true; $bl['data']['db-found']=true; $bl['data']['db-compatible']=true; try { mm ($databaseConfiguration,'connect to check DB config (try 2)'); } catch (AeMySQLException $e){ $bl = json_encode ($bl); die ($bl); } $bl['data']['db-good']=true; $dr = in ($databaseConfiguration); if ($dr['occupied']) { if ($dr['migrateable']) { $bl['data']['message']=$_strings['gs--data-exists']; } else { $bl['data']['db-good']=false; $bl['data']['message']=$_strings['er--db-data-incomplete-install']; } } $bl = json_encode ($bl); die ($bl); } function e2j_list_databases () { global$_config; $databaseConfiguration = hs ( USER_DIR . BACKUP_DIRNAME, $_POST, $_config['db_table_prefix'], $_config['db_table_subset'] ); $wr = []; $bl = [ 'success' => true, 'data' => [ 'databases-list' => [] ] ]; try { $wr = pn ($databaseConfiguration); $bl['data']['databases-list']=$wr; } catch (AeMySQLException $e){} $bl = json_encode ($bl); die ($bl); } if(substr ((string) @$_SERVER['HTTP_ACCEPT_LANGUAGE'],0,2)=='ru'){ define ('DEFAULT_LANGUAGE','ru'); } else { define ('DEFAULT_LANGUAGE','en'); } function e2l_get_string ($ur,$lb){ global$_strings; $name = $_strings[$ur]; if(preg_match_all ('/\$\[(.+?)\]/u',$name,$me,PREG_SET_ORDER)) { foreach ($me as $ir){ $or_ = $ir[1]; $o7 = ''; if(strstr ($or_,'.')) list ($or_,$o7)=explode ('.',$or_,2); if(array_key_exists ($or_,$lb)) { if ($o7){ $name = str_replace ($ir[0],e2l__format_value ($o7,$lb[$or_],$ur),$name); } else { $name = str_replace ($ir[0],$lb[$or_],$name); } } } } return$name; } function e2l__format_value ($o7,$cv,$ur){ @list ($o7,$pr)=explode ('.',$o7,2); $ct = 'e2lstr_'. $o7; if(function_exists ($ct)) { return call_user_func ($ct,$cv,$pr,$ur); } else { return $cv; } return $cv; } function nn () { global$_lang,$settings; if ( array_key_exists ('language',$settings) and is_file ($vt = SYSTEM_DIR . LANGUAGES_DIRNAME . $settings['language'] .'.php') ) { $_lang = $settings['language']; include $vt; } elseif(is_file ($vt = SYSTEM_DIR . LANGUAGES_DIRNAME . DEFAULT_LANGUAGE .'.php')) { $_lang = DEFAULT_LANGUAGE; include $vt; } else { die ('Language file missing: '. $vt); } return e2l_load_strings (); } class Log { public static $a = false; public static $st = false; } function dn () { global$_config; $at = INSTANCE_DIR . LOGS_DIRNAME . MAIN_LOG_FILENAME; if ( $_config['write_log'] and ($_config['write_log_create'] or is_file ($at)) ) { Log::$a = true; Log::$st = true; } else { Log::$a = false; Log::$st = false; } if (!Log::$a) return; @bq (INSTANCE_DIR . LOGS_DIRNAME); if($_config['write_log_reset']) { @file_put_contents ($at,''); @chmod ($at,E2_NEW_FILES_RIGHTS); } if (@$_config['write_log_limit'] and is_file ($at)) { $ud = @stat ($at); $ud = $ud['size']; if ($ud > $_config['write_log_limit']) { @rename ($at,$at .'.bak'); @chmod ($at .'.bak',E2_NEW_FILES_RIGHTS); @file_put_contents ($at,''); } } __log ('────────────────────────────────────────────────────────────────────────────────'); } function sn ($qt = false) { static $lt = false; if ($qt === false) return $lt; if ($qt === '') return $lt = false; $gd = str_replace ( '$',gmdate ('Y-m-d-\a\t-H-i-s'),$qt ); return $lt = $gd; } function __log ($q1){ static $kt; global$_stopwatch; $xt = sn (); $at = INSTANCE_DIR . LOGS_DIRNAME . MAIN_LOG_FILENAME; $et = ''; $rt = str_pad (round (mq () - $_stopwatch,5),10,' ',STR_PAD_RIGHT); if ($q1[0]=='}'){ -- $kt; if ($kt < 0)$kt = 0; } $tt = ( E2_RUN_ID .' '. $et .''. $rt .' '. str_repeat (' ',$kt * 2). $q1 . "\n" ); if ($q1[strlen ($q1)-1]=='{'){ ++ $kt; } $hy = FILE_APPEND; if(Log::$st){ @file_put_contents ($at,$tt,$hy); @chmod ($at,E2_NEW_FILES_RIGHTS); } if ($xt !== false){ $gd = INSTANCE_DIR . LOGS_DIRNAME . $xt .'.log'; @bq (INSTANCE_DIR . LOGS_DIRNAME); @file_put_contents ($gd,$tt,$hy); @chmod ($xt,E2_NEW_FILES_RIGHTS); } if ($q1[0]=='#'){ $jt = INSTANCE_DIR . LOGS_DIRNAME . 'debug.log'; @bq (dirname ($jt). '/'); @file_put_contents ($jt,$tt,$hy); @chmod ($jt,E2_NEW_FILES_RIGHTS); } } function an ($ht){ @e3 ( USER_DIR .'ctree.php', "<?php\r\n\r\n". var_export ($ht,true). "\r\n\r\n?>php" ); } function qn () { $at = INSTANCE_DIR . LOGS_DIRNAME . MAIN_LOG_FILENAME; @bq (INSTANCE_DIR . LOGS_DIRNAME); @file_put_contents ($at,''); @chmod ($at,E2_NEW_FILES_RIGHTS); } define ('MAIL_ENABLED', !in_array ('mail',explode (',',ini_get ('disable_functions')))); function ln ($gt,$content){ $wt = SYSTEM_DEFAULTS_DIR .'mail/'. $gt .'.mtmpl.php'; if(is_file ($wt)) { ob_start (); include $wt; $ba = ob_get_contents (); ob_end_clean (); return trim ($ba); } } function zn () { global$_config; $ut = $_config['mail_from']; if ($ut[strlen ($ut)-1]=='@'){ $ut .= $_SERVER['HTTP_HOST']; } return $ut; } function kn ($it,$subject,$dq,$ot = ''){ global$_config; if($_config['dev_mail_debug']) { $w = 'mail-debug'; $tv = basename (tempnam ($w,'m-')); $q1 = ( 'To:       '.$it ."\n". 'Subject:  '.$subject ."\n". $ot ."\n". "--------------------------------------------------\n". $dq ); e3 ($w .'/'. $tv,$q1); chmod ($w .'/'. $tv,E2_NEW_FILES_RIGHTS); rename ($w .'/'. $tv,$w .'/'. $tv.'.txt'); } $subject = '=?UTF-8?B?'. base64_encode ($subject) .'?='; $ot .= "\r\nContent-Type: text/plain; charset=utf-8"; if(MAIL_ENABLED){ mail ($it,$subject,$dq,trim ($ot)); } } function xn ($parameters,$pt){ global$settings; $c5['each'] = []; $c5['reorderable?']=false; $ed = bf (true,true); if ($ed === null or $ed === 0) return $c5; if (!@$settings['appearance']['show_main_menu']) return $c5; return $c5; } function en ($e2_){ foreach ($e2_ as $uq) if ($uq['visible?']) return true; return false; } function rn () { global$settings,$_strings,$_current_url; $f5 = ff (); return [ [ 'sort-id' => 'f', 'href' => kq ('e2m_favourites', ['page' => 1]), 'content-classes' => ['favourites'], 'svg-id' => 'favourite-on', 'title' => $_strings['nm--favourites'], 'current?' => AeMainMenuManager :: $isFavouritesCurrent, 'parent?' => AeMainMenuManager :: $isFavouritesParent, 'visible?' => (bool) @$settings['menu_items']['favourites_on'], 'available?' => true, ], [ 'sort-id' => 'h', 'href' => kq ('e2m_most_commented', ['page' => 1]), 'content-classes' => ['most-commented'], 'svg-id' => 'comments', 'title' => $_strings['nm--most-commented'], 'current?' => AeMainMenuManager :: $isMostCommentedCurrent, 'parent?' => AeMainMenuManager :: $isMostCommentedParent, 'visible?' => (bool) @$settings['menu_items']['most_commented_on'], 'available?' => true, ], [ 'sort-id' => 'p', 'href' => kq ('e2m_popular', ['page' => 1]), 'content-classes' => ['popular'], 'svg-id' => 'read', 'title' => $_strings['nm--most-read'], 'current?' => AeMainMenuManager :: $isPopularCurrent, 'parent?' => AeMainMenuManager :: $isPopularParent, 'visible?' => (bool) @$settings['menu_items']['popular_on'], 'available?' => true, ], [ 'sort-id' => 't', 'href' => kq ('e2m_tags'), 'svg-id' => 'tags', 'title' => $_strings['gs--tags'], 'current?' => AeMainMenuManager :: $isTagsCurrent, 'parent?' => AeMainMenuManager :: $isTagsParent, 'visible?' => (bool) @$settings['menu_items']['tags_on'], 'available?' => true, ], [ 'sort-id' => 'c', 'href' => p (), 'content-classes' => ['day','month','year'], 'svg-id' => 'calendar', 'title' => $_strings['gs--calendar'], 'current?' => AeMainMenuManager :: $isCalendarCurrent, 'parent?' => AeMainMenuManager :: $isCalendarParent, 'visible?' => (bool) @$settings['menu_items']['calendar_on'], 'available?' => true, ], [ 'sort-id' => 'r', 'href' => $f5? $f5 : kq ('e2m_frontpage', ['page' => 1]), 'svg-id' => 'dice', 'title' => $_strings['nm--random-note'], 'current?' => $_current_url === $f5, 'parent?' => false, 'visible?' => $f5 !== false and (bool) @$settings['menu_items']['random_on'], 'available?' => $f5 !== false, ], ]; } function tn ($candy,$d5,$s5,$a5,$q5){ global $_config, $_template, $_newsfeeds, $_current_url, $_canonical_url; $meta['base-href']=AeEnv::$base_url; $meta['current-href']=$_current_url; $meta['canonical-href']=$_canonical_url; $meta['stylesheets']=v2 (); $meta['scripts']=b2 (); $meta['newsfeeds']=$_newsfeeds; $meta['favicon-type']='image/x-icon'; $meta['favicon-href']='favicon.ico'; if ($l5 = tv ()) { $meta['favicon-type']=md ($l5); $meta['favicon-href']=$l5; $meta['apple-touch-icon-href']=tv ('square'); } $meta['navigation-links'] = [[ 'rel' => 'index', 'href' => kq ('e2m_frontpage', ['page' => 1]), 'id' => 'link-index', ]]; if (!empty ($q5)) { foreach (['prev','next','earlier','later'] as $z5){ if(array_key_exists ($z5 .'-href',$q5)) { $k5 = $z5; if ($z5 == 'earlier')$k5 = 'prev'; if ($z5 == 'later')$k5 = 'next'; $y1 = $q5[$z5 .'-href']; if ($y1 === 'javascript:;') continue; $meta['navigation-links'][] = [ 'rel' => $k5, 'href' => $y1, 'id' => 'link-'. $z5, ]; } } } if (!isset ($_template))lf (); $meta['viewport']=$_template['meta_viewport']; if(is_file ($_config['path_media'].'manifest.json')) { $meta['manifest-href']=AeEnv::$base_url .'manifest.json'; } $meta['og-images'] = []; if(is_array ($d5['only']['og-images'])) { $meta['og-images']=$d5['only']['og-images']; $meta['twitter-card']='summary_large_image'; } if(is_array (@$s5['og-images'])) { $meta['og-images']=$s5['og-images']; $meta['twitter-card']='summary_large_image'; } if (!count ($meta['og-images'])) { $meta['og-images'] = array ($a5['userpic-large-href']); $meta['twitter-card']='summary'; } return$meta; } function jn (AeDatabaseConfiguration $databaseConfiguration){ $x5 = $databaseConfiguration -> getSubset (); if ($x5 < 1){ throw new LogicException ('Subset to set in place of zero must be greater than 0'); } mm ($databaseConfiguration,'prepare migrate db'); dm ($databaseConfiguration,'SET sql_quote_show_create=1'); } function hn (AeDatabaseConfiguration $databaseConfiguration){ $prefix = $databaseConfiguration -> getPrefix (); $x5 = $databaseConfiguration -> getSubset (); if ($x5 < 1){ throw new LogicException ('Subset to set in place of zero must be greater than 0'); } mm ($databaseConfiguration,'migrate db'); dm ($databaseConfiguration,'SET sql_quote_show_create=1'); gn ($databaseConfiguration); un ($databaseConfiguration); if(Log::$a)__log ('Get existing table information {'); $e5 = false; foreach(AeModel::unprefixedCoreTablesNames () as $d2){ bm ($databaseConfiguration,$d2); dm ($databaseConfiguration,"SHOW CREATE TABLE `". $prefix . $d2 ."`"); $r5[$d2]=sm (); $r5[$d2]=$r5[$d2][0]['Create Table']; dm ($databaseConfiguration,"SHOW INDEX FROM `". $prefix . $d2 ."`"); $t5 = sm (); $j5 = []; $h5 = []; foreach ($t5 as $nb){ $nb = $nb['Key_name']; if ( preg_match ('/\_[0-9]+$/',$nb) or ($d2 === 'Actions' and $nb === 'EntityID') or ($d2 === 'GIPsSessions' and $nb === 'GIP') or ($d2 === 'GIPsSessions' and $nb === 'SubsetID') or ($d2 === 'Notes' and $nb === 'Title') ) { $j5[] = $nb; $h5[] = 'DROP INDEX `'. $nb. '`'; } if ($d2 === 'Actions' and $nb === 'EntityID'){ $e5 = true; } if ($d2 === 'Actions' and $nb === 'EntityIDStamp'){ $e5 = true; } } if(count ($h5)) { $h5 = implode (', ',array_unique ($h5)); $j5 = implode (', ',array_unique ($j5)); if(Log::$a)__log ( 'Drop erroneous index "'. $j5 .'" on "'. $prefix . $d2 .'"' ); dm ($databaseConfiguration, "ALTER TABLE `". $prefix . $d2 ."` ". $h5 ); } if (!strstr ($r5[$d2],'InnoDB')) { dm ($databaseConfiguration, "ALTER TABLE `". $prefix . $d2 ."` ". "ENGINE = InnoDB" ); } if (!strstr ($r5[$d2],'`SubsetID`')) { dm ($databaseConfiguration, "ALTER TABLE `". $prefix . $d2 . "` ". "ADD `SubsetID` INT UNSIGNED DEFAULT '0' NOT NULL AFTER `ID`" ); } if ( $d2 === 'Actions' and strstr ($r5['Actions'],'`ReadCount`') and !$e5 ) { wn ($databaseConfiguration); } dm ($databaseConfiguration, "UPDATE `". $prefix . $d2 ."` ". "SET `SubsetID` = ". $x5 ." ". "WHERE `SubsetID` = 0" ); } if(Log::$a)__log ('}'); if (!strstr ($r5['Actions'],'`ReadCount`')) { dm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Actions` ". "ADD `ReadCount` INT DEFAULT '0' NOT NULL" ); } if(strstr ($r5['Actions'],'`HitCount`')) { dm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Actions` ". "DROP `HitCount`" ); dm ($databaseConfiguration, "DELETE FROM `". $prefix . "Actions` ". "WHERE `ReadCount` = 0" ); } if (!strstr ($r5['Aliases'],'`EntityType`')) { dm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Aliases` ". "ADD `EntityType` VARCHAR( 1 ) DEFAULT '' NOT NULL AFTER `ID`" ); } dm ($databaseConfiguration, "UPDATE `". $prefix . "Aliases` ". "SET `EntityType` = 'n' ". "WHERE `EntityType` = ''" ); dm ($databaseConfiguration, "DELETE FROM `". $prefix . "Aliases` ". "WHERE `ID` IN (". "SELECT `ID` FROM (". "SELECT a.`ID` FROM `". $prefix . "Aliases` a ". "LEFT OUTER JOIN `". $prefix . "Keywords` e ". "ON a.`EntityID` = e.`ID` ". "WHERE a.`EntityType` = 't' ". "AND e.`ID` IS NULL". ") AS temp". ")", 'clean up “leaked” tag aliases' ); if (!stristr ($r5['Comments'],'`Text` MEDIUMTEXT')) { dm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Comments` ". "CHANGE `Text` `Text` MEDIUMTEXT" ); } if (!stristr ($r5['Comments'],'`Reply` MEDIUMTEXT')) { if(strstr ($r5['Comments'],'`Reply`')) { dm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Comments` ". "CHANGE `Reply` `Reply` MEDIUMTEXT" ); } else { if(Log::$a)__log ('No Reply column in comments; ignored assuming a 2.11 database'); } } if (!stristr ($r5['Comments'],'`IP` VARCHAR(39)')) { dm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Comments` ". "CHANGE `IP` `IP` VARCHAR(39)  DEFAULT '' NOT NULL" ); } if (!strstr ($r5['Comments'],'`IsGIPUsed`')) { dm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Comments` ". "ADD `IsGIPUsed` TINYINT(1) DEFAULT '0' NOT NULL AFTER `IP`" ); } if (!strstr ($r5['Comments'],'`GIP`')) { dm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Comments` ". "ADD `GIP` VARCHAR(15) DEFAULT '' NOT NULL AFTER `IsGIPUsed`" ); } if (!strstr ($r5['Comments'],'`GIPAuthorID`')) { dm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Comments` ". "ADD `GIPAuthorID` VARCHAR(64) DEFAULT '' NOT NULL AFTER `GIP`" ); } if(strstr ($r5['Comments'],'`SocialType`')) { dm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Comments` ". "DROP `SocialType`" ); } if(strstr ($r5['Comments'],'`SocialID`')) { dm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Comments` ". "DROP `SocialID`" ); } if (!strstr ($r5['GIPsSessions'],'`AuthorEmail`')) { dm ($databaseConfiguration, "ALTER TABLE `". $prefix . "GIPsSessions` ". "ADD `AuthorEmail` VARCHAR(255) DEFAULT '' NOT NULL AFTER `AuthorName`" ); } if (!strstr ($r5['GIPsSessions'],'`AuthorProfileLink`')) { dm ($databaseConfiguration, "ALTER TABLE `". $prefix . "GIPsSessions` ". "ADD `AuthorProfileLink` VARCHAR(255) DEFAULT '' NOT NULL AFTER `AuthorEmail`" ); } if(strstr ($r5['Keywords'],'`ParentKeywordID`')) { dm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Keywords` ". "DROP `ParentKeywordID`" ); } if (!strstr ($r5['Keywords'],'`OriginalAlias`')) { dm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Keywords` ". "CHANGE `URLName` `OriginalAlias` VARCHAR( 64 ) DEFAULT '' NOT NULL AFTER `Keyword`" ); } if (!strstr ($r5['Keywords'],'`PageTitle`')) { dm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Keywords` ". "ADD `PageTitle` VARCHAR(255) DEFAULT '' NOT NULL AFTER `OriginalAlias`" ); } if (!stristr ($r5['Keywords'],'`Description` MEDIUMTEXT')) { dm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Keywords` ". "CHANGE `Description` `Description` MEDIUMTEXT" ); } if (!strstr ($r5['Keywords'],'`Summary`')) { dm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Keywords` ". "ADD `Summary` MEDIUMTEXT AFTER `Description`" ); } if (!strstr ($r5['Keywords'],'`Uploads`')) { dm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Keywords` ". "ADD `Uploads` MEDIUMTEXT AFTER `Summary`" ); } if (!stristr ($r5['Keywords'],'`Uploads` MEDIUMTEXT')) { dm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Keywords` ". "CHANGE `Uploads` `Uploads` MEDIUMTEXT" ); } if (!strstr ($r5['Keywords'],'`IsVisible`')) { dm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Keywords` ". "ADD `IsVisible` TINYINT(1) DEFAULT '1' NOT NULL AFTER `Uploads`" ); } dm ($databaseConfiguration, "UPDATE `". $prefix . "Keywords` SET `Summary` = '' WHERE `Summary` IS NULL" ); dm ($databaseConfiguration, "UPDATE `". $prefix . "Keywords` SET `Uploads` = '' WHERE `Uploads` IS NULL" ); if (!strstr ($r5['Notes'],'`FormatterID`')) { dm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Notes` ". "ADD `FormatterID` VARCHAR( 32 ) DEFAULT '". DEFAULT_FORMATTER ."' NOT NULL AFTER `Text`" ); } if(1){ dm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Notes` ". "CHANGE `FormatterID` `FormatterID` VARCHAR( 32 ) DEFAULT '". DEFAULT_FORMATTER ."' NOT NULL" ); } if (!strstr ($r5['Notes'],'`OriginalAlias`')) { dm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Notes` ". "CHANGE `URLName` `OriginalAlias` VARCHAR( 64 ) DEFAULT '' NOT NULL AFTER `FormatterID`" ); } if(strstr ($r5['Notes'],'`IP`')) { dm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Notes` ". "DROP `IP`" ); } if (!stristr ($r5['Notes'],'`Text` MEDIUMTEXT')) { dm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Notes` ". "CHANGE `Text` `Text` MEDIUMTEXT" ); } if (!strstr ($r5['Notes'],'`Summary`')) { dm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Notes` ". "ADD `Summary` MEDIUMTEXT AFTER `Text`" ); } if (!strstr ($r5['Notes'],'`IsIndexed`')) { dm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Notes` ". "ADD `IsIndexed` TINYINT( 1 ) DEFAULT '0' NOT NULL AFTER `IsDST`" ); } if (!strstr ($r5['Notes'],'`Uploads`')) { dm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Notes` ". "ADD `Uploads` MEDIUMTEXT AFTER `OriginalAlias`" ); } if (!stristr ($r5['Notes'],'`Uploads` MEDIUMTEXT')) { dm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Notes` ". "CHANGE `Uploads` `Uploads` MEDIUMTEXT" ); } if (!strstr ($r5['Notes'],'`IsExternal`')) { dm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Notes` ". "ADD `IsExternal` TINYINT(1) DEFAULT '0' NOT NULL AFTER `IsIndexed`" ); } if (!strstr ($r5['Notes'],'`SourceID`')) { dm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Notes` ". "ADD `SourceID` INT UNSIGNED DEFAULT '0' NOT NULL AFTER `IsExternal`" ); } if (!strstr ($r5['Notes'],'`SourceNoteID`')) { dm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Notes` ". "ADD `SourceNoteID` INT UNSIGNED DEFAULT '0' NOT NULL AFTER `SourceID`" ); } if (!strstr ($r5['Notes'],'`SourceNoteURL`')) { dm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Notes` ". "ADD `SourceNoteURL` VARCHAR(255) DEFAULT '' NOT NULL AFTER `SourceNoteID`" ); } if (!strstr ($r5['Notes'],'`SourceNoteData`')) { dm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Notes` ". "ADD `SourceNoteData` MEDIUMTEXT AFTER `SourceNoteURL`" ); } if (!strstr ($r5['Notes'],'`SourceNoteJSONURL`')) { dm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Notes` ". "ADD `SourceNoteJSONURL` VARCHAR(255) DEFAULT '' NOT NULL AFTER `SourceNoteData`" ); } if(strstr ($r5['Notes'],'`SourceMainImageURL`')) { dm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Notes` ". "DROP `SourceMainImageURL`" ); } if(strstr ($r5['Notes'],'`IsIssue`')) { dm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Notes` ". "DROP `IsIssue`" ); } if (!strstr ($r5['Notes'],'`ReadCount`')) { dm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Notes` ". "ADD `ReadCount` INT UNSIGNED DEFAULT '0' NOT NULL AFTER `IsExternal`" ); dm ($databaseConfiguration, "UPDATE `". $prefix . "Notes` n JOIN (". "SELECT `EntityID`, SUM(`ReadCount`) `AggregateReadCount` ". "FROM  `". $prefix . "Actions` ". "GROUP BY `EntityID`". ") a ON n.`ID` = a.`EntityID` ". "SET `ReadCount` = `AggregateReadCount`" ); } dm ($databaseConfiguration, "UPDATE `". $prefix . "Notes` SET `Summary` = '' WHERE `Summary` IS NULL" ); dm ($databaseConfiguration, "UPDATE `". $prefix . "Notes` SET `Uploads` = '' WHERE `Uploads` IS NULL" ); dm ($databaseConfiguration, "UPDATE `". $prefix . "Notes` SET `SourceNoteData` = '' WHERE `SourceNoteData` IS NULL" ); if (!strstr ($r5['Sources'],'`TrueID`')) { dm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Sources` ". "ADD `TrueID` INT UNSIGNED DEFAULT '0' NOT NULL AFTER `ID`" ); dm ($databaseConfiguration, "UPDATE `". $prefix . "Sources` ". "SET `TrueID` = `ID`" ); } if(Log::$a)__log ('Ensure indexes {'); if(strstr ($r5['Notes'],'`Title` (`Title`(191))')) { if(Log::$a)__log ('Drop erroneous index on "'. $prefix .'Notes.Title"'); dm ($databaseConfiguration, "ALTER TABLE `". $prefix ."Notes` ". "DROP INDEX `Title`" ); } foreach(AeModel::unprefixedCoreTablesNames () as $d2){ foreach(AeModel::indexesByUnprefixedTableName ($d2) as $nb){ list ($type,$mb)=$nb; $fb = implode ('',$mb); $g5 = AeModel::indexCheckSQLByIndexType ($type).' `'. $fb .'` (`'. implode ('`,`',$mb) .'`)'; $db = AeModel::indexCreateSQLByIndexType ($type).' `'. $fb .'` (`'. implode ('`, `',$mb) .'`)'; if (!strstr ($r5[$d2],$g5)) { if(Log::$a)__log ( 'Table "'. $prefix . $d2 .'" is missing "'. AeModel::indexCheckSQLByIndexType ($type) .'" on columns "'. implode ('", "',$mb) .'"' ); dm ($databaseConfiguration, "ALTER TABLE `". $prefix . $d2 ."` ". "ADD ". $db ); } } } if(Log::$a)__log ('}'); return true; } function gn (AeDatabaseConfiguration $databaseConfiguration){ if(Log::$a)__log ('Ensure encoding utf8mb4 on all native tables {'); foreach(AeModel::unprefixedCoreTablesNames () as $w5){ $u5 = $databaseConfiguration -> getPrefix () . $w5; if(Log::$a)__log ('Migrate: Check table '. $u5); $i5 = vm ($databaseConfiguration,$w5); if (!$i5) continue; if(stripos ($i5['Collation'],'utf8mb4')===0) continue; if(Log::$a)__log ('Migrate: Table '. $u5 .' has a wrong encoding'); if(Log::$a)__log ('Migrate: Drop indexes of table '. $u5); dm ($databaseConfiguration, "SHOW INDEX FROM `". $u5 ."` ". "WHERE `Key_name` <> 'PRIMARY' ". "AND `Seq_in_index` = 1", 'show indexes from table '. $u5 ); $t5 = sm (); foreach ($t5 as $nb){ dm ($databaseConfiguration, "ALTER TABLE `". $u5 ."` ". "DROP INDEX `". $nb['Key_name'] ."`", 'drop index '. $nb['Key_name'] ); } if(Log::$a)__log ('Migrate: Convert table '. $u5 .' to utf8mb4'); dm ($databaseConfiguration, "ALTER TABLE `". $u5 ."` ". "CONVERT TO CHARACTER SET utf8mb4", 'convert table to character set utf8mb4' ); } if(Log::$a)__log ('}'); if(Log::$a)__log ('Ensure encoding utf8mb4 on all Rose tables {'); foreach (ed () as $o5){ $u5 = ( $databaseConfiguration -> getPrefix () . SEARCH_EXTRA_PREFIX . $o5 ); if(Log::$a)__log ('Migrate: Check table '. $u5); $i5 = vm ($databaseConfiguration,SEARCH_EXTRA_PREFIX . $o5); if (!$i5) continue; if(stripos ($i5['Collation'],'utf8mb4')===0) continue; if(Log::$a)__log ('Some Rose tables have a wrong encoding, will need to erase and recreate them all'); hd ($databaseConfiguration); break; } if(Log::$a)__log ('}'); } function wn (AeDatabaseConfiguration $databaseConfiguration){ $prefix = $databaseConfiguration -> getPrefix (); if(Log::$a)__log ( 'Table "'. $prefix .'Actions" is missing necessary UNIQUE index, must rearrange {' ); dm ($databaseConfiguration, "DROP TABLE IF EXISTS `". $prefix ."Actions_Fixed`", 'remove temporary Actions_Fixed table if exists' ); dm ($databaseConfiguration, "CREATE TABLE `". $prefix ."Actions_Fixed` ". "LIKE `". $prefix ."Actions`", 'create new temporary Actions_Fixed table' ); dm ($databaseConfiguration, "ALTER TABLE `". $prefix ."Actions_Fixed` ". "ADD UNIQUE INDEX(`EntityID`, `Stamp`)", 'add UNIQUE index to the temporary Actions_Fixed table' ); dm ($databaseConfiguration, "INSERT INTO `". $prefix ."Actions_Fixed` (`SubsetID`, `EntityID`, `Stamp`, `ReadCount`) ". "SELECT `SubsetID`, `EntityID`, `Stamp`, `AggregateReadCount` FROM (". "SELECT `SubsetID`, `EntityID`, `Stamp`, SUM(`ReadCount`) `AggregateReadCount` ". "FROM `". $prefix ."Actions` ". "GROUP BY `EntityID`, `Stamp`". ") `". $prefix ."Actions_Fixed_AliasRequiredForNoReason`", 'rearrange Actions records from existing problematic Actions table to the new temporary Actions_Fixed table' ); dm ($databaseConfiguration, "RENAME TABLE `". $prefix ."Actions` TO `". $prefix ."Actions_Corrupt`", 'rename Actions to Actions_Corrupt' ); dm ($databaseConfiguration, "RENAME TABLE `". $prefix ."Actions_Fixed` TO `". $prefix ."Actions`", 'rename Actions_Fixed to Actions' ); dm ($databaseConfiguration, "DROP TABLE `". $prefix ."Actions_Corrupt`", 'remove Actions_Corrupt table' ); if(Log::$a)__log ('}'); } function un ($databaseConfiguration){ global$_db; $p5 = ( "(0 ". "OR `Text` LIKE '%!!%' ". "OR `Text` LIKE '%||%' ". "OR `Text` LIKE '%\%\%%' ". "OR `Text` LIKE '%##%' ". "OR `Text` LIKE '%++%' ". "OR `Text` LIKE '%((html%' ". "OR `Text` LIKE '%((img%' ". "OR `Text` LIKE '%((link%' ". "OR `Text` LIKE '%((%.jpg%' ". "OR `Text` LIKE '%((%.jpeg%' ". "OR `Text` LIKE '%((%.gif%' ". "OR `Text` LIKE '%((%.png%' ". "OR `Text` LIKE '%((%.webp%' ". "OR `Text` LIKE '%[[html%' ". "OR `Text` LIKE '%[[img%' ". "OR `Text` LIKE '%[[link%' ". "OR `Text` LIKE '%[[%.jpg%' ". "OR `Text` LIKE '%[[%.jpeg%' ". "OR `Text` LIKE '%[[%.gif%' ". "OR `Text` LIKE '%[[%.png%' ". "OR `Text` LIKE '%[[%.webp%' ". ")" ); if(Log::$a)__log ('Switch from Calliope to Neasden {'); dm ($databaseConfiguration, "UPDATE `". $databaseConfiguration -> getPrefix () . "Notes` ". "SET `FormatterID` = 'neasden' ". "WHERE `SubsetID`=". $databaseConfiguration -> getSubset () ." ". "AND `FormatterID` = 'calliope' ". "AND (". "`IsPublished` = '0' ". "OR (". "`IsPublished` = '1' ". "AND !". $p5. ")". ")" ); if(Log::$a)__log (mysqli_affected_rows ($_db['link']) .' drafts and notes with simple formatting switched'); dm ($databaseConfiguration, "SELECT `ID` FROM `". $databaseConfiguration -> getPrefix () . "Notes` ". "WHERE `SubsetID`=". $databaseConfiguration -> getSubset () ." ". "AND `FormatterID` = 'calliope'" ); $bf = sm (); if(Log::$a)__log (count ($bf) .' with complex formatting remain'); if(count ($bf)>0){ $hv = 'AEGEA-LEGACY-REVIEW'; $cj = da ($databaseConfiguration,$hv); if (!$cj){ $cj['ID']=na ($databaseConfiguration,$hv,false); } if(Log::$a)__log ('Tag "'. $hv .'" has ID '. $cj['ID']); foreach ($bf as $sy){ fm ( "INSERT INTO `". $databaseConfiguration -> getPrefix () . "NotesKeywords` ". "(`SubsetID`, `NoteID`, `KeywordID`) ". "VALUES (". ((int)$databaseConfiguration -> getSubset ()) .", ". ((int)$sy['ID']) .", ". ((int)$cj['ID']). ")", 'add new tag bindings' ); } $jl = 'Aegea legacy notes for review'; $i1 = 'These notes were automatically converted from a very old version of Aegea and may have formatting problems. Please edit them to fix these problems. When finished, just delete this tag.'; dm ($databaseConfiguration, "UPDATE `". $databaseConfiguration -> getPrefix () . "Keywords` ". "SET `IsVisible` = 0, `IsFavourite` = 1, ". "`PageTitle` = '". $jl ."', ". "`Description` = '". $i1 ."' ". "WHERE `SubsetID`=". $databaseConfiguration -> getSubset () ." ". "AND `ID` = " . $cj['ID'] ); dm ($databaseConfiguration, "UPDATE `". $databaseConfiguration -> getPrefix () . "Notes` ". "SET `FormatterID` = 'neasden' ". "WHERE `SubsetID`=". $databaseConfiguration -> getSubset () ." ". "AND `FormatterID` = 'calliope'" ); if(Log::$a)__log ('Switched '. mysqli_affected_rows ($_db['link']) .' notes with complex formatting'); } if(Log::$a)__log ('}'); } function in (AeDatabaseConfiguration $databaseConfiguration){ global$_db; $vj = false; $bj = array (); $sql = ( 'SHOW TABLES FROM `'. mysqli_real_escape_string ( $_db['link'],$databaseConfiguration->name ). '`' ); if(Log::$a)__log ('DB [?]: '. $sql); $e3 = mysqli_query ($_db['link'],$sql); if ($e3){ while ($x2 = mysqli_fetch_row ($e3)) { foreach(AeModel::unprefixedCoreTablesNames () as $w5){ if(strcasecmp ($x2[0],$databaseConfiguration -> getPrefix () . $w5)===0){ $vj = true; $bj[] = $w5; } } } } $yj = true; foreach(AeModel::unprefixedCoreTablesNames () as $w5){ if (!in_array ($w5,$bj)) { $yj = false; } } $nj = true; foreach(AeModel::unprefixedEssentialTablesNames () as $w5){ if (!in_array ($w5,$bj)) { $nj = false; } } return array ( 'occupied' => $vj, 'complete' => $yj, 'migrateable' => $nj, ); } function on ($databaseConfiguration){ mm ($databaseConfiguration); $dr = in ($databaseConfiguration); if (!$dr['occupied']) { throw new AeMySQLNoDataException ('Database is empty'); } if (!$dr['migrateable']) { throw new AeMySQLNotMigrateableException ('Database is not migrateable'); } } function pn (AeDatabaseConfiguration $databaseConfiguration){ global $id; if (($cx = mysqli_connect ( 'p:'. $databaseConfiguration->host, $databaseConfiguration->user, ls ($databaseConfiguration->password), '', $databaseConfiguration->port )) === false) return []; $gr = []; $mj = [ 'information_schema', 'performance_schema', 'sys', 'mysql' ]; @$id ++; $l2 = 'SHOW DATABASES'; if(Log::$a)__log ('DB ['. $id .']: '. $l2); $e3 = mysqli_query ($cx,$l2); if ($e3 === false){ throw new AeMySQLQueryException ( "Could not list databases\n\nMySQL says:\n". mysqli_error ($cx) ); } while ($x2 = mysqli_fetch_row ($e3)) { if(mysqli_select_db ($cx,$x2[0]) and !in_array ($x2[0],$mj)) { $gr[] = $x2[0]; } } return $gr; } function cm ($databaseConfiguration,$d2){ dm ( $databaseConfiguration, "SHOW TABLES LIKE '". $databaseConfiguration -> getPrefix () . $d2 . "'" ); $l6 = sm (); return count ($l6)>0; } function vm ($databaseConfiguration,$d2){ dm ( $databaseConfiguration, "SHOW TABLE STATUS LIKE '". $databaseConfiguration -> getPrefix () . $d2 . "'" ); $e3 = sm (); return $e3 ? $e3[0] : []; } function bm ($databaseConfiguration,$d2){ if (cm ($databaseConfiguration,$d2)) return; dm ( $databaseConfiguration, "CREATE TABLE `". $databaseConfiguration -> getPrefix () . $d2 ."` ". AeModel::columnsAndIndexesSQLByUnprefixedTableName ($d2) ." ". "ENGINE=InnoDB DEFAULT CHARSET=utf8mb4" ); } function ym (AeDatabaseConfiguration $databaseConfiguration,$d2,$r4,$fj = 'INSERT',$dj = ''){ global$_db; $sj['SubsetID']=$databaseConfiguration -> getSubset (); foreach ($r4 as $a3 => $q3){ $sj[$a3]="'". am ($q3) ."'"; } $aj = "`". implode ("`, `",array_keys ($sj)). "`"; $qj = implode (", ",array_values ($sj)); dm ( $databaseConfiguration, $fj ." INTO `". $databaseConfiguration -> getPrefix () . $d2 ."` ". "(" . $aj .") VALUES (". $qj .")". ($dj? (' '. $dj):'') ); $r4['ID']=mysqli_insert_id ($_db['link']); return $r4; } function nm (AeDatabaseConfiguration $databaseConfiguration,$d2,$r4,$lj = false,$zj = false){ if(Log::$a)__log ('Model: update record in table '. $d2 .' {'); $kj = array (); foreach(AeModel::softFieldsByUnprefixedTableName ($d2) as $x){ if(array_key_exists ($x,$r4)) { $kj[] = '`'. $x .'`'."='". am ($r4[$x]) ."'"; } } $xj = array (); if(is_array ($lj)) { foreach(AeModel::softFieldsByUnprefixedTableName ($d2) as $x){ if(array_key_exists ($x,$lj)) { $xj[] = '`'. $x .'`'."='". am ($lj[$x]) ."'"; } } } if(count ($xj)) { $c1 = implode (" AND ",$xj); } else { if (!array_key_exists ('ID',$r4) or !is_numeric ($r4['ID'])) { if(Log::$a)__log ('Error: e2_update_record must be called with an ID field in $record when updating single row'); return false; } $c1 = "`ID`=". $r4['ID']; } if(count ($kj)>0){ $ej = $zj? 'LOW_PRIORITY ' : ''; dm ( $databaseConfiguration, "UPDATE ". $ej ."`". $databaseConfiguration -> getPrefix () . $d2 ."` ". "SET ". implode (', ',$kj) ." ". "WHERE `SubsetID`=". $databaseConfiguration -> getSubset () ." ". "AND (". $c1 .")" ); } if(Log::$a)__log ('}'); return true; } define ('E2_MYSQL_CONNECT_TIMEOUT',5); function mm (AeDatabaseConfiguration $databaseConfiguration,$rj = ''){ static $tj = false; static $jj = false; global $_instance_config, $_db, $id; if ($tj !== $databaseConfiguration -> getServerKeyString ()) { if(Log::$a)__log ('Ensure: Establishing connection "'. $databaseConfiguration -> getServerKeyString () .'"'); if ($tj !== false){ mysqli_close ($_db['link']); } $hj = mysqli_init (); $hj -> options (MYSQLI_OPT_CONNECT_TIMEOUT,E2_MYSQL_CONNECT_TIMEOUT); if($_instance_config['dev_chaos'] and !rand (0, (1 / $_instance_config['dev_chaos']) - 1)) { throw new AeMySQLCannotConnectException ('Could not '. $rj ."\n\nChaos"); } $gj = @mysqli_real_connect ( $hj, 'p:'. $databaseConfiguration->host, $databaseConfiguration->user, ls ($databaseConfiguration->password), '', $databaseConfiguration->port ); if (!$gj){ if(1045 === mysqli_connect_errno ()) { throw new AeMySQLAccessDeniedException ('Could not '. $rj); } else { throw new AeMySQLCannotConnectException ('Could not '. $rj); } } if (!zm ($hj)) { throw new AeMySQLTooOldException ('Could not '. $rj); }; $_db['link']=$hj; $tj = $databaseConfiguration -> getServerKeyString (); $jj = false; } if ($jj !== $databaseConfiguration->name){ if(Log::$a)__log ('Ensure: Selecting database "'. $databaseConfiguration->name .'"'); if (!@mysqli_select_db ($_db['link'],$databaseConfiguration->name)) { throw new AeMySQLNotFoundException ('Could not '. $rj); } $l2 = 'SET NAMES utf8mb4'; mysqli_query ($_db['link'],$l2); @$id ++; if(Log::$a)__log ('DB ['. $id .']: '. $l2); $jj = $databaseConfiguration->name; } } function fm ($l2,$rj = 'run some query'){ $databaseConfiguration = cl (); return dm ($databaseConfiguration,$l2,$rj); } function dm ($databaseConfiguration,$l2,$rj = ''){ global $id,$_db,$_config; mm ($databaseConfiguration,$rj); if($_config['dev_chaos'] and !rand (0, (1 / $_config['dev_chaos']) - 1)) { throw new AeMySQLQueryException ('Could not '. $rj ."\n\nChaos in e2_mysql_query"); } @$id ++; if(Log::$a) if ($rj)__log ('Will '. $rj); if(Log::$a)__log ('DB ['. $id .']: '. $l2); $_db['result'] = @mysqli_query ($_db['link'],$l2); if($_db['result']) { if($_config['backup_tail']) { if ( stripos ($l2,"SELECT")!==0 and stripos ($l2,"SHOW")!==0 ) { $gd = $databaseConfiguration->backup_dir .'backup-tail.sql'; @file_put_contents ($gd,$l2 .";\r\n\r\n",FILE_APPEND | LOCK_EX); @chmod ($gd,E2_NEW_FILES_RIGHTS); } } } else { throw new AeMySQLQueryException ('Could not '. $rj ."\n\nMySQL says:\n". mysqli_error ($_db['link'])); } } function sm ($type = MYSQLI_ASSOC){ global$_db; $cb = array (); while ($b5 = @mysqli_fetch_array ($_db['result'],$type)) { foreach ($b5 as $rb => $wj){ if(is_string ($wj)) { $b5[$rb]=$wj; } } $cb[] = $b5; } return $cb; } function am ($pl){ global$_db; mm (cl (), 'escape string'); return mysqli_real_escape_string ($_db['link'], (string)$pl); } function qm () { global$_config; $rv = array_keys (lm (USER_DIR . BACKUP_DIRNAME)); if(Log::$a)__log ('Backup: Found '. count ($rv) .' backups'); if(count ($rv)) { $uj = time () - $rv[0]; $ij = ($uj >= $_config['backup_rebase_interval']); if(Log::$a)__log ('Backup: '. $uj .' seconds since last backup'); } else { $ij = true; } if ($ij){ if(Log::$a)__log ('Backup: Will rebuild backup'); vv (kq ('e2s_dump', []), true); } } function lm ($backup_dir){ $rv = []; foreach(glob ($backup_dir .'*.sql') as $n2){ if(preg_match ('/^backup\-(\d+)\-(\d+)\-(\d+)\-at\-(\d+)\-(\d+)\-(\d+)\.sql$/is',basename ($n2),$me)) { list (, $rm,$tm,$jm,$oj,$rb,$pj)=$me; $vf = gmmktime ($oj,$rb,$pj,$tm,$jm,$rm); $rv[$vf]=$n2; } } krsort ($rv); return $rv; } function zm ($hj){ global$_db; $_db['software']='MySQL'; $_db['version-minimum']=E2_MINIMUM_MYSQL; $_db['version']=mysqli_get_server_info ($hj); $vh = strpos ($_db['version'],'-MariaDB'); if ($vh !== false){ $_db['software']='MariaDB'; $_db['version-minimum']=E2_MINIMUM_MARIADB; $_db['version']=substr ($_db['version'],0,$vh); if(substr ($_db['version'],0,6)==='5.5.5-'){ $_db['version']=substr ($_db['version'],6); } } if(Log::$a)__log ( 'Ensure: Running on "'. $_db['software'] .'", version "'. $_db['version'] .'"' ); return (version_compare ($_db['version'],$_db['version-minimum'],'>=')); } function km ($backup_dir){ $rv = lm ($backup_dir); $bh = [SECONDS_IN_A_MINUTE,SECONDS_IN_AN_HOUR,SECONDS_IN_A_DAY,SECONDS_IN_A_WEEK,SECONDS_IN_A_MONTH, -1]; $yh = count ($rv); $nh = count ($bh)-1; if ($yh > $nh){ if(Log::$a)__log ('Stored are '. $yh .' backups, over '. $nh .', will sift...'); $mh = -1; $rb = 0; foreach ($rv as $vf => $n2){ if(Log::$a)__log ('Backup '. $n2 .' ('. gmdate ('r',$vf) .')'); if ($mh == -1){ if(Log::$a)__log ('is latest, leave'); $mh = $vf; } elseif ($bh[$rb] == -1){ if(Log::$a)__log ('is too old, remove'); @unlink ($n2); } else { if ($mh - $vf < $bh[$rb]) { if(Log::$a)__log ('is not from long ago (within interval of '. $bh[$rb] .'s), remove'); @unlink ($n2); } else { $rb ++; if(Log::$a)__log ('is long enough ago, leave (proceed to interval of '. $bh[$rb] .'s)'); $mh = $vf; } } } } else { if(Log::$a)__log ('No need to sift'); } return; } function xm (AeDatabaseConfiguration $databaseConfiguration){ global$_db; if(Log::$a)__log ('Backup to '. $databaseConfiguration->backup_dir); mm ($databaseConfiguration,'make backup'); $cd = []; foreach(AeModel::unprefixedCoreTablesNames () as $d2){ $cd[] = $databaseConfiguration -> getPrefix () . $d2; } $l = time (); $gd = $databaseConfiguration->backup_dir .'backup-'.gmdate ('Y-m-d-\a\t-H-i-s',$l).'.sql'; if($databaseConfiguration -> hasSubsetSpecified ()) { $subset = $databaseConfiguration -> getSubset (); } else { $subset = null; } e2_backup ($_db['link'],$cd,$subset,$gd); @unlink ($databaseConfiguration->backup_dir .'backup-tail.sql'); km ($databaseConfiguration->backup_dir); return $gd; } function em ($fh){ $dh = parse_url ($fh); $sh = @$dh['host']; $ah = @$dh['port']; if ((string)$sh === ''){ $sh = $fh; $ah = ''; } return [$sh,$ah]; } function e2s_dump () { global$_config; if (!$_config['allow_underhood_access']) { q1 (kq ('e2m_settings')); } if($_SERVER['REQUEST_METHOD']!='POST'){ q1 (kq ('e2m_underhood')); } if (xm (cl ())) { hb ('Backed up',E2E_MESSAGE); } q1 (kq ('e2m_underhood')); } function e2m_note ($parameters = []) { global $settings, $_config, $_strings; if(Log::$a)__log ('Note {'); $sy = @$parameters['*note']; if ($sy == false) return e2m_error404 (); $qh = df ($sy); $nf = nf ($sy); $rn = vs (); $lh = ($parameters['preview-key']==$qh); if (!empty ($parameters['preview-key']) and !$lh) return e2m_error404 (); if (!$rn and !$lh and $nf !== 'public') return e2m_error404 (); if (!empty ($parameters['preview-key']) and $nf === 'public'){ unset($parameters['preview-key']); $ca = kq ('e2m_note',$parameters); q1 ($ca); } $ca = kq ('e2m_note',$parameters); $noteView = new AeNoteView ($sy); $noteView -> setWantReadHref ($_config['count_reads']); $noteView -> setWantControls ($rn and !@$_config['read_only']); $noteView -> setWantHiddenTags ($rn); if ($nf === 'draft' or $nf === 'scheduled'){ if (!$lh){ $zh = [ '.note-id' => $sy['ID'], 'form-action' => kq ('e2s_note_publish'), 'submit-text' => $_strings['fb--publish-note'], 'can-schedule?' => false, 'can-publish?' => !@$_config['read_only'], 'scheduling-promo' => e2l_get_string ( 'pm--scheduling', ['url' => $_config['paid_features_url']] ), ]; } } $kh = ''; $xh = []; $q5 = []; if ($nf === 'public'){ $noteView -> setWantNewCommentsCount ($rn); $noteView -> setWantSharingButtons (@$settings['appearance']['show_sharing_buttons']); $noteView -> setWantRelatedNotes (true); } if ($nf === 'public' or $nf === 'hidden'){ if(Log::$a)__log ('Navigation {'); $eh = gm ($sy,'prev'); $rh = gm ($sy,'next'); if ($eh){ $q5['prev-href']=kq ('e2m_note', ['*note' => $eh]); $q5['prev-title']=dy (htmlspecialchars ($eh['Title'],ENT_NOQUOTES,'UTF-8')); } if ($rh){ $q5['next-href']=kq ('e2m_note', ['*note' => $rh]); $q5['next-title']=dy (htmlspecialchars ($rh['Title'],ENT_NOQUOTES,'UTF-8')); } $q5['title']=$_strings['nm--posts']; $q5['timeline?']=false; $q5['this-title']=dy (htmlspecialchars ($sy['Title'],ENT_NOQUOTES,'UTF-8')); if(Log::$a)__log ('}'); if(Log::$a)__log ('Comments {'); if ($rn){ $th = e2_note_cache_filename_with_id_($sy['ID'] .'-comments-author'); } else { $th = e2_note_cache_filename_with_id_($sy['ID'] .'-comments'); } $jh = null; if(CACHE_NOTES_COMMENTS and is_file ($th)) { $jh = @unserialize (file_get_contents ($th)); } if(is_array ($jh)) { if(Log::$a)__log ('retrieve cached ctree'); $kh = $jh; } else { if(Log::$a)__log ('assemble ctree...'); $hh = zb ($sy['ID']); $a1 = []; $gh = true; foreach ($hh as $a3 => $ds){ if ($ds['IsVisible']) { $rs = mb ( $sy, $ds, $a3 + 1 ); if ($rs['new?'] and $gh){ $rs['first-new?']=true; $gh = false; } $a1[] = $rs; } } $kh = $a1; if(CACHE_NOTES_COMMENTS)e3 ($th,serialize ($kh)); } if ($wh = db ($sy)) { $wh['.comment-number']=count ($kh)+1; } if(Log::$a)__log ('} // Comments'); } $j3 = $noteView -> getNoteCTree (); if ($rn and xb ( $sy,NOTE_COMMENTABLE_NOW_CONDITIONALLY )) { $xh['form-action']=kq ('e2s_note_flag', [ '*note' => $sy, 'flag' => 'IsCommentable', 'value' => (int) !$sy['IsCommentable'], ]); $xh['submit-text'] = ( $sy['IsCommentable']? $_strings['bt--close-comments-to-post']:$_strings['bt--open-comments-to-post'] ); } if ($rn and $j3['new-comments-count']>0){ if(Log::$a)__log ('mark comments as not new'); e2_drop_caches_for_note_($sy['ID'],true); nm ( cl (), 'Comments', ['IsNew' => 0], ['NoteID' => $sy['ID']] ); } if(CACHE_RANDOM_NOTE and is_file (USER_DIR . CACHE_FILENAME_RANDOM_NOTE)) { $f5 = @unserialize (file_get_contents (USER_DIR . CACHE_FILENAME_RANDOM_NOTE)); if (((string)$f5)===$j3['href']) { @unlink (USER_DIR . CACHE_FILENAME_RANDOM_NOTE); } } foreach ($j3['tags'] as $hv){ AeMainMenuManager :: addParentTag ($hv['name']); } $cb = [ 'title' => $sy['Title'], 'notes' => ['only' => $j3], 'pages' => $q5, 'summary' => $j3['summary'], ]; if ($kh)$cb['comments']['each']=$kh; if ($xh)$cb['comments']['toggle']=$xh; $cb['comments']['count']=$j3['comments-count']; $cb['comments']['count-text']=$j3['comments-count-text']; $cb['comments']['new-count']=$j3['new-comments-count']; $cb['comments']['new-count-text']=$j3['new-comments-count-text']; $cb['comments']['display-form?']=xb ($sy); if (!empty ($wh)) { $cb['form']='form-comment'; $cb['form-comment']=$wh; } if (!empty ($zh)) { $cb['form']='form-note-publish'; $cb['form-note-publish']=$zh; } if(Log::$a)__log ('} // Note'); return $cb; } function e2m_note_read ($parameters = []) { global$_config; if (!$_config['count_reads']) { die ('Read counting disabled'); } $sy = $parameters['*note']; if ($sy == false) return e2m_error404 (); if(Log::$a)__log ('Note read {'); fm ( "UPDATE LOW_PRIORITY `". $_config['db_table_prefix']."Notes` ". "SET `ReadCount` = `ReadCount` + 1 ". "WHERE `ID` = ". $sy['ID'] ); $uh = time (); $uh = $uh - ($uh % SECONDS_IN_AN_HOUR); ym ( cl (), 'Actions', [ 'EntityID' => $sy['ID'], 'Stamp' => $uh, 'ReadCount' => 1, ], 'INSERT LOW_PRIORITY', 'ON DUPLICATE KEY UPDATE `ReadCount` = `ReadCount` + 1' ); fm ( "DELETE LOW_PRIORITY FROM `". $_config['db_table_prefix']."Actions` ". "WHERE (`Stamp` < ". (time () - (SECONDS_IN_A_MONTH)) .")" ); if(Log::$a)__log ('}'); q1 (kq ('e2m_note',$parameters)); } function e2m_note_withdraw ($parameters = []) { $databaseConfiguration = cl (); $s = $parameters['*note']; if (!$s) return e2m_error404 (); if($_SERVER['REQUEST_METHOD']!='POST'){ q1 (kq ('e2m_note', ['*note' => $s])); } ud (); $ih = kq ('e2m_note_broadcast', ['*note' => $s]); $s['IsPublished']=0; $s['IsCommentable']=0; $s['IsVisible']=1; $s['Stamp']=time (); $s['IP']=id (); $zy = e2_alias_of_note_with_id_($s['ID']); if ($zy){ $s['OriginalAlias']=$zy; } else { $s['OriginalAlias']=d ( USER_DIR,$databaseConfiguration, 'find','n',$s['ID'],$s['Title'] ); } e2_drop_caches_for_note_($s['ID'],null); nm ($databaseConfiguration,'Notes',$s); e2_delete_aliases_for_entity_('n',$s['ID']); kd ($s['ID']); vv ($ih); q1 (kq ('e2m_note', ['*note' => $s])); } function e2m_note_delete ($parameters = []) { global$_strings; $s = @$parameters['*note']; if (!$s) return e2m_error404 (); $nf = nf ($s); $oh = !$s['IsPublished']; if ($oh){ $ph = e2l_get_string ('gs--draft-will-be-deleted', [ 'draft' => htmlspecialchars ($s['Title'],ENT_NOQUOTES,'UTF-8'), ]); } else { $ph = e2l_get_string ('gs--post-will-be-deleted', [ 'post' => htmlspecialchars ($s['Title'],ENT_NOQUOTES,'UTF-8'), ]); } $ns = $oh? $_strings['pt--draft-deletion']:$_strings['pt--post-deletion']; $c8 = [ '.note-id' => $s['ID'], '.is-draft' => (int)$oh, 'note-title' => htmlspecialchars ($s['Title'],ENT_COMPAT,'UTF-8'), 'caution-text' => $ph, 'form-action' => kq ('e2s_note_delete'), 'submit-text' => $_strings['fb--delete'], 'draft?' => (int)$oh, ]; if ($nf === 'public'){ $c8['hide-action']=kq ( 'e2s_note_flag', [ '*note' => $parameters['*note'], 'flag' => 'IsVisible', 'value' => 0 ] ); } if ($s['IsPublished']) { $c8['withdraw-action']=kq ( 'e2m_note_withdraw',$parameters ); } $cb = [ 'title' => $ns. ': '. htmlspecialchars ($s['Title'],ENT_NOQUOTES,'UTF-8'), 'heading' => $ns, 'form' => 'form-note-delete', 'form-note-delete' => $c8, ]; return $cb; } function e2s_note_flag_favourite ($parameters){ $parameters['flag']='IsFavourite'; j1 ([ 'flag-name' => 'favourite', 'candy-name' => 'e2s_note_flag_favourite', 'parameters' => $parameters, 'flipping-function' => function () use ($parameters){ rm ($parameters); }, 'redirect-candy' => 'e2m_note', ]); } function e2s_note_flag ($parameters){ rm ($parameters); q1 (kq ('e2m_note',$parameters)); } function rm ($parameters){ if($_SERVER['REQUEST_METHOD']!='POST'){ q1 (kq ('e2m_note',$parameters)); } ud (); $note_id = $parameters['*note']['ID']; if (!is_numeric ($note_id)) throw new AeException ('Note record not cound from parameters'); e2_drop_caches_for_note_($note_id,$parameters['*note']['IsPublished']); if($parameters['flag']=='IsVisible'){ cb (); } nm (cl (), 'Notes', [ 'ID' => $note_id, $parameters['flag'] => (int) ($parameters['value']==1), ]); try { hv (hm ($note_id)); } catch (AeMySQLException $e){ v3 ($e,'Could not broadcast note flag change'); } return true; } function e2m_note_use_formatter ($parameters){ $note_id = $parameters['*note']['ID']; if (!is_numeric ($note_id)) { return e2m_error404 (); } e2_drop_caches_for_note_($note_id,$parameters['*note']['IsPublished']); if(in_array ($parameters['formatter'], ['raw','neasden'])) { nm (cl (), 'Notes', [ 'ID' => $note_id, 'FormatterID' => $parameters['formatter'], ]); echo 'formatter set to '. $parameters['formatter']; } else { echo 'unknown formatter'; } die; } function tm ($ys,$parameters = []) { global$_strings; $ns = $_strings['pt--new-post']; $ms = $_strings['pt--new-post']; $note_id = 'new'; $v8 = DEFAULT_FORMATTER; if ($ys == 'write'){ $vf = time (); $b8 = time (); $gb = ia (); $nf = 'draft'; $zy = $y8 = ''; } if ($ys == 'edit'){ $s = @$parameters['*note']; if (!$s) return e2m_error404 (); $vf = min ($s['Stamp'],time ()); $b8 = (int)$s['LastModified']; $gb = wa ($s); $nf = nf ($s); if ($s['IsPublished']) { $ms = $_strings['pt--edit-post']; $y8 = ''; $zy = e2_alias_of_note_with_id_($s['ID']); } else { $ms = $_strings['pt--edit-draft']; $y8 = d ( USER_DIR,cl (), 'find','n',$s['ID'],$s['Title'] ); if (@$s['OriginalAlias']) { $zy = $s['OriginalAlias']; } else { $zy = $y8; } } $note_id = $s['ID']; $v8 = $s['FormatterID']; $ns = $s['Title']; } $n8 = fa (); $m8 = []; if ($n8 !== null){ foreach ($n8 as $hv){ $m8[] = $hv['tag-dotted']; } } $f8 = []; if ($ys == 'edit' and count ($m8)) { $n8 = ca ($s['ID']); foreach ($n8 as $tb){ $f8[] = la ($tb); } } $d8 = []; foreach ($m8 as $s8){ $a8['tag-dotted']=$s8; $a8['selected?']=in_array ($s8,$f8); $d8[] = $a8; } $f8 = implode (', ',$f8); $ib = []; if ($ys == 'write'){ $ss = $_strings['fb--save-and-preview']; $q8 = ''; if(is_file (USER_DIR . 'new-uploads.psa')) { $q8 = @file_get_contents (USER_DIR . 'new-uploads.psa'); } $pb = @unserialize ($q8); } if ($ys == 'edit'){ if(array_key_exists ('draft',$parameters)) { $ss = $_strings['fb--save-and-preview']; } else { $ss = $_strings['fb--save-changes']; } $ib = sy ( $s['FormatterID'],$s['Text'],'full' ); $pb = @unserialize ( $s['Uploads'] ) or $pb = []; } $l8 = k2 ( a2 ( l2 ( $ib,$pb ) ) ); if ($ys == 'edit'){ i3 ( 'Notes', $s, $ib ); } $kz = vy (); $xz = by ($kz); $cb['title']=$ns; $cb['heading']=$ms; $cb['form']='form-note'; $cb['uploads'] = [ 'enabled?' => $xz, 'each' => $l8, 'default-name' => htmlspecialchars ($zy,ENT_COMPAT,'UTF-8'), 'upload-action' => kq ('e2j_file_upload'), 'remove-action' => kq ('e2j_file_remove'), ]; $cb['form-note'] = [ '.note-id' => $note_id, '.formatter-id' => $v8, '.last-modified-stamp' => $b8, '.published?' => (bool) @$s['IsPublished'], '.old-tags-hash' => md5 ($f8), '.action' => $ys, 'form-action' => kq ('e2s_note_process'), 'form-note-livesave-action' => kq ('e2j_note_livesave'), 'create:edit?' => (bool) ($ys == 'write'), 'title' => htmlspecialchars ((string) @$s['Title'],ENT_COMPAT,'UTF-8'), 'tags-info' => $d8, 'text' => htmlspecialchars ((string) @$s['Text'],ENT_NOQUOTES,'UTF-8'), 'stamp-formatted' => v1 ('d.m.Y H:i:s',$vf,$gb), 'time' => @$s['IsPublished']? [(int)$vf,$gb]:false, 'draft?' => $nf === 'draft', 'uploads-enabled?' => $xz, 'summary' => (string) @$s['Summary'], 'alias-autogenerated' => htmlspecialchars ($y8,ENT_COMPAT,'UTF-8'), 'alias' => htmlspecialchars ($zy,ENT_COMPAT,'UTF-8'), 'submit-text' => $ss, 'space-usage' => yy ($kz), ]; if ($ys == 'edit'){ $cb['related-delete-href']=kq ( 'e2m_note_delete', ['*note' => $s] ); } return $cb; } function e2m_note_edit ($parameters = []) { return tm ('edit',$parameters); } function e2m_write () { return tm ('write'); } function e2s_note_process () { global$_strings; try { $k8 = vf (); $note_id = $k8['data']['id']; $sy = hm ($note_id); q1 (kq ('e2m_note', ['*note' => $sy])); } catch (AeFormIncompleteException $e){ hb ($_strings['er--post-must-have-title-and-text'],E2E_USER_ERROR); if($e->note_id === 'new'){ q1 (kq ('e2m_write')); } else { q1 (kq ('e2m_note_edit', ['*note' => hm ($e->note_id)])); } } catch (AeMySQLException $e){ v3 ($e,'Could not process note'); q1 (); } die; } function e2s_note_publish () { global$_config,$settings; $databaseConfiguration = cl (); ud (); $note_id = ''; if(array_key_exists ('note-id',$_POST))$note_id = trim ($_POST['note-id']); if (!is_numeric ($note_id) and $note_id !== 'new'){ throw new AeFormInconsistentException (); } $x8 = false; $s = hm ($note_id); if (!$s)q1 (); $e8 = $s['OriginalAlias']; $r8 = $s['Stamp']; $t8 = !$s['IsExternal']; $s['ID']=$note_id; $s['IsVisible']=1; $s['IsPublished']=1; $s['IsCommentable'] = (int)$settings['comments']['default_on']; $s['IsFavourite']=0; if(array_key_exists ('browser-offset',$_POST)) { $gb = a1 (@$_POST['browser-offset']); ga ($gb); } else { $gb = ia (); } if ($x8 and $vf = cf ($x8,$gb)) { $s['Stamp']=$vf; } elseif ($t8){ $s['Stamp']=time (); } else { $s['Stamp']=$r8; } if (zd ($s)) { $s['IsIndexed']='1'; } if ($gb){ $s['Offset'] = (int)$gb['offset']; $s['IsDST'] = (int)$gb['is_dst']; } e2_drop_caches_for_note_($note_id,null); nm ($databaseConfiguration,'Notes',$s); $zy = ''; if ($e8 or $e8 === '0'){ $zy = d ( USER_DIR,$databaseConfiguration, 'set','n',$note_id,$e8 ); $s['OriginalAlias']=$zy; } if ($zy != $e8){ nm ($databaseConfiguration,'Notes',$s); } $nf = nf ($s); if ($nf === 'public'){ hv ($s); } q1 (kq ('e2m_note', ['*note' => $s])); } function jm ($note_id,$j8 = -1){ global$_config; $vs = true; if ($j8){ $vs = false; } if ($j8 === -1){ $vs = null; } e2_drop_caches_for_note_($note_id,$vs); fm ( "DELETE FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID` = '". ((int)$note_id) ."'", 'delete note by ID' ); kd ($note_id); e2_delete_aliases_for_entity_('n',$note_id); fm ( "DELETE FROM `". $_config['db_table_prefix']."NotesKeywords` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `NoteID`=". ((int)$note_id), 'delete tag bindings after deleting note' ); } function e2s_note_delete () { ud (); $note_id = ''; if(array_key_exists ('note-id',$_POST))$note_id = trim ($_POST['note-id']); if (!is_numeric ($note_id) and $note_id !== 'new'){ throw new AeFormInconsistentException (); } $j8 = (bool)$_POST['is-draft']; $s = hm ($note_id); if ($s){ $ih = kq ('e2m_note_broadcast', ['*note' => $s]); jm ($note_id,$j8); vv ($ih); } if ($j8){ q1 (kq ('e2m_drafts', ['page' => 1])); } else { q1 (); } die; } function e2j_note_livesave () { try { $k8 = vf (); } catch (AeFormIncompleteException $e){ $k8 = [ 'success' => false, 'error' => [ 'message' => 'Title or text is empty' ] ]; } catch (AeRecordNotFoundException $e){ $k8 = [ 'success' => false, 'error' => [ 'message' => 'Record not found' ] ]; } catch (AeMySQLException $e){ v3 ($e); $k8 = [ 'success' => false, 'error' => [ 'message' => 'Database error' ] ]; } echo json_encode ($k8); die; } function hm ($ly){ global$_config; fm ( "SELECT * FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID` = '". $ly ."'" ); $zb = sm (); if(count ($zb)>0){ return $zb[0]; } else { return false; } } function gm ($sy,$h8,$g8 = 1){ global$_config; $k5 = ($h8 == 'next')?'>':'<'; $w8 = ($h8 == 'next')?'':'DESC '; try { fm ( "SELECT * FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished`=". $g8 ." ". "AND (". "`Stamp` ". $k5 ." '". $sy['Stamp'] ."' ". "OR (`Stamp` = '". $sy['Stamp'] ."' AND `ID` ". $k5 . $sy['ID'] .")". ") ". mf (vs ()). "ORDER BY `Stamp` ". $w8 . ", `ID` ". $w8 . "LIMIT 1", 'get '. $h8 .' note' ); $zb = sm (); if(count ($zb)>0) return $zb[0]; else return false; } catch (AeMySQLException $e){ v3 ($e,'Could not get '. $h8 .' note'); return null; } } function wm ($u8){ global$_config; if(Log::$a)__log ('Lastmodifieds for Local Copier'); $u8 = (string)$u8; $u8 = preg_replace ('[^0-9,]','',$u8); $u8 = trim ($u8,','); if(CACHE_LASTMODIFIEDS and is_file (USER_DIR . CACHE_FILENAME_LASTMODIFIEDS)) { $i8 = @unserialize (file_get_contents (USER_DIR . CACHE_FILENAME_LASTMODIFIEDS)); if ($i8['ids_csv']==$u8){ if(Log::$a)__log ('Returned from cache'); return $i8['lastmodifieds_json']; } } $c1 = '`ID`='. str_replace (',',' OR `ID`=',$u8); $o8 = []; fm ( "SELECT `ID`, `LastModified` ". "FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND (". $c1 .")", 'get lastmodifieds for Local Copier' ); if(Log::$a)__log ('Requested from DB'); $e3 = sm (); foreach ($e3 as $a3 => $q3){ $o8[(int)$q3['ID']] = (int)$q3['LastModified']; } $p8 = json_encode ($o8); if ($p8 == '[]')$p8 = '{}'; $i8 = [ 'ids_csv' => $u8, 'lastmodifieds_json' => $p8, ]; if(CACHE_LASTMODIFIEDS){ e3 (USER_DIR . CACHE_FILENAME_LASTMODIFIEDS,serialize ($i8)); } return $p8; } function um ($rm,$tm,$jm = false){ global$_config; list ($ln,$zn)=f1 ($rm,$tm,$jm); fm ( "SELECT * FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished` AND (`Stamp` BETWEEN " .$ln. " AND " .$zn. ") ". "ORDER BY Stamp", 'get all notes for the date '. $jm .'.'. $tm .'.'. $rm ); $cb = []; foreach (sm () as $df){ if(is_numeric ($jm)) { $f1 = ((int)$rm) .'/'. ((int)$tm) .'/'. ((int)$jm) == v1 ('Y/n/j',$df['Stamp'],wa ($df)); } elseif(is_numeric ($tm)) { $f1 = ((int)$rm) .'/'. ((int)$tm) == v1 ('Y/n',$df['Stamp'],wa ($df)); } else { $f1 = ((int)$rm) == v1 ('Y',$df['Stamp'],wa ($df)); } if ($f1)$cb[] = $df; } return $cb; } function e2_published_noterec_with_parameters_($parameters = []) { $sy = e2_noterec_with_parameters_($parameters); if ($sy and $sy['IsPublished']) return $sy; } function e2_noterec_with_parameters_($parameters = []) { global$_config; $sy = false; $vg = false; if ((string) @$parameters['oalias']!=='')$vg = $parameters['oalias']; if ((string)$vg !== ''){ fm ( "SELECT * FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `OriginalAlias` = '". $vg ."' ". "AND `IsPublished` = 0", 'get note record by original alias' ); $sy = sm (); if(count ($sy)===1) { $sy = @$sy[0]; if ($sy) return $sy; } } $bg = false; if (@$parameters['draft']!=='') $bg = @$parameters['draft']; if (@$parameters['draft2']!=='')$bg = @$parameters['draft2']; if ($bg){ $sy = hm ($bg); return $sy; } if ((string)$vg !== ''){ $parameters['alias']=$vg; } if ((string) @$parameters['alias']!==''){ if ($yg = f (@$parameters['alias'])) { if ($yg['type']=='n'){ $sy = hm ($yg['id']); if ($sy and $sy['IsPublished']) return $sy; } } } if ( (string) @$parameters['year']!=='' and (string) @$parameters['month']!=='' and (string) @$parameters['day']!=='' ) { $bf = um ( $parameters['year'],$parameters['month'],$parameters['day'] ); if (@$bf[$parameters['day-number']-1]) { return $bf[$parameters['day-number']-1]; } } return null; } function pm ($ns,$q1,$gb,$q8){ $databaseConfiguration = cl (); vb (); @unlink (USER_DIR . CACHE_FILENAME_DRAFTS); @unlink (USER_DIR . CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); $sy = [ 'Title' => $ns, 'Text' => $q1, 'FormatterID' => DEFAULT_FORMATTER, 'OriginalAlias' => d ( USER_DIR,$databaseConfiguration, 'find','','',$ns ), 'Uploads' => $q8, 'IsPublished' => 0, 'Stamp' => (int)time (), 'LastModified' => (int)time (), ]; if ($gb and is_array ($gb)) { $sy['Offset'] = (int)$gb['offset']; $sy['IsDST'] = (int)$gb['is_dst']; } return ym ($databaseConfiguration,'Notes',$sy); } function cf ($ng,$gb){ $mg = '/^ *(\d{1,2})\.(\d{1,2})\.(\d{2}|\d{4}) +(\d{1,2})\:(\d{1,2})\:(\d{1,2}) *$/'; if(preg_match ($mg,$ng,$tm)) { $vf = gmmktime ($tm[4],$tm[5],$tm[6],$tm[2],$tm[1],$tm[3]); $vf -= pa ($gb,$vf); return $vf; } else { return false; } } function vf () { global$_config; if(Log::$a)__log ('Process note form'); ud (); $note_id = $ns = $fg = $q1 = $dg = $sg = ''; if(array_key_exists ('note-id',$_POST)) $note_id = trim ($_POST['note-id']); if(array_key_exists ('title',$_POST)) $ns = trim ($_POST['title']); if(array_key_exists ('tags',$_POST)) $fg = $_POST['tags']; if(array_key_exists ('text',$_POST)) $q1 = trim ($_POST['text'],"\r\n"); if(array_key_exists ('summary',$_POST)) $dg = trim ($_POST['summary'],"\r\n"); if(array_key_exists ('old-tags-hash',$_POST)) $sg = $_POST['old-tags-hash']; if (!is_numeric ($note_id) and $note_id !== 'new'){ throw new AeFormInconsistentException (); } if ((string)$ns === '' or (string)$q1 === ''){ throw new AeFormIncompleteException ($note_id); } $ag = $q1; $ag = str_replace ("\n",'\n'."\n",$ag); $ag = str_replace ("\r",'\r'."\r",$ag); if (!is_array ($fg))$fg = []; $fg = trim (implode (', ',$fg)); $se = x1 (',',$fg,'sort'); $fg = implode (', ',$se); $qg = md5 ($fg); if(array_key_exists ('browser-offset',$_POST)) { $gb = a1 (@$_POST['browser-offset']); ga ($gb); } else { $gb = ia (); } $lg = @$_POST['old-stamp']; $x8 = @$_POST['stamp']; $zy = @$_POST['alias']; $databaseConfiguration = cl (); if($note_id == 'new'){ $q8 = ''; if(is_file (USER_DIR . 'new-uploads.psa')) { $q8 = @file_get_contents (USER_DIR . 'new-uploads.psa'); } $sy = pm ($ns,$q1,$gb,$q8); $note_id = (int)$sy['ID']; @unlink (USER_DIR . 'new-uploads.psa'); $e3 = [ 'success' => true, 'data' => [ 'status' => 'created', 'id' => $note_id, 'note-url' => kq ('e2m_note', ['*note' => $sy]), 'note-edit-url' => kq ('e2m_note_edit', ['*note' => $sy]) ] ]; } else { $zg = hm ($note_id); if (!$zg){ throw new AeRecordNotFoundException (); } e2_drop_caches_for_note_($note_id,$zg['IsPublished']); $kg = $zg; $kg['ID']=$note_id; $kg['Title']=$ns; $kg['Summary']=$dg; $kg['Text']=$q1; $kg['FormatterID']=$zg['FormatterID']; $kg['LastModified']=time (); $kg['IsIndexed']='0'; if ($kg['FormatterID']!=='raw'){ $kg['FormatterID']=DEFAULT_FORMATTER; } if ($lg != $x8){ if ($vf = cf ($x8,$gb)) { $kg['Stamp']=min ($vf,time ()); } } $xy = $zy; if ((string)$zy !== ''){ $xg = $zy; } elseif (!$zg['IsPublished']) { $xg = $ns; } else { $xg = ''; } if ($zg['IsPublished']) { $xy = d ( USER_DIR,$databaseConfiguration, 'set','n',$note_id,$xg ); $eg = [ '*note' => $kg, 'alias' => $xy, ]; } else { $xy = d ( USER_DIR,$databaseConfiguration, 'find','n',$note_id,$xg ); $kg['OriginalAlias']=$xy; $eg = [ '*note' => $kg, 'alias' => $xy, ]; } $ib = sy ( $kg['FormatterID'],$kg['Text'],'full' ); if(count ($ib)>0){ j2 ($ib); h2 ($ib); } nm ($databaseConfiguration,'Notes',$kg); if ($kg['IsPublished']) { if (zd ($kg)) { $kg['IsIndexed']='1'; nm ($databaseConfiguration,'Notes',$kg); } if ($lg != $x8){ b (true); } } $e3 = [ 'success' => true, 'data' => [ 'status' => 'saved', 'id' => (int)$kg['ID'], 'new-alias' => $xy, 'note-url' => kq ('e2m_note',$eg), 'note-edit-url' => kq ('e2m_note_edit',$eg) ] ]; } if ($qg != $sg){ va ($databaseConfiguration,$note_id,$se); } if (isset ($kg)) { hv ($kg); } if($_config['backup_automatically']) { qm (); } return $e3; } function bf ($rg,$tg){ global$_config; if (!($rg and $tg) and !vs ()) { if(Log::$a)__log ('Error: e2_notes_count_generic called for invisible items unsecurely'); return null; } if (!is_bool ($rg) or !is_bool ($tg)) { if(Log::$a)__log ('Error: e2_notes_count_generic called with non-bool params'); return null; } if (!$rg and !$tg){ if(Log::$a)__log ('Error: e2_notes_count_generic called with nonsensical parameters'); return null; } $gf = ( USER_DIR . CACHES_DIRNAME . 'notes-count-p'. (int)$rg . ($rg ? ('v'. (int)$tg):'') . '.txt' ); $e3 = false; if(CACHE_NOTES_COUNTS and is_file ($gf)) { $e3 = (int) @file_get_contents ($gf); } if(is_numeric ($e3) and $e3 > 0){ return $e3; } else { $e3 = null; try { fm ( "SELECT COUNT(*) As NotesCount FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished`=". (int)$rg. " ". ($rg ? ( "AND `IsVisible`=". (int)$tg ) : ""), 'count notes with flags p'. (int)$rg . ($rg ? ('v'. (int)$tg):'') ); $e3 = sm (); $e3 = (int)$e3[0]['NotesCount']; if(CACHE_NOTES_COUNTS)e3 ($gf,$e3); } catch (AeMySQLException $e){ v3 ($e); if(Log::$a)__log ('Could not count notes'); } return $e3; } } function yf ($q1){ $dg = $q1; $dg = preg_match ( '/^(\<\/div\>)?\<p( class\=\"lead\")?\>(.*)\<\/p\>$/mu', $dg, $me ); $dg = @$me[3]; if (!$dg)$dg = $q1; if(mb_strlen ($dg) <= 50)$dg = $q1; $dg = str_replace ([ '<p>','<blockquote>','<ul>','<ol>','<br />', ], "\n",$dg); $dg = trim (strip_tags ($dg)); if(mb_strlen ($dg)>50){ $jg = mb_strpos ($dg,"\n",50); } else { $jg = mb_strrpos ($dg,"\n"); } if ($jg !== false){ $dg = mb_substr ($dg,0,$jg); $dg = trim ($dg,' :.()'."\n"); } if(preg_match ('/^(.{100,}?)(?:[:.!?()]|'."\n".')/su',$dg,$me)) { $dg = trim ($me[0],' :.()'."\n"); } if(preg_match ('/^(.{150,}?)[:.!?(),]/su',$dg,$me)) { $dg = trim ($me[0],' :.(),'."\n"); } if(preg_match ('/^(.{200,}?)[:.!?(), ]/su',$dg,$me)) { $dg = trim ($me[0],' :.()'."\n"); } $dg = preg_replace ('/[ \n\r\t]+/su',' ',$dg); if(mb_substr ($dg, -1)==='.')$dg = mb_substr ($dg,0, -1); if(mb_substr ($dg, -1)===':')$dg = mb_substr ($dg,0, -1); if(mb_substr ($dg, -1)==='!')$dg = mb_substr ($dg,0, -1); if (@in_array ($dg[mb_strlen ($dg)-1], [',',' '])) { $dg = trim ($dg,', '). '...'; } if(mb_strlen ($dg)>250){ $dg = trim (mb_substr ($dg,0,250)). '...'; } return $dg; } function nf ($sy){ $hg = false; if ($sy['IsPublished']) { if ($hg){ return 'scheduled'; } else { if ($sy['IsVisible']) { return 'public'; } else { return 'hidden'; } } } else { return 'draft'; } } function mf ($rn = false){ if ($rn){ return ''; } else { return 'AND (n.`IsVisible` = 1 AND n.`Stamp` <= '. time () .') '; } } function ff () { global$_config; if(CACHE_RANDOM_NOTE and is_file (USER_DIR . CACHE_FILENAME_RANDOM_NOTE)) { $f5 = @unserialize (file_get_contents (USER_DIR . CACHE_FILENAME_RANDOM_NOTE)); return $f5; } $f5 = false; $gg = bf (true,true); if ($gg >= 10){ fm ( "SELECT COUNT(*) as NotesCount FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE n.`SubsetID`=". $_config['db_table_subset'] ." ". "AND n.`IsFavourite` = 1 ". "AND n.`IsPublished` = 1 ". "AND n.`IsVisible` = 1 ", 'get the number of visible published favourite notes' ); $e3 = sm (); $wg = (int)$e3[0]['NotesCount']; $ug = ''; if ($wg >= 10){ $ug = 'AND n.`IsFavourite` = 1'; } fm ( "SELECT * FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE n.`SubsetID`=". $_config['db_table_subset'] ." ". $ug ." ". "AND n.`IsPublished` = 1 ". "AND n.`IsVisible` = 1 ". "ORDER BY RAND() ". "LIMIT 1 ", 'get a random visible published and maybe favourite note' ); $bf = sm (); $f5 = kq ('e2m_note', ['*note' => $bf[0]]); } if(CACHE_RANDOM_NOTE){ e3 (USER_DIR . CACHE_FILENAME_RANDOM_NOTE,serialize ($f5)); } return $f5; } function df ($sy){ return ''; } define ('OLBA_SPECIAL_CHAR',"\x1"); define ('OLBA_SPECIAL_SEQUENCE_LENGTH',6); function lf ($nw = null){ global$_template,$settings; if ($nw === null)$nw = @$settings['template']; $mw = null; $fw = null; $dw = null; $sw = array (); $aw = $nw; if ($aw !== null){ while (1){ foreach ([ USER_DIR . THEMES_DIRNAME, INSTANCE_DIR . THEMES_DIRNAME, SYSTEM_DIR . THEMES_DIRNAME ] as $qw){ $lw = $qw . $aw .'/'; if ( is_dir ($lw) and is_file ($lw .'/theme-info.php') ) { if(Log::$a)__log ('Theme "'. $aw .'" found in "'. $lw . '"'); break; } else { $lw = false; } } if (!$lw){ if(Log::$a)__log ('Theme "'. $aw .'" not found, using default theme "'. DEFAULT_TEMPLATE .'"'); $aw = DEFAULT_TEMPLATE; $lw = $qw . $aw .'/'; } array_push ($sw,$lw); $zw = include $lw .'/theme-info.php'; $kw[$lw]=$zw; if(array_key_exists ('meta_viewport',$zw)) { if ($mw === null){ $mw = $zw['meta_viewport']; } } if(array_key_exists ('supports_dark_mode',$zw)) { if ($fw === null){ $fw = $zw['supports_dark_mode']; } } if(array_key_exists ('use_likely_light',$zw)) { if ($dw === null){ $dw = $zw['use_likely_light']; } } if(array_key_exists ('based_on',$zw)) { $aw = $zw['based_on']; } else { break; } } } if ($mw === null)$mw = ''; if ($fw === null)$fw = false; if ($dw === null)$dw = false; $lw = SYSTEM_THEME_DIR; array_push ($sw,$lw); $kw[$lw] = []; $_template['name']=$nw; $_template['meta_viewport']=$mw; $_template['supports_dark_mode']=$fw; $_template['use_likely_light']=$dw; $_template['stack']=$sw; $_template['infos']=$kw; }; function zf ($xw){ global$content; if (!isset ($_olba_includes))$_olba_includes = 0; ++ $_olba_includes; if(Log::$a)__log ('Eat "'. $xw .'"'); ob_start (); include $xw; return ob_get_clean (); } function kf ($nb){ return ( OLBA_SPECIAL_CHAR. str_pad ($nb,OLBA_SPECIAL_SEQUENCE_LENGTH,'0',STR_PAD_LEFT). OLBA_SPECIAL_CHAR ); } function xf ($name){ static $nb = 0; n2 ($name,'_olba_placeholders'); return kf ($nb ++); } function ef ($ew){ global$_olba_placeholders; foreach($_olba_placeholders as $nb => $cv){ $rw = kf ($nb); $tw = strpos ($ew,$rw); $jw = tf ($cv,true); if ($tw !== false){ $ew = substr_replace ( $ew,$jw,$tw,strlen ($rw) ); } else { break; } } return $ew; } function rf ($hw){ foreach ([ USER_DIR . EXTRAS_DIRNAME, INSTANCE_DIR . EXTRAS_DIRNAME, SYSTEM_DIR . EXTRAS_DIRNAME ] as $gw){ if(is_dir ($gw)) { $ww = $gw . $hw .'.tmpl.php'; if(is_file ($ww)) { return zf ($ww); } } } return ''; } function tf ($hw){ global$_template,$_olba_includes; $ww = 'templates/'. $hw .'.tmpl.php'; if ($xw = e2o__usable_file_with_basename_($ww)) { return zf ($xw); } else { ob_end_clean (); throw new AeOlbaTemplateMissingException ('Missing: '. $ww); } } function jf () { global$_config; if ( @$_config['raw_template_data'] or @$_config['raw_template_data_with_param'] and array_key_exists ('raw',$_GET) ) { $uw = 'raw'; } else { $uw = 'main'; } return tf ($uw,true); } function hf ($iw){ n2 ($iw .'.css','_olba_used_stylesheets'); } function gf ($ow){ n2 ($ow .'.js','_olba_used_scripts'); } function wf ($pw){ foreach ([ SYSTEM_DIR . LIBRARY_DIRNAME, INSTANCE_DIR . LIBRARY_DIRNAME, USER_DIR . LIBRARY_DIRNAME ] as $cu){ foreach(glob ($cu . $pw .'/*') as $n2){ $g4 = pathinfo ($n2,PATHINFO_EXTENSION); if ($g4 == 'js'){ n2 ($n2,'_olba_used_scripts'); } if ($g4 == 'css'){ n2 ($n2,'_olba_used_stylesheets'); } } } } function uf () { global$_template,$settings; foreach ([ USER_DIR . THEMES_DIRNAME, INSTANCE_DIR . THEMES_DIRNAME, SYSTEM_DIR . THEMES_DIRNAME ] as $vu){ if ($bu = @opendir ($vu)) { while (false !== ($yu = readdir ($bu))) { if(is_dir ($vu. $yu) and $yu != '.' and $yu != '..'){ if(is_file ($vu . $yu .'/theme-info.php')) { $nu[$yu]=$vu . $yu .'/'; } } } closedir ($bu); } } $rv = array (); $mu = 1000; foreach ($nu as$name => $w){ $zw = include $w .'theme-info.php'; $fu = @$zw['display_name']; if (!$fu) continue; if(is_array ($fu)) { if(array_key_exists ($settings['language'],$fu)) { $fu = $fu[$settings['language']]; } else { $fu = array_shift ($fu); } } $nb = @$zw['index'] or $nb = $mu ++; $du = @$zw['colors']; if (!$du)$du = array ( 'background' => 'transparent', 'headings' => 'rgba(128,128,128,.2)', 'text' => 'rgba(128,128,128,.2)', 'link' => 'rgba(128,128,128,.2)', ); $su = (bool) ($name == $_template['name']); if ($su){ $au = kq ('e2m_theme_preview', array ('theme' => '')); } else { $au = kq ('e2m_theme_preview', array ('theme' => $name)); } $rv[$nb] = array ( 'name' => $name, 'display-name' => $fu, 'colors' => $du, 'current?' => $su, 'preview-url' => $au, 'supports-dark-mode?' => (bool) @$zw['supports_dark_mode'], ); } ksort ($rv); return $rv; } function if_ ($gd){ return e2o__usable_file_with_basename_('images/'. $gd); } function of ($qu){ $lu = e2o__usable_file_with_basename_('images/'. $qu .'.svg'); if(is_file ($lu)) { return file_get_contents ($lu); } return ''; } function pf ($iw){ global$_template; $jd = 'styles/'. $iw .'.css'; $zu = array (); foreach($_template['stack'] as $lw){ if(is_file ($gd = $lw . $jd)) { $zu[] = $gd; } if ( array_key_exists ('reset_styles',$_template['infos'][$lw]) and in_array ($iw,$_template['infos'][$lw]['reset_styles']) ) { break; } } $zu = array_reverse ($zu); } function c2 ($rv){ foreach ($rv as $a3 => $q3){ $ud = stat ($q3); $rv[$a3]=AeEnv::$base_url . $rv[$a3] .'?'. $ud['mtime']; } return $rv; } function v2 () { global$_olba_used_stylesheets,$_template; if (!isset ($_olba_used_stylesheets)) return; $_olba_used_stylesheets = array_unique ($_olba_used_stylesheets); $ku = array (); foreach($_olba_used_stylesheets as $iw){ if(is_file ($iw)) { $ku[] = $iw; continue; } if(is_file ($gd = USER_DIR . SCRIPTS_SUBDIR . $iw)) { $ku[] = $gd; } $jd = 'styles/'. $iw; $zu = array (); foreach($_template['stack'] as $lw){ if(is_file ($gd = $lw . $jd)) { $zu[] = $gd; } if ( array_key_exists ('reset_styles',$_template['infos'][$lw]) and in_array ($iw,$_template['infos'][$lw]['reset_styles']) ) { break; } } $zu = array_reverse ($zu); $ku = array_merge ($ku,$zu); } $ku = c2 ($ku); return $ku; } function b2 () { global$_olba_used_scripts; if (!isset ($_olba_used_scripts)) return; $_olba_used_scripts = array_unique ($_olba_used_scripts); $xu = array (); foreach($_olba_used_scripts as $ow){ if ( substr ($ow,0,7)=='http://' or substr ($ow,0,8)=='https://' or substr ($ow,0,2)=='//' ) { $xu[] = $ow; continue; } if(is_file ($ow)) { $xu[] = $ow; continue; } if(is_file ($eu = USER_DIR . SCRIPTS_SUBDIR . $ow)) { $xu[] = $eu; } $jd = SCRIPTS_SUBDIR . $ow; if ($eu = e2o__usable_file_with_basename_($jd)) { $xu[] = $eu; } } $xu = c2 ($xu); return $xu; } function y2 ($ru){ if (!is_array ($ru)) return; foreach ($ru as $cx){ if(substr ($cx, -3)=='.js'){ gf (substr ($cx,0, -3)); } if(substr ($cx, -4)=='.css'){ hf (substr ($cx,0, -4)); } } } function n2 ($cv,$pd){ if (!isset ($GLOBALS[$pd])) { $GLOBALS[$pd] = array ($cv); } else { $GLOBALS[$pd][] = $cv; } } function e2o__usable_file_with_basename_($jd){ global$_template; if (!isset ($_template))lf (); foreach($_template['stack'] as $lw){ if(is_file ($gd = $lw . $jd)) { return $gd; } } return ''; } function e2m_theme_preview ($parameters){ global$_lang,$_strings,$_config,$settings,$_template; if (!$_config['allow_themes_preview']) { return e2m_error404 (); } if ((string)$parameters['theme']!==''){ lf ($parameters['theme']); } else { lf (); } if($parameters['theme'] == @$settings['template']) { q1 (kq ('e2m_theme_preview', ['theme' => ''])); } $nx = $_lang; if (!is_file ($n2 = 'system/preview/'. $nx .'.php')) { $nx = $_strings['--secondary-language']; $n2 = 'system/preview/'. $nx .'.php'; } if (!is_file ($n2 = 'system/preview/'. $nx .'.php')) { $n2 = 'system/preview/'. DEFAULT_LANGUAGE .'.php'; } $v = include $n2; return $v; } function e2m_popular ($parameters = []) { global$settings,$_config,$_strings; $rn = vs (); $popularView = new AePageableNotesView ('e2m_popular',$parameters); $popularView -> setPortionSize ($settings['appearance']['notes_per_page']); $popularView -> setNextPrevPageTitles ($_strings['gs--earlier'],$_strings['gs--later']); $popularView -> setWantNewCommentsCount ($rn); $popularView -> setWantReadHrefs ($_config['count_reads']); $popularView -> setWantControls ($rn and !@$_config['read_only']); $popularView -> setWantHiddenTags ($rn); AeMainMenuManager :: $isPopularCurrent = true; $yl = $_config['popular_period']; if ($yl === 'ever'){ $popularView -> setLimitlessSQLRequest ( "SELECT * ". "FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished` = 1 ". mf ($rn). "ORDER BY `ReadCount` DESC" ); } else { $nl = time () - n3 ($_config['popular_period']); $tu = ( "FROM `". $_config['db_table_prefix']."Actions` a, ". "`". $_config['db_table_prefix']."Notes` n ". "WHERE a.`SubsetID`=". $_config['db_table_subset'] ." ". "AND n.`SubsetID`=". $_config['db_table_subset'] ." ". "AND a.`Stamp` > ". $nl ." ". "AND n.`IsPublished` = 1 ". mf ($rn). "AND a.`EntityID` = n.`ID` ". "GROUP BY a.`EntityID`" ); $popularView -> setSQLCountRequest ( "SELECT COUNT(*) Total FROM (SELECT 1 ". $tu .") _" ); $popularView -> setLimitlessSQLRequest ( "SELECT n.*, a.`EntityID`, SUM(a.`ReadCount`) `AggregateReadCount` ". $tu ." ". "ORDER BY `AggregateReadCount` DESC" ); } $cb = [ 'title' => e2l_get_string ('pt--most-read', ['period' => $yl]), 'heading' => e2l_get_string ('pt--most-read', ['period' => $yl]), 'notes' => $popularView -> getNotesCTree (), 'pages' => $popularView -> getPagesCTree (), ]; if($popularView -> isFirstPageOfEmptyView ()) { $cb['nothing']=$_strings['gs--no-such-notes']; } elseif (!$popularView -> isExistingPage ()) { return e2m_error404 (); } return $cb; } function f2 ($bs = false,$d3 = []) { global$_config,$_current_url; $ju = $hu = ''; $mostReadNotesCollectionView = new AeArbitraryNotesCollectionView ('most read or most read by tag'); $mostReadNotesCollectionView -> setCurrentURL ($_current_url); $mostReadNotesCollectionView -> setFilterOutIDs ($d3); $nl = time () - n3 ($_config['popular_period']); $mostReadNotesCollectionView -> setSQLRequest ( "SELECT n.*, a.`EntityID`, SUM(a.`ReadCount`) `AggregateReadCount` ". "FROM `". $_config['db_table_prefix']."Actions` a, ". "`". $_config['db_table_prefix']."Notes` n ". $ju. "WHERE a.`SubsetID`=". $_config['db_table_subset'] ." ". "AND n.`SubsetID`=". $_config['db_table_subset'] ." ". $hu. "AND a.`Stamp` > ". $nl ." ". "AND n.`IsPublished` = 1 ". "AND n.`IsFavourite` = 1 ". mf (vs ()). "AND a.`EntityID` = n.`ID` ". "GROUP BY a.`EntityID` ". "ORDER BY `IsFavourite` DESC, `AggregateReadCount` DESC ". "LIMIT 10" ); if ($bs === false){ if(CACHE_POPULAR){ $mostReadNotesCollectionView -> setViewExpiration (SECONDS_IN_A_DAY); $mostReadNotesCollectionView -> setCacheFilename (USER_DIR . CACHE_FILENAME_POPULAR); $mostReadNotesCollectionView -> setCacheExpiresFilename (USER_DIR . CACHE_FILENAME_POPULAR_EXPIRES); } } else { if(CACHE_POPULAR_WITH_TAG){ $mostReadNotesCollectionView -> setViewExpiration (SECONDS_IN_A_DAY); $mostReadNotesCollectionView -> setCacheFilename (e2_cache_filename_with_id_($bs,USER_DIR . CACHE_FILENAMES_POPULAR_WITH_TAG)); $mostReadNotesCollectionView -> setCacheExpiresFilename ( e2_cache_filename_with_id_($bs,USER_DIR . CACHE_FILENAMES_POPULAR_WITH_TAG_EXPIRES) ); } } return$mostReadNotesCollectionView -> getNotesCTree (); } function d2 ($bs = false,$d3 = []) { global$_strings; $gu = [ 'title' => $_strings['nm--most-read'], ]; $gu['each']=f2 ($bs,$d3); if ($bs){ $gu['seed']=$bs; } if(count ($gu['each']) < 7){ return []; } return $gu; } function e2s_post_service ($parameters){ global$_config; $wu = kq ('e2m_settings'); if($_config['allow_underhood_access']) { $wu = kq ('e2m_underhood'); } if($_SERVER['REQUEST_METHOD']!='POST'){ q1 ($wu); } if($_config['allow_underhood_access']) { if($parameters['service']==='build'){ ud (); e2_build (); hb ('Engine core built',E2E_MESSAGE); } if($parameters['service']==='sync'){ ud (); e2_drop_all_kinds_of_cache (); hb ('Caches invalidated',E2E_MESSAGE); } if($parameters['service']==='checklist-reset'){ ud (); rs (); hb ('Checklist reset',E2E_MESSAGE); } if($parameters['service']==='log'){ ud (); qn (); hb ('Logs enabled',E2E_MESSAGE); } if($parameters['service']==='unlog'){ ud (); cq (INSTANCE_DIR . LOGS_DIRNAME . '*'); hb ('All logs deleted',E2E_MESSAGE); } if($parameters['service']==='migrate'){ ud (); hn (cl ()); hb ('Database structure up to date',E2E_MESSAGE); } } if($parameters['service']==='backup'){ } q1 ($wu); } define ('PROVIDE_MEDIA_ASYNC',10); define ('PROVIDE_MEDIA_NOW',20); function s2 ($uu){ global$_config; $iu = parse_url ($uu); if (isset ($iu['host'])) { $url = $uu; if ($iu['host']=='www.youtube.com'){ $ly = basename ($iu['path']); $ou = 'remote/youtube-'. $ly .'-cover.jpg'; return [ 'url' => $url, 'type' => 'online-video', 'is-local?' => false, 'is-usable-as-cover?' => true, 'is-using-thumbnails?' => true, 'is-generating-thumbnail?' => true, 'is-snippetable?' => true, 'is-rss-enclosure?' => false, 'video-service' => 'youtube', 'video-id' => $ly, 'local-cover-href' => AeEnv::$base_url . PICTURES_DIRNAME . $ou, 'local-relative-filename' => $ou, 'local-full-filename' => $_config['path_media'].PICTURES_DIRNAME . $ou, 'local-full-failname' => $_config['path_media'].PICTURES_DIRNAME . $ou . '.failed', ]; } elseif ($iu['host']=='player.vimeo.com'){ $ly = basename ($iu['path']); $ou = 'remote/vimeo-'. $ly .'-cover.jpg'; return [ 'url' => $url, 'type' => 'online-video', 'is-local?' => false, 'is-usable-as-cover?' => true, 'is-using-thumbnails?' => true, 'is-generating-thumbnail?' => true, 'is-snippetable?' => true, 'is-rss-enclosure?' => false, 'video-service' => 'vimeo', 'video-id' => $ly, 'local-cover-href' => AeEnv::$base_url . PICTURES_DIRNAME . $ou, 'local-relative-filename' => $ou, 'local-full-filename' => $_config['path_media'].PICTURES_DIRNAME . $ou, 'local-full-failname' => $_config['path_media'].PICTURES_DIRNAME . $ou . '.failed', ]; } elseif (o2 ($iu['path'])) { return [ 'url' => $url, 'type' => 'remote-image', 'is-local?' => false, 'is-usable-as-cover?' => false, 'is-using-thumbnails?' => false, 'is-generating-thumbnail?' => false, 'is-snippetable?' => false, 'is-rss-enclosure?' => false, 'mime-type' => md ($iu['path']), 'length' => '', ]; } else { return [ 'url' => $url, 'type' => 'remote-non-image', 'is-local?' => false, 'is-usable-as-cover?' => false, 'is-using-thumbnails?' => false, 'is-generating-thumbnail?' => false, 'is-snippetable?' => false, 'is-rss-enclosure?' => true, 'mime-type' => md ($iu['path']), 'length' => '', ]; } } else { if (o2 ($iu['path'])) { $url = AeEnv::$base_url . PICTURES_DIRNAME . $iu['path']; $pu = $_config['path_media'].PICTURES_DIRNAME . $iu['path']; return [ 'url' => $url, 'type' => 'local-image', 'is-local?' => true, 'is-usable-as-cover?' => true, 'is-using-thumbnails?' => true, 'is-generating-thumbnail?' => p2 ($iu['path']), 'is-snippetable?' => true, 'is-rss-enclosure?' => false, 'mime-type' => md ($iu['path']), 'length' => @stat ($pu)['size'], 'local-href' => $url, 'local-cover-href' => $url, 'local-relative-filename' => $iu['path'], 'local-full-filename' => $pu, 'thumb-full-filename' => $pu, ]; } elseif (vd ($iu['path'])) { $url = AeEnv::$base_url . VIDEO_DIRNAME . $iu['path']; $pu = $_config['path_media'].VIDEO_DIRNAME . $iu['path']; return [ 'url' => $url, 'type' => 'local-video', 'is-local?' => true, 'is-usable-as-cover?' => false, 'is-using-thumbnails?' => true, 'is-generating-thumbnail?' => false, 'is-snippetable?' => false, 'is-rss-enclosure?' => true, 'mime-type' => md ($iu['path']), 'length' => @stat ($pu)['size'], 'local-href' => $url, 'local-relative-filename' => $iu['path'], 'local-full-filename' => $pu, 'thumb-full-filename' => SYSTEM_THEME_DIR . VIDEO_ICON_FILENAME, ]; } else { $url = AeEnv::$base_url . AUDIO_DIRNAME . $iu['path']; $pu = $_config['path_media'].AUDIO_DIRNAME . $iu['path']; return [ 'url' => $url, 'type' => 'local-non-image', 'is-local?' => true, 'is-usable-as-cover?' => false, 'is-using-thumbnails?' => true, 'is-generating-thumbnail?' => false, 'is-snippetable?' => false, 'is-rss-enclosure?' => true, 'mime-type' => md ($iu['path']), 'length' => @stat ($pu)['size'], 'local-href' => $url, 'local-full-filename' => $pu, 'thumb-full-filename' => SYSTEM_THEME_DIR . AUDIO_ICON_FILENAME, ]; } } } function a2 ($n4){ $c0 = []; foreach ($n4 as $uu){ $z8 = s2 ($uu); if ($z8['is-local?'])$c0[] = $uu; } return $c0; } function q2 ($n4){ $c0 = []; foreach ($n4 as $uu){ $z8 = s2 ($uu); if ($z8['is-snippetable?'])$c0[] = $uu; } return $c0; } function l2 ( $ib,$pb ){ if (!is_array ($ib))$ib = []; if (!is_array ($pb))$pb = []; $n4 = array_merge ($pb,$ib); $n4 = array_reverse ($n4); $n4 = array_unique ($n4); $n4 = array_reverse ($n4); return $n4; } function z2 ($n4){ if (!is_array ($n4) or !count ($n4)) return []; h2 ($n4); $v0 = []; foreach ($n4 as $uu){ if (!empty ($b0[$uu])) continue; $z8 = s2 ($uu); if (!$z8['is-usable-as-cover?']) continue; if (!is_file ($z8['local-full-filename'])) continue; $size = e2_getimagesize ($z8['local-full-filename']); list ($cz,$vz,$o6,$p6)=$size; $v0[] = [ 'src' => $z8['local-cover-href'], 'width' => $cz, 'height' => $vz, 'horizontality' => $o6, 'verticality' => $p6, ]; $b0[$uu]=true; } return $v0; } function k2 ($n4){ global$_strings; if (!is_array ($n4) or !count ($n4)) return []; h2 ($n4); $y0 = []; foreach ($n4 as $uu){ if (!empty ($b0[$uu])) continue; $z8 = s2 ($uu); if (!$z8['is-using-thumbnails?']) continue; if (!is_file ($z8['local-full-filename'])) continue; $n0 = [ 'is-available?' => true, 'src' => '', 'width' => '', 'height' => '', 'original-filename' => '', 'original-filesize' => '', ]; if (!$z8['is-local?'] or is_file ($z8['local-full-filename'])) { if ($z8['is-generating-thumbnail?']) { $m0 = g2 ( $z8 ); } else { $m0 = $z8['thumb-full-filename']; } } if (empty ($m0)) { $n0['is-available?']=false; $m0 = w2 ( $z8['local-relative-filename'] ); } $n0['src']=o3 ($m0); if ($n0['is-available?']) { $size = e2_getimagesize ($m0); list ($cz,$vz)=$size; } else { $cz = $vz = ''; } if (!$cz)$cz = THUMB_WIDTH/2; if (!$vz)$vz = THUMB_HEIGHT/2; list ($cz,$vz)=e2_fit_metrics_to_constraints ( [$cz,$vz], [THUMB_WIDTH/2,THUMB_HEIGHT/2] ); $n0['width']=$cz; $n0['height']=$vz; if ($z8['is-local?']) { $n0['original-filename']=$uu; if(is_file ($z8['local-full-filename'])) { $o4 = stat ($z8['local-full-filename'])[7]; $o4 = round ($o4 / 1024) .' '. $_strings['gs--kb']; $n0['original-filesize']=$o4; } } $y0[] = $n0; $b0[$uu]=true; } return $y0; } function x2 ($f0){ foreach ( ['maxresdefault','hqdefault','mqdefault','sddefault','default'] as $gd ) { $url = 'http://img.youtube.com/vi/'. $f0 .'/'. $gd .'.jpg'; if(Log::$a)__log ('Trying '. $url .'...'); $d0 = @file_get_contents ($url); if ($d0 !== false) return $d0; } return false; } function e2_ ($s0){ $a0 = @unserialize ( file_get_contents ('http://vimeo.com/api/v2/video/'. $s0 .'.php') ); if (!empty ($a0[0]['thumbnail_large'])) { return @file_get_contents ($a0[0]['thumbnail_large']); } return false; } function r2 ($z8,$q0){ if(is_file ($z8['local-full-filename'])) { if(Log::$a)__log ('Already exists: '. $z8['local-full-filename']); } elseif(is_file ($z8['local-full-failname'])) { if(Log::$a)__log ('Already tried and failed: '. $z8['local-full-filename']); } else { if(Log::$a)__log ('Resource '. $z8['url'].' is missing a cover, retrieving'); if ($q0 == PROVIDE_MEDIA_ASYNC){ vv (kq ('e2s_retrieve', [ 'url' => strtr (base64_encode ($z8['url']), '+/','-_'), ])); } if ($q0 == PROVIDE_MEDIA_NOW){ if(Log::$a)__log ('Downloading "'. $z8['video-service'] .'" cover as '. $z8['local-full-filename'] .'...'); if ($z8['video-service']=='youtube'){ $d0 = x2 ($z8['video-id']); } if ($z8['video-service']=='vimeo') { $d0 = e2_ ($z8['video-id']); } if ($d0 !== false){ e3 ($z8['local-full-filename'],$d0); } else { e3 ($z8['local-full-failname'],''); } } } } function t2 ($uu,$q0){ $z8 = s2 ($uu); if(Log::$a)__log ('Resource '. $uu .' is of type '. $z8['type']); if ($z8['type']=='local-image'){ g2 ($z8); } if ($z8['type']=='online-video'){ r2 ($z8,$q0); if ($q0 == PROVIDE_MEDIA_NOW and is_file ($z8['local-full-filename'])) { g2 ($z8); } } if ($z8['type']=='remote-image'){ } } function j2 ($n4){ foreach ($n4 as $uu){ $z8 = s2 ($uu); if (empty ($z8['local-full-failname'])) continue; if(is_file ($z8['local-full-failname'])) { if(Log::$a)__log ('Deleting '. $z8['local-full-failname'] .' to try again'); unlink ($z8['local-full-failname']); } } } function h2 ($n4){ if (!is_array ($n4)) return; if(Log::$a)__log ('Asynchronously provide data for resnames {'); foreach ($n4 as $uu){ t2 ($uu,PROVIDE_MEDIA_ASYNC); } if(Log::$a)__log ('}'); } function g2 ($z8){ if (!$z8['is-generating-thumbnail?']) return false; return e2img_filename_by_processing ( $z8['local-full-filename'], w2 ($z8['local-relative-filename']), [THUMB_WIDTH,THUMB_HEIGHT], CROP_NONE, THUMB_JPG_QUALITY ); } function w2 ($l0){ global$_config; return yd ( $_config['path_media'].THUMBNAILS_DIRNAME . $l0, 'thumb@2x' ); } function i2 ($uu){ $k0 = pathinfo ($uu); $g4 = @$k0['extension']; return (in_array (strtolower ($g4), ['jpg','jpeg'])); } function o2 ($uu){ $k0 = pathinfo ($uu); $g4 = (string) @$k0['extension']; return (in_array (strtolower ($g4), ['jpg','jpeg','gif','png','webp','svg'])); } function p2 ($uu){ $k0 = pathinfo ($uu); $g4 = (string) @$k0['extension']; return (in_array (strtolower ($g4), ['jpg','jpeg','gif','png','webp'])); } function cd ($uu){ $k0 = pathinfo ($uu); $g4 = (string) @$k0['extension']; return (in_array (strtolower ($g4), ['svg'])); } function vd ($uu){ $k0 = pathinfo ($uu); $g4 = (string) @$k0['extension']; return (in_array (strtolower ($g4), ['mp4','mov'])); } function bd ($uu){ $k0 = pathinfo ($uu); $g4 = (string) @$k0['extension']; return (in_array (strtolower ($g4), ['mp3'])); } function yd ($uu,$x0){ if (!empty ($x0)) { $e0 = explode ('/',$uu); $jd = array_pop ($e0); $r0 = explode ('.',$jd); if(count ($r0)<2)$r0[] = ''; $g4 = array_pop ($r0); $r0[] = $x0; if ($g4)$r0[] = $g4; $jd = implode ('.',$r0); $e0[] = $jd; $uu = implode ('/',$e0); } return $uu; } function nd ($w,$jd){ if (!is_file ($w . $jd)) return $jd; $t0 = strrpos ($jd,'.'); $j0 = substr ($jd,0,$t0); $g4 = substr ($jd,$t0); $rb = 0; while (is_file ($w . $j0 .'-'. (++ $rb).$g4)); $jd = $j0 .'-'. $rb . $g4; return $jd; } function md ($uu){ $k0 = pathinfo ($uu); $g4 = @$k0['extension']; if ($g4 == 'png') return 'image/png'; if ($g4 == 'webp') return 'image/webp'; if ($g4 == 'gif') return 'image/gif'; if ($g4 == 'jpg' or $g4 == 'jpeg') return 'image/jpeg'; if ($g4 == 'mp3') return 'audio/mpeg'; if ($g4 == 'svg') return 'image/svg+xml'; if ($g4 == 'mp4') return 'video/mp4'; if ($g4 == 'mov') return 'video/quicktime'; } function fd ($h0,$g0){ return strcasecmp ($h0,$g0)===0; } define ('SEARCH_EXTRA_PREFIX','Rose'); define ('SEARCH_LIMIT',20); define ('SEARCH_SNIPPETS_LIMIT',20); define ('SEARCH_USE_ROSE',1); define ('SEARCH_USE_MYSQL',1); define ('BSI_SELECT_PORTION',10); define ('BSI_GIVE_UP_TIMEOUT',10); define ('BSI_UNLOCK_TIMEOUT',10); use S2\Rose\Storage\Exception\EmptyIndexException; use S2\Rose\Storage\Database\PdoStorage; use S2\Rose\Storage\Database\MysqlRepository; use S2\Rose\Stemmer\PorterStemmerEnglish; use S2\Rose\Stemmer\PorterStemmerRussian; use S2\Rose\Indexer; use S2\Rose\Entity\Indexable; use S2\Rose\Entity\Query; use S2\Rose\Entity\ExternalContent; use S2\Rose\Finder; use S2\Rose\SnippetBuilder; function e2m_found ($parameters = array ()) { global$_strings,$_config; $parameters['query']=trim ($parameters['query']); $l2 = $parameters['query']; if (!$l2){ return array ( 'title' => $_strings['pt--search-query-empty'], 'heading' => $_strings['pt--search'], 'nothing' => $_strings['gs--search-query-empty'], ); } $w0 = false; $u0 = []; try { if (vs ()) { $i0 = ''; } else { $i0 = 'AND `IsVisible` = 1 '; } fm ( "SELECT * FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". $i0 . "AND `Keyword`='". am ($l2) ."'", 'get tags matching the search query' ); $zb = sm (); if (isset ($zb[0]['ID'])) { $w0 = [ 'href' => kq ('e2m_tag', array ('*tag' => $zb[0])), 'name' => htmlspecialchars ($l2,ENT_NOQUOTES,'UTF-8'), 'visible?' => (bool)$zb[0]['IsVisible'], ]; $u0 = ya ($zb[0]['ID'],4); array_unshift ($u0,$w0); } } catch (AeMySQLException $e){ v3 ($e,'Could not get tags matching the search query'); } $o0 = x1 (' ',$parameters['query']); if(SEARCH_USE_ROSE){ $p0 = new PorterStemmerRussian (new PorterStemmerEnglish ()); foreach ($o0 as $a3 => $q3){ $o0[$a3]=$p0 -> stemWord ($o0[$a3]); } } $c9 = array (); $rn = vs (); if(SEARCH_USE_ROSE){ try { $ar = rd (cl ()); $v9 = new Finder ($ar,$p0); $v9 -> setHighlightTemplate ('<mark>%s</mark>'); $b9 = new Query ($l2); $b9 -> setInstanceId ($_config['db_table_subset']); $b9 -> setLimit (SEARCH_LIMIT); $resultSet = $v9 -> find ($b9); foreach($resultSet -> getFoundExternalIds () as $y9){ $n9 = $y9 -> getId (); if ($n9[0]=='n'){ $note_id = substr ($n9,1); $sy = hm ($note_id); if (!empty ($_config['search_favourites_boost'])) { if ($sy['IsFavourite']) { $resultSet->setRelevanceRatio ( $n9, $_config['search_favourites_boost'] ); } } } } $snippetBuilder = new SnippetBuilder ($p0); $snippetBuilder -> setSnippetLineSeparator(' · '); $snippetBuilder -> attachSnippets ( $resultSet, static function (array $f9) use ($rn,$_config){ $e3 = new ExternalContent (); foreach ( array_slice ($f9,0,SEARCH_SNIPPETS_LIMIT) as $y9 ) { $n9 = $y9 -> getId (); if ($n9[0]=='n'){ $note_id = substr ($n9,1); $sy = hm ($note_id); if ($sy){ $noteView = new AeNoteView ($sy); $noteView -> setWantReadHref ($_config['count_reads']); $noteView -> setWantControls ($rn and !@$_config['read_only']); $noteView -> setWantHiddenTags ($rn); $j3 = $noteView -> getNoteCTree (); $d9[$sy['ID']] = $j3; $e3 -> attach ($y9,$j3['text']); } } } return $e3; } ); foreach($resultSet -> getItems () as $s9){ $a9 = $s9 -> getId (); if ($a9[0]=='n'){ $note_id = substr ($a9,1); $sy = hm ($note_id); if (!( nf ($sy)==='public' or ($rn and $sy['IsPublished']) )) continue; $sy['_']['_srprovider']='Rose'; $sy['_']['_rose_relevance']=$s9 -> getRelevance (); $sy['_']['_rose_title']=$s9 -> getHighlightedTitle ($p0); $sy['_']['_rose_snippet']=$s9 -> getSnippet (); $c9[] = $sy; } } $q9 = false; if (@$_config['dev_rose_info']) { $q9 = print_r ($resultSet -> getTrace (), true); } } catch (EmptyIndexException $e){ hd (cl ()); ad (USER_DIR); } catch (AeMySQLException $e){ v3 ($e,'Could not do something with the database while working on Rose search results'); } } if(SEARCH_USE_MYSQL){ $l9 = am (preg_quote ($l2)); $z9 = 'MySQL FT'; $k9 = ( "SELECT * FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished`=1 AND (". "MATCH (`Title`, `Text`) AGAINST ('". $l9 ."')". ") ". mf ($rn). "LIMIT ". SEARCH_LIMIT ); try { fm ( $k9, 'search using MySQL fulltext search' ); $e3 = sm (); foreach ($e3 as $a3 => $sy){ $sy['_']['_srprovider']=$z9; $c9[] = $sy; } } catch (AeMySQLException $e){ v3 ($e,'Could not search using MySQL fulltext search'); } } $x9 = array (); $kn = array (); $rb = 0; foreach ($c9 as $sy){ if (!in_array ($sy['ID'],$x9)) { if (!empty ($d9[$sy['ID']])) { $r = $d9[$sy['ID']]; } else { $noteView = new AeNoteView ($sy); $noteView -> setWantReadHref ($_config['count_reads']); $noteView -> setWantControls ($rn and !@$_config['read_only']); $r = $noteView -> getNoteCTree (); } $r['search-result-provider']=$sy['_']['_srprovider']; if ($sy['_']['_srprovider']=='Rose'){ $r['search-rose'] = [ 'relevance' => $sy['_']['_rose_relevance'], 'title' => $sy['_']['_rose_title'], 'snippet' => $sy['_']['_rose_snippet'], ]; } if (@$sy['_']['_rose_title']) { $r['title']=$sy['_']['_rose_title']; } else { $r['title']=td ($r['title'],$o0); } $r['title']=dy ($r['title']); if (!empty ($sy['_']['_rose_snippet'])) { $r['snippet-text']=$sy['_']['_rose_snippet']; } else { $q1 = $r['text']; $q1 = preg_replace ('/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/i','',$q1); $q1 = preg_replace ('/<style\b[^<]*(?:(?!<\/style>)<[^<]*)*<\/style>/i','',$q1); $q1 = str_replace ( array ( '<br>', '<br/>', '<br />', '</h1>', '</h2>', '</h3>', '</h4>', '</h5>', '</h6>', '</p>', '</pre>', '</blockquote>', '</li>', ), ' ', $q1 ); $q1 = strip_tags ($q1); $e9 = array (); $r9 = preg_split ('/[\\n\(\)\[\]]|[.:;?!](\s|$)/uis',$q1); $t9 = 0; $j9 = ''; foreach ($r9 as $h9){ $h9 = trim ($h9); if (!$h9) continue; if (!$j9)$j9 = $h9; $g9 = $h9; $g9 = td ($g9,$o0); if ($g9 != $h9){ $e9[] = jd ($g9); $t9 ++; if ($t9 > 3) break; } } if(count ($e9)) { $r['snippet-text']=implode (' · ',$e9); } else { $r['snippet-text']=$j9; } } $r['has-highlighed-thumbs?']=false; if ($ib = @$r['format-info']['resources-detected']) { $w9 = k2 ( q2 ($ib) ); foreach ($w9 as $a3 => $q3){ $w9[$a3]['highlighted?'] = ( strstr ($q3['original-filename'],$l2)!==false ); if ($w9[$a3]['highlighted?']) { $r['has-highlighted-thumbs?']=true; } } $r['thumbs']=$w9; } $kn[] = $r; $x9[] = $sy['ID']; $rb ++; if ($rb >= SEARCH_LIMIT) break; } } $r2 = count ($kn); if ($r2){ $u9 = e2l_get_string ( 'pt--n-posts', array ('number' => $r2) ); } else { $u9 = $_strings['pt--no-posts']; $cb['nothing']=$_strings['gs--nothing-found']; } if ($rb >= SEARCH_LIMIT){ $u9 = $_strings['gs--many-posts']; } if ($u0){ $cb['search-related-tags']=$u0; } $cb['notes']=$kn; $cb['pages'] = array (); $cb['title']=$u9 .' '. $_strings['gs--found-for-query'] .': '. htmlspecialchars ($l2,ENT_NOQUOTES,'UTF-8'); $cb['heading']=$l2; if (@$q9){ $cb['rose-debug-info']=$q9; } return $cb; } function dd ($parameters){ if(Log::$a)__log ('Search form'); $l2 = trim ((string) @$parameters['query']); return [ 'form-action' => kq ('e2s_search'), 'query' => htmlspecialchars ($l2,ENT_COMPAT,'UTF-8'), ]; } function e2s_search () { $l2 = @$_POST['query']; $l2 = str_replace ('?',urlencode ('?'),$l2); $l2 = str_replace ('/',' ',$l2); $l2 = trim ($l2); $l2 = str_replace (' ','+',$l2); q1 (kq ('e2m_found', array ('query' => $l2))); } function sd () { global$_config; fm ( "SELECT COUNT(*) c FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished` = 1 ", 'count total published notes' ); $l6 = sm (); $i9 = $l6[0]['c']; fm ( "SELECT COUNT(*) c FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsIndexed` = 1 AND `IsPublished` = 1 ", 'count indexed published notes' ); $l6 = sm (); $o9 = $l6[0]['c']; $p9 = true; foreach (ed () as $o5){ if (!cm ( cl (), SEARCH_EXTRA_PREFIX . $o5 )) { $p9 = false; break; } } $ci = qd (USER_DIR); if (!$p9){ $o9 = 0; $ci['spent']=false; } $vi = $i9 - $o9; return [ 'indexed_count' => $o9, 'total_count' => $i9, 'remaining_count' => $vi, 'time_spent' => @$ci['spent']? $ci['spent']:false, ]; } function e2s_bsi_step () { global$_config; $ci = qd (USER_DIR); ignore_user_abort (true); echo '<pre>'; if($_config['log_bsi']) { Log::$a = true; if(Log::$a)sn ('bsi'); } if(Log::$a)__log ('BSI step'); if ( !isset ($ci['lock']) or $ci['lock']<time () - (BSI_GIVE_UP_TIMEOUT + BSI_UNLOCK_TIMEOUT) ) { if (isset ($ci['lock'])) { if(Log::$a)__log ('Indexer: old lock is '. $ci['lock']); echo 'Old lock is '. $ci['lock'] .'<br />'; } else { echo 'No old lock<br />'; } $ci['lock']=time (); if (!@e3 (USER_DIR . 'bsi.psa',serialize ($ci))) { if(Log::$a)__log ('Indexer: can’t get a new lock'); die ('Can’t get a new lock<br />'); } if(Log::$a)__log ('Indexer: new lock is '. $ci['lock']); echo 'New lock is '. $ci['lock'] .'<br /><br />'; try { $rb = 0; $bi = 0; $yi = mq (); $ni = false; $mi = false; while ($bi < BSI_GIVE_UP_TIMEOUT){ fm ( "SELECT * FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsIndexed`=0 AND `IsPublished`=1 ". "ORDER BY `Stamp` DESC ". "LIMIT ". BSI_SELECT_PORTION, 'get portion of unindexed notes for indexing' ); $l6 = sm (); if(count ($l6)) { ++ $rb; if(Log::$a)__log ('Indexer: portion '. $rb); echo 'Portion '. $rb .'<br />'; foreach ($l6 as $s){ if(Log::$a)__log ('Indexer: indexing "'. $s['Title'].'"'); echo 'Indexing: '. $s['Title'] .'<br />'; if (zd ($s)) { $s['IsIndexed']='1'; nm (cl (), 'Notes',$s); } else { $mi = true; break 2; } if($_config['broadcast_on_indexing']) { wv ($s); } } $bi = round (mq () - $yi,3); if(Log::$a)__log ('Indexer: steps done '. count ($l6) .', spent '. $bi .' ms so far'); echo 'Steps done '. count ($l6) .', spent '. $bi .' ms so far<br /><br />'; } else { $ni = true; break; } } if ($ni){ if(Log::$a)__log ('Indexer: indexing complete'); echo 'Indexing complete<br /><br />'; if(CACHE_INDEXED_FLAG){ @e3 (USER_DIR . CACHE_FILENAME_INDEXED_FLAG,''); } } elseif ($mi){ if(Log::$a)__log ('Indexer: indexing failed'); echo 'Indexing failed<br /><br />'; } else { if(Log::$a)__log ('Indexer: time out'); echo 'Time out<br />'; unset ($ci['lock']); } if ($ci['spent']!=='?')$ci['spent']+=$bi; @e3 (USER_DIR . 'bsi.psa',serialize ($ci)); } catch (AeMySQLException $e){ v3 ($e,'Could not index notes'); if(Log::$a)__log ('Indexer: DB unaccessible'); echo 'DB unaccessible<br />'; } } else { if(Log::$a)__log ('Indexer: locked'); echo 'Locked<br />'; } die ('</pre>'); } function e2s_reindex () { global$_config; if (!$_config['allow_underhood_access']) { q1 (kq ('e2m_settings')); } if($_SERVER['REQUEST_METHOD']=='POST'){ ud (); @unlink (USER_DIR . CACHE_FILENAME_INDEXED_FLAG); hd (cl (), true); ad (USER_DIR); } q1 (kq ('e2m_underhood')); } function ad ($p3){ $ci = ['spent' => 0]; @e3 ($p3 . 'bsi.psa',serialize ($ci)); return $ci; } function qd ($p3){ $ci = @unserialize (file_get_contents (USER_DIR . 'bsi.psa')); if (!is_array ($ci)) { $ci = ad ($p3); } return $ci; } function ld () { if(CACHE_INDEXED_FLAG and is_file (USER_DIR . CACHE_FILENAME_INDEXED_FLAG)) { return true; } $fi = sd (); $yj = ($fi['remaining_count']===0); if(CACHE_INDEXED_FLAG and $yj){ e3 (USER_DIR . CACHE_FILENAME_INDEXED_FLAG,''); } return $yj; } function zd ($sy){ static $di = null; if(Log::$a)__log ('Indexer: index noterec'); $databaseConfiguration = cl (); try { if ($di === null){ $p0 = new PorterStemmerRussian (new PorterStemmerEnglish ()); $di = new Indexer (rd ($databaseConfiguration),$p0); } $dd = ay ($sy['FormatterID'], @$sy['Text'],'full-rss'); r3 ( 'note',$sy, $dd['meta']['resources-detected'] ); $q1 = strip_tags ($dd['text-final']); $si = new Indexable ( 'n'. $sy['ID'], $sy['Title'], $q1, $databaseConfiguration -> getSubset () ); $di -> index ($si); return true; } catch (EmptyIndexException $e){ hd (cl ()); ad (USER_DIR); } catch (\Exception $e){ v3 ($e,'Could not index note'); return false; } } function kd ($ly){ global$_config; static $di = null; $databaseConfiguration = cl (); try { if ($di === null){ $p0 = new PorterStemmerRussian (new PorterStemmerEnglish ()); $di = new Indexer (rd ($databaseConfiguration),$p0); } return $di -> removeById ('n'. $ly,$_config['db_table_subset']); } catch (EmptyIndexException $e){ hd ($databaseConfiguration); ad (USER_DIR); } catch (\Exception $e){ v3 ($e,'Could not unindex note'); return false; } } function xd ($gx){ $prefix = 'S2\\Rose\\'; if(BUILT){ $ai = __DIR__ . '/library/rose/'; } else { $ai = __DIR__ . '/../library/rose/'; } $yz = strlen ($prefix); if(strncmp ($prefix,$gx,$yz)!==0) return; $qi = substr ($gx,$yz); $n2 = $ai . str_replace ('\\','/',$qi).'.php'; if(file_exists ($n2)) require $n2; } function ed () { return array ( 'TOC' => 'Contents', 'WORD' => 'Word', 'FULLTEXT_INDEX' => 'Fulltext', 'KEYWORD_INDEX' => 'Keyword', 'KEYWORD_MULTIPLE_INDEX' => 'KeywordMultiple', ); } function rd (AeDatabaseConfiguration $databaseConfiguration){ static $li = null; if ($li === null and SEARCH_USE_ROSE){ $zi = new \PDO ( 'mysql:'. 'host='. $databaseConfiguration->host .';'. 'dbname='. $databaseConfiguration->name.';'. 'port='. $databaseConfiguration->port, $databaseConfiguration->user, ls ($databaseConfiguration->password) ); $zi -> exec ('SET NAMES utf8mb4'); $zi -> setAttribute (\PDO::ATTR_ERRMODE,\PDO::ERRMODE_EXCEPTION); $ki = ed (); $li = new PdoStorage ( $zi, $databaseConfiguration -> getPrefix () . SEARCH_EXTRA_PREFIX, [ MysqlRepository::TOC => $ki['TOC'], MysqlRepository::WORD => $ki['WORD'], MysqlRepository::FULLTEXT_INDEX => $ki['FULLTEXT_INDEX'], MysqlRepository::KEYWORD_INDEX => $ki['KEYWORD_INDEX'], MysqlRepository::KEYWORD_MULTIPLE_INDEX => $ki['KEYWORD_MULTIPLE_INDEX'], ] ); } return $li; } function td ($q1,$o0){ foreach ($o0 as $oj){ if ($oj == '-') continue; $oj = preg_quote ($oj,'/'); $oj = str_replace ('е','[её]',$oj); $oj = str_replace ('Е','[ЕЁ]',$oj); $q1 = preg_replace ('/(?<=^|\W)('.$oj.'[\w\p{M}]*)/iu','<mark>$1</mark>',$q1); } $q1 = str_replace ('</mark> <mark>',' ',$q1); $q1 = str_replace ('</mark> <mark>',' ',$q1); return $q1; } function jd ($xi){ $ei = mb_strtoupper (mb_substr ($xi,0,1)); return $ei . mb_substr ($xi,1); } function hd (AeDatabaseConfiguration $databaseConfiguration,$ri = false){ $ti = false; if($databaseConfiguration -> hasSubsetSpecified () and !$ti){ if(Log::$a)__log ('Search: unmark and unindex subset'); $c1 = "WHERE `SubsetID`=". $databaseConfiguration -> getSubset (); } else { if(Log::$a)__log ('Search: unmark and unindex all'); $c1 = ''; } fm ( "UPDATE `". $databaseConfiguration -> getPrefix () . "Notes` ". "SET `IsIndexed`=0 ". $c1, 'mark all notes for reindexing' ); if ($ri)hb ('Notes marked for reindexing',E2E_MESSAGE); $ar = rd ($databaseConfiguration); try { $ar -> erase (); if ($ri)hb ('Indexes erased',E2E_MESSAGE); } catch (\S2\Rose\Exception\RuntimeException $e){ if(Log::$a)__log ('Rose threw RuntimeException'); } } function e2m_password_reset () { global$_strings,$_config,$settings; if (!is_file (USER_DIR. 'password-reset.psa')) { $py = sha1 (ds ()); $url = kq ('e2m_password', array ('recovery-key' => $py)); @e3 (USER_DIR. 'password-reset.psa',$url); } $cb['title']=$_strings['pt--password-reset']; $cb['heading']=$_strings['pt--password-reset']; $ji = (bool) ($na = $settings['author_email']); $cb['form']='form-password-reset-email'; $cb['form-password-reset-email'] = array ( 'form-action' => kq ('e2s_password_reset_email'), 'show-controls?' => $ji, 'submit-text' => $_strings['fb--send-link-by-email'], ); if($_config['user_has_access_to_filesystem']) { $cb['form-password-reset-email']['reset-info']=$_strings['gs--password-reset-link-saved']; } elseif (!$ji){ hb ($_strings['er--cannot-reset-password']); } return $cb; } function e2s_password_reset_email () { global$_strings,$settings; if($_SERVER['REQUEST_METHOD']!='POST')q1 (); if(array_key_exists ('email',$_POST))$xs = trim ($_POST['email']); if (!$xs){ hb ($_strings['er--cannot-send-link-email-empty']); q1 (kq ('e2m_password_reset')); } $hi = @file_get_contents (USER_DIR. 'password-reset.psa'); if(strlen ($hi)==0){ hb ($_strings['er--error-occurred']); q1 (kq ('e2m_password_reset')); } if ($na = $settings['author_email']) { if ($xs == $na){ $ba = ln ( 'password-reset', array ('reset-href' => $hi) ); $ya = $_strings['em--password-reset-subject']; $ma = 'From: '. zn (); kn ($na,$ya,$ba,$ma); } hb ($_strings['gs--password-reset-link-sent-maybe'],E2E_MESSAGE); q1 (kq ('e2m_password_reset')); } die; } function e2m_password ($parameters){ global$_strings; $gi = false; $py = ''; if(array_key_exists ('recovery-key',$parameters)) { $py = $parameters['recovery-key']; $url = kq ('e2m_password', array ('recovery-key' => $py)); $hi = @file_get_contents (USER_DIR. 'password-reset.psa'); if(strlen ($hi)>0){ $gi = ($url == $hi); } } if (vs () or $gi){ $cb['title']=$_strings['pt--password']; $cb['heading']=$_strings['pt--password-for-blog']; if ($gi){ $cb['title']=$_strings['pt--password-reset']; $cb['heading']=$_strings['pt--password-reset']; } $cb['form']='form-password'; $cb['form-password'] = array ( '.recovery-key' => $py, 'form-action' => kq ('e2s_password_save'), 'recovering?' => $gi, 'submit-text' => $_strings['fb--change'], ); return $cb; } else { q1 (); } } function e2m_sessions () { global$_strings; $zr = bs (); $cb['title']=$_strings['pt--sessions']; $cb['heading']=$_strings['pt--sessions']; $wi = array (); $py = $_COOKIE[z1 ('key')]; foreach ($zr['sessions'] as $a3 => $q3){ $wi[] = array ( 'current?' => sha1 ($py)===$q3['key_hash'], 'opened' => array ((int)$q3['stamp'],ua ()), 'ip-address' => $q3['remote_ip'], 'source' => ($q3['remote_ip']=='127.0.0.1')? $_strings['gs--locally']:$q3['remote_ip'], 'title' => fs ($q3['ua']), 'user-agent' => $q3['ua']? $q3['ua']:$_strings['gs--unknown'], ); } $wi = array_reverse ($wi); $cb['sessions']['each']=$wi; if(count ($wi)>1){ $cb['form']='form-sessions'; $cb['form-sessions'] = array ( 'form-action' => kq ('e2s_drop_other_sessions'), 'submit-text' => $_strings['fb--end-all-sessions-but-this'], ); } return $cb; } function e2m_sign_in () { global$_strings; if (vs ())q1 (kq ('e2m_frontpage', array ('page' => 1))); return [ 'title' => $_strings['pt--sign-in'], ]; } function e2m_sign_out () { global$_strings; $zr = bs (); $ui = -1; if(array_key_exists ('sessions',$zr) and is_array ($zr['sessions'])) { foreach ($zr['sessions'] as $a3 => $q3){ $py = $_COOKIE[z1 ('key')]; if(sha1 ($py)===$q3['key_hash']) { $ui = $a3; break; } } } if ($ui > -1) unset ($zr['sessions'][$ui]); if (!ys ($zr)) { hb ($_strings['er--cannot-write-auth-data'],E2E_PERMISSIONS_ERROR); } k1 ('key',''); q1 (); } function e2s_password_save () { global$_strings; ud (); $gi = false; $ii = trim ($_POST['old-password']); if ($py = trim ($_POST['recovery-key'])) { $url = kq ('e2m_password', array ('recovery-key' => $py)); $hi = @file_get_contents (USER_DIR. 'password-reset.psa'); if(strlen ($hi)>0){ $gi = ($url == $hi); } } if (od ($ii) or $gi){ $qr = trim ($_POST['new-password']); if ($qr != ''){ if (@e3 (USER_DIR. 'password-hash.psa',serialize (sha1 ($qr)))) { @unlink (USER_DIR. 'password-reset.psa'); hb ($_strings['gs--password-changed'],E2E_MESSAGE); q1 (); } else { hb ($_strings['er--could-not-change-password'],E2E_PERMISSIONS_ERROR); q1 (kq ('e2m_password', array ('recovery-key' => ''))); } } else { hb ($_strings['er--no-password-entered'],E2E_USER_ERROR); q1 (kq ('e2m_password', array ('recovery-key' => ''))); } } else { hb ($_strings['er--wrong-password'],E2E_USER_ERROR); q1 (kq ('e2m_password', array ('recovery-key' => ''))); } die; } function gd () { global$_token; if (!vs ()) return ''; return$_token; } function wd () { return sha1 ( $_SERVER['HTTP_USER_AGENT'].id () . time () . mt_rand (1000000,9999999) ); } function ud () { global$_token; if (!vs ()) return true; if ( !array_key_exists ('token',$_POST) or ((string)$_POST['token'] !== (string) @$_token) ) { throw new AeTokenException ('Incorrect token'); } return true; } function id () { $oi = $_SERVER['REMOTE_ADDR']; if(array_key_exists ('HTTP_X_FORWARDED_FOR',$_SERVER)) { $oi = array_pop (explode (',',$_SERVER['HTTP_X_FORWARDED_FOR'])); } return $oi; } function e2s_sign_in () { global$_strings; $zr = bs (); if($_SERVER['REQUEST_METHOD']=='POST'){ $password = @$_POST['password']; $pi = @$_POST['is_public_pc']; } else { $password = @$_GET['password']; $pi = false; } if (od ($password)) { @unlink (USER_DIR. 'password-reset.psa'); $co = [ 'stamp' => time (), 'remote_ip' => id (), 'key_hash' => cs ($pi), 'anti_csrf_token' => wd (), 'ua' => $_SERVER['HTTP_USER_AGENT'], ]; $zr['sessions'][] = $co; } elseif(strlen (trim ($password)) > 0){ ss (); hb ($_strings['er--wrong-password'],E2E_USER_ERROR); } if (!ys ($zr)) { hb ($_strings['er--cannot-write-auth-data'],E2E_PERMISSIONS_ERROR); q1 (); } l1 (); } function e2s_drop_other_sessions () { global$_strings; ud (); $zr = bs (); $co = null; foreach ($zr['sessions'] as $a3 => $q3){ $py = $_COOKIE[z1 ('key')]; if(sha1 ($py)===$q3['key_hash']) { $co = $q3; break; } } $zr['sessions'] = array ($co); if (!ys ($zr)) { hb ($_strings['er--cannot-write-auth-data'],E2E_PERMISSIONS_ERROR); } l1 (); die; } function od ($password){ $vo = @unserialize (file_get_contents (USER_DIR. 'password-hash.psa')); return (sha1 ($password)===$vo and trim ($password)!=''); } function pd () { $vo = @unserialize (file_get_contents (USER_DIR. 'password-hash.psa')); return is_string ($vo) and $vo !== ''; } function cs ($bo = false){ $py = ds (); $yo = sha1 ($py); k1 ('key',$py, !$bo); return $yo; } function vs () { static $no = null; global$_token; if ($no !== null) return $no; $no = false; if (!isset ($_COOKIE[z1 ('key')])) return $no; $zr = bs (); $yo = sha1 ($_COOKIE[z1 ('key')]); $no = false; $_token = ''; foreach ($zr['sessions'] as &$co){ if ($yo === $co['key_hash']) { $no = true; $_token = (string) @$co['anti_csrf_token']; if($_token === ''){ $co['anti_csrf_token']=wd (); ys ($zr); } break; } } if (!$no)k1 ('key',''); return $no; } function bs () { $zr = []; if(is_file (USER_DIR . 'auth.psa')) { $zr = unserialize (@file_get_contents (USER_DIR . 'auth.psa')); } if (!is_array ($zr))$zr = []; if (!array_key_exists ('sessions',$zr))$zr['sessions'] = []; if (!is_array ($zr['sessions']))$zr['sessions'] = []; return $zr; } function ys ($zr){ return e3 (USER_DIR . 'auth.psa',serialize ($zr)); } function ns () { if ($py = @$_COOKIE[z1 ('key')]) { return z1 ('key') .'='. $py .""; } } function ms () { if ($py = @$_COOKIE[z1 ('key')]) { return 'Cookie: '. z1 ('key') .'='. $py ."\r\n"; } return "\r\n"; } function fs ($mo){ global$_strings; if(strstr ($mo,'iPhone')) return$_strings['gs--ua-iphone']; if(strstr ($mo,'iPad')) return$_strings['gs--ua-ipad']; if(strstr ($mo,'Opera'))$cb = $_strings['gs--ua-opera']; if(strstr ($mo,'Firefox'))$cb = $_strings['gs--ua-firefox']; if(strstr ($mo,'Chrome'))$cb = $_strings['gs--ua-chrome']; if(strstr ($mo,'Safari') and !strstr ($mo,'Chrome'))$cb = $_strings['gs--ua-safari']; if (!$cb)$cb = $_strings['gs--ua-unknown']; if(strstr ($mo,'Macintosh')) { if ($cb)$cb .= ' '. $_strings['gs--ua-for-mac']; } return $cb; } function e2j_check_password () { $vo = @unserialize (file_get_contents (USER_DIR. 'password-hash.psa')); $password = ''; if(array_key_exists ('password',$_POST))$password = $_POST['password']; ss (); $bl = [ 'success' => true, 'data' => [ 'password-correct' => trim ($password)!=='' and sha1 ($password)===$vo ], ]; $bl = json_encode ($bl); die ($bl); } function ds () { if(function_exists ('random_bytes')) { $so = sha1 (random_bytes (128)); } else { $so = ''; $ao = '0123456789abcdef'; for ($rb = 0; $rb < 40; $rb++) { $so .= $ao[mt_rand (0,15)]; } $so .= time () . microtime (); $so = sha1 ($so); } return $so; } function ss () { if(is_file (USER_DIR. 'password-wait.psa')) { $qo = unserialize ( file_get_contents (USER_DIR. 'password-wait.psa') ); if ($qo['delay']<5){ $qo['delay'] ++; } if(time () - $qo['time']>SECONDS_IN_A_MINUTE){ $qo['delay']=0; } $qo['time']=time (); } else { $qo = array ( 'time' => time (), 'delay' => 5, ); } e3 (USER_DIR . 'password-wait.psa',serialize ($qo)); sleep ($qo['delay']); } function as_ () { static $lo; if(empty($lo))$lo = md5 ('seсret'); return $lo; } function qs ($pl){ $py = as_ (); $zo = strlen ($py); $ko = strlen ($pl); $cb = ''; for ($rb = 0; $rb < $ko + rand (16,64); ++ $rb){ if ($rb > $ko){ $xo = rand (0,127); } elseif ($rb == $ko){ $xo = 0; } else { $xo = ord ($pl[$rb]); } $eo = chr (($xo + ord ($py[$rb%$zo])) % 256); $cb .= $eo; } $cb = base64_encode ($cb); return $cb; } function ls ($pl){ $py = as_ (); $zo = strlen ($py); $pl = base64_decode ($pl); $ko = strlen ($pl); $cb = ''; for ($rb = 0; $rb < $ko; ++ $rb){ $ro = (ord ($pl[$rb]) + 256 - ord ($py[$rb%$zo])) % 256; if ($ro === 0) break; $cb .= chr ($ro); } return $cb; } function zs () { global$settings; if (vs ()) { return null; } else { return [ 'form-action' => kq ('e2s_sign_in'), 'form-check-password-action' => kq ('e2j_check_password'), 'login-name' => @$settings['author'], 'public-pc?' => false, 'reset-href' => kq ('e2m_password_reset'), ]; } } function ks () { if (!vs ()) return; list (, $to)=es (); $e3 = false; foreach ($to as $gd => $jo){ if(Log::$a)__log ( 'Selfcheck: Double-checking remote access of "'. $gd .'" '. 'before showing a warning (status was '. $jo.')...' ); $v2 = vv (AeEnv::$o . $gd); if ($v2 and $v2['http_code'] >= 400) continue; $e3 = true; $url = AeEnv::$o . $gd; hb ( 'Security alert: <a href="'. $url .'">'. $gd .'</a> '. 'responded with HTTP '. $v2['http_code'] .' instead of 403' ); } return $e3; } function xs () { list ($ho,$to)=es (); $qd = time (); if ( $ho === false or ( array_key_exists ('completed-stamp',$ho) and @$ho['completed-stamp']<$qd - SECONDS_IN_A_WEEK ) ) { $ho = rs (); } $go = false; if(count ($to)) { $go = true; } foreach ($ho['statuses'] as $gd => $jo){ if ($jo >= 400) continue; if(Log::$a)__log ('Selfcheck: Checking remote access of "'. $gd .'"...'); $v2 = vv (AeEnv::$o . $gd); if (!$v2 or @$v2['http_code']<200) break; $jo = $v2['http_code']; $ho['statuses'][$gd]=$jo; if(Log::$a)__log ('Selfcheck: The response is '. $v2['http_code']); if ($jo >= 400 and !$go){ break; } else { $go = true; } } if (!array_key_exists ('completed-stamp',$ho)) { end ($ho['statuses']); $wo = !empty (current ($ho['statuses'])); if ($wo)$ho['completed-stamp']=$qd; if ($wo)$ho['completed']=date ('r',$qd); } @e3 (USER_DIR . 'checklist.psa',serialize ($ho)); } function es () { static $ho,$to = null; if ($ho !== null and $to !== null){ return [$ho,$to]; } $uo = USER_DIR . 'checklist.psa'; $ho = @unserialize (file_get_contents ($uo)); $io = @$ho['statuses']; $to = []; if(is_array ($io)) { foreach ($io as $gd => $jo){ if ($jo !== null and $jo < 400){ $to[$gd]=$jo; } } } else { $ho = false; } return [$ho,$to]; } function rs () { global$_config; if(Log::$a)__log ('Selfcheck: Reset access checklist file'); $oo = array_merge ( AeFileManager::writtenFiles ($_config['path_user'],$_config['path_media']), [ '.htaccess', 'system/core.php', 'system/default/config.php', INSTANCE_DIR . LOGS_DIRNAME . MAIN_LOG_FILENAME, $_config['path_media'].PICTURES_DIRNAME .'.htaccess', $_config['path_media'].THUMBNAILS_DIRNAME .'.htaccess', $_config['path_media'].AVATARS_DIRNAME .'.htaccess', $_config['path_media'].USERPIC_DIRNAME .'.htaccess', $_config['path_media'].VIDEO_DIRNAME .'.htaccess', $_config['path_media'].AUDIO_DIRNAME .'.htaccess', USER_DIR . CACHE_FILENAME_FRONTPAGE, USER_DIR . BACKUP_DIRNAME .'backup-tail.sql', ] ); foreach ($oo as $gd){ $po[$gd]=null; } $ho = ['statuses' => $po]; @e3 (USER_DIR . 'checklist.psa',serialize ($ho)); return $ho; } function ts () { $cp['items_count']=0; $cp['total_count']=0; $cp['percentage']=0; $cp['stamp_completed']=false; $uo = USER_DIR . 'checklist.psa'; $ho = @unserialize (file_get_contents ($uo)); if ($ho === false) return $cp; $io = @$ho['statuses']; $r2 = $vp = 0; if(is_array ($io)) { foreach ($io as $jo){ $r2 ++; if ($jo !== null){ $vp ++; } } $cp['items_count']=$vp; $cp['total_count']=$r2; $cp['percentage']=r1 ($vp,$r2); } $cp['stamp_completed'] = @$ho['completed-stamp']; return $cp; } function e2_load_settings_from_user_folder_($bp){ $yp = []; if(is_file ($bp . 'settings.json')) { $yp = json_decode (file_get_contents ($bp . 'settings.json'),true); } $yp = ws ($yp); return $yp; } function e2m_settings () { global$_lang,$_template,$_strings,$_config,$settings; $np = []; foreach(glob (SYSTEM_DIR . LANGUAGES_DIRNAME. '*.php') as $gd){ $mp = substr (basename ($gd),0,2); $fp = file_get_contents ($gd); if(preg_match ( '/^ *\/\/ *display_name *\= *(.*?) *$/ismu',$fp,$me )) { $fu = $me[1]; } else { $fu = $mp; } $np[$mp] = array ( 'selected?' => (bool) ($_lang == $mp), 'display-name' => $fu, ); } $ad = $dp = false; $sp = (string) @$ad['pay-href']; if ((string)$sp === ''){ $sp = 'https://'. $_strings['e2--website-host'] .'/get/'; } if (!isset ($_template))lf (); $cb['title']=$_strings['pt--settings']; $cb['heading']=$_strings['pt--settings']; $cb['form']='form-preferences'; $cb['form-preferences'] = [ 'blog-title-default' => htmlspecialchars ((string) @$_strings['e2--default-blog-title'],ENT_COMPAT,'UTF-8'), 'blog-title' => htmlspecialchars (ev (), ENT_COMPAT,'UTF-8'), 'blog-subtitle' => htmlspecialchars ((string) @$settings['blog_subtitle'],ENT_COMPAT,'UTF-8'), 'blog-meta-description' => htmlspecialchars ((string) @$settings['meta_description'],ENT_COMPAT,'UTF-8'), 'blog-author-default' => htmlspecialchars ((string) @$_strings['e2--default-blog-author'],ENT_COMPAT,'UTF-8'), 'blog-author' => htmlspecialchars ((string) @$settings['author'],ENT_COMPAT,'UTF-8'), 'languages' => $np, 'language' => $_lang, 'form-action' => kq ('e2s_settings_save'), 'userpic-href' => tv ('square'), 'notes-per-page' => $settings['appearance']['notes_per_page'], 'emailing-possible?' => MAIL_ENABLED, 'email-notify?' => (bool) @$settings['notifications']['new_comments'], 'email' => htmlspecialchars ((string) @$settings['author_email'],ENT_COMPAT,'UTF-8'), 'comments-default-on?' => (bool) @$settings['comments']['default_on'], 'comments-require-gip?' => (bool) @$settings['comments']['require_gip'], 'comments-fresh-only?' => (bool) @$settings['comments']['fresh_only'], 'show-view-counts?' => (bool) @$settings['appearance']['show_view_counts'], 'show-sharing-buttons?' => (bool) @$settings['appearance']['show_sharing_buttons'], 'includes-main-menu-fields?' => false, 'main-menu-promo' => e2l_get_string ( 'pm--main-menu', ['url' => $_config['paid_features_url']] ), 'show-main-menu?' => false, 'main-menu-items' => [], 'includes-analytics-fields?' => false, 'analytics-promo' => e2l_get_string ( 'pm--analytics', ['url' => $_config['paid_features_url']] ), 'template-name' => $_template['name'], 'templates' => uf (), 'respond-to-dark-mode?' => (bool) @$settings['appearance']['respond_to_dark_mode'], 'submit-text' => $_strings['fb--save-changes'], 'show-payment-info?' => $dp and ($ad !== false), 'paid-period' => @$ad['licensed?'] ? (time () <= $ad['until-stamp']) : false, 'paid-period-ended' => @$ad['licensed?'] ? (time () > $ad['until-stamp']) : false, 'paid-until' => @$ad['licensed?'] ? ([$ad['until-stamp'],ia ()]) : false, 'pay-href' => $sp, 'space-usage' => yy (vy (), true), ]; return $cb; } function e2s_settings_save () { global$settings,$_strings; if($_SERVER['REQUEST_METHOD']!='POST'){ q1 (kq ('e2m_settings')); } ud (); $lp = $sd = ''; if(array_key_exists ('blog-title',$_POST)) { $lp = trim ($_POST['blog-title']); } if(array_key_exists ('blog-subtitle',$_POST)) { $sd = trim ($_POST['blog-subtitle']); } if(array_key_exists ('blog-meta-description',$_POST)) { $zp = trim ($_POST['blog-meta-description']); } if(array_key_exists ('blog-author',$_POST)) { $kp = trim ($_POST['blog-author']); } if(array_key_exists ('language',$_POST)) $xp = $_POST['language']; if(array_key_exists ('email',$_POST)) $xs = trim ($_POST['email']); $ep = (int)$_POST['notes-per-page']; $settings['blog_title']=$lp; $settings['blog_title']=ev (); $settings['author']=$kp; $settings['author_email']=$xs; $settings['notifications']['new_comments'] = isset ($_POST['email-notify']); if(array_key_exists ('template',$_POST)) { $settings['template']=trim ($_POST['template']); } $settings['comments']['default_on'] = isset ($_POST['comments-default-on']); $settings['comments']['require_gip'] = isset ($_POST['comments-require-gip']); $settings['appearance']['show_view_counts'] = isset ($_POST['show-view-counts']); if ( !array_key_exists ('language',$settings) or $settings['language']!=$xp ) { e2_drop_all_kinds_of_cache (); $settings['language']=$xp; } if ( @$settings['blog_subtitle']!=$sd or @$settings['meta_description']!=$zp or @$settings['appearance']['notes_per_page']!=$ep or @$settings['appearance']['show_sharing_buttons'] != isset ($_POST['show-sharing-buttons']) or @$settings['appearance']['respond_to_dark_mode'] != isset ($_POST['respond-to-dark-mode']) or @$settings['comments']['fresh_only'] != isset ($_POST['comments-fresh-only']) ) { @unlink (USER_DIR . CACHE_FILENAME_FRONTPAGE); @unlink (USER_DIR . CACHE_FILENAME_FRONTPAGE_FEED); @unlink (USER_DIR . CACHE_FILENAME_FRONTPAGE_AUTHOR); $settings['blog_subtitle']=$sd; $settings['meta_description']=$zp; $settings['appearance']['notes_per_page']=$ep; $settings['appearance']['show_sharing_buttons'] = isset ($_POST['show-sharing-buttons']); $settings['appearance']['respond_to_dark_mode'] = isset ($_POST['respond-to-dark-mode']); $settings['comments']['fresh_only'] = isset ($_POST['comments-fresh-only']); } cq (USER_DIR . CACHE_FILENAMES_NOTES_COMMENTS); if (!@e3 (USER_DIR . 'settings.json',json_encode ($settings,E2_JSON_STYLE))) { hb ($_strings['er--settings-not-saved'],E2E_PERMISSIONS_ERROR); q1 (kq ('e2m_settings')); } q1 (kq ('e2m_frontpage', array ('page' => 1))); } function e2m_underhood () { global$_db,$_config; if (!$_config['allow_underhood_access']) return e2m_error404 (); $cb['title']='Underhood'; $cb['heading']='Underhood'; mm (cl (), 'check version'); $rp = ia (); $tp = $jp = 0; foreach(glob (USER_DIR . CACHES_DIRNAME .'*') as $gd){ $tp ++; $jp += stat ($gd)['size']; } $hp = $gp = 0; foreach(glob (INSTANCE_DIR . LOGS_DIRNAME .'*') as $gd){ $hp ++; $gp += stat ($gd)['size']; } $fi = sd (); $wp = r1 ( $fi['indexed_count'],$fi['total_count'] ); $up = false; if ($fi['time_spent']) { if(is_numeric (($fi['time_spent']))) { $up = floor ($fi['time_spent']); } if ($up >= 60){ $up = ( floor ($up / 60) .'min '. str_pad ($up % 60,2,'0',STR_PAD_LEFT). 's' ); } elseif ($up > 0){ $up .= 's'; } else { $up = false; } } $cp = ts (); $ip = array_keys (lm (USER_DIR . BACKUP_DIRNAME)); $cb['form']='form-underhood'; $cb['form-underhood'] = [ 'db-software' => $_db['software'], 'db-version' => $_db['version'], 'form-action-engine-rebuild' => BUILT? false : kq ('e2s_post_service', ['service' => 'build']), 'current-timezone-offset' => ja ($rp ['offset']), 'current-timezone-is-dst' => $rp ['is_dst'], 'cache-files-count' => $tp, 'cache-files-size' => $jp, 'form-action-cache-invalidate' => kq ('e2s_post_service', ['service' => 'sync']), 'search-index-items-count' => $fi['indexed_count'], 'search-index-total-items-count' => $fi['total_count'], 'search-index-time-spent' => $up, 'search-index-percentage' => $wp, 'form-action-search-index-continue' => ld ()? false : kq ('e2s_bsi_step'), 'form-action-search-index-rebuild' => kq ('e2s_reindex'), 'checklist-items-count' => $cp['items_count'], 'checklist-total-items-count' => $cp['total_count'], 'checklist-percentage' => $cp['percentage'], 'checklist-stamp-completed' => !empty ($cp['stamp_completed'])? b1 ('D, M d, Y \a\t H:i:s',$cp['stamp_completed']) : false, 'form-action-checklist-reset' => kq ('e2s_post_service', ['service' => 'checklist-reset']), 'log-files-count' => $hp, 'log-files-size' => $gp, 'form-action-logs-enable' => ( is_file (INSTANCE_DIR . LOGS_DIRNAME . MAIN_LOG_FILENAME) ? '' : kq ('e2s_post_service', ['service' => 'log']) ), 'form-action-logs-erase-disable' => ( $hp? kq ('e2s_post_service', ['service' => 'unlog']) : '' ), 'backup-last' => count ($ip)? b1 ('D, M d, Y \a\t H:i:s',$ip[0]) : false, 'form-action-backup' => kq ('e2s_dump'), 'form-action-database-migrate' => kq ( 'e2s_post_service', ['service' => 'migrate'] ), 'form-action-license-verify' => kq ( 'e2s_post_service', ['service' => 'verify'] ), ]; return $cb; } function e2m_database () { global$settings,$_strings,$_config; $databaseConfiguration = cl (); if($databaseConfiguration->source !== 'settings' or !$_config['allow_db_config']) { return e2m_error404 (); } $cb['title']=$_strings['pt--database']; $cb['heading']=$_strings['pt--database']; $cb['form']='form-database'; $cb['form-database'] = array ( 'form-action' => kq ('e2s_database_save'), 'db-server' => htmlspecialchars (@$settings['db']['server']? $settings['db']['server']:'localhost'), 'db-user' => htmlspecialchars (@$settings['db']['user_name']? $settings['db']['user_name']:'root'), 'db-database' => htmlspecialchars (@$settings['db']['name']), 'submit-text' => $_strings['fb--connect-to-this-db'], ); return $cb; } function hs ($backup_dir,$op,$prefix = null,$subset = null){ $pp['server']=$pp['user_name'] = $pp['passw']=$pp['name']=''; if(array_key_exists ('db-server',$op)) $pp['server']=$op['db-server']; if(array_key_exists ('db-user',$op)) $pp['user_name']=$op['db-user']; if(array_key_exists ('db-password',$op))$pp['passw']=$op['db-password']; if(array_key_exists ('db-database',$op))$pp['name']=$op['db-database']; $databaseConfiguration = new AeDatabaseConfiguration ( 'post', $backup_dir, $pp['server'], $pp['user_name'], qs ($pp['passw']), $pp['name'], $prefix, $subset ); return$databaseConfiguration; } function e2s_database_save () { global$settings,$_db,$_strings,$_config; ud (); if($_SERVER['REQUEST_METHOD']!='POST'){ q1 (kq ('e2m_database')); } $databaseConfiguration = cl (); if($databaseConfiguration->source !== 'settings' or !$_config['allow_db_config']) { return e2m_error404 (); } $op = $_POST; if (!array_key_exists ('db-password',$op)) { $op['db-password']=htmlspecialchars (ls (@$settings['db']['passw'])); } $databaseConfiguration = hs ( USER_DIR . BACKUP_DIRNAME, $op, $_config['db_table_prefix'], $_config['db_table_subset'] ); $lr = false; try { mm ($databaseConfiguration,'check database from HTTP post'); $dr = in ($databaseConfiguration); if (!$dr['occupied'] or !$dr['migrateable']) { hb ($_strings['er--db-data-incomplete']); q1 (kq ('e2m_database')); } hn ($databaseConfiguration); $lr = true; } catch (AeMySQLCannotConnectException $e){ hb ( $_strings['er--cannot-connect-to-db']. ':<br />'. mysqli_connect_error () .' ('. mysqli_connect_errno () .')' ); } catch (AeMySQLTooOldException $e){ hb (e2l_get_string ('er--dbs-version-too-old', [ 'dbs' => $_db['software'], 'v1' => $_db['version'], 'v2' => $_db['version-minimum'], ])); } catch (AeMySQLException $e){ hb ($_strings['er--cannot-find-db'] .' '. $databaseConfiguration->name); } if (!$lr){ q1 (kq ('e2m_database')); } $settings['db']=$databaseConfiguration -> getDatabaseParamsArray (); if (!@e3 (USER_DIR . 'settings.json',json_encode ($settings,E2_JSON_STYLE))) { hb ($_strings['er--settings-not-saved'],E2E_PERMISSIONS_ERROR); q1 (kq ('e2m_database')); } e2_drop_all_kinds_of_cache (); if (!$_config['retain_search_indexes_on_db_switch']) { $ar = rd (cl ()); try { $ar -> erase (); } catch (\S2\Rose\Exception\RuntimeException $e){ if(Log::$a)__log ('Rose not available'); } ad (USER_DIR); } vv (kq ('e2s_bsi_step')); q1 (kq ('e2m_settings')); } function gs () { return class_exists ('ZipArchive'); } function e2m_get_backup () { if (gs ()) { $ccv = new ZipArchive (); $vcv = USER_DIR . BACKUP_DIRNAME .'backup.zip'; if ($ccv -> open ($vcv,ZIPARCHIVE::CREATE)) { @ $ccv -> addEmptyDir ('backup'); $bcv = USER_DIR . BACKUP_DIRNAME .'backup-tail.sql'; $ycv = ''; $ncv = -1; foreach(glob (USER_DIR . BACKUP_DIRNAME .'backup-*.sql') as $n2){ if ($n2 === $bcv) continue; $mcv = stat ($n2); if ($mcv['ctime']>$ncv)$ycv = $n2; $ncv = $mcv['ctime']; } if ($ycv === ''){ $ycv = xm (cl ()); } $ccv -> addFile ($ycv,'backup/'. basename ($ycv)); if(is_file ($bcv)) { @file_put_contents ($bcv,"COMMIT;\r\n\r\n",FILE_APPEND | LOCK_EX); @chmod ($bcv,E2_NEW_FILES_RIGHTS); } $ccv -> addFile ($bcv,'backup/backup-tail.sql'); $ccv -> close (); } if(is_file ($vcv)) { header ('Content-Type: application/zip'); header ('Content-Disposition: attachment; filename="backup.zip"'); readfile ($vcv); unlink ($vcv); } else { die ('Cannot get backup'); } die; } else { die ('Cannot get backup'); } } function ws ($yp){ if ( !array_key_exists ('appearance',$yp) or !array_key_exists ('notes_per_page',$yp['appearance']) or !is_numeric ($yp['appearance']['notes_per_page']) or $yp['appearance']['notes_per_page']<1 ) { $yp['appearance']['notes_per_page']=DEFAULT_ITEMS_PER_PAGE; } if ($yp['appearance']['notes_per_page']>MAX_ITEMS_PER_PAGE){ $yp['appearance']['notes_per_page']=MAX_ITEMS_PER_PAGE; } if ( !array_key_exists ('comments',$yp) or !array_key_exists ('default_on',$yp['comments']) ) { $yp['comments']['default_on']=false; } if (!array_key_exists ('respond_to_dark_mode',$yp['appearance'])) { $yp['appearance']['respond_to_dark_mode']=true; } if ( !array_key_exists ('template',$yp) or (string)$yp['template']==='' ) { $yp['template']=DEFAULT_TEMPLATE; } if (isset ($yp['description'])) { if (!isset ($yp['blog_subtitle'])) { $yp['blog_subtitle']=$yp['description']; } unset ($yp['description']); } if (isset ($yp['site_title'])) { if (!isset ($yp['blog_title'])) { $yp['blog_title']=$yp['site_title']; } unset ($yp['site_title']); } if (isset ($yp['user'])) { if (!isset ($yp['author_email'])) { $yp['author_email'] = (string) @$yp['user']['email']; } unset ($yp['user']); } if (isset ($yp['v3223_rss_permalinks_before_stamp'])) { unset ($yp['v3223_rss_permalinks_before_stamp']); } return $yp; } function e2j_save_menu_order () { global$settings; $bl = ['success' => false]; if(is_array (@$_POST['order'])) { $settings['menu_order']=$_POST['order']; if (@e3 (USER_DIR . 'settings.json',json_encode ($settings,E2_JSON_STYLE))) { $bl = ['success' => true]; } } $bl = json_encode ($bl); die ($bl); } function us ($v3){ global$_config; $dcv = $_config['share_to']; $scv = '|twitter|facebook|vkontakte|telegram|linkedin|whatsapp|'; if (@$_config['share_to_twitter_via']) { $lb['twitter']['via']=$_config['share_to_twitter_via']; } if(count ($v3)>0){ $acv = $v3[0]; $scv .= 'pinterest|'; $lb['pinterest']['media']=$acv; } $qcv = []; foreach(explode (',',$dcv) as $lcv){ $lcv = trim ($lcv); if ($lcv == 'vk')$lcv = 'vkontakte'; if(strstr ($scv,'|'. $lcv. '|')) { $qcv[$lcv]['share?']=true; if(is_array (@$lb[$lcv]) and count ($lb[$lcv])) { $qcv[$lcv]['data']=$lb[$lcv]; } } } return $qcv; } function is ($zcv,$lb = null){ if ($zcv === 'generic'){ $kcv = $lb; } else { if (!is_file ($xcv = SYSTEM_DIR . 'stubs/' . $zcv .'.php')) { throw new AeStubException ('No stub found for the problem "'. $zcv .'"'); } $kcv = include $xcv; } $ecv = false; if (!empty ($kcv['button'])) { $ecv = true; $rcv = kq ('e2m_frontpage', ['page' => 1]); $tcv = $kcv['button']; } $cb = [ 'stub-kind' => $zcv, 'title' => $kcv['heading'], 'heading' => $kcv['heading'], 'stub' => $kcv['text'], ]; if ($ecv)$cb += [ 'stub-button-href' => $rcv, 'stub-button-text' => $tcv ]; return $cb; } function e2m_tags () { global$_strings; AeMainMenuManager :: $isTagsCurrent = true; $cb['title']=$_strings['pt--tags']; $cb['heading']=$_strings['pt--tags']; $cb['tags']=ma ([]); $n8 = fa (true); if ($n8 === null){ $cb['unavailable?']=true; } else { $cb['tags']['each']=$n8; if(count ($n8)==0){ $cb['nothing']=$_strings['gs--no-tags']; } } return $cb; } function e2m_tag ($parameters = []) { global $settings, $_config, $_strings; if(Log::$a)__log ('Tag {'); $rn = vs (); $tagNotesView = new AePageableNotesView ('e2m_tag',$parameters); $tagNotesView -> setPortionSize ($settings['appearance']['notes_per_page']); $tagNotesView -> setNextPrevPageTitles ($_strings['gs--earlier'],$_strings['gs--later']); $tagNotesView -> setWantPaging (true); $tagNotesView -> setWantNewCommentsCount ($rn); $tagNotesView -> setWantReadHrefs ($_config['count_reads']); $tagNotesView -> setWantControls ($rn and !@$_config['read_only']); $tagNotesView -> setWantHiddenTags ($rn); if(array_key_exists ('*tags',$parameters)) { $jcv = $parameters['*tags']; } elseif(array_key_exists ('*tag',$parameters)) { $jcv = [$parameters['*tag']]; } else { $jcv = []; } $xb = []; foreach ($jcv as $tb){ if ($rn or $tb['IsVisible']) { $xb[] = $tb; } } $hcv = count ($xb); if ($hcv == 0 or $hcv < count ($jcv)) { return e2m_error404 (); } foreach ($xb as $tb) if ($tb)$gcv[] = "nk.`KeywordID`=". $tb['ID']; $tu = ( "FROM `". $_config['db_table_prefix'] ."Notes` n ". "JOIN `". $_config['db_table_prefix'] ."NotesKeywords` nk ". "ON nk.`NoteID` = n.`ID` ". "WHERE n.`SubsetID`=". $_config['db_table_subset'] ." ". "AND nk.`SubsetID`=". $_config['db_table_subset'] ." ". "AND (". implode (" OR ",$gcv).") ". "AND IsPublished=1 ". mf ($rn). "GROUP BY n.`ID` ". "HAVING COUNT(*)>=". $hcv ); $tagNotesView -> setSQLCountRequest ( "SELECT COUNT(*) Total FROM (SELECT 1 ". $tu .") _" ); $tagNotesView -> setLimitlessSQLRequest ( "SELECT n.*, COUNT(*) ". $tu ." ". "ORDER BY n.`Stamp` DESC" ); $wcv = []; foreach ($xb as $tb){ $wcv[] = $tb['Keyword']; if ($hcv === 1){ AeMainMenuManager :: addCurrentTag ($tb['Keyword']); } else { AeMainMenuManager :: addParentTag ($tb['Keyword']); } } $tagNotesView -> setHighlightedTags ($wcv); $jl = ''; $s5['description']=''; $s5['summary']=''; $s5['visible?']=true; foreach ($xb as $tb) if (!$tb['IsVisible']) { $s5['visible?']=false; break; } if ($hcv === 1){ $ucv = $xb[0]; $icv = b () ['t'. $ucv['ID']]; if(CACHE_TAG and $tagNotesView -> isFirstPage ()) { if ($rn){ $tagNotesView -> setCacheFilename (e2_cache_filename_with_id_($ucv['ID'],USER_DIR . CACHE_FILENAMES_TAG_AUTHOR)); } else { $tagNotesView -> setCacheFilename (e2_cache_filename_with_id_($ucv['ID'],USER_DIR . CACHE_FILENAMES_TAG)); } } $u0 = ya ($ucv['ID'],5); if ($rn){ $s5['edit-href']=kq ( 'e2m_tag_edit', ['tag-alias' => $icv] ); $ocv = (bool)$ucv['IsFavourite']; $pcv = $parameters; $pcv['flag']='IsFavourite'; $pcv['value'] = (int) !$ocv; $s5['pinned?']=false; } if ((string)$ucv['Description']!==''){ $dd = qy ($ucv['Description'],'full'); $i1 = $dd['text-final']; $s5['description']=$i1; $s5['description-format-info']=$dd['meta']; y2 (@$dd['meta']['links-required']); } if ((string)$ucv['Summary']!==''){ $s5['summary']=dy (htmlspecialchars ($ucv['Summary'],ENT_NOQUOTES,'UTF-8')); } elseif ((string)$s5['description']!==''){ $s5['summary']=yf ($s5['description']); }; $cvv = kq ('e2m_tag_rss', ['tag-alias' => $icv]); $vvv = kq ('e2m_tag_json', ['tag-alias' => $icv]); d3 ( 'rss', ev () .': '. $ucv['Keyword'], $cvv ); d3 ( 'json', ev () .': '. $ucv['Keyword'], $vvv ); $s5['og-images']=t3 ( l2 ( @$s5['description-format-info']['resources-detected'], g3 ('tag',$ucv['ID']) ) ); $s5['name']=htmlspecialchars ($ucv['Keyword'],ENT_COMPAT,'UTF-8'); $s5['related']=$u0; $jl = htmlspecialchars ($ucv['PageTitle'],ENT_COMPAT,'UTF-8'); } $r2 = $tagNotesView -> getTotalNotes (); $s5['notes-count']=$r2; $s5['notes-count-text']=e2l_get_string ('pt--n-posts', ['number' => $r2]); $bvv = $s5['notes-count-text'] .' '. $_strings['gs--tagged']; $yvv = []; foreach ($xb as $q3){ $yvv[] = htmlspecialchars ($q3['Keyword'],ENT_COMPAT,'UTF-8'); } $yvv = implode (', ',$yvv); if ((string)$jl !== ''){ $ns = $jl; $ms = $jl; } else { $ns = ev () .': '. $bvv .' '. $yvv; if ($hcv > 1){ $ms = $_strings['pt--tags'] .': '. $yvv; } else { $ms = $_strings['pt--tag'] .': '. $yvv; } } if($parameters['page']>1){ $ns .= ' ('. $_strings['gs--page'] .' '. $parameters['page'] .')'; } $s3 = ma ($parameters); $cb = [ 'title' => $ns, 'heading' => htmlspecialchars_decode ($ms,ENT_COMPAT), 'notes' => $tagNotesView -> getNotesCTree (), 'pages' => $tagNotesView -> getPagesCTree (), 'tag' => $s5, 'tags' => $s3, ]; if ( !$tagNotesView -> isExistingPage () and !$tagNotesView -> isFirstPageOfEmptyView () ) { return e2m_error404 (); } if ( $tagNotesView -> isFirstPageOfEmptyView () and !$rn ) { return e2m_error404 (); } if($tagNotesView -> isFirstPageOfEmptyView ()) { $cb['nothing']=$_strings['gs--no-such-notes']; } if ((string)$s5['summary']!==''){ $cb['summary']=$s5['summary']; } if ($hcv == 1){ if (vs ()) { $cb['related-edit-href']=$s5['edit-href']; $cb['related-edit-title']=$_strings['tt--edit-tag']; } } if(Log::$a)__log ('} // Tag'); return $cb; } function e2m_tag_edit ($parameters = []) { global$_strings; if(array_key_exists ('*tag',$parameters)) { $tb = $parameters['*tag']; } if (!@$tb) return e2m_error404 (); AeMainMenuManager :: addParentTag ($tb['Keyword']); $ib = sy ( 'neasden',$tb['Description'],'full' ); $pb = @unserialize ( $tb['Uploads'] ) or $pb = []; $l8 = k2 ( a2 ( l2 ( $ib,$pb ) ) ); i3 ( 'Keywords', $tb, $ib ); $kz = vy (); $nvv = htmlspecialchars ($tb['Keyword'],ENT_COMPAT,'UTF-8'); $mvv = b () ['t'. $tb['ID']]; $fvv = [ 'enabled?' => by ($kz), 'each' => $l8, 'default-name' => htmlspecialchars ($mvv,ENT_COMPAT,'UTF-8'), 'upload-action' => kq ('e2j_file_upload'), 'remove-action' => kq ('e2j_file_remove'), ]; $dvv = [ '.tag-id' => $tb['ID'], '.formatter-id' => 'neasden', 'form-action' => kq ('e2s_tag_edit'), 'submit-text' => $_strings['fb--save-changes'], 'tag-dotted' => la ($tb), 'page-title' => htmlspecialchars ($tb['PageTitle'],ENT_COMPAT,'UTF-8'), 'page-title-placeholder' => htmlspecialchars ($tb['Keyword'],ENT_COMPAT,'UTF-8'), 'alias' => htmlspecialchars ($mvv,ENT_COMPAT,'UTF-8'), 'description' => htmlspecialchars ($tb['Description'],ENT_COMPAT,'UTF-8'), 'summary' => (string)$tb['Summary'], 'favourite?' => (bool)$tb['IsFavourite'], 'space-usage' => yy ($kz), ]; $cb = [ 'body-uploads-enabled?' => by ($kz), 'title' => $_strings['pt--tag-edit'] .': '. $tb['Keyword'], 'heading' => $_strings['pt--tag-edit'], 'form' => 'form-tag', 'form-tag' => $dvv, 'uploads' => $fvv, 'related-delete-href' => kq ('e2m_tag_delete', ['*tag' => $tb]), ]; return $cb; } function e2s_tag_flag_ajax ($parameters){ j1 ([ 'flag-name' => 'tag', 'candy-name' => 'e2s_tag_flag_ajax', 'parameters' => $parameters, 'flipping-function' => function () use ($parameters){ os ($parameters); }, 'redirect-candy' => 'e2m_tag', ]); } function os ($parameters){ if($_SERVER['REQUEST_METHOD']!='POST'){ q1 (kq ('e2m_tag',$parameters)); } ud (); if(array_key_exists ('*tag',$parameters)) { $tb = $parameters['*tag']; } if (!$tb) throw new AeException ('Tag record not cound from parameters'); e2_drop_caches_for_tag_($tb['ID']); nm ( cl (), 'Keywords', [ 'ID' => $tb['ID'], $parameters['flag'] => (int) ($parameters['value']==1), ] ); } function e2m_tag_delete ($parameters = []) { global$_strings; if(array_key_exists ('*tag',$parameters)) { $svv = $parameters['*tag']; } if (!$svv) return e2m_error404 (); $avv = [ '.tag-id' => $svv['ID'], 'caution-text' => e2l_get_string ('gs--tag-will-be-deleted-notes-remain', [ 'tag' => htmlspecialchars ($svv['Keyword'],ENT_COMPAT,'UTF-8') ]), 'tag' => htmlspecialchars ($svv['Keyword'],ENT_COMPAT,'UTF-8'), 'form-action' => kq ('e2s_tag_delete'), 'submit-text' => $_strings['fb--delete'], ]; $cb = [ 'title' => $_strings['pt--tag-delete'] .': '. $svv['Keyword'], 'heading' => $_strings['pt--tag-delete'], 'form' => 'form-tag-delete', 'form-tag-delete' => $avv, ]; return $cb; } function e2m_untagged ($parameters = []) { global$settings,$_strings,$_config; $rn = vs (); $untaggedView = new AePageableNotesView ('e2m_untagged',$parameters); $untaggedView -> setPortionSize ($settings['appearance']['notes_per_page']); $untaggedView -> setNextPrevPageTitles ($_strings['gs--earlier'],$_strings['gs--later']); $untaggedView -> setWantPaging (true); $untaggedView -> setWantNewCommentsCount ($rn); $untaggedView -> setWantReadHrefs ($_config['count_reads']); $untaggedView -> setWantControls ($rn and !@$_config['read_only']); $untaggedView -> setWantHiddenTags ($rn); $tu = ( "FROM `". $_config['db_table_prefix']."Notes` n ". "LEFT OUTER JOIN `". $_config['db_table_prefix']."NotesKeywords` nk ". "ON nk.`NoteID` = n.`ID` ". "WHERE n.`SubsetID`=". $_config['db_table_subset'] ." ". "AND n.`IsPublished`=1 ". "AND nk.`SubsetID` IS NULL ". mf ($rn) ); $untaggedView -> setSQLCountRequest ( "SELECT COUNT(*) Total ". $tu ); $untaggedView -> setLimitlessSQLRequest ( "SELECT n.* ". $tu ." ORDER BY n.`Stamp` DESC" ); $ns = $_strings['pt--posts-without-tags']; if($parameters['page']>1){ $ns .= ' ('. $_strings['gs--page'] .' '. $parameters['page'] .')'; } $cb = [ 'title' => $ns, 'heading' => $_strings['pt--posts-without-tags'], 'notes' => $untaggedView -> getNotesCTree (), 'pages' => $untaggedView -> getPagesCTree (), ]; if($untaggedView -> isFirstPageOfEmptyView ()) { $cb['nothing']=$_strings['gs--no-posts-without-tags']; } elseif (!$untaggedView -> isExistingPage ()) { return e2m_error404 (); } return $cb; } function e2s_tag_edit () { global$_strings,$_config; ud (); $bs = $s8 = $i1 = $xg = ''; if(array_key_exists ('tag-id',$_POST)) $bs = $_POST['tag-id']; if(array_key_exists ('tag',$_POST)) $s8 = $_POST['tag']; if(array_key_exists ('page-title',$_POST)) $jl = trim ($_POST['page-title'],"\r\n"); if(array_key_exists ('description',$_POST)) $i1 = trim ($_POST['description'],"\r\n"); if(array_key_exists ('summary',$_POST)) $dg = trim ($_POST['summary'],"\r\n"); if(array_key_exists ('urlname',$_POST)) $xg = trim ($_POST['urlname'],"\r\n"); list ($hv,$qvv)=za ($s8); $lvv = 0; $zvv = 1; fm ( "SELECT * FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID` = ".((int)$bs)."", 'get tag record to update' ); $xvv = sm (); if(count ($xvv)!=1) die; $tb = $xvv[0]; fm ( "SELECT * FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `Keyword` = '". am ($hv) ."' ". "AND (`ID` != ".((int)$bs).")", 'make sure new tag name does not conflict with existing ones' ); $xvv = sm (); if(count ($xvv)==0){ if ($zvv != $lvv){ cb (); } e2_drop_caches_for_tag_($bs); if ($hv === ''){ $hv = $tb['Keyword']; hb ($_strings['er--tag-must-have-name'],E2E_USER_ERROR); } $tb['ID'] = ((int)$bs); $tb['Keyword']=$hv; $tb['PageTitle']=$jl; $tb['Description']=$i1; $tb['Summary']=$dg; $tb['IsVisible']=$qvv; $ib = sy ( 'neasden',$tb['Description'],'full' ); if(count ($ib)>0){ j2 ($ib); h2 ($ib); } $databaseConfiguration = cl (); nm ($databaseConfiguration,'Keywords',$tb); $xy = d ( USER_DIR,$databaseConfiguration, 'set','t',$tb['ID'],$xg ); q1 (kq ('e2m_tag', ['tag-alias' => $xy])); } else { hb ($_strings['er--cannot-rename-tag'],E2E_USER_ERROR); l1 (); } die; } function e2s_tag_delete () { global$_config; ud (); $bs = ((int)$_POST['tag-id']); cb (); e2_drop_caches_for_tag_($bs); fm ( "DELETE FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID`=". $bs, 'delete note by ID' ); fm ( "DELETE FROM `". $_config['db_table_prefix']."Aliases` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `EntityType` = 't' ". "AND `EntityID` = ". ((int)$bs), 'delete aliases after deleting note' ); fm ( "DELETE FROM `". $_config['db_table_prefix']."NotesKeywords` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `KeywordID`=". $bs, 'delete tag bindings after deleting tag' ); q1 (kq ('e2m_tags')); } function ps () { global$settings,$_config; $evv = null; if(CACHE_FAVTAGS and is_file (USER_DIR . CACHE_FILENAME_FAVTAGS)) { $evv = @unserialize (file_get_contents (USER_DIR . CACHE_FILENAME_FAVTAGS)); } $rn = vs (); if (!is_array ($evv)) { try { fm ( "SELECT * FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsFavourite`=1 ORDER BY `Keyword`", 'get favorite tags for tags menu' ); $rvv = sm (); $evv = []; foreach ($rvv as $tb){ if (!$tb['IsVisible']) continue; $va['sort-id']='t'. $tb['ID']; $va['tag']=htmlspecialchars ($tb['Keyword'],ENT_NOQUOTES,'UTF-8'); $va['title']=jd ($va['tag']); $va['href']=kq ( 'e2m_tag', ['*tag' => $tb] ); $va['visible?'] = (bool)$tb['IsVisible']; $va['current?']=false; $va['parent?']=false; $evv[] = $va; } if(CACHE_FAVTAGS)e3 (USER_DIR . CACHE_FILENAME_FAVTAGS,serialize ($evv)); } catch (AeMySQLException $e){ v3 ($e); if(Log::$a)__log ('Count not get tags menu from database'); } } if (!is_array ($evv)) return null; foreach ($evv as $a3 => $q3){ if (!$rn and !$evv[$a3]['visible?']) { unset ($evv[$a3]); continue; } $evv[$a3]['parent?'] = ( AeMainMenuManager :: isParentTag ($evv[$a3]['tag']) ); $evv[$a3]['current?'] = ( AeMainMenuManager :: isCurrentTag ($evv[$a3]['tag']) ); } if(is_array (@$settings['menu_order'])) { $wf = array_flip ($settings['menu_order']); usort ($evv, function ($b5,$y5) use ($wf){ $n5 = @$wf[$b5['sort-id']]; $m5 = @$wf[$y5['sort-id']]; if ($n5 === false)$n5 = count ($wf); if ($m5 === false)$m5 = count ($wf); return $n5 - $m5; }); } return $evv; } function ca ($note_id){ global$_config; $xb = []; fm ( "SELECT k.* ". "FROM `". $_config['db_table_prefix']."Keywords` k, ". "`". $_config['db_table_prefix']."NotesKeywords` nk ". "WHERE k.`SubsetID`=". $_config['db_table_subset'] ." ". "AND nk.`SubsetID`=". $_config['db_table_subset'] ." ". "AND nk.`NoteID`=". ((int)$note_id) ." ". "AND k.`ID`=nk.`KeywordID` ". "ORDER BY `Keyword`", 'get tag records for note by id' ); $xb = sm (); return $xb; } function va ($databaseConfiguration,$note_id,$se){ ba ($databaseConfiguration, ['NoteID' => $note_id]); foreach ($se as $s8){ list ($hv,$qvv)=za ( $s8 ); if ($hv === '') continue; $cj = da ($databaseConfiguration,$hv); if (!$cj){ @unlink (USER_DIR . CACHE_FILENAME_TAGS); @unlink (USER_DIR . CACHE_FILENAME_TAGS_FULL); @unlink (USER_DIR . CACHE_FILENAME_TAGS_AUTHOR); @unlink (USER_DIR . CACHE_FILENAME_TAGS_AUTHOR_FULL); b (true); $cj['ID']=na ( $databaseConfiguration,$hv,$qvv ); } dm ($databaseConfiguration, "INSERT INTO `". $databaseConfiguration -> getPrefix () . "NotesKeywords` ". "(`SubsetID`, `NoteID`, `KeywordID`) ". "VALUES (". ((int)$databaseConfiguration -> getSubset ()) .", ". ((int)$note_id) .", ". ((int)$cj['ID']). ")", 'add new tag bindings' ); } } function ba ($databaseConfiguration,$tvv){ $jvv = []; foreach ([ 'ID', 'NoteID', 'KeywordID', ] as $x) if(array_key_exists ($x,$tvv)) { $kj[] = '`'. $x .'`'."='". am ($tvv[$x]) ."'"; if ($x == 'ID')$hvv = 'tagbinging-id'; if ($x == 'NoteID')$hvv = 'tagbinging-note-id'; if ($x == 'KeywordID')$hvv = 'tagbinging-tag-id'; $jvv[$hvv]=$tvv[$x]; } $l2 = ( "DELETE FROM `". $databaseConfiguration -> getPrefix () . "NotesKeywords` ". "WHERE `SubsetID`=". $databaseConfiguration -> getSubset () ." ". "AND ". implode (' AND ',$kj) ); dm ($databaseConfiguration,$l2); } function ya ($bs,$gvv){ global$_config; fm ( "SELECT `ID`, `Keyword`, `OriginalAlias` ". "FROM `". $_config['db_table_prefix'] ."Keywords` k ". "WHERE k.`SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsVisible` = 1 ". "AND k.`ID` IN (". "SELECT `KeywordID` FROM (". "SELECT COUNT(`NoteID`) NotesCount, `KeywordID` ". "FROM `". $_config['db_table_prefix'] ."NotesKeywords` nk ". "WHERE nk.`SubsetID`=". $_config['db_table_subset'] ." ". "AND nk.`NoteID` IN (". "SELECT nk2.`NoteID` ". "FROM `". $_config['db_table_prefix'] ."NotesKeywords` nk2 ". "WHERE nk2.`SubsetID`=". $_config['db_table_subset'] ." ". "AND nk2.`KeywordID`=". $bs. ") ". "GROUP BY nk.`KeywordID` ". "HAVING NotesCount > 1 ". "ORDER BY NotesCount DESC ". "LIMIT 1, ". $gvv. ") k_ids". ")", 'find related tags' ); $u0 = []; foreach (sm () as $tb){ if ($tb['ID']===$bs) continue; $u0[] = [ 'name' => htmlspecialchars ($tb['Keyword'],ENT_NOQUOTES,'UTF-8'), 'href' => kq ('e2m_tag', ['*tag' => $tb]), 'visible?' => true, ]; } return $u0; } function na ( AeDatabaseConfiguration $databaseConfiguration,$hv,$qvv ){ $tb = [ 'Keyword' => $hv, 'OriginalAlias' => d ( USER_DIR,$databaseConfiguration, 'find','','',$hv ), 'Description' => '', 'IsVisible' => $qvv, ]; $tb = ym ($databaseConfiguration,'Keywords',$tb); $wvv = d ( USER_DIR,$databaseConfiguration, 'set','t',$tb['ID'],$hv ); if ($wvv != $tb['OriginalAlias']) { $tb['OriginalAlias']=$wvv; nm ($databaseConfiguration,'Keywords',$tb); } return $tb['ID']; } function ma ($parameters){ if (($uvv = fa ()) === null) return []; $s3['each']=$uvv; if(count ($s3['each']) > 0){ $s3['href']=kq ('e2m_tags'); } if (($ivv = ps ()) !== null){ $s3['menu-each']=$ivv; } return $s3; } function fa ($ovv = false){ global$_config; $rn = vs (); $gf = USER_DIR . CACHE_FILENAME_TAGS; if ($rn)$gf = USER_DIR . CACHE_FILENAME_TAGS_AUTHOR; if ($ovv){ $gf = USER_DIR . CACHE_FILENAME_TAGS_FULL; if ($rn)$gf = USER_DIR . CACHE_FILENAME_TAGS_AUTHOR_FULL; } $pvv = null; if(CACHE_TAGS and is_file ($gf)) { $pvv = @unserialize (file_get_contents ($gf)); } if (!is_array ($pvv)) { try { fm ( "SELECT * FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "ORDER BY `Keyword`", 'get all tags' ); $cbv = []; foreach (sm () as $tb){ $hv['id'] = (int)$tb['ID']; $hv['tag']=htmlspecialchars ($tb['Keyword'],ENT_NOQUOTES,'UTF-8'); $hv['tag-dotted']=la ($tb); $hv['favourite?'] = (bool)$tb['IsFavourite']; $hv['visible?'] = (bool)$tb['IsVisible']; $hv['notes-count']=0; $hv['last-used']=0; $hv['freshness']=0; $hv['weight']=0; if ($ovv){ $hv['href']=kq ('e2m_tag', ['*tag' => $tb]); } $cbv[$tb['ID']] = $hv; } fm ( "SELECT nk.KeywordID, COUNT(DISTINCT n.ID) as Count, max(n.Stamp) as LastUsed ". "FROM `". $_config['db_table_prefix']."NotesKeywords` nk, ". "`". $_config['db_table_prefix']."Notes` n ". "WHERE nk.`SubsetID`=". $_config['db_table_subset'] ." ". "AND n.`SubsetID`=". $_config['db_table_subset'] ." ". "AND n.`IsPublished` = 1 ". mf ($rn). "AND nk.`NoteID` = n.`ID` ". "GROUP BY nk.KeywordID", 'get tags ordering info' ); $vbv = 0; $bbv = 0; $ybv = 0; foreach (sm () as $nbv){ if (!isset ($cbv[$nbv['KeywordID']])) { unset ($cbv[$nbv['KeywordID']]); continue; } $va =& $cbv[$nbv['KeywordID']]; $va['notes-count']=$nbv['Count']; if (@$va['last-used']<$nbv['LastUsed']) { $va['last-used']=$nbv['LastUsed']; $mbv = (time () - $va['last-used']) / SECONDS_IN_A_YEAR; $va['freshness']=pow (1/2,$mbv); } $vbv = max ($vbv,$va['notes-count']); $bbv = max ($bbv,$va['freshness']); $ybv = max ($ybv,$va['notes-count']*$va['freshness']); } $pvv = []; foreach ($cbv as $rb => $q3){ if (!$rn and $q3['notes-count']==0) continue; if (!$rn and !$q3['visible?']) continue; $fbv = mb_strtolower ($q3['tag']); $pvv[$fbv]=$q3; if ($bbv != 0){ $pvv[$fbv]['freshness']=$q3['freshness']/$bbv; } else { $pvv[$fbv]['freshness']=0; } if ($ybv != 0){ $pvv[$fbv]['weight'] = ( $q3['freshness']*$q3['notes-count']/$ybv ); } else { $pvv[$fbv]['weight']=0; } if ($pvv[$fbv]['favourite?'])$pvv[$fbv]['weight']=1; } if(CACHE_TAGS)e3 ($gf,serialize ($pvv)); } catch (AeMySQLException $e){ v3 ($e); if(Log::$a)__log ('Could not get tags from database'); } } return $pvv; } function da (AeDatabaseConfiguration $databaseConfiguration,$svv){ dm ( $databaseConfiguration, "SELECT * FROM `". $databaseConfiguration -> getPrefix () . "Keywords` ". "WHERE `SubsetID`=". $databaseConfiguration -> getSubset () ." ". "AND `Keyword`='". am ($svv) ."'", 'get tag by name' ); $a3 = sm (); if (isset ($a3[0])) { return $a3[0]; } else { return null; } } function sa (AeDatabaseConfiguration $databaseConfiguration,$dbv){ dm ( $databaseConfiguration, "SELECT * FROM `". $databaseConfiguration -> getPrefix () . "Keywords` ". "WHERE `SubsetID`=". $databaseConfiguration -> getSubset () ." ". "AND `OriginalAlias`='".am ($dbv)."'", 'get tag by legacy urlname name' ); $zb = sm (); if (isset ($zb[0])) { return $zb[0]; } else { return null; } } function aa ($ly){ global$_config; fm ( "SELECT * FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID`='".((int)$ly)."'", 'get tag by id' ); $zb = sm (); if (isset ($zb[0])) { return $zb[0]; } else { return null; } } function e2_tagrecs_with_parameters_($parameters){ $sbv = []; if (@$parameters['tag-alias'] or $parameters['tag-alias']==='0'){ $sbv = explode (',',$parameters['tag-alias']); } $xb = []; foreach ($sbv as $dbv) if ($dbv or $dbv === '0'){ if ( $yg = f (@$dbv) and ($yg['type']=='t') and ($tb = aa ($yg['id'])) ) { $xb[] = $tb; } else { if ($abv = sa ( cl (), $dbv )) { $xb[] = $abv; } } } return $xb; } function la ($tb){ $qbv = htmlspecialchars ($tb['Keyword'],ENT_COMPAT,'UTF-8'); if (!$tb['IsVisible']) { $qbv = '.'. $qbv; } return $qbv; } function za ($qbv){ if (@$qbv[0]==='.'){ return [trim (substr ($qbv,1),". \t\n\r\0\x0B"),false]; } else { return [$qbv,true]; } } function ka ($vf){ $oj = b1 ('H',$vf); if ($oj <= 4) return 4; elseif ($oj <= 10) return 1; elseif ($oj <= 16) return 2; elseif ($oj <= 22) return 3; else return 4; } function xa ($lbv,$zbv = null){ global$_strings; if ($zbv === null)$zbv = ia (); $qd = time (); $kbv = v1 ('d.m.Y',$qd,$zbv); $xbv = v1 ('d.m.Y',$lbv,$zbv); $ebv = SECONDS_IN_A_MINUTE; $rbv = SECONDS_IN_AN_HOUR; $tbv = ka ($qd); $jbv = ka ($lbv); $hbv = $qd - $lbv; if ($hbv < 0) return$_strings['tt--from-the-future']; if ($hbv >= 0 and $hbv < 54) return$_strings['tt--just-now']; if ($hbv >= 54 and $hbv < 108) return$_strings['tt--one-minute-ago']; $gbv = $hbv + 12; $wbv = floor ($gbv / $ebv); if ($hbv >= 108 and $hbv < 54*$ebv) return e2l_get_string ( 'tt--minutes-ago', array ('minutes' => $wbv) ); if ($hbv >= 54*$ebv and $hbv < 108*$ebv) return$_strings['tt--one-hour-ago']; $gbv = $hbv + 12*$ebv; $ubv = floor ($gbv / $rbv); if ($hbv >= 108*$ebv and $hbv < 4*$rbv) return e2l_get_string ( 'tt--hours-ago', array ('hours' => $ubv) ); $l = v1 ('G:i',$lbv,$zbv); if ($hbv >= 4*$rbv and $tbv > $jbv and $kbv == $xbv){ return$_strings['tt--today']; } if ((($qd - $lbv) <= 7884000)) { return e2l_get_string ( 'tt--date', array ( 'day' => v1 ('j',$lbv,$zbv), 'month' => v1 ('m',$lbv,$zbv), ) ); } return v1 ('Y',$lbv,$zbv); } function ea ($lbv,$zbv = null){ global$_strings; $hbv = time () - $lbv; if ($hbv < 0) return$_strings['tt--from-the-future']; if ($hbv == 0) return$_strings['tt--now']; $ibv = array ( array (1,'tt--seconds-short'), array (SECONDS_IN_A_MINUTE,'tt--minutes-short'), array (SECONDS_IN_AN_HOUR,'tt--hours-short'), array (SECONDS_IN_A_DAY,'tt--days-short'), array (SECONDS_IN_A_MONTH,'tt--months-short'), array (SECONDS_IN_A_YEAR,'tt--years-short'), array (SECONDS_IN_A_YEAR + SECONDS_IN_A_MONTH,''), ); for ($rb = 0; $rb < count ($ibv); ++ $rb){ if ($hbv >= $ibv[$rb][0] and $hbv < $ibv[$rb + 1][0]) { return e2l_get_string ( $ibv[$rb][1], array ('value' => floor ($hbv / $ibv[$rb][0])) ); } } if ($zbv === null)$zbv = ia (); return v1 ('Y',$lbv,$zbv); } function e2m_timezone () { global$_strings,$settings; $obv = array ( 'form-action' => kq ('e2s_select_timezone'), 'submit-text' => $_strings['fb--select'], 'timezone-selector' => ha ($settings['timezone']['offset'],1), 'dst?' => $settings['timezone']['is_dst'], ); return array ( 'title' => $_strings['pt--default-timezone'], 'heading' => $_strings['pt--default-timezone'], 'form' => 'form-timezone', 'form-timezone' => $obv, ); } function ra () { global$_strings; $pbv = array ( -720 => '', -660 => '', -600 => '', -540 => '', -480 => $_strings['tt--zone-pt'], -420 => $_strings['tt--zone-mt'], -360 => $_strings['tt--zone-ct'], -300 => $_strings['tt--zone-et'], -240 => '', -210 => '', -180 => '', -120 => '', -60 => '', 0 => $_strings['tt--zone-gmt'], 60 => $_strings['tt--zone-cet'], 120 => $_strings['tt--zone-eet'], 180 => '', 210 => '', 240 => $_strings['tt--zone-msk'], 270 => '', 300 => '', 330 => '', 345 => '', 360 => $_strings['tt--zone-ekt'], 390 => '', 420 => '', 480 => '', 540 => '', 570 => '', 600 => '', 660 => '', 720 => '', 780 => '', 840 => '', ); return $pbv; } function ta ($k3){ $pbv = ra (); return @$pbv[(int)$k3/SECONDS_IN_A_MINUTE]; } function ja ($k3){ $c3v = '+'; if ($k3 < 0)$c3v = '&ndash;'; $v3v = str_pad ((int) (abs ($k3)/3600),2,'0',STR_PAD_LEFT); $b3v = str_pad (abs ($k3)/60 % 60,2,'0',STR_PAD_LEFT); return 'GMT'. $c3v . $v3v .':'. $b3v; } function ha ($y3v,$n3v = ''){ global$_strings; $pbv = ra (); $cb = ''; if (!$n3v)$n3v = count ($pbv); $cb .= '<select class="e2-select" name="offset" size="'. $n3v .'">'; foreach ($pbv as $k3 => $m3v){ $f3v = ''; if ($k3 * SECONDS_IN_A_MINUTE == $y3v)$f3v = ' selected="selected"'; $cb .= '<option'. $f3v .' value="'.$k3.'">'; $c3v = ''; if ($k3 < 0)$c3v = '−'; if ($k3 > 0)$c3v = '+'; $v3v = (int) (abs ($k3 * SECONDS_IN_A_MINUTE)/3600); $b3v = (int) (abs ($k3 * SECONDS_IN_A_MINUTE)/60 % 60); if ($v3v){ $cb .= ( $c3v .' '. $v3v .' '. $_strings['gs--timezone-offset-hours'] .' '. ($b3v? ($b3v .' '. $_strings['gs--timezone-offset-minutes']) : '') ); if ($m3v){ $cb .= ' ('. $m3v. ')'; } } else { $cb .= $m3v; } $cb .= '</option>'; } $cb .= '</select>'; return $cb; } function ga ($gb){ global$settings; if($settings['timezone']===$gb) return true; $settings['timezone']=$gb; return @e3 (USER_DIR . 'settings.json',json_encode ($settings,E2_JSON_STYLE)); } function e2s_select_timezone () { global$_strings; ud (); if (@$_POST['offset'] >= -720 and @$_POST['offset'] <= 780){ $gb['offset'] = @$_POST['offset']*SECONDS_IN_A_MINUTE; $gb['is_dst'] = isset ($_POST['is_dst']); } if (ga ($gb)) { q1 (kq ('e2m_settings')); } else { hb ($_strings['er--settings-not-saved'],E2E_PERMISSIONS_ERROR); q1 (kq ('e2m_timezone')); } } function wa ($r){ return array ( 'offset' => (int)$r['Offset'], 'is_dst' => (bool)$r['IsDST'], ); } function ua () { return array ( 'offset' => 0, 'is_dst' => false, ); } function ia () { global$settings; if(array_key_exists ('timezone',$settings)) { return$settings['timezone']; } else { return ua (); } } function oa ($gb,$d3v){ if (@$gb['is_dst']) { $s3v = (int)date ('I',$d3v); $a3v = date ('Z',$d3v)-$s3v * SECONDS_IN_AN_HOUR; $q3v = $gb['offset']; $l3v = $q3v - $a3v; $z3v = date ('I',$d3v + $l3v); return $z3v; } else { return 0; } } function pa ($gb,$d3v){ if ($gb and is_array ($gb)) { return ( $gb['offset'] + oa ($gb,$d3v)*SECONDS_IN_AN_HOUR ); } } function c1 ($d3v){ return pa (ia (), $d3v); } function v1 ($k3v,$e4,$gb){ return gmdate ($k3v,$e4 + pa ($gb,$e4)); } function b1 ($k3v,$e4){ return v1 ($k3v,$e4,ia ()); } function y1 ($rm,$tm = false,$jm = false){ if(is_numeric ($jm)) { $x3v = gmmktime (0,0,0,$tm,$jm,$rm); $e3v = gmmktime (0,0,0,$tm,$jm + 1,$rm)-1; } elseif(is_numeric ($tm)) { $x3v = gmmktime (0,0,0,$tm,1,$rm); $e3v = gmmktime (0,0,0,$tm + 1,1,$rm)-1; } else { $x3v = gmmktime (0,0,0,1,1,$rm); $e3v = gmmktime (0,0,0,1,1,$rm + 1)-1; } return array ($x3v,$e3v); } function n1 ($gb,$rm,$tm = false,$jm = false){ list ($x3v,$e3v)=y1 ($rm,$tm,$jm); $x3v -= pa ($gb,$x3v); $e3v -= pa ($gb,$e3v); return array ($x3v,$e3v); } function m1 ($rm,$tm = false,$jm = false){ return n1 (ia (), $rm,$tm,$jm); } function f1 ($rm,$tm = false,$jm = false){ $r3v = 13; $t3v = -12; $r3v += 1; $t3v -= 1; list ($x3v,$e3v)=y1 ($rm,$tm,$jm); $x3v -= $r3v * 3600; $e3v -= $t3v * 3600; return array ($x3v,$e3v); } function d1 ($k3){ if ((int) @$k3 > 0) return (string)'+'.abs (@$k3); elseif ((int) @$k3 < 0) return (string)'-'.abs (@$k3); else return ''; } function s1 ($d3v,$j3v = ''){ $h3v = c1 ($d3v); $c3v = ($h3v >= 0)?'+':'-'; $h3v = abs ($h3v); $pj = $h3v % 60; $h3v -= $pj; $tm = $h3v % 3600 / 60; $h3v -= $tm * 60; $oj = $h3v / 3600; if ($oj < 10)$oj = '0'.$oj; if ($tm < 10)$tm = '0'.$tm; return $c3v.$oj.$j3v.$tm; } function a1 ($g3v){ global$settings; if(is_numeric ($g3v)) { $e3['offset']=SECONDS_IN_A_MINUTE * $g3v; $e3['is_dst']=false; $w3v = SECONDS_IN_A_MINUTE * $g3v - SECONDS_IN_AN_HOUR; $u3v = array ('offset' => $w3v,'is_dst' => true); $u3v = (int)pa ($u3v,time ()); if ($e3['offset']==$u3v){ $e3['offset']=$w3v; $e3['is_dst']=true; } } else { if(array_key_exists ('timezone',$settings)) { $e3 = $settings['timezone']; } else { $e3['offset']=0; $e3['is_dst']=false; } } return $e3; } function q1 ($c1 = ''){ global$errors; @session_start (); $_SESSION['errors']=$errors; if(substr ($c1,0,strlen (AeEnv::$i)+3)!=AeEnv::$i .'://'){ header ('Location: '. AeEnv::$o . $c1); } else { header ('Location: '. $c1); } flush (); die; } function l1 () { $i3v = (string) @$_SERVER['HTTP_REFERER']; q1 ($i3v); } function z1 ($or_ = ''){ $o3v = str_replace ('/','--', trim (AeEnv::$w .'/'.AeEnv::$u,'/') ); if ($o3v !== '')$o3v .= '-'; $url = AeEnv::$base_url; $qz = substr_count ($_SERVER['HTTP_HOST'],'.'); $cb = $o3v . @str_repeat ('_',$qz).$or_; return $cb; } function k1 ($or_,$cv = '',$p3v = true){ $cyv = $p3v? (time () + 3600 * 24 * 365) : (0); $nt = $_SERVER['HTTP_HOST']; $vyv = substr_count ($nt,'.'); if ($vyv < 3)$nt = str_repeat ('.',3 - $vyv).$nt; setcookie (z1 ($or_),$cv,$cyv,'/'); } function x1 ($byv,$pl,$yyv = ''){ if(trim ($pl)!=''){ $pl = explode ($byv,$pl); foreach ($pl as $rb => $a3)$pl[$rb]=trim ($a3); foreach ($pl as $rb => $a3) if ($a3 == '') unset ($pl[$rb]); $nyv = array_unique ($pl); if ('sort' == $yyv)sort ($nyv); return $nyv; } else return array (); } function e1 ($pl){ $zq = array (); if(is_file (SYSTEM_DEFAULTS_DIR . 'romanize.txt')) { $zq = file (SYSTEM_DEFAULTS_DIR . 'romanize.txt'); } $myv = $it = ''; foreach ($zq as $rb => $om){ if (!($rb%2))$myv .= rtrim ($om) .' '; else $it .= rtrim ($om) .' '; if ($rb%2){ while (mb_strlen ($it)<mb_strlen ($myv))$it .= ' '; while (mb_strlen ($it)>mb_strlen ($myv))$myv .= ' '; } } $fyv = ''; $dyv = -1; for ($rb = 0; $rb < mb_strlen ($myv); ++ $rb){ $fcv = mb_substr ($myv,$rb,1); if ($fcv != ' '){ $fyv .= $fcv; if ($dyv == -1)$dyv = $rb; } elseif ($fyv){ $syv = trim (mb_substr ($it,$dyv,mb_strpos ($it,' ',$dyv + 1)-$dyv)); $kb = array ($fyv,$syv); $ayv[mb_strlen ($fyv)][] = $kb; $fyv = ''; $dyv = -1; } } $qyv = array (); for ($rb = count ($ayv); $rb > 0; -- $rb){ foreach ($ayv[$rb] as $kb)$qyv[$kb[0]] = $kb[1]; } return strtr ($pl,$qyv); } function r1 ($b5,$y5,$lyv = 0){ if ($y5 == 0) return 0; $zyv = round ($b5 / $y5 * 100,$lyv); $kyv = pow (10, -$lyv); if ($b5 > 0 and $zyv == 0)$zyv = $kyv; if ($b5 < $y5 and $zyv == 100)$zyv = 100 - $kyv; return $zyv; } function t1 ($xyv,$action,$e4){ if (!is_array ($xyv))$xyv = array (); if($action == 'add'){ $xyv = array_unique (array_merge ($xyv,$e4)); } if($action == 'remove'){ unset ($xyv[array_search ($e4,$xyv)]); } if (!is_array ($xyv))$xyv = array (); return $xyv; } function j1 ($lb){ $parameters = $lb['parameters']; $bl = [ 'success' => false ]; $lb['flipping-function'] ($parameters); $eyv = $parameters; $eyv['value'] = !$parameters['value']; $bl = [ 'success' => true, 'data' => [ 'flag-now-on' => ($parameters['value']==1), 'new-href' => kq ($lb['candy-name'],$eyv), ] ]; if(array_key_exists ('result',$_POST) and ($_POST['result']=='ajaxresult')) { $bl = json_encode ($bl); die ($bl); } else { q1 (kq ($lb['redirect-candy'],$parameters)); } } function h1 ($pl){ $mo = @$_SERVER['HTTP_USER_AGENT'] or $mo = ''; $ryv = strstr ($mo,'iPhone') || strstr ($mo,'iPad'); $tyv = strstr ($mo,'Macintosh'); if ($ryv) return ''; if ($pl == 'submit'){ if ($tyv){ return '&#x2303; &#x21a9;'; } else { return 'Ctrl + Enter'; } } if ($pl == 'livesave'){ if ($tyv){ return '&#x2318; S'; } else { return 'Ctrl + S'; } } if ($pl == 'navigation'){ if ($tyv){ return '&#x2325;'; } else { return 'Ctrl'; } } if ($pl == 'navigation-later'){ if ($tyv){ return '&#x2325; &uarr;'; } else { return 'Ctrl + &uarr;'; } } if ($pl == 'navigation-earlier'){ if ($tyv){ return '&#x2325; &darr;'; } else { return 'Ctrl + &darr;'; } } } function g1 ($q1){ $q1 = str_replace ('<','&lt;',$q1); $q1 = str_replace ('>','&gt;',$q1); return $q1; } function w1 ($q1){ $q1 = str_replace ('"','&quot;',$q1); return $q1; } function u1 ($cv,$jyv){ return str_replace ('.',',',round ($cv,$jyv)); } function e2_stripslashes_array ($pd){ return is_array ($pd)?array_map ('e2_stripslashes_array',$pd):stripslashes ($pd); } function i1 () { if(version_compare (PHP_VERSION,'7.4') >= 0) return; if(get_magic_quotes_runtime ()) { set_magic_quotes_runtime (0); } if(get_magic_quotes_gpc ()) { $_GET = e2_stripslashes_array ($_GET); $_POST = e2_stripslashes_array ($_POST); $_COOKIE = e2_stripslashes_array ($_COOKIE); $_REQUEST = e2_stripslashes_array ($_REQUEST); } } function o1 ($oi){ return sprintf ('%u',ip2long ($oi)); } function p1 ($aa){ return long2ip (sprintf ('%d',$aa)); } function e2_decline_for_number ($q1,$aa = null){ $hyv = $q1; if ($aa === null){ $aa = substr ($q1,0,strpos ($q1,' ')); $hyv = substr ($q1,strpos ($q1,' ')+1); } $gyv = strpos ($hyv,'('); $wyv = strpos ($hyv,')'); if ($wyv > $gyv)$uyv = substr ($hyv,$gyv,$wyv - $gyv + 1); $iyv = explode (',',trim (@$uyv,'()')); if(count ($iyv)==2)array_unshift ($iyv,''); $oyv = array (2,0,1,1,1,2,2,2,2,2); if ($aa%100 > 10 and $aa%100 < 20)$pyv = 2; else $pyv = $oyv[$aa%10]; $d7 = $iyv[$pyv]; $q1 = str_replace ($uyv,$d7,$q1); if(strstr ($q1,'(') and strstr ($q1,')')) { return e2_decline_for_number ($q1,$aa); } else { return $q1; } } function cq ($cnv){ $oo = glob ($cnv,GLOB_NOSORT); if(is_array ($oo)) { foreach ($oo as $gd){ @unlink ($gd); } } } function vq ($yx){ $oo = glob ($yx .'*',GLOB_NOSORT); if(is_array ($oo)) { foreach ($oo as $gd){ if(basename ($gd)!='.' and basename ($gd)!='..'){ if(is_dir ($gd)) { if (vq ($gd .'/')) { if (!@rmdir ($gd)) { return false; } } else { return false; } } else { @unlink ($gd); } } } return true; } else { return false; } } function bq ($vnv){ $vnv = trim ($vnv,'/'); $vnv = explode ('/',$vnv); $yx = ''; foreach ($vnv as $vh){ $yx = $yx.$vh; if (!is_dir ($yx)) { if (@mkdir ($yx)) { @chmod ($yx,E2_NEW_FILES_RIGHTS); } else { return false; } } $yx = $yx.'/'; } return true; } function yq ($vnv){ return preg_replace ('/\/([^\/]+?)\/\.\./','',$vnv); } function nq ($pl){ $bnv = get_html_translation_table (HTML_ENTITIES); $bnv = array_flip ($bnv); return strtr ($pl,$bnv); } function mq ($ynv = NULL){ if(NULL == $ynv)$ynv = microtime (); list ($nnv,$hbv)=explode (' ',$ynv); return ((float)$nnv + (float)$hbv); } function _A ($q1){ global$_candy,$_current_url; if ( preg_match ('/\<a href\=\"(.*?)\"[^>]*\>(.*?)\<\/a\>/si',$q1,$me) and ( $me[1]==='' or $me[1]===$_current_url or AeEnv::$i .'://'. AeEnv::$server . $me[1]===$_current_url or AeEnv::$o . $me[1]===$_current_url or $_candy == 'e2m_install' ) ) { return $me[2]; } else { return $q1; } } function _AT ($y1){ global$_current_url; return ( $y1 === '' or $y1 === $_current_url or AeEnv::$i .'://'. AeEnv::$server . $y1 === $_current_url or AeEnv::$o . AeEnv::$u . $y1 === $_current_url ); } function _READS ($j3){ if (!empty ($j3['read-count'])) return $j3['read-count']; return AeNoteReadCountsProvider :: getReadCountForNoteID ($j3['id']); } function _IMGSRC ($gd){ return if_ ($gd); } function _SVG ($gd){ return of ($gd); } function _COLOR ($b,$y,$mnv,$fnv = 1){ if(strlen ($b)!=3 and strlen ($b)!=6) return 'f0f'; if(strlen ($y)!=3 and strlen ($y)!=6) return 'f0f'; if(strlen ($b)==3)$b = $b[0].$b[0].$b[1].$b[1].$b[2].$b[2]; if(strlen ($y)==3)$y = $y[0].$y[0].$y[1].$y[1].$y[2].$y[2]; $qj = array ( $b[0].$b[1],$b[2].$b[3],$b[4].$b[5], $y[0].$y[1],$y[2].$y[3],$y[4].$y[5], ); foreach ($qj as $a3 => $q3){ $qj[$a3]=hexdec ($q3); } $qt = array ( $qj[0]+pow ($mnv,$fnv) * ($qj[3]-$qj[0]), $qj[1]+pow ($mnv,$fnv) * ($qj[4]-$qj[1]), $qj[2]+pow ($mnv,$fnv) * ($qj[5]-$qj[2]), ); $dnv = ''; foreach ($qt as $a3 => $q3){ $dnv .= str_pad (dechex ($q3),2,'0',STR_PAD_LEFT); } return $dnv; } function _DT ($k3v,$snv){ if (!$snv) return ''; list ($vf,$gb)=$snv; $cb = $k3v; $xn = v1 ('m',$vf,$gb); $cb = str_replace ('{zone}',e2__escape_all (ja ($gb['offset'])), $cb); $cb = str_replace ('{month}',e2__escape_all (e2l_get_string ('um--month', array ('month' => $xn))), $cb); $cb = str_replace ('{month-short}',e2__escape_all (e2l_get_string ('um--month-short', array ('month' => $xn))), $cb); $cb = str_replace ('{month-g}',e2__escape_all (e2l_get_string ('um--month-g', array ('month' => $xn))), $cb); $cb = v1 ($cb,$vf,$gb); return $cb; } function _AGO ($snv){ return ea ($snv[0], array ('offset' => $snv[1]['offset'],'is_dst' => $snv[1]['is_dst']) ); } function _NUM ($q1){ return e2_decline_for_number ($q1); } function _CSS ($anv){ return hf ($anv); } function _CSS_HREF ($anv){ return pf ($anv); } function _JS ($qnv){ return gf ($qnv); } function _LIB ($pw){ return wf ($pw); } function _T ($hw){ echo tf ($hw); } function _T_DEFER ($name){ echo xf ($name); } function _X ($hw){ echo rf ($hw); } function _T_FOR ($hw,$lnv = null){ global$content; if ($lnv === null)$lnv = $hw; if(array_key_exists ($lnv,$content)) { echo tf ($hw); } else { echo ''; } } function _FIT ($hz,$gz){ } function _GUIDES ($znv = false){ global$_olba_guides; if(is_array ($znv))$_olba_guides = $znv; if (!is_array ($_olba_guides)) return; $knv = '<div style="position: fixed; width: 100%; height: 100%; z-index: -100">'; $xnv = 0; $env = $_olba_guides; $env[] = 100; foreach ($env as $rb => $rnv){ if ($rnv == 100) break; $xnv += $rnv; $knv .= '<div style="position: fixed; left: '. $rnv .'%; width: 0; height: 100%; border-left: 1px #000 dotted; opacity: .2; -webkit-opacity: .2; -moz-opacity: .2"></div>'; $tnv = 'position: absolute; padding: 2px 3px; top: 0; font-size: 9px; background: #ccc; color: #000; font-family: "Verdana", sans-serif; opacity: .8; -webkit-opacity: .8; -moz-opacity: .8'; if ($env[$rb+1]-$env[$rb]<4){ $knv .= '<div style="'. $tnv.'; right: '. (100 - $rnv) .'%; border-bottom-left-radius: .5em; -webkit-border-bottom-left-radius: .5em; -moz-border-bottom-left-radius: .5em;">'. $rnv .'%</div>'; } else { $knv .= '<div style="'. $tnv.'; left: '. $rnv .'%; border-bottom-right-radius: .5em; -webkit-border-bottom-right-radius: .5em; -moz-border-bottom-right-radius: .5em;">'. $rnv .'%</div>'; } } $knv .= '</div>'; $_olba_current_col = 0; return $knv; } function _S ($pl){ global$_strings; return$_strings[$pl]; } function _SHORTCUT ($name){ return h1 ($name); } function e2__escape_all ($pl){ $cb = ''; for ($rb = 0; $rb < mb_strlen ($pl); ++ $rb){ $cb .= '\\'. mb_substr ($pl,$rb,1); } return $cb; } function fq ($myv){ global$_db,$_instance_config,$_strings; $jnv = 'v'. $myv; $hnv = 'v'. E2_VERSION; $gnv = aq ($myv); $wnv = aq (E2_VERSION); if ($gnv === $wnv){ $gnv = $jnv; $wnv = $hnv; } else { $gnv .= ' ('. $jnv. ')'; $wnv .= ' ('. $hnv .')'; } $unv = aq (3239) .' (v3239)'; if (!$_instance_config['allow_update']) { return ['stub' => is ('update-disallowed')]; } if(E2_VERSION < $myv and !$_instance_config['dev_ignore_version_mismatch']) { return ['stub' => is ('generic', [ 'heading' => $_strings['pt--confused'], 'text' => '<p>'. e2l_get_string ('gs--downdate-explanation', [ 'dr' => $gnv, 'rr' => $wnv, ]) .'</p>', ])]; } if ($myv < 3239){ return ['stub' => is ('generic', [ 'heading' => $_strings['pt--multi-step-update'], 'text' => '<p>'. e2l_get_string ('gs--multi-step-update-p1', [ 'dr' => $gnv, 'rr' => $wnv, 'ur' => $unv, ]) .'</p>'.'<p>'. e2l_get_string ('gs--multi-step-update-p2', [ 'dr' => $gnv, 'rr' => $wnv, 'ur' => $unv, ]) .'</p>', ])]; } if (sq ()) { return ['stub' => is ('generic', [ 'heading' => $_strings['pt--updating'], 'text' => '<p>'. $_strings['gs--this-takes-seconds'] .'</p>', 'button' => $_strings['fb--retry'], ])]; } if($_instance_config['log_updates']) { Log::$a = true; if(Log::$a)sn ('update-$'); } if(Log::$a)__log ('Update from v'. $myv .' to v'. E2_VERSION.' {'); $inv = ($myv < 3601); $databaseConfigurationsToMigrate = []; try { if(Log::$a)__log ('Update instance'); if($_instance_config['db']!==null){ $instanceDatabaseConfiguration = new AeDatabaseConfiguration ( 'instance-config', INSTANCE_DIR . BACKUP_DIRNAME, $_instance_config['db']['server'], $_instance_config['db']['user_name'], $_instance_config['db']['passw'], $_instance_config['db']['name'], $_instance_config['db_table_prefix'] ); if($_instance_config['backup_before_update']) { xm ($instanceDatabaseConfiguration); } on ($instanceDatabaseConfiguration); if(Log::$a)__log ('Instance has migrateable database table set "'. $instanceDatabaseConfiguration -> getTablesKeyString (). '"'); $onv = (dq ($instanceDatabaseConfiguration)); $instanceDatabaseConfiguration -> setSubset ($onv); if(Log::$a)__log ('Will set subset '. $onv .' for subset-zero records'); $databaseConfigurationsToMigrate[ $instanceDatabaseConfiguration -> getTablesKeyString () ] = $instanceDatabaseConfiguration; } yn (); AeFileManager::forceInstanceDirectories (); $pnv = pq (); if(Log::$a)__log ('Update '. count ($pnv) .' users {'); $cq = []; foreach ($pnv as $bp){ $cmv = uq ($bp,$_instance_config['path_user']); $vmv = oq ($_instance_config,$cmv); $yp = e2_load_settings_from_user_folder_($bp); if(count ($bmv = AeFileManager::getPathsWithNoWritePermissions ( $vmv['path_user'],$vmv['path_media'] )) > 0){ $cq = array_merge ($cq,$bmv); continue; } if(Log::$a)__log ( 'User with key "'. $cmv .'" has path "'. $vmv['path_user'] .'", '. 'media path "'. $vmv['path_media'] .'"' ); $userDatabaseConfiguration = vl ( $vmv,$yp ); if ($vmv['backup_before_update']) { xm ($userDatabaseConfiguration); } on ($userDatabaseConfiguration); if(Log::$a)__log ( 'User has migrateable database configuration "'. $userDatabaseConfiguration. '"' ); $databaseConfigurationsToMigrate[ $userDatabaseConfiguration -> getTablesKeyString () ] = $userDatabaseConfiguration; AeFileManager::forceUserDirectories ($vmv['path_user']); AeFileManager::forceMediaDirectories ($vmv['path_media']); cq ($vmv['path_user'].CACHES_DIRNAME .'*'); if ($myv < 3354){ @rename ($vmv['path_media'].'pictures/userpics/',AVATARS_DIRNAME); @unlink ($vmv['path_user'] .'password-reset.txt'); } if ($myv < 3932){ @unlink ($vmv['path_user'] .'indexing.psa'); } foreach (p3 () as $jd){ if(is_file ($vmv['path_user'].$jd)) { rename ( $vmv['path_user'].$jd, $vmv['path_media'].USERPIC_DIRNAME . $jd ); } } if ($inv)ad ($vmv['path_user']); } if(count ($cq)>0){ return ['stub' => is ('generic', [ 'heading' => $_strings['pt--fix-permissions'], 'text' => ( '<p>'. $_strings['gs--fix-permissions'] .'</p>'. gb (array_unique ($cq)) ), 'button' => $_strings['fb--retry'], ])]; } if(Log::$a)__log ('}'); if(Log::$a)__log ('Migrate '. count ($databaseConfigurationsToMigrate) .' database table set(s), namely:'); $a3 = 0; foreach($databaseConfigurationsToMigrate as$databaseConfigurationToMigrate){ if(Log::$a)__log ((++ $a3) .'. "'. $databaseConfigurationToMigrate -> getTablesKeyString (). '"'); } $a3 = 0; foreach($databaseConfigurationsToMigrate as$databaseConfigurationToMigrate){ if(Log::$a)__log ('Prepage for migratation '. (++ $a3) .'/'. count ($databaseConfigurationsToMigrate) .':'); jn ($databaseConfigurationToMigrate); } $a3 = 0; foreach($databaseConfigurationsToMigrate as$databaseConfigurationToMigrate){ if(Log::$a)__log ('Migrate '. (++ $a3) .'/'. count ($databaseConfigurationsToMigrate) .':'); hn ($databaseConfigurationToMigrate); if ($inv){ hd ($databaseConfigurationToMigrate); } } } catch (AeMySQLCannotConnectException $e){ if(Log::$a)__log ('Aborting: cannot connect'); return ['stub' => is ('generic', [ 'heading' => $_strings['pt--update-cancelled'], 'text' => '<p>'. $_strings['er--cannot-connect-to-db'] .'</p>', ])]; } catch (AeMySQLNotFoundException $e){ if(Log::$a)__log ('Aborting: database not found'); return ['stub' => is ('generic', [ 'heading' => $_strings['pt--update-cancelled'], 'text' => '<p>'. $_strings['er--cannot-find-db'] .'</p>', ])]; } catch (AeMySQLTooOldException $e){ if(Log::$a)__log ('Aborting: '. $_db['software'] .' too old'); return ['stub' => is ('generic', [ 'heading' => $_strings['pt--update-cancelled'], 'text' => '<p>'. e2l_get_string ( 'gs--dbs-version-too-old', [ 'dbs' => $_db['software'], 'dbv' => $_db['version'], 'minmysql' => E2_MINIMUM_MYSQL, 'minmariadb' => E2_MINIMUM_MARIADB, 'aegearelease' => aq (E2_VERSION) ] ) .'</p>' ])]; } catch (AeMySQLNotMigrateableException $e){ if(Log::$a)__log ('Aborting: not migrateable'); return ['stub' => is ('generic', [ 'heading' => $_strings['pt--update-cancelled'], 'text' => '<p>'. $_strings['gs--update-db-incomplete'] .'</p>', ])]; } catch (AeMySQLNoDataException $e){ if(Log::$a)__log ('Aborting: no data in database'); return ['stub' => is ('generic', [ 'heading' => $_strings['pt--update-cancelled'], 'text' => '<p>'. $_strings['gs--update-db-no-data-configure-or-reinstall'] .'</p>', ])]; } finally { @unlink (INSTANCE_DIR .'updating.psa'); } $lx = bn (E2_VERSION); return [ 'status' => 'success', 'from-release' => $gnv, 'to-release' => $wnv, 'instance' => $lx, ]; } function dq (AeDatabaseConfiguration $databaseConfiguration){ $ymv = 0; foreach(AeModel::unprefixedCoreTablesNames () as $d2){ dm ( $databaseConfiguration, "SELECT MAX(`SubsetID`) MaxSubsetID ". "FROM `". $databaseConfiguration -> getPrefix () . $d2 ."`" ); $e3 = sm (); $ymv = max ($ymv,$e3[0]['MaxSubsetID']); } return $ymv + 1; } function sq () { $nmv = ini_get ('max_execution_time')+1; $mmv = @unserialize (file_get_contents (INSTANCE_DIR .'updating.psa')); if (!is_array ($mmv))$mmv = []; if ( isset ($mmv['locktime']) and $mmv['locktime'] >= time () - $nmv ) return true; $mmv['locktime']=time (); @e3 (INSTANCE_DIR .'updating.psa',serialize ($mmv)); return false; } function aq ($q3){ $name = '2.6 or earlier'; if ($q3 >= 3119)$name = '2.6'; if ($q3 >= 3201)$name = '2.7b'; if ($q3 >= 3225)$name = '2.7b2'; if ($q3 >= 3239)$name = '2.7'; if ($q3 >= 3254)$name = '2.8a'; if ($q3 >= 3335)$name = '2.8b'; if ($q3 >= 3354)$name = '2.8b2'; if ($q3 >= 3364)$name = '2.8'; if ($q3 >= 3382)$name = '2.8 SP1'; if ($q3 >= 3386)$name = '2.8 SP2'; if ($q3 >= 3445)$name = '2.9a2'; if ($q3 >= 3492)$name = '2.9a4'; if ($q3 >= 3520)$name = '2.9b'; if ($q3 >= 3543)$name = '2.9b2'; if ($q3 >= 3553)$name = '2.9'; if ($q3 >= 3559)$name = '2.9 SP1'; if ($q3 >= 3565)$name = '2.9 SP2'; if ($q3 >= 3572)$name = '2.9 SP3'; if ($q3 >= 3576)$name = '2.9 SP4'; if ($q3 >= 3733)$name = '2.10a'; if ($q3 >= 3753)$name = '2.10a2'; if ($q3 >= 3783)$name = '2.10a3'; if ($q3 >= 3788)$name = '2.10'; if ($q3 >= 3805)$name = '2.10 SP1'; if ($q3 >= 3820)$name = '2.10 SP2'; if ($q3 >= 3831)$name = '2.10 SP3'; if ($q3 >= 3849)$name = '2.10 SP4'; if ($q3 >= 3860)$name = '2.10 SP5'; if ($q3 >= 3874)$name = '2.10 SP6'; if ($q3 >= 4034)$name = '11.0a'; if ($q3 >= 4045)$name = '11.0a2'; if ($q3 >= 4065)$name = '11.0b'; if ($q3 >= 4066)$name = '11.0b2'; if ($q3 >= 4079)$name = '11.0'; if ($q3 >= E2_VERSION)$name = '11.0'; return$name; } $_url_map = [ '@retrieve:url' => 'e2://e2s_retrieve', '@instantiate:version' => 'e2://e2s_instantiate', '@notify' => 'e2://e2s_notify', '@info' => 'e2://e2m_info', '' => 'e2://e2m_frontpage?page=1', ':page' => 'e2://e2m_frontpage', 'rss' => 'e2://e2m_rss', 'json' => 'e2://e2m_json', 'sitemap.xml' => 'e2://e2m_sitemap_xml', ':year' => 'e2://e2m_year', ':year/:month' => 'e2://e2m_month', ':year/:month/:day' => 'e2://e2m_day', 'all' => 'e2://e2m_everything', ':note' => 'e2://e2m_note?is_published=1&preview-key=0', ':note/:preview' => 'e2://e2m_note?is_published=1', ':note/edit' => 'e2://e2m_note_edit?is_published=1', ':note/favourite' => 'e2://e2s_note_flag_favourite?is_published=1&value=1', ':note/unfavourite' => 'e2://e2s_note_flag_favourite?is_published=1&value=0', ':note/show' => 'e2://e2s_note_flag?is_published=1&flag=IsVisible&value=1', ':note/hide' => 'e2://e2s_note_flag?is_published=1&flag=IsVisible&value=0', ':note/discuss' => 'e2://e2s_note_flag?is_published=1&flag=IsCommentable&value=1', ':note/quiet' => 'e2://e2s_note_flag?is_published=1&flag=IsCommentable&value=0', ':note/withdraw' => 'e2://e2m_note_withdraw?is_published=1', ':note/json' => 'e2://e2m_note_json', ':note/broadcast' => 'e2://e2m_note_broadcast', ':note/read' => 'e2://e2m_note_read', ':note/delete' => 'e2://e2m_note_delete?is_published=1', ':note/format/:formatter' => 'e2://e2m_note_use_formatter?is_published=1', ':note/:unsubscr' => 'e2://e2m_unsubscribe?is_published=1', ':note/:comnum' => 'e2://e2m_comment', ':note/:comnum/edit' => 'e2://e2m_comment_edit', ':note/:comnum/important' => 'e2://e2s_comment_flag_ajax?flag=IsFavourite&value=1', ':note/:comnum/usual' => 'e2://e2s_comment_flag_ajax?flag=IsFavourite&value=0', ':note/:comnum/replace' => 'e2://e2s_comment_flag_ajax?flag=IsVisible&value=1', ':note/:comnum/remove' => 'e2://e2s_comment_flag_ajax?flag=IsVisible&value=0', ':note/:comnum/spam' => 'e2://e2m_comment_flag?flag=IsSpamSuspect&value=1', ':note/:comnum/good' => 'e2://e2m_comment_flag?flag=IsSpamSuspect&value=0', ':note/:comnum/wipe' => 'e2://e2m_comment_delete', ':note/:comnum/reply/edit' => 'e2://e2m_comment_reply', ':note/:comnum/reply/important' => 'e2://e2s_comment_flag_ajax?flag=IsReplyFavourite&value=1', ':note/:comnum/reply/usual' => 'e2://e2s_comment_flag_ajax?flag=IsReplyFavourite&value=0', ':note/:comnum/reply/replace' => 'e2://e2s_comment_flag_ajax?flag=IsReplyVisible&value=1', ':note/:comnum/reply/remove' => 'e2://e2s_comment_flag_ajax?flag=IsReplyVisible&value=0', ':note/:comnum/reply/delete' => 'e2://e2m_comment_reply_delete', 'drafts' => 'e2://e2m_drafts?page=1', 'drafts-:page' => 'e2://e2m_drafts', 'drafts/:draft' => 'e2://e2m_note?is_published=0&preview-key=0', 'drafts/:draft/:preview' => 'e2://e2m_note?is_published=0', 'drafts/:draft/edit' => 'e2://e2m_note_edit?is_published=0', 'drafts/:draft/delete' => 'e2://e2m_note_delete?is_published=0', 'drafts/:draft/format/:formatter' => 'e2://e2m_note_use_formatter?is_published=0', 'sources' => 'e2://e2m_sources', 'sources/:source/trust' => 'e2://e2m_source_trust', 'sources/:source/premoderate' => 'e2://e2m_source_premoderate', 'sources/:source/ban' => 'e2://e2m_source_ban', 'sources/:source/forget' => 'e2://e2m_source_forget', 'tags' => 'e2://e2m_tags', 'tags/:tag' => 'e2://e2m_tag?page=1', 'tags/:tag/:page' => 'e2://e2m_tag', 'tags/:tag/rss' => 'e2://e2m_tag_rss', 'tags/:tag/json' => 'e2://e2m_tag_json', 'tags/:tag/edit' => 'e2://e2m_tag_edit', 'tags/:tag/delete' => 'e2://e2m_tag_delete', 'tags/:tag/pin' => 'e2://e2s_tag_flag_ajax?flag=IsFavourite&value=1', 'tags/:tag/unpin' => 'e2://e2s_tag_flag_ajax?flag=IsFavourite&value=0', 'selected' => 'e2://e2m_favourites?page=1', 'selected/:page' => 'e2://e2m_favourites', 'hot' => 'e2://e2m_most_commented', 'popular' => 'e2://e2m_popular', 'untagged' => 'e2://e2m_untagged?page=1', 'untagged/:page' => 'e2://e2m_untagged', 'found' => 'e2://e2m_found&query=', 'found/:query' => 'e2://e2m_found', 'new' => 'e2://e2m_write', 'settings' => 'e2://e2m_settings', 'settings/underhood' => 'e2://e2m_underhood', 'settings/underhood/build' => 'e2://e2s_post_service?service=build', 'settings/underhood/sync' => 'e2://e2s_post_service?service=sync', 'settings/underhood/checklist-reset' => 'e2://e2s_post_service?service=checklist-reset', 'settings/underhood/log' => 'e2://e2s_post_service?service=log', 'settings/underhood/unlog' => 'e2://e2s_post_service?service=unlog', 'settings/underhood/migrate' => 'e2://e2s_post_service?service=migrate', 'settings/underhood/verify' => 'e2://e2s_post_service?service=verify', 'settings/underhood/backup' => 'e2://e2s_dump', 'settings/underhood/index' => 'e2://e2s_bsi_step', 'settings/underhood/reindex' => 'e2://e2s_reindex', 'settings/database' => 'e2://e2m_database', 'settings/password' => 'e2://e2m_password?recovery-key=', 'settings/password-reset' => 'e2://e2m_password_reset', 'settings/password/:reset' => 'e2://e2m_password', 'settings/timezone' => 'e2://e2m_timezone', 'settings/sessions' => 'e2://e2m_sessions', 'settings/theme-preview' => 'e2://e2m_theme_preview?theme=', 'settings/theme-preview/:theme' => 'e2://e2m_theme_preview', 'settings/get-backup' => 'e2://e2m_get_backup', 'sign-in' => 'e2://e2m_sign_in', 'sign-out' => 'e2://e2m_sign_out', 'sign-in/:provider' => 'e2://e2m_gip_sign_in', 'sign-out/:provider' => 'e2://e2m_gip_sign_out', 'sign-in-done/:provider' => 'e2://e2m_gip_sign_in_callback', '@ajax/::' => 'e2://e2j_::', '@actions/::' => 'e2://e2s_::', ]; $_url_chunks = [ '\:page' => 'page\-(?P<page>\d+)', '\:year' => '(?P<year>\d{4})', '\:month' => '(?P<month>\d{1,2})', '\:day' => '(?P<day>\d{1,2})', '\:note' => [ 'all\/(?P<alias>[-a-zA-Z0-9]+)', '(?P<year>\d{4})\/(?P<month>\d{1,2})\/(?P<day>\d{1,2})\/(?P<day_number>\d+)', ], '\:draft' => [ '(?P<oalias2>[-a-zA-Z0-9]+)\/(?P<draft2>\d+)', '(?P<oalias>[-a-zA-Z0-9]+)', '-\/(?P<draft>\d+)', ], '\:comnum' => 'comment\-(?P<comment_number>[0-9]+)', '\:file' => '(?P<file>.*?)', '\:tag' => '(?P<tag_alias>[-a-zA-Z0-9,]+)', '\:query' => '(?P<query>.*?)', '\:provider' => '(?P<provider>.*?)', '\:version' => '\:(?P<version>\d+)', '\:source' => '\:(?P<source>.*?)', '\:picture' => '\:(?P<picture>.*?)', '\:unsubscr' => 'unsubscribe\:(?P<unsubscribe_email>.+?)\:(?P<unsubscribe_key>[0-9a-f]{32})', '\:reset' => 'reset\:(?P<recovery_key>[0-9a-f]{40})', '\:formatter' => '(?P<formatter>.*?)', '\:alias' => '(?P<newalias>[-a-zA-Z0-9]+)', '\:preview' => 'preview\:(?P<preview_key>[0-9a-f]{32})', '\:theme' => '(?P<theme>[-a-zA-Z0-9]+)', '\:source' => '(?P<source>\d+)', '\:url' => '\:(?P<url>[a-zA-Z0-9\=\/\\\+\-\_\,]+)', ]; $_url_autoredirects = [ '/^favo(?:u?)rites(\~.+)?$/i' => 'selected\\1', '/^favo(?:u?)rites\/(.+)/i' => 'selected/\\1', '/^keywords$/i' => 'tags', '/^keywords\/(.*)/i' => 'tags/\\1', '/^everything$/i' => 'all', '/^search\/(.+)/i' => 'found/\\1', '/^(\d{4}\/\d{1,2}\/\d{1,2}\/\d+)\/comments(\/?)$/i' => '\\1', '/^\~(\d+)/i' => 'page-\\1', '/\/?\~(\d+)/i' => '/page-\\1', ]; function qq () { global$_config; $fmv = [ 'result', 'url', 'entity', 'entity-id', 'overwrite', 'data', 'src', 'ord', ]; if($_config['raw_template_data_with_param']) { $fmv[] = 'raw'; } return $fmv; } function lq ($url){ global$_url_autoredirects; $url = preg_replace (array_keys ($_url_autoredirects),array_values ($_url_autoredirects),$url); if(preg_match ('/^([0-9]+)[.-]([0-9]+)[.-]([0-9]+)(.*)/',$url,$me)) { if(2 == strlen ($me[3]))$me[3]='20'.$me[3]; return ($me[3].'/'.$me[2].'/'.$me[1].$me[4]); } if(preg_match ('/^tags\-rss\/(.*?)\/?$/',$url,$me)) { $hv = substr ($me[1],strrpos ($me[1],'/')+1); return ('tags/'. $hv . '/rss/'); } return$url; } function zq () { static $dmv = false; global$__synthetic_urls,$_config; if ($dmv) return; $smv = $_config['url_composition']; $__synthetic_urls = false; if ($smv == 'synthetic'){ $__synthetic_urls = true; } if ($smv == 'auto'){ if(function_exists ('apache_get_modules')) { if(in_array ('mod_rewrite',apache_get_modules ())) { $__synthetic_urls = true; } } } $dmv = true; } function kq ($candy,$parameters = []) { global$_url_map,$_url_chunks,$_config,$__synthetic_urls; $amv = array_flip ($_url_map); $url = AeEnv::$o; $qmv = 'e2://'. $candy; if(array_key_exists ('page',$parameters)) { $parameters['page'] = (int)$parameters['page']; } if(array_key_exists ('day',$parameters)) { $parameters['day']=str_pad ((int)$parameters['day'],2,'0',STR_PAD_LEFT); } if(array_key_exists ('month',$parameters)) { $parameters['month']=str_pad ((int)$parameters['month'],2,'0',STR_PAD_LEFT); } if($parameters){ $qmv .= '?'; $lmv = []; $zmv = []; foreach($parameters as $py => $cv){ if ($py == '*note'){ $zmv[] = $py; $lmv[] = rq ($cv); } if ($py == '*tags'){ $zmv[] = $py; $lmv[] = tq ($cv); } if ($py == '*tag'){ $zmv[] = $py; $lmv[] = tq ([$cv]); } } foreach ($zmv as $py) unset($parameters[$py]); foreach ($lmv as $kmv){ $parameters = array_merge ($parameters,$kmv); } foreach($parameters as $py => $cv){ if (@$py[0]!='_'){ $qmv .= $py . ($cv !== true? ('='. urlencode ($cv)) : '') .'&'; } } $qmv = substr ($qmv,0, -1); } if(array_key_exists ($qmv,$amv)) { if ($amv[$qmv]!==''){ $url .= $amv[$qmv]; if ( !in_array (substr ($amv[$qmv], -4), ['.txt','.xml']) ) { $url .= '/'; } } return$url; } else { $rmv = false; foreach ($amv as $tmv => $jmv){ $hmv = $tmv; $hmv = preg_quote ($hmv,'/'); $gmv = parse_url ($tmv); $wmv = $gmv['host']; $umv = parse_url ($qmv); if(strstr ($tmv,'::')) { $imv = $umv['scheme'] .'://'. $umv['host']; $hmv = str_replace ('\:\:','(.*)',$hmv); $hmv = '/^'. $hmv .'$/s'; if(preg_match ($hmv,$imv,$me)) { $vnv = str_replace ('::',$me[1],$jmv); $vnv = str_replace ('_','-',$vnv); $l2 = false; if(array_key_exists ('query',$umv)) { $l2 = $umv['query']; } if($__synthetic_urls and $l2){ $url .= $vnv .'/?'. $l2; } elseif($__synthetic_urls){ $url .= $vnv .'/'; } elseif ($l2){ $url .= '?go='. $vnv .'/?'. $l2; } else { $url .= '?go='. $vnv .'/'; } return$url; } } $omv = false; if($candy === $wmv){ $rmv = true; if ((string) @$gmv['query']!==''){ $pmv = explode ('&',$gmv['query']); foreach ($pmv as $cfv){ list ($py,$cv)=explode ('=',$cfv); $cv = urldecode ($cv); $py = str_replace ('_','-',$py); if ( array_key_exists ($py,$parameters) and $parameters[$py]!=$cv ) { $omv = true; break; } } } if (!$omv){ if(preg_match_all ('/\:[\-a-z]+/i',$jmv,$me)) { foreach ($me[0] as $vfv){ $bfv = $_url_chunks['\\'. $vfv]; if (!is_array ($bfv)) { $bfv = [$bfv]; } $yfv = $bfv[0]; foreach ($bfv as $yfv){ $nfv = '/\(\?P\<(.*?)\>.*?\)/'; $mfv = true; if (@preg_match_all ($nfv,$yfv,$me)) { $me = $me[1]; $mfv = true; for ($rb = 0; $rb < count ($me); ++ $rb){ if ( !array_key_exists (str_replace ("_","-",$me[$rb]), $parameters) or $parameters[str_replace ("_","-",$me[$rb])] === '' ) { $mfv = false; break; } } } if (!$mfv) continue; $ffv = @preg_replace_callback ( $nfv, function ($me) use ($parameters){ return$parameters[str_replace ("_","-",$me[1])]; }, $yfv ); $ffv = stripslashes ($ffv); $dfv = str_replace ($vfv,$ffv,$jmv); break; } $jmv = @$dfv; } } $sfv = []; if ($jmv){ if($__synthetic_urls){ $url .= $jmv .'/'; } else { $sfv[] = 'go='. $jmv .'/'; } } if (@$parameters['raw']===true){ if($_config['raw_template_data_with_param']) { $sfv[] = 'raw'; } } if(count ($sfv)) { $url .= '?'. implode ('&',$sfv); } return$url; } } } if ($rmv){ return$url; } else { die ('Cannot compose url for candy '. $candy); } } } function xq ($url = null){ global$_url_map,$_url_chunks,$_current_url; if(Log::$a)__log ('Resolve request "'. $url .'" {'); zq (); $url = trim ($url,'/'); $url = lq ($url); $parameters = []; $qmv = ''; foreach($_url_map as $afv => $tmv){ $qfv = $afv; $qfv = preg_quote ($qfv,'/'); if(strstr ($afv,'::')) { $qfv = str_replace ('\:\:','(.*)',$qfv); $qfv = '/^'. $qfv .'$/s'; if(preg_match ($qfv,$url,$me)) { $lfv = str_replace ('-','_',$me[1]); $qmv = str_replace ('::',$lfv,$tmv); } } elseif(strstr ($afv,':')) { $zfv = []; foreach($_url_chunks as $a3 => $q3){ if(is_array ($q3)) { $zfv[$a3]='(?:(?:'. implode (')|(?:',$q3) .'))'; } else { $zfv[$a3]=$q3; } } $qfv = str_replace ( array_keys ($zfv), array_values ($zfv), $qfv ); $qfv = '/^'. $qfv .'$/s'; if(preg_match ($qfv,$url,$me)) { $qmv = $tmv; foreach ($me as $py => $cv) if (!is_numeric ($py)) { $py = str_replace ('_','-',$py); $parameters[$py]=$cv; } } } else { if ($afv == $url){ $qmv = $tmv; break; } } } if ($qmv){ $kfv = true; } else { $kfv = false; $qmv = 'e2://e2m_error404'; } if (!$qmv)$qmv = 'e2://e2m_error404'; $umv = parse_url ($qmv); $candy = $umv['host']; if ((string) @$umv['query']!==''){ $pmv = explode ('&',$umv['query']); foreach ($pmv as $cfv){ list ($py,$cv)=explode ('=',$cfv); $cv = urldecode ($cv); $py = str_replace ('_','-',$py); $parameters[$py]=$cv; } } foreach($_GET as $py => $cv){ if(in_array ($py,qq (), true)) { $parameters[$py] = (string)$cv or $parameters[$py]=true; } } $cb = false; if ($kfv){ $_current_url = AeEnv::$h .'://'. AeEnv::$j . $_SERVER['REQUEST_URI']; hq ($candy,$parameters); if(is_callable ($candy)) { $cb = [$candy,$parameters]; } else { $cb = [null, []]; } } else { $cb = [null, []]; } if(Log::$a){ $xfv = ''; if(count ($cb[1]) > 0){ $xfv = print_r ($cb[1],true); $xfv = substr ($xfv,8, -2); $xfv = '    '. trim ($xfv); $xfv = preg_replace ('/^.*?$/smu','           $0',$xfv); $xfv = ' with parameters:'."\r\n". $xfv; } __log ( 'Resolved to candy "'. $cb[0] .'"'. $xfv ); } if(Log::$a)__log ('}'); return $cb; } function rq ($sy){ if (!isset ($sy['IsPublished'])) { throw new LogicException ('Cannot compose parameters from noterec without IsPublished'); return []; } if (!$sy['IsPublished']) { $parameters['is-published']=0; if ($sy['OriginalAlias']===''){ $parameters['draft']=$sy['ID']; } elseif (tb ($sy['OriginalAlias']) == 1){ $parameters['oalias']=$sy['OriginalAlias']; } else { $parameters['draft2']=$sy['ID']; $parameters['oalias2']=$sy['OriginalAlias']; } return$parameters; } $parameters['is-published']=1; $yy = b (); $my = 'n'. $sy['ID']; $efv = $yy[$my]; if (isset ($sy['__force_ymdn']) and ((string)$sy['OriginalAlias']==='')) { $my = 'n'. $sy['ID'] .'-ymdn'; if(array_key_exists ($my,$yy)) { $efv = $yy[$my]; } } if(preg_match ( '/(?P<year>\d{4})\/(?P<month>\d{1,2})\/(?P<day>\d{1,2})\/(?P<day_number>\d+)/', $efv,$me )) { $parameters['year']=$me['year']; $parameters['month']=$me['month']; $parameters['day']=$me['day']; $parameters['day-number']=$me['day_number']; } else { $parameters['alias']=$efv; } return$parameters; } function tq ($xb){ $rfv = $parameters = []; foreach ($xb as $tb){ $rfv[] = b () ['t'. $tb['ID']]; } if(count ($rfv)) { $parameters['tag-alias']=implode (',',$rfv); } return$parameters; } function jq ($parameters){ if ( (string) @$parameters['alias']!=='' or ( (string) @$parameters['year']!=='' and (string) @$parameters['month']!=='' and (string) @$parameters['day']!=='' and (string) @$parameters['day-number']!=='' ) ) { if ($r = e2_published_noterec_with_parameters_($parameters)) { if(Log::$a)__log ('Fetched note '.$r['ID'].' "'. $r['Title'] .'" as *note'); $parameters['*note']=$r; foreach (['alias','year','month','day','day-number'] as $tfv){ if(array_key_exists ($tfv,$parameters)) { unset($parameters[$tfv]); } } } } if ( (string) @$parameters['oalias']!=='' or (string) @$parameters['draft']!=='' or (string) @$parameters['oalias2']!=='' or (string) @$parameters['draft2']!=='' ) { if ($r = e2_noterec_with_parameters_($parameters)) { if(Log::$a)__log ('Fetched note '.$r['ID'].' "'. $r['Title'] .'" as *note'); if ((string) @$parameters['oalias']!==''){ $parameters['alias']=$parameters['oalias']; } elseif ((string) @$parameters['oalias2']!==''){ $parameters['alias']=$parameters['oalias2']; } $parameters['*note']=$r; foreach (['oalias','draft','oalias2','draft2'] as $tfv){ if(array_key_exists ($tfv,$parameters)) { unset($parameters[$tfv]); } } } } if ( (string) @$parameters['tag-alias']!=='' ) { $parameters['*tags']=e2_tagrecs_with_parameters_($parameters); if(Log::$a)__log ('Fetched '. count ($parameters['*tags']) .' tag(s) as *tag(s)'); if(count ($parameters['*tags']) == 1){ $parameters['*tag']=$parameters['*tags'][0]; unset($parameters['*tags']); if(array_key_exists ('tag-alias',$parameters)) { unset($parameters['tag-alias']); } } } return$parameters; } function hq ($candy,$parameters){ global$_config,$_current_url,$_canonical_url; if (!$_config['force_canonical_urls']) return; if($candy === 'e2m_install') return; if($candy === 'e2m_sign_in') return; if($candy === 'e2m_error404') return; if($candy === 'e2m_gip_sign_in_callback') return; if($candy === 'e2s_notify') return; if($candy === 'e2j_file_upload') return; $_canonical_url = kq ($candy,$parameters); if(Log::$a)__log ('Params are: '. var_export ($parameters,true)); if ( $_current_url != $_canonical_url and urldecode ($_current_url)!=$_canonical_url ) { if(Log::$a)__log ('Used URL "'. $_current_url .'"'); if(Log::$a)__log ('Redirecting to canonical URL "'. $_canonical_url .'"'); q1 ($_canonical_url); } } function gq ($jfv){ global$_instance_config; $cmv = str_replace ('/','--',$jfv); if(substr ($cmv,0,4)=='www.'){ $cmv = substr ($cmv,4); } if(array_key_exists ($cmv,$_instance_config['path_user_rewrites'])) { $cmv = $_instance_config['path_user_rewrites'][$cmv]; } return $cmv; } function wq () { static $hfv = null; if ($hfv !== null) return $hfv; $gfv = AeEnv::$server . AeEnv::$w; if(AeEnv::$u !== (string)''){ $gfv .= '/'. AeEnv::$u; } $hfv = gq ($gfv); return $hfv; } function uq ($bp,$wfv){ $ufv = $wfv; $ufv = preg_quote ($ufv); $ufv = str_replace ('/','\/',$ufv); $ufv = str_replace ('%USERKEY%','(.*?)',$ufv); $ufv = '/'. $ufv . '/i'; $cmv = ''; if(preg_match ($ufv,$bp,$me) and array_key_exists (1,$me)) { $cmv = $me[1]; } return $cmv; } function iq ($ifv,$cmv){ foreach (['path_user','path_media'] as $ofv){ if (!array_key_exists ($ofv .'.raw', $ifv)) { $ifv[$ofv .'.raw']=$ifv[$ofv]; } if(strpos ($ifv[$ofv .'.raw'],'%USERKEY%')!==false){ $ifv[$ofv]=str_replace ( '%USERKEY%', $cmv, $ifv[$ofv .'.raw'] ); } } return $ifv; } function oq ($pfv,$cmv){ foreach (['path_user','path_media'] as $ofv){ if (!array_key_exists ($ofv .'.raw',$pfv)) { $pfv[$ofv .'.raw']=$pfv[$ofv]; } if(strpos ($pfv[$ofv .'.raw'],'%USERKEY%')!==false){ $pfv[$ofv]=str_replace ( '%USERKEY%', $cmv, $pfv[$ofv .'.raw'] ); } } $_config = $pfv; if(is_file ($bx = $pfv['path_user'] .'config.php')) { include $bx; $_config += $pfv; } return$_config; } function pq () { global$_instance_config; if(strpos ($_instance_config['path_user'],'%USERKEY%')!==false){ $c2v = str_replace ( '%USERKEY%', '*', $_instance_config['path_user'] ); return glob ($c2v); } else { return [$_instance_config['path_user']]; } } function cl () { static $databaseConfiguration = null; global$settings,$_config; if($databaseConfiguration === null){ $databaseConfiguration = vl ($_config,$settings); } return$databaseConfiguration; } function vl ($vmv,$yp){ $pp = null; $v2v = null; if(getenv ('E2_DB_SERVER'))$pp['server']=getenv ('E2_DB_SERVER'); if(getenv ('E2_DB_USER_NAME'))$pp['user_name']=getenv ('E2_DB_USER_NAME'); if(getenv ('E2_DB_PASSW'))$pp['passw']=getenv ('E2_DB_PASSW'); if(getenv ('E2_DB_NAME'))$pp['name']=getenv ('E2_DB_NAME'); if ($pp !== null){ $v2v = 'environment'; if(Log::$a)__log ('Database configuration found in Environment, won’t look elsewhere'); } else { if(Log::$a)__log ('No database configuration found in Environment'); $pp = $vmv['db']; if ($pp !== null){ $v2v = 'config'; if(Log::$a)__log ('Database configuration found in Config, won’t look elsewhere'); } else { if(Log::$a)__log ('No database configuration found in Config'); if(array_key_exists ('db',$yp)) { $v2v = 'settings'; if(Log::$a)__log ('Database configuration found in Settings'); $pp = $yp['db']; } else { if(Log::$a)__log ('No database configuration found anywhere'); } } } if ($pp === null) return null; $databaseConfiguration = new AeDatabaseConfiguration ( $v2v, $vmv['path_user'].BACKUP_DIRNAME, $pp['server'], $pp['user_name'], $pp['passw'], $pp['name'], $vmv['db_table_prefix'], $vmv['db_table_subset'] ); return$databaseConfiguration; } function bl ($b2v,$y2v = false){ $n2v = ''; $yz = strlen ($b2v); for ($rb = 0; $rb < 256; ++ $rb){ $m2v[$rb]=0; $f2v = $rb; while ($f2v & 0x00000080){ $f2v <<= 1; ++ $m2v[$rb]; } } for ($rb = 0xd090; $rb <= 0xd0bf; $rb++)$d2v[$rb]=chr (($rb & 0x000000ff)+48); for ($rb = 0xd180; $rb <= 0xd18f; $rb++)$d2v[$rb]=chr (($rb & 0x000000ff)+112); $d2v[0xd081]="\xa8"; $d2v[0xd191]="\xb8"; $d2v[0xc299]="\x99"; $d2v[0xc2a9]="\xa9"; $d2v[0xc2ae]="\xae"; $d2v[0xc2ab]="\xab"; $d2v[0xc2bb]="\xbb"; $d2v[0xc2a0]="\xa0"; $rb = 0; while ($rb < $yz){ $s2v = $b2v[$rb]; $a2v = ord ($s2v); if ($m2v[$a2v]==0){ $n2v .= $s2v; ++ $rb; } elseif ($m2v[$a2v]==2){ $q2v = $d2v[($a2v << 8) | ord ($b2v[$rb+1])]; $n2v .= ($q2v != null)? $q2v : ( $y2v? (e2utf8__unformat_htmlentity ( yl (substr ($b2v,$rb,2)) )) : '?' ); $rb += 2; } else { $l2v = substr ($b2v,$rb,$m2v[$a2v]); if ($l2v == "\xe2\x84\x96")$n2v .= "\xb9"; elseif ($l2v == "\xe2\x80\x93")$n2v .= "\x96"; elseif ($l2v == "\xe2\x80\x94")$n2v .= "\x97"; elseif ($l2v == "\xe2\x80\x98")$n2v .= "\x91"; elseif ($l2v == "\xe2\x80\x99")$n2v .= "\x92"; elseif ($l2v == "\xe2\x80\x9a")$n2v .= "\x82"; elseif ($l2v == "\xe2\x80\x9c")$n2v .= "\x93"; elseif ($l2v == "\xe2\x80\x9d")$n2v .= "\x94"; elseif ($l2v == "\xe2\x80\x9e")$n2v .= "\x84"; elseif ($l2v == "\xe2\x80\xa6")$n2v .= "\x85"; elseif ($l2v == "\xe2\x80\xb9")$n2v .= "\x8b"; elseif ($l2v == "\xe2\x80\xba")$n2v .= "\x9b"; elseif ($l2v == "\xe2\x82\xac")$n2v .= "\x88"; elseif ($l2v == "\xe2\x84\xa2")$n2v .= "\x99"; else $n2v .= $y2v? (e2utf8__unformat_htmlentity ( yl ($l2v) )) : '?'; $rb += $m2v[$a2v]; } } return $n2v; } function yl ($fcv){ $z2v = ''; $yz = strlen ($fcv); for ($rb = 0; $rb < $yz; ++ $rb){ $z2v .= preg_replace ('/^1*0/','',decbin (ord ($fcv[$rb]))); } return '&#'. bindec ($z2v) .';'; } if (!BUILT) include 'builder.php'; if(version_compare (PHP_VERSION,E2_MINIMUM_PHP)<0){ die ('PHP version must be '. E2_MINIMUM_PHP .' or later, you are running '. PHP_VERSION); } if (!function_exists ('getimagesize')) { die ('Function getimagesize is not defined, php_gd not installed?'); } if (!function_exists ('mb_internal_encoding')) { die ('Function mb_internal_encoding is not defined, php_mbstring not installed?'); } if (!class_exists ('PDO')) { die ('Class PDO is not defined installed, PDO not installed?'); } if (!in_array ('mysql',PDO::getAvailableDrivers ())) { die ('Required PDO driver "mysql" not installed'); } if (!is_file ($bx = 'system/default/config.php')) { die ('File not found: '. $bx); } error_reporting (E_ALL); setlocale (LC_CTYPE,'ru_RU.UTF'); mb_internal_encoding ('UTF-8'); date_default_timezone_set ('GMT'); mysqli_report (MYSQLI_REPORT_OFF); if(version_compare (PHP_VERSION,'7.0')<0){ error_reporting (E_ALL & ~E_STRICT); } ini_set ('pcre.jit','0'); include $bx; $_system_default_config = $_config; foreach (['instance/',$_config['path_user']] as $k2v){ if(is_dir ($x2v = $k2v)) { if(is_file ($bx = $x2v .'config.php')) { include $bx; $_config += $_system_default_config; } break; } } $_instance_config = $_config; define ('INSTANCE_DIR',$x2v); AeEnv::examine ($_SERVER); $_config = oq ($_instance_config,wq ()); if (!is_dir ($_config['path_user'])) { die ('User directory not found: '. $_config['path_user']); } define ('USER_DIR',$_config['path_user']); define ('USER_URLPATH','user/'); AeEnv::setPrefersHTTPS ($_config['force_https']); AeEnv::setPreferredServer ($_config['preferred_domain_name']); AeFileManager::setInstancePath (INSTANCE_DIR); AeFileManager::setUserPath ($_config['path_user']); AeFileManager::setMediaPath ($_config['path_media']); $_stopwatch = mq ($_stopwatch); spl_autoload_register ('xd'); spl_autoload_register ('gy'); dn (); $settings = e2_load_settings_from_user_folder_(USER_DIR); $_strings = nn (); $e2v = serialize ($_config); $e2v = serialize (md5 ($e2v)); $r2v = $_config['path_user'].'config-hash.psa'; if ($e2v !== (string) @unserialize (file_get_contents ($r2v))) { if(Log::$a)__log ('Edition or configuration changed, dropping all caches'); e2_drop_all_kinds_of_cache (); if (!@e3 ($r2v,serialize ($e2v))) { die ('Cannot write file: '. $r2v); } } function e2 () { global$settings,$content, $_candy, $_lang, $_config, $_strings, $_template; if(Log::$a)__log ( 'Serving the user with key "'. wq () .'" '. 'using directory "'. $_config['path_user'] .'"' ); i1 (); set_error_handler ('wb'); set_exception_handler ('y3'); $t2v = new AeRequest ($_SERVER,$_GET); $content = []; $_candy = $t2v->candy; $lx = vn (); $j2v = true; $h2v = true; $rn = vs (); if ( $t2v -> requiresInstallation () and ( $lx === null or cl () === null or !pd () ) ) { $j2v = false; if (!$_config['allow_installer'] or !$_config['allow_db_config']) { $content = is ('not-configured'); } elseif(count ( $cq = AeFileManager::getPathsWithNoWritePermissions ( $_config['path_user'],$_config['path_media'] ) ) > 0){ $content = is ('generic', [ 'heading' => $_strings['pt--fix-permissions'], 'text' => ( '<p>'. $_strings['gs--fix-permissions'] .'</p>'. gb (array_unique ($cq)) ), 'button' => $_strings['fb--retry'], ]); } else { $t2v -> replaceWith ('e2m_install'); } } if ( empty ($content) and $t2v -> requiresVersionMatch () and E2_VERSION !== $lx['version'] ) { $h2v = false; if(Log::$a)__log ('Startup: need to update first'); $g2v = fq ($lx['version']); if (@$g2v['status']==='success'){ $lx = $g2v['instance']; if (vs ()) { hb (e2l_get_string ('gs--updated-successfully', [ 'from' => $g2v['from-release'], 'to' => $g2v['to-release'], ]), E2E_MESSAGE); } $h2v = true; } else { $content = $g2v['stub']; } } if ( empty ($content) and $t2v -> requiresSignIn () ) { if(Log::$a)__log ('Author signed in? '. ($rn? 'Yes' : 'No')); if (!$rn){ $t2v -> replaceWith ('e2m_sign_in'); if ($t2v -> toBeFulfilledByService ()) { q1 (kq ('e2m_sign_in')); } } } if ( empty ($content) and !$t2v -> allowedInReadOnlyMode () and $_config['read_only'] ) { $content = is ('read-only-mode'); $j2v = false; } header ('X-Powered-By: '. E2_UA_STRING); header ('Content-type: text/html; charset=UTF-8'); if (empty ($content)) { if (!is_callable ($t2v->candy)) { $t2v -> replaceWith ('e2m_error404'); } if(Log::$a)__log ('Candy after clearance: '. $t2v->candy); if ($t2v -> shouldSlowDownAJAXResponse () and $_config['dev_slow_ajax']) { sleep (1 + 2 * (rand () / getrandmax ())); } try { if ($t2v -> requiresInstallation ()) { $t2v->parameters = jq ($t2v->parameters); if(Log::$a)__log ('Call e2_canonize_url for the second time:'); hq ($t2v->candy,$t2v->parameters); if ( array_key_exists ('is-published',$t2v->parameters) and $t2v->parameters['is-published']=='0' and $t2v->parameters['*note']['IsPublished']=='1' ) { q1 (kq ($t2v->candy,$t2v->parameters)); } } if(Log::$a)__log ('Candy call {'); $content = call_user_func ($t2v->candy,$t2v->parameters); } catch (AeMySQLException $e){ if (!$t2v->toBeFulfilledByService ()) { v3 ($e); $t2v->parameters = []; $content['unavailable?']=true; } else { throw $e; } } if(Log::$a)__log ('}'); } if (!is_array ($content))$content = []; if (!array_key_exists ('notes',$content))$content['notes'] = []; if (!array_key_exists ('tag',$content))$content['tag'] = []; if (!array_key_exists ('drafts',$content))$content['drafts'] = []; if (!array_key_exists ('comments',$content))$content['comments'] = []; if (!array_key_exists ('notes-list',$content))$content['notes-list'] = []; $content['title']=strip_tags (dy (htmlspecialchars ((string) @$content['title'],ENT_NOQUOTES,'UTF-8'))); if (!empty ($content['heading'])) { $content['heading']=strip_tags (dy (htmlspecialchars ((string) @$content['heading'],ENT_NOQUOTES,'UTF-8'))); } $content['language']=$_lang; if (!isset ($_template))lf (); $content['template']['respond-to-dark-mode?'] = ( array_key_exists ('supports_dark_mode',$_template) and $_template['supports_dark_mode'] and @(bool)$settings['appearance']['respond_to_dark_mode'] ); $content['template']['use-likely-light?']=$_template['use_likely_light']; if (!array_key_exists ('class',$content)) { $content['class']=str_replace ('_','-',str_replace ('e2m_','',$t2v->candy)); } if ($j2v and $h2v){ if(Log::$a)__log ('Stuff for installed engine {'); d3 ('rss',ev (), kq ('e2m_rss')); d3 ('json',ev (), kq ('e2m_json')); $content['sign-in'] = [ 'done?' => (bool)$rn, 'required?' => (bool)$t2v->requiresSignIn (), 'necessary?' => (bool)$t2v->requiresSignIn () && !$rn, 'href' => kq ('e2m_sign_in'), 'prompt' => $_strings['gs--need-password'], 'token' => gd (), ]; $content['hrefs'] = array ( 'everything' => kq ('e2m_everything'), ); if (!array_key_exists ('tags',$content)) $content['tags']=ma ($t2v->parameters); if (!array_key_exists ('main-menu',$content)) $content['main-menu']=xn ($t2v->parameters,$content['class']); $content['blog']=xv (); $content['form-search']=dd ($t2v->parameters); $content['engine']=jb (); $content['form-login']=zs (); if($content['form-login']===null) unset($content['form-login']); if (!array_key_exists ('summary',$content)) { if (!empty ($settings['meta_description'])) { $content['summary']=strip_tags (dy (htmlspecialchars ($settings['meta_description'],ENT_NOQUOTES,'UTF-8'))); } else { $content['summary'] = @trim (strip_tags ($content['blog']['subtitle'])); } } if (@$settings['appearance']['show_view_counts']) { AeNoteReadCountsProvider :: setSQLRequestTemplateToMapIDsToReadCounts ( "SELECT `ID`, `ReadCount` ". "FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ); } foreach($content['notes'] as $r){ y2 (@$r['format-info']['links-required']); } if ($rn){ $content['admin']=c (); $content['last-modifieds-by-id']='{}'; if (@$_COOKIE[z1 ('local_copies')]) { $content['last-modifieds-by-id'] = ( wm ($_COOKIE[z1 ('local_copies')]) ); } $w2v = ks (); } if(Log::$a)__log ('}'); } $content['message']=ib (); $ew = jf (); $content['meta']=tn ( $t2v->candy, $content['notes'], $content['tag'], $content['blog'], $content['pages'] ); $content['stat']=jv (); $ew = ef ($ew); echo $ew; if ($j2v and $h2v and $_SERVER['HTTP_USER_AGENT']!==E2_UA_STRING){ if (!ld ()) { if(Log::$a)__log ('Spawn BSI step'); vv (kq ('e2s_bsi_step')); } if (!$w2v){ xs (); } } if (@$_config['dev_dump_ctree'])an ($content); } ?>