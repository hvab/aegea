<?php $_stopwatch = microtime (); define ('E2_VERSION',4034); define ('E2_RELEASE','2.11a'); define ('CACHE',1); define ('BUILDER_OBFUSCATE',1); define ('BUILDER_FLATTEN',1); define ('BUILT', !strstr (__FILE__,'all.php')); define ('E2_RUN_ID',chr (rand (65,90))); function e2m_error404 () { global$_config,$_strings; if($_config['try_redirect_to_all']) { $c = 'all/'. urldecode ($_GET['go']); lq ($c); } header ('HTTP/1.1 404 Not found'); $v['class']='404'; $v['heading']=$_strings['pt--page-not-found']; $v['title']=$_strings['pt--page-not-found']; return $v; } class AeArbitraryNotesCollectionView { private $name = ''; private $isCached = false; private $hasRun = false; private $sql = null; private $currentURL = null; private $cacheFilename = null; private $cacheExpiresFilename = null; private $cacheable = []; private $viewExpiration = null; private $notesCTree = null; private $filterOutIDs = []; public function __construct ($name){ $this->name = $name; } public function setSQLRequest ($sql){ $this->sql = $sql; } public function setCurrentURL ($currentURL){ $this->currentURL = $currentURL; } public function setCacheFilename ($cacheFilename){ $this->isCached = true; $this->cacheFilename = $cacheFilename; } public function setCacheExpiresFilename ($cacheExpiresFilename){ $this->cacheExpiresFilename = $cacheExpiresFilename; } public function setViewExpiration ($viewExpiration){ $this->viewExpiration = $viewExpiration; } public function setFilterOutIDs ($filterOutIDs){ $this->filterOutIDs = $filterOutIDs; } public function orderNotesCTreeByVerticality () { if (!$this->hasRun)$this -> run (); usort ($this->notesCTree, function ($b,$y){ if (empty ($b['images'][0]['verticality']))$n = 0; else $n = $b['images'][0]['verticality']; if (empty ($y['images'][0]['verticality']))$m = 0; else $m = $y['images'][0]['verticality']; return (int)round (($m - $n)*10000); }); } public function getNotesCTree () { if (!$this->hasRun)$this -> run (); return$this->notesCTree; } private function prepareCacheableData () { $f = [ 'notes-records' => function () { $d = []; try { mm ($this->sql,'get "'. $this->name .'" list'); foreach (dm () as $s){ if (yf ($s)==='public'){ $d[] = $s; } } } catch (AeMySQLException $e){ v3 ($e); if(Log::$a)__log ('Could not get list from database'); } return $d; }, ]; if($this->isCached and is_file ($this->cacheFilename)) { $this->cacheable = @unserialize (file_get_contents ($this->cacheFilename)) or $this->cacheable = []; } $q = true; if (!empty ($this->cacheExpiresFilename)) { if($this->isCached and is_file ($this->cacheExpiresFilename)) { $l = time (); $z = (int) @file_get_contents ($this->cacheExpiresFilename); if(Log::$a)__log ('List expires '. date ('r',$z) .', now '. date ('r',$l)); $q = ($l < $z); } } $k = false; foreach ($f as $x => $e_){ if (!array_key_exists ($x,$this->cacheable) or !$q){ if(Log::$a)__log ('Build cache: "'. $x .'"'); $this->cacheable[$x]=$e_ (); $k = true; } else { if(Log::$a)__log ('Retrieved from cache: "'. $x .'"'); } } if($this->isCached and $k){ e3 ($this->cacheFilename,serialize ($this->cacheable)); if($this->cacheExpiresFilename){ @e3 ($this->cacheExpiresFilename,time () + $this->viewExpiration); } } } private function run () { $this->hasRun = true; if(Log::$a)__log ('AeArbitraryNotesCollectionView "'. $this->name .'" run {'); if(Log::$a)__log ('Cacheable data {'); $this -> prepareCacheableData (); if(Log::$a)__log ('}'); if(Log::$a)__log ('Uncacheable data {'); $this->notesCTree = []; foreach($this->cacheable['notes-records'] as $s){ if(in_array ($s['ID'],$this->filterOutIDs)) continue; $noteView = new AeNoteView ($s); $r = $noteView -> getNoteCTree (); $r['current?'] = ($r['href']==$this->currentURL); $this->notesCTree[] = $r; AeNoteReadCountsProvider :: requestDeferredReadCountForNoteID ($s['ID']); } if(Log::$a)__log ('}'); if(Log::$a)__log ('}'); } } class AeDatabaseConfiguration { public $server; public $host; public $port = null; public $user; public $password; public $name; public $source; public $backup_dir; private $prefix = null; private $subset = null; public function __construct ( string $source, string $backup_dir, string $server, string $user, string $password, string $name, string $prefix = null, string $subset = null ) { $this->source = $source; $this->backup_dir = $backup_dir; $this->server = $server; list ($this->host,$this->port)=xm ($this->server); if ((string)$this->port === '') { $this->port = null; } $this->user = $user; $this->password = $password; $this->name = $name; $this->prefix = $prefix; $this->subset = $subset; } public function hasPrefixSpecified () { return$this->prefix !== null; } public function getPrefix () { if($this->prefix === null){ throw new LogicException ('Assertion failed: database configuration has no prefix'); } return$this->prefix; } public function setPrefix ($prefix){ $this->prefix = $prefix; } public function hasSubsetSpecified () { return$this->subset !== null; } public function setSubset ($subset){ $this->subset = $subset; } public function getSubset () { if($this->subset === null){ throw new LogicException ('Assertion failed: database configuration has no subset'); } return$this->subset; } public function getDatabaseParamsArray () { return [ 'server' => $this->server, 'user_name' => $this->user, 'passw' => $this->password, 'name' => $this->name, ]; } public function getServerKeyString () { return$this->user .'@'. $this->server; } public function getDatabaseKeyString () { return$this -> getServerKeyString () .'/'. $this->name; } public function getTablesKeyString () { return$this -> getDatabaseKeyString () .'/'. $this -> getPrefix () .'...'; } public function __toString () { return$this -> getTablesKeyString () .'?'. $this -> getSubset (); } } class AeEnv { private static $t = false; public static $j = ''; public static $h = 'http'; public static $g = ''; public static $server = ''; public static $w = ''; public static $u = ''; public static $i = 'http'; public static $base_url = ''; public static $o = ''; private static function updateBaseURL () { if (!self::$t) throw new LogicException ('AeEnv not initialized'); self::$base_url = self::$i. '://'. self::$server . self::$w . '/'; self::$o = self::$base_url; if(self::$u !== (string)''){ self::$o .= self::$u .'/'; } } public static function examine ($p){ list (self::$server, ) = explode (':',$p['HTTP_HOST']); self::$w = substr ( $p['PHP_SELF'], 0,strpos ($p['PHP_SELF'],'/index.php') ); self::$i = ( !empty ($p['HTTPS']) && $p['HTTPS']!=='off' or $p['SERVER_PORT']==443 or isset ($p['HTTP_X_FORWARDED_PROTO']) && $p['HTTP_X_FORWARDED_PROTO']=='https' or isset ($p['HTTP_X_HTTPS']) && ($p['HTTP_X_HTTPS']) ) ? 'https' : 'http'; if(getenv ('E2_USER_SUBPATH')) { self::$u = getenv ('E2_USER_SUBPATH'); } elseif(getenv ('REDIRECT_E2_USER_SUBPATH')) { self::$u = getenv ('REDIRECT_E2_USER_SUBPATH'); } self::$t = true; self::updateBaseURL (); self::$j = self::$server; self::$h = self::$i; self::$g = self::$base_url; } public static function setPrefersHTTPS ($cv){ if (!self::$t) throw new LogicException ('AeEnv not initialized'); if ((bool)$cv){ self::$i = 'https'; self::updateBaseURL (); } } public static function setPreferredServer ($vv){ if (!self::$t) throw new LogicException ('AeEnv not initialized'); if ($vv !== null and $_SERVER['HTTP_HOST']!==$vv){ self::$server = $vv; self::updateBaseURL (); } } public static function showDie () { if (!self::$t) throw new LogicException ('AeEnv not initialized'); echo '<pre>'; echo '<b>server</b>: "'. self::$server. '"<br />'; echo '<b>server_used</b>: "'. self::$j. '"<br />'; echo '<b>folder</b>: "'. self::$w. '"<br />'; echo '<b>user_subpath</b>: "'. self::$u. '"<br />'; echo '<b>protocol_used</b>: "'. self::$h. '"<br />'; echo '<b>protocol</b>: "'. self::$i. '"<br />'; echo '<b>base_url_used</b>: "'. self::$g. '"<br />'; echo '<b>base_url</b>: "'. self::$base_url. '"<br />'; echo '</pre>'; die; } } class AeFileManager { private static $bv = null; private static $yv = null; private static $nv = null; private static $mv = [ '.', ]; private static $fv = [ '', LOGS_DIRNAME, BACKUP_DIRNAME, ]; private static $dv = [ '', CACHES_DIRNAME, BACKUP_DIRNAME, ]; private static $sv = [ PICTURES_DIRNAME, THUMBNAILS_DIRNAME, PICTURES_DIRNAME .'remote/', THUMBNAILS_DIRNAME .'remote/', VIDEO_DIRNAME, AUDIO_DIRNAME, AVATARS_DIRNAME, USERPIC_DIRNAME, ]; private static $av = [ 'updating.psa', ]; private static $qv = [ 'password-hash.psa', 'password-wait.psa', 'last-comment.psa', 'new-uploads.psa', 'settings.json', 'bsi.psa', 'auth.psa', 'scheduled.psa', 'license.psa', 'checklist.psa', ]; private static function ready () { return self::$bv !== null and self::$yv !== null and self::$nv !== null; } public static function writtenDirectories ($yv = null,$nv = null){ if (!self::ready ()) return []; if ($yv === null)$yv = self::$yv; if ($nv === null)$nv = self::$nv; $lv = self::$mv; foreach(self::$fv as $zv){ $lv[] = self::$bv . $zv; } foreach(self::$dv as $zv){ $lv[] = $yv . $zv; } foreach(self::$sv as $zv){ $lv[] = $nv . $zv; } $lv = array_unique ($lv); return $lv; } public static function writtenFiles ($yv = null,$nv = null){ if (!self::ready ()) return []; if ($yv === null)$yv = self::$yv; if ($nv === null)$nv = self::$nv; $kv = []; foreach(self::$av as $xv){ $kv[] = self::$bv . $xv; } foreach(self::$qv as $xv){ $kv[] = $yv . $xv; } $kv = array_unique ($kv); return $kv; } public static function setInstancePath ($bv){ self::$bv = $bv; } public static function setUserPath ($yv){ self::$yv = $yv; } public static function setMediaPath ($nv){ self::$nv = $nv; } public static function forceAllDirectories () { if (!self::ready ()) return false; foreach(self::writtenDirectories () as $ev){ @cq ($ev); } } public static function forceInstanceDirectories () { if (!self::ready ()) return false; foreach(self::$fv as $zv){ @cq (self::$bv . $zv); } } public static function forceUserDirectories ($yv = null){ if (!self::ready ()) return false; if ($yv === null)$yv = self::$yv; foreach(self::$dv as $zv){ @cq ($yv . $zv); } } public static function forceMediaDirectories ($nv = null){ if (!self::ready ()) return false; if ($nv === null)$nv = self::$nv; foreach(self::$sv as $zv){ @cq ($nv . $zv); } } public static function getPathsWithNoWritePermissions ($yv = null,$nv = null){ if (!self::ready ()) return []; if ($yv === null)$yv = self::$yv; if ($nv === null)$nv = self::$nv; clearstatcache (); $rv = []; foreach(self::writtenDirectories ($yv,$nv) as $tv){ if(is_dir ($tv) and !is_writable ($tv)) { $rv[] = $tv; } } foreach(self::writtenFiles ($yv,$nv) as $tv){ if(is_file ($tv) and !is_writable ($tv)) { $rv[] = $tv; } } return $rv; } } class AeLayoutDiversityManager { private static $layoutsUseIndexes = []; private static $layoutsUseIndex = 1; private static $layoutsUseMaxIndex = 1; public static function addLayoutsUsed ($jv){ self::$layoutsUseIndexes[$jv]=self::$layoutsUseIndex; self::$layoutsUseIndex ++; self::$layoutsUseMaxIndex ++; } public static function hasLayoutBeenUsed ($jv){ if (isset (self::$layoutsUseIndexes[$jv])) return true; } public static function getLayoutsUseRecency ($jv){ if (isset (self::$layoutsUseIndexes[$jv])) { return self::$layoutsUseIndexes[$jv]-self::$layoutsUseMaxIndex; } } } class AeMainMenuManager { private static $currentTags = []; private static $parentTags = []; static $isFavouritesCurrent = false; static $isFavouritesParent = false; static $isMostCommentedCurrent = false; static $isMostCommentedParent = false; static $isPopularCurrent = false; static $isPopularParent = false; static $isTagsCurrent = false; static $isTagsParent = false; static $isCalendarCurrent = false; static $isCalendarParent = false; public static function addCurrentTag ($hv){ self::$currentTags[] = $hv; } public static function addParentTag ($hv){ self::$parentTags[] = $hv; } public static function isCurrentTag ($hv){ if (!empty (self::$currentTags)) { return in_array ($hv,self::$currentTags); } return false; } public static function isParentTag ($hv){ if (!empty (self::$parentTags)) { return in_array ($hv,self::$parentTags); } return false; } } class AeModel { private static $gv = [ 'key' => "INT UNSIGNED AUTO_INCREMENT PRIMARY KEY", 'pkey' => "INT UNSIGNED DEFAULT '0' NOT NULL", 'pkey1' => "INT UNSIGNED DEFAULT '1' NOT NULL", 'int' => "INT DEFAULT '0' NOT NULL", 'uint' => "INT UNSIGNED DEFAULT '0' NOT NULL", 'time' => "INT UNSIGNED DEFAULT '0' NOT NULL", '0' => "TINYINT(1) DEFAULT '0' NOT NULL", '1' => "TINYINT(1) DEFAULT '1' NOT NULL", 'v1' => "VARCHAR(1) DEFAULT '' NOT NULL", 'v8' => "VARCHAR(8) DEFAULT '' NOT NULL", 'v15' => "VARCHAR(15) DEFAULT '' NOT NULL", 'v32' => "VARCHAR(32) DEFAULT '' NOT NULL", 'v39' => "VARCHAR(39) DEFAULT '' NOT NULL", 'v64' => "VARCHAR(64) DEFAULT '' NOT NULL", 'fid' => "VARCHAR(32) DEFAULT '". DEFAULT_FORMATTER ."' NOT NULL", 'v255' => "VARCHAR(255) DEFAULT '' NOT NULL", 'text' => "MEDIUMTEXT", ]; private static $wv = [ 'Actions' => [ ['ID', 'key'], ['SubsetID', 'pkey1'], ['EntityID', 'pkey'], ['Stamp', 'time'], ['ReadCount', 'int'], ], 'Aliases' => [ ['ID', 'key'], ['SubsetID', 'pkey1'], ['EntityType', 'v1'], ['EntityID', 'pkey'], ['Alias', 'v64'], ['Stamp', 'time'], ], 'Comments' => [ ['ID', 'key'], ['SubsetID', 'pkey1'], ['NoteID', 'pkey'], ['AuthorName', 'v255'], ['AuthorEmail', 'v255'], ['Text', 'text'], ['Reply', 'text'], ['IsVisible', '1'], ['IsFavourite', '0'], ['IsReplyVisible', '0'], ['IsReplyFavourite', '0'], ['IsAnswerAware', '1'], ['IsSubscriber', '0'], ['IsSpamSuspect', '0'], ['IsNew', '0'], ['Stamp', 'time'], ['LastModified', 'time'], ['ReplyStamp', 'time'], ['ReplyLastModified', 'time'], ['IP', 'v39'], ['IsGIPUsed', '0'], ['GIP', 'v15'], ['GIPAuthorID', 'v64'], ], 'GIPsSessions' => [ ['ID', 'key'], ['SubsetID', 'pkey1'], ['GIP', 'v15'], ['GIPAuthorID', 'v64'], ['AuthorName', 'v255'], ['AuthorEmail', 'v255'], ['AuthorProfileLink', 'v255'], ['SessionToken', 'v255'], ['Stamp', 'time'], ], 'Keywords' => [ ['ID', 'key'], ['SubsetID', 'pkey1'], ['Keyword', 'v255'], ['OriginalAlias', 'v64'], ['PageTitle', 'v255'], ['Description', 'text'], ['Summary', 'text'], ['Uploads', 'text'], ['IsVisible', '1'], ['IsFavourite', '0'], ], 'Notes' => [ ['ID', 'key'], ['SubsetID', 'pkey1'], ['Title', 'v255'], ['Text', 'text'], ['Summary', 'text'], ['FormatterID', 'fid'], ['OriginalAlias', 'v64'], ['Uploads', 'text'], ['IsPublished', '0'], ['IsCommentable', '0'], ['IsVisible', '1'], ['IsFavourite', '0'], ['Stamp', 'time'], ['LastModified', 'time'], ['Offset', 'int'], ['IsDST', '0'], ['IsIndexed', '0'], ['IsExternal', '0'], ['ReadCount', 'uint'], ['SourceID', 'pkey'], ['SourceNoteID', 'pkey'], ['SourceNoteURL', 'v255'], ['SourceNoteJSONURL', 'v255'], ['SourceNoteData', 'text'], ], 'NotesKeywords' => [ ['ID', 'key'], ['SubsetID', 'pkey1'], ['NoteID', 'pkey'], ['KeywordID', 'pkey'], ], 'Sources' => [ ['ID', 'key'], ['SubsetID', 'pkey1'], ['TrueID', 'pkey'], ['Title', 'v255'], ['AuthorName', 'v255'], ['URL', 'v255'], ['PictureURL', 'v255'], ['IsWhiteListed', '0'], ['IsTrusted', '0'], ], ]; private static $uv = [ 'Actions' => [ ['unique', ['EntityID','Stamp']], ['index', ['SubsetID']], ], 'Aliases' => [ ['index', ['SubsetID']], ['index', ['Alias']], ['index', ['EntityID']], ], 'Comments' => [ ['index', ['SubsetID']], ['index', ['NoteID']], ], 'GIPsSessions' => [ ['unique', ['SubsetID','GIP','GIPAuthorID']], ['index', ['SubsetID']], ], 'Keywords' => [ ['index', ['SubsetID']], ], 'Notes' => [ ['fulltext', ['Title','Text']], ['index', ['SubsetID']], ['index', ['Stamp']], ['index', ['SourceID']], ['index', ['SourceNoteID']], ], 'NotesKeywords' => [ ['index', ['SubsetID']], ['index', ['NoteID']], ], 'Sources' => [ ['index', ['SubsetID']], ], ]; private static $iv = [ 'index' => 'INDEX', 'unique' => 'UNIQUE INDEX', 'fulltext' => 'FULLTEXT', ]; private static $ov = [ 'index' => 'KEY', 'unique' => 'UNIQUE KEY', 'fulltext' => 'FULLTEXT KEY', ]; public static function unprefixedCoreTablesNames () { return array_keys (self::$wv); } public static function unprefixedEssentialTablesNames () { return [ 'Comments', 'Keywords', 'Notes', 'NotesKeywords', ]; } public static function assertUnprefixedTableName ($pv){ if (!array_key_exists ($pv,self::$wv)) { throw new LogicException ('Table "'. $pv .'" is not part of the model'); } } public static function columnsByUnprefixedTableName ($pv){ self::assertUnprefixedTableName ($pv); return self::$wv[$pv]; } public static function indexesByUnprefixedTableName ($pv){ self::assertUnprefixedTableName ($pv); return self::$uv[$pv]; } public static function softFieldsByUnprefixedTableName ($pv){ self::assertUnprefixedTableName ($pv); $cb = []; foreach(self::$wv[$pv] as $x){ if (!in_array ($x[1], ['key'])) { $cb[] = $x[0]; } } return $cb; } public static function columnsAndIndexesSQLByUnprefixedTableName ($pv){ self::assertUnprefixedTableName ($pv); $vb = []; foreach(self::columnsByUnprefixedTableName ($pv) as $bb){ list ($name,$yb)=$bb; $vb[] = "`". $name ."` ". self::expandColumnDefinition ($yb); } foreach(self::indexesByUnprefixedTableName ($pv) as $nb){ list ($type,$mb)=$nb; $fb = implode ('',$mb); $db = self::indexCreateSQLByIndexType ($type).' `'. $fb .'` (`'. implode ('`, `',$mb) .'`)'; $vb[] = $db; } return "(". implode (", ",$vb) .")"; } public static function expandColumnDefinition ($sb){ return self::$gv[$sb]; } public static function indexCheckSQLByIndexType ($ab){ return self::$ov[$ab]; } public static function indexCreateSQLByIndexType ($ab){ return self::$iv[$ab]; } } class AeNoteReadCountsProvider { private static $dataByNoteID = []; private static $hasRun = false; private static $sql = null; public static function setSQLRequestTemplateToMapIDsToReadCounts ($sql){ self::$sql = $sql; } public static function requestDeferredReadCountForNoteID ($noteID){ self::$dataByNoteID[$noteID]=true; } public static function getReadCountForNoteID ($noteID){ if(self::$sql === null) return false; if (!self::$hasRun)self :: run (); if (empty (self::$dataByNoteID[$noteID])) return false; return self::$dataByNoteID[$noteID]; } private static function run () { self::$hasRun = true; $qb = []; foreach(self::$dataByNoteID as$note_id => $lb){ $qb[] = "(`ID` = ". $note_id . ")"; } if (!count ($qb)) return; $qb = implode (' OR ',$qb); try { mm ( self::$sql ." AND (". $qb .")", 'get all requested read counts for notes' ); $zb = dm (); foreach ($zb as $kb){ self::$dataByNoteID[$kb['ID']] = $kb['ReadCount']; } } catch (AeMySQLException $e){ v3 ($e); if(Log::$a)__log ('Could not get requested read counts for notes'); } } } class AeNoteView { private $noteRecord = []; private $isCached = false; private $hasRun = false; private $cacheFilename = null; private $noteCTree = null; private $highlightedTags = null; private $cacheable = []; private $OGImages = []; private $wantRichText = false; private $wantCommentsLink = false; private $wantNewCommentsCount = false; private $wantReadHref = false; private $wantPreviewHref = false; private $wantControls = false; private $wantHiddenTags = false; private $wantSharingButtons = false; private $wantRelatedNotes = false; private $filterOutRelatedNoteIDs = []; private $useLocalHref = false; public function __construct ($noteRecord){ $this->noteRecord = $noteRecord; if(CACHE_NOTES){ $this->isCached = true; $this->cacheFilename = e2_note_cache_filename_with_id_($noteRecord['ID']); } } public function setHighlightedTags ($highlightedTags){ $this->highlightedTags = $highlightedTags; } public function setWantRichText ($wantRichText){ $this->wantRichText = $wantRichText; } public function setWantCommentsLink ($wantCommentsLink){ $this->wantCommentsLink = $wantCommentsLink; } public function setWantNewCommentsCount ($wantNewCommentsCount){ $this->wantNewCommentsCount = $wantNewCommentsCount; } public function setWantReadHref ($wantReadHref){ $this->wantReadHref = $wantReadHref; } public function setWantPreviewHref ($wantPreviewHref){ $this->wantPreviewHref = $wantPreviewHref; } public function setWantControls ($wantControls){ $this->wantControls = $wantControls; } public function setWantHiddenTags ($wantHiddenTags){ $this->wantHiddenTags = $wantHiddenTags; } public function setWantSharingButtons ($wantSharingButtons){ $this->wantSharingButtons = $wantSharingButtons; } public function setWantRelatedNotes ($wantRelatedNotes){ $this->wantRelatedNotes = $wantRelatedNotes; } public function setFilterOutRelatedNoteIDs ($filterOutRelatedNoteIDs){ $this->filterOutRelatedNoteIDs = $filterOutRelatedNoteIDs; } public function setUseLocalHref ($useLocalHref){ $this->useLocalHref = $useLocalHref; } public function getNoteCTree () { if (!$this->hasRun)$this -> run (); return$this->noteCTree; } private function prepareCacheableData () { $f = [ 'title' => function () { return dy ( htmlspecialchars ($this->noteRecord['Title'],ENT_NOQUOTES,'UTF-8') ); }, 'text-format-info' => function () { return ay ( $this->noteRecord['FormatterID'], $this->noteRecord['Text'], 'full' ); }, 'summary' => function () { if ((string)$this->noteRecord['Summary']!==''){ return dy (htmlspecialchars ($this->noteRecord['Summary'],ENT_NOQUOTES,'UTF-8')); } else { return bf ($this->cacheable['text-format-info']['text-final']); } }, 'comments-count' => function () { if (!$this->noteRecord['IsPublished']) { return false; } else { return ab ($this->noteRecord['ID']); } }, 'tags-data' => function () { $xb = ps ($this->noteRecord['ID']); $eb['ctree'] = []; $eb['all-resnames-uploads'] = []; foreach ($xb as $rb => $tb){ $eb['ctree'][] = [ 'visible?' => (bool)$tb['IsVisible'], 'name' => htmlspecialchars ($tb['Keyword'],ENT_NOQUOTES,'UTF-8'), 'href' => qq ('e2m_tag', array ('*tag' => $tb)), ]; $eb['all-resnames-uploads']=array_merge ( $eb['all-resnames-uploads'], g3 ('tag',$tb['ID']) ); } $eb['all-resnames-uploads']=array_unique ( $eb['all-resnames-uploads'] ); return $eb; }, ]; if($this->isCached and is_file ($this->cacheFilename)) { $this->cacheable = @unserialize (file_get_contents ($this->cacheFilename)) or $this->cacheable = []; } $k = false; foreach ($f as $x => $e_){ if (!array_key_exists ($x,$this->cacheable)) { if(Log::$a)__log ('Build cache: "'. $x .'"'); $this->cacheable[$x]=$e_ (); $k = true; } else { if(Log::$a)__log ('Retrieved from cache: "'. $x .'"'); } } if($this->isCached and $k){ e3 ($this->cacheFilename,serialize ($this->cacheable)); } } private function run () { $this->hasRun = true; if(Log::$a)__log ('AeNoteView run {'); if(Log::$a)__log ('Cacheable data {'); $this -> prepareCacheableData (); if(Log::$a)__log ('}'); if(Log::$a)__log ('Uncacheable data {'); $jb = false; if($this->noteRecord['IsPublished']) { if ((string)$this->noteRecord['OriginalAlias']!==''){ $jb = qq ('e2m_note', ['alias' => $this->noteRecord['OriginalAlias']]); } else { $hb = $this->noteRecord; $hb['__force_ymdn']=true; $jb = qq ('e2m_note', ['*note' => $hb]); } } $gb = ha ($this->noteRecord); $wb = [(int)$this->noteRecord['LastModified'],$gb]; $l = ( $this->noteRecord['IsPublished'] ? [(int)$this->noteRecord['Stamp'],$gb]:$wb ); $ub = yf ($this->noteRecord); $ib = @$this->cacheable['text-format-info']['meta']['resources-detected']; if (!is_array ($ib))$ib = []; if(count ($ib)) { j2 ($ib); } $ob = a2 ($ib); $pb = @unserialize ($this->noteRecord['Uploads']) or $pb = []; $c3 = array_merge ( q2 ( $ib,$pb ), $this->cacheable['tags-data']['all-resnames-uploads'] ); $v3 = t3 ($c3); $b3 = a2 ($c3); $y3 = $this->noteRecord['SourceNoteData']; $y3 = @json_decode ($y3,true); $n3 = @$y3['og_images'][0] or $n3 = ''; if($this->noteRecord['IsExternal']) { $m3 = py ($this->noteRecord); } else { $m3 = []; } $f3 = false; $d3 = $this->cacheable['tags-data']['ctree']; foreach ($d3 as $s3 => $a3){ if($this->highlightedTags !== null){ $d3[$s3]['current?']=in_array ($d3[$s3]['name'],$this->highlightedTags); } if (!$this->wantHiddenTags and !$d3[$s3]['visible?']) { unset ($d3[$s3]); } } if($this->wantSharingButtons and $ub === 'public'){ $q3 = ws ($v3); } else { $q3 = false; } if($this->wantNewCommentsCount){ $l3 = sb ($this->noteRecord['ID']); } else { $l3 = false; } $this->noteCTree = [ 'id' => (int)$this->noteRecord['ID'], 'title' => (string)$this->cacheable['title'], 'href' => qq ('e2m_note', ['*note' => $this->noteRecord]), 'href-original' => $jb, 'time' => $l, 'last-modified' => $wb, 'text' => (string)$this->cacheable['text-format-info']['text-final'], 'format-info' => $this->cacheable['text-format-info']['meta'], 'summary' => (string)$this->cacheable['summary'], 'snippet-text' => (string)$this->cacheable['summary'], 'draft?' => $ub === 'draft', 'scheduled?' => $ub === 'scheduled', 'public?' => $ub === 'public', 'hidden?' => $ub === 'hidden', 'current?' => false, 'favourite?' => (bool) ($this->noteRecord['IsFavourite'] and $ub !== 'draft'), 'images' => l2 ($ob), 'thumbs' => z2 ($ob), 'source-main-image-url' => (string)$n3, 'og-images' => $v3, 'og-images-thumbs' => z2 ($b3), 'tags' => $d3, 'sharing-buttons' => $q3, 'related' => $f3, 'read-href' => ($this->wantReadHref and $this->noteRecord['IsPublished'])? qq ('e2m_note_read', ['*note' => $this->noteRecord]) : false, 'preview-href' => ($this->wantPreviewHref and ($ub !== 'public'))? qq ('e2m_note', [ '*note' => $this->noteRecord, 'preview-key' => ff ($this->noteRecord) ]) : false, 'comments-count' => $this->cacheable['comments-count'], 'comments-count-text' => is_int ($this->cacheable['comments-count'])? e2l_get_string ('gs--n-comments', [ 'number' => $this->cacheable['comments-count'] ]) : '', 'new-comments-count' => $l3, 'new-comments-count-text' => is_int ($l3)? e2l_get_string ('gs--comments-n-new', [ 'number' => $l3 ]) : '', 'comments-link?' => (bool) ( $this->wantCommentsLink and $this->noteRecord['IsPublished'] and ( xb ($this->noteRecord) or ($this->cacheable['comments-count']>0) ) ), ]; if($this->noteRecord['IsExternal']) { $this->noteCTree = array_merge ($this->noteCTree,$m3); $this->noteCTree['href-original']=$this->noteCTree['href-external']; if (!$this->useLocalHref){ $this->noteCTree['href']=$this->noteCTree['href-external']; } } if($this->wantControls){ $this->noteCTree['edit-href']=qq ( 'e2m_note_edit', array ('*note' => $this->noteRecord) ); if($this->noteRecord['IsPublished'] and !$this->noteRecord['IsVisible']) { $this->noteCTree['show-action']=qq ('e2s_note_flag', [ '*note' => $this->noteRecord, 'flag' => 'IsVisible', 'value' => 1 ]); } if($this->noteRecord['IsPublished']) { $this->noteCTree['favourite-toggle-action']=qq ( 'e2s_note_flag_favourite', [ '*note' => $this->noteRecord, 'value' => !$this->noteRecord['IsFavourite'] ] ); } } $this->noteCTree['href-comments']=$this->noteCTree['href'] .'#comments'; if(Log::$a)__log ('}'); AeNoteReadCountsProvider :: requestDeferredReadCountForNoteID ($this->noteRecord['ID']); if(Log::$a)__log ('}'); } } class AePageableNotesView { private $candy; private $parameters; private $pageExists = false; private $isCached = false; private $hasRun = false; private $sql = null; private $sql_count = null; private $highlightedTags = null; private $cacheFilename = null; private $prevPageTitle = null; private $nextPageTitle = null; private $totalNotes = null; private $totalPages = null; private $notesCTree = null; private $pagesCTree = null; private $wantPaging = false; private $wantNewCommentsCount = false; private $wantReadHrefs = false; private $wantPreviewHrefs = false; private $wantControls = false; private $wantHiddenTags = false; private $wantRelatedNotes = false; private $useLocalHrefs = false; private $page = 1; private $limit = 10; public function __construct ($candy,$parameters){ $this->candy = $candy; $this->parameters = $parameters; if (empty ($parameters['page'])) { $this->page = 1; } else { $this->page = (int)$parameters['page']; } } public function setSQLCountRequest ($sql_count){ if(strpos ($sql_count,"SELECT COUNT(*) Total FROM ")!==0){ die ('AePageableNotesView: Count request must start with "SELECT COUNT(*) Total FROM "'); } $this->sql_count = $sql_count; } public function setLimitlessSQLRequest ($sql){ if(strstr ($sql,"LIMIT")) { die ('AePageableNotesView: Request must not contain "LIMIT"'); } $this->sql = $sql; if($this->sql_count === null){ if(strpos ($sql,"SELECT * ")===0){ $this->sql_count = "SELECT COUNT(*) Total ". substr ($sql,9); } else { die ('AePageableNotesView: setSQLCountRequest () must be used'); } } } public function setPortionSize ($limit){ $this->limit = abs ((int)$limit); } public function setNextPrevPageTitles ($nextPageTitle,$prevPageTitle){ $this->nextPageTitle = $nextPageTitle; $this->prevPageTitle = $prevPageTitle; } public function setHighlightedTags ($highlightedTags){ $this->highlightedTags = $highlightedTags; } public function setCacheFilename ($cacheFilename){ $this->isCached = true; $this->cacheFilename = $cacheFilename; } public function setWantPaging ($wantPaging){ $this->wantPaging = $wantPaging; } public function setWantNewCommentsCount ($wantNewCommentsCount){ $this->wantNewCommentsCount = $wantNewCommentsCount; } public function setWantReadHrefs ($wantReadHrefs){ $this->wantReadHrefs = $wantReadHrefs; } public function setWantPreviewHrefs ($wantPreviewHrefs){ $this->wantPreviewHrefs = $wantPreviewHrefs; } public function setWantControls ($wantControls){ $this->wantControls = $wantControls; } public function setWantHiddenTags ($wantHiddenTags){ $this->wantHiddenTags = $wantHiddenTags; } public function setWantRelatedNotes ($wantRelatedNotes){ $this->wantRelatedNotes = $wantRelatedNotes; } public function setUseLocalHrefs ($useLocalHrefs){ $this->useLocalHrefs = $useLocalHrefs; } public function isExistingPage () { if (!$this->hasRun)$this -> run (); return$this->pageExists; } public function isFirstPage () { return$this->page === 1; } public function isFirstPageOfEmptyView () { if (!$this->hasRun)$this -> run (); return$this->page === 1 and $this->totalPages === 0; } public function getTotalNotes () { if (!$this->hasRun)$this -> run (); return$this->totalNotes; } public function getTotalPages () { if (!$this->hasRun)$this -> run (); return$this->totalPages; } public function getNotesCTree () { if (!$this->hasRun)$this -> run (); return$this->notesCTree; } public function getPagesCTree () { if (!$this->hasRun)$this -> run (); return$this->pagesCTree; } private function prepareCacheableData () { $this->totalNotes = 0; if($this->limit){ $z3 = ($this->page - 1)*$this->limit; $this->sql .= ' LIMIT '. $z3 .', '. $this->limit; } mm ($this->sql_count,'count total notes of "'. $this->candy .'" list'); $k3 = dm (); $this->totalNotes = $k3 ? (int)$k3[0]['Total']:0; mm ($this->sql,'get limited full notes "'. $this->candy .'" list'); $x3 = dm (); $e3 = []; foreach ($x3 as $s3 => $s){ $e3[] = $s['ID']; } $this->notesCTree = []; foreach ($x3 as $s3 => $s){ $noteView = new AeNoteView ($s); $noteView -> setWantNewCommentsCount ($this->wantNewCommentsCount); $noteView -> setWantReadHref ($this->wantReadHrefs); $noteView -> setWantPreviewHref ($this->wantPreviewHrefs); $noteView -> setWantControls ($this->wantControls); $noteView -> setWantHiddenTags ($this->wantHiddenTags); $noteView -> setWantCommentsLink (true); $noteView -> setWantRelatedNotes ($this->wantRelatedNotes); $noteView -> setFilterOutRelatedNoteIDs ($e3); $noteView -> setHighlightedTags ($this->highlightedTags); $noteView -> setUseLocalHref ($this->useLocalHrefs); $this->notesCTree[] = $noteView -> getNoteCTree (); } $this->pagesCTree = []; if ( $this->limit and $this->totalPages = (int)ceil ($this->totalNotes / $this->limit) ) { $this->pagesCTree['timeline?']=true; $this->pagesCTree['count'] = (int)$this->totalPages; $this->pagesCTree['this'] = (int)$this->page; if($this->wantPaging){ $this->pagesCTree['earlier-title']=$this->nextPageTitle; $this->pagesCTree['later-title']=$this->prevPageTitle; $r3 = $this->parameters; if($this->page < $this->totalPages){ $r3['page']=$this->page + 1; $this->pagesCTree['earlier-href']=qq ($this->candy,$r3); } if($this->page > 1){ $r3['page']=$this->page - 1; $this->pagesCTree['later-href']=qq ($this->candy,$r3); } } } } private function run () { $this->hasRun = true; if($this->isCached and is_file ($this->cacheFilename)) { $t3 = @unserialize (file_get_contents ($this->cacheFilename)); $this->totalNotes = @$t3['notes_total']; $this->notesCTree = @$t3['notes_ctree']; $this->pagesCTree = @$t3['pages_ctree']; $this->totalPages = @$this->pagesCTree['count']; } if ( is_int ($this->totalNotes) and is_array ($this->notesCTree) and is_array ($this->pagesCTree) and is_int ($this->totalPages) ) { if(Log::$a)__log ('Retrieved cached CTree'); } else { $this -> prepareCacheableData (); if($this->isCached){ e3 ($this->cacheFilename,serialize ([ 'notes_total' => $this->totalNotes, 'notes_ctree' => $this->notesCTree, 'pages_ctree' => $this->pagesCTree, ])); } } foreach($this->notesCTree as $j3){ AeNoteReadCountsProvider :: requestDeferredReadCountForNoteID ($j3['id']); if (empty ($j3['related']['each'])) continue; foreach ($j3['related']['each'] as $h3){ AeNoteReadCountsProvider :: requestDeferredReadCountForNoteID ($h3['id']); } } $this->pageExists = ( $this->totalPages > 0 and $this->page >= 1 and $this->page <= $this->totalPages ); } } class AeRequest { public static $method = 'GET'; public static $url = ''; public static $candy = ''; public static $parameters = []; public function __construct ($p,$g3){ $this->method = $p['REQUEST_METHOD']; $w3 = urldecode ($g3['go']); if(substr ($w3,0,strlen (AeEnv::$u)) === AeEnv::$u){ $w3 = substr ($w3,strlen (AeEnv::$u)); } $this->url = ( AeEnv::$h .'://'. AeEnv::$j . AeEnv::$w . AeEnv::$u . '/'. $w3 ); list ($this->candy,$this->parameters)=lq ($w3); } public function toBeFulfilledByService () { return substr ($this->candy,0,4)=='e2s_'; } public function requiresInstallation () { return !in_array ($this->candy, [ 'e2s_build', 'e2m_info', 'e2m_install', 'e2j_check_db_config', 'e2j_list_databases', 'e2s_instantiate', 'e2s_install', ]); } public function requiresVersionMatch () { return$this->requiresInstallation(); } public function requiresScheduleCheckBeforeServing () { return$this->requiresInstallation(); } public function shouldSlowDownAJAXResponse () { return in_array ($this->candy, [ 'e2j_check_db_config', 'e2j_list_databases', 'e2j_check_password', 'e2j_userpic_upload', 'e2j_userpic_remove', 'e2j_file_upload', 'e2j_file_remove', 'e2j_note_livesave', 'e2s_note_flag_favourite', 'e2s_comment_flag_ajax', 'e2s_tag_flag_ajax', ]); } public function requiresSignIn () { return ( !empty ($this->candy) and is_callable ($this->candy) and $this->requiresInstallation () and !in_array ($this->candy, [ 'e2m_info', 'e2m_frontpage', 'e2m_rss', 'e2m_json', 'e2m_note', 'e2m_note_json', 'e2m_note_read', 'e2m_tags', 'e2m_tag', 'e2m_untagged', 'e2m_tag_rss', 'e2m_tag_json', 'e2m_popular', 'e2m_favourites', 'e2m_most_commented', 'e2m_found', 'e2m_comments', 'e2m_everything', 'e2m_sitemap_xml', 'e2m_year', 'e2m_month', 'e2m_day', 'e2m_unsubscribe', 'e2m_theme_preview', 'e2m_error404', 'e2m_password_reset', 'e2s_password_reset_email', 'e2m_password', 'e2s_password_save', 'e2s_sign_in', 'e2m_sign_out', 'e2m_gip_sign_in', 'e2m_gip_sign_in_callback', 'e2m_gip_sign_out', 'e2s_comment_process', 'e2s_search', 'e2s_bsi_step', 'e2j_check_password', 'e2s_retrieve', 'e2s_notify', 'e2s_dump', ]) ); } public function allowedInReadOnlyMode () { return !in_array ($this->candy, [ 'e2m_write', 'e2m_note_edit', 'e2s_note_process', 'e2s_note_publish', 'e2s_note_delete', 'e2s_note_flag_favourite', 'e2s_note_flag', 'e2m_comment_edit', 'e2m_comment_delete', 'e2m_comment_reply', 'e2m_comment_reply_delete', 'e2m_comment_flag', 'e2s_comment_flag_ajax', 'e2m_unsubscribe', 'e2s_comment_process', 'e2m_settings', 'e2m_timezone', ]); } public function replaceWith ($u3){ $this->candy = $u3; } } function c () { global$_config; $i3 = [ 'new-note-href' => qq ('e2m_write'), 'drafts-href' => qq ('e2m_drafts', ['page' => 1]), 'drafts-count' => (int)vf (false,true), 'settings-href' => qq ('e2m_settings'), 'theme-preview-href' => qq ('e2m_theme_preview', array ('theme' => '')), 'password-href' => qq ('e2m_password', array ('recovery-key' => '')), 'database-href' => qq ('e2m_database'), 'timezone-href' => qq ('e2m_timezone'), 'sessions-href' => qq ('e2m_sessions'), 'sign-out-href' => qq ('e2m_sign_out'), ]; if (hs ()) { $i3['get-backup-href']=qq ('e2m_get_backup'); } if (@$_config['read_only']) { unset ($i3['new-note-href']); unset ($i3['settings-href']); unset ($i3['timezone-href']); } if (!$_config['allow_themes_preview']) { unset ($i3['theme-preview-href']); } $databaseConfiguration = iq (); if($databaseConfiguration->source !== 'settings' or !$_config['allow_db_config']) { unset ($i3['database-href']); } list ($l3,$o3,$p3)=lb (); if ($l3){ $i3['new-comments-count']=$l3; $i3['new-comments-href']=$p3; } return $i3; } function v ($cy,AeDatabaseConfiguration $databaseConfiguration,$vy){ static $by = null; $yy = ( $cy === USER_DIR and $databaseConfiguration == iq () ); if ($vy){ if ($cy !== false){ @unlink ($cy . CACHE_FILENAME_ALIASMAP); } if ($yy)$by = null; return; } if ($yy and is_array ($by)) { return $by; } $ny = null; if(CACHE_ALIASMAP and is_file ($cy . CACHE_FILENAME_ALIASMAP)) { $ny = @unserialize (file_get_contents ($cy . CACHE_FILENAME_ALIASMAP)); } if(is_array ($ny)) { if ($yy)$by = $ny; return $ny; } if(Log::$a)__log ('Build aliasmap {'); $ny = []; fm ( $databaseConfiguration, "SELECT `EntityType`, `EntityID`, `Alias` ". "FROM `". $databaseConfiguration -> getPrefix () . "Aliases` ". "WHERE `SubsetID`=". $databaseConfiguration -> getSubset () ." ". "AND `Stamp` IN (". "SELECT MAX(`Stamp`) `MaxStamp` ". "FROM `". $databaseConfiguration -> getPrefix () . "Aliases` ". "WHERE `SubsetID`=". $databaseConfiguration -> getSubset () ." ". "GROUP BY `EntityType`, `EntityID`". ")", 'get all active aliases' ); foreach (dm () as $my){ $fy = $my['EntityType'].$my['EntityID']; $ny[$fy]=$my['Alias']; } fm ( $databaseConfiguration, "SELECT `ID`, `Stamp`, `Offset`, `IsDST`, `OriginalAlias` ". "FROM `". $databaseConfiguration -> getPrefix () . "Notes` ". "WHERE `SubsetID`=". $databaseConfiguration -> getSubset () ." ". "AND `IsPublished` = 1 ". "ORDER BY `Stamp`", 'get all notes to cache y/d/m/n urls' ); $dy = 0; $sy = false; foreach (dm () as $ay){ $fy = 'n'. $ay['ID']; $qy = pa ( 'Y/m/d',$ay['Stamp'],ha ($ay) ); if ($qy !== $sy)$dy = 0; $dy ++; $ly = $qy .'/'. $dy; if (empty ($ny[$fy])) { $ny[$fy]=$ly; } else { if ((string)$ay['OriginalAlias']===''){ $ny[$fy . '-ymdn']=$ly; } } $sy = $qy; } fm ( $databaseConfiguration, "SELECT `ID`, `OriginalAlias` ". "FROM `". $databaseConfiguration -> getPrefix () . "Keywords` ". "WHERE `SubsetID`=". $databaseConfiguration -> getSubset (), 'get original active aliases for tags' ); foreach (dm () as $tb){ $fy = 't'. $tb['ID']; if (empty ($ny[$fy])) { $ny[$fy]=$tb['OriginalAlias']; } } if(CACHE_ALIASMAP)e3 ($cy . CACHE_FILENAME_ALIASMAP,serialize ($ny)); if ($yy)$by = $ny; if(Log::$a)__log ('}'); return $ny; } function b ($vy = false){ return v (USER_DIR,iq (), $vy); } function e2_alias_of_note_with_id_($zy){ $ky = b () ['n'. $zy]; if(preg_match ( '/^(?P<year>\d{4})\/(?P<month>\d{1,2})\/(?P<day>\d{1,2})\/(?P<day_number>\d+)$/s', $ky ))$ky = ''; return $ky; } function e2ali__alias_from_title_($source){ global$_config; $xy = $source; if(array_key_exists ('autoreplace_for_aliases',$_config)) { $xy = strtr ( $xy, $_config['autoreplace_for_aliases'] ); } $xy = k1 ($xy); $xy = str_replace ('\'','',$xy); $xy = str_replace ('’','',$xy); $xy = str_replace (chr (146),'',$xy); $ey = ''; for ($rb = 0; $rb < strlen ($xy); ++ $rb){ if ( (ord ($xy[$rb]) >= 48 and ord ($xy[$rb]) <= 57) or (ord ($xy[$rb]) >= 65 and ord ($xy[$rb]) <= 90) or (ord ($xy[$rb]) >= 97 and ord ($xy[$rb]) <= 122) or 0 ) { $ey .= $xy[$rb]; } else { $ey .= '-'; } } $ey = preg_replace ('/\-+/','-',$ey); $ey = trim ($ey,'-'); $ey = strtolower ($ey); if ($ey == '-')$ey = ''; $ey = substr ($ey,0,ALIAS_MAX_LENGTH); return $ey; } function m (AeDatabaseConfiguration $databaseConfiguration,$ky){ if ((string)$ky === '') return false; fm ( $databaseConfiguration, "SELECT * FROM `". $databaseConfiguration -> getPrefix () . "Aliases` ". "WHERE `SubsetID`=". $databaseConfiguration -> getSubset () ." ". "AND `Alias` = '". $ky ."' ". "ORDER BY `Stamp` LIMIT 1", 'get alias record for alias "'. $ky .'"' ); $x3 = dm (); if(count ($x3)==1){ return $x3[0]; } else { return false; } } function f ($ky){ if ((string)$ky === '') return false; if(Log::$a)__log ('Get entity type and id from alias "'. $ky .'"'); $ry = @array_flip (b ()); $fy = (string) @$ry[$ky]; if ( strlen ($fy)>0 and ($fy[0]=='n' or $fy[0]=='t') ) { $kb = [ 'type' => $fy[0], 'id' => (int)substr ($fy,1) ]; return $kb; } $my = m (iq (), $ky); if (!$my) return false; $kb = [ 'type' => $my['EntityType'], 'id' => (int)$my['EntityID'], ]; if(Log::$a)__log ('Got entity type "'. $kb['type'] .'" and id "'. $kb['id'] .'"'); return $kb; } function d ( $cy,AeDatabaseConfiguration $databaseConfiguration, $gy,$hy,$ty,$source,$jy = 1 ){ if(Log::$a)__log ('Aliases: "'. $gy .'" available alias for source "'. $source. '"'); $wy = $hy . $ty; if ($gy === 'set' and $wy === '') return false; $ey = e2ali__alias_from_title_($source); if($source !== '' and $ey === ''){ $ey = (string)$jy; } elseif ($jy > 1){ $uy = '-'. $jy; $ey = substr ($ey,0,ALIAS_MAX_LENGTH - strlen ($uy)) . $uy; } $ny = v ($cy,$databaseConfiguration,false); if ($my = m ($databaseConfiguration,$ey)) { $iy = $my['EntityType'].$my['EntityID']; if ( $wy === $iy or $ey !== $ny[$iy] ) { if ($gy == 'find') return $ey; if ($gy == 'set'){ if(Log::$a)__log ('Aliases: update alias timestamp'); ym ($databaseConfiguration,'Aliases', [ 'ID' => $my['ID'], 'EntityType' => $hy, 'EntityID' => $ty, 'Alias' => $ey, 'Stamp' => time (), ]); v ($cy,$databaseConfiguration,true); return $ey; } } else { return d ($cy,$databaseConfiguration,$gy,$hy,$ty,$source,$jy + 1); } } else { if ($wy !== '' and $ey == ''){ if(preg_match ( '/(?P<year>\d{4})\/(?P<month>\d{1,2})\/(?P<day>\d{1,2})\/(?P<day_number>\d+)/', $ny [$wy] )) { if(Log::$a)__log ('Aliases: d/m/y/n was already used for this entity'); return ''; } } if(Log::$a)__log ('Aliases: it’s an empty alias, and it was not being used for this entity'); if ( $hy == 't' and $oy = da ($databaseConfiguration,$ey) ) { if ($oy['ID']!=$ty){ return d ($cy,$databaseConfiguration,$gy,$hy,$ty,$source,$jy + 1); } } if ($gy == 'find') return $ey; if ($gy == 'set'){ bm ($databaseConfiguration,'Aliases', [ 'EntityType' => $hy, 'EntityID' => $ty, 'Alias' => $ey, 'Stamp' => time (), ]); v ($cy,$databaseConfiguration,true); return $ey; } } return ''; } function e2_delete_aliases_for_entity_($type,$zy){ global$_config; mm ( "DELETE FROM `". $_config['db_table_prefix']."Aliases` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `EntityType` = '". $type ."' ". "AND `EntityID`=". ((int)$zy), 'delete aliases of note' ); } function a () { static $py; $cn = ss (); if (empty ($py)) { $py = md5 (AeEnv::$o .'email'. $cn); } return $py; } function q () { static $vn; $cn = ss (); if (empty ($vn)) { $vn = md5 (AeEnv::$o .'nospam'. $cn . date ('n-Y')); } return $vn; } function l () { static $bn; $cn = ss (); if(empty($bn)) { $bn = md5 (AeEnv::$o .'nospam'. $cn . date ('n-Y',strtotime('-1 month'))); } return $bn; } function z ($note_id){ $cn = ss (); return q1 ('comment_'. md5 (AeEnv::$o .'nospam_cookie'. $cn . $note_id)); } function k () { $yn = $_SERVER['HTTP_USER_AGENT']; $cn = ss (); return md5 (AeEnv::$o .'nospam_cookie'. $cn . $yn); } function x () { if ( array_key_exists ('email',$_POST) and $_POST['email']!=='' ) return true; $vn = q (); $bn = l (); if ( !array_key_exists ($vn,$_POST) and !array_key_exists ($bn,$_POST) ) return true; if ( ( array_key_exists ($vn,$_POST) and $_POST[$vn]!=='' ) or ( array_key_exists ($bn,$_POST) and $_POST[$bn]!=='' ) ) return true; if ( !array_key_exists ('comment',$_POST) or (strlen ($_POST['comment']) > 6) ) return true; return false; } function e2_cookie_data_is_spam_suspicios_for_note_id_($note_id){ if ( !array_key_exists (z ($note_id),$_COOKIE) or ($_COOKIE[z ($note_id)] !== k ()) ) return true; return false; } function e2m_year ($parameters = array ()) { global$_strings,$_config; $nn = $parameters['year']; $mn = e2l_get_string ('pt--nth-year', array ('year' => $nn)); if (!j ($nn)) { return e2m_error404 (); } AeMainMenuManager :: $isCalendarCurrent = false; AeMainMenuManager :: $isCalendarParent = true; $fn_ = gmmktime (0,0,0,1,1,$nn - 1); $dn = gmmktime (0,0,0,1,1,$nn + 1); list ($sn,$an)=e2__fruitful_neighbours_with_ymd_($nn); $qn = 'e2m_year'; if ($sn){ $ln['prev-href']=qq ( $qn,e2__parameters_with_timestamp_($sn) ); $ln['prev-jump?'] = (bool) (gmdate ('Y',$fn_)!=gmdate ('Y',$sn)); $ln['prev-title']=gmdate ('Y',$sn); } if ($an){ $ln['next-href']=qq ( $qn,e2__parameters_with_timestamp_($an) ); $ln['next-jump?'] = (bool) (gmdate ('Y',$dn)!=gmdate ('Y',$an)); $ln['next-title']=gmdate ('Y',$an); } $ln['timeline?']=false; $ln['this']=$nn; $ln['this-title']=$nn; list ($zn,$kn)=n1 ($nn); $cb = [ 'title' => $mn, 'heading' => $mn, 'pages' => $ln, 'year' => (int)$nn, 'calendar' => t ($nn,false,false), ]; mm ( "SELECT * FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished` = 1 ". nf (cs ()). "AND `Stamp` BETWEEN ". $zn ." ". "AND ". $kn ." ". "ORDER BY `Stamp`", 'get all notes for the year' ); $x3 = dm (); $xn = w (true,$x3,$nn); if(count ($xn)) { $cb['notes-list']=$xn; } else { $cb['nothing']=$_strings['gs--no-such-notes']; } return $cb; } function e2m_month ($parameters = array ()) { global$_strings,$_config; $nn = $parameters['year']; $en = $parameters['month']; $mn = e2l_get_string ( 'pt--nth-month-of-nth-year', array ('year' => $nn,'month' => $en) ); if (!j ($nn,$en)) { return e2m_error404 (); } AeMainMenuManager :: $isCalendarCurrent = false; AeMainMenuManager :: $isCalendarParent = true; $fn_ = gmmktime (0,0,0,$en - 1,1,$nn); $dn = gmmktime (0,0,0,$en + 1,1,$nn); list ($sn,$an)=e2__fruitful_neighbours_with_ymd_($nn,$en); $qn = 'e2m_month'; if ($sn){ $ln['prev-href']=qq ( $qn,e2__parameters_with_timestamp_($sn) ); $ln['prev-jump?'] = (bool) (gmdate ('Y/m',$fn_)!=gmdate ('Y/m',$sn)); $ln['prev-title']=e2l_get_string ( 'gs--nth-month-of-nth-year', array ( 'year' => gmdate ('Y',$sn),'month' => gmdate ('n',$sn) ) ); } if ($an){ $ln['next-href']=qq ( $qn,e2__parameters_with_timestamp_($an) ); $ln['next-jump?'] = (bool) (gmdate ('Y/m',$dn)!=gmdate ('Y/m',$an)); $ln['next-title']=e2l_get_string ( 'gs--nth-month-of-nth-year', array ( 'year' => gmdate ('Y',$an),'month' => gmdate ('n',$an) ) ); } $ln['timeline?']=false; $ln['this-title']=$mn; list ($zn,$kn)=n1 ($nn,$en); $cb = [ 'title' => $mn, 'heading' => $mn, 'calendar' => t ($nn,$en,false), 'pages' => $ln, 'year' => (int)$nn, 'month' => (int)$en, ]; mm ( "SELECT * FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished` = 1 ". nf (cs ()). "AND `Stamp` BETWEEN ". $zn ." ". "AND ". $kn ." ". "ORDER BY `Stamp`", 'get all notes for the month' ); $x3 = dm (); $xn = w (true,$x3,$nn,$en); if(count ($xn)) { $cb['notes-list']=$xn; } else { $cb['nothing']=$_strings['gs--no-such-notes']; } return $cb; } function e2m_day ($parameters = array ()) { global$_strings,$_config,$_current_url; $nn = (int)$parameters['year']; $en = (int)$parameters['month']; $rn = (int)$parameters['day']; if (!(j ($nn,$en,$rn))) { return e2m_error404 (); } AeMainMenuManager :: $isCalendarCurrent = false; AeMainMenuManager :: $isCalendarParent = true; if($_current_url === p ()) { AeMainMenuManager :: $isCalendarCurrent = true; AeMainMenuManager :: $isCalendarParent = false; } $mn = e2l_get_string ( 'pt--nth-day-of-nth-month-of-nth-year', array ('year' => $nn,'month' => $en,'day' => $rn) ); $fn_ = gmmktime (0,0,0,$en,$rn - 1,$nn); $dn = gmmktime (0,0,0,$en,$rn + 1,$nn); list ($sn,$an)=e2__fruitful_neighbours_with_ymd_($nn,$en,$rn); $qn = 'e2m_day'; if ($sn){ $ln['prev-href']=qq ( $qn,e2__parameters_with_timestamp_($sn) ); $ln['prev-jump?'] = (bool) (gmdate ('Y/m/d',$fn_)!=gmdate ('Y/m/d',$sn)); $ln['prev-title']=e2l_get_string ( 'gs--nth-day-of-nth-month-of-nth-year', array ( 'year' => gmdate ('Y',$sn),'month' => gmdate ('n',$sn),'day' => gmdate ('j',$sn), ) ); } if ($an){ $ln['next-href']=qq ( $qn,e2__parameters_with_timestamp_($an) ); $ln['next-jump?'] = (bool) (gmdate ('Y/m/d',$dn)!=gmdate ('Y/m/d',$an)); $ln['next-title']=e2l_get_string ( 'gs--nth-day-of-nth-month-of-nth-year', array ( 'year' => gmdate ('Y',$an),'month' => gmdate ('n',$an),'day' => gmdate ('j',$an), ) ); } $ln['timeline?']=false; $ln['this-title']=$mn; $cb = [ 'title' => $mn, 'heading' => $mn, 'pages' => $ln, 'calendar' => t ($nn,$en,$rn), ]; $x3 = wm ($nn,$en,$rn); $x3 = array_reverse ($x3); $tn = cs (); $xn = []; foreach ($x3 as $s3 => $ay){ if (!( yf ($ay)==='public' or ($tn and $ay['IsPublished']) )) continue; $noteView = new AeNoteView ($ay); $noteView -> setWantNewCommentsCount ($tn); $noteView -> setWantReadHref ($_config['count_reads']); $noteView -> setWantControls ($tn and !@$_config['read_only']); $noteView -> setWantHiddenTags ($tn); $noteView -> setWantCommentsLink (true); $xn[] = $noteView -> getNoteCTree (); } if(count ($xn)) { $cb['notes']=$xn; } else { $cb['nothing']=$_strings['gs--no-such-notes']; } return $cb; } function r ($jn){ global$_config; $xn = null; if(CACHE_FULLLIST and is_file (USER_DIR . CACHE_FILENAME_FULLLIST)) { $xn = @unserialize (file_get_contents (USER_DIR . CACHE_FILENAME_FULLLIST)); if(Log::$a)__log ('Retrieving full notes list from cache...'); } if (!is_array ($xn)) { if(Log::$a)__log ('Retrieving full notes list from database...'); mm ( "SELECT `ID`, `Title`, `Stamp`, `LastModified`, `Offset`, `IsDST`, ". "`IsFavourite`, `IsPublished`, `IsVisible`, `SourceNoteURL`, `OriginalAlias` ". "FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished` = 1 ". nf (). "ORDER BY `Stamp`", 'get full notes list' ); $x3 = dm (); $xn = w ($jn,$x3); if ($jn){ if(CACHE_FULLLIST)e3 (USER_DIR . CACHE_FILENAME_FULLLIST,serialize ($xn)); } } return $xn; } function e2m_everything ($parameters = array ()) { global$_strings; $xn = r (true); $hn = count ($xn); $mn = e2l_get_string ('pt--n-posts', array ('number' => $hn)); $cb = [ 'title' => $mn, 'heading' => $mn, ]; if(count ($xn)) { $cb['notes-list']=$xn; } else { $cb['nothing']=$_strings['gs--no-notes']; } return $cb; } function e2m_sitemap_xml ($parameters = array ()) { global$_config; $xn = r (false); if (@$_config['dev_xml_as_text']) { header ('Content-Type: text/plain'); } else { header ('Content-type: application/xml; charset=utf-8'); } echo '<?xml version="1.0" encoding="UTF-8"?>'."\r\n"; echo '<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">'."\r\n"; if(count ($xn)) { $gn = @$xn[0]['last-modified']; echo '<url>'."\r\n"; echo '<loc>'. qq ('e2m_frontpage', array ('page' => 1)) .'</loc>'."\r\n"; echo '<lastmod>'; echo gmdate ('Y-m-d\TH:i:s\Z',$gn[0]); echo '</lastmod>'."\r\n"; echo '<changefreq>hourly</changefreq>'; echo '</url>'."\r\n"; foreach ($xn as $r){ echo '<url>'."\r\n"; echo '<loc>'; echo $r['href']; echo '</loc>'."\r\n"; echo '<lastmod>'; echo gmdate ('Y-m-d\TH:i:s\Z',$r['last-modified'][0]); echo '</lastmod>'."\r\n"; echo '</url>'."\r\n"; } } echo '</urlset>'."\r\n"; die; } function t ($nn,$en,$rn){ if(is_numeric ($en)) { $wn = pa ( 't',gmmktime (0,0,0,$en,1,$nn), ga () ); } else { $wn = 0; } $un = cv ('start'); $in = pa ( 'Y',$un['stamp'],$un['timezone'] ); $on = c1 ('Y',time ()); $pn = c1 ('m',time ()); if ((int)$nn == (int)$in){ $cm = pa ('m',$un['stamp'],$un['timezone']); } else { $cm = 1; } if ((int)$nn == (int)$on){ $pn = c1 ('m',time ()); } else { $pn = 12; } if ((int)$nn == (int)$in and (int)$en == (int)$cm){ $vm = pa ('d',$un['stamp'],$un['timezone']); } else { $vm = 1; } if ((int)$nn == (int)$on and (int)$en == (int)$pn){ $bm = c1 ('d',time ()); } else { $bm = $wn; } if(1){ $ym = u (); for ($rb = $in; $rb <= $on; ++ $rb){ $nm = gmmktime (0,0,0,1,1,$rb); $mm[$rb] = [ 'number' => $rb, 'start-time' => [$nm,ga ()], 'href' => qq ('e2m_year', [ 'year' => gmdate ('Y',$nm), ]), 'this?' => (bool) ($rb == $nn), 'real?' => true, 'fruitful?' => @in_array (gmdate ('Y',$nm),$ym), ]; } $fm['years']=$mm; } if(1){ $dm = i ($nn); for ($rb = 1; $rb <= 12; ++ $rb){ $nm = gmmktime (0,0,0,$rb,1,$nn); $sm[$rb] = [ 'number' => $rb, 'start-time' => [$nm,ga ()], 'href' => qq ('e2m_month', [ 'year' => gmdate ('Y',$nm), 'month' => gmdate ('m',$nm), ]), 'this?' => (bool) ($rb == $en), 'real?' => $rb >= $cm and $rb <= $pn, 'fruitful?' => @in_array (gmdate ('n',$nm),$dm), ]; } $fm['months']=$sm; } if ($wn){ $am = o ($nn,$en); for ($rb = 1; $rb <= $wn; ++ $rb){ $nm = gmmktime (0,0,0,$en,$rb,$nn); $qm[$rb] = [ 'number' => $rb, 'start-time' => [$nm,ga ()], 'href' => qq ('e2m_day', [ 'year' => gmdate ('Y',$nm), 'month' => gmdate ('m',$nm), 'day' => gmdate ('d',$nm), ]), 'this?' => (bool) ($rb == $rn), 'real?' => $rb >= $vm and $rb <= $bm, 'fruitful?' => @in_array (gmdate ('d',$nm),$am), ]; } $fm['days']=$qm; } return $fm; } function j ($nn,$en = false,$rn = false){ $un = cv ('start'); if ($un === false){ return false; } $lm = pa ('Y',$un['stamp'],$un['timezone']); $zm = c1 ('Y',time ()); if ($en === false){ return (bool) ( $nn >= $lm and $nn <= $zm ); } else { $km = pa ('n',$un['stamp'],$un['timezone']); $xm = c1 ('n',time ()); if ($rn === false){ return (bool) ( $en >= 1 and $en <= 12 and ( ($nn > $lm and $nn < $zm) or ($nn == $lm and $en >= $km) or ($nn == $zm and $en <= $xm) ) ); } else { $em = pa ('j',$un['stamp'],$un['timezone']); $rm = c1 ('j',time ()); if(1){ return (bool) ( checkdate ($en,$rn,$nn) and ( ($nn > $lm and $nn < $zm) or ($nn == $lm and $en > $km) or ($nn == $lm and $en == $km and $rn >= $em) or ($nn == $zm and $en < $xm) or ($nn == $zm and $en == $xm and $rn <= $rm) ) ); } } } } function e2__fruitful_neighbours_with_ymd_($tm,$jm = false,$hm = false){ global$_db,$_config; list ($gm,$wm)=n1 ($tm,$jm,$hm); $um = SECONDS_IN_A_DAY; if ($hm === false)$um = SECONDS_IN_A_MONTH; if ($jm === false)$um = SECONDS_IN_A_YEAR; $im = $om = null; mm ( "SELECT `Stamp`, `Offset`, `IsDST` ". "FROM `". $_config['db_table_prefix']. "Notes` n ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished`=1 ". "AND `Stamp` < '". ($wm - $um) ."' ". nf (cs ()). "ORDER BY Stamp DESC", 'get previous fruitful neighbour with ymd' ); while ($pm = mysqli_fetch_array ($_db['result'],MYSQLI_ASSOC)) { list ($nn,$en,$rn)=explode ('/', pa ('Y/n/j',$pm['Stamp'],ha ($pm)) ); $cf = $tm * 10000 + ($jm? ($jm * 100):0) + ($hm? $hm : 0); $vf = $nn * 10000 + ($jm? ($en * 100):0) + ($hm? $rn : 0); if ($vf < $cf){ $im = gmmktime (0,0,0,$en,$rn,$nn); break; } } mm ( "SELECT `Stamp`, `Offset`, `IsDST` ". "FROM `". $_config['db_table_prefix']. "Notes` n ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished`=1 ". "AND `Stamp` > '". ($gm + $um) ."' ". nf (cs ()). "ORDER BY Stamp", 'get next fruitful neighbour with ymd' ); while ($pm = mysqli_fetch_array ($_db['result'],MYSQLI_ASSOC)) { list ($nn,$en,$rn)=explode ('/', pa ('Y/n/j',$pm['Stamp'],ha ($pm)) ); $cf = $tm * 10000 + ($jm? ($jm * 100):0) + ($hm? $hm : 0); $vf = $nn * 10000 + ($jm? ($en * 100):0) + ($hm? $rn : 0); if ($vf > $cf){ $om = gmmktime (0,0,0,$en,$rn,$nn); break; } } return [$im,$om]; } function e2__parameters_with_timestamp_($bf){ list ( $parameters['year'], $parameters['month'], $parameters['day'] ) = explode ('/',gmdate ('Y/m/d',$bf)); return$parameters; } function w ($jn,$yf,$nn = false,$en = false){ $xn = []; $nf = []; foreach ($yf as $s3 => $ay){ $r['href'] = qq ('e2m_note', array ('*note' => $ay)); $r['time'] = array ((int)$ay['Stamp'],ha ($ay)); $r['last-modified'] = array ((int)min ($ay['LastModified'],time ()), ha ($ay)); $r['favourite?'] = (bool) ($ay['IsFavourite'] && $ay['IsPublished']); $mf = yf ($ay); $r['draft?'] = $mf === 'draft'; $r['scheduled?'] = $mf === 'scheduled'; $r['public?'] = $mf === 'public'; $r['hidden?'] = $mf === 'hidden'; if(array_key_exists ('SourceNoteURL',$ay) and @$ay['SourceNoteURL']!=''){ $r['href']=$ay['SourceNoteURL']; $r['href-original']=$ay['SourceNoteURL']; } if ( ($nn and $en and ( ((int)$nn) .'/'. ((int)$en) == pa ('Y/n',$ay['Stamp'],ha ($ay)) )) or ($nn and !$en and ( (int)$nn == pa ('Y',$ay['Stamp'],ha ($ay)) )) or (!$nn and !$en) ) { $xn[] = $r; $nf[] = str_replace ("\n",' ',$ay['Title']); } } if(Log::$a)__log ('Will do typography'); if ($jn){ $ff = implode ("\n",$nf); $ff = dy (htmlspecialchars ($ff,ENT_NOQUOTES,'UTF-8')); $nf = explode ("\n",$ff); } foreach ($xn as $s3 => $a3){ $xn[$s3]['title']=$nf[$s3]; } $xn = array_reverse ($xn); return $xn; } function u () { global$_config; mm ( "SELECT `Stamp`, `Offset`, `IsDST` ". "FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished`=1 ". nf (cs ()), 'get all notes list years with notes' ); $x3 = dm (); $df = []; foreach ($x3 as $sf){ $af = (int)pa ('Y',$sf['Stamp'],ha ($sf)); $df[$af]=true; } $df = array_keys ($df); sort ($df); return $df; } function i ($tm){ global$_config; list ($qf,$lf)=n1 ($tm); mm ( "SELECT `Stamp`, `Offset`, `IsDST` ". "FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished`=1 ". "AND `Stamp` BETWEEN '". $qf. "' AND '". $lf ."' ". nf (cs ()), 'get all notes for the year '. $tm .' to list months with notes' ); $x3 = dm (); $zf = array (); foreach ($x3 as $sf){ if ( ((int)$tm) == pa ('Y',$sf['Stamp'],ha ($sf)) ) { $kf = (int)pa ('n',$sf['Stamp'],ha ($sf)); $zf[$kf]=true; } } $zf = array_keys ($zf); sort ($zf); return $zf; } function o ($tm,$jm){ global$_config; list ($xf,$ef)=n1 ($tm,$jm); mm ( "SELECT `Stamp`, `Offset`, `IsDST` ". "FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished`=1 ". "AND `Stamp` BETWEEN '". $xf ."' AND '". $ef ."' ". nf (cs ()), 'get all notes for the month '.$jm.' of the year '. $tm .' to list days with notes' ); $x3 = dm (); $rf = array (); foreach ($x3 as $sf){ if ( ((int)$tm) .'/'. ((int)$jm) == pa ('Y/n',$sf['Stamp'],ha ($sf)) ) { $tf = (int)pa ('j',$sf['Stamp'],ha ($sf)); $rf[$tf]=true; } } $rf = array_keys ($rf); sort ($rf); return $rf; } function p () { $jf = cv ('end'); return qq ('e2m_day', [ 'year' => pa ( 'Y',$jf['stamp'],$jf['timezone'] ), 'month' => pa ( 'm',$jf['stamp'],$jf['timezone'] ), 'day' => pa ( 'd',$jf['stamp'],$jf['timezone'] ), ]); } function cv ($hf){ global$_config; $gf = 'p1'; if (!cs ()) { $gf = 'p1v1'; } $wf = USER_DIR . CACHES_DIRNAME . $hf .'-stamp-'. $gf .'.e2time.psa'; if(CACHE_EDGE_TIMEINFO and is_file ($wf)) { $cb = @unserialize (file_get_contents ($wf)); } if(is_array (@$cb)) { return $cb; } else { $cb = array ( 'stamp' => time (), 'timezone' => wa (), ); $uf = (($hf == 'end')? ' DESC' : ''); mm ( "SELECT `Stamp`, `Offset`, `IsDST` ". "FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished`=1 ". nf (cs ()). "ORDER BY `Stamp`". $uf ." LIMIT 1", 'get '. $hf .' timestamp' ); $x3 = dm (); if(count ($x3)) { $cb = array ( 'stamp' => $x3[0]['Stamp'], 'timezone' => ha ($x3[0]), ); if(CACHE_EDGE_TIMEINFO)e3 ($wf,serialize ($cb)); return $cb; } return $cb; } } function vv ($url,$if_ = false){ if($_SERVER['HTTP_USER_AGENT']===E2_UA_STRING){ if(Log::$a)__log ('Spawn not allowed when requested by Aegea itself'); return false; } if(Log::$a)__log ('Spawn: Curl '. $url .' using '. ($if_? 'post' : 'get') .'...'); if(function_exists ('curl_init')) { $of = curl_init (); $pf = !ini_get ('open_basedir'); $pf = ($pf and !$if_); curl_setopt_array ($of, array ( CURLOPT_URL => $url, CURLOPT_POST => $if_, CURLOPT_POSTREDIR => false, CURLOPT_POSTFIELDS => '', CURLOPT_CONNECTTIMEOUT => 300, CURLOPT_TIMEOUT => 1, CURLOPT_MAXREDIRS => 1, CURLOPT_COOKIE => ys (), CURLOPT_SSL_VERIFYPEER => false, CURLOPT_FOLLOWLOCATION => $pf, CURLOPT_RETURNTRANSFER => true, CURLOPT_AUTOREFERER => true, CURLOPT_USERAGENT => E2_UA_STRING, )); $content = curl_exec ($of); $c2 = curl_errno ($of); $v2 = curl_error ($of); $b2 = curl_getinfo ($of); curl_close ($of); if(Log::$a)__log ('Spawn: Curl returns: ['. print_r ($b2,true) .'] ['. $content .'], (errno='. $c2 .', errstr='. $v2 .')...'); return $b2; } else { if(Log::$a)__log ('Spawn: Curl functions are not available'); } } function e2_check_timeout(){ static $y2; if(is_null($y2)) { $n2 = ini_get('max_execution_time'); if ($n2){ $y2 = time()+$n2 - 5; } else { $y2 = 0; } } return ($y2 == 0)?true : $y2 >= time(); } function e2_write_dump_header($m2){ $b2 = ( 'SET SQL_MODE="NO_AUTO_VALUE_ON_ZERO";' .PHP_EOL. 'SET AUTOCOMMIT=0;' .PHP_EOL. 'START TRANSACTION;' .PHP_EOL. "/*!40101 SET @OLD_CHARACTER_SET_CLIENT=@@CHARACTER_SET_CLIENT */;" .PHP_EOL. "/*!40101 SET @OLD_CHARACTER_SET_RESULTS=@@CHARACTER_SET_RESULTS */;" .PHP_EOL. "/*!40101 SET @OLD_COLLATION_CONNECTION=@@COLLATION_CONNECTION */;" .PHP_EOL. "/*!40014 SET @OLD_UNIQUE_CHECKS=@@UNIQUE_CHECKS, UNIQUE_CHECKS=0 */;" .PHP_EOL. "/*!40014 SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0 */;" .PHP_EOL. "/*!40101 SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE=NO_AUTO_VALUE_ON_ZERO */;" .PHP_EOL. "/*!40101 SET NAMES utf8 */;" .PHP_EOL. "/*!50503 SET NAMES utf8mb4 */;" .PHP_EOL. '' ); fwrite($m2,$b2); return true; } function e2_write_dump_footer($m2){ $f2 = 'COMMIT;' .PHP_EOL; $f2 .= "/*!40101 SET SQL_MODE=@OLD_SQL_MODE */;" . PHP_EOL . "/*!40014 SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS */;" . PHP_EOL . "/*!40014 SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS */;" . PHP_EOL . "/*!40101 SET CHARACTER_SET_RESULTS=@OLD_CHARACTER_SET_RESULTS */;" . PHP_EOL . "/*!40101 SET COLLATION_CONNECTION=@OLD_COLLATION_CONNECTION */;" . PHP_EOL . "/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;" . PHP_EOL; fwrite($m2,$f2); return true; } function e2_get_table_definition($d2,$s2){ $a2 = null; $x3 = mysqli_query($d2,"SHOW CREATE TABLE `{$s2}`"); if ($x3){ $q2 = mysqli_fetch_array($x3); $a2 = $q2['Create Table']; } return $a2; } function e2_write_table_definition($m2,$d2,$s2){ $l2 = e2_get_table_definition($d2,$s2); if(e2_check_timeout() && $l2){ fwrite($m2,$l2); fwrite($m2,';'); fwrite($m2,PHP_EOL . PHP_EOL); return true; } return false; } function e2_get_table_data($d2,$s2,$z3,$limit){ $z2 = "SELECT * FROM `{$s2}` LIMIT {$z3}, {$limit}"; $x3 = mysqli_query($d2,$z2); if (!$x3){ return false; } $k2 = ''; $x2 = "INSERT INTO `{$s2}` VALUES"; while ($e2_ = mysqli_fetch_row($x3)) { $r2 = array(); foreach($e2_ as $cv){ $r2[] = is_null($cv)?"NULL" : "'" . mysqli_real_escape_string($d2,$cv)."'"; } $k2 .= $x2 . '(' . join(', ',$r2).');' . PHP_EOL; } return $k2; } function e2_table_disable_keys($s2){ return "ALTER TABLE `{$s2}` DISABLE KEYS;" . PHP_EOL; } function e2_table_enable_keys($s2){ return "ALTER TABLE `{$s2}` ENABLE KEYS;" . PHP_EOL; } function e2_get_total_records($d2,$s2){ $s3 = mysqli_fetch_row(mysqli_query($d2,"SELECT COUNT(*) FROM `{$s2}`")); return $s3[0]; } function e2_backup_select_chuck_size_for_table_($s2){ $limit = 5000; if(substr ($s2, -7)==='Actions')$limit = 50000; if(substr ($s2, -7)==='Aliases')$limit = 20000; if(substr ($s2, -7)==='NotesKeywords')$limit = 50000; if(Log::$a)__log ('Backup: chunk size '. (int)$limit); return$limit; } function e2_write_table_data($m2,$d2,$s2,$subset){ $t2 = e2_get_total_records($d2,$s2); $z3 = 0; $limit = e2_backup_select_chuck_size_for_table_($s2); $x3 = true; $j2 = 20000; $h2 = 30; if ($t2){ $g2 = e2_table_disable_keys($s2); fwrite($m2,$g2); } $k2 = "INSERT INTO `{$s2}` VALUES"; $w2 = $t2; while ($w2 > 0){ $z2 = "SELECT * FROM `{$s2}` "; if ((int)$subset > 0){ $z2 .= "WHERE `SubsetID` = {$subset} "; } $z2 .= "ORDER BY `ID` LIMIT {$z3}, {$limit}"; $x3 = mysqli_query($d2,$z2); $u2 = mysqli_num_rows($x3); if (!$x3 || !e2_check_timeout()) { $x3 = false; break; } $i2 = array(); $o2 = 0; $p2 = 0; while ($e2_ = mysqli_fetch_row($x3)) { if (!e2_check_timeout()) { $x3 = false; break; } $u2--; $mb = array(); foreach($e2_ as $cv){ $mb[] = is_null($cv)?"NULL" : "'" . mysqli_real_escape_string($d2,$cv)."'"; } $lb = '(' . join(', ',$mb).')'; $o2 += strlen($lb); $i2[] = $lb; $p2++; if ( ($o2 >= $j2) || ($p2 >= $h2) || ($u2 == 0)) { $z2 = $k2 . join(', ',$i2).';'; fwrite($m2,$z2); fwrite($m2,PHP_EOL); $o2 = 0; $p2 = 0; $i2 = array(); } } $z3 += $limit; $w2 -= $limit; } if ($t2){ $cd = e2_table_enable_keys($s2); fwrite($m2,$cd); } return $x3; } function e2_backup($d2,$vd,$subset,$bd){ $yd = tmpfile(); e2_write_dump_header($yd); if(Log::$a)__log ('Backup: wrote header'); $nd = true; foreach($vd as $s2){ if ((int)$subset > 0){ if(Log::$a)__log ('Backup: table '. $s2 .', subset '. $subset); } else { if(Log::$a)__log ('Backup: table '. $s2 .', all subsets'); } $md = e2_write_table_definition($yd,$d2,$s2); if(Log::$a)__log ('Backup: wrote table definition with result '. @(int)$md); $fd = e2_write_table_data($yd,$d2,$s2,$subset); if(Log::$a)__log ('Backup: wrote table data with result '. @(int)$fd); $nd = $md && $fd; if ($nd === false){ break; } } if(Log::$a)__log ('Backup: wrote data with running == '. (int)$nd); if ($nd){ e2_write_dump_footer($yd); fseek($yd,0); $m2 = fopen($bd,'w+'); while ($nd && ($lb = fread($yd,1024))) { if(e2_check_timeout()) { fwrite($m2,$lb); } else { $nd = false; } } fclose($m2); } fclose($yd); return $nd; } function xv () { global$settings,$_lang,$_config,$_strings; if(Log::$a)__log ('Blog information'); $dd['author']=htmlspecialchars (rv (), ENT_NOQUOTES,'UTF-8'); if(array_key_exists ('blog_subtitle',$settings)) { $sd = qy ($settings['blog_subtitle'],'full'); $ad = $sd['text-final']; $dd['subtitle']=$ad; $dd['subtitle-format-info']=$sd['meta']; b2 (@$sd['meta']['links-required']); } $dd['title']=htmlspecialchars (ev (), ENT_NOQUOTES,'UTF-8'); $dd['userpic-set?']=false; $dd['userpic-changeable?']=cs (); if ($dd['userpic-href']=tv ()) { $dd['userpic-set?']=true; $dd['userpic-large-href']=tv ('large'); $dd['userpic-square-href']=tv ('square'); $dd['userpic-changeable-href']=$dd['userpic-href']; } else { unset ($dd['userpic-href']); } if (cs ()) { $dd['userpic-upload-action']=qq ('e2j_userpic_upload'); $dd['userpic-remove-action']=qq ('e2j_userpic_remove'); } $dd['href']=qq ('e2m_frontpage', array ('page' => 1)); $dd['rss-href']=qq ('e2m_rss'); $dd['jsonfeed-href']=qq ('e2m_json'); $dd['language']=$_lang; $dd['show-follow-button?']=false; $dd['license-expired?']=false; $ld = array (time (), wa ()); $zd = c1 ('Y',$ld[0]); $dd['now']=$ld; $kd = $zd; $xd = cv ('start'); if(array_key_exists ('stamp',$xd)) { $kd = c1 ('Y',$xd['stamp']); $dd['start-time'] = array ((int)$xd['stamp'],$xd['timezone']); } $ed = false; $rd = vf (true,true); if ($rd !== null){ if (cs ()) { $td = vf (true,false); if ($td !== null){ $ed = ($rd + $td == 0); } } else { $ed = ($rd == 0); } } $dd['notes-count'] = (int)$rd; if ($dd['notes-count']>0){ $dd['selected-href']=qq ('e2m_favourites', ['page' => 1]); $dd['most-commented-href']=qq ('e2m_most_commented', ['page' => 1]); $dd['popular-href']=qq ('e2m_popular', ['page' => 1]); $dd['calendar-href']=p (); $dd['random-note-href']=mf (); } $dd['virgin?']=$ed; $jd = $_config['years_range_separator']? $_config['years_range_separator']:$_strings['gs--range-separator']; $dd['years-range']=$kd . (($kd == $zd)? '':($jd . $zd)); if(AeEnv::$w){ $dd['parent-site-href']=substr (AeEnv::$w, (int)strpos ('/',AeEnv::$w)); } return $dd; } function ev () { global$settings,$_strings; if ( array_key_exists ('blog_title',$settings) and trim ($settings['blog_title']) != '' ) { return trim ($settings['blog_title']); } else { return$_strings['e2--default-blog-title']; } } function rv () { global$settings,$_strings; if ( array_key_exists ('author',$settings) and trim ($settings['author']) != '' ) { return trim ($settings['author']); } else { return$_strings['e2--default-blog-author']; } } function tv ($size = ''){ global$_config; $hd = false; $gd = $_config['path_media'].USERPIC_DIRNAME; if(is_file ($gd .'userpic@2x.jpg')) { $hd = 'userpic@2x.jpg'; } elseif(is_file ($gd .'userpic@2x.png')) { $hd = 'userpic@2x.png'; } if($size == 'large' and is_file ($gd .'userpic-large@2x.jpg')) { $hd = 'userpic-large@2x.jpg'; } elseif($size == 'square' and is_file ($gd .'userpic-square@2x.jpg')) { $hd = 'userpic-square@2x.jpg'; } if ($hd === false) return false; $wd = $gd . $hd; $ud = AeEnv::$base_url . USERPIC_DIRNAME . $hd; $id = stat ($wd); if ($id['mtime'])$ud .= '?'. $id['mtime']; return $ud; } function jv () { global$_config,$_stopwatch,$od; $pd = round (yq () - $_stopwatch,3); return [ 'show?' => ($_config['display_stat'] > (int) !cs ()), 'generation-time' => str_replace ('.',',',$pd), 'peak-memory-mb' => str_replace ('.',',',round ((memory_get_peak_usage () / 1024 / 1024)*100)/100), 'db-query-count' => (int) @$od, ]; } function e2m_info () { global$settings,$_template; if (!isset ($_template))qf (); $cs = array ( 'E2_VERSION' => E2_VERSION, 'E2_RELEASE' => E2_RELEASE, 'E2_UA_STRING' => E2_UA_STRING, '---', 'PHP_VERSION' => PHP_VERSION, '---', 'installed' => (cn () !== null), 'server_name' => AeEnv::$server, 'folder_on_server' => AeEnv::$w, '---', 'default formatter' => DEFAULT_FORMATTER, '---', 'theme' => $settings['template'], '---', 'Olba name' => $_template['name'], 'Olba stack' => $_template['stack'], '---', 'Neasden' => substr (md5 (file_get_contents ('system/neasden/neasden.php')), 0,4), '---', ); echo '<pre>'; foreach ($cs as $s3 => $a3){ if ($a3 == '---'){ echo "\n"; continue; } echo str_pad ($s3,24); echo '\''; print_r ($a3); echo '\''; echo "\n"; } echo '</pre>'; die; } function hv ($s){ global$_config; if (@$_config['broadcast_url'] and !$s['IsExternal']) { if($_config['log_broadcast']) { Log::$a = true; if(Log::$a)dn ('broadcast'); } if(Log::$a)__log ('Broadcast-async note: '. $s['Title']); $url = qq ('e2m_note_broadcast', array ('*note' => $s)); if(Log::$a)__log ('Broadcast will spawn url: '. $url); vv ($url); } } function gv ($vs){ global$_config; if (!$vs) return false; $url = $_config['broadcast_url']; $url .= '?src='. urlencode ($vs); if($_config['log_broadcast']) { Log::$a = true; if(Log::$a)dn ('broadcast'); } if(Log::$a)__log ('Broadcast: Curl '. $url .'...'); if(function_exists ('curl_init')) { $of = curl_init (); $pf = !ini_get ('open_basedir'); curl_setopt_array ($of, array ( CURLOPT_URL => $url, CURLOPT_CONNECTTIMEOUT => 300, CURLOPT_TIMEOUT => 1, CURLOPT_MAXREDIRS => 1, CURLOPT_COOKIE => ys (), CURLOPT_SSL_VERIFYPEER => false, CURLOPT_FOLLOWLOCATION => $pf, CURLOPT_RETURNTRANSFER => true, CURLOPT_AUTOREFERER => true, CURLOPT_USERAGENT => E2_UA_STRING, )); $content = curl_exec ($of); $c2 = curl_errno ($of); $v2 = curl_error ($of); $b2 = curl_getinfo ($of); curl_close ($of); if(Log::$a)__log ('Broadcast: Curl returns: ['. print_r ($b2,true) .'] ['. $content .'], (errno='. $c2 .', errstr='. $v2 .')...'); if ($c2 === 0) return true; } else { if(Log::$a)__log ('Spawn: Curl functions are not available'); } return false; } function wv ($s){ if (!$s) return false; $vs = qq ('e2m_note_json', array ('*note' => $s)); return gv ($vs); } function e2m_note_broadcast ($parameters = array ()) { global$_config; if (@$_config['broadcast_url']) { if(array_key_exists ('*note',$parameters)) { $vs = qq ('e2m_note_json', array ('*note' => $parameters['*note'])); } elseif(array_key_exists ('alias',$parameters)) { $vs = qq ('e2m_note_json', array ('alias' => $parameters['alias'])); } if (gv ($vs)) { die ('Broadcasted.'); } else { die ('Could not broadcast.'); } } else { return e2m_error404 (); } } function e2_cache_filename_with_id_($zy,$gf){ return str_replace ('*',$zy,$gf); } function e2_note_cache_filename_with_id_($zy){ return e2_cache_filename_with_id_($zy,USER_DIR . CACHE_FILENAMES_NOTES); } function e2_drop_caches_for_note_($note_id,$bs){ if(is_numeric ($note_id)) { if(Log::$a)__log ('Caches: Drop caches for note id '. $note_id); @unlink (e2_note_cache_filename_with_id_($note_id)); @unlink (e2_note_cache_filename_with_id_($note_id .'-comments')); @unlink (e2_note_cache_filename_with_id_($note_id .'-comments-author')); } else { o1 (USER_DIR . CACHE_FILENAMES_NOTES); o1 (USER_DIR . CACHE_FILENAMES_NOTES_COMMENTS); o1 (USER_DIR . CACHE_FILENAMES_NOTES_COMMENTS_AUTHOR); } vb (); if ($bs !== false){ bb (); o1 (USER_DIR . CACHE_FILENAMES_NOTES_RELATED); o1 (USER_DIR . CACHE_FILENAMES_POPULAR_WITH_TAG); o1 (USER_DIR . CACHE_FILENAMES_TAG); o1 (USER_DIR . CACHE_FILENAMES_TAG_AUTHOR); @unlink (USER_DIR . CACHE_FILENAME_POPULAR); @unlink (USER_DIR . CACHE_FILENAME_FRONTPAGE); @unlink (USER_DIR . CACHE_FILENAME_FRONTPAGE_AUTHOR); @unlink (USER_DIR . CACHE_FILENAME_FRONTPAGE_FEED); @unlink (USER_DIR . CACHE_FILENAME_FULLLIST); @unlink (USER_DIR . CACHE_FILENAME_TAGS); @unlink (USER_DIR . CACHE_FILENAME_TAGS_FULL); @unlink (USER_DIR . CACHE_FILENAME_TAGS_AUTHOR); @unlink (USER_DIR . CACHE_FILENAME_TAGS_AUTHOR_FULL); } if ($bs !== true){ @unlink (USER_DIR . CACHE_FILENAME_DRAFTS); @unlink (USER_DIR . CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); } @unlink (USER_DIR . CACHE_FILENAME_LASTMODIFIEDS); } function e2_drop_caches_for_tag_($ys){ if(is_numeric ($ys)) { @unlink (e2_cache_filename_with_id_($ys,USER_DIR . CACHE_FILENAMES_TAG)); @unlink (e2_cache_filename_with_id_($ys,USER_DIR . CACHE_FILENAMES_TAG_AUTHOR)); } else { o1 (USER_DIR . CACHE_FILENAMES_TAG); o1 (USER_DIR . CACHE_FILENAMES_TAG_AUTHOR); } @unlink (USER_DIR . CACHE_FILENAME_FAVTAGS); @unlink (USER_DIR . CACHE_FILENAME_TAGS); @unlink (USER_DIR . CACHE_FILENAME_TAGS_FULL); @unlink (USER_DIR . CACHE_FILENAME_TAGS_AUTHOR); @unlink (USER_DIR . CACHE_FILENAME_TAGS_AUTHOR_FULL); } function cb () { if(Log::$a)__log ('Caches: Drop notes caches'); e2_drop_caches_for_note_(null,null); } function vb () { if(Log::$a)__log ('Caches: Drop notes counts cache'); o1 (USER_DIR . CACHE_FILENAMES_NOTES_COUNTS); } function bb () { if(Log::$a)__log ('Caches: Drop egde time info cache'); o1 (USER_DIR . CACHE_FILENAMES_EDGE_TIMEINFO); } function e2_drop_all_kinds_of_cache () { if(Log::$a)__log ('Caches: Drop all kinds of caches'); o1 (USER_DIR . CACHES_DIRNAME . '*'); return true; } function e2m_comment ($parameters = []) { s1 (qq ('e2m_note',$parameters)); } function e2m_comment_edit ($parameters = []) { return yb ('edit',$parameters); } function yb ($ns,$parameters = []) { global$_strings; $ms = $fs = $_strings['pt--new-comment']; $ds = 'new'; if ($ns == 'edit'){ $ss = e2_commentrec_with_parameters_($parameters); $as_ = $_strings['fb--save-changes']; $ay = $ss['noterec']; $ms = $fs = $_strings['pt--edit-comment']; $qs = mb ($ay,$ss,$parameters['comment-number']); if (!$ss){ return e2m_error404 (); } $ls = [ '.note-id' => $ss['NoteID'], '.comment-id' => $ss['ID'], '.comment-number' => $parameters['comment-number'], '.already-subscribed?' => false, '.gip' => $ss['GIP'], 'create:edit?' => false, 'form-action' => qq ('e2s_comment_process'), 'submit-text' => $as_, 'show-subscribe?' => true, 'subscribe?' => (bool)$ss['IsSubscriber'], 'name' => htmlspecialchars ($ss['AuthorName'],ENT_COMPAT,'UTF-8'), 'email' => htmlspecialchars ($ss['AuthorEmail'],ENT_COMPAT,'UTF-8'), 'text' => htmlspecialchars ($ss['Text'],ENT_COMPAT,'UTF-8'), 'email-field-name' => a (), ]; if ('' != trim ($ss['IP'])) { $ls['ip']=$ss['IP']; } } $cb = [ 'title' => $ms, 'heading' => $fs, 'form' => 'form-comment', 'form-comment' => $ls, ]; if (!empty ($qs)) { $cb['comments'] = ['each' => ['only' => $qs]]; } return $cb; } function e2m_comment_reply ($parameters = []) { global$_strings; $ss = e2_commentrec_with_parameters_($parameters); if (!$ss){ return e2m_error404 (); } $ay = $ss['noterec']; $qs = mb ($ay,$ss,$parameters['comment-number']); $qs['replying?'] = (bool)true; $zs = ($ss['Reply']=='' or !$ss['IsReplyVisible']); $ms = $zs? $_strings['pt--reply-to-comment']:$_strings['pt--edit-reply-to-comment']; $ks = [ '.note-id' => $ay['ID'], '.comment-id' => $ss['ID'], '.reply-action' => $zs? 'new' : 'edit', 'form-action' => qq ('e2s_comment_edit_reply'), 'submit-text' => $zs? $_strings['fb--publish']:$_strings['fb--save-changes'], 'create:edit?' => (bool) ($zs), 'reply-text' => htmlspecialchars ($ss['Reply'],ENT_COMPAT,'UTF-8'), 'emailing-possible?' => MAIL_ENABLED, 'mail-back?' => (bool) ($zs), ]; return [ 'title' => $ms, 'heading' => $ms, 'comments' => ['each' => ['only' => $qs]], 'form' => 'form-comment-reply', 'form-comment-reply' => $ks, ]; } function e2m_comment_delete ($parameters = []) { global$_config; $ss = e2_commentrec_with_parameters_($parameters); $note_id = $ss['NoteID']; if (!$ss){ return e2m_error404 (); } e2_drop_caches_for_note_($note_id,true); @unlink (USER_DIR. '/last-comment.psa'); mm ( "DELETE FROM `". $_config['db_table_prefix']."Comments` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID` = '". ((int)$ss['ID']). "'" ); a1 (); } function e2m_comment_reply_delete ($parameters = []) { global$_strings,$settings,$_config; $ss = e2_commentrec_with_parameters_($parameters); if (!$ss){ return e2m_error404 (); } mm ( "UPDATE `". $_config['db_table_prefix']."Comments` SET ". "`Reply`='', ". "`IsReplyFavourite`='0' ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID`=".((int)$ss['ID']) ); a1 (); } function e2m_unsubscribe ($parameters){ global$_strings,$_config; $uf = "ORDER BY `ID` DESC"; $xs = false; $ay = $parameters['*note']; $note_id = $ay['ID']; $es = $parameters['unsubscribe-email']; $rs = $parameters['unsubscribe-key']; $es = str_replace (' ','+',$es); if($note_id){ mm ( "SELECT `ID`, `Stamp` FROM `". $_config['db_table_prefix']."Comments` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `NoteID`=". $note_id ." ". "AND `IsSubscriber`=1 ". "AND `AuthorEmail`='". sm ($es) ."' ". $uf, 'get subscriber’s comments ids' ); $x3 = dm (); if(count ($x3)<1) { $cb['unsubscribe']['error-message']=$_strings['gs--you-are-not-subscribed']; } else { $ts = @$x3[0]; $js = md5 ($ts['ID'].$ts['Stamp'] .'x'); if ($rs == $js){ mm ( "UPDATE `". $_config['db_table_prefix']."Comments` ". "SET `IsSubscriber`=0 ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `NoteID`=". $note_id ." ". "AND `AuthorEmail` = '". sm ($es). "'", 'unsubscribe' ); $xs = true; $cb['unsubscribe']['note-title']=dy ( htmlspecialchars ($ay['Title'],ENT_COMPAT,'UTF-8') ); $cb['unsubscribe']['note-href']=qq ( 'e2m_note', ['*note' => $ay] ); } if (!$xs){ $cb['unsubscribe']['error-message']=$_strings['gs--unsubscription-didnt-work']; } } } else { $cb['unsubscribe']['error-message']=$_strings['gs--post-not-found']; } if ($xs){ $ms = $_strings['pt--unsubscription-done']; } else { $ms = $_strings['pt--unsubscription-failed']; } $cb['unsubscribe']['success?']=$xs; $cb['title']=$ms; $cb['heading']=$ms; return $cb; } function e2m_comment_flag ($parameters){ nb ($parameters); s1 (qq ('e2m_note',$parameters)); } function e2s_comment_flag_ajax ($parameters){ r1 ([ 'flag-name' => 'comment', 'candy-name' => 'e2s_comment_flag_ajax', 'parameters' => $parameters, 'flipping-function' => function () use ($parameters){ nb ($parameters); }, 'redirect-candy' => 'e2m_note', ]); } function nb ($parameters){ if($_SERVER['REQUEST_METHOD']!='POST'){ s1 (qq ('e2m_note',$parameters)); } wd (); $ss = e2_commentrec_with_parameters_($parameters); $note_id = $ss['NoteID']; if (!$ss) throw new AeException ('Comment record not cound from parameters'); e2_drop_caches_for_note_($note_id,true); ym ( iq (), 'Comments', [ 'ID' => $ss['ID'], $parameters['flag'] => (int) ($parameters['value']==1), ] ); } function e2s_comment_process () { global$_strings; $hs = true; $gs = ''; try { $note_id = rb (); } catch (AeFormIncompleteException $e){ hb ($_strings['er--name-email-text-required'],E2E_USER_ERROR); s1 (qq ('e2m_note', ['*note' => jm ($e->note_id)])); } catch (AeFormNoteNotCommentableException $e){ $hs = false; $ws = $_strings['gs--comment-post-not-commentable']; $us = $_strings['gs--comment-post-not-commentable-description']; $gs = $e->comment_text; } catch (AeFormDuplicateCommentException $e){ $hs = false; $ws = $_strings['gs--comment-double-post']; $us = $_strings['gs--comment-double-post-description']; $gs = $e->comment_text; } catch (AeFormCommentTooLongException $e){ $hs = false; $ws = $_strings['gs--comment-too-long']; $us = $_strings['gs--comment-too-long-description']; $gs = $e->comment_text; } catch (AeFormCommentIsSpamSuspectException $e){ $hs = false; $ws = $_strings['gs--comment-spam-suspect']; $us = $_strings['gs--comment-spam-suspect-description']; $gs = $e->comment_text; } if ($hs){ if($note_id){ s1 (qq ('e2m_note', ['*note' => jm ($note_id)])); } else { s1 (); } } else { $cb['title']=$ws; $cb['heading']=$ws; $cb['form']='form-unaccepted-comment'; $cb['form-unaccepted-comment'] = [ 'reason' => $us, 'text' => @htmlspecialchars ($gs,ENT_COMPAT,'UTF-8'), ]; return $cb; } die; } function e2s_comment_edit_reply () { global$_config; wd (); $is = @$_POST['text']; if(trim ($is)=='')$is = ''; $note_id = @$_POST['note-id']; $ay = jm ($note_id); $ds = @$_POST['comment-id']; $ss = fb ($ds); $os = isset ($_POST['mail-back']); $ps = time (); if (@$_POST['reply-action']=='new'){ $ca = time (); } @unlink (e2_note_cache_filename_with_id_($note_id .'-comments')); @unlink (e2_note_cache_filename_with_id_($note_id .'-comments-author')); if ($ss){ mm ( "UPDATE `". $_config['db_table_prefix']."Comments` SET ". "`Reply`='". sm ($is) ."', ". ( isset ($ca)? ( "`ReplyStamp`='". $ca ."', " ) : ( "" ) ). "`ReplyLastModified`='". $ps ."', ". "`IsReplyVisible`='1' ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID`=".((int)$ds), 'update comment reply' ); $va = qq ('e2m_note', ['*note' => $ay]); if ($os and $is != ''){ $ba['comment-time'] = [$ss['Stamp'],wa ()]; $ba['commenter']=$ss['AuthorName']; $ba['commenter-email']=$ss['AuthorEmail']; $ba['comment-text']=$ss['Text']; $ba['note-title']=dy ($ay['Title']); $ba['reply-time'] = [time (), wa ()]; $ba['blog-author']=rv (); $ba['note-href']=$va; $ba['comment-href']=$va; $ba['reply-text']=$is; if(1){ $ya = qn ( 'comment-reply',$ba ); $na = e2l_get_string ( 'em--comment-reply', $ba ); $ma = $ss['AuthorEmail']; $fa = 'From: '. ln (); zn ($ma,$na,$ya,$fa); } if(1){ unset ($ba['commenter-email']); $fa = 'From: '. ln (); foreach (kb ($ay,$ss['AuthorEmail']) as $da){ $sa = $da['AuthorEmail']; $aa = md5 ($da['ID'].$da['Stamp'].'x'); $ba['unsubscribe-href']=qq ('e2m_unsubscribe', [ '*note' => $ay, 'unsubscribe-email' => $sa, 'unsubscribe-key' => $aa, ] ); $ma = $sa; $ya = qn ('comment-reply-to-public',$ba); $na = e2l_get_string ( 'em--comment-reply-to-public-subject', $ba ); zn ($ma,$na,$ya,$fa); } } } s1 ($va); } else { a1 (); } die; } function mb ($ay,$ts,$qa){ global$_config; if(Log::$a)__log ('Package comment '. $ts['ID'] .'...'); if ($ay === null){ $ay = jm ($ts['NoteID']); } $ba['number']=$qa; $la = !empty ($ts['IsGIPUsed']); $ba['gip-used?']=$la; $ba['gip']=$ba['gip-used?']?$ts['GIP']:''; $ba['name']=htmlspecialchars ($ts['AuthorName'],ENT_NOQUOTES,'UTF-8'); $ba['userpic-set?']=false; if ($la){ $za = AVATARS_DIRNAME . $ts['GIP'] .'-'. $ts['GIPAuthorID'] .'.jpg'; if(is_file ($_config['path_media'].$za)) { $ba['userpic-set?']=true; $ba['userpic-href']=AeEnv::$base_url . $za; } } $ba['name-href']=''; if ( $la and $ka = e2_get_user_profile_url ( $ts['GIP'],$ts['GIPAuthorID'],$ts['AuthorProfileLink'] ) ) { $ba['name-href']=$ka; } if (cs ()) { $ba['email']=htmlspecialchars ($ts['AuthorEmail'],ENT_NOQUOTES,'UTF-8'); if ('' != trim ($ts['IP'])) { $ba['ip']=$ts['IP']; } } $ba['author-name']=rv (); $ba['important?'] = (bool)$ts['IsFavourite']; $ba['reply-visible?'] = (bool) ($ts['IsVisible'] && $ts['IsReplyVisible']); $ba['reply-important?'] = (bool)$ts['IsReplyFavourite']; $ba['spam-suspect?'] = (bool)$ts['IsSpamSuspect']; $xa = [(int)$ts['Stamp'],ha ($ay)]; $ba['time']=$xa; $ba['last-modified']=$xa; if ($ts['LastModified']) $ba['last-modified'] = [(int)$ts['LastModified'],ha ($ay)]; if ($ts['ReplyStamp']) $ba['reply-time'] = [(int)$ts['ReplyStamp'],ha ($ay)]; if ($ts['ReplyLastModified']) $ba['reply-last-modified'] = [(int)$ts['ReplyLastModified'],ha ($ay)]; if (cs ()) { $ba['subscriber?'] = (bool)$ts['IsSubscriber']; $ba['new?'] = (bool)$ts['IsNew']; $ba['first-new?']=false; if (!@$_config['read_only']) { $ba['important-toggle-action']=qq ('e2s_comment_flag_ajax', [ '*note' => $ay,'comment-number' => $qa, 'flag' => 'IsFavourite', 'value' => !$ts['IsFavourite'] ]); $ba['reply-important-toggle-action']=qq ('e2s_comment_flag_ajax', [ '*note' => $ay,'comment-number' => $qa, 'flag' => 'IsReplyFavourite', 'value' => !$ts['IsReplyFavourite'] ]); $ba['edit-href']=qq ('e2m_comment_edit', [ '*note' => $ay,'comment-number' => $qa, ]); $ba['removed-action']=qq ('e2s_comment_flag_ajax', [ '*note' => $ay,'comment-number' => $qa, 'flag' => 'IsVisible', 'value' => 0 ]); $ba['removed-reply-action']=qq ('e2s_comment_flag_ajax', [ '*note' => $ay,'comment-number' => $qa, 'flag' => 'IsReplyVisible', 'value' => 0 ]); $ba['replaced-action']=qq ('e2s_comment_flag_ajax', [ '*note' => $ay,'comment-number' => $qa, 'flag' => 'IsVisible', 'value' => 1 ]); $ba['replaced-reply-action']=qq ('e2s_comment_flag_ajax', [ '*note' => $ay,'comment-number' => $qa, 'flag' => 'IsReplyVisible', 'value' => 1 ]); $ea = qq ('e2m_comment_reply', [ '*note' => $ay,'comment-number' => $qa ]); if ($ts['Reply']=='' or !$ts['IsReplyVisible']) { $ba['reply-href']=$ea; } else { $ba['edit-reply-href']=$ea; } } } if(mb_strlen ($ts['Text']) > $_config['max_comment_length']) { $ts['Text']=mb_substr ($ts['Text'],0,$_config['max_comment_length']); } $ra = $ay['FormatterID']==='raw' ? 'neasden' : $ay['FormatterID']; $sd = ay ($ra,$ts['Text'],'simple'); $ba['text']=$sd['text-final']; $ba['reply']=''; $ba['replying?'] = (bool)false; $ba['replied?'] = (bool) ( (trim ($ts['Reply']) != '') && ($ts['IsReplyVisible']) ); if ((string)$ts['Reply']!==''){ $sd = ay ($ay['FormatterID'],$ts['Reply'],'full'); $ba['reply']=$sd['text-final']; } if(Log::$a)__log ('Comments: done'); return $ba; } function fb ($zy){ global$_config; mm ( "SELECT * FROM `". $_config['db_table_prefix']."Comments` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID` = '". $zy ."'" ); $zb = dm (); if(count ($zb)>0){ return $zb[0]; } else { return false; } } function db ($s){ global$_strings,$settings; $ta = (string) @$_COOKIE[q1 ('commenter_name')]; $ja = (string) @$_COOKIE[q1 ('commenter_email')]; $ha = (string) @$_COOKIE[q1 ('commenter_ph')]; $ga = false; if ($ja and $ha){ foreach (kb ($s) as $da){ $js = md5 ($da['ID'].$da['Stamp'] .'x'); if ( $da['AuthorEmail']==$ja and $ha == $js ) { $ga = true; break; } } } $as_ = $_strings['fb--submit']; $vn = q (); $ls = [ '.note-id' => $s['ID'], '.comment-id' => 'new', '.already-subscribed?' => (bool)$ga, 'cookie-name' => z ($s['ID']), 'cookie-value' => k (), 'email-field-name' => a (), 'nospam-field-name-part-1' => substr ($vn,0,4), 'nospam-field-name-part-2' => substr ($vn,4), 'create:edit?' => true, 'form-action' => qq ('e2s_comment_process'), 'submit-text' => $as_, 'show-subscribe?' => (bool) !$ga, 'emailing-possible?' => MAIL_ENABLED, 'subscribe?' => (bool)$ga, 'subscription-status' => $ga? $_strings['gs--you-are-already-subscribed']:'', 'name' => htmlspecialchars ($ta,ENT_COMPAT,'UTF-8'), 'email' => htmlspecialchars ($ja,ENT_COMPAT,'UTF-8'), 'text' => '', 'email-comments-enabled?' => empty ($settings['comments']['require_gip']), 'gips' => [], ]; $wa = false; $ua = ''; foreach(e2_list_gips () as $ia){ if (!is_file (SYSTEM_DIR .'gips/'. $ia .'.json')) { continue; } $oa = e2_is_logged_in ($ia); $ls['gips'][$ia] = ( e2_get_gip_auth_url ($ia) ); if ($oa){ $wa = true; $pa = e2_get_gip_session ($ia); $ua = $pa['GIP']; $ls['name']=htmlspecialchars ( $pa['AuthorName'],ENT_COMPAT,'UTF-8' ); } } if (!$ls['email-comments-enabled?'] and !count ($ls['gips'])) { return false; } $ls['email-comments-only?'] = (count ($ls['gips']) === 0); $ls['logged-in?']=$wa; $ls['logged-in-gip']=$ua; $ls['logout-url']=$wa ? qq('e2m_gip_sign_out', array('provider' => E2GIP::get_logout_key())) : ''; return $ls; } function sb ($note_id){ return qb ($note_id,'`IsNew` = 1'); } function ab ($note_id){ return qb ($note_id,'`IsVisible` = 1'); } function qb ($note_id,$c1){ global$_config; if (!is_numeric ($note_id)) return 0; $v1 = 0; mm ( "SELECT count(*) ". "FROM `". $_config['db_table_prefix']."Comments` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `NoteID`=". $note_id ." ". "AND (". $c1. ")", 'count comments' ); $x3 = dm (); $x3 = (int)$x3[0]['count(*)']; $v1 = $x3; return (int)$v1; } function lb () { global$_config; if(Log::$a)__log ('Count new comments'); $b1 = 0; $y1 = ''; $n1 = ''; try { mm ( "SELECT `NoteID`, `Text` FROM `". $_config['db_table_prefix']."Comments` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsNew`=1 ORDER BY `Stamp` DESC", 'count new comments for author menu' ); $x3 = dm (); $b1 = count ($x3); while ($b1-- > 0){ if ($ay = jm ($x3[$b1]['NoteID'])) { $n1 = qq ('e2m_note', ['*note' => $ay]); break; } } $b1 ++; } catch (AeMySQLException $e){ v3 ($e); if(Log::$a)__log ('Could not count new comments or provide link to the latest one'); } return [(int)$b1,$y1,$n1]; } function zb ($note_id){ global$_config; if(Log::$a)__log ('Comments: getting comments for note '. $note_id); mm ( "SELECT c.*, g.`AuthorProfileLink` ". "FROM `". $_config['db_table_prefix']."Comments` c ". "LEFT JOIN `". $_config['db_table_prefix']."GIPsSessions` g ". "ON c.`SubsetID`=g.`SubsetID` ". "AND c.`GIP`=g.`GIP` ". "AND c.`GIPAuthorID`=g.`GIPAuthorID` ". "WHERE c.`SubsetID`=". $_config['db_table_subset'] ." ". "AND `NoteID`=". @$note_id . " ". "ORDER BY `Stamp`", 'get comments including deleted' ); $x3 = dm (); return $x3; } function kb ($ay,$m1 = ''){ global$_config; $uf = "ORDER BY `ID` DESC"; $cb = $f1 = []; mm ( "SELECT DISTINCT `ID`, `Text`, `IsSubscriber`, `IsVisible`, ". "`AuthorName`, `AuthorEmail`, `Stamp` ". "FROM `". $_config['db_table_prefix']."Comments` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `NoteID`=". @$ay['ID'] ." ". "AND `IsSubscriber`=1 ". "AND `IsVisible`=1 ". "AND `AuthorEmail`!='". sm ($m1) ."' ". $uf, 'get subscribers by note' ); $x3 = dm (); foreach ($x3 as $da){ if (!in_array ($da['AuthorEmail'],$f1)) { $cb[] = $da; } $f1[] = $da['AuthorEmail']; } return $cb; } function xb ($ay,$d1 = NOTE_COMMENTABLE_NOW){ global$settings,$_config; $s1 = true; if (@$settings['comments']['fresh_only']) if (isset ($_config['comment_freshness_days'])) if ($ay['Stamp']<time () - $_config['comment_freshness_days']*SECONDS_IN_A_DAY) $s1 = false; $a1 = $ay['IsCommentable']; if ($d1 == NOTE_COMMENTABLE_NOW_CONDITIONALLY){ $a1 = true; } return ( yf ($ay)==='public' and $s1 and $a1 ); } function e2_commentrec_with_parameters_($parameters = []) { $ay = $parameters['*note']; $q1 = zb ($ay['ID']); $ss = @$q1[$parameters['comment-number']-1]; if ($ss){ $ss['noterec']=$ay; return $ss; } } function rb () { global$settings,$_config; if(Log::$a)__log ('Process comment form'); wd (); $py = a (); $note_id = $ds = $name = $es = $l1 = ''; if(array_key_exists ('note-id',$_POST)) $note_id = trim (@$_POST['note-id']); if(array_key_exists ('comment-id',$_POST)) $ds = trim (@$_POST['comment-id']); if(array_key_exists ('comment-number',$_POST)) $qa = trim (@$_POST['comment-number']); if(array_key_exists ('name',$_POST)) $name = trim (@$_POST['name']); if(array_key_exists ($py,$_POST)) $es = trim (@$_POST[$py]); if(array_key_exists ('text',$_POST)) $l1 = trim (@$_POST['text']); if ($ds === 'new'){ $z1 = e2_get_logged_gip_name (); if ($z1){ $pa = e2_get_gip_session ($z1); $name = trim ($pa['AuthorName']); $es = ''; $k1 = $pa['GIPAuthorID']; } } else { if(array_key_exists ('gip',$_POST))$z1 = trim (@$_POST['gip']); } $x1 = ( (array_key_exists ('already-subscribed',$_POST) and $_POST['already-subscribed']) or (array_key_exists ('subscribe',$_POST) and $_POST['subscribe']) ); $gn = time (); if (!is_numeric ($note_id)) { throw new AeFormInconsistentException (); } if (!is_numeric ($ds) and $ds !== 'new'){ throw new AeFormInconsistentException (); } if ($ds !== 'new' and !cs ()) { throw new AeFormInconsistentException (); } if ( $l1 == '' or (!$z1 and ((string)$name === '' or (string)$es === '')) ) { throw new AeFormIncompleteException ($note_id); } if ($ds == 'new' and !$z1){ l1 ('commenter_name',$name); l1 ('commenter_email',$es); } $e1 = ($ds === 'new' and ( x () or e2_cookie_data_is_spam_suspicios_for_note_id_($note_id) )); if ($ds == 'new'){ $r1 = @unserialize (file_get_contents (USER_DIR. '/last-comment.psa')); if(md5 ($name . $es . $l1) == @$r1['md5']) { throw new AeFormDuplicateCommentException ($l1); } if ( isset ($_config['max_comment_length']) and strlen (@$_POST['text']) > ($_config['max_comment_length']) ) { throw new AeFormCommentTooLongException ($l1); } $ay = jm ($note_id); if ($ds == 'new' and !xb ($ay)) { throw new AeFormNoteNotCommentableException ($l1); } if ($e1){ throw new AeFormCommentIsSpamSuspectException ($l1); } } e2_drop_caches_for_note_($note_id,true); if ($ds == 'new'){ $ss = [ 'NoteID' => (int)$note_id, 'AuthorName' => $name, 'AuthorEmail' => $es, 'Text' => $l1, 'Reply' => '', 'IsVisible' => 1, 'IsAnswerAware' => 1, 'IsSubscriber' => (int)$x1, 'IsSpamSuspect' => (int)$e1, 'IsNew' => 1, 'Stamp' => (int)time (), 'LastModified' => (int)time (), 'IP' => sm (ud ()), 'IsGIPUsed' => intval (!empty ($z1) && !empty ($k1)), 'GIP' => !empty ($z1)?sm ($z1):'', 'GIPAuthorID' => !empty ($k1)?sm ($k1):'', ]; $ss = bm (iq (), 'Comments',$ss); $ds = $ss['ID']; $r1 = [ 'id' => $ds, 'md5' => md5 ($name . $es . $l1), ]; @e3 (USER_DIR. 'last-comment.psa',serialize ($r1)); $t1 = md5 ($ss['ID'].$ss['Stamp'].'x'); l1 ('commenter_ph',$t1); $ay = jm ($note_id); $va = qq ('e2m_note', ['*note' => $ay]); $ba['comment-time'] = [$gn,wa ()]; $ba['commenter']=$name; $ba['commenter-email']=$es; $ba['comment-text']=$l1; $ba['note-title']=$ay['Title']; $ba['note-href']=$va; $ba['comment-href']=$va; $ba['comments-disable-href']=qq ('e2s_note_flag', [ '*note' => $ay, 'flag' => 'IsCommentable', 'value' => 0 ]); $ba['reply-href']=qq ( 'e2m_comment_reply', [ '*note' => $ay, 'comment-number' => $qa ] ); if (isset ($settings['author_email']) and @$settings['notifications']['new_comments']) { $ya = qn ( 'comment-new-to-author',$ba ); $na = e2l_get_string ( 'em--comment-new-to-author-subject', $ba ); $ma = $settings['author_email']; $fa = 'From: '. ln () ."\r\n". 'Reply-to: '. $name .' <'. $es .">"; zn ($ma,$na,$ya,$fa); } if (!$e1){ unset ($ba['commenter-email']); $fa = 'From: '. ln (); foreach (kb ($ay,$es) as $da){ $sa = $da['AuthorEmail']; $aa = md5 ($da['ID'].$da['Stamp'].'x'); $ba['unsubscribe-href']=qq ('e2m_unsubscribe', [ '*note' => $ay, 'unsubscribe-email' => $sa, 'unsubscribe-key' => $aa ] ); $ma = $sa; $ya = qn ('comment-new-to-public',$ba); $na = e2l_get_string ( 'em--comment-new-to-public-subject', $ba ); zn ($ma,$na,$ya,$fa); } } } else { $j1 = [ 'ID' => $ds, 'Text' => $l1, 'IsVisible' => 1, 'IsSubscriber' => ((int)$x1), 'LastModified' => time (), ]; if (!empty ($name))$j1['AuthorName']=$name; if (!empty ($es))$j1['AuthorEmail']=$es; ym (iq (), 'Comments',$j1); } return (int)$note_id; } define ('E2_UA_STRING','Aegea '. E2_RELEASE .' (v'. E2_VERSION .')'); define ('E2_MINIMUM_PHP','5.6'); define ('E2_MINIMUM_MYSQL','5.6'); define ('E2_MINIMUM_MARIADB','10.1'); define ('E2E_STRANGE_ERROR',10); define ('E2E_USER_ERROR',20); define ('E2E_PERMISSIONS_ERROR',30); define ('E2E_MESSAGE',100); define ('E2E_DIAGNOSTICS_MESSAGE',110); define ('DEFAULT_TEMPLATE','acute'); define ('DEFAULT_FORMATTER','neasden'); define ('E2_NEW_FILES_RIGHTS',0777); define ('E2_JSON_STYLE',JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE); define ('DEFAULT_ITEMS_PER_PAGE',10); define ('MAX_ITEMS_PER_PAGE',100); define ('SYSTEM_DIR','system/'); define ('SYSTEM_DEFAULTS_DIR','system/default/'); define ('SYSTEM_THEME_DIR','system/theme/'); define ('LANGUAGES_DIRNAME','languages/'); define ('LIBRARY_DIRNAME','library/'); define ('THEMES_DIRNAME','themes/'); define ('EXTRAS_DIRNAME','extras/'); define ('SCRIPTS_SUBDIR','js/'); define ('LOGS_DIRNAME','logs/'); define ('CACHES_DIRNAME','caches/'); define ('BACKUP_DIRNAME','backup/'); define ('MAIN_LOG_FILENAME','main.log'); define ('PICTURES_DIRNAME','pictures/'); define ('THUMBNAILS_DIRNAME','pictures/thumbs/'); define ('AVATARS_DIRNAME','pictures/avatars/'); define ('USERPIC_DIRNAME','pictures/userpic/'); define ('VIDEO_DIRNAME','video/'); define ('AUDIO_DIRNAME','audio/'); define ('LICENSE_FILENAME','license.psa'); define ('THUMB_WIDTH',180); define ('THUMB_HEIGHT',120); define ('THUMB_JPG_QUALITY',50); define ('SCALED_IMAGE_JPG_QUALITY',80); define ('USERPIC_WIDTH',80); define ('USERPIC_HEIGHT',80); define ('USERPIC_JPG_QUALITY',80); define ('VIDEO_ICON_FILENAME','images/video.svg'); define ('AUDIO_ICON_FILENAME','images/audio.svg'); define ('VIDEO_ICON_WIDTH',180); define ('VIDEO_ICON_HEIGHT',120); define ('AUDIO_ICON_WIDTH',120); define ('AUDIO_ICON_HEIGHT',120); define ('ALIAS_MAX_LENGTH',64); define ('CACHE_ALIASMAP',CACHE and true); define ('CACHE_NOTES',CACHE and true); define ('CACHE_NOTES_RELATED',CACHE and true); define ('CACHE_NOTES_COMMENTS',CACHE and true); define ('CACHE_POPULAR',CACHE and true); define ('CACHE_POPULAR_WITH_TAG',CACHE and true); define ('CACHE_RANDOM_NOTE',CACHE and true); define ('CACHE_TAGS',CACHE and true); define ('CACHE_FAVTAGS',CACHE and true); define ('CACHE_NOTES_COUNTS',CACHE and true); define ('CACHE_EDGE_TIMEINFO',CACHE and true); define ('CACHE_FRONTPAGE',CACHE and true); define ('CACHE_FRONTPAGE_FEED',CACHE and true); define ('CACHE_TAG',CACHE and true); define ('CACHE_FULLLIST',CACHE and true); define ('CACHE_DRAFTS',CACHE and true); define ('CACHE_DRAFTS_ALIAS_USE_COUNTS',CACHE and true); define ('CACHE_LASTMODIFIEDS',CACHE and true); define ('CACHE_INDEXED_FLAG',CACHE and true); define ('CACHE_FILENAME_ALIASMAP',CACHES_DIRNAME . 'aliasmap.psa'); define ('CACHE_FILENAMES_NOTES',CACHES_DIRNAME . 'note-*.psa'); define ('CACHE_FILENAMES_NOTES_RELATED',CACHES_DIRNAME . 'note-*-related.psa'); define ('CACHE_FILENAMES_NOTES_COMMENTS',CACHES_DIRNAME . 'note-*-comments.ctree.psa'); define ('CACHE_FILENAMES_NOTES_COMMENTS_AUTHOR',CACHES_DIRNAME . 'note-*-comments-author.ctree.psa'); define ('CACHE_FILENAMES_NOTES_COUNTS',CACHES_DIRNAME . 'notes-count-*.txt'); define ('CACHE_FILENAMES_EDGE_TIMEINFO',CACHES_DIRNAME . '*.e2time.psa'); define ('CACHE_FILENAME_POPULAR',CACHES_DIRNAME . 'popular.ctree.psa'); define ('CACHE_FILENAME_POPULAR_EXPIRES',CACHES_DIRNAME . 'popular-expires.txt'); define ('CACHE_FILENAME_RANDOM_NOTE',CACHES_DIRNAME . 'random-note.psa'); define ('CACHE_FILENAMES_POPULAR_WITH_TAG',CACHES_DIRNAME . 'popular-*.ctree.psa'); define ('CACHE_FILENAMES_POPULAR_WITH_TAG_EXPIRES',CACHES_DIRNAME . 'popular-*-expires.txt'); define ('CACHE_FILENAME_TAGS',CACHES_DIRNAME . 'tags.ctree.psa'); define ('CACHE_FILENAME_TAGS_FULL',CACHES_DIRNAME . 'tags-full.ctree.psa'); define ('CACHE_FILENAME_TAGS_AUTHOR',CACHES_DIRNAME . 'tags-author.ctree.psa'); define ('CACHE_FILENAME_TAGS_AUTHOR_FULL',CACHES_DIRNAME . 'tags-author-full.ctree.psa'); define ('CACHE_FILENAME_FAVTAGS',CACHES_DIRNAME . 'favtags.ctree.psa'); define ('CACHE_FILENAME_FRONTPAGE',CACHES_DIRNAME . 'frontpage.ctree.psa'); define ('CACHE_FILENAME_FRONTPAGE_AUTHOR',CACHES_DIRNAME . 'frontpage-author.ctree.psa'); define ('CACHE_FILENAME_FRONTPAGE_FEED',CACHES_DIRNAME . 'frontpage-feed.psa'); define ('CACHE_FILENAMES_TAG',CACHES_DIRNAME . 'tag-*.ctree.psa'); define ('CACHE_FILENAMES_TAG_AUTHOR',CACHES_DIRNAME . 'tag-*-author.ctree.psa'); define ('CACHE_FILENAME_FULLLIST',CACHES_DIRNAME . 'notes-list.ctree.psa'); define ('CACHE_FILENAME_DRAFTS',CACHES_DIRNAME . 'drafts.psa'); define ('CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS',CACHES_DIRNAME . 'drafts-auc.psa'); define ('CACHE_FILENAME_LASTMODIFIEDS',CACHES_DIRNAME . 'last-modifieds-by-id.psa'); define ('CACHE_FILENAME_INDEXED_FLAG',CACHES_DIRNAME . 'indexed.flag'); define ('FP_NO_ID_OR_NEW', -1); define ('FP_INSERT_ERROR', -10); define ('FP_UPDATE_ERROR', -11); define ('FP_EMPTY_FIELD', -20); define ('FP_TITLE_OR_TEXT_EMPTY', -21); define ('FP_NOT_COMMENTABLE', -30); define ('FP_COMMENT_DOUBLE_POST', -101); define ('FP_COMMENT_TOO_LONG', -102); define ('FP_COMMENT_SPAM_SUSPECT', -103); define ('NOTE_COMMENTABLE_NOW', -1); define ('NOTE_COMMENTABLE_NOW_CONDITIONALLY', -2); define ('SECONDS_IN_A_MINUTE',60); define ('SECONDS_IN_AN_HOUR',3600); define ('SECONDS_IN_A_DAY',86400); define ('SECONDS_IN_A_WEEK',604800); define ('SECONDS_IN_A_MONTH',2592000); define ('SECONDS_IN_A_YEAR',31536000); function e2m_drafts ($parameters){ global$_strings,$_config; $draftsView = new AePageableNotesView ('e2m_drafts',$parameters); $draftsView -> setPortionSize ((int)$_config['drafts_per_page']); $draftsView -> setNextPrevPageTitles ($_strings['gs--earlier'],$_strings['gs--later']); $draftsView -> setWantPaging (true); $draftsView -> setUseLocalHrefs (true); if($draftsView -> isFirstPage () and CACHE_DRAFTS){ $draftsView -> setCacheFilename (USER_DIR . CACHE_FILENAME_DRAFTS); } $draftsView -> setLimitlessSQLRequest ( "SELECT * ". "FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished`=0 ". "ORDER BY `LastModified` DESC" ); $h1 = $draftsView -> getNotesCTree (); if(count ($h1)) { if(Log::$a)__log ('Thumbnails {'); foreach ($h1 as $s3 => $a3){ $h1[$s3]['thumbs']=z2 (@$a3['format-info']['resources-detected']); } if(Log::$a)__log ('}'); } $ms = $_strings['pt--drafts']; if($parameters['page']>1){ $ms .= ' ('. $_strings['gs--page'] .' '. $parameters['page'] .')'; } $cb = [ 'title' => $ms, 'heading' => $_strings['pt--drafts'], 'notes' => $h1, 'pages' => $draftsView -> getPagesCTree (), ]; if(count ($h1) >= 5){ $cb['secret-link-promo']=e2l_get_string ( 'pm--secret-link', ['url' => $_config['paid_features_url']] ); } if($draftsView -> isFirstPageOfEmptyView ()) { $cb['nothing']=$_strings['gs--no-drafts']; } elseif (!$draftsView -> isExistingPage ()) { return e2m_error404 (); } return $cb; } function tb ($g1){ global$_config; if(Log::$a)__log ('Drafts: find duplicate OriginalAliases...'); if(CACHE_DRAFTS_ALIAS_USE_COUNTS and is_file (USER_DIR . CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS)) { $w1 = @unserialize (file_get_contents (USER_DIR . CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS)); } if(CACHE_DRAFTS_ALIAS_USE_COUNTS and @is_array ($w1)) { if(Log::$a)__log ('Drafts: retrieve cached'); } else { if(Log::$a)__log ('Drafts: assemle cacheable...'); $w1 = array (); mm ( "SELECT `OriginalAlias` FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished`=0 ". "ORDER BY `ID`", 'get original aliases of drafts to calculate use counts' ); $x3 = dm (); $xn = array (); foreach ($x3 as $s3 => $ay){ @$w1[$ay['OriginalAlias']] ++; } if(CACHE_DRAFTS_ALIAS_USE_COUNTS){ e3 (USER_DIR . CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS,serialize ($w1)); } } return $w1[$g1]; } function jb () { global$_strings; $u1 = 'https://'. $_strings['e2--website-host'] .'/'; $i1 = '('. $_strings['e2--release'] .' '. E2_RELEASE .', v'. E2_VERSION .')'; return [ 'built?' => BUILT, 'installed?' => (cn () !== null), 'version' => 'v'. E2_VERSION, 'version-description' => $_strings['e2--vname-aegea'] .' '. $i1, 'user-folder-name' => jq (), 'cookie-prefix' => q1 (), 'href' => $u1, 'about' => ( '<span title="E2 '.$i1 .'">'. $_strings['e2--powered-by'] .' '. '<a href="'. $u1 .'" class="nu"><u>'. $_strings['e2--vname-aegea'] .'</u> '. '<span class="e2-svgi">'. if_ ('aegea') .'</span></a></span>' ), ]; } function hb ($o1,$type = E2E_STRANGE_ERROR){ global$errors,$_config; if (!isset ($errors))$errors = []; $p1 = (!cs ()+1 <= (int)$_config['show_call_stack']); if ($o1){ if ($o1[0]!='<')$o1 = '<p>' . $o1 .'</p>'; $cq = array ( 'description' => $o1, 'type' => $type, ); if($type == E2E_STRANGE_ERROR and $p1){ $cq['backtrace']=debug_backtrace (); } $errors[] = $cq; } return true; } function gb ($vq){ global$_strings; if(count ($vq)==0) return false; $bq = ''; $bq .= '<p>'. $_strings['gs--enable-write-permissions-for-the-following'] .'</p>'; $bq .= '<ul>'; foreach ($vq as $tv){ if ($tv == '.')$tv = ''; $bq .= '<li><tt>./'. $tv .'</tt></li>'; } $bq .= '</ul>'; return $bq; } function wb ($yq,$o1,$nq = false,$mq = false,$fq = []) { global$errors; if (!(error_reporting () & $yq) or ($yq & 8)) return; $nq = str_replace (__DIR__,'',$nq); hb ($nq .', line '. $mq .'<br />Error '. $yq .': '. $o1); $errors[count ($errors)-1]['phpcode']=$yq; } function ub ($dq,$sq,$m2,$pm){ if (!(error_reporting () & $dq)) return; throw new ErrorException($sq,0,$dq,$m2,$pm); } function ib () { global$errors,$_config; if (!isset ($errors))$errors = []; @session_start (); if(is_array (@$_SESSION['errors'])) { $e = array_merge (@$_SESSION['errors'],$errors); } else { $e = $errors; } $p1 = (!cs ()+1 <= (int)$_config['show_call_stack']); if (@$_config['store_backtrace'] and $p1 and $e != NULL){ @e3 ('backtrace.psa',serialize ($e)); } else { @unlink ('backtrace.psa'); } if (isset ($_SESSION['errors'])) unset($_SESSION['errors']); $cb = array (); $aq = false; if(count ($e)>0){ foreach($e as $rb => $qq){ if ($qq['type']==E2E_STRANGE_ERROR){ $qq['class']='serious'; $aq = true; if ($p1){ $qq['backtrace']=pb ($qq['backtrace']); } } if ($qq['type']==E2E_MESSAGE){ $qq['class']='info'; } $e[$rb]=$qq; } $cb['each']=$e; if ( $aq and @$_config['store_backtrace'] and $p1 and is_file ('debug.php') ) { $cb['debug-link']='debug.php'; } } return $cb; } function ob () { $errors = ib (); foreach($errors['each'] as $lq){ echo '<p>'. $lq['description'] .'</p>'; } die; } function pb ($zq){ if (!is_array ($zq)) return 'No backtrace info'; $zq = array_reverse ($zq); $zq = array_splice ($zq,0,count ($zq)-1); $e = '<p style="background: #fea; padding: .25em .5em; line-height: 1em; overflow: hidden">'; foreach ($zq as $rb => $kq){ $xq = @$kq['args'] or $xq = array (); $eq = array (); foreach ($xq as $rq){ $eq[] = var_export ($rq,true); } $m2 = @$kq['file']; $m2 = str_replace ($_SERVER['DOCUMENT_ROOT'],'',$m2); $pm = (@$kq['line']? (' #'. $kq['line']) : '?'); $e .= '<div style="margin: .25em 0 .5em '. $rb*3 .'em">'; $e .= '<span style="float: right; color: #666"> '. $m2 . $pm .'</span>'; $e .= '<tt><b>'. @$kq['function'] .' (</b>'; if(count ($eq)) { $tq = str_replace ("array (\n)",'array ()',$eq); $tq = implode (', ',$tq); if(0){ $tq = highlight_string ('<?'. $tq .'?'.'>',true); $tq = substr ($tq,77, -28); } $tq = str_replace ('&nbsp;',' ',$tq); $tq = nl2br ($tq); $e .= '<div style="margin: 0 0 0 1.12em">'. $tq .'</div>'; } $e .= '<b>)</b> &rarr;</tt></div>'; } $e .= '</p>'; return$e; } class AeException extends \Exception {} class AeMySQLException extends AeException {} class AeMySQLNotFoundException extends AeMySQLException {} class AeMySQLTooOldException extends AeMySQLException {} class AeMySQLCannotConnectException extends AeMySQLException {} class AeMySQLAccessDeniedException extends AeMySQLCannotConnectException {} class AeMySQLQueryException extends AeMySQLException {} class AeMySQLNoDataException extends AeMySQLException {} class AeMySQLNotMigrateableException extends AeMySQLException {} class AeMySQLCorruptedUpdateRecordCallException extends AeMySQLException {} class AeRecordNotFoundException extends AeException {} class AeInstallException extends AeException {} class AeInstallAlreadyInstalledException extends AeInstallException {} class AeInstallDatabaseOccupiedException extends AeInstallException {} class AeBackupFailedException extends AeException {} class AeWritePermissionsException extends AeException {} class AeNotSavedException extends AeWritePermissionsException {} class AeTokenException extends AeException {} class AeOlbaException extends AeException {} class AeOlbaTemplateMissingException extends AeOlbaException {} class AeStubException extends AeException {} class AeFormException extends AeException {} class AeFormInconsistentException extends AeFormException {} class AeFormIncompleteException extends AeFormException { public $note_id = ''; function __construct ($note_id){ $this->note_id = $note_id; parent::__construct (); } } class AeFormCommentUnacceptableException extends AeFormException { public $comment_text = ''; function __construct ($comment_text){ $this->comment_text = $comment_text; parent::__construct (); } } class AeFormDuplicateCommentException extends AeFormCommentUnacceptableException {} class AeFormCommentTooLongException extends AeFormCommentUnacceptableException {} class AeFormNoteNotCommentableException extends AeFormCommentUnacceptableException {} class AeFormCommentIsSpamSuspectException extends AeFormCommentUnacceptableException {} function c3 ($jq,$hq = false){ $gq = substr (__DIR__,0,strrpos (__DIR__,'/')); $wq = ''; $uq = []; foreach(array_reverse ($jq -> getTrace ()) as $iq){ $oq['where']=str_replace ( $gq .'/','',$iq['file'] ) .':'. $iq['line']; $pq = []; foreach ($iq['args'] as $cl){ $pq[] = htmlspecialchars ( str_replace ("\n","\n  ",var_export ($cl,true)), ENT_NOQUOTES,'UTF-8' ); } $vl = ''; if(count ($pq)) { $vl = ("\n". '  '. implode (",\n  ",$pq). "\n" ); } $oq['call']=$iq['function'] .' ('. $vl .')'; $uq[] = $oq; } do { if ((string)$jq -> getMessage () !== ''){ $wq .= $jq -> getMessage () ."\n"; } $wq .= "\n";; $wq .= ( get_class ($jq) .' in '. str_replace ( $gq .'/','',$jq -> getFile () ) .':'. $jq -> getLine (). "\n" ); if ($jq -> getCode ()) { $wq .= 'Code: '. $jq -> getCode () ."\n"; } $bl = ''; $rb = 1; foreach ($uq as $pm){ $bl .= $rb++ .'. '. $pm['where'] .' '. $pm['call']. "\n"; if (!$hq)$bl .= "\n";; } $wq .= "\n";; } while ($jq = $jq -> getPrevious ()); if ($hq){ $bl = preg_replace ('/^.*?$/smu','│            $0',$bl); $wq .= '┌─'. "\n"; $wq .= $bl; $wq .= '└─'; } else { $wq .= $bl; } return $wq; } function v3 ($jq,$sq = ''){ global$_config; if($_config['dev_verbose'] > (int) !cs ()) { hb ('<pre>'. c3 ($jq) .'</pre>'); } if($_config['log_errors']) { Log::$a = true; if(Log::$a)dn ('error-$'); } if(Log::$a)__log ('Exception caught: '. c3 ($jq,true)); if(Log::$a)dn (''); if ((string)$sq !== ''){ if(Log::$a)__log ($sq); } } function b3 ($jq){ global$_config,$content; $content['title']=':-('; $content['exception-message']=$jq -> getMessage (); $yl['error']['message']=':-('; if (($_config['dev_verbose'] > (int) !cs ())) { $content['exception-string']=c3 ($jq); $yl['error']['message']=nl2br (c3 ($jq)); } if($_config['log_errors']) { Log::$a = true; if(Log::$a)dn ('error-$'); } if(Log::$a)__log ('Panic: '. c3 ($jq,true)); if(Log::$a)__log (':-('); if(array_key_exists ('result',$_POST) and ($_POST['result']=='ajaxresult')) { $cb = json_encode ($yl); } else { $cb = rf ('panic',true); } echo $cb; die; } function y3 ($jq){ b3 ($jq); } function e2m_most_commented ($parameters = []) { global$settings,$_strings,$_config; $tn = cs (); $mostCommentedView = new AePageableNotesView ('e2m_most_commented',$parameters); $mostCommentedView -> setPortionSize ($settings['appearance']['notes_per_page']); $mostCommentedView -> setNextPrevPageTitles ($_strings['gs--earlier'],$_strings['gs--later']); $mostCommentedView -> setWantNewCommentsCount ($tn); $mostCommentedView -> setWantReadHrefs ($_config['count_reads']); $mostCommentedView -> setWantControls ($tn and !@$_config['read_only']); $mostCommentedView -> setWantHiddenTags ($tn); AeMainMenuManager :: $isMostCommentedCurrent = $mostCommentedView->isFirstPage (); AeMainMenuManager :: $isMostCommentedParent = !$mostCommentedView->isFirstPage (); $nl = $_config['hot_period']; $ml = time () - n3 ($_config['hot_period']); $mostCommentedView -> setLimitlessSQLRequest ( "SELECT * ". "FROM `". $_config['db_table_prefix'] ."Notes` n ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished`=1 ". nf ($tn). "AND `ID` IN ( ". "SELECT `NoteID` FROM ( ". "SELECT `NoteID`, COUNT(*) `CommentsCount` ". "FROM `". $_config['db_table_prefix']."Comments` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsVisible` = 1 ". "AND `Stamp` > ". $ml . " ". "GROUP BY `NoteID` ". "ORDER BY `CommentsCount` DESC ". ") As MostCommentedNotesIDs ". ")" ); $cb = [ 'title' => e2l_get_string ('pt--most-commented', ['period' => $nl]), 'heading' => e2l_get_string ('pt--most-commented', ['period' => $nl]), 'notes' => $mostCommentedView -> getNotesCTree (), 'pages' => $mostCommentedView -> getPagesCTree (), ]; if($mostCommentedView -> isFirstPageOfEmptyView ()) { $cb['nothing']=$_strings['gs--no-such-notes']; } elseif (!$mostCommentedView -> isExistingPage ()) { return e2m_error404 (); } return $cb; } function e2m_favourites ($parameters = []) { global$settings,$_config,$_strings; $tn = cs (); $favouritesView = new AePageableNotesView ('e2m_favourites',$parameters); $favouritesView -> setPortionSize ($settings['appearance']['notes_per_page']); $favouritesView -> setNextPrevPageTitles ($_strings['gs--earlier'],$_strings['gs--later']); $favouritesView -> setWantPaging (true); $favouritesView -> setWantNewCommentsCount ($tn); $favouritesView -> setWantReadHrefs ($_config['count_reads']); $favouritesView -> setWantControls ($tn and !@$_config['read_only']); $favouritesView -> setWantHiddenTags ($tn); AeMainMenuManager :: $isFavouritesCurrent = $favouritesView->isFirstPage (); AeMainMenuManager :: $isFavouritesParent = !$favouritesView->isFirstPage (); $favouritesView -> setLimitlessSQLRequest ( "SELECT * ". "FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished`=1 ". "AND `IsFavourite`=1 ". nf ($tn). "ORDER BY `Stamp` DESC" ); $ms = $_strings['pt--favourites']; if($parameters['page']>1){ $ms .= ' ('. $_strings['gs--page'] .' '. $parameters['page'] .')'; } $cb = [ 'title' => $ms, 'heading' => $_strings['pt--favourites'], 'notes' => $favouritesView -> getNotesCTree (), 'pages' => $favouritesView -> getPagesCTree (), ]; if($favouritesView -> isFirstPageOfEmptyView ()) { $cb['nothing']=$_strings['gs--no-favourites']; } elseif (!$favouritesView -> isExistingPage ()) { return e2m_error404 (); } return $cb; } function n3 ($nl){ if ('year' == $nl) return SECONDS_IN_A_YEAR; elseif ('month' == $nl) return SECONDS_IN_A_MONTH; elseif ('week' == $nl) return SECONDS_IN_A_DAY * 7; elseif ('day' == $nl) return SECONDS_IN_A_DAY; else return PHP_INT_MAX; } function e2m_json ($parameters = array ()) { list ($fl,$gn)=q3 (); $dl = json_encode ($fl,E2_JSON_STYLE); x3 ($dl,$gn,'json'); } function e2m_rss ($parameters = array ()) { list ($fl,$gn)=q3 (); $sl = e2feeds__rss_using_jsonfeed_array_($fl); x3 ($sl,$gn,'rss'); } function e2m_tag_json ($parameters = array ()) { if(array_key_exists ('*tag',$parameters)) { $tb = $parameters['*tag']; } else { return e2m_error404 (); } list ($fl,$gn)=l3 ($tb); $dl = json_encode ($fl,E2_JSON_STYLE); x3 ($dl,$gn,'json'); } function e2m_tag_rss ($parameters = array ()) { if(array_key_exists ('*tag',$parameters)) { $tb = $parameters['*tag']; } else { return e2m_error404 (); } list ($fl,$gn)=l3 ($tb); $sl = e2feeds__rss_using_jsonfeed_array_($fl); x3 ($sl,$gn,'rss'); } function e2m_note_json ($parameters = array ()) { global$settings,$_current_url; $ay = $parameters['*note']; if ($ay == false) return e2m_error404 (); $tn = cs (); if (!( yf ($ay)==='public' or ($tn and $ay['IsPublished']) )) return e2m_error404 (); $gn = $ay['Stamp']; $al = e2_jsonfeed_item_array_from_noterec_($ay); $ql = array ($al); $fl = e2_jsonfeed_array_stub_from_jsonfeed_item_arrays_($ql); $fl['title']=ev (); $fl['_rss_description']=a3 (); $fl['home_page_url']=qq ('e2m_frontpage', array ('page' => 1)); $fl['feed_url']=$_current_url; x3 (json_encode ($fl,E2_JSON_STYLE),$gn,'json'); } function e2_jsonfeed_array_stub_from_jsonfeed_item_arrays_($ql){ global$_lang,$_config,$settings; $cb = [ 'version' => 'https://jsonfeed.org/version/1', 'title' => null, '_rss_description' => null, '_rss_language' => $_lang, '_itunes_email' => '', '_itunes_categories_xml' => '', '_itunes_image' => '', '_itunes_explicit' => '', 'home_page_url' => null, 'feed_url' => null, 'icon' => tv (), 'author' => array ( 'name' => rv (), 'url' => qq ('e2m_frontpage', array ('page' => 1)), 'avatar' => tv (), ), 'items' => $ql, '_e2_version' => E2_VERSION, '_e2_ua_string' => E2_UA_STRING, ]; return $cb; } function e2_jsonfeed_item_array_from_noterec_($ay){ global$settings; $url = qq ('e2m_note', array ('*note' => $ay)); $ll = ( c1 ('Y-m-d\TH:i:s',$ay['Stamp']) . f1 ($ay['Stamp'],':') ); $zl = ( c1 ('Y-m-d\TH:i:s',$ay['LastModified']) . f1 ($ay['LastModified'],':') ); $kl = ( c1 ('D, d M Y H:i:s ',$ay['Stamp']) . f1 ($ay['Stamp']) ); $sd = ay ($ay['FormatterID'], @$ay['Text'],'full-rss'); $v3 = t3 ( q2 ( $sd['meta']['resources-detected'], g3 ('note',$ay['ID']) ) ); $v = array ( 'id' => (string)$ay['ID'], 'url' => $url, 'title' => dy ($ay['Title']), 'content_html' => $sd['text-final'], 'date_published' => $ll, 'date_modified' => $zl, ); if ($ay['IsExternal']) { $el = py ($ay); $v['url']=$el['href-external']; $v['author'] = array ( 'name' => $el['author'], 'url' => $el['author-href'], 'avatar' => $el['userpic-href'], ); } if(count ($v3)>0){ $v['image']=$v3[0]; } $v['_date_published_rfc2822']=$kl; $v['_rss_guid_is_permalink']='false'; $v['_rss_guid'] = (string)$ay['ID']; $v['_e2_data'] = array ( 'is_favourite' => (bool)$ay['IsFavourite'], 'links_required' => $sd['meta']['links-required'], 'og_images' => $v3, ); return $v; } function d3 ($rl,$ms,$n1){ global$_newsfeeds; if (!isset ($_newsfeeds))$_newsfeeds = []; $tl = ''; if ($rl == 'rss')$tl = 'application/rss+xml'; if ($rl == 'json')$tl = 'application/json'; $_newsfeeds[] = [ 'type' => $tl, 'title' => htmlspecialchars ($ms,ENT_NOQUOTES,'UTF-8'), 'href' => $n1 ]; } function s3 () { global$_config; mm ( "SELECT * FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished`=1 ". nf (). "ORDER BY `Stamp` DESC ". "LIMIT ". $_config['rss_items'], 'get recent public noterecs for RSS or JSONFeed' ); return dm (); } function a3 () { global$settings; if (!empty ($settings['meta_description'])) { $jl = strip_tags (dy (htmlspecialchars ($settings['meta_description'],ENT_NOQUOTES,'UTF-8'))); } elseif (!empty ($settings['blog_subtitle'])) { $sd = qy ($settings['blog_subtitle'],'full'); $jl = $sd['text-final']; $jl = bf ($jl); } else { $jl = ev (); } return $jl; } function q3 () { global$settings,$_current_url; $gn = 0; $ql = array (); $fl = array (); $wf = USER_DIR . CACHE_FILENAME_FRONTPAGE_FEED; if(CACHE_FRONTPAGE_FEED and is_file ($wf)) { if(Log::$a)__log ('Feed array (RSS, JSON): cached'); $fl = @unserialize (file_get_contents ($wf)); $gn = filemtime ($wf); } else { if(Log::$a)__log ('Feed array (RSS, JSON): not cached, will need to build'); $yf = s3 (); foreach ($yf as $ay){ $ql[] = e2_jsonfeed_item_array_from_noterec_($ay); $gn = max ($gn,$ay['Stamp']); } $fl = e2_jsonfeed_array_stub_from_jsonfeed_item_arrays_($ql); $fl['title']=ev (); $fl['_rss_description']=a3 (); $fl['home_page_url']=qq ('e2m_frontpage', array ('page' => 1)); $fl['feed_url']=$_current_url; if(CACHE_FRONTPAGE_FEED)e3 ($wf,serialize ($fl)); } return array ($fl,$gn); } function l3 ($tb){ global$_config,$_strings,$_current_url; $gn = 0; $ql = array (); mm ( "SELECT n.* ". "FROM `". $_config['db_table_prefix']."Notes` n ". "INNER JOIN `". $_config['db_table_prefix']."NotesKeywords` nk ". "ON nk.`NoteID` = n.`ID` ". "WHERE n.`SubsetID`=". $_config['db_table_subset'] ." ". "AND nk.`SubsetID`=". $_config['db_table_subset'] ." ". "AND (nk.`KeywordID` = ". $tb['ID'] .") ". "AND n.`IsPublished` = 1 ". nf (cs ()). "ORDER BY n.`Stamp` DESC ". "LIMIT ". $_config['rss_items'], 'get tag noterecs for RSS or JSONFeed' ); $yf = dm (); foreach ($yf as $ay){ $ql[] = e2_jsonfeed_item_array_from_noterec_($ay); $gn = max ($gn,$ay['Stamp']); } if ((string)$tb['Summary']!==''){ $jl = strip_tags (dy (htmlspecialchars ($tb['Summary'],ENT_NOQUOTES,'UTF-8'))); } else if ((string)$tb['Description']!==''){ $sd = qy ($tb['Description'],'full'); $jl = $sd['text-final']; $jl = bf ($jl); } else { $jl = a3 (); } $hl = htmlspecialchars ($tb['PageTitle'],ENT_COMPAT,'UTF-8'); if ((string)$hl !== ''){ $ms = $hl; } else { $ms = ( ev () .': '. $_strings['gs--posts-tagged'] .' '. htmlspecialchars ($tb['Keyword'],ENT_COMPAT,'UTF-8') ); } $fl = e2_jsonfeed_array_stub_from_jsonfeed_item_arrays_($ql); $fl['title']=$ms; $fl['_rss_description']=$jl; $fl['home_page_url']=qq ('e2m_tag', array ('*tag' => $tb)); $fl['feed_url']=$_current_url; return array ($fl,$gn); } function e2feeds__rss_using_jsonfeed_array_($content){ $gl = USER_DIR . 'rss/rss.tmpl.php'; if (!is_file ($gl)) { $gl = SYSTEM_DEFAULTS_DIR . 'rss/rss.tmpl.php'; } if(is_file ($gl)) { ob_start (); include $gl; $sl = ob_get_contents (); ob_end_clean (); } return $sl; } function k3 ($sl){ $sl = str_replace ("\x0",'',$sl); for ($rb = 0; $rb < strlen ($sl); ++$rb){ if(ord ($sl[$rb]) < 32 and !in_array (ord ($sl[$rb]), array (10,13))) { $sl[$rb]=''; } } return $sl; } function x3 ($wl,$gn,$rl){ global$_config; $ul = gmdate ('r',$gn); $il = md5 ($gn); if ($rl == 'rss'){ if (@$_config['dev_xml_as_text']) { header ('Content-Type: text/plain'); } else { header ('Content-Type: application/xml; charset=utf-8'); } } elseif ($rl == 'json'){ header ('Content-Type: application/json'); } else { header ('Content-Type: text/plain'); } header ('Last-modified: '. $ul); header ('Etag: '. $il); header ('Cache-Control: public'); header ('Expires: '. date ('r',$gn + SECONDS_IN_A_DAY)); $ol = isset($_SERVER['HTTP_IF_MODIFIED_SINCE'])? stripslashes ($_SERVER['HTTP_IF_MODIFIED_SINCE']) : false; $pl = isset($_SERVER['HTTP_IF_NONE_MATCH'])? stripslashes ($_SERVER['HTTP_IF_NONE_MATCH']) : false; if ( !$ol && !$pl or $pl && $pl != $il or $ol && $ol != $ul ) { if ($rl == 'rss'){ $wl = k3 ($wl); } ini_set ('zlib.output_compression',0); echo $wl; ini_set ('zlib.output_compression',1); } else { header ('HTTP/1.1 304 Not Modified'); } die; } define ('CROP_NONE',0); define ('CROP_SQUARE',1); function e3 ($m2,$c4){ @cq (dirname ($m2)); if (!@file_put_contents ($m2,$c4,LOCK_EX)) { return false; } @chmod ($m2,E2_NEW_FILES_RIGHTS); return true; } function e2s_retrieve ($parameters){ $url = base64_decode (strtr ($parameters['url'],'-_','+/')); if(Log::$a)__log ('Retrieve: '. $url); r2 ($url,PROVIDE_MEDIA_NOW); die; } function r3 ( $hy,$v4,$ib ){ $b4 = []; if(is_array ($ib)) { $b4 = s2 ($ib); } $y4 = @unserialize ( $v4['Uploads'] ) or $y4 = []; $n4 = array_diff ($b4,$y4); if(count ($n4)>0){ u3 ($hy,$v4['ID'],'add',$n4); } return $n4; } function t3 ($m4){ $rv = []; foreach (l2 ($m4) as $f4){ $rv[] = $f4['src']; } return $rv; } function j3 ($name,$d4){ global$_config; $name = k1 ($name); if(preg_match('//u',$name))$name = pq ($name,false); if ($d4 == 'image'){ $w = $_config['path_media'].PICTURES_DIRNAME; } elseif ($d4 == 'video'){ $w = $_config['path_media'].VIDEO_DIRNAME; } elseif ($d4 == 'audio'){ $w = $_config['path_media'].AUDIO_DIRNAME; } else { return false; } $s4 = ''; for ($rb = 0; $rb < strlen ($name); $rb++) { if($name[$rb]=='?'){ $s4 .= ''; } elseif($name[$rb]==' '){ $s4 .= '-'; } elseif(ord ($name[$rb]) <= 127){ $s4 .= $name[$rb]; } } if ($s4 == '')$s4 = $d4; if ($s4[0]=='.')$s4 = $d4 . $s4; return $s4; } function h3 ($a4){ global$_config; if(Log::$a)__log ('Count references for upload <'. $a4 .'>'); if(is_file (USER_DIR . 'new-uploads.psa')) { $q4 = @unserialize (file_get_contents (USER_DIR . 'new-uploads.psa')); } $l4 = '%'. str_replace ('%','#%',$a4) .'%'; mm ( "SELECT `ID`, `Text`, `FormatterID`, `Uploads` ". "FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND (`Text` LIKE '". $l4 ."' ESCAPE '#' ". "OR `Uploads` LIKE '". $l4 ."' ESCAPE '#')", 'get notes where uploads may be referenced' ); $x3 = dm (); $z4 = @unserialize ($x3[0]['Uploads']); if (!is_array ($z4)) { foreach ($x3 as $ay){ $sd = ay ( $ay['FormatterID'], @$ay['Text'],'full-rss' ); $z4 = r3 ( 'note',$ay, $sd['meta']['resources-detected'] ); } } mm ( "SELECT `ID`, `Description`, `Uploads` ". "FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND (`Description` LIKE '". $l4 ."' ESCAPE '#' ". "OR `Uploads` LIKE '". $l4 ."' ESCAPE '#')", 'get tags where uploads may be referenced' ); $x3 = dm (); $k4 = @unserialize ($x3[0]['Uploads']); if (!is_array ($k4)) { foreach ($x3 as $tb){ $sd = qy ( @$tb['Description'],'full-rss' ); $k4 = r3 ( 'tag',$tb, $sd['meta']['resources-detected'] ); } } if (!is_array ($q4))$q4 = []; if (!is_array ($z4))$z4 = []; if (!is_array ($k4))$k4 = []; $x4 = array_merge ($q4,$z4,$k4); if(Log::$a)__log ('References found in relevant entries: '. var_export ($x4,true)); if(in_array ($a4,$x4)) { if(Log::$a)__log ('Still referenced, do not delete file'); return true; } return false; } function g3 ($e4,$zy){ global$_config; if ($e4 == 'note' and $zy == 'new'){ if(is_file (USER_DIR . 'new-uploads.psa')) { $x4 = @unserialize (file_get_contents (USER_DIR . 'new-uploads.psa')); } } elseif ($e4 == 'note'){ mm ( "SELECT `Uploads` FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID`=". $zy ); $x3 = dm (); $x4 = @unserialize ($x3[0]['Uploads']); } elseif ($e4 == 'tag'){ mm ( "SELECT `Uploads` FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID`=". $zy ); $x3 = dm (); $x4 = @unserialize ($x3[0]['Uploads']); } if (!is_array ($x4))$x4 = []; return $x4; } function w3 ($e4,$zy,$x4){ global$_config; if ($e4 == 'note' and $zy == 'new'){ if (!@e3 (USER_DIR . 'new-uploads.psa',serialize ($x4))) { hb ('ERROR',E2E_PERMISSIONS_ERROR); } } elseif ($e4 == 'note'){ mm ( "UPDATE `". $_config['db_table_prefix']."Notes` ". "SET `Uploads`='". serialize ($x4) ."' ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID`=". $zy ); } elseif ($e4 == 'tag'){ mm ( "UPDATE `". $_config['db_table_prefix']."Keywords` ". "SET `Uploads`='". serialize ($x4) ."' ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID`=". $zy ); } else { return false; } if (!is_array ($x4))$x4 = []; return $x4; } function u3 ($e4,$zy,$action,$r4){ $x4 = []; if(Log::$a)__log ('Register upload: <'. $e4.', '. $zy.', '. $action.', '. $r4 .'>'); $x4 = g3 ($e4,$zy); $x4 = e1 ($x4,$action,$r4); w3 ($e4,$zy,$x4); } function i3 ($pv,$t4,$ib){ $y4 = @unserialize ($t4['Uploads']) or $y4 = []; $j4 = s2 ($ib); $x4 = e1 ($y4,'add',$j4); $x4 = serialize ($x4); if ($x4 != $t4['Uploads']) { $t4['Uploads']=$x4; ym (iq (), $pv,$t4); } } function e2j_file_upload ($parameters = []) { global$_config,$_strings; @cq ($_config['path_media'].PICTURES_DIRNAME); @chmod ($_config['path_media'].PICTURES_DIRNAME,$_config['uploaded_files_mode']); @cq ($_config['path_media'].VIDEO_DIRNAME); @chmod ($_config['path_media'].VIDEO_DIRNAME,$_config['uploaded_files_mode']); @cq ($_config['path_media'].AUDIO_DIRNAME); @chmod ($_config['path_media'].AUDIO_DIRNAME,$_config['uploaded_files_mode']); $yl = [ 'success' => false ]; if(count ($_FILES)>0){ foreach($_FILES as $m2){ if (!$m2['error']) { if(Log::$a)__log ('Ajax file upload: <'. $m2['name'].'>'); $yl['data']['file-kind']='image'; $w = $_config['path_media'].PICTURES_DIRNAME; if (cd ($m2['name'])) { $yl['data']['file-kind']='video'; $w = $_config['path_media'].VIDEO_DIRNAME; } elseif (vd ($m2['name'])) { $yl['data']['file-kind']='audio'; $w = $_config['path_media'].AUDIO_DIRNAME; } $h4 = ( array_key_exists ('overwrite',$_GET) and is_file ($w . $m2['name']) ); $g4 = false; $yl['data']['overwrite'] = (int)$h4; if(Log::$a)__log ('Ajax file upload: Overwrite is resolved to <'. (int)$h4.'>'); $s4 = j3 ($m2['name'],$yl['data']['file-kind']); if(Log::$a)__log ('Ajax file upload: Safe name is <'. $s4.'>'); if(is_file ($w . $s4)) { if(file_get_contents ($w . $s4)==file_get_contents ($m2['tmp_name'])) { if(Log::$a)__log ('Ajax file upload: Existing file is the same'); $g4 = true; } elseif (!$h4){ $s4 = yd ($w,$s4); } } if (!$g4){ move_uploaded_file ($m2['tmp_name'],$w . $s4); @chmod ($w . $s4,$_config['uploaded_files_mode']); } if(Log::$a)__log ('Ajax file upload: File kind is <'. $yl['data']['file-kind'].'>'); if ($yl['data']['file-kind']=='image'){ $w4 = pathinfo ($s4,PATHINFO_EXTENSION); if (md ($w4,'jpg')) { $u4 = $s4; } else { $u4 = $s4 .'.jpg'; $u4 = yd ( $_config['path_media'].PICTURES_DIRNAME,$u4 ); } $i4 = $_config['path_media'].PICTURES_DIRNAME . $s4; $o4 = $_config['path_media'].PICTURES_DIRNAME . $u4; if(Log::$a)__log ('Ajax file upload: Process uploaded image <'. $i4 .'>'. ' to possibly <'. $o4.'>'); $o4 = e2img_filename_by_processing ( $i4, $o4, [ $_config['fit_uploaded_images'], $_config['fit_uploaded_images'], ], CROP_NONE, SCALED_IMAGE_JPG_QUALITY ); $p4 = $m2['size']; if (!md ($o4,$i4)) { @unlink ($i4); $s4 = $u4; $p4 = stat ($o4)['size']; } if ($h4){ @unlink (g2 ($s4)); } if ($cz = e2img_filename_by_processing ( $o4, g2 ($s4), [THUMB_WIDTH,THUMB_HEIGHT], CROP_NONE, THUMB_JPG_QUALITY )) { if(Log::$a)__log ('Ajax file upload: thumbnail, done as '. $cz); list ($vz,$bz)=e2_getimagesize ($cz); if(Log::$a)__log ('Ajax file upload: image size '. $vz .'×'. $bz); if (!$vz)$vz = THUMB_WIDTH/2; if (!$bz)$bz = THUMB_HEIGHT/2; list ($vz,$bz)=e2_fit_metrics_to_constraints ( [$vz,$bz], [THUMB_WIDTH/2,THUMB_HEIGHT/2] ); $yl['success']=true; $yl['data']['new-name']=$s4; $yl['data']['filesize']=round ($p4 / 1024) .' '. $_strings['gs--kb']; $yl['data']['thumb']=o3 ($cz); $yl['data']['width']=$vz; $yl['data']['height']=$bz; u3 ($parameters['entity'],$parameters['entity-id'],'add', [$s4]); } else { if(Log::$a)__log ('Ajax file upload: couldn’t create thumbnail'); @unlink ($w . $s4); $yl['error']['message']=_S ('er--cannot-create-thumbnail'); } } if ($yl['data']['file-kind']=='video'){ if(Log::$a)__log ('Ajax file upload: video, done'); $yl['success']=true; $yl['data']['new-name']=$s4; $yl['data']['filesize']=round ($m2['size']/1024) .' '. $_strings['gs--kb']; $yl['data']['thumb']=SYSTEM_THEME_DIR . VIDEO_ICON_FILENAME; $yl['data']['width']=VIDEO_ICON_WIDTH/2; $yl['data']['height']=VIDEO_ICON_HEIGHT/2; u3 ($parameters['entity'],$parameters['entity-id'],'add', [$s4]); } if ($yl['data']['file-kind']=='audio'){ if(Log::$a)__log ('Ajax file upload: audio, done'); $yl['success']=true; $yl['data']['new-name']=$s4; $yl['data']['filesize']=round ($m2['size']/1024) .' '. $_strings['gs--kb']; $yl['data']['thumb']=SYSTEM_THEME_DIR . AUDIO_ICON_FILENAME; $yl['data']['width']=AUDIO_ICON_WIDTH/2; $yl['data']['height']=AUDIO_ICON_HEIGHT/2; u3 ($parameters['entity'],$parameters['entity-id'],'add', [$s4]); } } elseif(4 != $m2['error']) { $yl['error']['message'] = ( ny ($m2['error']) ); } } } else { if(Log::$a)__log ('Ajax file upload error: no files'); $yl['error']['message']='No files were received by server'; } $yl = json_encode ($yl); die ($yl); } function o3 ($yz){ global$_config; $nz = strlen ($_config['path_media']); if ($nz and substr ($yz,0,$nz)==$_config['path_media']) { return substr ($yz,$nz); } else { return AeEnv::$base_url . $yz; } } function p3 () { return [ 'userpic.original.png', 'userpic.original.jpg', 'userpic@2x.png', 'userpic@2x.jpg', 'userpic-large@2x.jpg', 'userpic-square@2x.jpg', ]; } function cy () { global$_config; foreach (p3 () as $hd){ @unlink ($_config['path_media'].USERPIC_DIRNAME . $hd); } } function e2j_userpic_remove () { if($_SERVER['REQUEST_METHOD']!='POST'){ s1 (qq ('e2m_settings')); } cy (); $yl = json_encode (['success' => true]); die ($yl); } function e2j_userpic_upload () { global$_config,$_strings; $yl = ['success' => false]; if(count ($_FILES)!=1){ if(Log::$a)__log ('Ajax userpic upload error: no or too many files'); $yl['error']['message']=$_strings['er--cannot-upload-no-or-too-many-files']; $yl = json_encode ($yl); die ($yl); } $m2 = array_pop ($_FILES); if (!$m2['error']) { if(Log::$a)__log ('Ajax userpic upload: <'. $m2['name'].'>'); $mz = pathinfo ($m2['name']); $w4 = strtolower ($mz['extension']); if ($w4 != 'png')$w4 = 'jpg'; $wd = 'userpic.original.'. $w4; $gd = $_config['path_media'].USERPIC_DIRNAME; cy (); move_uploaded_file ($m2['tmp_name'],$gd . $wd); @chmod ($gd . $wd,$_config['uploaded_files_mode']); copy ( $gd . $wd, $gd .'userpic-large@2x.jpg' ); $fz = e2img_filename_by_processing ( $gd .'userpic-large@2x.jpg', $gd .'userpic-large@2x.jpg', [$_config['max_image_width'],$_config['max_image_width']], CROP_NONE, USERPIC_JPG_QUALITY ); copy ( $gd . $wd, $gd .'userpic-square@2x.jpg' ); $dz = e2img_filename_by_processing ( $gd .'userpic-square@2x.jpg', $gd .'userpic-square@2x.jpg', [$_config['max_image_width'],$_config['max_image_width']], CROP_SQUARE, USERPIC_JPG_QUALITY ); $sz = e2img_filename_by_processing ( $gd . $wd, $gd .'userpic@2x.jpg', [USERPIC_WIDTH,USERPIC_HEIGHT], CROP_SQUARE, USERPIC_JPG_QUALITY ); if ($dz){ $az = str_replace (USER_DIR,USER_URLPATH,$dz); $yl = [ 'success' => true, 'data' => [ 'new-image-src' => $az, ] ]; } else { $yl['error']['message']=_S ('er--supported-only-png-jpg-gif'); } } elseif(4 != $m2['error']) { $yl['error']['message'] = ( ny ($m2['error']) ); } $yl = json_encode ($yl); die ($yl); } function e2j_file_remove ($parameters){ global$_config; if (!array_key_exists ('file',$_POST)) { $yl = [ 'success' => false ]; $yl = json_encode ($yl); die ($yl); } $m2 = $_POST['file']; $yl = [ 'success' => true ]; $yl = json_encode ($yl); u3 ($parameters['entity'],$parameters['entity-id'],'remove',$m2); if (!h3 ($m2)) { if (vd ($m2)) { if(Log::$a)__log ('Not referenced, deleting '. $_config['path_media'].AUDIO_DIRNAME . $m2); @unlink ($_config['path_media'].AUDIO_DIRNAME . $m2); } elseif (cd ($m2)) { if(Log::$a)__log ('Not referenced, deleting '. $_config['path_media'].VIDEO_DIRNAME . $m2); @unlink ($_config['path_media'].VIDEO_DIRNAME . $m2); } else { $sz = bd ($m2,'thumb@2x'); if(Log::$a)__log ('Not referenced, deleting '. $_config['path_media'].PICTURES_DIRNAME . $m2); @unlink ($_config['path_media'].PICTURES_DIRNAME . $m2); if(Log::$a)__log ('Not referenced, deleting '. $_config['path_media'].THUMBNAILS_DIRNAME . $m2); @unlink ($_config['path_media'].THUMBNAILS_DIRNAME . $sz); } } die ($yl); } function vy () { global$_config; if (!$_config['files_total_size_limit']) return false; $qz = 0; foreach(glob ($_config['path_media'].PICTURES_DIRNAME .'/*') as $m2){ $lz = stat ($m2); $qz += $lz['size']; } foreach(glob ($_config['path_media'].VIDEO_DIRNAME .'/*') as $m2){ $lz = stat ($m2); $qz += $lz['size']; } foreach(glob ($_config['path_media'].AUDIO_DIRNAME .'/*') as $m2){ $lz = stat ($m2); $qz += $lz['size']; } $zz = $_config['files_total_size_limit']; $kz = x1 ($qz,$zz); return [$qz,$zz,$kz]; } function by ($xz){ $ez = true; if (list ($qz,$zz,$kz)=$xz){ $ez = ($zz - $qz)>0; } return $ez; } function yy ($xz,$rz = false){ $tz = ''; if (list ($qz,$zz,$kz)=$xz){ $xz = [ 'used' => round ($qz / 1024 / 1024), 'total' => round ($zz / 1024 / 1024), 'percent' => $kz ]; if ($rz or ($zz - $qz)<1024 * 1024 * 10){ if ($qz < $zz){ $tz = e2l_get_string ('gs--used',$xz); } else { $tz = e2l_get_string ('gs--used-all',$xz); } } } return $tz; } function ny ($lq){ global$_strings; if ($lq == UPLOAD_ERR_INI_SIZE){ $sq = $_strings['er--cannot-upload-file-too-big']; } elseif ($lq == UPLOAD_ERR_FORM_SIZE){ $sq = $_strings['er--cannot-upload-file-too-big']; } else { $sq = e2l_get_string ('er--cannot-upload', ['error' => $lq]); } return $sq; } function dy ($l1){ include_once 'system/neasden/neasden.php'; $Nn = new Neasden; $Nn->profile_name = 'kavychki'; return$Nn->format ($l1); } function sy ($p7,$l1,$cx){ include_once 'system/neasden/neasden.php'; if ($l1 === '') return array (); if ($p7 == 'neasden'){ $Nn = new Neasden; $Nn->profile_name = $cx; $Nn->format ($l1); return$Nn->resources_detected; } else { return array (); } } function ay ($p7,$l1,$cx){ include_once 'system/neasden/neasden.php'; if(Log::$a)__log ('Format: format with formatter "'. $p7 .'" in context "'. $cx.'"'); $meta = []; if ($p7 == 'neasden'){ $Nn = new Neasden; $Nn->profile_name = $cx; $l1 = $Nn->format ($l1); $meta = [ 'links-required' => $Nn->links_required, 'resources-detected' => $Nn->resources_detected ]; } return array ( 'text-final' => $l1, 'meta' => $meta, ); } function qy ($l1,$cx){ return ay (DEFAULT_FORMATTER,$l1,$cx); } function e2m_frontpage ($parameters = []) { global$settings,$_strings,$_config; if(Log::$a)__log ('Frontpage {'); $tn = cs (); $frontpageView = new AePageableNotesView ('e2m_frontpage',$parameters); $frontpageView -> setPortionSize ($settings['appearance']['notes_per_page']); $frontpageView -> setNextPrevPageTitles ($_strings['gs--earlier'],$_strings['gs--later']); $frontpageView -> setWantPaging (true); $frontpageView -> setWantNewCommentsCount ($tn); $frontpageView -> setWantReadHrefs ($_config['count_reads']); $frontpageView -> setWantControls ($tn and !@$_config['read_only']); $frontpageView -> setWantHiddenTags ($tn); $frontpageView -> setWantRelatedNotes (true); if(CACHE_FRONTPAGE and $frontpageView -> isFirstPage ()) { if ($tn){ $frontpageView -> setCacheFilename (USER_DIR . CACHE_FILENAME_FRONTPAGE_AUTHOR); } else { $frontpageView -> setCacheFilename (USER_DIR . CACHE_FILENAME_FRONTPAGE); } } $frontpageView -> setLimitlessSQLRequest ( "SELECT * ". "FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished`=1 ". nf ($tn). "ORDER BY `Stamp` DESC" ); $ms = ev (); if($parameters['page']>1){ $ms .= ' ('. $_strings['gs--page'] .' '. $parameters['page'] .')'; } $cb = [ 'title' => $ms, 'heading' => '', 'notes' => $frontpageView -> getNotesCTree (), 'pages' => $frontpageView -> getPagesCTree (), 'frontpage?' => $frontpageView -> isFirstPage (), ]; if ( !$frontpageView -> isExistingPage () and !$frontpageView -> isFirstPageOfEmptyView () ) { return e2m_error404 (); } if(Log::$a)__log ('} // Frontpage'); return $cb; } abstract class E2GIP { protected $gip_cookie_name = 'gip'; protected $gip_token_cookie_name = 'gip_access_token'; protected $gip_token = null; abstract public function get_auth_url(); abstract public static function get_profile_url($zy,$vx); abstract public function callback(); const PHP_VERSION_VK_FEATURE = 70100; public static function set_session_data($cn,$cv){ if(session_status()==PHP_SESSION_NONE){ session_start(); } $_SESSION[$cn]=$cv; } public static function get_session_data($cn,$bx = false){ if(session_status()==PHP_SESSION_NONE){ session_start(); } if(!isset($_SESSION[$cn])) { return null; } $cv = $_SESSION[$cn]; if($bx){ unset($_SESSION[$cn]); } return $cv; } public static function get_gips_order(){ return [ 'twitter' => 0, 'facebook' => 1, 'vk' => 2, 'telegram' => 3 ]; } public function get_config($cn){ $yx = 'gips/'. $this->type .'.json'; $dl = false; foreach ([USER_DIR,INSTANCE_DIR,SYSTEM_DIR] as $nx){ if(is_file ($nx . $yx)) { $dl = @file_get_contents ($nx . $yx); break; } } if ($dl !== false){ $cb = json_decode ($dl,true,512,JSON_BIGINT_AS_STRING)[$cn]; if ($cb) return $cb; } return null; } public function get_callback_url(){ return qq('e2m_gip_sign_in_callback', array('provider' => $this->type)); } protected function get_proxy_param(){ global$settings; $mx = DEFAULT_LANGUAGE; if(array_key_exists ('language',$settings))$mx = $settings['language']; return '?language=' . $mx . '&type=' . $this->type . '&callback_url=' . urlencode($this->get_callback_url()); } public function get_gip_session_data(){ global$_config; $fx = $this->gip_token ? $this->gip_token : $_COOKIE[q1($this->gip_token_cookie_name)]; mm ( "SELECT * FROM `". $_config['db_table_prefix']."GIPsSessions` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `GIP` = '". $this->type ."' ". "AND `SessionToken` = '" . sm($fx)."' ". "ORDER BY `ID` DESC LIMIT 1", 'get GIP session data' ); $x3 = dm (); return $x3 ? $x3[0] : array(); } public function is_logged_in(){ if(empty($_COOKIE[q1($this->gip_cookie_name)]) || !in_array($_COOKIE[q1($this->gip_cookie_name)], e2_list_gips()) || $_COOKIE[q1($this->gip_cookie_name)] != $this->type || empty($_COOKIE[q1($this->gip_token_cookie_name)])) { return false; } $lb = $this->get_gip_session_data(); return (bool)$lb; } protected function save_session($zy,$name,$accessToken,$dx = '',$userEmail = '',$userLink = ''){ $bf = time(); bm ( iq (), 'GIPsSessions', [ 'GIP' => $this->type, 'GIPAuthorID' => $zy, 'AuthorName' => $name, 'AuthorEmail' => $userEmail, 'AuthorProfileLink' => $userLink, 'SessionToken' => $accessToken, 'Stamp' => $bf, ], 'INSERT', 'ON DUPLICATE KEY UPDATE '. '`SessionToken` = "' . sm($accessToken).'", '. '`AuthorName` = "' . sm($name).'", '. '`Stamp` = "' . $bf . '"' ); l1($this->gip_cookie_name,$this->type); l1($this->gip_token_cookie_name,$accessToken); if(isset($userEmail) && !empty($userEmail))l1('commenter_email',$userEmail); $this->gip_token = $accessToken; } public static function get_logout_key(){ if ($sx = self::get_session_data('logout_key')) { return $sx; } $sx = md5(microtime()); self::set_session_data('logout_key',$sx); return $sx; } public static function is_valid_logout_key($cn){ $ax = self::get_session_data('logout_key',true); if (empty($ax) || empty($cn) || $ax != $cn){ return false; } return true; } public function logout(){ global$_config; l1($this->gip_cookie_name); l1($this->gip_token_cookie_name); mm ( "DELETE FROM `". $_config['db_table_prefix']."GIPsSessions` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `GIP` = '" . $this->type . "' ". "AND `SessionToken` = '" . sm($_COOKIE[q1($this->gip_token_cookie_name)]) . "'", 'logout' ); } public function get_avatar_width(){ return USERPIC_WIDTH; } public function get_avatar_height(){ return USERPIC_HEIGHT; } public function save_avatar($zy,$qx){ global$_config; if (!preg_match ('/^https?\:\/\//i',$qx)) return; $qx = str_replace ("\0",'',$qx); $zy = preg_replace ('/[^a-zA-Z0-9._-]/','',$zy); $zy = substr ($zy,0,64); @cq ($_config['path_media'].AVATARS_DIRNAME); @chmod ($_config['path_media'].AVATARS_DIRNAME,$_config['uploaded_files_mode']); $wd = $_config['path_media'].AVATARS_DIRNAME . $this->type .'-'. $zy .'.jpg'; if ($lx = file_get_contents ($qx)) { file_put_contents ($wd,$lx); } return $wd; } } function e2m_gip_sign_in($lb){ global$_config,$settings; $type = $lb['provider']; $zx = e2_get_gip_instance($type); if (!$zx)a1 (); header('Location: ' . $zx->get_auth_url()); die; } function e2m_gip_sign_in_callback($lb){ global$_config; $type = $lb['provider']; $zx = e2_get_gip_instance($type); if (!$zx){ die ('Unknown provider'); } $kx = $zx->callback(); echo '<script>'; if ($kx === true){ $pa = $zx->get_gip_session_data(); $xx = [ 'name' => $pa['AuthorName'], 'gipIcon' => _SVG($type), 'logoutUrl' => qq('e2m_gip_sign_out', array('provider' => E2GIP::get_logout_key())), ]; echo 'window.opener.oauthAuthorized(' . json_encode($xx).');'; } else { echo 'alert (\''. $kx. '\');'; } echo 'window.close();</script>'; die; } function e2m_gip_sign_out($lb){ global$_config; $sx = $lb['provider']; if (!E2GIP::is_valid_logout_key($sx)) { die('invalid logout key'); } $zx = e2_get_logged_gip(); if($zx){ $zx->logout(); } a1(); } function e2_list_gips(){ static $ex = null; if(!is_null($ex)) { return $ex; } $rx = SYSTEM_DIR. 'gips/'; if (!is_dir ($rx)) return []; $tx = opendir($rx); $ex = []; $jx = E2GIP::get_gips_order(); $hx = count($jx); while (($m2 = readdir($tx)) !== false){ if(pathinfo($m2,PATHINFO_EXTENSION)!='php') continue; $gx = pathinfo($m2,PATHINFO_FILENAME); if ($gx == 'vk'){ if(PHP_VERSION_ID < E2GIP::PHP_VERSION_VK_FEATURE) continue; } $cn = isset($jx[$gx]) ? $jx[$gx] : ++$hx; $ex[$cn]=$gx; } closedir($tx); ksort($ex); return $ex; } function e2_get_gip_class_name($type){ return "E2GIP" . ucfirst($type); } function e2_get_gip_instance($type){ if (!in_array($type,e2_list_gips())) { return false; } $wx = e2_get_gip_class_name($type); $zx = new $wx; return $zx; } function e2_get_gip_auth_url($type){ return qq('e2m_gip_sign_in', array('provider' => $type)); } function e2_is_logged_in($type = ''){ $ux = !$type ? e2_list_gips() : array($type); foreach($ux as$type){ $zx = e2_get_gip_instance($type); if ($zx && $zx->is_logged_in()) { return true; } } return false; } function e2_get_logged_gip(){ foreach(e2_list_gips() as$type){ $zx = e2_get_gip_instance($type); if ($zx && $zx->is_logged_in()) { return $zx; } } return false; } function e2_get_logged_gip_name(){ foreach(e2_list_gips() as$type){ $zx = e2_get_gip_instance($type); if ($zx && $zx->is_logged_in()) { return$type; } } return false; } function e2_get_user_profile_url($type,$zy,$vx){ $wx = e2_get_gip_class_name($type); return $wx::get_profile_url($zy,$vx); } function e2_get_gip_session($type){ $zx = e2_get_gip_instance($type); if (!$zx || !$zx->is_logged_in()) { return false; } return $zx->get_gip_session_data(); } foreach(e2_list_gips() as $ia){ require_once 'system/gips/' . $ia . '.php'; } function e2s_notify () { global$_config; if($_config['holborn']) { $ix = @$_GET['src']; if ($ix == ''){ if(Log::$a)__log ('Holborn: No src URL'); die; } $dl = file_get_contents ($ix); $dl = iy ($dl); $ox = json_decode ($dl,true); if (!$ox){ if(Log::$a)__log ('Holborn: No meaningful info from '. $ix .' ('. json_last_error () .')'); if ($px = wy ($ix)) { if(Log::$a)__log ('Holborn: Delete note with ID '. $px['ID']); tm ($px['ID']); } die; } gy ($ox,$ix); } die; } function e2m_sources ($parameters){ global$_config; $ce = $_GET['ord']; if (!$ce)$ce = 'ID'; $ce = "`". sm ($ce) ."`"; mm ( "SELECT *, REPLACE(REPLACE(REPLACE(`URL`, 'http://', ''), 'https://', ''), 'www.', '') AS _URLX ". "FROM `". $_config['db_table_prefix']."Sources` " . "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "ORDER BY ". $ce ); $x3 = dm (); foreach ($x3 as $iq){ $ve = $iq['ID']; if ($iq['ID']!=$iq['TrueID'])$ve .= '<br />'. $iq['TrueID']; $source = array ( 'id' => $ve, 'userpic-href' => $iq['PictureURL'], 'href' => $iq['URL'], 'href-display' => str_replace ('/','/<wbr>',$iq['URL']), 'href-filtered' => str_replace ('/','/<wbr>',$iq['_URLX']), 'title' => $iq['Title'], 'author' => $iq['AuthorName'], 'true?' => $iq['ID']==$iq['TrueID'], 'whitelisted?' => (bool)$iq['IsWhiteListed'], 'trusted?' => (bool)$iq['IsTrusted'], ); if (!$iq['IsTrusted']) { $source['trust-url']=qq ( 'e2m_source_trust', array ('source' => $iq['ID']) ); } if ($iq['IsTrusted']) { $source['premoderate-url']=qq ( 'e2m_source_premoderate', array ('source' => $iq['ID']) ); } $source['ban-url']=qq ( 'e2m_source_ban', array ('source' => $iq['ID']) ); $source['forget-url']=qq ( 'e2m_source_forget', array ('source' => $iq['ID']) ); $be[] = $source; } $cb = array ( 'title' => 'Sources', 'heading' => 'Sources', ); if(count ($be)) { $cb['sources']=$be; } else { $cb['nothing']='No sources'; } return $cb; } function e2m_source_trust ($parameters){ global$_config; $ye = $parameters['source']; mm ( "UPDATE  ". $_config['db_table_prefix']."Sources ". "SET `IsWhitelisted`=1, `IsTrusted`=1 ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID`=". $ye, 'trust source' ); mm ( "UPDATE  ". $_config['db_table_prefix']."Notes ". "SET `IsPublished`=1 ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `SourceID`=". $ye, 'publish all notes from the just trusted source' ); cb (); @unlink (USER_DIR . CACHE_FILENAME_DRAFTS); @unlink (USER_DIR . CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); @unlink (USER_DIR . CACHE_FILENAME_INDEXED_FLAG); s1 (); } function e2m_source_premoderate ($parameters){ global$_config; $ye = $parameters['source']; mm ( "UPDATE  ". $_config['db_table_prefix']."Sources ". "SET `IsTrusted`=0 ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID`=". $ye, 'distrust source, set to premoderation' ); cb (); s1 (); } function e2m_source_ban ($parameters){ global$_config; $ye = $parameters['source']; mm ( "UPDATE  ". $_config['db_table_prefix']."Sources ". "SET `IsWhiteListed`=0, `IsTrusted`=0 ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID`=". $ye, 'ban source' ); mm ( "DELETE FROM  ". $_config['db_table_prefix']."Notes ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `SourceID`=". $ye, 'delete all notes from the just banned source' ); cb (); @unlink (USER_DIR . CACHE_FILENAME_DRAFTS); @unlink (USER_DIR . CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); s1 (); } function e2m_source_forget ($parameters){ global$_config; $ye = $parameters['source']; mm ( "DELETE FROM  ". $_config['db_table_prefix']."Sources ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID`=". $ye, 'forget source' ); mm ( "DELETE FROM  ". $_config['db_table_prefix']."Notes ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `SourceID`=". $ye, 'delete all notes from the just forgotten source' ); cb (); @unlink (USER_DIR . CACHE_FILENAME_DRAFTS); @unlink (USER_DIR . CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); s1 (); } function gy ($ne,$ix){ global$_config; $me = oy (array ( 'author' => $ne['author']['name'], 'title' => $ne['title'], 'href' => $ne['author']['url'], 'userpic-href' => $ne['author']['avatar'], )); if (!$me['IsWhiteListed']) return; if(preg_match ('/\+(\d\d)\:(\d\d)/',$ne['items'][0]['date_published'],$fe)) { $z3 = $fe[1]*SECONDS_IN_AN_HOUR + $fe[2]*SECONDS_IN_A_MINUTE; } $de = @$ne['items'][0]['_e2_data'] or $de = array (); $de = json_encode ($de); $se = $me['IsTrusted']; $ay = array ( 'Title' => $ne['items'][0]['title'], 'Text' => $ne['items'][0]['content_html'], 'FormatterID' => 'raw', 'OriginalAlias' => '', 'Uploads' => '', 'Stamp' => strtotime ($ne['items'][0]['date_published']), 'Offset' => (int)$z3, 'IsDST' => 0, 'LastModified' => strtotime ($ne['items'][0]['date_modified']), 'IsCommentable' => 0, 'IsPublished' => $se, 'IsExternal' => 1, 'SourceID' => $me['ID'], 'SourceNoteID' => $ne['items'][0]['id'], 'SourceNoteURL' => $ne['items'][0]['url'], 'SourceNoteJSONURL' => $ix, 'SourceNoteData' => $de, ); $note_id = $ne['items'][0]['id']; if ( $px = uy ($me['ID'],$note_id) ) { $ay['ID']=$px['ID']; ym (iq (), 'Notes',$ay); } else { $ay = bm (iq (), 'Notes',$ay); } if ($se){ if (ld ($ay)) { $ay['IsIndexed']='1'; ym (iq (), 'Notes',$ay); } } e2_drop_caches_for_note_($ay['ID'],$se); if($_config['backup_automatically']) { am (); } } function wy ($ix){ global$_config; mm ( "SELECT `ID` FROM ". $_config['db_table_prefix']."Notes ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `SourceNoteJSONURL`='". sm ($ix) ."' ". "LIMIT 1", 'get note ID by source JSON URL' ); $x3 = dm (); return $x3[0]; } function uy ($ye,$ae){ global$_config; mm ( "SELECT `ID` FROM ". $_config['db_table_prefix']."Notes ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `SourceID`= '". $ye ."' ". "AND `SourceNoteID`= '". $ae ."' ". "LIMIT 1", 'get note ID by source ID and source note ID' ); $x3 = dm (); return $x3[0]; } function iy ($dl){ for ($rb = 0; $rb <= 31; ++$rb){ $dl = str_replace (chr ($rb),'',$dl); } $dl = str_replace (chr (127),'',$dl); if(0 === strpos (bin2hex ($dl),'efbbbf')) { $dl = substr ($dl,3); } return $dl; } function oy ($qe){ global$_config; $le = false; mm ( "SELECT * FROM ". $_config['db_table_prefix']."Sources ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `URL`= '". $qe['href'] ."' ". "LIMIT 1", 'get source record by the URL from blog info' ); $x3 = dm (); if(count ($x3)) { $le = $x3[0]; if ($le['ID']!=$le['TrueID']) { mm ( "SELECT * FROM ". $_config['db_table_prefix']."Sources ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID`= '". $le['TrueID'] ."' ". "LIMIT 1", 'get true source record by using the TrueID of just found record' ); $x3 = dm (); if(count ($x3)) { $le = $x3[0]; } } } $me = array ( 'Title' => $qe['title'], 'AuthorName' => $qe['author'], 'PictureURL' => $qe['userpic-href'], ); if ($le !== false){ if ( $le['Title']!==$qe['title'] or $le['AuthorName']!==$qe['author'] or $le['PictureURL']!==$qe['userpic-href'] ) { $me['ID']=$le['ID']; ym (iq (), 'Sources',$me); } return $le; } else { $me['URL']=$qe['href']; $me['IsWhiteListed']=1; $me['IsTrusted']=0; $me = bm (iq (), 'Sources',$me); $me['TrueID']=$me['ID']; ym (iq (), 'Sources',$me); return $me; } } function py ($ay){ global$_config; $ba = array (); if (@$ay['IsExternal']) { if(array_key_exists ('SourceID',$ay)) { mm ( "SELECT * FROM `". $_config['db_table_prefix']."Sources` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID` = '". $ay['SourceID'] ."'", 'get source by id' ); $zb = dm (); $ba['source']=$zb[0]['Title']; $ba['source-id'] = (int)$ay['SourceID']; $ba['source-true-id'] = (int)$zb[0]['TrueID']; $ba['source-whitelisted?'] = (bool)$zb[0]['IsWhiteListed']; $ba['source-trusted?'] = (bool)$zb[0]['IsTrusted']; if (!$zb[0]['IsTrusted']) { $ba['source-trust-url']=qq ( 'e2m_source_trust', array ('source' => $ay['SourceID']) ); } if ($zb[0]['IsTrusted']) { $ba['source-premoderate-url']=qq ( 'e2m_source_premoderate', array ('source' => $ay['SourceID']) ); } $ba['source-ban-url']=qq ( 'e2m_source_ban', array ('source' => $ay['SourceID']) ); $ba['source-forget-url']=qq ( 'e2m_source_forget', array ('source' => $ay['SourceID']) ); $ba['author']=$zb[0]['AuthorName']; $ba['author-href']=$zb[0]['URL']; $ba['userpic-href']=$zb[0]['PictureURL']; } if(array_key_exists ('SourceNoteURL',$ay) and @$ay['SourceNoteURL']!=''){ $ba['href-external']=$ay['SourceNoteURL']; } } return $ba; } function e2img_filename_by_processing ( $ze,$ke, $xe,$ee,$re ) { global$_config; if(Log::$a)__log ('Process image: "'. $ze .'" -> "'. $ke .'"'); if (!is_file ($ze)) return false; $te = stat ($ze)['size']; if (!o2 ($ze)) { if(Log::$a)__log ('Process image: SVG, no processing'); return $ze; } if(is_file ($ke) and !md ($ze,$ke)) { if(Log::$a)__log ('Process image: Already exists'); return $ke; } if (!extension_loaded ('gd')) return false; $je = pathinfo ($ke); if (!@cq ($je['dirname'])) { if(Log::$a)__log ( 'Process image: Can’t create directory <'. $je['dirname'] .'>' ); return false; } if(Log::$a)__log ('Process image: Detecting image type'); $type = e2img__type_of_file ($ze); if (!$type) return false; $he = 'imagecreatefrom'. $type; if (!function_exists ($he)) { if(Log::$a)__log ('Process image: Function does not exist ('. $he .')'); return false; } if(Log::$a)__log ('Process image: Opening original image ('. $he .')'); $ge = call_user_func ($he,$ze); if (!$ge) return false; if ($we = e2img__orientation_of_file ($ze)) { if(Log::$a)__log ('Process image: Needs orientation fix'); $ge = e2img__res_rotate ($ge, -$we); } $ue = [imagesx ($ge),imagesy ($ge)]; $ie = $ue; $oe = [0,0,0,0]; if ($ee == CROP_SQUARE){ if(Log::$a)__log ('Process image: Needs crop'); list ($ie,$oe) = ( e2img__crop_metrics_to_square ($ie) ); } $ie = e2_fit_metrics_to_constraints ( $ie,$xe ); if ( $we === 0 and $ie === $ue ) { if(Log::$a)__log ('Process image: No changes necessary, leaving original'); return $ze; } if(Log::$a)__log (var_export ($ie,true)); if(Log::$a)__log (var_export ($oe,true)); $pe = e2img__create_copy_resampled ( $ge, $ie, $oe, $type ); imagejpeg ($pe,$ke,$re); if (!is_file ($ke)) { if(Log::$a)__log ('Process image: File not created by imagejpeg'); return false; } if ($ke !== $ze){ if ($we === 0){ $c6 = stat ($ke)['size']; if ($c6 >= $te){ if(Log::$a)__log ('Process image: Conversion to JPEG made file bigger, back up'); @unlink ($ke); $ke = $ze; } } } @chmod ($ke,$_config['uploaded_files_mode']); if(Log::$a)__log ('Process image: Done'); return $ke; } function e2img__create_copy_resampled ( $ge,$ie,$oe,$type ) { list ($v6,$b6)=$ie; list ($y6,$n6,$m6,$f6)=$oe; $pe = imagecreatetruecolor ($v6,$b6); if($type === 'png'){ imagefill ($pe,0,0,imagecolorallocate ($pe,255,255,255)); imagealphablending ($pe,true); } $d6 = imagesx ($ge); $s6 = imagesy ($ge); imagecopyresampled ( $pe, $ge, 0,0, 0 + $y6,0 + $n6, $v6,$b6, $d6 - $m6,$s6 - $f6 ); imageinterlace ($pe,1); return $pe; } function e2img__type_of_file ($wd){ $a6 = @getimagesize ($wd); if (!$a6) return false; if ($a6[2]==IMAGETYPE_GIF) return 'gif'; if ($a6[2]==IMAGETYPE_JPEG) return 'jpeg'; if ($a6[2]==IMAGETYPE_PNG) return 'png'; if ($a6[2]==IMAGETYPE_WEBP) return 'webp'; return false; } function e2img__orientation_of_file ($wd){ if (!function_exists ('exif_read_data')) return 0; if (($q6 = @exif_read_data ($wd)) === false) return 0; if (@$q6['Orientation']==3) return -180; if (@$q6['Orientation']==6) return -270; if (@$q6['Orientation']==8) return -90; return 0; } function e2img__res_rotate ($l6,$we){ $z6 = imagerotate ($l6,$we,0); if ($z6 !== false){ imagedestroy ($l6); $l6 = $z6; } return $l6; } function e2_fit_metrics_to_constraints ( $k6,$xe ) { if ($xe === false)$xe = [0,0]; list ($vz,$bz)=$k6; list ($x6,$e6)=$xe; $r6 = [1]; if ($x6)$r6[] = $x6 / $vz; if ($e6)$r6[] = $e6 / $bz; $t6 = min ($r6); if ($t6 < 1){ $vz = (int)round ($vz * $t6); $bz = (int)round ($bz * $t6); } return [$vz,$bz]; } function e2_getimagesize_jpeg ($wd){ $j6 = @fopen ($wd,'r'); if ($j6 === false){ throw new \RuntimeException (error_get_last ()['message']); } try { if (!flock ($j6,LOCK_SH)) { throw new \RuntimeException ('Cannot lock the file: '. $wd); } $b2 = fread ($j6,2); if ($b2 !== "\xFF\xD8"){ throw new \RuntimeException ('Unknown format: '. $wd); } for (;;) { $h6 = @unpack ('H4segment/nlen',fread ($j6,4)); if ($h6 === false){ throw new \RuntimeException ('Unknown format: '. $wd); } $nz = $h6['len']; $g6 = $h6['segment']; if(strpos ($g6,'ffc')===0){ $w6 = @unpack ('Cbits/nheight/nwidth',fread ($j6,$nz - 2)); if ($w6 === false){ throw new \RuntimeException ('Unknown format: '. $wd); } return [$w6['width'],$w6['height']]; } if(fseek($j6,$nz - 2,SEEK_CUR)!==0){ throw new \RuntimeException ('Cannot find start of frame: '. $wd); } } } finally { fclose ($j6); } } function e2_getimagesize ($wd){ $vz = $bz = 0; if (u2 ($wd)) { try { list ($vz,$bz)=e2_getimagesize_jpeg ($wd); } catch (\Exception $e){ list ($vz,$bz)=getimagesize ($wd); } } elseif (o2 ($wd)) { list ($vz,$bz)=getimagesize ($wd); } elseif (cd ($wd)) { try { require_once SYSTEM_DIR . LIBRARY_DIRNAME .'getid3/getid3.php'; $a6 = new getid3 (); $a6 = $a6->analyze ($wd); $vz = $a6['video']['resolution_x']; $bz = $a6['video']['resolution_y']; } catch (\Exception $e){} } elseif (p2 ($wd)) { if(function_exists ('simplexml_load_string')) { $u6 = simplexml_load_string (file_get_contents ($wd)); if ($u6){ $i6 = $u6->attributes (); list ($vz,$bz) = [(string)$i6 -> width, (string)$i6 -> height]; } } } if(substr ($wd,strrpos ($wd,'.')-3,3)=='@2x'){ $vz = (int)floor ($vz / 2); $bz = (int)floor ($bz / 2); } $o6 = round (($bz > 0) ? ($vz / $bz):1,2); $p6 = round (($vz > 0) ? ($bz / $vz):1,2); return [$vz,$bz,$o6,$p6]; } function e2img__crop_metrics_to_square ($k6){ $cr = $vr = $br = $yr = 0; list ($vz,$bz)=$k6; if ($vz > $bz){ $br = $vz - $bz; $cr = floor ($br / 2); $bz = $vz; } elseif ($vz < $bz){ $yr = $bz - $vz; $vr = floor ($br / 2); $vz = $bz; } $oe = [$cr,$vr,$br,$yr]; $nr = [$vz,$bz]; return [$nr,$oe]; } function e2m_install () { global$_strings,$_config; qf (DEFAULT_TEMPLATE); $cb = []; if(Log::$a)__log ('Installer: not installed, present user with form'); $mr['server'] = @$_COOKIE[q1 ('install_db_server')]; $mr['user_name'] = @$_COOKIE[q1 ('install_db_user_name')]; $mr['passw']=qs (@$_COOKIE[q1 ('install_db_passw')]); $mr['name'] = @$_COOKIE[q1 ('install_db_name')]; $cb = [ 'title' => $_strings['pt--install'], 'heading' => $_strings['pt--install'], 'form-install' => [ 'form-action' => qq ('e2s_install'), 'form-check-db-config-action' => qq ('e2j_check_db_config'), 'form-list-databases-action' => qq ('e2j_list_databases'), 'submit-text' => $_strings['fb--begin'], 'db-server' => htmlspecialchars (@$mr['server']? $mr['server']:'localhost'), 'db-user' => htmlspecialchars (@$mr['user_name']? $mr['user_name']:'root'), 'db-password' => '', 'db-database' => htmlspecialchars (@$mr['name']), ] ]; return $cb; } function cn () { static $zx = null; if ($zx === null){ $zx = @unserialize ( @file_get_contents (INSTANCE_DIR . 'instance.psa') ) or $zx = null; } return $zx; } function vn ($fr){ static $zx = null; $zx = cn (); $zx['version']=$fr; if (e3 (INSTANCE_DIR . 'instance.psa',serialize ($zx))) { return $zx; } else { die ('Cannot instantiate v'. $fr .': probably permission denied'); } } function e2s_instantiate ($parameters){ global$_strings; if (cn () !== null){ die ('Remove the file "'. INSTANCE_DIR . 'instance.psa" first'); } else { if(is_numeric ($parameters['version'])) { if (vn ($parameters['version'])) { hb ($_strings['gs--instantiated-version'] .' v'. $parameters['version'],E2E_MESSAGE); s1 (qq ('e2m_frontpage', array ('page' => 1))); } } } die ('Could not create instance of engine'); } function e2_install ($databaseConfiguration,$lb){ global$_strings,$_config,$settings; if ( cn () !== null and iq () !== null and od () ) { throw new AeInstallAlreadyInstalledException ('Instance already created and db params set'); } $databaseConfiguration -> setPrefix ($_config['db_table_prefix']); $databaseConfiguration -> setSubset ($_config['db_table_subset']); if(array_key_exists ('db_plain_password',$lb)) { $databaseConfiguration->password = as_ ($lb['db_plain_password']); } if($_config['log_installs']) { Log::$a = true; if(Log::$a)dn ('install-$'); } if(Log::$a)__log ('Installer: force directories'); AeFileManager::forceAllDirectories (); if(Log::$a)__log ('Installer: write password hash'); if (!@e3 (USER_DIR . 'password-hash.psa',serialize (sha1 ($lb['password'])))) { throw new AeNotSavedException; } $settings['db']=$databaseConfiguration -> getDatabaseParamsArray (); $settings['template']=DEFAULT_TEMPLATE; $settings['language']=DEFAULT_LANGUAGE; nm ($databaseConfiguration,'check database during installation'); $dr = un ($databaseConfiguration); $sr = false; if ($dr['occupied']) { if ($dr['migrateable'] and $lb['allow_migration']) { $sr = true; if(Log::$a)__log ('Installer: data exists and migrateable'); } else { if(Log::$a)__log ('Installer: incomplete data in the database'); throw new AeInstallDatabaseOccupiedException ('Database already has some data'); } } if ($sr){ if(Log::$a)__log ('Installer: no need to create tables, will migrate'); try { jn ($databaseConfiguration); } catch (AeMySQLException $e){ v3 ($e,'Could not migrate'); hb ($_strings['er--double-check-db-params']); } jd ($databaseConfiguration); } else { if(Log::$a)__log ('Installer: create tables'); foreach(AeModel::unprefixedCoreTablesNames () as $pv){ vm ($databaseConfiguration,$pv); } } if(Log::$a)__log ('Installer: write settings'); if (!@e3 (USER_DIR . 'settings.json',json_encode ($settings,E2_JSON_STYLE))) { throw new AeNotSavedException; } if(Log::$a)__log ('Installer: search index'); $ar = ed (iq ()); try { $ar -> erase (); } catch (\S2\Rose\Exception\RuntimeException $e){ if(Log::$a)__log ('Installer: Rose not available'); } e2_drop_all_kinds_of_cache (); sd (USER_DIR); km ($databaseConfiguration); if(Log::$a)__log ('Installer: instantiate'); vn (E2_VERSION); if(Log::$a)__log ('Installer: complete'); } function e2s_install () { global$_strings,$_db,$_config; if ( cn () !== null and iq () !== null and od () ) { s1 (); } $databaseConfiguration = js ( USER_DIR . BACKUP_DIRNAME, $_POST, $_config['db_table_prefix'], $_config['db_table_subset'] ); foreach($databaseConfiguration -> getDatabaseParamsArray () as $s3 => $a3){ l1 ('install_db_'. $s3,$a3); } if (!array_key_exists ('password',$_POST) or trim ($_POST['password']) == ''){ hb ($_strings['er--no-password-entered'],E2E_USER_ERROR); s1 (qq ('e2m_frontpage')); } $qr = trim ($_POST['password']); @session_start (); $lr = false; try { e2_install ($databaseConfiguration, [ 'allow_migration' => true, 'password' => $qr, ]); $lr = true; } catch (AeMySQLCannotConnectException $e){ hb ( $_strings['er--cannot-connect-to-db']. ':<br />'. mysqli_connect_error () .' ('. mysqli_connect_errno () .')' ); } catch (AeMySQLTooOldException $e){ hb (e2l_get_string ('er--dbs-version-too-old', [ 'dbs' => $_db['software'], 'v1' => $_db['version'], 'v2' => $_db['version-minimum'], ])); } catch (AeMySQLException $e){ hb ($_strings['er--cannot-find-db'] .' '. $databaseConfiguration->name); } catch (AeInstallDatabaseOccupiedException $e){ hb ($_strings['er--db-data-incomplete-install']); } catch (AeNotSavedException $e){ hb ($_strings['er--settings-not-saved'],E2E_PERMISSIONS_ERROR); } catch (AeInstallException $e){ } bn (); if (!$lr)s1 (qq ('e2m_frontpage', ['page' => 1])); $zr['sessions'] = [[ 'stamp' => time (), 'remote_ip' => ud (), 'key_hash' => pd (true), 'ua' => $_SERVER['HTTP_USER_AGENT'], ]]; if (!bs ($zr)) { hb ($_strings['er--cannot-write-auth-data'],E2E_PERMISSIONS_ERROR); } vv (qq ('e2s_bsi_step', array ())); s1 (); } function bn () { if ((strpos ($_SERVER['SERVER_SOFTWARE'],'Apache')!==0)) return; if(Log::$a)__log ('Running on Apache'); $kr = SYSTEM_DEFAULTS_DIR . 'default.htaccess'; $xr = false; if (!is_file ($kr)) { echo 'File not found: '.$kr. '. Please use the full Aegea installation package.'; die; } if(is_file ('.htaccess')) { if(Log::$a)__log ('There is an .htaccess file in the installation directory'); $er = file_get_contents ($kr); $rr = file_get_contents ('.htaccess'); if ($rr != $er){ $xr = true; $tr = $jr = '.htaccess.old'; $hr = 1; while (is_file ($jr)) { $jr = $tr .'.'. $hr ++; } if(Log::$a)__log ('Existing .htaccess wrong, backing up as <'. $jr .'>'); if (!@rename ('.htaccess',$jr)) { if(Log::$a)__log ('Installer: fuck'); echo 'Looks like you are using Apache and have put an incorrect ".htaccess" file in the installation directory. Additionally, the installer was not able to back up your existing ".htaccess" file in order to replace it with the correct one. Please use the full E2 installation package and grant write access on the installation target directory, all the files and subdirectories.'; die; } } } else { $xr = true; } if ($xr){ if(Log::$a)__log ('Writing a correct .htaccess file'); if (!@copy ($kr,'.htaccess')) { if(Log::$a)__log ('Fuck'); echo 'The installer was not able to create a correct ".htaccess" file. Please grant write access on the installation target directory.'; die; } @chmod ('.htaccess',E2_NEW_FILES_RIGHTS); } } function e2j_check_db_config () { global$_db,$_strings,$_config; $databaseConfiguration = js ( USER_DIR . BACKUP_DIRNAME, $_POST, $_config['db_table_prefix'], $_config['db_table_subset'] ); $yl = [ 'success' => true, 'data' => [ 'message' => '', 'db-responding' => false, 'db-connected' => false, 'db-found' => false, 'db-compatible' => false, 'db-occupied' => false, 'db-migrateable' => false, ] ]; try { nm ($databaseConfiguration,'connect to check DB config (try 1)'); } catch (AeMySQLAccessDeniedException $e){ $yl['data']['db-responding']=true; $yl = json_encode ($yl); die ($yl); } catch (AeMySQLCannotConnectException $e){ $yl = json_encode ($yl); die ($yl); } catch (AeMySQLTooOldException $e){ $yl['data']['db-responding']=true; $yl['data']['db-connected']=true; $yl['data']['message']=e2l_get_string ('er--dbs-version-too-old', [ 'dbs' => $_db['software'], 'v1' => $_db['version'], 'v2' => $_db['version-minimum'], ]); $yl = json_encode ($yl); die ($yl); } catch (AeMySQLNotFoundException $e){ $yl['data']['db-responding']=true; $yl['data']['db-connected']=true; if($databaseConfiguration->name){ $yl = json_encode ($yl); die ($yl); } else { $gr = on ($databaseConfiguration); if(count ($gr)>0){ $yl['data']['db-found']=true; $databaseConfiguration->name = $gr[0]; } else { $yl = json_encode ($yl); die ($yl); } } } $yl['data']['db-responding']=true; $yl['data']['db-connected']=true; $yl['data']['db-found']=true; $yl['data']['db-compatible']=true; try { nm ($databaseConfiguration,'connect to check DB config (try 2)'); } catch (AeMySQLException $e){ $yl = json_encode ($yl); die ($yl); } $yl['data']['db-good']=true; $dr = un ($databaseConfiguration); if ($dr['occupied']) { if ($dr['migrateable']) { $yl['data']['message']=$_strings['gs--data-exists']; } else { $yl['data']['db-good']=false; $yl['data']['message']=$_strings['er--db-data-incomplete-install']; } } $yl = json_encode ($yl); die ($yl); } function e2j_list_databases () { global$_config; $databaseConfiguration = js ( USER_DIR . BACKUP_DIRNAME, $_POST, $_config['db_table_prefix'], $_config['db_table_subset'] ); $yl = [ 'success' => true, 'data' => [ 'databases-list' => on ($databaseConfiguration), ] ]; $yl = json_encode ($yl); die ($yl); } if(substr (@$_SERVER['HTTP_ACCEPT_LANGUAGE'],0,2)=='ru'){ define ('DEFAULT_LANGUAGE','ru'); } else { define ('DEFAULT_LANGUAGE','en'); } function e2l_get_string ($wr,$lb){ global$_strings; $name = $_strings[$wr]; if(preg_match_all ('/\$\[(.+?)\]/u',$name,$fe,PREG_SET_ORDER)) { foreach ($fe as $ur){ $ir = $ur[1]; $p7 = ''; if(strstr ($ir,'.')) list ($ir,$p7)=explode ('.',$ir,2); if(array_key_exists ($ir,$lb)) { if ($p7){ $name = str_replace ($ur[0],e2l__format_value ($p7,$lb[$ir],$wr),$name); } else { $name = str_replace ($ur[0],$lb[$ir],$name); } } } } return$name; } function e2l__format_value ($p7,$cv,$wr){ @list ($p7,$or_)=explode ('.',$p7,2); $pr = 'e2lstr_'. $p7; if(function_exists ($pr)) { return call_user_func ($pr,$cv,$or_,$wr); } else { return $cv; } return $cv; } function yn () { global$_lang,$settings; if ( array_key_exists ('language',$settings) and is_file ($ct = SYSTEM_DIR . LANGUAGES_DIRNAME . $settings['language'] .'.php') ) { $_lang = $settings['language']; include $ct; } elseif(is_file ($ct = SYSTEM_DIR . LANGUAGES_DIRNAME . DEFAULT_LANGUAGE .'.php')) { $_lang = DEFAULT_LANGUAGE; include $ct; } else { die ('Language file missing: '. $ct); } return e2l_load_strings (); } class Log { public static $a = false; public static $ft = false; } function fn_ () { global$_config; $dt = INSTANCE_DIR . LOGS_DIRNAME . MAIN_LOG_FILENAME; if ( $_config['write_log'] and ($_config['write_log_create'] or is_file ($dt)) ) { Log::$a = true; Log::$ft = true; } else { Log::$a = false; Log::$ft = false; } if (!Log::$a) return; @cq (INSTANCE_DIR . LOGS_DIRNAME); if($_config['write_log_reset']) { @file_put_contents ($dt,''); @chmod ($dt,E2_NEW_FILES_RIGHTS); } if (@$_config['write_log_limit'] and is_file ($dt)) { $id = @stat ($dt); $id = $id['size']; if ($id > $_config['write_log_limit']) { @rename ($dt,$dt .'.bak'); @chmod ($dt .'.bak',E2_NEW_FILES_RIGHTS); @file_put_contents ($dt,''); } } __log ('────────────────────────────────────────────────────────────────────────────────'); } function dn ($st = false) { static $at = false; if ($st === false) return $at; if ($st === '') return $at = false; $wd = str_replace ( '$',gmdate ('Y-m-d-\a\t-H-i-s'),$st ); return $at = $wd; } function __log ($l1){ static $lt; global$_stopwatch; $zt = dn (); $dt = INSTANCE_DIR . LOGS_DIRNAME . MAIN_LOG_FILENAME; $kt = ''; $xt = str_pad (round (yq () - $_stopwatch,5),10,' ',STR_PAD_RIGHT); if ($l1[0]=='}'){ -- $lt; if ($lt < 0)$lt = 0; } $et = ( E2_RUN_ID .' '. $kt .''. $xt .' '. str_repeat (' ',$lt * 2). $l1 . "\n" ); if ($l1[strlen ($l1)-1]=='{'){ ++ $lt; } $gy = FILE_APPEND; if(Log::$ft){ @file_put_contents ($dt,$et,$gy); @chmod ($dt,E2_NEW_FILES_RIGHTS); } if ($zt !== false){ $wd = INSTANCE_DIR . LOGS_DIRNAME . $zt .'.log'; @cq (INSTANCE_DIR . LOGS_DIRNAME); @file_put_contents ($wd,$et,$gy); @chmod ($zt,E2_NEW_FILES_RIGHTS); } if ($l1[0]=='#'){ $rt = INSTANCE_DIR . LOGS_DIRNAME . 'debug.log'; @cq (dirname ($rt). '/'); @file_put_contents ($rt,$et,$gy); @chmod ($rt,E2_NEW_FILES_RIGHTS); } } function sn ($tt){ @e3 ( USER_DIR .'ctree.php', "<?php\r\n\r\n". var_export ($tt,true). "\r\n\r\n?>php" ); } function an () { $dt = INSTANCE_DIR . LOGS_DIRNAME . MAIN_LOG_FILENAME; @cq (INSTANCE_DIR . LOGS_DIRNAME); @file_put_contents ($dt,''); @chmod ($dt,E2_NEW_FILES_RIGHTS); } define ('MAIL_ENABLED', !in_array ('mail',explode (',',ini_get ('disable_functions')))); function qn ($jt,$content){ $ht = SYSTEM_DEFAULTS_DIR .'mail/'. $jt .'.mtmpl.php'; if(is_file ($ht)) { ob_start (); include $ht; $ya = ob_get_contents (); ob_end_clean (); return trim ($ya); } } function ln () { global$_config; $gt = $_config['mail_from']; if ($gt[strlen ($gt)-1]=='@'){ $gt .= $_SERVER['HTTP_HOST']; } return $gt; } function zn ($wt,$subject,$sq,$ut = ''){ global$_config; if($_config['dev_mail_debug']) { $w = 'mail-debug'; $tv = basename (tempnam ($w,'m-')); $l1 = ( 'To:       '.$wt ."\n". 'Subject:  '.$subject ."\n". $ut ."\n". "--------------------------------------------------\n". $sq ); e3 ($w .'/'. $tv,$l1); chmod ($w .'/'. $tv,E2_NEW_FILES_RIGHTS); rename ($w .'/'. $tv,$w .'/'. $tv.'.txt'); } $subject = '=?UTF-8?B?'. base64_encode ($subject) .'?='; $ut .= "\r\nContent-Type: text/plain; charset=utf-8"; if(MAIL_ENABLED){ mail ($wt,$subject,$sq,trim ($ut)); } } function kn ($parameters,$it){ global$settings; $ot['each'] = []; $ot['reorderable?']=false; $rd = vf (true,true); if ($rd === null or $rd === 0) return $ot; if (!@$settings['appearance']['show_main_menu']) return $ot; return $ot; } function xn ($r2){ foreach ($r2 as $iq) if ($iq['visible?']) return true; return false; } function en () { global$settings,$_strings,$_current_url; $n5 = mf (); return [ [ 'sort-id' => 'f', 'href' => qq ('e2m_favourites', ['page' => 1]), 'content-classes' => ['favourites'], 'svg-id' => 'favourite-on', 'title' => $_strings['nm--favourites'], 'current?' => AeMainMenuManager :: $isFavouritesCurrent, 'parent?' => AeMainMenuManager :: $isFavouritesParent, 'visible?' => (bool) @$settings['menu_items']['favourites_on'], 'available?' => true, ], [ 'sort-id' => 'h', 'href' => qq ('e2m_most_commented', ['page' => 1]), 'content-classes' => ['most-commented'], 'svg-id' => 'comments', 'title' => $_strings['nm--most-commented'], 'current?' => AeMainMenuManager :: $isMostCommentedCurrent, 'parent?' => AeMainMenuManager :: $isMostCommentedParent, 'visible?' => (bool) @$settings['menu_items']['most_commented_on'], 'available?' => true, ], [ 'sort-id' => 'p', 'href' => qq ('e2m_popular', ['page' => 1]), 'content-classes' => ['popular'], 'svg-id' => 'read', 'title' => $_strings['nm--most-read'], 'current?' => AeMainMenuManager :: $isPopularCurrent, 'parent?' => AeMainMenuManager :: $isPopularParent, 'visible?' => (bool) @$settings['menu_items']['popular_on'], 'available?' => true, ], [ 'sort-id' => 't', 'href' => qq ('e2m_tags'), 'svg-id' => 'tags', 'title' => $_strings['gs--tags'], 'current?' => AeMainMenuManager :: $isTagsCurrent, 'parent?' => AeMainMenuManager :: $isTagsParent, 'visible?' => (bool) @$settings['menu_items']['tags_on'], 'available?' => true, ], [ 'sort-id' => 'c', 'href' => p (), 'content-classes' => ['day','month','year'], 'svg-id' => 'calendar', 'title' => $_strings['gs--calendar'], 'current?' => AeMainMenuManager :: $isCalendarCurrent, 'parent?' => AeMainMenuManager :: $isCalendarParent, 'visible?' => (bool) @$settings['menu_items']['calendar_on'], 'available?' => true, ], [ 'sort-id' => 'r', 'href' => $n5? $n5 : qq ('e2m_frontpage', ['page' => 1]), 'svg-id' => 'dice', 'title' => $_strings['nm--random-note'], 'current?' => $_current_url === $n5, 'parent?' => false, 'visible?' => $n5 !== false and (bool) @$settings['menu_items']['random_on'], 'available?' => $n5 !== false, ], ]; } function rn ($candy,$m5,$f5,$d5,$s5){ global $_config, $_template, $_newsfeeds, $_current_url; $meta['base-href']=AeEnv::$base_url; $meta['current-href']=$_current_url; $meta['stylesheets']=c2 (); $meta['scripts']=v2 (); $meta['newsfeeds']=$_newsfeeds; $meta['favicon-type']='image/x-icon'; $meta['favicon-href']='favicon.ico'; if ($a5 = tv ()) { $meta['favicon-type']=nd ($a5); $meta['favicon-href']=$a5; $meta['apple-touch-icon-href']=tv ('square'); } $meta['navigation-links'] = [[ 'rel' => 'index', 'href' => qq ('e2m_frontpage', ['page' => 1]), 'id' => 'link-index', ]]; if (!empty ($s5)) { foreach (['prev','next','earlier','later'] as $q5){ if(array_key_exists ($q5 .'-href',$s5)) { $l5 = $q5; if ($q5 == 'earlier')$l5 = 'prev'; if ($q5 == 'later')$l5 = 'next'; $n1 = $s5[$q5 .'-href']; if ($n1 === 'javascript:;') continue; $meta['navigation-links'][] = [ 'rel' => $l5, 'href' => $n1, 'id' => 'link-'. $q5, ]; } } } $meta['robots']='noindex, follow'; if($candy === 'e2m_note' and @$m5['only']['public?']) { $meta['robots']='index, follow'; } if ( @$_config['index_follow_everything'] and in_array ($candy, [ 'e2m_frontpage', 'e2m_tag', 'e2m_favourites', 'e2m_most_commented', 'e2m_found', 'e2m_tags', 'e2m_everything', ]) ) { $meta['robots']='index, follow'; } if (!isset ($_template))qf (); $meta['viewport']=$_template['meta_viewport']; if(is_file ($_config['path_media'].'manifest.json')) { $meta['manifest-href']=AeEnv::$base_url .'manifest.json'; } $meta['og-images'] = []; if(is_array ($m5['only']['og-images'])) { $meta['og-images']=$m5['only']['og-images']; $meta['twitter-card']='summary_large_image'; } if(is_array (@$f5['og-images'])) { $meta['og-images']=$f5['og-images']; $meta['twitter-card']='summary_large_image'; } if (!count ($meta['og-images'])) { $meta['og-images'] = array ($d5['userpic-large-href']); $meta['twitter-card']='summary'; } return$meta; } function tn (AeDatabaseConfiguration $databaseConfiguration){ $z5 = $databaseConfiguration -> getSubset (); if ($z5 < 1){ throw new LogicException ('Subset to set in place of zero must be greater than 0'); } nm ($databaseConfiguration,'prepare migrate db'); fm ($databaseConfiguration,'SET sql_quote_show_create=1'); } function jn (AeDatabaseConfiguration $databaseConfiguration){ $prefix = $databaseConfiguration -> getPrefix (); $z5 = $databaseConfiguration -> getSubset (); if ($z5 < 1){ throw new LogicException ('Subset to set in place of zero must be greater than 0'); } nm ($databaseConfiguration,'migrate db'); fm ($databaseConfiguration,'SET sql_quote_show_create=1'); hn ($databaseConfiguration); wn ($databaseConfiguration); if(Log::$a)__log ('Get existing table information {'); $k5 = false; foreach(AeModel::unprefixedCoreTablesNames () as $s2){ vm ($databaseConfiguration,$s2); fm ($databaseConfiguration,"SHOW CREATE TABLE `". $prefix . $s2 ."`"); $x5[$s2]=dm (); $x5[$s2]=$x5[$s2][0]['Create Table']; fm ($databaseConfiguration,"SHOW INDEX FROM `". $prefix . $s2 ."`"); $e5 = dm (); $r5 = []; $t5 = []; foreach ($e5 as $nb){ $nb = $nb['Key_name']; if ( preg_match ('/\_[0-9]+$/',$nb) or ($s2 === 'Actions' and $nb === 'EntityID') or ($s2 === 'GIPsSessions' and $nb === 'GIP') or ($s2 === 'GIPsSessions' and $nb === 'SubsetID') or ($s2 === 'Notes' and $nb === 'Title') ) { $r5[] = $nb; $t5[] = 'DROP INDEX `'. $nb. '`'; } if ($s2 === 'Actions' and $nb === 'EntityID'){ $k5 = true; } if ($s2 === 'Actions' and $nb === 'EntityIDStamp'){ $k5 = true; } } if(count ($t5)) { $t5 = implode (', ',array_unique ($t5)); $r5 = implode (', ',array_unique ($r5)); if(Log::$a)__log ( 'Drop erroneous index "'. $r5 .'" on "'. $prefix . $s2 .'"' ); fm ($databaseConfiguration, "ALTER TABLE `". $prefix . $s2 ."` ". $t5 ); } if (!strstr ($x5[$s2],'InnoDB')) { fm ($databaseConfiguration, "ALTER TABLE `". $prefix . $s2 ."` ". "ENGINE = InnoDB" ); } if (!strstr ($x5[$s2],'`SubsetID`')) { fm ($databaseConfiguration, "ALTER TABLE `". $prefix . $s2 . "` ". "ADD `SubsetID` INT UNSIGNED DEFAULT '0' NOT NULL AFTER `ID`" ); } if ( $s2 === 'Actions' and strstr ($x5['Actions'],'`ReadCount`') and !$k5 ) { gn ($databaseConfiguration); } fm ($databaseConfiguration, "UPDATE `". $prefix . $s2 ."` ". "SET `SubsetID` = ". $z5 ." ". "WHERE `SubsetID` = 0" ); } if(Log::$a)__log ('}'); if (!strstr ($x5['Actions'],'`ReadCount`')) { fm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Actions` ". "ADD `ReadCount` INT DEFAULT '0' NOT NULL" ); } if(strstr ($x5['Actions'],'`HitCount`')) { fm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Actions` ". "DROP `HitCount`" ); fm ($databaseConfiguration, "DELETE FROM `". $prefix . "Actions` ". "WHERE `ReadCount` = 0" ); } if (!strstr ($x5['Aliases'],'`EntityType`')) { fm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Aliases` ". "ADD `EntityType` VARCHAR( 1 ) DEFAULT '' NOT NULL AFTER `ID`" ); } fm ($databaseConfiguration, "UPDATE `". $prefix . "Aliases` ". "SET `EntityType` = 'n' ". "WHERE `EntityType` = ''" ); fm ($databaseConfiguration, "DELETE FROM `". $prefix . "Aliases` ". "WHERE `ID` IN (". "SELECT `ID` FROM (". "SELECT a.`ID` FROM `". $prefix . "Aliases` a ". "LEFT OUTER JOIN `". $prefix . "Keywords` e ". "ON a.`EntityID` = e.`ID` ". "WHERE a.`EntityType` = 't' ". "AND e.`ID` IS NULL". ") AS temp". ")", 'clean up “leaked” tag aliases' ); if (!stristr ($x5['Comments'],'`Text` MEDIUMTEXT')) { fm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Comments` ". "CHANGE `Text` `Text` MEDIUMTEXT" ); } if (!stristr ($x5['Comments'],'`Reply` MEDIUMTEXT')) { if(strstr ($x5['Comments'],'`Reply`')) { fm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Comments` ". "CHANGE `Reply` `Reply` MEDIUMTEXT" ); } else { if(Log::$a)__log ('No Reply column in comments; ignored assuming a 2.11 database'); } } if (!stristr ($x5['Comments'],'`IP` VARCHAR(39)')) { fm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Comments` ". "CHANGE `IP` `IP` VARCHAR(39)  DEFAULT '' NOT NULL" ); } if (!strstr ($x5['Comments'],'`IsGIPUsed`')) { fm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Comments` ". "ADD `IsGIPUsed` TINYINT(1) DEFAULT '0' NOT NULL AFTER `IP`" ); } if (!strstr ($x5['Comments'],'`GIP`')) { fm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Comments` ". "ADD `GIP` VARCHAR(15) DEFAULT '' NOT NULL AFTER `IsGIPUsed`" ); } if (!strstr ($x5['Comments'],'`GIPAuthorID`')) { fm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Comments` ". "ADD `GIPAuthorID` VARCHAR(64) DEFAULT '' NOT NULL AFTER `GIP`" ); } if(strstr ($x5['Comments'],'`SocialType`')) { fm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Comments` ". "DROP `SocialType`" ); } if(strstr ($x5['Comments'],'`SocialID`')) { fm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Comments` ". "DROP `SocialID`" ); } if (!strstr ($x5['GIPsSessions'],'`AuthorEmail`')) { fm ($databaseConfiguration, "ALTER TABLE `". $prefix . "GIPsSessions` ". "ADD `AuthorEmail` VARCHAR(255) DEFAULT '' NOT NULL AFTER `AuthorName`" ); } if (!strstr ($x5['GIPsSessions'],'`AuthorProfileLink`')) { fm ($databaseConfiguration, "ALTER TABLE `". $prefix . "GIPsSessions` ". "ADD `AuthorProfileLink` VARCHAR(255) DEFAULT '' NOT NULL AFTER `AuthorEmail`" ); } if(strstr ($x5['Keywords'],'`ParentKeywordID`')) { fm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Keywords` ". "DROP `ParentKeywordID`" ); } if (!strstr ($x5['Keywords'],'`OriginalAlias`')) { fm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Keywords` ". "CHANGE `URLName` `OriginalAlias` VARCHAR( 64 ) DEFAULT '' NOT NULL AFTER `Keyword`" ); } if (!strstr ($x5['Keywords'],'`PageTitle`')) { fm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Keywords` ". "ADD `PageTitle` VARCHAR(255) DEFAULT '' NOT NULL AFTER `OriginalAlias`" ); } if (!stristr ($x5['Keywords'],'`Description` MEDIUMTEXT')) { fm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Keywords` ". "CHANGE `Description` `Description` MEDIUMTEXT" ); } if (!strstr ($x5['Keywords'],'`Summary`')) { fm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Keywords` ". "ADD `Summary` MEDIUMTEXT AFTER `Description`" ); } if (!strstr ($x5['Keywords'],'`Uploads`')) { fm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Keywords` ". "ADD `Uploads` MEDIUMTEXT AFTER `Summary`" ); } if (!stristr ($x5['Keywords'],'`Uploads` MEDIUMTEXT')) { fm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Keywords` ". "CHANGE `Uploads` `Uploads` MEDIUMTEXT" ); } if (!strstr ($x5['Keywords'],'`IsVisible`')) { fm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Keywords` ". "ADD `IsVisible` TINYINT(1) DEFAULT '1' NOT NULL AFTER `Uploads`" ); } fm ($databaseConfiguration, "UPDATE `". $prefix . "Keywords` SET `Summary` = '' WHERE `Summary` IS NULL" ); fm ($databaseConfiguration, "UPDATE `". $prefix . "Keywords` SET `Uploads` = '' WHERE `Uploads` IS NULL" ); if (!strstr ($x5['Notes'],'`FormatterID`')) { fm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Notes` ". "ADD `FormatterID` VARCHAR( 32 ) DEFAULT '". DEFAULT_FORMATTER ."' NOT NULL AFTER `Text`" ); } if(1){ fm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Notes` ". "CHANGE `FormatterID` `FormatterID` VARCHAR( 32 ) DEFAULT '". DEFAULT_FORMATTER ."' NOT NULL" ); } if (!strstr ($x5['Notes'],'`OriginalAlias`')) { fm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Notes` ". "CHANGE `URLName` `OriginalAlias` VARCHAR( 64 ) DEFAULT '' NOT NULL AFTER `FormatterID`" ); } if(strstr ($x5['Notes'],'`IP`')) { fm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Notes` ". "DROP `IP`" ); } if (!stristr ($x5['Notes'],'`Text` MEDIUMTEXT')) { fm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Notes` ". "CHANGE `Text` `Text` MEDIUMTEXT" ); } if (!strstr ($x5['Notes'],'`Summary`')) { fm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Notes` ". "ADD `Summary` MEDIUMTEXT AFTER `Text`" ); } if (!strstr ($x5['Notes'],'`IsIndexed`')) { fm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Notes` ". "ADD `IsIndexed` TINYINT( 1 ) DEFAULT '0' NOT NULL AFTER `IsDST`" ); } if (!strstr ($x5['Notes'],'`Uploads`')) { fm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Notes` ". "ADD `Uploads` MEDIUMTEXT AFTER `OriginalAlias`" ); } if (!stristr ($x5['Notes'],'`Uploads` MEDIUMTEXT')) { fm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Notes` ". "CHANGE `Uploads` `Uploads` MEDIUMTEXT" ); } if (!strstr ($x5['Notes'],'`IsExternal`')) { fm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Notes` ". "ADD `IsExternal` TINYINT(1) DEFAULT '0' NOT NULL AFTER `IsIndexed`" ); } if (!strstr ($x5['Notes'],'`SourceID`')) { fm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Notes` ". "ADD `SourceID` INT UNSIGNED DEFAULT '0' NOT NULL AFTER `IsExternal`" ); } if (!strstr ($x5['Notes'],'`SourceNoteID`')) { fm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Notes` ". "ADD `SourceNoteID` INT UNSIGNED DEFAULT '0' NOT NULL AFTER `SourceID`" ); } if (!strstr ($x5['Notes'],'`SourceNoteURL`')) { fm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Notes` ". "ADD `SourceNoteURL` VARCHAR(255) DEFAULT '' NOT NULL AFTER `SourceNoteID`" ); } if (!strstr ($x5['Notes'],'`SourceNoteData`')) { fm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Notes` ". "ADD `SourceNoteData` MEDIUMTEXT AFTER `SourceNoteURL`" ); } if (!strstr ($x5['Notes'],'`SourceNoteJSONURL`')) { fm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Notes` ". "ADD `SourceNoteJSONURL` VARCHAR(255) DEFAULT '' NOT NULL AFTER `SourceNoteData`" ); } if(strstr ($x5['Notes'],'`SourceMainImageURL`')) { fm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Notes` ". "DROP `SourceMainImageURL`" ); } if(strstr ($x5['Notes'],'`IsIssue`')) { fm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Notes` ". "DROP `IsIssue`" ); } if (!strstr ($x5['Notes'],'`ReadCount`')) { fm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Notes` ". "ADD `ReadCount` INT UNSIGNED DEFAULT '0' NOT NULL AFTER `IsExternal`" ); fm ($databaseConfiguration, "UPDATE `". $prefix . "Notes` n JOIN (". "SELECT `EntityID`, SUM(`ReadCount`) `AggregateReadCount` ". "FROM  `". $prefix . "Actions` ". "GROUP BY `EntityID`". ") a ON n.`ID` = a.`EntityID` ". "SET `ReadCount` = `AggregateReadCount`" ); } fm ($databaseConfiguration, "UPDATE `". $prefix . "Notes` SET `Summary` = '' WHERE `Summary` IS NULL" ); fm ($databaseConfiguration, "UPDATE `". $prefix . "Notes` SET `Uploads` = '' WHERE `Uploads` IS NULL" ); fm ($databaseConfiguration, "UPDATE `". $prefix . "Notes` SET `SourceNoteData` = '' WHERE `SourceNoteData` IS NULL" ); if (!strstr ($x5['Sources'],'`TrueID`')) { fm ($databaseConfiguration, "ALTER TABLE `". $prefix . "Sources` ". "ADD `TrueID` INT UNSIGNED DEFAULT '0' NOT NULL AFTER `ID`" ); fm ($databaseConfiguration, "UPDATE `". $prefix . "Sources` ". "SET `TrueID` = `ID`" ); } if(Log::$a)__log ('Ensure indexes {'); if(strstr ($x5['Notes'],'`Title` (`Title`(191))')) { if(Log::$a)__log ('Drop erroneous index on "'. $prefix .'Notes.Title"'); fm ($databaseConfiguration, "ALTER TABLE `". $prefix ."Notes` ". "DROP INDEX `Title`" ); } foreach(AeModel::unprefixedCoreTablesNames () as $s2){ foreach(AeModel::indexesByUnprefixedTableName ($s2) as $nb){ list ($type,$mb)=$nb; $fb = implode ('',$mb); $j5 = AeModel::indexCheckSQLByIndexType ($type).' `'. $fb .'` (`'. implode ('`,`',$mb) .'`)'; $db = AeModel::indexCreateSQLByIndexType ($type).' `'. $fb .'` (`'. implode ('`, `',$mb) .'`)'; if (!strstr ($x5[$s2],$j5)) { if(Log::$a)__log ( 'Table "'. $prefix . $s2 .'" is missing "'. AeModel::indexCheckSQLByIndexType ($type) .'" on columns "'. implode ('", "',$mb) .'"' ); fm ($databaseConfiguration, "ALTER TABLE `". $prefix . $s2 ."` ". "ADD ". $db ); } } } if(Log::$a)__log ('}'); return true; } function hn (AeDatabaseConfiguration $databaseConfiguration){ if(Log::$a)__log ('Ensure encoding utf8mb4 on all native tables {'); foreach(AeModel::unprefixedCoreTablesNames () as $h5){ $g5 = $databaseConfiguration -> getPrefix () . $h5; if(Log::$a)__log ('Migrate: Check table '. $g5); $w5 = cm ($databaseConfiguration,$h5); if (!$w5) continue; if(stripos ($w5['Collation'],'utf8mb4')===0) continue; if(Log::$a)__log ('Migrate: Table '. $g5 .' has a wrong encoding'); if(Log::$a)__log ('Migrate: Drop indexes of table '. $g5); fm ($databaseConfiguration, "SHOW INDEX FROM `". $g5 ."` ". "WHERE `Key_name` <> 'PRIMARY' ". "AND `Seq_in_index` = 1", 'show indexes from table '. $g5 ); $e5 = dm (); foreach ($e5 as $nb){ fm ($databaseConfiguration, "ALTER TABLE `". $g5 ."` ". "DROP INDEX `". $nb['Key_name'] ."`", 'drop index '. $nb['Key_name'] ); } if(Log::$a)__log ('Migrate: Convert table '. $g5 .' to utf8mb4'); fm ($databaseConfiguration, "ALTER TABLE `". $g5 ."` ". "CONVERT TO CHARACTER SET utf8mb4", 'convert table to character set utf8mb4' ); } if(Log::$a)__log ('}'); if(Log::$a)__log ('Ensure encoding utf8mb4 on all Rose tables {'); foreach (xd () as $u5){ $g5 = ( $databaseConfiguration -> getPrefix () . SEARCH_EXTRA_PREFIX . $u5 ); if(Log::$a)__log ('Migrate: Check table '. $g5); $w5 = cm ($databaseConfiguration,SEARCH_EXTRA_PREFIX . $u5); if (!$w5) continue; if(stripos ($w5['Collation'],'utf8mb4')===0) continue; if(Log::$a)__log ('Some Rose tables have a wrong encoding, will need to erase and recreate them all'); jd ($databaseConfiguration); break; } if(Log::$a)__log ('}'); } function gn (AeDatabaseConfiguration $databaseConfiguration){ $prefix = $databaseConfiguration -> getPrefix (); if(Log::$a)__log ( 'Table "'. $prefix .'Actions" is missing necessary UNIQUE index, must rearrange {' ); fm ($databaseConfiguration, "DROP TABLE IF EXISTS `". $prefix ."Actions_Fixed`", 'remove temporary Actions_Fixed table if exists' ); fm ($databaseConfiguration, "CREATE TABLE `". $prefix ."Actions_Fixed` ". "LIKE `". $prefix ."Actions`", 'create new temporary Actions_Fixed table' ); fm ($databaseConfiguration, "ALTER TABLE `". $prefix ."Actions_Fixed` ". "ADD UNIQUE INDEX(`EntityID`, `Stamp`)", 'add UNIQUE index to the temporary Actions_Fixed table' ); fm ($databaseConfiguration, "INSERT INTO `". $prefix ."Actions_Fixed` (`SubsetID`, `EntityID`, `Stamp`, `ReadCount`) ". "SELECT `SubsetID`, `EntityID`, `Stamp`, `AggregateReadCount` FROM (". "SELECT `SubsetID`, `EntityID`, `Stamp`, SUM(`ReadCount`) `AggregateReadCount` ". "FROM `". $prefix ."Actions` ". "GROUP BY `EntityID`, `Stamp`". ") `". $prefix ."Actions_Fixed_AliasRequiredForNoReason`", 'rearrange Actions records from existing problematic Actions table to the new temporary Actions_Fixed table' ); fm ($databaseConfiguration, "RENAME TABLE `". $prefix ."Actions` TO `". $prefix ."Actions_Corrupt`", 'rename Actions to Actions_Corrupt' ); fm ($databaseConfiguration, "RENAME TABLE `". $prefix ."Actions_Fixed` TO `". $prefix ."Actions`", 'rename Actions_Fixed to Actions' ); fm ($databaseConfiguration, "DROP TABLE `". $prefix ."Actions_Corrupt`", 'remove Actions_Corrupt table' ); if(Log::$a)__log ('}'); } function wn ($databaseConfiguration){ global$_db; $i5 = ( "(0 ". "OR `Text` LIKE '%!!%' ". "OR `Text` LIKE '%||%' ". "OR `Text` LIKE '%\%\%%' ". "OR `Text` LIKE '%##%' ". "OR `Text` LIKE '%++%' ". "OR `Text` LIKE '%((html%' ". "OR `Text` LIKE '%((img%' ". "OR `Text` LIKE '%((link%' ". "OR `Text` LIKE '%((%.jpg%' ". "OR `Text` LIKE '%((%.jpeg%' ". "OR `Text` LIKE '%((%.gif%' ". "OR `Text` LIKE '%((%.png%' ". "OR `Text` LIKE '%((%.webp%' ". "OR `Text` LIKE '%[[html%' ". "OR `Text` LIKE '%[[img%' ". "OR `Text` LIKE '%[[link%' ". "OR `Text` LIKE '%[[%.jpg%' ". "OR `Text` LIKE '%[[%.jpeg%' ". "OR `Text` LIKE '%[[%.gif%' ". "OR `Text` LIKE '%[[%.png%' ". "OR `Text` LIKE '%[[%.webp%' ". ")" ); if(Log::$a)__log ('Switch from Calliope to Neasden {'); fm ($databaseConfiguration, "UPDATE `". $databaseConfiguration -> getPrefix () . "Notes` ". "SET `FormatterID` = 'neasden' ". "WHERE `SubsetID`=". $databaseConfiguration -> getSubset () ." ". "AND `FormatterID` = 'calliope' ". "AND (". "`IsPublished` = '0' ". "OR (". "`IsPublished` = '1' ". "AND !". $i5. ")". ")" ); if(Log::$a)__log (mysqli_affected_rows ($_db['link']) .' drafts and notes with simple formatting switched'); fm ($databaseConfiguration, "SELECT `ID` FROM `". $databaseConfiguration -> getPrefix () . "Notes` ". "WHERE `SubsetID`=". $databaseConfiguration -> getSubset () ." ". "AND `FormatterID` = 'calliope'" ); $yf = dm (); if(Log::$a)__log (count ($yf) .' with complex formatting remain'); if(count ($yf)>0){ $hv = 'AEGEA-LEGACY-REVIEW'; $o5 = fa ($databaseConfiguration,$hv); if (!$o5){ $o5['ID']=ya ($databaseConfiguration,$hv,false); } if(Log::$a)__log ('Tag "'. $hv .'" has ID '. $o5['ID']); foreach ($yf as $ay){ mm ( "INSERT INTO `". $databaseConfiguration -> getPrefix () . "NotesKeywords` ". "(`SubsetID`, `NoteID`, `KeywordID`) ". "VALUES (". ((int)$databaseConfiguration -> getSubset ()) .", ". ((int)$ay['ID']) .", ". ((int)$o5['ID']). ")", 'add new tag bindings' ); } $hl = 'Aegea legacy notes for review'; $o1 = 'These notes were automatically converted from a very old version of Aegea and may have formatting problems. Please edit them to fix these problems. When finished, just delete this tag.'; fm ($databaseConfiguration, "UPDATE `". $databaseConfiguration -> getPrefix () . "Keywords` ". "SET `IsVisible` = 0, `IsFavourite` = 1, ". "`PageTitle` = '". $hl ."', ". "`Description` = '". $o1 ."' ". "WHERE `SubsetID`=". $databaseConfiguration -> getSubset () ." ". "AND `ID` = " . $o5['ID'] ); fm ($databaseConfiguration, "UPDATE `". $databaseConfiguration -> getPrefix () . "Notes` ". "SET `FormatterID` = 'neasden' ". "WHERE `SubsetID`=". $databaseConfiguration -> getSubset () ." ". "AND `FormatterID` = 'calliope'" ); if(Log::$a)__log ('Switched '. mysqli_affected_rows ($_db['link']) .' notes with complex formatting'); } if(Log::$a)__log ('}'); } function un (AeDatabaseConfiguration $databaseConfiguration){ global$_db; $p5 = false; $cj = array (); $sql = ( 'SHOW TABLES FROM `'. mysqli_real_escape_string ( $_db['link'],$databaseConfiguration->name ). '`' ); if(Log::$a)__log ('DB [?]: '. $sql); $x3 = mysqli_query ($_db['link'],$sql); if ($x3){ while ($e2_ = mysqli_fetch_row ($x3)) { foreach(AeModel::unprefixedCoreTablesNames () as $h5){ if(strcasecmp ($e2_[0],$databaseConfiguration -> getPrefix () . $h5)===0){ $p5 = true; $cj[] = $h5; } } } } $vj = true; foreach(AeModel::unprefixedCoreTablesNames () as $h5){ if (!in_array ($h5,$cj)) { $vj = false; } } $bj = true; foreach(AeModel::unprefixedEssentialTablesNames () as $h5){ if (!in_array ($h5,$cj)) { $bj = false; } } return array ( 'occupied' => $p5, 'complete' => $vj, 'migrateable' => $bj, ); } function in ($databaseConfiguration){ nm ($databaseConfiguration); $dr = un ($databaseConfiguration); if (!$dr['occupied']) { throw new AeMySQLNoDataException ('Database is empty'); } if (!$dr['migrateable']) { throw new AeMySQLNotMigrateableException ('Database is not migrateable'); } } function on (AeDatabaseConfiguration $databaseConfiguration){ global $od; if (($vx = mysqli_connect ( 'p:'. $databaseConfiguration->host, $databaseConfiguration->user, qs ($databaseConfiguration->password), '', $databaseConfiguration->port )) === false) return []; $gr = []; $yj = [ 'information_schema', 'performance_schema', 'sys', 'mysql' ]; @$od ++; $z2 = 'SHOW DATABASES'; if(Log::$a)__log ('DB ['. $od .']: '. $z2); $x3 = mysqli_query ($vx,$z2); while ($e2_ = mysqli_fetch_row ($x3)) { if(mysqli_select_db ($vx,$e2_[0]) and !in_array ($e2_[0],$yj)) { $gr[] = $e2_[0]; } } return $gr; } function pn ($databaseConfiguration,$s2){ fm ( $databaseConfiguration, "SHOW TABLES LIKE '". $databaseConfiguration -> getPrefix () . $s2 . "'" ); $l6 = dm (); return count ($l6)>0; } function cm ($databaseConfiguration,$s2){ fm ( $databaseConfiguration, "SHOW TABLE STATUS LIKE '". $databaseConfiguration -> getPrefix () . $s2 . "'" ); $x3 = dm (); return $x3 ? $x3[0] : []; } function vm ($databaseConfiguration,$s2){ if (pn ($databaseConfiguration,$s2)) return; fm ( $databaseConfiguration, "CREATE TABLE `". $databaseConfiguration -> getPrefix () . $s2 ."` ". AeModel::columnsAndIndexesSQLByUnprefixedTableName ($s2) ." ". "ENGINE=InnoDB DEFAULT CHARSET=utf8mb4" ); } function bm (AeDatabaseConfiguration $databaseConfiguration,$s2,$t4,$nj = 'INSERT',$mj = ''){ global$_db; $fj['SubsetID']=$databaseConfiguration -> getSubset (); foreach ($t4 as $s3 => $a3){ $fj[$s3]="'". sm ($a3) ."'"; } $dj = "`". implode ("`, `",array_keys ($fj)). "`"; $sj = implode (", ",array_values ($fj)); fm ( $databaseConfiguration, $nj ." INTO `". $databaseConfiguration -> getPrefix () . $s2 ."` ". "(" . $dj .") VALUES (". $sj .")". ($mj? (' '. $mj):'') ); $t4['ID']=mysqli_insert_id ($_db['link']); return $t4; } function ym (AeDatabaseConfiguration $databaseConfiguration,$s2,$t4,$aj = false,$qj = false){ if(Log::$a)__log ('Model: update record in table '. $s2 .' {'); $lj = array (); foreach(AeModel::softFieldsByUnprefixedTableName ($s2) as $x){ if(array_key_exists ($x,$t4)) { $lj[] = '`'. $x .'`'."='". sm ($t4[$x]) ."'"; } } $zj = array (); if(is_array ($aj)) { foreach(AeModel::softFieldsByUnprefixedTableName ($s2) as $x){ if(array_key_exists ($x,$aj)) { $zj[] = '`'. $x .'`'."='". sm ($aj[$x]) ."'"; } } } if(count ($zj)) { $c1 = implode (" AND ",$zj); } else { if (!array_key_exists ('ID',$t4) or !is_numeric ($t4['ID'])) { if(Log::$a)__log ('Error: e2_update_record must be called with an ID field in $record when updating single row'); return false; } $c1 = "`ID`=". $t4['ID']; } if(count ($lj)>0){ $kj = $qj? 'LOW_PRIORITY ' : ''; fm ( $databaseConfiguration, "UPDATE ". $kj ."`". $databaseConfiguration -> getPrefix () . $s2 ."` ". "SET ". implode (', ',$lj) ." ". "WHERE `SubsetID`=". $databaseConfiguration -> getSubset () ." ". "AND (". $c1 .")" ); } if(Log::$a)__log ('}'); return true; } define ('E2_MYSQL_CONNECT_TIMEOUT',5); function nm (AeDatabaseConfiguration $databaseConfiguration,$xj = ''){ static $ej = false; static $rj = false; global $_instance_config, $_db, $od; if ($ej !== $databaseConfiguration -> getServerKeyString ()) { if(Log::$a)__log ('Ensure: Establishing connection "'. $databaseConfiguration -> getServerKeyString () .'"'); if ($ej !== false){ mysqli_close ($_db['link']); } $tj = mysqli_init (); $tj -> options (MYSQLI_OPT_CONNECT_TIMEOUT,E2_MYSQL_CONNECT_TIMEOUT); if($_instance_config['dev_chaos'] and !rand (0, (1 / $_instance_config['dev_chaos']) - 1)) { throw new AeMySQLCannotConnectException ('Could not '. $xj ."\n\nChaos"); } $jj = @mysqli_real_connect ( $tj, 'p:'. $databaseConfiguration->host, $databaseConfiguration->user, qs ($databaseConfiguration->password), '', $databaseConfiguration->port ); if (!$jj){ if(1045 === mysqli_connect_errno ()) { throw new AeMySQLAccessDeniedException ('Could not '. $xj); } else { throw new AeMySQLCannotConnectException ('Could not '. $xj); } } if (!lm ($tj)) { throw new AeMySQLTooOldException ('Could not '. $xj); }; $_db['link']=$tj; $ej = $databaseConfiguration -> getServerKeyString (); $rj = false; } if ($rj !== $databaseConfiguration->name){ if(Log::$a)__log ('Ensure: Selecting database "'. $databaseConfiguration->name .'"'); if (!@mysqli_select_db ($_db['link'],$databaseConfiguration->name)) { throw new AeMySQLNotFoundException ('Could not '. $xj); } $z2 = 'SET NAMES utf8mb4'; mysqli_query ($_db['link'],$z2); @$od ++; if(Log::$a)__log ('DB ['. $od .']: '. $z2); $rj = $databaseConfiguration->name; } } function mm ($z2,$xj = 'run some query'){ $databaseConfiguration = iq (); return fm ($databaseConfiguration,$z2,$xj); } function fm ($databaseConfiguration,$z2,$xj = ''){ global $od,$_db,$_config; nm ($databaseConfiguration,$xj); if($_config['dev_chaos'] and !rand (0, (1 / $_config['dev_chaos']) - 1)) { throw new AeMySQLQueryException ('Could not '. $xj ."\n\nChaos in e2_mysql_query"); } @$od ++; if(Log::$a) if ($xj)__log ('Will '. $xj); if(Log::$a)__log ('DB ['. $od .']: '. $z2); $_db['result'] = @mysqli_query ($_db['link'],$z2); if($_db['result']) { if($_config['backup_tail']) { if ( stripos ($z2,"SELECT")!==0 and stripos ($z2,"SHOW")!==0 ) { $wd = $databaseConfiguration->backup_dir .'backup-tail.sql'; @file_put_contents ($wd,$z2 .";\r\n\r\n",FILE_APPEND | LOCK_EX); @chmod ($wd,E2_NEW_FILES_RIGHTS); } } } else { throw new AeMySQLQueryException ('Could not '. $xj ."\n\nMySQL says:\n". mysqli_error ($_db['link'])); } } function dm ($type = MYSQLI_ASSOC){ global$_db; $cb = array (); while ($c5 = @mysqli_fetch_array ($_db['result'],$type)) { foreach ($c5 as $rb => $hj){ if(is_string ($hj)) { $c5[$rb]=$hj; } } $cb[] = $c5; } return $cb; } function sm ($c4){ global$_db; nm (iq (), 'escape string'); return mysqli_real_escape_string ($_db['link'], (string)$c4); } function am () { global$_config; $rv = array_keys (qm (USER_DIR . BACKUP_DIRNAME)); if(Log::$a)__log ('Backup: Found '. count ($rv) .' backups'); if(count ($rv)) { $gj = time () - $rv[0]; $wj = ($gj >= $_config['backup_rebase_interval']); if(Log::$a)__log ('Backup: '. $gj .' seconds since last backup'); } else { $wj = true; } if ($wj){ if(Log::$a)__log ('Backup: Will rebuild backup'); vv (qq ('e2s_dump', []), true); } } function qm ($backup_dir){ $rv = []; foreach(glob ($backup_dir .'*.sql') as $m2){ if(preg_match ('/^backup\-(\d+)\-(\d+)\-(\d+)\-at\-(\d+)\-(\d+)\-(\d+)\.sql$/is',basename ($m2),$fe)) { list (, $tm,$jm,$hm,$uj,$rb,$ij)=$fe; $bf = gmmktime ($uj,$rb,$ij,$jm,$hm,$tm); $rv[$bf]=$m2; } } krsort ($rv); return $rv; } function lm ($tj){ global$_db; $_db['software']='MySQL'; $_db['version-minimum']=E2_MINIMUM_MYSQL; $_db['version']=mysqli_get_server_info ($tj); if(substr ($_db['version'], -8)==='-MariaDB'){ $_db['software']='MariaDB'; $_db['version-minimum']=E2_MINIMUM_MARIADB; $_db['version']=substr ($_db['version'],0, -8); if(substr ($_db['version'],0,6)==='5.5.5-'){ $_db['version']=substr ($_db['version'],6); } } if(Log::$a)__log ( 'Ensure: Running on "'. $_db['software'] .'", version "'. $_db['version'] .'"' ); return (version_compare ($_db['version'],$_db['version-minimum'],'>=')); } function zm ($backup_dir){ $rv = qm ($backup_dir); $pj = [SECONDS_IN_A_MINUTE,SECONDS_IN_AN_HOUR,SECONDS_IN_A_DAY,SECONDS_IN_A_WEEK,SECONDS_IN_A_MONTH, -1]; $ch = count ($rv); $vh = count ($pj)-1; if ($ch > $vh){ if(Log::$a)__log ('Stored are '. $ch .' backups, over '. $vh .', will sift...'); $bh = -1; $rb = 0; foreach ($rv as $bf => $m2){ if(Log::$a)__log ('Backup '. $m2 .' ('. gmdate ('r',$bf) .')'); if ($bh == -1){ if(Log::$a)__log ('is latest, leave'); $bh = $bf; } elseif ($pj[$rb] == -1){ if(Log::$a)__log ('is too old, remove'); @unlink ($m2); } else { if ($bh - $bf < $pj[$rb]) { if(Log::$a)__log ('is not from long ago (within interval of '. $pj[$rb] .'s), remove'); @unlink ($m2); } else { $rb ++; if(Log::$a)__log ('is long enough ago, leave (proceed to interval of '. $pj[$rb] .'s)'); $bh = $bf; } } } } else { if(Log::$a)__log ('No need to sift'); } return; } function km (AeDatabaseConfiguration $databaseConfiguration){ global$_db; if(Log::$a)__log ('Backup to '. $databaseConfiguration->backup_dir); try { nm ($databaseConfiguration,'make backup'); if($_db['link']) { $vd = []; foreach(AeModel::unprefixedCoreTablesNames () as $s2){ $vd[] = $databaseConfiguration -> getPrefix () . $s2; } $l = time (); $wd = $databaseConfiguration->backup_dir .'backup-'.gmdate ('Y-m-d-\a\t-H-i-s',$l).'.sql'; if($databaseConfiguration -> hasSubsetSpecified ()) { $subset = $databaseConfiguration -> getSubset (); } else { $subset = null; } e2_backup ($_db['link'],$vd,$subset,$wd); @unlink ($databaseConfiguration->backup_dir .'backup-tail.sql'); zm ($databaseConfiguration->backup_dir); return $wd; } } catch (AeMySQLException $e){ v3 ($e,'Could not do backup'); return false; } } function xm ($yh){ $nh = parse_url ($yh); $mh = @$nh['host']; $fh = @$nh['port']; if ((string)$mh === ''){ $mh = $yh; $fh = ''; } return [$mh,$fh]; } function e2s_dump () { global$_config; if (!$_config['allow_underhood_access']) { s1 (qq ('e2m_settings')); } if($_SERVER['REQUEST_METHOD']!='POST'){ s1 (qq ('e2m_underhood')); } if (km (iq ())) { hb ('Backed up',E2E_MESSAGE); } s1 (qq ('e2m_underhood')); } function e2m_note ($parameters = []) { global $settings, $_config, $_strings; if(Log::$a)__log ('Note {'); $ay = @$parameters['*note']; if ($ay == false) return e2m_error404 (); $dh = ff ($ay); $mf = yf ($ay); $tn = cs (); $sh = ($parameters['preview-key']==$dh); if (!empty ($parameters['preview-key']) and !$sh) return e2m_error404 (); if (!$tn and !$sh and $mf !== 'public') return e2m_error404 (); if (!empty ($parameters['preview-key']) and $mf === 'public'){ unset($parameters['preview-key']); $va = qq ('e2m_note',$parameters); s1 ($va); } $va = qq ('e2m_note',$parameters); $noteView = new AeNoteView ($ay); $noteView -> setWantReadHref ($_config['count_reads']); $noteView -> setWantControls ($tn and !@$_config['read_only']); $noteView -> setWantHiddenTags ($tn); if ($mf === 'draft' or $mf === 'scheduled'){ if (!$sh){ $ah = [ '.note-id' => $ay['ID'], 'form-action' => qq ('e2s_note_publish'), 'submit-text' => $_strings['fb--publish-note'], 'can-schedule?' => false, 'can-publish?' => !@$_config['read_only'], 'scheduling-promo' => e2l_get_string ( 'pm--scheduling', ['url' => $_config['paid_features_url']] ), ]; } } $qh = ''; $lh = []; $s5 = []; if ($mf === 'public'){ $noteView -> setWantNewCommentsCount ($tn); $noteView -> setWantSharingButtons ($settings['appearance']['show_sharing_buttons']); $noteView -> setWantRelatedNotes (true); } if ($mf === 'public' or $mf === 'hidden'){ if(Log::$a)__log ('Navigation {'); $zh = hm ($ay,'prev'); $kh = hm ($ay,'next'); if ($zh){ $s5['prev-href']=qq ('e2m_note', ['*note' => $zh]); $s5['prev-title']=dy (htmlspecialchars ($zh['Title'],ENT_NOQUOTES,'UTF-8')); } if ($kh){ $s5['next-href']=qq ('e2m_note', ['*note' => $kh]); $s5['next-title']=dy (htmlspecialchars ($kh['Title'],ENT_NOQUOTES,'UTF-8')); } $s5['title']=$_strings['nm--posts']; $s5['timeline?']=false; $s5['this-title']=dy (htmlspecialchars ($ay['Title'],ENT_NOQUOTES,'UTF-8')); if(Log::$a)__log ('}'); if(Log::$a)__log ('Comments {'); if ($tn){ $xh = e2_note_cache_filename_with_id_($ay['ID'] .'-comments-author'); } else { $xh = e2_note_cache_filename_with_id_($ay['ID'] .'-comments'); } $eh = null; if(CACHE_NOTES_COMMENTS and is_file ($xh)) { $eh = @unserialize (file_get_contents ($xh)); } if(is_array ($eh)) { if(Log::$a)__log ('retrieve cached ctree'); $qh = $eh; } else { if(Log::$a)__log ('assemble ctree...'); $rh = zb ($ay['ID']); $q1 = []; $th = true; foreach ($rh as $s3 => $ss){ if ($ss['IsVisible']) { $ts = mb ( $ay, $ss, $s3 + 1 ); if ($ts['new?'] and $th){ $ts['first-new?']=true; $th = false; } $q1[] = $ts; } } $qh = $q1; if(CACHE_NOTES_COMMENTS)e3 ($xh,serialize ($qh)); } if (!@$_config['read_only'] and xb ($ay)) { $jh = db ($ay); $jh['.comment-number']=count ($qh)+1; } if(Log::$a)__log ('} // Comments'); } $j3 = $noteView -> getNoteCTree (); if ($tn and xb ( $ay,NOTE_COMMENTABLE_NOW_CONDITIONALLY )) { $lh['form-action']=qq ('e2s_note_flag', [ '*note' => $ay, 'flag' => 'IsCommentable', 'value' => (int) !$ay['IsCommentable'], ]); $lh['submit-text'] = ( $ay['IsCommentable']? $_strings['bt--close-comments-to-post']:$_strings['bt--open-comments-to-post'] ); } if ($tn and $j3['new-comments-count']>0){ if(Log::$a)__log ('mark comments as not new'); e2_drop_caches_for_note_($ay['ID'],true); ym ( iq (), 'Comments', ['IsNew' => 0], ['NoteID' => $ay['ID']] ); } if(CACHE_RANDOM_NOTE and is_file (USER_DIR . CACHE_FILENAME_RANDOM_NOTE)) { $n5 = @file_get_contents (USER_DIR . CACHE_FILENAME_RANDOM_NOTE); if (((string)$n5)===$j3['href']) { @unlink (USER_DIR . CACHE_FILENAME_RANDOM_NOTE); } } foreach ($j3['tags'] as $hv){ AeMainMenuManager :: addParentTag ($hv['name']); } $cb = [ 'title' => $ay['Title'], 'notes' => ['only' => $j3], 'pages' => $s5, 'summary' => $j3['summary'], ]; if ($qh)$cb['comments']['each']=$qh; if ($lh)$cb['comments']['toggle']=$lh; $cb['comments']['count']=$j3['comments-count']; $cb['comments']['count-text']=$j3['comments-count-text']; $cb['comments']['new-count']=$j3['new-comments-count']; $cb['comments']['new-count-text']=$j3['new-comments-count-text']; $cb['comments']['display-form?']=xb ($ay); if (!empty ($jh)) { $cb['form']='form-comment'; $cb['form-comment']=$jh; } if (!empty ($ah)) { $cb['form']='form-note-publish'; $cb['form-note-publish']=$ah; } if(Log::$a)__log ('} // Note'); return $cb; } function e2m_note_read ($parameters = []) { global$_config; if (!$_config['count_reads']) { die ('Read counting disabled'); } $ay = $parameters['*note']; if ($ay == false) return e2m_error404 (); if(Log::$a)__log ('Note read {'); mm ( "UPDATE LOW_PRIORITY `". $_config['db_table_prefix']."Notes` ". "SET `ReadCount` = `ReadCount` + 1 ". "WHERE `ID` = ". $ay['ID'] ); $hh = time (); $hh = $hh - ($hh % SECONDS_IN_AN_HOUR); bm ( iq (), 'Actions', [ 'EntityID' => $ay['ID'], 'Stamp' => $hh, 'ReadCount' => 1, ], 'INSERT LOW_PRIORITY', 'ON DUPLICATE KEY UPDATE `ReadCount` = `ReadCount` + 1' ); mm ( "DELETE LOW_PRIORITY FROM `". $_config['db_table_prefix']."Actions` ". "WHERE (`Stamp` < ". (time () - (SECONDS_IN_A_MONTH)) .")" ); if(Log::$a)__log ('}'); s1 (qq ('e2m_note',$parameters)); } function e2m_note_withdraw ($parameters = []) { $databaseConfiguration = iq (); $s = $parameters['*note']; if (!$s) return e2m_error404 (); if($_SERVER['REQUEST_METHOD']!='POST'){ s1 (qq ('e2m_note', ['*note' => $s])); } wd (); $gh = qq ('e2m_note_broadcast', ['*note' => $s]); $s['IsPublished']=0; $s['IsCommentable']=0; $s['IsVisible']=1; $s['Stamp']=time (); $s['IP']=ud (); $ky = e2_alias_of_note_with_id_($s['ID']); if ($ky){ $s['OriginalAlias']=$ky; } else { $s['OriginalAlias']=d ( USER_DIR,$databaseConfiguration, 'find','n',$s['ID'],$s['Title'] ); } e2_drop_caches_for_note_($s['ID'],null); ym ($databaseConfiguration,'Notes',$s); e2_delete_aliases_for_entity_('n',$s['ID']); zd ($s['ID']); vv ($gh); s1 (qq ('e2m_note', ['*note' => $s])); } function e2m_note_delete ($parameters = []) { global$_strings; $s = @$parameters['*note']; if (!$s) return e2m_error404 (); $mf = yf ($s); $wh = !$s['IsPublished']; if ($wh){ $uh = e2l_get_string ('gs--draft-will-be-deleted', [ 'draft' => htmlspecialchars ($s['Title'],ENT_NOQUOTES,'UTF-8'), ]); } else { $uh = e2l_get_string ('gs--post-will-be-deleted', [ 'post' => htmlspecialchars ($s['Title'],ENT_NOQUOTES,'UTF-8'), ]); } $ms = $wh? $_strings['pt--draft-deletion']:$_strings['pt--post-deletion']; $ih = [ '.note-id' => $s['ID'], '.is-draft' => (int)$wh, 'note-title' => htmlspecialchars ($s['Title'],ENT_COMPAT,'UTF-8'), 'caution-text' => $uh, 'form-action' => qq ('e2s_note_delete'), 'submit-text' => $_strings['fb--delete'], 'draft?' => (int)$wh, ]; if ($mf === 'public'){ $ih['hide-action']=qq ( 'e2s_note_flag', [ '*note' => $parameters['*note'], 'flag' => 'IsVisible', 'value' => 0 ] ); } if ($s['IsPublished']) { $ih['withdraw-action']=qq ( 'e2m_note_withdraw',$parameters ); } $cb = [ 'title' => $ms. ': '. htmlspecialchars ($s['Title'],ENT_NOQUOTES,'UTF-8'), 'heading' => $ms, 'form' => 'form-note-delete', 'form-note-delete' => $ih, ]; return $cb; } function e2s_note_flag_favourite ($parameters){ $parameters['flag']='IsFavourite'; r1 ([ 'flag-name' => 'favourite', 'candy-name' => 'e2s_note_flag_favourite', 'parameters' => $parameters, 'flipping-function' => function () use ($parameters){ em ($parameters); }, 'redirect-candy' => 'e2m_note', ]); } function e2s_note_flag ($parameters){ em ($parameters); s1 (qq ('e2m_note',$parameters)); } function em ($parameters){ if($_SERVER['REQUEST_METHOD']!='POST'){ s1 (qq ('e2m_note',$parameters)); } wd (); $note_id = $parameters['*note']['ID']; if (!is_numeric ($note_id)) throw new AeException ('Note record not cound from parameters'); e2_drop_caches_for_note_($note_id,$parameters['*note']['IsPublished']); if($parameters['flag']=='IsVisible'){ cb (); } ym (iq (), 'Notes', [ 'ID' => $note_id, $parameters['flag'] => (int) ($parameters['value']==1), ]); try { hv (jm ($note_id)); } catch (AeMySQLException $e){ v3 ($e,'Could not broadcast note flag change'); } return true; } function e2m_note_use_formatter ($parameters){ $note_id = $parameters['*note']['ID']; if (!is_numeric ($note_id)) { return e2m_error404 (); } e2_drop_caches_for_note_($note_id,$parameters['*note']['IsPublished']); if(in_array ($parameters['formatter'], ['raw','neasden'])) { ym (iq (), 'Notes', [ 'ID' => $note_id, 'FormatterID' => $parameters['formatter'], ]); echo 'formatter set to '. $parameters['formatter']; } else { echo 'unknown formatter'; } die; } function rm ($ns,$parameters = []) { global$_strings; $ms = $_strings['pt--new-post']; $fs = $_strings['pt--new-post']; $note_id = 'new'; $oh = DEFAULT_FORMATTER; if ($ns == 'write'){ $bf = time (); $ph = time (); $gb = wa (); $mf = 'draft'; $ky = $c8 = ''; } if ($ns == 'edit'){ $s = @$parameters['*note']; if (!$s) return e2m_error404 (); $bf = min ($s['Stamp'],time ()); $ph = (int)$s['LastModified']; $gb = ha ($s); $mf = yf ($s); if ($s['IsPublished']) { $fs = $_strings['pt--edit-post']; $c8 = ''; $ky = e2_alias_of_note_with_id_($s['ID']); } else { $fs = $_strings['pt--edit-draft']; $c8 = d ( USER_DIR,iq (), 'find','n',$s['ID'],$s['Title'] ); if (@$s['OriginalAlias']) { $ky = $s['OriginalAlias']; } else { $ky = $c8; } } $note_id = $s['ID']; $oh = $s['FormatterID']; $ms = $s['Title']; } $v8 = ma (); $b8 = []; if ($v8 !== null){ foreach ($v8 as $hv){ $b8[] = $hv['tag-dotted']; } } $y8 = []; if ($ns == 'edit' and count ($b8)) { $v8 = ps ($s['ID']); foreach ($v8 as $tb){ $y8[] = qa ($tb); } } $n8 = []; foreach ($b8 as $m8){ $f8['tag-dotted']=$m8; $f8['selected?']=in_array ($m8,$y8); $n8[] = $f8; } $y8 = implode (', ',$y8); if ($ns == 'write'){ $as_ = $_strings['fb--save-and-preview']; } if ($ns == 'edit'){ if(array_key_exists ('draft',$parameters)) { $as_ = $_strings['fb--save-and-preview']; } else { $as_ = $_strings['fb--save-changes']; } } $ib = []; if ($ns == 'edit'){ $ib = sy ( $s['FormatterID'],$s['Text'],'full' ); } $pb = @unserialize ( $s['Uploads'] ) or $pb = []; $d8 = z2 ( s2 ( q2 ( $ib,$pb ) ) ); if ($ns == 'edit'){ i3 ( 'Notes', $s, $ib ); } $xz = vy (); $ez = by ($xz); $cb['title']=$ms; $cb['heading']=$fs; $cb['form']='form-note'; $cb['uploads'] = [ 'enabled?' => $ez, 'each' => $d8, 'default-name' => htmlspecialchars ($ky,ENT_COMPAT,'UTF-8'), 'upload-action' => qq ('e2j_file_upload'), 'remove-action' => qq ('e2j_file_remove'), ]; $cb['form-note'] = [ '.note-id' => $note_id, '.formatter-id' => $oh, '.last-modified-stamp' => $ph, '.published?' => (bool) @$s['IsPublished'], '.old-tags-hash' => md5 ($y8), '.action' => $ns, 'form-action' => qq ('e2s_note_process'), 'form-note-livesave-action' => qq ('e2j_note_livesave'), 'create:edit?' => (bool) ($ns == 'write'), 'title' => htmlspecialchars ((string) @$s['Title'],ENT_COMPAT,'UTF-8'), 'tags-info' => $n8, 'text' => htmlspecialchars ((string) @$s['Text'],ENT_NOQUOTES,'UTF-8'), 'stamp-formatted' => pa ('d.m.Y H:i:s',$bf,$gb), 'time' => @$s['IsPublished']? [(int)$bf,$gb]:false, 'draft?' => $mf === 'draft', 'uploads-enabled?' => $ez, 'summary' => (string) @$s['Summary'], 'alias-autogenerated' => htmlspecialchars ($c8,ENT_COMPAT,'UTF-8'), 'alias' => htmlspecialchars ($ky,ENT_COMPAT,'UTF-8'), 'submit-text' => $as_, 'space-usage' => yy ($xz), ]; if ($ns == 'edit'){ $cb['related-delete-href']=qq ( 'e2m_note_delete', ['*note' => $s] ); } return $cb; } function e2m_note_edit ($parameters = []) { return rm ('edit',$parameters); } function e2m_write () { return rm ('write'); } function e2s_note_process () { global$_strings; try { $a8 = cf (); $note_id = $a8['data']['id']; $ay = jm ($note_id); s1 (qq ('e2m_note', ['*note' => $ay])); } catch (AeFormIncompleteException $e){ hb ($_strings['er--post-must-have-title-and-text'],E2E_USER_ERROR); if($e->note_id === 'new'){ s1 (qq ('e2m_write')); } else { s1 (qq ('e2m_note_edit', ['*note' => jm ($e->note_id)])); } } catch (AeMySQLException $e){ v3 ($e,'Could not process note'); s1 (); } die; } function e2s_note_publish () { global$_config,$settings; $databaseConfiguration = iq (); wd (); $note_id = ''; if(array_key_exists ('note-id',$_POST))$note_id = trim ($_POST['note-id']); if (!is_numeric ($note_id) and $note_id !== 'new'){ throw new AeFormInconsistentException (); } $q8 = false; $s = jm ($note_id); if (!$s)s1 (); $l8 = $s['OriginalAlias']; $z8 = $s['Stamp']; $k8 = !$s['IsExternal']; $s['ID']=$note_id; $s['IsVisible']=1; $s['IsPublished']=1; $s['IsCommentable'] = (int)$settings['comments']['default_on']; $s['IsFavourite']=0; if(array_key_exists ('browser-offset',$_POST)) { $gb = d1 (@$_POST['browser-offset']); } else { $gb = wa (); } if ($q8 and $bf = pm ($q8,$gb)) { $s['Stamp']=$bf; } elseif ($k8){ $s['Stamp']=time (); } else { $s['Stamp']=$z8; } if (ld ($s)) { $s['IsIndexed']='1'; } if ($gb){ $s['Offset'] = (int)$gb['offset']; $s['IsDST'] = (int)$gb['is_dst']; } e2_drop_caches_for_note_($note_id,null); ym ($databaseConfiguration,'Notes',$s); $ky = ''; if ($l8 or $l8 === '0'){ $ky = d ( USER_DIR,$databaseConfiguration, 'set','n',$note_id,$l8 ); $s['OriginalAlias']=$ky; } if ($ky != $l8){ ym ($databaseConfiguration,'Notes',$s); } $mf = yf ($s); if ($mf === 'public'){ hv ($s); } s1 (qq ('e2m_note', ['*note' => $s])); } function tm ($note_id,$x8 = -1){ global$_config; $bs = true; if ($x8){ $bs = false; } if ($x8 === -1){ $bs = null; } e2_drop_caches_for_note_($note_id,$bs); mm ( "DELETE FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID` = '". ((int)$note_id) ."'", 'delete note by ID' ); zd ($note_id); e2_delete_aliases_for_entity_('n',$note_id); mm ( "DELETE FROM `". $_config['db_table_prefix']."NotesKeywords` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `NoteID`=". ((int)$note_id), 'delete tag bindings after deleting note' ); } function e2s_note_delete () { wd (); $note_id = ''; if(array_key_exists ('note-id',$_POST))$note_id = trim ($_POST['note-id']); if (!is_numeric ($note_id) and $note_id !== 'new'){ throw new AeFormInconsistentException (); } $x8 = (bool)$_POST['is-draft']; $s = jm ($note_id); if ($s){ $gh = qq ('e2m_note_broadcast', ['*note' => $s]); tm ($note_id,$x8); vv ($gh); } if ($x8){ s1 (qq ('e2m_drafts', ['page' => 1])); } else { s1 (); } die; } function e2j_note_livesave () { try { $a8 = cf (); } catch (AeFormIncompleteException $e){ $a8 = [ 'success' => false, 'error' => [ 'message' => 'Title or text is empty' ] ]; } catch (AeRecordNotFoundException $e){ $a8 = [ 'success' => false, 'error' => [ 'message' => 'Record not found' ] ]; } catch (AeMySQLException $e){ v3 ($e); $a8 = [ 'success' => false, 'error' => [ 'message' => 'Database error' ] ]; } echo json_encode ($a8); die; } function jm ($zy){ global$_config; mm ( "SELECT * FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID` = '". $zy ."'" ); $zb = dm (); if(count ($zb)>0){ return $zb[0]; } else { return false; } } function hm ($ay,$e8,$r8 = 1){ global$_config; $l5 = ($e8 == 'next')?'>':'<'; $t8 = ($e8 == 'next')?'':'DESC '; try { mm ( "SELECT * FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished`=". $r8 ." ". "AND (". "`Stamp` ". $l5 ." '". $ay['Stamp'] ."' ". "OR (`Stamp` = '". $ay['Stamp'] ."' AND `ID` ". $l5 . $ay['ID'] .")". ") ". nf (cs ()). "ORDER BY `Stamp` ". $t8 . ", `ID` ". $t8 . "LIMIT 1", 'get '. $e8 .' note' ); $zb = dm (); if(count ($zb)>0) return $zb[0]; else return false; } catch (AeMySQLException $e){ v3 ($e,'Could not get '. $e8 .' note'); return null; } } function gm ($j8){ global$_config; if(Log::$a)__log ('Lastmodifieds for Local Copier'); $j8 = (string)$j8; $j8 = preg_replace ('[^0-9,]','',$j8); $j8 = trim ($j8,','); if(CACHE_LASTMODIFIEDS and is_file (USER_DIR . CACHE_FILENAME_LASTMODIFIEDS)) { $h8 = @unserialize (file_get_contents (USER_DIR . CACHE_FILENAME_LASTMODIFIEDS)); if ($h8['ids_csv']==$j8){ if(Log::$a)__log ('Returned from cache'); return $h8['lastmodifieds_json']; } } $c1 = '`ID`='. str_replace (',',' OR `ID`=',$j8); $g8 = []; mm ( "SELECT `ID`, `LastModified` ". "FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND (". $c1 .")", 'get lastmodifieds for Local Copier' ); if(Log::$a)__log ('Requested from DB'); $x3 = dm (); foreach ($x3 as $s3 => $a3){ $g8[(int)$a3['ID']] = (int)$a3['LastModified']; } $w8 = json_encode ($g8); if ($w8 == '[]')$w8 = '{}'; $h8 = [ 'ids_csv' => $j8, 'lastmodifieds_json' => $w8, ]; if(CACHE_LASTMODIFIEDS){ e3 (USER_DIR . CACHE_FILENAME_LASTMODIFIEDS,serialize ($h8)); } return $w8; } function wm ($tm,$jm,$hm = false){ global$_config; list ($zn,$kn)=n1 ($tm,$jm,$hm); mm ( "SELECT * FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished` AND (`Stamp` BETWEEN " .$zn. " AND " .$kn. ") ". "ORDER BY Stamp", 'get all notes for the date '. $hm .'.'. $jm .'.'. $tm ); $cb = []; foreach (dm () as $sf){ if(is_numeric ($hm)) { $d1 = ((int)$tm) .'/'. ((int)$jm) .'/'. ((int)$hm) == pa ('Y/n/j',$sf['Stamp'],ha ($sf)); } elseif(is_numeric ($jm)) { $d1 = ((int)$tm) .'/'. ((int)$jm) == pa ('Y/n',$sf['Stamp'],ha ($sf)); } else { $d1 = ((int)$tm) == pa ('Y',$sf['Stamp'],ha ($sf)); } if ($d1)$cb[] = $sf; } return $cb; } function e2_published_noterec_with_parameters_($parameters = []) { $ay = e2_noterec_with_parameters_($parameters); if ($ay and $ay['IsPublished']) return $ay; } function e2_noterec_with_parameters_($parameters = []) { global$_config; $ay = false; $i8 = false; if ((string) @$parameters['oalias']!=='')$i8 = $parameters['oalias']; if ((string)$i8 !== ''){ mm ( "SELECT * FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `OriginalAlias` = '". $i8 ."' ". "AND `IsPublished` = 0", 'get note record by original alias' ); $ay = dm (); if(count ($ay)===1) { $ay = @$ay[0]; if ($ay) return $ay; } } $o8 = false; if (@$parameters['draft']!=='') $o8 = @$parameters['draft']; if (@$parameters['draft2']!=='')$o8 = @$parameters['draft2']; if ($o8){ $ay = jm ($o8); return $ay; } if ((string)$i8 !== ''){ $parameters['alias']=$i8; } if ((string) @$parameters['alias']!==''){ if ($p8 = f (@$parameters['alias'])) { if ($p8['type']=='n'){ $ay = jm ($p8['id']); if ($ay and $ay['IsPublished']) return $ay; } } } if ( (string) @$parameters['year']!=='' and (string) @$parameters['month']!=='' and (string) @$parameters['day']!=='' ) { $yf = wm ( $parameters['year'],$parameters['month'],$parameters['day'] ); if (@$yf[$parameters['day-number']-1]) { return $yf[$parameters['day-number']-1]; } } return null; } function om ($ms,$l1,$gb,$cg){ $databaseConfiguration = iq (); vb (); @unlink (USER_DIR . CACHE_FILENAME_DRAFTS); @unlink (USER_DIR . CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); $ay = [ 'Title' => $ms, 'Text' => $l1, 'FormatterID' => DEFAULT_FORMATTER, 'OriginalAlias' => d ( USER_DIR,$databaseConfiguration, 'find','','',$ms ), 'Uploads' => $cg, 'IsPublished' => 0, 'Stamp' => (int)time (), 'LastModified' => (int)time (), ]; if ($gb and is_array ($gb)) { $ay['Offset'] = (int)$gb['offset']; $ay['IsDST'] = (int)$gb['is_dst']; } return bm ($databaseConfiguration,'Notes',$ay); } function pm ($vg,$gb){ $bg = '/^ *(\d{1,2})\.(\d{1,2})\.(\d{2}|\d{4}) +(\d{1,2})\:(\d{1,2})\:(\d{1,2}) *$/'; if(preg_match ($bg,$vg,$jm)) { $bf = gmmktime ($jm[4],$jm[5],$jm[6],$jm[2],$jm[1],$jm[3]); $bf -= ia ($gb,$bf); return $bf; } else { return false; } } function cf () { global$_config; if(Log::$a)__log ('Process note form'); wd (); $note_id = $ms = $yg = $l1 = $ng = $mg = ''; if(array_key_exists ('note-id',$_POST)) $note_id = trim ($_POST['note-id']); if(array_key_exists ('title',$_POST)) $ms = trim ($_POST['title']); if(array_key_exists ('tags',$_POST)) $yg = $_POST['tags']; if(array_key_exists ('text',$_POST)) $l1 = trim ($_POST['text'],"\r\n"); if(array_key_exists ('summary',$_POST)) $ng = trim ($_POST['summary'],"\r\n"); if(array_key_exists ('old-tags-hash',$_POST)) $mg = $_POST['old-tags-hash']; if (!is_numeric ($note_id) and $note_id !== 'new'){ throw new AeFormInconsistentException (); } if ((string)$ms === '' or (string)$l1 === ''){ throw new AeFormIncompleteException ($note_id); } $fg = $l1; $fg = str_replace ("\n",'\n'."\n",$fg); $fg = str_replace ("\r",'\r'."\r",$fg); if (!is_array ($yg))$yg = []; $yg = trim (implode (', ',$yg)); $dg = z1 (',',$yg,'sort'); $yg = implode (', ',$dg); $sg = md5 ($yg); if(array_key_exists ('browser-offset',$_POST)) { $gb = d1 (@$_POST['browser-offset']); } else { $gb = wa (); } $ag = @$_POST['old-stamp']; $q8 = @$_POST['stamp']; $ky = @$_POST['alias']; $databaseConfiguration = iq (); if($note_id == 'new'){ $cg = ''; if(is_file (USER_DIR . 'new-uploads.psa')) { $cg = @file_get_contents (USER_DIR . 'new-uploads.psa'); } $ay = om ($ms,$l1,$gb,$cg); $note_id = (int)$ay['ID']; @unlink (USER_DIR . 'new-uploads.psa'); $x3 = [ 'success' => true, 'data' => [ 'status' => 'created', 'id' => $note_id, 'note-url' => qq ('e2m_note', ['*note' => $ay]), 'note-edit-url' => qq ('e2m_note_edit', ['*note' => $ay]) ] ]; } else { $qg = jm ($note_id); if (!$qg){ throw new AeRecordNotFoundException (); } e2_drop_caches_for_note_($note_id,$qg['IsPublished']); $lg = $qg; $lg['ID']=$note_id; $lg['Title']=$ms; $lg['Summary']=$ng; $lg['Text']=$l1; $lg['FormatterID']=$qg['FormatterID']; $lg['LastModified']=time (); $lg['IsIndexed']='0'; if ($lg['FormatterID']!=='raw'){ $lg['FormatterID']=DEFAULT_FORMATTER; } if ($ag != $q8){ if ($bf = pm ($q8,$gb)) { $lg['Stamp']=min ($bf,time ()); } } $ey = $ky; if ((string)$ky !== ''){ $zg = $ky; } elseif (!$qg['IsPublished']) { $zg = $ms; } else { $zg = ''; } if ($qg['IsPublished']) { $ey = d ( USER_DIR,$databaseConfiguration, 'set','n',$note_id,$zg ); $kg = [ '*note' => $lg, 'alias' => $ey, ]; } else { $ey = d ( USER_DIR,$databaseConfiguration, 'find','n',$note_id,$zg ); $lg['OriginalAlias']=$ey; $kg = [ '*note' => $lg, 'alias' => $ey, ]; } $ib = sy ( $lg['FormatterID'],$lg['Text'],'full' ); if(count ($ib)>0){ t2 ($ib); j2 ($ib); } ym ($databaseConfiguration,'Notes',$lg); if ($lg['IsPublished']) { if (ld ($lg)) { $lg['IsIndexed']='1'; ym ($databaseConfiguration,'Notes',$lg); } if ($ag != $q8){ b (true); } hv ($lg); } $x3 = [ 'success' => true, 'data' => [ 'status' => 'saved', 'id' => (int)$lg['ID'], 'new-alias' => $ey, 'note-url' => qq ('e2m_note',$kg), 'note-edit-url' => qq ('e2m_note_edit',$kg) ] ]; } if ($sg != $mg){ ca ($databaseConfiguration,$note_id,$dg); } if($_config['backup_automatically']) { am (); } return $x3; } function vf ($xg,$eg){ global$_config; if (!($xg and $eg) and !cs ()) { if(Log::$a)__log ('Error: e2_notes_count_generic called for invisible items unsecurely'); return null; } if (!is_bool ($xg) or !is_bool ($eg)) { if(Log::$a)__log ('Error: e2_notes_count_generic called with non-bool params'); return null; } if (!$xg and !$eg){ if(Log::$a)__log ('Error: e2_notes_count_generic called with nonsensical parameters'); return null; } $wf = ( USER_DIR . CACHES_DIRNAME . 'notes-count-p'. (int)$xg . ($xg ? ('v'. (int)$eg):'') . '.txt' ); $x3 = false; if(CACHE_NOTES_COUNTS and is_file ($wf)) { $x3 = (int) @file_get_contents ($wf); } if(is_numeric ($x3) and $x3 > 0){ return $x3; } else { $x3 = null; try { mm ( "SELECT COUNT(*) As NotesCount FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished`=". (int)$xg. " ". ($xg ? ( "AND `IsVisible`=". (int)$eg ) : ""), 'count notes with flags p'. (int)$xg . ($xg ? ('v'. (int)$eg):'') ); $x3 = dm (); $x3 = (int)$x3[0]['NotesCount']; if(CACHE_NOTES_COUNTS)e3 ($wf,$x3); } catch (AeMySQLException $e){ v3 ($e); if(Log::$a)__log ('Could not count notes'); } return $x3; } } function bf ($l1){ $ng = $l1; $ng = preg_match ( '/^(\<\/div\>)?\<p( class\=\"lead\")?\>(.*)\<\/p\>$/mu', $ng, $fe ); $ng = @$fe[3]; if (!$ng)$ng = $l1; if(mb_strlen ($ng) <= 50)$ng = $l1; $ng = str_replace ([ '<p>','<blockquote>','<ul>','<ol>','<br />', ], "\n",$ng); $ng = trim (strip_tags ($ng)); if(mb_strlen ($ng)>50){ $rg = mb_strpos ($ng,"\n",50); } else { $rg = mb_strrpos ($ng,"\n"); } if ($rg !== false){ $ng = mb_substr ($ng,0,$rg); $ng = trim ($ng,' :.()'."\n"); } if(preg_match ('/^(.{100,}?)(?:[:.!?()]|'."\n".')/su',$ng,$fe)) { $ng = trim ($fe[0],' :.()'."\n"); } if(preg_match ('/^(.{150,}?)[:.!?(),]/su',$ng,$fe)) { $ng = trim ($fe[0],' :.(),'."\n"); } if(preg_match ('/^(.{200,}?)[:.!?(), ]/su',$ng,$fe)) { $ng = trim ($fe[0],' :.()'."\n"); } $ng = preg_replace ('/[ \n\r\t]+/su',' ',$ng); if(mb_substr ($ng, -1)==='.')$ng = mb_substr ($ng,0, -1); if(mb_substr ($ng, -1)===':')$ng = mb_substr ($ng,0, -1); if(mb_substr ($ng, -1)==='!')$ng = mb_substr ($ng,0, -1); if (@in_array ($ng[mb_strlen ($ng)-1], [',',' '])) { $ng = trim ($ng,', '). '...'; } if(mb_strlen ($ng)>250){ $ng = trim (mb_substr ($ng,0,250)). '...'; } return $ng; } function yf ($ay){ $tg = false; if ($ay['IsPublished']) { if ($tg){ return 'scheduled'; } else { if ($ay['IsVisible']) { return 'public'; } else { return 'hidden'; } } } else { return 'draft'; } } function nf ($tn = false){ if ($tn){ return ''; } else { return 'AND (n.`IsVisible` = 1 AND n.`Stamp` <= '. time () .') '; } } function mf () { global$_config; if(CACHE_RANDOM_NOTE and is_file (USER_DIR . CACHE_FILENAME_RANDOM_NOTE)) { $n5 = @unserialize (file_get_contents (USER_DIR . CACHE_FILENAME_RANDOM_NOTE)); return $n5; } mm ( "SELECT *, COUNT(*) AS c FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE n.`SubsetID`=". $_config['db_table_subset'] ." ". "AND n.`IsPublished` = 1 ". "AND n.`IsVisible` = 1 ". "ORDER BY `IsFavourite`, RAND() LIMIT 1", 'get a random visible published preferably favourite note' ); $yf = dm (); $n5 = false; if(count ($yf) and $yf[0]['c'] >= 10){ $n5 = qq ('e2m_note', ['*note' => $yf[0]]); } if(CACHE_RANDOM_NOTE){ e3 (USER_DIR . CACHE_FILENAME_RANDOM_NOTE,serialize ($n5)); } return $n5; } function ff ($ay){ return ''; } define ('OLBA_SPECIAL_CHAR',"\x1"); define ('OLBA_SPECIAL_SEQUENCE_LENGTH',6); function qf ($pg = null){ global$_template,$settings; if ($pg === null)$pg = @$settings['template']; $cw = null; $vw = null; $bw = null; $yw = array (); $nw = $pg; if ($nw !== null){ while (1){ foreach ([ USER_DIR . THEMES_DIRNAME, INSTANCE_DIR . THEMES_DIRNAME, SYSTEM_DIR . THEMES_DIRNAME ] as $mw){ $fw = $mw . $nw .'/'; if ( is_dir ($fw) and is_file ($fw .'/theme-info.php') ) { if(Log::$a)__log ('Theme "'. $nw .'" found in "'. $fw . '"'); break; } else { $fw = false; } } if (!$fw){ if(Log::$a)__log ('Theme "'. $nw .'" not found, using default theme "'. DEFAULT_TEMPLATE .'"'); $nw = DEFAULT_TEMPLATE; $fw = $mw . $nw .'/'; } array_push ($yw,$fw); $dw = include $fw .'/theme-info.php'; $sw[$fw]=$dw; if(array_key_exists ('meta_viewport',$dw)) { if ($cw === null){ $cw = $dw['meta_viewport']; } } if(array_key_exists ('supports_dark_mode',$dw)) { if ($vw === null){ $vw = $dw['supports_dark_mode']; } } if(array_key_exists ('use_likely_light',$dw)) { if ($bw === null){ $bw = $dw['use_likely_light']; } } if(array_key_exists ('based_on',$dw)) { $nw = $dw['based_on']; } else { break; } } } if ($cw === null)$cw = ''; if ($vw === null)$vw = false; if ($bw === null)$bw = false; $fw = SYSTEM_THEME_DIR; array_push ($yw,$fw); $sw[$fw] = []; $_template['name']=$pg; $_template['meta_viewport']=$cw; $_template['supports_dark_mode']=$vw; $_template['use_likely_light']=$bw; $_template['stack']=$yw; $_template['infos']=$sw; }; function lf ($aw){ global$content; if (!isset ($_olba_includes))$_olba_includes = 0; ++ $_olba_includes; if(Log::$a)__log ('Eat "'. $aw .'"'); ob_start (); include $aw; return ob_get_clean (); } function zf ($nb){ return ( OLBA_SPECIAL_CHAR. str_pad ($nb,OLBA_SPECIAL_SEQUENCE_LENGTH,'0',STR_PAD_LEFT). OLBA_SPECIAL_CHAR ); } function kf ($name){ static $nb = 0; y2 ($name,'_olba_placeholders'); return zf ($nb ++); } function xf ($qw){ global$_olba_placeholders; foreach($_olba_placeholders as $nb => $cv){ $lw = zf ($nb); $zw = strpos ($qw,$lw); $kw = rf ($cv,true); if ($zw !== false){ $qw = substr_replace ( $qw,$kw,$zw,strlen ($lw) ); } else { break; } } return $qw; } function ef ($xw){ foreach ([ USER_DIR . EXTRAS_DIRNAME, INSTANCE_DIR . EXTRAS_DIRNAME, SYSTEM_DIR . EXTRAS_DIRNAME ] as $ew){ if(is_dir ($ew)) { $rw = $ew . $xw .'.tmpl.php'; if(is_file ($rw)) { return lf ($rw); } } } return ''; } function rf ($xw){ global$_template,$_olba_includes; $rw = 'templates/'. $xw .'.tmpl.php'; if ($aw = e2o__usable_file_with_basename_($rw)) { return lf ($aw); } else { ob_end_clean (); throw new AeOlbaTemplateMissingException ('Missing: '. $rw); } } function tf () { global$_config; if ( @$_config['raw_template_data'] or @$_config['raw_template_data_with_param'] and array_key_exists ('raw',$_GET) ) { $tw = 'raw'; } else { $tw = 'main'; } return rf ($tw,true); } function jf ($jw){ y2 ($jw .'.css','_olba_used_stylesheets'); } function hf ($hw){ y2 ($hw .'.js','_olba_used_scripts'); } function gf ($gw){ foreach ([ SYSTEM_DIR . LIBRARY_DIRNAME, INSTANCE_DIR . LIBRARY_DIRNAME, USER_DIR . LIBRARY_DIRNAME ] as $ww){ foreach(glob ($ww . $gw .'/*') as $m2){ $w4 = pathinfo ($m2,PATHINFO_EXTENSION); if ($w4 == 'js'){ y2 ($m2,'_olba_used_scripts'); } if ($w4 == 'css'){ y2 ($m2,'_olba_used_stylesheets'); } } } } function wf () { global$_template,$settings; foreach ([ USER_DIR . THEMES_DIRNAME, INSTANCE_DIR . THEMES_DIRNAME, SYSTEM_DIR . THEMES_DIRNAME ] as $uw){ if ($iw = @opendir ($uw)) { while (false !== ($ow = readdir ($iw))) { if(is_dir ($uw. $ow) and $ow != '.' and $ow != '..'){ if(is_file ($uw . $ow .'/theme-info.php')) { $pw[$ow]=$uw . $ow .'/'; } } } closedir ($iw); } } $rv = array (); $cu = 1000; foreach ($pw as$name => $w){ $dw = include $w .'theme-info.php'; $vu = @$dw['display_name']; if (!$vu) continue; if(is_array ($vu)) { if(array_key_exists ($settings['language'],$vu)) { $vu = $vu[$settings['language']]; } else { $vu = array_shift ($vu); } } $nb = @$dw['index'] or $nb = $cu ++; $bu = @$dw['colors']; if (!$bu)$bu = array ( 'background' => 'transparent', 'headings' => 'rgba(128,128,128,.2)', 'text' => 'rgba(128,128,128,.2)', 'link' => 'rgba(128,128,128,.2)', ); $yu = (bool) ($name == $_template['name']); if ($yu){ $nu = qq ('e2m_theme_preview', array ('theme' => '')); } else { $nu = qq ('e2m_theme_preview', array ('theme' => $name)); } $rv[$nb] = array ( 'name' => $name, 'display-name' => $vu, 'colors' => $bu, 'current?' => $yu, 'preview-url' => $nu, 'supports-dark-mode?' => $dw['supports_dark_mode'], ); } ksort ($rv); return $rv; } function uf ($wd){ return e2o__usable_file_with_basename_('images/'. $wd); } function if_ ($mu){ $fu = e2o__usable_file_with_basename_('images/'. $mu .'.svg'); if(is_file ($fu)) { return file_get_contents ($fu); } return ''; } function of ($jw){ global$_template; $hd = 'styles/'. $jw .'.css'; $du = array (); foreach($_template['stack'] as $fw){ if(is_file ($wd = $fw . $hd)) { $du[] = $wd; } if ( array_key_exists ('reset_styles',$_template['infos'][$fw]) and in_array ($jw,$_template['infos'][$fw]['reset_styles']) ) { break; } } $du = array_reverse ($du); } function pf ($rv){ foreach ($rv as $s3 => $a3){ $id = stat ($a3); $rv[$s3]=AeEnv::$base_url . $rv[$s3] .'?'. $id['mtime']; } return $rv; } function c2 () { global$_olba_used_stylesheets,$_template; if (!isset ($_olba_used_stylesheets)) return; $_olba_used_stylesheets = array_unique ($_olba_used_stylesheets); $su = array (); foreach($_olba_used_stylesheets as $jw){ if(is_file ($jw)) { $su[] = $jw; continue; } if(is_file ($wd = USER_DIR . SCRIPTS_SUBDIR . $jw)) { $su[] = $wd; } $hd = 'styles/'. $jw; $du = array (); foreach($_template['stack'] as $fw){ if(is_file ($wd = $fw . $hd)) { $du[] = $wd; } if ( array_key_exists ('reset_styles',$_template['infos'][$fw]) and in_array ($jw,$_template['infos'][$fw]['reset_styles']) ) { break; } } $du = array_reverse ($du); $su = array_merge ($su,$du); } $su = pf ($su); return $su; } function v2 () { global$_olba_used_scripts; if (!isset ($_olba_used_scripts)) return; $_olba_used_scripts = array_unique ($_olba_used_scripts); $au = array (); foreach($_olba_used_scripts as $hw){ if ( substr ($hw,0,7)=='http://' or substr ($hw,0,8)=='https://' or substr ($hw,0,2)=='//' ) { $au[] = $hw; continue; } if(is_file ($hw)) { $au[] = $hw; continue; } if(is_file ($qu = USER_DIR . SCRIPTS_SUBDIR . $hw)) { $au[] = $qu; } $hd = SCRIPTS_SUBDIR . $hw; if ($qu = e2o__usable_file_with_basename_($hd)) { $au[] = $qu; } } $au = pf ($au); return $au; } function b2 ($lu){ if (!is_array ($lu)) return; foreach ($lu as $vx){ if(substr ($vx, -3)=='.js'){ hf (substr ($vx,0, -3)); } if(substr ($vx, -4)=='.css'){ jf (substr ($vx,0, -4)); } } } function y2 ($cv,$cs){ if (!isset ($GLOBALS[$cs])) { $GLOBALS[$cs] = array ($cv); } else { $GLOBALS[$cs][] = $cv; } } function e2o__usable_file_with_basename_($hd){ global$_template; if (!isset ($_template))qf (); foreach($_template['stack'] as $fw){ if(is_file ($wd = $fw . $hd)) { return $wd; } } return ''; } function e2m_theme_preview ($parameters){ global$_lang,$_strings,$_config,$_template; if (!$_config['allow_themes_preview']) { return e2m_error404 (); } if ((string)$parameters['theme']!==''){ qf ($parameters['theme']); } else { qf (); } if($parameters['theme']==$_template['name']) { s1 (qq ('e2m_theme_preview', ['theme' => ''])); } $mx = $_lang; if (!is_file ($m2 = 'system/preview/'. $mx .'.php')) { $mx = $_strings['--secondary-language']; $m2 = 'system/preview/'. $mx .'.php'; } if (!is_file ($m2 = 'system/preview/'. $mx .'.php')) { $m2 = 'system/preview/'. DEFAULT_LANGUAGE .'.php'; } $v = include $m2; return $v; } function e2m_popular ($parameters = []) { global$settings,$_config,$_strings; $tn = cs (); $popularView = new AePageableNotesView ('e2m_popular',$parameters); $popularView -> setPortionSize ($settings['appearance']['notes_per_page']); $popularView -> setNextPrevPageTitles ($_strings['gs--earlier'],$_strings['gs--later']); $popularView -> setWantNewCommentsCount ($tn); $popularView -> setWantReadHrefs ($_config['count_reads']); $popularView -> setWantControls ($tn and !@$_config['read_only']); $popularView -> setWantHiddenTags ($tn); AeMainMenuManager :: $isPopularCurrent = true; $nl = $_config['popular_period']; if ($nl === 'ever'){ $popularView -> setLimitlessSQLRequest ( "SELECT * ". "FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished` = 1 ". nf ($tn). "ORDER BY `ReadCount` DESC" ); } else { $ml = time () - n3 ($_config['popular_period']); $zu = ( "FROM `". $_config['db_table_prefix']."Actions` a, ". "`". $_config['db_table_prefix']."Notes` n ". "WHERE a.`SubsetID`=". $_config['db_table_subset'] ." ". "AND n.`SubsetID`=". $_config['db_table_subset'] ." ". "AND a.`Stamp` > ". $ml ." ". "AND n.`IsPublished` = 1 ". nf ($tn). "AND a.`EntityID` = n.`ID` ". "GROUP BY a.`EntityID`" ); $popularView -> setSQLCountRequest ( "SELECT COUNT(*) Total FROM (SELECT 1 ". $zu .") _" ); $popularView -> setLimitlessSQLRequest ( "SELECT n.*, a.`EntityID`, SUM(a.`ReadCount`) `AggregateReadCount` ". $zu ." ". "ORDER BY `AggregateReadCount` DESC" ); } $cb = [ 'title' => e2l_get_string ('pt--most-read', ['period' => $nl]), 'heading' => e2l_get_string ('pt--most-read', ['period' => $nl]), 'notes' => $popularView -> getNotesCTree (), 'pages' => $popularView -> getPagesCTree (), ]; if($popularView -> isFirstPageOfEmptyView ()) { $cb['nothing']=$_strings['gs--no-such-notes']; } elseif (!$popularView -> isExistingPage ()) { return e2m_error404 (); } return $cb; } function m2 ($ys = false,$e3 = []) { global$_config,$_current_url; $ku = $xu = ''; $mostReadNotesCollectionView = new AeArbitraryNotesCollectionView ('most read or most read by tag'); $mostReadNotesCollectionView -> setCurrentURL ($_current_url); $mostReadNotesCollectionView -> setFilterOutIDs ($e3); $ml = time () - n3 ($_config['popular_period']); $mostReadNotesCollectionView -> setSQLRequest ( "SELECT n.*, a.`EntityID`, SUM(a.`ReadCount`) `AggregateReadCount` ". "FROM `". $_config['db_table_prefix']."Actions` a, ". "`". $_config['db_table_prefix']."Notes` n ". $ku. "WHERE a.`SubsetID`=". $_config['db_table_subset'] ." ". "AND n.`SubsetID`=". $_config['db_table_subset'] ." ". $xu. "AND a.`Stamp` > ". $ml ." ". "AND n.`IsPublished` = 1 ". "AND n.`IsFavourite` = 1 ". nf (cs ()). "AND a.`EntityID` = n.`ID` ". "GROUP BY a.`EntityID` ". "ORDER BY `IsFavourite` DESC, `AggregateReadCount` DESC ". "LIMIT 10" ); if ($ys === false){ if(CACHE_POPULAR){ $mostReadNotesCollectionView -> setViewExpiration (SECONDS_IN_A_DAY); $mostReadNotesCollectionView -> setCacheFilename (USER_DIR . CACHE_FILENAME_POPULAR); $mostReadNotesCollectionView -> setCacheExpiresFilename (USER_DIR . CACHE_FILENAME_POPULAR_EXPIRES); } } else { if(CACHE_POPULAR_WITH_TAG){ $mostReadNotesCollectionView -> setViewExpiration (SECONDS_IN_A_DAY); $mostReadNotesCollectionView -> setCacheFilename (e2_cache_filename_with_id_($ys,USER_DIR . CACHE_FILENAMES_POPULAR_WITH_TAG)); $mostReadNotesCollectionView -> setCacheExpiresFilename ( e2_cache_filename_with_id_($ys,USER_DIR . CACHE_FILENAMES_POPULAR_WITH_TAG_EXPIRES) ); } } return$mostReadNotesCollectionView -> getNotesCTree (); } function f2 ($ys = false,$e3 = []) { global$_strings; $eu = [ 'title' => $_strings['nm--most-read'], ]; $eu['each']=m2 ($ys,$e3); if ($ys){ $eu['seed']=$ys; } if(count ($eu['each']) < 7){ return []; } return $eu; } function e2s_post_service ($parameters){ global$_config; $ru = qq ('e2m_settings'); if($_config['allow_underhood_access']) { $ru = qq ('e2m_underhood'); } if($_SERVER['REQUEST_METHOD']!='POST'){ s1 ($ru); } if($_config['allow_underhood_access']) { if($parameters['service']==='build'){ wd (); e2_build (); hb ('Engine core built',E2E_MESSAGE); } if($parameters['service']==='sync'){ wd (); e2_drop_all_kinds_of_cache (); hb ('Caches invalidated',E2E_MESSAGE); } if($parameters['service']==='checklist-reset'){ wd (); es (); hb ('Checklist reset',E2E_MESSAGE); } if($parameters['service']==='log'){ wd (); an (); hb ('Logs enabled',E2E_MESSAGE); } if($parameters['service']==='unlog'){ wd (); o1 (INSTANCE_DIR . LOGS_DIRNAME . '*'); hb ('All logs deleted',E2E_MESSAGE); } if($parameters['service']==='migrate'){ wd (); jn (iq ()); hb ('Database structure up to date',E2E_MESSAGE); } } if($parameters['service']==='backup'){ } s1 ($ru); } define ('PROVIDE_MEDIA_ASYNC',10); define ('PROVIDE_MEDIA_NOW',20); function d2 ($tu){ global$_config; $ju = parse_url ($tu); if (isset ($ju['host'])) { $url = $tu; if ($ju['host']=='www.youtube.com'){ $zy = basename ($ju['path']); $hu = 'remote/youtube-'. $zy .'-cover.jpg'; return [ 'url' => $url, 'type' => 'online-video', 'is-local?' => false, 'is-usable-as-cover?' => true, 'is-using-thumbnails?' => true, 'is-generating-thumbnail?' => true, 'is-snippetable?' => true, 'is-rss-enclosure?' => false, 'video-service' => 'youtube', 'video-id' => $zy, 'local-cover-href' => AeEnv::$base_url . PICTURES_DIRNAME . $hu, 'local-relative-filename' => $hu, 'local-full-filename' => $_config['path_media'].PICTURES_DIRNAME . $hu, 'local-full-failname' => $_config['path_media'].PICTURES_DIRNAME . $hu . '.failed', ]; } elseif ($ju['host']=='player.vimeo.com'){ $zy = basename ($ju['path']); $hu = 'remote/vimeo-'. $zy .'-cover.jpg'; return [ 'url' => $url, 'type' => 'online-video', 'is-local?' => false, 'is-usable-as-cover?' => true, 'is-using-thumbnails?' => true, 'is-generating-thumbnail?' => true, 'is-snippetable?' => true, 'is-rss-enclosure?' => false, 'video-service' => 'vimeo', 'video-id' => $zy, 'local-cover-href' => AeEnv::$base_url . PICTURES_DIRNAME . $hu, 'local-relative-filename' => $hu, 'local-full-filename' => $_config['path_media'].PICTURES_DIRNAME . $hu, 'local-full-failname' => $_config['path_media'].PICTURES_DIRNAME . $hu . '.failed', ]; } elseif (i2 ($ju['path'])) { return [ 'url' => $url, 'type' => 'remote-image', 'is-local?' => false, 'is-usable-as-cover?' => false, 'is-using-thumbnails?' => false, 'is-generating-thumbnail?' => false, 'is-snippetable?' => false, 'is-rss-enclosure?' => false, 'mime-type' => nd ($ju['path']), 'length' => '', ]; } else { return [ 'url' => $url, 'type' => 'remote-non-image', 'is-local?' => false, 'is-usable-as-cover?' => false, 'is-using-thumbnails?' => false, 'is-generating-thumbnail?' => false, 'is-snippetable?' => false, 'is-rss-enclosure?' => true, 'mime-type' => nd ($ju['path']), 'length' => '', ]; } } else { if (i2 ($ju['path'])) { $url = AeEnv::$base_url . PICTURES_DIRNAME . $ju['path']; $gu = $_config['path_media'].PICTURES_DIRNAME . $ju['path']; return [ 'url' => $url, 'type' => 'local-image', 'is-local?' => true, 'is-usable-as-cover?' => true, 'is-using-thumbnails?' => true, 'is-generating-thumbnail?' => o2 ($ju['path']), 'is-snippetable?' => true, 'is-rss-enclosure?' => false, 'mime-type' => nd ($ju['path']), 'length' => @stat ($gu)['size'], 'local-href' => $url, 'local-cover-href' => $url, 'local-relative-filename' => $ju['path'], 'local-full-filename' => $gu, 'thumb-full-filename' => $gu, ]; } elseif (cd ($ju['path'])) { $url = AeEnv::$base_url . VIDEO_DIRNAME . $ju['path']; $gu = $_config['path_media'].VIDEO_DIRNAME . $ju['path']; return [ 'url' => $url, 'type' => 'local-video', 'is-local?' => true, 'is-usable-as-cover?' => false, 'is-using-thumbnails?' => true, 'is-generating-thumbnail?' => false, 'is-snippetable?' => false, 'is-rss-enclosure?' => true, 'mime-type' => nd ($ju['path']), 'length' => @stat ($gu)['size'], 'local-href' => $url, 'local-relative-filename' => $ju['path'], 'local-full-filename' => $gu, 'thumb-full-filename' => SYSTEM_THEME_DIR . VIDEO_ICON_FILENAME, ]; } else { $url = AeEnv::$base_url . AUDIO_DIRNAME . $ju['path']; $gu = $_config['path_media'].AUDIO_DIRNAME . $ju['path']; return [ 'url' => $url, 'type' => 'local-non-image', 'is-local?' => true, 'is-usable-as-cover?' => false, 'is-using-thumbnails?' => true, 'is-generating-thumbnail?' => false, 'is-snippetable?' => false, 'is-rss-enclosure?' => true, 'mime-type' => nd ($ju['path']), 'length' => @stat ($gu)['size'], 'local-href' => $url, 'local-full-filename' => $gu, 'thumb-full-filename' => SYSTEM_THEME_DIR . AUDIO_ICON_FILENAME, ]; } } } function s2 ($m4){ $wu = []; foreach ($m4 as $tu){ $s8 = d2 ($tu); if ($s8['is-local?'])$wu[] = $tu; } return $wu; } function a2 ($m4){ $wu = []; foreach ($m4 as $tu){ $s8 = d2 ($tu); if ($s8['is-snippetable?'])$wu[] = $tu; } return $wu; } function q2 ( $ib,$pb ){ if (!is_array ($ib))$ib = []; if (!is_array ($pb))$pb = []; $m4 = array_merge ($pb,$ib); $m4 = array_reverse ($m4); $m4 = array_unique ($m4); $m4 = array_reverse ($m4); return $m4; } function l2 ($m4){ if (!is_array ($m4) or !count ($m4)) return []; j2 ($m4); $uu = []; foreach ($m4 as $tu){ if (!empty ($iu[$tu])) continue; $s8 = d2 ($tu); if (!$s8['is-usable-as-cover?']) continue; if (!is_file ($s8['local-full-filename'])) continue; $size = e2_getimagesize ($s8['local-full-filename']); list ($vz,$bz,$o6,$p6)=$size; $uu[] = [ 'src' => $s8['local-cover-href'], 'width' => $vz, 'height' => $bz, 'horizontality' => $o6, 'verticality' => $p6, ]; $iu[$tu]=true; } return $uu; } function z2 ($m4){ global$_strings; if (!is_array ($m4) or !count ($m4)) return []; j2 ($m4); $ou = []; foreach ($m4 as $tu){ if (!empty ($iu[$tu])) continue; $s8 = d2 ($tu); if (!$s8['is-using-thumbnails?']) continue; if (!is_file ($s8['local-full-filename'])) continue; $pu = [ 'is-available?' => true, 'src' => '', 'width' => '', 'height' => '', 'original-filename' => '', 'original-filesize' => '', ]; if (!$s8['is-local?'] or is_file ($s8['local-full-filename'])) { if ($s8['is-generating-thumbnail?']) { $c0 = h2 ( $s8 ); } else { $c0 = $s8['thumb-full-filename']; } } if (empty ($c0)) { $pu['is-available?']=false; $c0 = g2 ( $s8['local-relative-filename'] ); } $pu['src']=o3 ($c0); if ($pu['is-available?']) { $size = e2_getimagesize ($c0); list ($vz,$bz)=$size; } else { $vz = $bz = ''; } if (!$vz)$vz = THUMB_WIDTH/2; if (!$bz)$bz = THUMB_HEIGHT/2; list ($vz,$bz)=e2_fit_metrics_to_constraints ( [$vz,$bz], [THUMB_WIDTH/2,THUMB_HEIGHT/2] ); $pu['width']=$vz; $pu['height']=$bz; if ($s8['is-local?']) { $pu['original-filename']=$tu; if(is_file ($s8['local-full-filename'])) { $p4 = stat ($s8['local-full-filename'])[7]; $p4 = round ($p4 / 1024) .' '. $_strings['gs--kb']; $pu['original-filesize']=$p4; } } $ou[] = $pu; $iu[$tu]=true; } return $ou; } function k2 ($v0){ foreach ( ['maxresdefault','hqdefault','mqdefault','sddefault','default'] as $wd ) { $url = 'http://img.youtube.com/vi/'. $v0 .'/'. $wd .'.jpg'; if(Log::$a)__log ('Trying '. $url .'...'); $b0 = @file_get_contents ($url); if ($b0 !== false) return $b0; } return false; } function x2 ($y0){ $n0 = @unserialize ( file_get_contents ('http://vimeo.com/api/v2/video/'. $y0 .'.php') ); if (!empty ($n0[0]['thumbnail_large'])) { return @file_get_contents ($n0[0]['thumbnail_large']); } return false; } function e2_ ($s8,$m0){ if(is_file ($s8['local-full-filename'])) { if(Log::$a)__log ('Already exists: '. $s8['local-full-filename']); } elseif(is_file ($s8['local-full-failname'])) { if(Log::$a)__log ('Already tried and failed: '. $s8['local-full-filename']); } else { if(Log::$a)__log ('Resource '. $s8['url'].' is missing a cover, retrieving'); if ($m0 == PROVIDE_MEDIA_ASYNC){ vv (qq ('e2s_retrieve', [ 'url' => strtr (base64_encode ($s8['url']), '+/','-_'), ])); } if ($m0 == PROVIDE_MEDIA_NOW){ if(Log::$a)__log ('Downloading "'. $s8['video-service'] .'" cover as '. $s8['local-full-filename'] .'...'); if ($s8['video-service']=='youtube'){ $b0 = k2 ($s8['video-id']); } if ($s8['video-service']=='vimeo') { $b0 = x2 ($s8['video-id']); } if ($b0 !== false){ e3 ($s8['local-full-filename'],$b0); } else { e3 ($s8['local-full-failname'],''); } } } } function r2 ($tu,$m0){ $s8 = d2 ($tu); if(Log::$a)__log ('Resource '. $tu .' is of type '. $s8['type']); if ($s8['type']=='local-image'){ h2 ($s8); } if ($s8['type']=='online-video'){ e2_ ($s8,$m0); if ($m0 == PROVIDE_MEDIA_NOW and is_file ($s8['local-full-filename'])) { h2 ($s8); } } if ($s8['type']=='remote-image'){ } } function t2 ($m4){ foreach ($m4 as $tu){ $s8 = d2 ($tu); if (empty ($s8['local-full-failname'])) continue; if(is_file ($s8['local-full-failname'])) { if(Log::$a)__log ('Deleting '. $s8['local-full-failname'] .' to try again'); unlink ($s8['local-full-failname']); } } } function j2 ($m4){ if (!is_array ($m4)) return; if(Log::$a)__log ('Asynchronously provide data for resnames {'); foreach ($m4 as $tu){ r2 ($tu,PROVIDE_MEDIA_ASYNC); } if(Log::$a)__log ('}'); } function h2 ($s8){ if (!$s8['is-generating-thumbnail?']) return false; return e2img_filename_by_processing ( $s8['local-full-filename'], g2 ($s8['local-relative-filename']), [THUMB_WIDTH,THUMB_HEIGHT], CROP_NONE, THUMB_JPG_QUALITY ); } function g2 ($f0){ global$_config; return bd ( $_config['path_media'].THUMBNAILS_DIRNAME . $f0, 'thumb@2x' ); } function u2 ($tu){ $s0 = pathinfo ($tu); $w4 = @$s0['extension']; return (in_array (strtolower ($w4), ['jpg','jpeg'])); } function i2 ($tu){ $s0 = pathinfo ($tu); $w4 = (string) @$s0['extension']; return (in_array (strtolower ($w4), ['jpg','jpeg','gif','png','webp','svg'])); } function o2 ($tu){ $s0 = pathinfo ($tu); $w4 = (string) @$s0['extension']; return (in_array (strtolower ($w4), ['jpg','jpeg','gif','png','webp'])); } function p2 ($tu){ $s0 = pathinfo ($tu); $w4 = (string) @$s0['extension']; return (in_array (strtolower ($w4), ['svg'])); } function cd ($tu){ $s0 = pathinfo ($tu); $w4 = (string) @$s0['extension']; return (in_array (strtolower ($w4), ['mp4','mov'])); } function vd ($tu){ $s0 = pathinfo ($tu); $w4 = (string) @$s0['extension']; return (in_array (strtolower ($w4), ['mp3'])); } function bd ($tu,$a0){ if (!empty ($a0)) { $q0 = explode ('/',$tu); $hd = array_pop ($q0); $l0 = explode ('.',$hd); if(count ($l0)<2)$l0[] = ''; $w4 = array_pop ($l0); $l0[] = $a0; if ($w4)$l0[] = $w4; $hd = implode ('.',$l0); $q0[] = $hd; $tu = implode ('/',$q0); } return $tu; } function yd ($w,$hd){ if (!is_file ($w . $hd)) return $hd; $z0 = strrpos ($hd,'.'); $k0 = substr ($hd,0,$z0); $w4 = substr ($hd,$z0); $rb = 0; while (is_file ($w . $k0 .'-'. (++ $rb).$w4)); $hd = $k0 .'-'. $rb . $w4; return $hd; } function nd ($tu){ $s0 = pathinfo ($tu); $w4 = @$s0['extension']; if ($w4 == 'png') return 'image/png'; if ($w4 == 'webp') return 'image/webp'; if ($w4 == 'gif') return 'image/gif'; if ($w4 == 'jpg' or $w4 == 'jpeg') return 'image/jpeg'; if ($w4 == 'mp3') return 'audio/mpeg'; if ($w4 == 'svg') return 'image/svg+xml'; if ($w4 == 'mp4') return 'video/mp4'; if ($w4 == 'mov') return 'video/quicktime'; } function md ($x0,$e0){ return strcasecmp ($x0,$e0)===0; } define ('SEARCH_EXTRA_PREFIX','Rose'); define ('SEARCH_LIMIT',20); define ('SEARCH_SNIPPETS_LIMIT',20); define ('SEARCH_USE_ROSE',1); define ('SEARCH_USE_MYSQL',1); define ('BSI_SELECT_PORTION',10); define ('BSI_GIVE_UP_TIMEOUT',10); define ('BSI_UNLOCK_TIMEOUT',10); use S2\Rose\Storage\Exception\EmptyIndexException; use S2\Rose\Storage\Database\PdoStorage; use S2\Rose\Storage\Database\MysqlRepository; use S2\Rose\Stemmer\PorterStemmerEnglish; use S2\Rose\Stemmer\PorterStemmerRussian; use S2\Rose\Indexer; use S2\Rose\Entity\Indexable; use S2\Rose\Entity\Query; use S2\Rose\Entity\ExternalContent; use S2\Rose\Finder; use S2\Rose\SnippetBuilder; function e2m_found ($parameters = array ()) { global$_strings,$_config; $parameters['query']=trim ($parameters['query']); $z2 = $parameters['query']; if (!$z2){ return array ( 'title' => $_strings['pt--search-query-empty'], 'heading' => $_strings['pt--search'], 'nothing' => $_strings['gs--search-query-empty'], ); } $r0 = false; $t0 = []; try { if (cs ()) { $j0 = ''; } else { $j0 = 'AND `IsVisible` = 1 '; } mm ( "SELECT * FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". $j0 . "AND `Keyword`='". sm ($z2) ."'", 'get tags matching the search query' ); $zb = dm (); if (isset ($zb[0]['ID'])) { $r0 = [ 'href' => qq ('e2m_tag', array ('*tag' => $zb[0])), 'name' => htmlspecialchars ($z2,ENT_NOQUOTES,'UTF-8'), 'visible?' => (bool)$zb[0]['IsVisible'], ]; $t0 = ba ($zb[0]['ID'],4); array_unshift ($t0,$r0); } } catch (AeMySQLException $e){ v3 ($e,'Could not get tags matching the search query'); } $h0 = z1 (' ',$parameters['query']); if(SEARCH_USE_ROSE){ $g0 = new PorterStemmerRussian (new PorterStemmerEnglish ()); foreach ($h0 as $s3 => $a3){ $h0[$s3]=$g0 -> stemWord ($h0[$s3]); } } $w0 = array (); $tn = cs (); if(SEARCH_USE_ROSE){ try { $ar = ed (iq ()); $u0 = new Finder ($ar,$g0); $u0 -> setHighlightTemplate ('<mark>%s</mark>'); $i0 = new Query ($z2); $i0 -> setInstanceId ($_config['db_table_subset']); $i0 -> setLimit (SEARCH_LIMIT); $resultSet = $u0 -> find ($i0); foreach($resultSet -> getFoundExternalIds () as $o0){ $p0 = $o0 -> getId (); if ($p0[0]=='n'){ $note_id = substr ($p0,1); $ay = jm ($note_id); if (!empty ($_config['search_favourites_boost'])) { if ($ay['IsFavourite']) { $resultSet->setRelevanceRatio ( $p0, $_config['search_favourites_boost'] ); } } } } $snippetBuilder = new SnippetBuilder ($g0); $snippetBuilder -> setSnippetLineSeparator(' · '); $snippetBuilder -> attachSnippets ( $resultSet, static function (array $v9) use ($tn,$_config){ $x3 = new ExternalContent (); foreach ( array_slice ($v9,0,SEARCH_SNIPPETS_LIMIT) as $o0 ) { $p0 = $o0 -> getId (); if ($p0[0]=='n'){ $note_id = substr ($p0,1); $ay = jm ($note_id); if ($ay){ $noteView = new AeNoteView ($ay); $noteView -> setWantReadHref ($_config['count_reads']); $noteView -> setWantControls ($tn and !@$_config['read_only']); $noteView -> setWantHiddenTags ($tn); $j3 = $noteView -> getNoteCTree (); $b9[$ay['ID']] = $j3; $x3 -> attach ($o0,$j3['text']); } } } return $x3; } ); foreach($resultSet -> getItems () as $y9){ $n9 = $y9 -> getId (); if ($n9[0]=='n'){ $note_id = substr ($n9,1); $ay = jm ($note_id); if (!( yf ($ay)==='public' or ($tn and $ay['IsPublished']) )) continue; $ay['_']['_srprovider']='Rose'; $ay['_']['_rose_relevance']=$y9 -> getRelevance (); $ay['_']['_rose_title']=$y9 -> getHighlightedTitle ($g0); $ay['_']['_rose_snippet']=$y9 -> getSnippet (); $w0[] = $ay; } } $m9 = false; if (@$_config['dev_rose_info']) { $m9 = print_r ($resultSet -> getTrace (), true); } } catch (EmptyIndexException $e){ jd (iq ()); sd (USER_DIR); } catch (AeMySQLException $e){ v3 ($e,'Could not do something with the database while working on Rose search results'); } } if(SEARCH_USE_MYSQL){ $f9 = sm (preg_quote ($z2)); $d9 = 'MySQL FT'; $s9 = ( "SELECT * FROM `". $_config['db_table_prefix']."Notes` n ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished`=1 AND (". "MATCH (`Title`, `Text`) AGAINST ('". $f9 ."')". ") ". nf ($tn). "LIMIT ". SEARCH_LIMIT ); try { mm ( $s9, 'search using MySQL fulltext search' ); $x3 = dm (); foreach ($x3 as $s3 => $ay){ $ay['_']['_srprovider']=$d9; $w0[] = $ay; } } catch (AeMySQLException $e){ v3 ($e,'Could not search using MySQL fulltext search'); } } $a9 = array (); $xn = array (); $rb = 0; foreach ($w0 as $ay){ if (!in_array ($ay['ID'],$a9)) { if (!empty ($b9[$ay['ID']])) { $r = $b9[$ay['ID']]; } else { $noteView = new AeNoteView ($ay); $noteView -> setWantReadHref ($_config['count_reads']); $noteView -> setWantControls ($tn and !@$_config['read_only']); $r = $noteView -> getNoteCTree (); } $r['search-result-provider']=$ay['_']['_srprovider']; if ($ay['_']['_srprovider']=='Rose'){ $r['search-rose'] = [ 'relevance' => $ay['_']['_rose_relevance'], 'title' => $ay['_']['_rose_title'], 'snippet' => $ay['_']['_rose_snippet'], ]; } if (@$ay['_']['_rose_title']) { $r['title']=$ay['_']['_rose_title']; } else { $r['title']=rd ($r['title'],$h0); } $r['title']=dy ($r['title']); if (!empty ($ay['_']['_rose_snippet'])) { $r['snippet-text']=$ay['_']['_rose_snippet']; } else { $l1 = $r['text']; $l1 = preg_replace ('/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/i','',$l1); $l1 = preg_replace ('/<style\b[^<]*(?:(?!<\/style>)<[^<]*)*<\/style>/i','',$l1); $l1 = str_replace ( array ( '<br>', '<br/>', '<br />', '</h1>', '</h2>', '</h3>', '</h4>', '</h5>', '</h6>', '</p>', '</pre>', '</blockquote>', '</li>', ), ' ', $l1 ); $l1 = strip_tags ($l1); $q9 = array (); $l9 = preg_split ('/[\\n\(\)\[\]]|[.:;?!](\s|$)/uis',$l1); $z9 = 0; $k9 = ''; foreach ($l9 as $x9){ $x9 = trim ($x9); if (!$x9) continue; if (!$k9)$k9 = $x9; $e9 = $x9; $e9 = rd ($e9,$h0); if ($e9 != $x9){ $q9[] = td ($e9); $z9 ++; if ($z9 > 3) break; } } if(count ($q9)) { $r['snippet-text']=implode (' · ',$q9); } else { $r['snippet-text']=$k9; } } $r['has-highlighed-thumbs?']=false; if ($ib = @$r['format-info']['resources-detected']) { $r9 = z2 ( a2 ($ib) ); foreach ($r9 as $s3 => $a3){ $r9[$s3]['highlighted?'] = ( strstr ($a3['original-filename'],$z2)!==false ); if ($r9[$s3]['highlighted?']) { $r['has-highlighted-thumbs?']=true; } } $r['thumbs']=$r9; } $xn[] = $r; $a9[] = $ay['ID']; $rb ++; if ($rb >= SEARCH_LIMIT) break; } } $t2 = count ($xn); if ($t2){ $t9 = e2l_get_string ( 'pt--n-posts', array ('number' => $t2) ); } else { $t9 = $_strings['pt--no-posts']; $cb['nothing']=$_strings['gs--nothing-found']; } if ($rb >= SEARCH_LIMIT){ $t9 = $_strings['gs--many-posts']; } if ($t0){ $cb['search-related-tags']=$t0; } $cb['notes']=$xn; $cb['pages'] = array (); $cb['title']=$t9 .' '. $_strings['gs--found-for-query'] .': '. htmlspecialchars ($z2,ENT_NOQUOTES,'UTF-8'); $cb['heading']=$z2; if (@$m9){ $cb['rose-debug-info']=$m9; } return $cb; } function fd ($parameters){ if(Log::$a)__log ('Search form'); $z2 = trim ((string) @$parameters['query']); return [ 'form-action' => qq ('e2s_search'), 'query' => htmlspecialchars ($z2,ENT_COMPAT,'UTF-8'), ]; } function e2s_search () { $z2 = @$_POST['query']; $z2 = str_replace ('?',urlencode ('?'),$z2); $z2 = str_replace ('/',' ',$z2); $z2 = trim ($z2); $z2 = str_replace (' ','+',$z2); s1 (qq ('e2m_found', array ('query' => $z2))); } function dd () { global$_config; mm ( "SELECT COUNT(*) c FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsPublished` = 1 ", 'count total published notes' ); $l6 = dm (); $j9 = $l6[0]['c']; mm ( "SELECT COUNT(*) c FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsIndexed` = 1 AND `IsPublished` = 1 ", 'count indexed published notes' ); $l6 = dm (); $h9 = $l6[0]['c']; $g9 = true; foreach (xd () as $u5){ if (!pn ( iq (), SEARCH_EXTRA_PREFIX . $u5 )) { $g9 = false; break; } } $w9 = ad (USER_DIR); if (!$g9){ $h9 = 0; $w9['spent']=false; } $u9 = $j9 - $h9; return [ 'indexed_count' => $h9, 'total_count' => $j9, 'remaining_count' => $u9, 'time_spent' => @$w9['spent']? $w9['spent']:false, ]; } function e2s_bsi_step () { global$_config; $w9 = ad (USER_DIR); ignore_user_abort (true); echo '<pre>'; if($_config['log_bsi']) { Log::$a = true; if(Log::$a)dn ('bsi'); } if(Log::$a)__log ('BSI step'); if ( !isset ($w9['lock']) or $w9['lock']<time () - (BSI_GIVE_UP_TIMEOUT + BSI_UNLOCK_TIMEOUT) ) { if (isset ($w9['lock'])) { if(Log::$a)__log ('Indexer: old lock is '. $w9['lock']); echo 'Old lock is '. $w9['lock'] .'<br />'; } else { echo 'No old lock<br />'; } $w9['lock']=time (); if (!@e3 (USER_DIR . 'bsi.psa',serialize ($w9))) { if(Log::$a)__log ('Indexer: can’t get a new lock'); die ('Can’t get a new lock<br />'); } if(Log::$a)__log ('Indexer: new lock is '. $w9['lock']); echo 'New lock is '. $w9['lock'] .'<br /><br />'; try { $rb = 0; $i9 = 0; $o9 = yq (); $p9 = false; $ci = false; while ($i9 < BSI_GIVE_UP_TIMEOUT){ mm ( "SELECT * FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsIndexed`=0 AND `IsPublished`=1 ". "ORDER BY `Stamp` DESC ". "LIMIT ". BSI_SELECT_PORTION, 'get portion of unindexed notes for indexing' ); $l6 = dm (); if(count ($l6)) { ++ $rb; if(Log::$a)__log ('Indexer: portion '. $rb); echo 'Portion '. $rb .'<br />'; foreach ($l6 as $s){ if(Log::$a)__log ('Indexer: indexing "'. $s['Title'].'"'); echo 'Indexing: '. $s['Title'] .'<br />'; if (ld ($s)) { $s['IsIndexed']='1'; ym (iq (), 'Notes',$s); } else { $ci = true; break 2; } if($_config['broadcast_on_indexing']) { wv ($s); } } $i9 = round (yq () - $o9,3); if(Log::$a)__log ('Indexer: steps done '. count ($l6) .', spent '. $i9 .' ms so far'); echo 'Steps done '. count ($l6) .', spent '. $i9 .' ms so far<br /><br />'; } else { $p9 = true; break; } } if ($p9){ if(Log::$a)__log ('Indexer: indexing complete'); echo 'Indexing complete<br /><br />'; if(CACHE_INDEXED_FLAG){ @e3 (USER_DIR . CACHE_FILENAME_INDEXED_FLAG,''); } } elseif ($ci){ if(Log::$a)__log ('Indexer: indexing failed'); echo 'Indexing failed<br /><br />'; } else { if(Log::$a)__log ('Indexer: time out'); echo 'Time out<br />'; unset ($w9['lock']); } if ($w9['spent']!=='?')$w9['spent']+=$i9; @e3 (USER_DIR . 'bsi.psa',serialize ($w9)); } catch (AeMySQLException $e){ v3 ($e,'Could not index notes'); if(Log::$a)__log ('Indexer: DB unaccessible'); echo 'DB unaccessible<br />'; } } else { if(Log::$a)__log ('Indexer: locked'); echo 'Locked<br />'; } die ('</pre>'); } function e2s_reindex () { global$_config; if (!$_config['allow_underhood_access']) { s1 (qq ('e2m_settings')); } if($_SERVER['REQUEST_METHOD']=='POST'){ wd (); @unlink (USER_DIR . CACHE_FILENAME_INDEXED_FLAG); jd (iq (), true); sd (USER_DIR); } s1 (qq ('e2m_underhood')); } function sd ($cy){ $w9 = ['spent' => 0]; @e3 ($cy . 'bsi.psa',serialize ($w9)); return $w9; } function ad ($cy){ $w9 = @unserialize (file_get_contents (USER_DIR . 'bsi.psa')); if (!is_array ($w9)) { $w9 = sd ($cy); } return $w9; } function qd () { if(CACHE_INDEXED_FLAG and is_file (USER_DIR . CACHE_FILENAME_INDEXED_FLAG)) { return true; } $vi = dd (); $vj = ($vi['remaining_count']===0); if(CACHE_INDEXED_FLAG and $vj){ e3 (USER_DIR . CACHE_FILENAME_INDEXED_FLAG,''); } return $vj; } function ld ($ay){ static $bi = null; if(Log::$a)__log ('Indexer: index noterec'); $databaseConfiguration = iq (); try { if ($bi === null){ $g0 = new PorterStemmerRussian (new PorterStemmerEnglish ()); $bi = new Indexer (ed ($databaseConfiguration),$g0); } $sd = ay ($ay['FormatterID'], @$ay['Text'],'full-rss'); r3 ( 'note',$ay, $sd['meta']['resources-detected'] ); $l1 = strip_tags ($sd['text-final']); $yi = new Indexable ( 'n'. $ay['ID'], $ay['Title'], $l1, $databaseConfiguration -> getSubset () ); $bi -> index ($yi); return true; } catch (EmptyIndexException $e){ jd (iq ()); sd (USER_DIR); } catch (\Exception $e){ v3 ($e,'Could not index note'); return false; } } function zd ($zy){ global$_config; static $bi = null; $databaseConfiguration = iq (); try { if ($bi === null){ $g0 = new PorterStemmerRussian (new PorterStemmerEnglish ()); $bi = new Indexer (ed ($databaseConfiguration),$g0); } return $bi -> removeById ('n'. $zy,$_config['db_table_subset']); } catch (EmptyIndexException $e){ jd ($databaseConfiguration); sd (USER_DIR); } catch (\Exception $e){ v3 ($e,'Could not unindex note'); return false; } } function kd ($ni){ $prefix = 'S2\\Rose\\'; if(BUILT){ $mi = __DIR__ . '/library/rose/'; } else { $mi = __DIR__ . '/../library/rose/'; } $nz = strlen ($prefix); if(strncmp ($prefix,$ni,$nz)!==0) return; $fi = substr ($ni,$nz); $m2 = $mi . str_replace ('\\','/',$fi).'.php'; if(file_exists ($m2)) require $m2; } function xd () { return array ( 'TOC' => 'Contents', 'WORD' => 'Word', 'FULLTEXT_INDEX' => 'Fulltext', 'KEYWORD_INDEX' => 'Keyword', 'KEYWORD_MULTIPLE_INDEX' => 'KeywordMultiple', ); } function ed (AeDatabaseConfiguration $databaseConfiguration){ static $di = null; if ($di === null and SEARCH_USE_ROSE){ $si = new \PDO ( 'mysql:'. 'host='. $databaseConfiguration->host .';'. 'dbname='. $databaseConfiguration->name.';'. 'port='. $databaseConfiguration->port, $databaseConfiguration->user, qs ($databaseConfiguration->password) ); $si -> exec ('SET NAMES utf8mb4'); $si -> setAttribute (\PDO::ATTR_ERRMODE, \PDO::ERRMODE_EXCEPTION); $ai = xd (); $di = new PdoStorage ( $si, $databaseConfiguration -> getPrefix () . SEARCH_EXTRA_PREFIX, [ MysqlRepository::TOC => $ai['TOC'], MysqlRepository::WORD => $ai['WORD'], MysqlRepository::FULLTEXT_INDEX => $ai['FULLTEXT_INDEX'], MysqlRepository::KEYWORD_INDEX => $ai['KEYWORD_INDEX'], MysqlRepository::KEYWORD_MULTIPLE_INDEX => $ai['KEYWORD_MULTIPLE_INDEX'], ] ); } return $di; } function rd ($l1,$h0){ foreach ($h0 as $uj){ if ($uj == '-') continue; $uj = preg_quote ($uj,'/'); $uj = str_replace ('е','[её]',$uj); $uj = str_replace ('Е','[ЕЁ]',$uj); $l1 = preg_replace ('/(?<=^|\W)('.$uj.'[\w\p{M}]*)/iu','<mark>$1</mark>',$l1); } $l1 = str_replace ('</mark> <mark>',' ',$l1); $l1 = str_replace ('</mark> <mark>',' ',$l1); return $l1; } function td ($qi){ $li = mb_strtoupper (mb_substr ($qi,0,1)); return $li . mb_substr ($qi,1); } function jd (AeDatabaseConfiguration $databaseConfiguration,$zi = false){ $ki = false; if($databaseConfiguration -> hasSubsetSpecified () and !$ki){ if(Log::$a)__log ('Search: unmark and unindex subset'); $c1 = "WHERE `SubsetID`=". $databaseConfiguration -> getSubset (); } else { if(Log::$a)__log ('Search: unmark and unindex all'); $c1 = ''; } mm ( "UPDATE `". $databaseConfiguration -> getPrefix () . "Notes` ". "SET `IsIndexed`=0 ". $c1, 'mark all notes for reindexing' ); if ($zi)hb ('Notes marked for reindexing',E2E_MESSAGE); $ar = ed ($databaseConfiguration); try { $ar -> erase (); if ($zi)hb ('Indexes erased',E2E_MESSAGE); } catch (\S2\Rose\Exception\RuntimeException $e){ if(Log::$a)__log ('Rose threw RuntimeException'); } } function e2m_password_reset () { global$_strings,$_config,$settings; if (!is_file (USER_DIR. 'password-reset.psa')) { $cn = sha1 (fs ()); $url = qq ('e2m_password', array ('recovery-key' => $cn)); @e3 (USER_DIR. 'password-reset.psa',$url); } $cb['title']=$_strings['pt--password-reset']; $cb['heading']=$_strings['pt--password-reset']; $xi = (bool) ($ma = $settings['author_email']); $cb['form']='form-password-reset-email'; $cb['form-password-reset-email'] = array ( 'form-action' => qq ('e2s_password_reset_email'), 'show-controls?' => $xi, 'submit-text' => $_strings['fb--send-link-by-email'], ); if($_config['user_has_access_to_filesystem']) { $cb['form-password-reset-email']['reset-info']=$_strings['gs--password-reset-link-saved']; } elseif (!$xi){ hb ($_strings['er--cannot-reset-password']); } return $cb; } function e2s_password_reset_email () { global$_strings,$settings; if($_SERVER['REQUEST_METHOD']!='POST')s1 (); if(array_key_exists ('email',$_POST))$es = trim ($_POST['email']); if (!$es){ hb ($_strings['er--cannot-send-link-email-empty']); s1 (qq ('e2m_password_reset')); } $ei = @file_get_contents (USER_DIR. 'password-reset.psa'); if(strlen ($ei)==0){ hb ($_strings['er--error-occurred']); s1 (qq ('e2m_password_reset')); } if ($ma = $settings['author_email']) { if ($es == $ma){ $ya = qn ( 'password-reset', array ('reset-href' => $ei) ); $na = $_strings['em--password-reset-subject']; $fa = 'From: '. ln (); zn ($ma,$na,$ya,$fa); } hb ($_strings['gs--password-reset-link-sent-maybe'],E2E_MESSAGE); s1 (qq ('e2m_password_reset')); } die; } function e2m_password ($parameters){ global$_strings; $ri = false; $cn = ''; if(array_key_exists ('recovery-key',$parameters)) { $cn = $parameters['recovery-key']; $url = qq ('e2m_password', array ('recovery-key' => $cn)); $ei = @file_get_contents (USER_DIR. 'password-reset.psa'); if(strlen ($ei)>0){ $ri = ($url == $ei); } } if (cs () or $ri){ $cb['title']=$_strings['pt--password']; $cb['heading']=$_strings['pt--password-for-blog']; if ($ri){ $cb['title']=$_strings['pt--password-reset']; $cb['heading']=$_strings['pt--password-reset']; } $cb['form']='form-password'; $cb['form-password'] = array ( '.recovery-key' => $cn, 'form-action' => qq ('e2s_password_save'), 'recovering?' => $ri, 'submit-text' => $_strings['fb--change'], ); return $cb; } else { s1 (); } } function e2m_sessions () { global$_strings; $zr = vs (); $cb['title']=$_strings['pt--sessions']; $cb['heading']=$_strings['pt--sessions']; $ti = array (); $cn = $_COOKIE[q1 ('key')]; foreach ($zr['sessions'] as $s3 => $a3){ $ti[] = array ( 'current?' => sha1 ($cn)===$a3['key_hash'], 'opened' => array ((int)$a3['stamp'],ga ()), 'ip-address' => $a3['remote_ip'], 'source' => ($a3['remote_ip']=='127.0.0.1')? $_strings['gs--locally']:$a3['remote_ip'], 'title' => ms ($a3['ua']), 'user-agent' => $a3['ua']? $a3['ua']:$_strings['gs--unknown'], ); } $ti = array_reverse ($ti); $cb['sessions']['each']=$ti; if(count ($ti)>1){ $cb['form']='form-sessions'; $cb['form-sessions'] = array ( 'form-action' => qq ('e2s_drop_other_sessions'), 'submit-text' => $_strings['fb--end-all-sessions-but-this'], ); } return $cb; } function e2m_sign_in () { global$_strings; if (cs ())s1 (qq ('e2m_frontpage', array ('page' => 1))); return [ 'title' => $_strings['pt--sign-in'], ]; } function e2m_sign_out () { global$_strings; $zr = vs (); $ji = -1; if(array_key_exists ('sessions',$zr) and is_array ($zr['sessions'])) { foreach ($zr['sessions'] as $s3 => $a3){ $cn = $_COOKIE[q1 ('key')]; if(sha1 ($cn)===$a3['key_hash']) { $ji = $s3; break; } } } if ($ji > -1) unset ($zr['sessions'][$ji]); if (!bs ($zr)) { hb ($_strings['er--cannot-write-auth-data'],E2E_PERMISSIONS_ERROR); } l1 ('key',''); s1 (); } function e2s_password_save () { global$_strings; wd (); $ri = false; $hi = trim ($_POST['old-password']); if ($cn = trim ($_POST['recovery-key'])) { $url = qq ('e2m_password', array ('recovery-key' => $cn)); $ei = @file_get_contents (USER_DIR. 'password-reset.psa'); if(strlen ($ei)>0){ $ri = ($url == $ei); } } if (id ($hi) or $ri){ $qr = trim ($_POST['new-password']); if ($qr != ''){ if (@e3 (USER_DIR. 'password-hash.psa',serialize (sha1 ($qr)))) { @unlink (USER_DIR. 'password-reset.psa'); hb ($_strings['gs--password-changed'],E2E_MESSAGE); s1 (); } else { hb ($_strings['er--could-not-change-password'],E2E_PERMISSIONS_ERROR); s1 (qq ('e2m_password', array ('recovery-key' => ''))); } } else { hb ($_strings['er--no-password-entered'],E2E_USER_ERROR); s1 (qq ('e2m_password', array ('recovery-key' => ''))); } } else { hb ($_strings['er--wrong-password'],E2E_USER_ERROR); s1 (qq ('e2m_password', array ('recovery-key' => ''))); } die; } function hd () { global$_token; if (!cs ()) return ''; return$_token; } function gd () { return sha1 ( $_SERVER['HTTP_USER_AGENT'].ud () . time () . mt_rand (1000000,9999999) ); } function wd () { global$_token; if (!cs ()) return true; if ( !array_key_exists ('token',$_POST) or ((string)$_POST['token'] !== (string) @$_token) ) { throw new AeTokenException ('Incorrect token'); } return true; } function ud () { $gi = $_SERVER['REMOTE_ADDR']; if(array_key_exists ('HTTP_X_FORWARDED_FOR',$_SERVER)) { $gi = array_pop (explode (',',$_SERVER['HTTP_X_FORWARDED_FOR'])); } return $gi; } function e2s_sign_in () { global$_strings; $zr = vs (); if($_SERVER['REQUEST_METHOD']=='POST'){ $password = @$_POST['password']; $wi = @$_POST['is_public_pc']; } else { $password = @$_GET['password']; $wi = false; } if (id ($password)) { @unlink (USER_DIR. 'password-reset.psa'); $ui = [ 'stamp' => time (), 'remote_ip' => ud (), 'key_hash' => pd ($wi), 'anti_csrf_token' => gd (), 'ua' => $_SERVER['HTTP_USER_AGENT'], ]; $zr['sessions'][] = $ui; } elseif(strlen (trim ($password)) > 0){ ds (); hb ($_strings['er--wrong-password'],E2E_USER_ERROR); } if (!bs ($zr)) { hb ($_strings['er--cannot-write-auth-data'],E2E_PERMISSIONS_ERROR); s1 (); } a1 (); } function e2s_drop_other_sessions () { global$_strings; wd (); $zr = vs (); $ui = null; foreach ($zr['sessions'] as $s3 => $a3){ $cn = $_COOKIE[q1 ('key')]; if(sha1 ($cn)===$a3['key_hash']) { $ui = $a3; break; } } $zr['sessions'] = array ($ui); if (!bs ($zr)) { hb ($_strings['er--cannot-write-auth-data'],E2E_PERMISSIONS_ERROR); } a1 (); die; } function id ($password){ $ii = @unserialize (file_get_contents (USER_DIR. 'password-hash.psa')); return (sha1 ($password)===$ii and trim ($password)!=''); } function od () { $ii = @unserialize (file_get_contents (USER_DIR. 'password-hash.psa')); return is_string ($ii) and $ii !== ''; } function pd ($oi = false){ $cn = fs (); $pi = sha1 ($cn); l1 ('key',$cn, !$oi); return $pi; } function cs () { static $co = null; global$_token; if ($co !== null) return $co; $co = false; if (!isset ($_COOKIE[q1 ('key')])) return $co; $zr = vs (); $pi = sha1 ($_COOKIE[q1 ('key')]); $co = false; $_token = ''; foreach ($zr['sessions'] as &$ui){ if ($pi === $ui['key_hash']) { $co = true; $_token = (string) @$ui['anti_csrf_token']; if($_token === ''){ $ui['anti_csrf_token']=gd (); bs ($zr); } break; } } if (!$co)l1 ('key',''); return $co; } function vs () { $zr = []; if(is_file (USER_DIR . 'auth.psa')) { $zr = unserialize (@file_get_contents (USER_DIR . 'auth.psa')); } if (!is_array ($zr))$zr = []; if (!array_key_exists ('sessions',$zr))$zr['sessions'] = []; if (!is_array ($zr['sessions']))$zr['sessions'] = []; return $zr; } function bs ($zr){ return e3 (USER_DIR . 'auth.psa',serialize ($zr)); } function ys () { if ($cn = @$_COOKIE[q1 ('key')]) { return q1 ('key') .'='. $cn .""; } } function ns () { if ($cn = @$_COOKIE[q1 ('key')]) { return 'Cookie: '. q1 ('key') .'='. $cn ."\r\n"; } return "\r\n"; } function ms ($vo){ global$_strings; if(strstr ($vo,'iPhone')) return$_strings['gs--ua-iphone']; if(strstr ($vo,'iPad')) return$_strings['gs--ua-ipad']; if(strstr ($vo,'Opera'))$cb = $_strings['gs--ua-opera']; if(strstr ($vo,'Firefox'))$cb = $_strings['gs--ua-firefox']; if(strstr ($vo,'Chrome'))$cb = $_strings['gs--ua-chrome']; if(strstr ($vo,'Safari') and !strstr ($vo,'Chrome'))$cb = $_strings['gs--ua-safari']; if (!$cb)$cb = $_strings['gs--ua-unknown']; if(strstr ($vo,'Macintosh')) { if ($cb)$cb .= ' '. $_strings['gs--ua-for-mac']; } return $cb; } function e2j_check_password () { $ii = @unserialize (file_get_contents (USER_DIR. 'password-hash.psa')); $password = ''; if(array_key_exists ('password',$_POST))$password = $_POST['password']; ds (); $yl = [ 'success' => true, 'data' => [ 'password-correct' => trim ($password)!=='' and sha1 ($password)===$ii ], ]; $yl = json_encode ($yl); die ($yl); } function fs () { if(function_exists ('random_bytes')) { $no = sha1 (random_bytes (128)); } else { $no = ''; $mo = '0123456789abcdef'; for ($rb = 0; $rb < 40; $rb++) { $no .= $mo[mt_rand (0,15)]; } $no .= time () . microtime (); $no = sha1 ($no); } return $no; } function ds () { if(is_file (USER_DIR. 'password-wait.psa')) { $fo = unserialize ( file_get_contents (USER_DIR. 'password-wait.psa') ); if ($fo['delay']<5){ $fo['delay'] ++; } if(time () - $fo['time']>SECONDS_IN_A_MINUTE){ $fo['delay']=0; } $fo['time']=time (); } else { $fo = array ( 'time' => time (), 'delay' => 5, ); } e3 (USER_DIR . 'password-wait.psa',serialize ($fo)); sleep ($fo['delay']); } function ss () { static $do_; if(empty($do_))$do_ = md5 ('seсret'); return $do_; } function as_ ($c4){ $cn = ss (); $so = strlen ($cn); $ao = strlen ($c4); $cb = ''; for ($rb = 0; $rb < $ao + rand (16,64); ++ $rb){ if ($rb > $ao){ $qo = rand (0,127); } elseif ($rb == $ao){ $qo = 0; } else { $qo = ord ($c4[$rb]); } $lo = chr (($qo + ord ($cn[$rb%$so])) % 256); $cb .= $lo; } $cb = base64_encode ($cb); return $cb; } function qs ($c4){ $cn = ss (); $so = strlen ($cn); $c4 = base64_decode ($c4); $ao = strlen ($c4); $cb = ''; for ($rb = 0; $rb < $ao; ++ $rb){ $zo = (ord ($c4[$rb]) + 256 - ord ($cn[$rb%$so])) % 256; if ($zo === 0) break; $cb .= chr ($zo); } return $cb; } function ls () { global$settings; if (cs ()) { return null; } else { return [ 'form-action' => qq ('e2s_sign_in'), 'form-check-password-action' => qq ('e2j_check_password'), 'login-name' => @$settings['author'], 'public-pc?' => false, 'reset-href' => qq ('e2m_password_reset'), ]; } } function zs () { if (!cs ()) return; list (, $ko)=xs (); $x3 = false; foreach ($ko as $wd => $xo){ if(Log::$a)__log ( 'Selfcheck: Double-checking remote access of "'. $wd .'" '. 'before showing a warning (status was '. $xo.')...' ); $b2 = vv (AeEnv::$o . $wd); if ($b2 and $b2['http_code'] >= 400) continue; $x3 = true; $url = AeEnv::$o . $wd; hb ( 'Security alert: <a href="'. $url .'">'. $wd .'</a> '. 'responded with HTTP '. $b2['http_code'] .' instead of 403' ); } return $x3; } function ks () { list ($eo,$ko)=xs (); $ld = time (); if ( $eo === false or ( array_key_exists ('completed-stamp',$eo) and @$eo['completed-stamp']<$ld - SECONDS_IN_A_WEEK ) ) { $eo = es (); } $ro = false; if(count ($ko)) { $ro = true; } foreach ($eo['statuses'] as $wd => $xo){ if ($xo >= 400) continue; if(Log::$a)__log ('Selfcheck: Checking remote access of "'. $wd .'"...'); $b2 = vv (AeEnv::$o . $wd); if (!$b2) break; $xo = $b2['http_code']; $eo['statuses'][$wd]=$xo; if(Log::$a)__log ('Selfcheck: The response is '. $b2['http_code']); if ($xo >= 400 and !$ro){ break; } else { $ro = true; } } if (!array_key_exists ('completed-stamp',$eo)) { end ($eo['statuses']); $to = !empty (current ($eo['statuses'])); if ($to)$eo['completed-stamp']=$ld; if ($to)$eo['completed']=date ('r',$ld); } @e3 (USER_DIR . 'checklist.psa',serialize ($eo)); } function xs () { static $eo,$ko = null; if ($eo !== null and $ko !== null){ return [$eo,$ko]; } $jo = USER_DIR . 'checklist.psa'; $eo = @unserialize (file_get_contents ($jo)); $ho = @$eo['statuses']; $ko = []; if(is_array ($ho)) { foreach ($ho as $wd => $xo){ if ($xo !== null and $xo < 400){ $ko[$wd]=$xo; } } } else { $eo = false; } return [$eo,$ko]; } function es () { global$_config; if(Log::$a)__log ('Selfcheck: Reset access checklist file'); $go = array_merge ( AeFileManager::writtenFiles ($_config['path_user'],$_config['path_media']), [ '.htaccess', 'system/core.php', 'system/default/config.php', INSTANCE_DIR . LOGS_DIRNAME . MAIN_LOG_FILENAME, $_config['path_media'].PICTURES_DIRNAME .'.htaccess', $_config['path_media'].THUMBNAILS_DIRNAME .'.htaccess', $_config['path_media'].AVATARS_DIRNAME .'.htaccess', $_config['path_media'].USERPIC_DIRNAME .'.htaccess', $_config['path_media'].VIDEO_DIRNAME .'.htaccess', $_config['path_media'].AUDIO_DIRNAME .'.htaccess', USER_DIR . CACHE_FILENAME_FRONTPAGE, USER_DIR . BACKUP_DIRNAME .'backup-tail.sql', ] ); foreach ($go as $wd){ $wo[$wd]=null; } $eo = ['statuses' => $wo]; @e3 (USER_DIR . 'checklist.psa',serialize ($eo)); return $eo; } function rs () { $uo['items_count']=0; $uo['total_count']=0; $uo['percentage']=0; $uo['stamp_completed']=false; $jo = USER_DIR . 'checklist.psa'; $eo = @unserialize (file_get_contents ($jo)); if ($eo === false) return $uo; $ho = @$eo['statuses']; $t2 = $io = 0; if(is_array ($ho)) { foreach ($ho as $xo){ $t2 ++; if ($xo !== null){ $io ++; } } $uo['items_count']=$io; $uo['total_count']=$t2; $uo['percentage']=x1 ($io,$t2); } $uo['stamp_completed'] = @$eo['completed-stamp']; return $uo; } function e2_load_settings_from_user_folder_($oo){ $po = []; if(is_file ($oo . 'settings.json')) { $po = json_decode (file_get_contents ($oo . 'settings.json'),true); } $po = gs ($po); return $po; } function e2m_settings () { global$settings,$_template,$_strings,$_config; $cp = array (); $vp = DEFAULT_LANGUAGE; if(array_key_exists ('language',$settings)) { $vp = $settings['language']; } foreach(glob (SYSTEM_DIR . LANGUAGES_DIRNAME. '*.php') as $wd){ $bp = substr (basename ($wd),0,2); $yp = file_get_contents ($wd); if(preg_match ( '/^ *\/\/ *display_name *\= *(.*?) *$/ismu',$yp,$fe )) { $vu = $fe[1]; } else { $vu = $bp; } $cp[$bp] = array ( 'selected?' => (bool) ($vp == $bp), 'display-name' => $vu, ); } $qd = $np = false; $mp = (string) @$qd['pay-href']; if ((string)$mp === ''){ $mp = 'https://'. $_strings['e2--website-host'] .'/get/'; } if (!isset ($_template))qf (); $cb['title']=$_strings['pt--settings']; $cb['heading']=$_strings['pt--settings']; $cb['form']='form-preferences'; $cb['form-preferences'] = [ 'blog-title-default' => htmlspecialchars ($_strings['e2--default-blog-title'],ENT_COMPAT,'UTF-8'), 'blog-title' => htmlspecialchars (ev (), ENT_COMPAT,'UTF-8'), 'blog-subtitle' => htmlspecialchars (@$settings['blog_subtitle'],ENT_COMPAT,'UTF-8'), 'blog-meta-description' => htmlspecialchars (@$settings['meta_description'],ENT_COMPAT,'UTF-8'), 'blog-author-default' => htmlspecialchars ($_strings['e2--default-blog-author'],ENT_COMPAT,'UTF-8'), 'blog-author' => htmlspecialchars (@$settings['author'],ENT_COMPAT,'UTF-8'), 'languages' => $cp, 'language' => $vp, 'form-action' => qq ('e2s_settings_save'), 'userpic-href' => tv ('square'), 'notes-per-page' => $settings['appearance']['notes_per_page'], 'emailing-possible?' => MAIL_ENABLED, 'email-notify?' => (bool) @$settings['notifications']['new_comments'], 'email' => htmlspecialchars (@$settings['author_email'],ENT_COMPAT,'UTF-8'), 'comments-default-on?' => (bool) @$settings['comments']['default_on'], 'comments-require-gip?' => (bool) @$settings['comments']['require_gip'], 'comments-fresh-only?' => (bool) @$settings['comments']['fresh_only'], 'show-view-counts?' => (bool) @$settings['appearance']['show_view_counts'], 'show-sharing-buttons?' => (bool) @$settings['appearance']['show_sharing_buttons'], 'includes-main-menu-fields?' => false, 'main-menu-promo' => e2l_get_string ( 'pm--main-menu', ['url' => $_config['paid_features_url']] ), 'show-main-menu?' => false, 'main-menu-items' => [], 'includes-analytics-fields?' => false, 'analytics-promo' => e2l_get_string ( 'pm--analytics', ['url' => $_config['paid_features_url']] ), 'template-name' => $_template['name'], 'templates' => wf (), 'respond-to-dark-mode?' => (bool) @$settings['appearance']['respond_to_dark_mode'], 'submit-text' => $_strings['fb--save-changes'], 'show-payment-info?' => $np and ($qd !== false), 'paid-period' => @$qd['licensed?'] ? (time () <= $qd['until-stamp']) : false, 'paid-period-ended' => @$qd['licensed?'] ? (time () > $qd['until-stamp']) : false, 'paid-until' => @$qd['licensed?'] ? ([$qd['until-stamp'],wa ()]) : false, 'pay-href' => $mp, 'space-usage' => yy (vy (), true), ]; return $cb; } function e2s_settings_save () { global$settings,$_strings; if($_SERVER['REQUEST_METHOD']!='POST'){ s1 (qq ('e2m_settings')); } wd (); $sp = $ad = ''; if(array_key_exists ('blog-title',$_POST)) { $sp = trim ($_POST['blog-title']); } if(array_key_exists ('blog-subtitle',$_POST)) { $ad = trim ($_POST['blog-subtitle']); } if(array_key_exists ('blog-meta-description',$_POST)) { $ap = trim ($_POST['blog-meta-description']); } if(array_key_exists ('blog-author',$_POST)) { $qp = trim ($_POST['blog-author']); } if(array_key_exists ('language',$_POST)) $lp = $_POST['language']; if(array_key_exists ('email',$_POST)) $es = trim ($_POST['email']); $zp = (int)$_POST['notes-per-page']; $settings['blog_title']=$sp; $settings['blog_title']=ev (); $settings['author']=$qp; $settings['author_email']=$es; $settings['notifications']['new_comments'] = isset ($_POST['email-notify']); if(array_key_exists ('template',$_POST)) { $settings['template']=trim ($_POST['template']); } $settings['comments']['default_on'] = isset ($_POST['comments-default-on']); $settings['comments']['require_gip'] = isset ($_POST['comments-require-gip']); $settings['appearance']['show_view_counts'] = isset ($_POST['show-view-counts']); if ( !array_key_exists ('language',$settings) or $settings['language']!=$lp ) { e2_drop_all_kinds_of_cache (); $settings['language']=$lp; } if ( $settings['blog_subtitle']!=$ad or $settings['meta_description']!=$ap or $settings['appearance']['notes_per_page']!=$zp or $settings['appearance']['show_sharing_buttons'] != isset ($_POST['show-sharing-buttons']) or $settings['appearance']['respond_to_dark_mode'] != isset ($_POST['respond-to-dark-mode']) or $settings['comments']['fresh_only'] != isset ($_POST['comments-fresh-only']) ) { @unlink (USER_DIR . CACHE_FILENAME_FRONTPAGE); @unlink (USER_DIR . CACHE_FILENAME_FRONTPAGE_FEED); @unlink (USER_DIR . CACHE_FILENAME_FRONTPAGE_AUTHOR); $settings['blog_subtitle']=$ad; $settings['meta_description']=$ap; $settings['appearance']['notes_per_page']=$zp; $settings['appearance']['show_sharing_buttons'] = isset ($_POST['show-sharing-buttons']); $settings['appearance']['respond_to_dark_mode'] = isset ($_POST['respond-to-dark-mode']); $settings['comments']['fresh_only'] = isset ($_POST['comments-fresh-only']); } o1 (USER_DIR . CACHE_FILENAMES_NOTES_COMMENTS); if (!@e3 (USER_DIR . 'settings.json',json_encode ($settings,E2_JSON_STYLE))) { hb ($_strings['er--settings-not-saved'],E2E_PERMISSIONS_ERROR); s1 (qq ('e2m_settings')); } s1 (qq ('e2m_frontpage', array ('page' => 1))); } function e2m_underhood () { global$_db,$_config; if (!$_config['allow_underhood_access']) return e2m_error404 (); $cb['title']='Underhood'; $cb['heading']='Underhood'; nm (iq (), 'check version'); $kp = wa (); $xp = $ep = 0; foreach(glob (USER_DIR . CACHES_DIRNAME .'*') as $wd){ $xp ++; $ep += stat ($wd)['size']; } $rp = $tp = 0; foreach(glob (INSTANCE_DIR . LOGS_DIRNAME .'*') as $wd){ $rp ++; $tp += stat ($wd)['size']; } $vi = dd (); $jp = x1 ( $vi['indexed_count'],$vi['total_count'] ); $hp = false; if ($vi['time_spent']) { if(is_numeric (($vi['time_spent']))) { $hp = floor ($vi['time_spent']); } if ($hp >= 60){ $hp = ( floor ($hp / 60) .'min '. str_pad ($hp % 60,2,'0',STR_PAD_LEFT). 's' ); } elseif ($hp > 0){ $hp .= 's'; } else { $hp = false; } } $uo = rs (); $gp = array_keys (qm (USER_DIR . BACKUP_DIRNAME)); $cb['form']='form-underhood'; $cb['form-underhood'] = [ 'db-software' => $_db['software'], 'db-version' => $_db['version'], 'form-action-engine-rebuild' => BUILT? false : qq ('e2s_post_service', ['service' => 'build']), 'current-timezone-offset' => ta ($kp ['offset']), 'current-timezone-is-dst' => $kp ['is_dst'], 'cache-files-count' => $xp, 'cache-files-size' => $ep, 'form-action-cache-invalidate' => qq ('e2s_post_service', ['service' => 'sync']), 'search-index-items-count' => $vi['indexed_count'], 'search-index-total-items-count' => $vi['total_count'], 'search-index-time-spent' => $hp, 'search-index-percentage' => $jp, 'form-action-search-index-continue' => qd ()? false : qq ('e2s_bsi_step'), 'form-action-search-index-rebuild' => qq ('e2s_reindex'), 'checklist-items-count' => $uo['items_count'], 'checklist-total-items-count' => $uo['total_count'], 'checklist-percentage' => $uo['percentage'], 'checklist-stamp-completed' => !empty ($uo['stamp_completed'])? c1 ('D, M d, Y \a\t H:i:s',$uo['stamp_completed']) : false, 'form-action-checklist-reset' => qq ('e2s_post_service', ['service' => 'checklist-reset']), 'log-files-count' => $rp, 'log-files-size' => $tp, 'form-action-logs-enable' => ( is_file (INSTANCE_DIR . LOGS_DIRNAME . MAIN_LOG_FILENAME) ? '' : qq ('e2s_post_service', ['service' => 'log']) ), 'form-action-logs-erase-disable' => ( $rp? qq ('e2s_post_service', ['service' => 'unlog']) : '' ), 'backup-last' => count ($gp)? c1 ('D, M d, Y \a\t H:i:s',$gp[0]) : false, 'form-action-backup' => qq ('e2s_dump'), 'form-action-database-migrate' => qq ( 'e2s_post_service', ['service' => 'migrate'] ), 'form-action-license-verify' => qq ( 'e2s_post_service', ['service' => 'verify'] ), ]; return $cb; } function e2m_database () { global$settings,$_strings,$_config; $databaseConfiguration = iq (); if($databaseConfiguration->source !== 'settings' or !$_config['allow_db_config']) { return e2m_error404 (); } $cb['title']=$_strings['pt--database']; $cb['heading']=$_strings['pt--database']; $cb['form']='form-database'; $cb['form-database'] = array ( 'form-action' => qq ('e2s_database_save'), 'db-server' => htmlspecialchars (@$settings['db']['server']? $settings['db']['server']:'localhost'), 'db-user' => htmlspecialchars (@$settings['db']['user_name']? $settings['db']['user_name']:'root'), 'db-database' => htmlspecialchars (@$settings['db']['name']), 'submit-text' => $_strings['fb--connect-to-this-db'], ); return $cb; } function js ($backup_dir,$wp,$prefix = null,$subset = null){ $up['server']=$up['user_name'] = $up['passw']=$up['name']=''; if(array_key_exists ('db-server',$wp)) $up['server']=$wp['db-server']; if(array_key_exists ('db-user',$wp)) $up['user_name']=$wp['db-user']; if(array_key_exists ('db-password',$wp))$up['passw']=$wp['db-password']; if(array_key_exists ('db-database',$wp))$up['name']=$wp['db-database']; $databaseConfiguration = new AeDatabaseConfiguration ( 'post', $backup_dir, $up['server'], $up['user_name'], as_ ($up['passw']), $up['name'], $prefix, $subset ); return$databaseConfiguration; } function e2s_database_save () { global$settings,$_db,$_strings,$_config; wd (); if($_SERVER['REQUEST_METHOD']!='POST'){ s1 (qq ('e2m_database')); } $databaseConfiguration = iq (); if($databaseConfiguration->source !== 'settings' or !$_config['allow_db_config']) { return e2m_error404 (); } $wp = $_POST; if (!array_key_exists ('db-password',$wp)) { $wp['db-password']=htmlspecialchars (qs (@$settings['db']['passw'])); } $databaseConfiguration = js ( USER_DIR . BACKUP_DIRNAME, $wp, $_config['db_table_prefix'], $_config['db_table_subset'] ); $lr = false; try { nm ($databaseConfiguration,'check database from HTTP post'); $dr = un ($databaseConfiguration); if (!$dr['occupied'] or !$dr['migrateable']) { hb ($_strings['er--db-data-incomplete']); s1 (qq ('e2m_database')); } jn ($databaseConfiguration); $lr = true; } catch (AeMySQLCannotConnectException $e){ hb ( $_strings['er--cannot-connect-to-db']. ':<br />'. mysqli_connect_error () .' ('. mysqli_connect_errno () .')' ); } catch (AeMySQLTooOldException $e){ hb (e2l_get_string ('er--dbs-version-too-old', [ 'dbs' => $_db['software'], 'v1' => $_db['version'], 'v2' => $_db['version-minimum'], ])); } catch (AeMySQLException $e){ hb ($_strings['er--cannot-find-db'] .' '. $databaseConfiguration->name); } if (!$lr){ s1 (qq ('e2m_database')); } $settings['db']=$databaseConfiguration -> getDatabaseParamsArray (); if (!@e3 (USER_DIR . 'settings.json',json_encode ($settings,E2_JSON_STYLE))) { hb ($_strings['er--settings-not-saved'],E2E_PERMISSIONS_ERROR); s1 (qq ('e2m_database')); } e2_drop_all_kinds_of_cache (); if (!$_config['retain_search_indexes_on_db_switch']) { $ar = ed (iq ()); try { $ar -> erase (); } catch (\S2\Rose\Exception\RuntimeException $e){ if(Log::$a)__log ('Rose not available'); } sd (USER_DIR); } vv (qq ('e2s_bsi_step')); s1 (qq ('e2m_settings')); } function hs () { return class_exists ('ZipArchive'); } function e2m_get_backup () { if (hs ()) { $ip = new ZipArchive (); $op = USER_DIR . BACKUP_DIRNAME .'backup.zip'; if ($ip -> open ($op,ZIPARCHIVE::CREATE)) { @ $ip -> addEmptyDir ('backup'); $pp = USER_DIR . BACKUP_DIRNAME .'backup-tail.sql'; $ccv = ''; $vcv = -1; foreach(glob (USER_DIR . BACKUP_DIRNAME .'backup-*.sql') as $m2){ if ($m2 === $pp) continue; $bcv = stat ($m2); if ($bcv['ctime']>$vcv)$ccv = $m2; $vcv = $bcv['ctime']; } if ($ccv === ''){ $ccv = km (iq ()); } $ip -> addFile ($ccv,'backup/'. basename ($ccv)); if(is_file ($pp)) { @file_put_contents ($pp,"COMMIT;\r\n\r\n",FILE_APPEND | LOCK_EX); @chmod ($pp,E2_NEW_FILES_RIGHTS); } $ip -> addFile ($pp,'backup/backup-tail.sql'); $ip -> close (); } if(is_file ($op)) { header ('Content-Type: application/zip'); header ('Content-Disposition: attachment; filename="backup.zip"'); readfile ($op); unlink ($op); } else { die ('Cannot get backup'); } die; } else { die ('Cannot get backup'); } } function gs ($po){ if ( !array_key_exists ('appearance',$po) or !array_key_exists ('notes_per_page',$po['appearance']) or !is_numeric ($po['appearance']['notes_per_page']) or $po['appearance']['notes_per_page']<1 ) { $po['appearance']['notes_per_page']=DEFAULT_ITEMS_PER_PAGE; } if ($po['appearance']['notes_per_page']>MAX_ITEMS_PER_PAGE){ $po['appearance']['notes_per_page']=MAX_ITEMS_PER_PAGE; } if ( !array_key_exists ('comments',$po) or !array_key_exists ('default_on',$po['comments']) ) { $po['comments']['default_on']=false; } if (!array_key_exists ('respond_to_dark_mode',$po['appearance'])) { $po['appearance']['respond_to_dark_mode']=true; } if ( !array_key_exists ('template',$po) or (string)$po['template']==='' ) { $po['template']=DEFAULT_TEMPLATE; } if (isset ($po['description'])) { if (!isset ($po['blog_subtitle'])) { $po['blog_subtitle']=$po['description']; } unset ($po['description']); } if (isset ($po['site_title'])) { if (!isset ($po['blog_title'])) { $po['blog_title']=$po['site_title']; } unset ($po['site_title']); } if (isset ($po['user'])) { if (!isset ($po['author_email'])) { $po['author_email'] = (string) @$po['user']['email']; } unset ($po['user']); } if (isset ($po['v3223_rss_permalinks_before_stamp'])) { unset ($po['v3223_rss_permalinks_before_stamp']); } return $po; } function e2j_save_menu_order () { global$settings; $yl = ['success' => false]; if(is_array (@$_POST['order'])) { $settings['menu_order']=$_POST['order']; if (@e3 (USER_DIR . 'settings.json',json_encode ($settings,E2_JSON_STYLE))) { $yl = ['success' => true]; } } $yl = json_encode ($yl); die ($yl); } function ws ($v3){ global$_config; $ncv = $_config['share_to']; $mcv = '|twitter|facebook|vkontakte|telegram|linkedin|whatsapp|'; if (@$_config['share_to_twitter_via']) { $lb['twitter']['via']=$_config['share_to_twitter_via']; } if(count ($v3)>0){ $fcv = $v3[0]; $mcv .= 'pinterest|'; $lb['pinterest']['media']=$fcv; } $dcv = []; foreach(explode (',',$ncv) as $scv){ $scv = trim ($scv); if(strstr ($mcv,'|'. $scv. '|')) { $dcv[$scv]['share?']=true; if(is_array (@$lb[$scv]) and count ($lb[$scv])) { $dcv[$scv]['data']=$lb[$scv]; } } } return $dcv; } function us ($acv,$lb = null){ if ($acv === 'generic'){ $qcv = $lb; } else { if (!is_file ($lcv = SYSTEM_DIR . 'stubs/' . $acv .'.php')) { throw new AeStubException ('No stub found for the problem "'. $acv .'"'); } $qcv = include $lcv; } $zcv = false; if (!empty ($qcv['button'])) { $zcv = true; $kcv = qq ('e2m_frontpage', ['page' => 1]); $xcv = $qcv['button']; } $cb = [ 'stub-kind' => $acv, 'title' => $qcv['heading'], 'heading' => $qcv['heading'], 'stub' => $qcv['text'], ]; if ($zcv)$cb += [ 'stub-button-href' => $kcv, 'stub-button-text' => $xcv ]; return $cb; } function e2m_tags () { global$_strings; AeMainMenuManager :: $isTagsCurrent = true; $cb['title']=$_strings['pt--tags']; $cb['heading']=$_strings['pt--tags']; $cb['tags']=na ([]); $v8 = ma (true); if ($v8 === null){ $cb['unavailable?']=true; } else { $cb['tags']['each']=$v8; if(count ($v8)==0){ $cb['nothing']=$_strings['gs--no-tags']; } } return $cb; } function e2m_tag ($parameters = []) { global $settings, $_config, $_strings; if(Log::$a)__log ('Tag {'); $tn = cs (); $tagNotesView = new AePageableNotesView ('e2m_tag',$parameters); $tagNotesView -> setPortionSize ($settings['appearance']['notes_per_page']); $tagNotesView -> setNextPrevPageTitles ($_strings['gs--earlier'],$_strings['gs--later']); $tagNotesView -> setWantPaging (true); $tagNotesView -> setWantNewCommentsCount ($tn); $tagNotesView -> setWantReadHrefs ($_config['count_reads']); $tagNotesView -> setWantControls ($tn and !@$_config['read_only']); $tagNotesView -> setWantHiddenTags ($tn); if(array_key_exists ('*tags',$parameters)) { $ecv = $parameters['*tags']; } elseif(array_key_exists ('*tag',$parameters)) { $ecv = [$parameters['*tag']]; } else { $ecv = []; } $xb = []; foreach ($ecv as $tb){ if ($tn or $tb['IsVisible']) { $xb[] = $tb; } } $rcv = count ($xb); if ($rcv == 0 or $rcv < count ($ecv)) { return e2m_error404 (); } foreach ($xb as $tb) if ($tb)$tcv[] = "nk.`KeywordID`=". $tb['ID']; $zu = ( "FROM `". $_config['db_table_prefix'] ."Notes` n ". "JOIN `". $_config['db_table_prefix'] ."NotesKeywords` nk ". "ON nk.`NoteID` = n.`ID` ". "WHERE n.`SubsetID`=". $_config['db_table_subset'] ." ". "AND nk.`SubsetID`=". $_config['db_table_subset'] ." ". "AND (". implode (" OR ",$tcv).") ". "AND IsPublished=1 ". nf ($tn). "GROUP BY n.`ID` ". "HAVING COUNT(*)>=". $rcv ); $tagNotesView -> setSQLCountRequest ( "SELECT COUNT(*) Total FROM (SELECT 1 ". $zu .") _" ); $tagNotesView -> setLimitlessSQLRequest ( "SELECT n.*, COUNT(*) ". $zu ." ". "ORDER BY n.`Stamp` DESC" ); $jcv = []; foreach ($xb as $tb){ $jcv[] = $tb['Keyword']; if ($rcv === 1){ AeMainMenuManager :: addCurrentTag ($tb['Keyword']); } else { AeMainMenuManager :: addParentTag ($tb['Keyword']); } } $tagNotesView -> setHighlightedTags ($jcv); $hl = ''; $f5['description']=''; $f5['summary']=''; $f5['visible?']=true; foreach ($xb as $tb) if (!$tb['IsVisible']) { $f5['visible?']=false; break; } if ($rcv === 1){ $hcv = $xb[0]; $gcv = b () ['t'. $hcv['ID']]; if(CACHE_TAG and $tagNotesView -> isFirstPage ()) { if ($tn){ $tagNotesView -> setCacheFilename (e2_cache_filename_with_id_($hcv['ID'],USER_DIR . CACHE_FILENAMES_TAG_AUTHOR)); } else { $tagNotesView -> setCacheFilename (e2_cache_filename_with_id_($hcv['ID'],USER_DIR . CACHE_FILENAMES_TAG)); } } $t0 = ba ($hcv['ID'],5); if ($tn){ $f5['edit-href']=qq ( 'e2m_tag_edit', ['tag-alias' => $gcv] ); $wcv = (bool)$hcv['IsFavourite']; $ucv = $parameters; $ucv['flag']='IsFavourite'; $ucv['value'] = (int) !$wcv; $f5['pinned?']=false; } if ((string)$hcv['Description']!==''){ $sd = qy ($hcv['Description'],'full'); $o1 = $sd['text-final']; $f5['description']=$o1; $f5['description-format-info']=$sd['meta']; b2 (@$sd['meta']['links-required']); } if ((string)$hcv['Summary']!==''){ $f5['summary']=dy (htmlspecialchars ($hcv['Summary'],ENT_NOQUOTES,'UTF-8')); } elseif ((string)$f5['description']!==''){ $f5['summary']=bf ($f5['description']); }; $icv = qq ('e2m_tag_rss', ['tag-alias' => $gcv]); $ocv = qq ('e2m_tag_json', ['tag-alias' => $gcv]); d3 ( 'rss', ev () .': '. $hcv['Keyword'], $icv ); d3 ( 'json', ev () .': '. $hcv['Keyword'], $ocv ); $f5['og-images']=t3 ( q2 ( @$f5['description-format-info']['resources-detected'], g3 ('tag',$hcv['ID']) ) ); $f5['name']=htmlspecialchars ($hcv['Keyword'],ENT_COMPAT,'UTF-8'); $f5['related']=$t0; $hl = htmlspecialchars ($hcv['PageTitle'],ENT_COMPAT,'UTF-8'); } $t2 = $tagNotesView -> getTotalNotes (); $f5['notes-count']=$t2; $f5['notes-count-text']=e2l_get_string ('pt--n-posts', ['number' => $t2]); $pcv = $f5['notes-count-text'] .' '. $_strings['gs--tagged']; $cvv = []; foreach ($xb as $a3){ $cvv[] = htmlspecialchars ($a3['Keyword'],ENT_COMPAT,'UTF-8'); } $cvv = implode (', ',$cvv); if ((string)$hl !== ''){ $ms = $hl; $fs = $hl; } else { $ms = ev () .': '. $pcv .' '. $cvv; if ($rcv > 1){ $fs = $_strings['pt--tags'] .': '. $cvv; } else { $fs = $_strings['pt--tag'] .': '. $cvv; } } if($parameters['page']>1){ $ms .= ' ('. $_strings['gs--page'] .' '. $parameters['page'] .')'; } $d3 = na ($parameters); $cb = [ 'title' => $ms, 'heading' => htmlspecialchars_decode ($fs,ENT_COMPAT), 'notes' => $tagNotesView -> getNotesCTree (), 'pages' => $tagNotesView -> getPagesCTree (), 'tag' => $f5, 'tags' => $d3, ]; if ( !$tagNotesView -> isExistingPage () and !$tagNotesView -> isFirstPageOfEmptyView () ) { return e2m_error404 (); } if ( $tagNotesView -> isFirstPageOfEmptyView () and !$tn ) { return e2m_error404 (); } if($tagNotesView -> isFirstPageOfEmptyView ()) { $cb['nothing']=$_strings['gs--no-such-notes']; } if ((string)$f5['summary']!==''){ $cb['summary']=$f5['summary']; } if ($rcv == 1){ if (cs ()) { $cb['related-edit-href']=$f5['edit-href']; $cb['related-edit-title']=$_strings['tt--edit-tag']; } } if(Log::$a)__log ('} // Tag'); return $cb; } function e2m_tag_edit ($parameters = []) { global$_strings; if(array_key_exists ('*tag',$parameters)) { $tb = $parameters['*tag']; } if (!@$tb) return e2m_error404 (); AeMainMenuManager :: addParentTag ($tb['Keyword']); $ib = sy ( 'neasden',$tb['Description'],'full' ); $pb = @unserialize ( $tb['Uploads'] ) or $pb = []; $d8 = z2 ( s2 ( q2 ( $ib,$pb ) ) ); i3 ( 'Keywords', $tb, $ib ); $xz = vy (); $vvv = htmlspecialchars ($tb['Keyword'],ENT_COMPAT,'UTF-8'); $bvv = b () ['t'. $tb['ID']]; $yvv = [ 'enabled?' => by ($xz), 'each' => $d8, 'default-name' => htmlspecialchars ($bvv,ENT_COMPAT,'UTF-8'), 'upload-action' => qq ('e2j_file_upload'), 'remove-action' => qq ('e2j_file_remove'), ]; $nvv = [ '.tag-id' => $tb['ID'], '.formatter-id' => 'neasden', 'form-action' => qq ('e2s_tag_edit'), 'submit-text' => $_strings['fb--save-changes'], 'tag-dotted' => qa ($tb), 'page-title' => htmlspecialchars ($tb['PageTitle'],ENT_COMPAT,'UTF-8'), 'page-title-placeholder' => htmlspecialchars ($tb['Keyword'],ENT_COMPAT,'UTF-8'), 'alias' => htmlspecialchars ($bvv,ENT_COMPAT,'UTF-8'), 'description' => htmlspecialchars ($tb['Description'],ENT_COMPAT,'UTF-8'), 'summary' => (string)$tb['Summary'], 'favourite?' => (bool)$tb['IsFavourite'], 'space-usage' => yy ($xz), ]; $cb = [ 'body-uploads-enabled?' => by ($xz), 'title' => $_strings['pt--tag-edit'] .': '. $tb['Keyword'], 'heading' => $_strings['pt--tag-edit'], 'form' => 'form-tag', 'form-tag' => $nvv, 'uploads' => $yvv, 'related-delete-href' => qq ('e2m_tag_delete', ['*tag' => $tb]), ]; return $cb; } function e2s_tag_flag_ajax ($parameters){ r1 ([ 'flag-name' => 'tag', 'candy-name' => 'e2s_tag_flag_ajax', 'parameters' => $parameters, 'flipping-function' => function () use ($parameters){ is ($parameters); }, 'redirect-candy' => 'e2m_tag', ]); } function is ($parameters){ if($_SERVER['REQUEST_METHOD']!='POST'){ s1 (qq ('e2m_tag',$parameters)); } wd (); if(array_key_exists ('*tag',$parameters)) { $tb = $parameters['*tag']; } if (!$tb) throw new AeException ('Tag record not cound from parameters'); e2_drop_caches_for_tag_($tb['ID']); ym ( iq (), 'Keywords', [ 'ID' => $tb['ID'], $parameters['flag'] => (int) ($parameters['value']==1), ] ); } function e2m_tag_delete ($parameters = []) { global$_strings; if(array_key_exists ('*tag',$parameters)) { $mvv = $parameters['*tag']; } if (!$mvv) return e2m_error404 (); $fvv = [ '.tag-id' => $mvv['ID'], 'caution-text' => e2l_get_string ('gs--tag-will-be-deleted-notes-remain', [ 'tag' => htmlspecialchars ($mvv['Keyword'],ENT_COMPAT,'UTF-8') ]), 'tag' => htmlspecialchars ($mvv['Keyword'],ENT_COMPAT,'UTF-8'), 'form-action' => qq ('e2s_tag_delete'), 'submit-text' => $_strings['fb--delete'], ]; $cb = [ 'title' => $_strings['pt--tag-delete'] .': '. $mvv['Keyword'], 'heading' => $_strings['pt--tag-delete'], 'form' => 'form-tag-delete', 'form-tag-delete' => $fvv, ]; return $cb; } function e2m_untagged ($parameters = []) { global$settings,$_strings,$_config; $tn = cs (); $untaggedView = new AePageableNotesView ('e2m_untagged',$parameters); $untaggedView -> setPortionSize ($settings['appearance']['notes_per_page']); $untaggedView -> setNextPrevPageTitles ($_strings['gs--earlier'],$_strings['gs--later']); $untaggedView -> setWantPaging (true); $untaggedView -> setWantNewCommentsCount ($tn); $untaggedView -> setWantReadHrefs ($_config['count_reads']); $untaggedView -> setWantControls ($tn and !@$_config['read_only']); $untaggedView -> setWantHiddenTags ($tn); $zu = ( "FROM `". $_config['db_table_prefix']."Notes` n ". "LEFT OUTER JOIN `". $_config['db_table_prefix']."NotesKeywords` nk ". "ON nk.`NoteID` = n.`ID` ". "WHERE n.`SubsetID`=". $_config['db_table_subset'] ." ". "AND n.`IsPublished`=1 ". "AND nk.`SubsetID` IS NULL ". nf ($tn) ); $untaggedView -> setSQLCountRequest ( "SELECT COUNT(*) Total ". $zu ); $untaggedView -> setLimitlessSQLRequest ( "SELECT n.* ". $zu ." ORDER BY n.`Stamp` DESC" ); $ms = $_strings['pt--posts-without-tags']; if($parameters['page']>1){ $ms .= ' ('. $_strings['gs--page'] .' '. $parameters['page'] .')'; } $cb = [ 'title' => $ms, 'heading' => $_strings['pt--posts-without-tags'], 'notes' => $untaggedView -> getNotesCTree (), 'pages' => $untaggedView -> getPagesCTree (), ]; if($untaggedView -> isFirstPageOfEmptyView ()) { $cb['nothing']=$_strings['gs--no-posts-without-tags']; } elseif (!$untaggedView -> isExistingPage ()) { return e2m_error404 (); } return $cb; } function e2s_tag_edit () { global$_strings,$_config; wd (); $ys = $m8 = $o1 = $zg = ''; if(array_key_exists ('tag-id',$_POST)) $ys = $_POST['tag-id']; if(array_key_exists ('tag',$_POST)) $m8 = $_POST['tag']; if(array_key_exists ('page-title',$_POST)) $hl = trim ($_POST['page-title'],"\r\n"); if(array_key_exists ('description',$_POST)) $o1 = trim ($_POST['description'],"\r\n"); if(array_key_exists ('summary',$_POST)) $ng = trim ($_POST['summary'],"\r\n"); if(array_key_exists ('urlname',$_POST)) $zg = trim ($_POST['urlname'],"\r\n"); list ($hv,$dvv)=la ($m8); $svv = 0; $avv = 1; mm ( "SELECT * FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID` = ".((int)$ys)."", 'get tag record to update' ); $lvv = dm (); if(count ($lvv)!=1) die; $tb = $lvv[0]; mm ( "SELECT * FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `Keyword` = '". sm ($hv) ."' ". "AND (`ID` != ".((int)$ys).")", 'make sure new tag name does not conflict with existing ones' ); $lvv = dm (); if(count ($lvv)==0){ if ($avv != $svv){ cb (); } e2_drop_caches_for_tag_($ys); if ($hv === ''){ $hv = $tb['Keyword']; hb ($_strings['er--tag-must-have-name'],E2E_USER_ERROR); } $tb['ID'] = ((int)$ys); $tb['Keyword']=$hv; $tb['PageTitle']=$hl; $tb['Description']=$o1; $tb['Summary']=$ng; $tb['IsVisible']=$dvv; $ib = sy ( 'neasden',$tb['Description'],'full' ); if(count ($ib)>0){ t2 ($ib); j2 ($ib); } $databaseConfiguration = iq (); ym ($databaseConfiguration,'Keywords',$tb); $ey = d ( USER_DIR,$databaseConfiguration, 'set','t',$tb['ID'],$zg ); s1 (qq ('e2m_tag', ['tag-alias' => $ey])); } else { hb ($_strings['er--cannot-rename-tag'],E2E_USER_ERROR); a1 (); } die; } function e2s_tag_delete () { global$_config; wd (); $ys = ((int)$_POST['tag-id']); cb (); e2_drop_caches_for_tag_($ys); mm ( "DELETE FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID`=". $ys, 'delete note by ID' ); mm ( "DELETE FROM `". $_config['db_table_prefix']."Aliases` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `EntityType` = 't' ". "AND `EntityID` = ". ((int)$ys), 'delete aliases after deleting note' ); mm ( "DELETE FROM `". $_config['db_table_prefix']."NotesKeywords` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `KeywordID`=". $ys, 'delete tag bindings after deleting tag' ); s1 (qq ('e2m_tags')); } function os () { global$settings,$_config; $zvv = null; if(CACHE_FAVTAGS and is_file (USER_DIR . CACHE_FILENAME_FAVTAGS)) { $zvv = @unserialize (file_get_contents (USER_DIR . CACHE_FILENAME_FAVTAGS)); } $tn = cs (); if (!is_array ($zvv)) { try { mm ( "SELECT * FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsFavourite`=1 ORDER BY `Keyword`", 'get favorite tags for tags menu' ); $kvv = dm (); $zvv = []; foreach ($kvv as $tb){ if (!$tb['IsVisible']) continue; $ba['sort-id']='t'. $tb['ID']; $ba['tag']=htmlspecialchars ($tb['Keyword'],ENT_NOQUOTES,'UTF-8'); $ba['title']=td ($ba['tag']); $ba['href']=qq ( 'e2m_tag', ['*tag' => $tb] ); $ba['visible?'] = (bool)$tb['IsVisible']; $ba['current?']=false; $ba['parent?']=false; $zvv[] = $ba; } if(CACHE_FAVTAGS)e3 (USER_DIR . CACHE_FILENAME_FAVTAGS,serialize ($zvv)); } catch (AeMySQLException $e){ v3 ($e); if(Log::$a)__log ('Count not get tags menu from database'); } } if (!is_array ($zvv)) return null; foreach ($zvv as $s3 => $a3){ if (!$tn and !$zvv[$s3]['visible?']) { unset ($zvv[$s3]); continue; } $zvv[$s3]['parent?'] = ( AeMainMenuManager :: isParentTag ($zvv[$s3]['tag']) ); $zvv[$s3]['current?'] = ( AeMainMenuManager :: isCurrentTag ($zvv[$s3]['tag']) ); } if(is_array (@$settings['menu_order'])) { $uf = array_flip ($settings['menu_order']); usort ($zvv, function ($c5,$v5) use ($uf){ $b5 = @$uf[$c5['sort-id']]; $y5 = @$uf[$v5['sort-id']]; if ($b5 === false)$b5 = count ($uf); if ($y5 === false)$y5 = count ($uf); return $b5 - $y5; }); } return $zvv; } function ps ($note_id){ global$_config; $xb = []; mm ( "SELECT k.* ". "FROM `". $_config['db_table_prefix']."Keywords` k, ". "`". $_config['db_table_prefix']."NotesKeywords` nk ". "WHERE k.`SubsetID`=". $_config['db_table_subset'] ." ". "AND nk.`SubsetID`=". $_config['db_table_subset'] ." ". "AND nk.`NoteID`=". ((int)$note_id) ." ". "AND k.`ID`=nk.`KeywordID` ". "ORDER BY `Keyword`", 'get tag records for note by id' ); $xb = dm (); return $xb; } function ca ($databaseConfiguration,$note_id,$dg){ va ($databaseConfiguration, ['NoteID' => $note_id]); foreach ($dg as $m8){ list ($hv,$dvv)=la ( $m8 ); if ($hv === '') continue; $o5 = fa ($databaseConfiguration,$hv); if (!$o5){ @unlink (USER_DIR . CACHE_FILENAME_TAGS); @unlink (USER_DIR . CACHE_FILENAME_TAGS_FULL); @unlink (USER_DIR . CACHE_FILENAME_TAGS_AUTHOR); @unlink (USER_DIR . CACHE_FILENAME_TAGS_AUTHOR_FULL); b (true); $o5['ID']=ya ( $databaseConfiguration,$hv,$dvv ); } fm ($databaseConfiguration, "INSERT INTO `". $databaseConfiguration -> getPrefix () . "NotesKeywords` ". "(`SubsetID`, `NoteID`, `KeywordID`) ". "VALUES (". ((int)$databaseConfiguration -> getSubset ()) .", ". ((int)$note_id) .", ". ((int)$o5['ID']). ")", 'add new tag bindings' ); } } function va ($databaseConfiguration,$xvv){ $evv = []; foreach ([ 'ID', 'NoteID', 'KeywordID', ] as $x) if(array_key_exists ($x,$xvv)) { $lj[] = '`'. $x .'`'."='". sm ($xvv[$x]) ."'"; if ($x == 'ID')$rvv = 'tagbinging-id'; if ($x == 'NoteID')$rvv = 'tagbinging-note-id'; if ($x == 'KeywordID')$rvv = 'tagbinging-tag-id'; $evv[$rvv]=$xvv[$x]; } $z2 = ( "DELETE FROM `". $databaseConfiguration -> getPrefix () . "NotesKeywords` ". "WHERE `SubsetID`=". $databaseConfiguration -> getSubset () ." ". "AND ". implode (' AND ',$lj) ); fm ($databaseConfiguration,$z2); } function ba ($ys,$tvv){ global$_config; mm ( "SELECT `ID`, `Keyword`, `OriginalAlias` ". "FROM `". $_config['db_table_prefix'] ."Keywords` k ". "WHERE k.`SubsetID`=". $_config['db_table_subset'] ." ". "AND `IsVisible` = 1 ". "AND k.`ID` IN (". "SELECT `KeywordID` FROM (". "SELECT COUNT(`NoteID`) NotesCount, `KeywordID` ". "FROM `". $_config['db_table_prefix'] ."NotesKeywords` nk ". "WHERE nk.`SubsetID`=". $_config['db_table_subset'] ." ". "AND nk.`NoteID` IN (". "SELECT nk2.`NoteID` ". "FROM `". $_config['db_table_prefix'] ."NotesKeywords` nk2 ". "WHERE nk2.`SubsetID`=". $_config['db_table_subset'] ." ". "AND nk2.`KeywordID`=". $ys. ") ". "GROUP BY nk.`KeywordID` ". "HAVING NotesCount > 1 ". "ORDER BY NotesCount DESC ". "LIMIT 1, ". $tvv. ") k_ids". ")", 'find related tags' ); $t0 = []; foreach (dm () as $tb){ if ($tb['ID']===$ys) continue; $t0[] = [ 'name' => htmlspecialchars ($tb['Keyword'],ENT_NOQUOTES,'UTF-8'), 'href' => qq ('e2m_tag', ['*tag' => $tb]), 'visible?' => true, ]; } return $t0; } function ya ( AeDatabaseConfiguration $databaseConfiguration,$hv,$dvv ){ $tb = [ 'Keyword' => $hv, 'OriginalAlias' => d ( USER_DIR,$databaseConfiguration, 'find','','',$hv ), 'Description' => '', 'IsVisible' => $dvv, ]; $tb = bm ($databaseConfiguration,'Keywords',$tb); $jvv = d ( USER_DIR,$databaseConfiguration, 'set','t',$tb['ID'],$hv ); if ($jvv != $tb['OriginalAlias']) { $tb['OriginalAlias']=$jvv; ym ($databaseConfiguration,'Keywords',$tb); } return $tb['ID']; } function na ($parameters){ if (($hvv = ma ()) === null) return []; $d3['each']=$hvv; $d3['reorderable?']=false; if (cs ()) { $d3['reorderable?']=true; $d3['save-order-action']=qq ('e2j_save_menu_order'); } if(count ($d3['each']) > 0){ $d3['href']=qq ('e2m_tags'); } if (($gvv = os ()) !== null){ $d3['menu-each']=$gvv; } return $d3; } function ma ($wvv = false){ global$_config; $tn = cs (); $wf = USER_DIR . CACHE_FILENAME_TAGS; if ($tn)$wf = USER_DIR . CACHE_FILENAME_TAGS_AUTHOR; if ($wvv){ $wf = USER_DIR . CACHE_FILENAME_TAGS_FULL; if ($tn)$wf = USER_DIR . CACHE_FILENAME_TAGS_AUTHOR_FULL; } $uvv = null; if(CACHE_TAGS and is_file ($wf)) { $uvv = @unserialize (file_get_contents ($wf)); } if (!is_array ($uvv)) { try { mm ( "SELECT * FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "ORDER BY `Keyword`", 'get all tags' ); $ivv = []; foreach (dm () as $tb){ $hv['id'] = (int)$tb['ID']; $hv['tag']=htmlspecialchars ($tb['Keyword'],ENT_NOQUOTES,'UTF-8'); $hv['tag-dotted']=qa ($tb); $hv['favourite?'] = (bool)$tb['IsFavourite']; $hv['visible?'] = (bool)$tb['IsVisible']; $hv['notes-count']=0; $hv['last-used']=0; $hv['freshness']=0; $hv['weight']=0; if ($wvv){ $hv['href']=qq ('e2m_tag', ['*tag' => $tb]); } $ivv[$tb['ID']] = $hv; } mm ( "SELECT nk.KeywordID, COUNT(DISTINCT n.ID) as Count, max(n.Stamp) as LastUsed ". "FROM `". $_config['db_table_prefix']."NotesKeywords` nk, ". "`". $_config['db_table_prefix']."Notes` n ". "WHERE nk.`SubsetID`=". $_config['db_table_subset'] ." ". "AND n.`SubsetID`=". $_config['db_table_subset'] ." ". "AND n.`IsPublished` = 1 ". nf ($tn). "AND nk.`NoteID` = n.`ID` ". "GROUP BY nk.KeywordID", 'get tags ordering info' ); $ovv = 0; $pvv = 0; $cbv = 0; foreach (dm () as $vbv){ if (!isset ($ivv[$vbv['KeywordID']])) { unset ($ivv[$vbv['KeywordID']]); continue; } $ba =& $ivv[$vbv['KeywordID']]; $ba['notes-count']=$vbv['Count']; if (@$ba['last-used']<$vbv['LastUsed']) { $ba['last-used']=$vbv['LastUsed']; $bbv = (time () - $ba['last-used']) / SECONDS_IN_A_YEAR; $ba['freshness']=pow (1/2,$bbv); } $ovv = max ($ovv,$ba['notes-count']); $pvv = max ($pvv,$ba['freshness']); $cbv = max ($cbv,$ba['notes-count']*$ba['freshness']); } $uvv = []; foreach ($ivv as $rb => $a3){ if (!$tn and $a3['notes-count']==0) continue; if (!$tn and !$a3['visible?']) continue; $ybv = mb_strtolower ($a3['tag']); $uvv[$ybv]=$a3; if ($pvv != 0){ $uvv[$ybv]['freshness']=$a3['freshness']/$pvv; } else { $uvv[$ybv]['freshness']=0; } if ($cbv != 0){ $uvv[$ybv]['weight'] = ( $a3['freshness']*$a3['notes-count']/$cbv ); } else { $uvv[$ybv]['weight']=0; } if ($uvv[$ybv]['favourite?'])$uvv[$ybv]['weight']=1; } if(CACHE_TAGS)e3 ($wf,serialize ($uvv)); } catch (AeMySQLException $e){ v3 ($e); if(Log::$a)__log ('Could not get tags from database'); } } return $uvv; } function fa (AeDatabaseConfiguration $databaseConfiguration,$mvv){ fm ( $databaseConfiguration, "SELECT * FROM `". $databaseConfiguration -> getPrefix () . "Keywords` ". "WHERE `SubsetID`=". $databaseConfiguration -> getSubset () ." ". "AND `Keyword`='". sm ($mvv) ."'", 'get tag by name' ); $s3 = dm (); if (isset ($s3[0])) { return $s3[0]; } else { return null; } } function da (AeDatabaseConfiguration $databaseConfiguration,$nbv){ fm ( $databaseConfiguration, "SELECT * FROM `". $databaseConfiguration -> getPrefix () . "Keywords` ". "WHERE `SubsetID`=". $databaseConfiguration -> getSubset () ." ". "AND `OriginalAlias`='".sm ($nbv)."'", 'get tag by legacy urlname name' ); $zb = dm (); if (isset ($zb[0])) { return $zb[0]; } else { return null; } } function sa ($zy){ global$_config; mm ( "SELECT * FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ." ". "AND `ID`='".((int)$zy)."'", 'get tag by id' ); $zb = dm (); if (isset ($zb[0])) { return $zb[0]; } else { return null; } } function e2_tagrecs_with_parameters_($parameters){ $mbv = []; if (@$parameters['tag-alias'] or $parameters['tag-alias']==='0'){ $mbv = explode (',',$parameters['tag-alias']); } $xb = []; foreach ($mbv as $nbv) if ($nbv or $nbv === '0'){ if ( $p8 = f (@$nbv) and ($p8['type']=='t') and ($tb = sa ($p8['id'])) ) { $xb[] = $tb; } else { if ($fbv = da ( iq (), $nbv )) { $xb[] = $fbv; } } } return $xb; } function qa ($tb){ $dbv = htmlspecialchars ($tb['Keyword'],ENT_COMPAT,'UTF-8'); if (!$tb['IsVisible']) { $dbv = '.'. $dbv; } return $dbv; } function la ($dbv){ if (@$dbv[0]==='.'){ return [trim (substr ($dbv,1),". \t\n\r\0\x0B"),false]; } else { return [$dbv,true]; } } function za ($bf){ $uj = c1 ('H',$bf); if ($uj <= 4) return 4; elseif ($uj <= 10) return 1; elseif ($uj <= 16) return 2; elseif ($uj <= 22) return 3; else return 4; } function ka ($sbv,$abv = null){ global$_strings; if ($abv === null)$abv = wa (); $ld = time (); $qbv = pa ('d.m.Y',$ld,$abv); $lbv = pa ('d.m.Y',$sbv,$abv); $zbv = SECONDS_IN_A_MINUTE; $kbv = SECONDS_IN_AN_HOUR; $xbv = za ($ld); $ebv = za ($sbv); $rbv = $ld - $sbv; if ($rbv < 0) return$_strings['tt--from-the-future']; if ($rbv >= 0 and $rbv < 54) return$_strings['tt--just-now']; if ($rbv >= 54 and $rbv < 108) return$_strings['tt--one-minute-ago']; $tbv = $rbv + 12; $jbv = floor ($tbv / $zbv); if ($rbv >= 108 and $rbv < 54*$zbv) return e2l_get_string ( 'tt--minutes-ago', array ('minutes' => $jbv) ); if ($rbv >= 54*$zbv and $rbv < 108*$zbv) return$_strings['tt--one-hour-ago']; $tbv = $rbv + 12*$zbv; $hbv = floor ($tbv / $kbv); if ($rbv >= 108*$zbv and $rbv < 4*$kbv) return e2l_get_string ( 'tt--hours-ago', array ('hours' => $hbv) ); $l = pa ('G:i',$sbv,$abv); if ($rbv >= 4*$kbv and $xbv > $ebv and $qbv == $lbv){ return$_strings['tt--today']; } if ((($ld - $sbv) <= 7884000)) { return e2l_get_string ( 'tt--date', array ( 'day' => pa ('j',$sbv,$abv), 'month' => pa ('m',$sbv,$abv), ) ); } return pa ('Y',$sbv,$abv); } function xa ($sbv,$abv = null){ global$_strings; $rbv = time () - $sbv; if ($rbv < 0) return$_strings['tt--from-the-future']; if ($rbv == 0) return$_strings['tt--now']; $gbv = array ( array (1,'tt--seconds-short'), array (SECONDS_IN_A_MINUTE,'tt--minutes-short'), array (SECONDS_IN_AN_HOUR,'tt--hours-short'), array (SECONDS_IN_A_DAY,'tt--days-short'), array (SECONDS_IN_A_MONTH,'tt--months-short'), array (SECONDS_IN_A_YEAR,'tt--years-short'), array (SECONDS_IN_A_YEAR + SECONDS_IN_A_MONTH,''), ); for ($rb = 0; $rb < count ($gbv); ++ $rb){ if ($rbv >= $gbv[$rb][0] and $rbv < $gbv[$rb + 1][0]) { return e2l_get_string ( $gbv[$rb][1], array ('value' => floor ($rbv / $gbv[$rb][0])) ); } } if ($abv === null)$abv = wa (); return pa ('Y',$sbv,$abv); } function e2m_timezone () { global$_strings,$settings; $wbv = array ( 'form-action' => qq ('e2s_select_timezone'), 'submit-text' => $_strings['fb--select'], 'timezone-selector' => ja ($settings['timezone']['offset'],1), 'dst?' => $settings['timezone']['is_dst'], ); return array ( 'title' => $_strings['pt--default-timezone'], 'heading' => $_strings['pt--default-timezone'], 'form' => 'form-timezone', 'form-timezone' => $wbv, ); } function ea () { global$_strings; $ubv = array ( -720 => '', -660 => '', -600 => '', -540 => '', -480 => $_strings['tt--zone-pt'], -420 => $_strings['tt--zone-mt'], -360 => $_strings['tt--zone-ct'], -300 => $_strings['tt--zone-et'], -240 => '', -210 => '', -180 => '', -120 => '', -60 => '', 0 => $_strings['tt--zone-gmt'], 60 => $_strings['tt--zone-cet'], 120 => $_strings['tt--zone-eet'], 180 => '', 210 => '', 240 => $_strings['tt--zone-msk'], 270 => '', 300 => '', 330 => '', 345 => '', 360 => $_strings['tt--zone-ekt'], 390 => '', 420 => '', 480 => '', 540 => '', 570 => '', 600 => '', 660 => '', 720 => '', 780 => '', 840 => '', ); return $ubv; } function ra ($z3){ $ubv = ea (); return @$ubv[(int)$z3/SECONDS_IN_A_MINUTE]; } function ta ($z3){ $ibv = '+'; if ($z3 < 0)$ibv = '&ndash;'; $obv = str_pad ((int) (abs ($z3)/3600),2,'0',STR_PAD_LEFT); $pbv = str_pad (abs ($z3)/60 % 60,2,'0',STR_PAD_LEFT); return 'GMT'. $ibv . $obv .':'. $pbv; } function ja ($c3v,$v3v = ''){ global$_strings; $ubv = ea (); $cb = ''; if (!$v3v)$v3v = count ($ubv); $cb .= '<select class="e2-select" name="offset" size="'. $v3v .'">'; foreach ($ubv as $z3 => $b3v){ $y3v = ''; if ($z3 * SECONDS_IN_A_MINUTE == $c3v)$y3v = ' selected="selected"'; $cb .= '<option'. $y3v .' value="'.$z3.'">'; $ibv = ''; if ($z3 < 0)$ibv = '−'; if ($z3 > 0)$ibv = '+'; $obv = (int) (abs ($z3 * SECONDS_IN_A_MINUTE)/3600); $pbv = (int) (abs ($z3 * SECONDS_IN_A_MINUTE)/60 % 60); if ($obv){ $cb .= ( $ibv .' '. $obv .' '. $_strings['gs--timezone-offset-hours'] .' '. ($pbv? ($pbv .' '. $_strings['gs--timezone-offset-minutes']) : '') ); if ($b3v){ $cb .= ' ('. $b3v. ')'; } } else { $cb .= $b3v; } $cb .= '</option>'; } $cb .= '</select>'; return $cb; } function e2s_select_timezone () { global$settings,$_strings; wd (); if (@$_POST['offset'] >= -720 and @$_POST['offset'] <= 780){ $settings['timezone']['offset'] = @$_POST['offset']*SECONDS_IN_A_MINUTE; $settings['timezone']['is_dst'] = isset ($_POST['is_dst']); } if (!@e3 (USER_DIR . 'settings.json',json_encode ($settings,E2_JSON_STYLE))) { hb ($_strings['er--settings-not-saved'],E2E_PERMISSIONS_ERROR); s1 (qq ('e2m_timezone')); } s1 (qq ('e2m_settings')); } function ha ($r){ return array ( 'offset' => (int)$r['Offset'], 'is_dst' => (bool)$r['IsDST'], ); } function ga () { return array ( 'offset' => 0, 'is_dst' => false, ); } function wa () { global$settings; if(array_key_exists ('timezone',$settings)) { return$settings['timezone']; } else { return ga (); } } function ua ($gb,$n3v){ if (@$gb['is_dst']) { $m3v = (int)date ('I',$n3v); $f3v = date ('Z',$n3v)-$m3v * SECONDS_IN_AN_HOUR; $d3v = $gb['offset']; $s3v = $d3v - $f3v; $a3v = date ('I',$n3v + $s3v); return $a3v; } else { return 0; } } function ia ($gb,$n3v){ if ($gb and is_array ($gb)) { return ( $gb['offset'] + ua ($gb,$n3v)*SECONDS_IN_AN_HOUR ); } } function oa ($n3v){ return ia (wa (), $n3v); } function pa ($q3v,$r4,$gb){ return gmdate ($q3v,$r4 + ia ($gb,$r4)); } function c1 ($q3v,$r4){ return pa ($q3v,$r4,wa ()); } function v1 ($tm,$jm = false,$hm = false){ if(is_numeric ($hm)) { $l3v = gmmktime (0,0,0,$jm,$hm,$tm); $z3v = gmmktime (0,0,0,$jm,$hm + 1,$tm)-1; } elseif(is_numeric ($jm)) { $l3v = gmmktime (0,0,0,$jm,1,$tm); $z3v = gmmktime (0,0,0,$jm + 1,1,$tm)-1; } else { $l3v = gmmktime (0,0,0,1,1,$tm); $z3v = gmmktime (0,0,0,1,1,$tm + 1)-1; } return array ($l3v,$z3v); } function b1 ($gb,$tm,$jm = false,$hm = false){ list ($l3v,$z3v)=v1 ($tm,$jm,$hm); $l3v -= ia ($gb,$l3v); $z3v -= ia ($gb,$z3v); return array ($l3v,$z3v); } function y1 ($tm,$jm = false,$hm = false){ return b1 (wa (), $tm,$jm,$hm); } function n1 ($tm,$jm = false,$hm = false){ $k3v = 13; $x3v = -12; $k3v += 1; $x3v -= 1; list ($l3v,$z3v)=v1 ($tm,$jm,$hm); $l3v -= $k3v * 3600; $z3v -= $x3v * 3600; return array ($l3v,$z3v); } function m1 ($z3){ if ((int) @$z3 > 0) return (string)'+'.abs (@$z3); elseif ((int) @$z3 < 0) return (string)'-'.abs (@$z3); else return ''; } function f1 ($n3v,$e3v = ''){ $r3v = oa ($n3v); $ibv = ($r3v >= 0)?'+':'-'; $r3v = abs ($r3v); $ij = $r3v % 60; $r3v -= $ij; $jm = $r3v % 3600 / 60; $r3v -= $jm * 60; $uj = $r3v / 3600; if ($uj < 10)$uj = '0'.$uj; if ($jm < 10)$jm = '0'.$jm; return $ibv.$uj.$e3v.$jm; } function d1 ($t3v){ global$settings; if(is_numeric ($t3v)) { $x3['offset']=SECONDS_IN_A_MINUTE * $t3v; $x3['is_dst']=false; $j3v = SECONDS_IN_A_MINUTE * $t3v - SECONDS_IN_AN_HOUR; $h3v = array ('offset' => $j3v,'is_dst' => true); $h3v = (int)ia ($h3v,time ()); if ($x3['offset']==$h3v){ $x3['offset']=$j3v; $x3['is_dst']=true; } } else { if(array_key_exists ('timezone',$settings)) { $x3 = $settings['timezone']; } else { $x3['offset']=0; $x3['is_dst']=false; } } return $x3; } function s1 ($c1 = ''){ global$errors; @session_start (); $_SESSION['errors']=$errors; if(substr ($c1,0,strlen (AeEnv::$i)+3)!=AeEnv::$i .'://'){ header ('Location: '. AeEnv::$o . $c1); } else { header ('Location: '. $c1); } flush (); die; } function a1 () { $g3v = (string) @$_SERVER['HTTP_REFERER']; s1 ($g3v); } function q1 ($ir = ''){ $w3v = str_replace ('/','--', trim (AeEnv::$w .'/'.AeEnv::$u,'/') ); if ($w3v !== '')$w3v .= '-'; $url = AeEnv::$base_url; $lz = substr_count ($_SERVER['HTTP_HOST'],'.'); $cb = $w3v . @str_repeat ('_',$lz).$ir; return $cb; } function l1 ($ir,$cv = '',$u3v = true){ $i3v = $u3v? (time () + 3600 * 24 * 365) : (0); $o3v = $_SERVER['HTTP_HOST']; $p3v = substr_count ($o3v,'.'); if ($p3v < 3)$o3v = str_repeat ('.',3 - $p3v).$o3v; setcookie (q1 ($ir),$cv,$i3v,'/'); } function z1 ($cyv,$c4,$vyv = ''){ if(trim ($c4)!=''){ $c4 = explode ($cyv,$c4); foreach ($c4 as $rb => $s3)$c4[$rb]=trim ($s3); foreach ($c4 as $rb => $s3) if ($s3 == '') unset ($c4[$rb]); $byv = array_unique ($c4); if ('sort' == $vyv)sort ($byv); return $byv; } else return array (); } function k1 ($c4){ $kq = array (); if(is_file (SYSTEM_DEFAULTS_DIR . 'romanize.txt')) { $kq = file (SYSTEM_DEFAULTS_DIR . 'romanize.txt'); } $yyv = $wt = ''; foreach ($kq as $rb => $pm){ if (!($rb%2))$yyv .= rtrim ($pm) .' '; else $wt .= rtrim ($pm) .' '; if ($rb%2){ while (mb_strlen ($wt)<mb_strlen ($yyv))$wt .= ' '; while (mb_strlen ($wt)>mb_strlen ($yyv))$yyv .= ' '; } } $nyv = ''; $myv = -1; for ($rb = 0; $rb < mb_strlen ($yyv); ++ $rb){ $ycv = mb_substr ($yyv,$rb,1); if ($ycv != ' '){ $nyv .= $ycv; if ($myv == -1)$myv = $rb; } elseif ($nyv){ $fyv = trim (mb_substr ($wt,$myv,mb_strpos ($wt,' ',$myv + 1)-$myv)); $kb = array ($nyv,$fyv); $dyv[mb_strlen ($nyv)][] = $kb; $nyv = ''; $myv = -1; } } $syv = array (); for ($rb = count ($dyv); $rb > 0; -- $rb){ foreach ($dyv[$rb] as $kb)$syv[$kb[0]] = $kb[1]; } return strtr ($c4,$syv); } function x1 ($c5,$v5,$ayv = 0){ if ($v5 == 0) return 0; $qyv = round ($c5 / $v5 * 100,$ayv); $lyv = pow (10, -$ayv); if ($c5 > 0 and $qyv == 0)$qyv = $lyv; if ($c5 < $v5 and $qyv == 100)$qyv = 100 - $lyv; return $qyv; } function e1 ($zyv,$action,$r4){ if (!is_array ($zyv))$zyv = array (); if($action == 'add'){ $zyv = array_unique (array_merge ($zyv,$r4)); } if($action == 'remove'){ unset ($zyv[array_search ($r4,$zyv)]); } if (!is_array ($zyv))$zyv = array (); return $zyv; } function r1 ($lb){ $parameters = $lb['parameters']; $yl = [ 'success' => false ]; $lb['flipping-function'] ($parameters); $kyv = $parameters; $kyv['value'] = !$parameters['value']; $yl = [ 'success' => true, 'data' => [ 'flag-now-on' => ($parameters['value']==1), 'new-href' => qq ($lb['candy-name'],$kyv), ] ]; if(array_key_exists ('result',$_POST) and ($_POST['result']=='ajaxresult')) { $yl = json_encode ($yl); die ($yl); } else { s1 (qq ($lb['redirect-candy'],$parameters)); } } function t1 ($c4){ $vo = @$_SERVER['HTTP_USER_AGENT'] or $vo = ''; $xyv = strstr ($vo,'iPhone') || strstr ($vo,'iPad'); $eyv = strstr ($vo,'Macintosh'); if ($xyv) return ''; if ($c4 == 'submit'){ if ($eyv){ return '&#x2303; &#x21a9;'; } else { return 'Ctrl + Enter'; } } if ($c4 == 'livesave'){ if ($eyv){ return '&#x2318; S'; } else { return 'Ctrl + S'; } } if ($c4 == 'navigation'){ if ($eyv){ return '&#x2325;'; } else { return 'Ctrl'; } } if ($c4 == 'navigation-later'){ if ($eyv){ return '&#x2325; &uarr;'; } else { return 'Ctrl + &uarr;'; } } if ($c4 == 'navigation-earlier'){ if ($eyv){ return '&#x2325; &darr;'; } else { return 'Ctrl + &darr;'; } } } function j1 ($l1){ $l1 = str_replace ('<','&lt;',$l1); $l1 = str_replace ('>','&gt;',$l1); return $l1; } function h1 ($l1){ $l1 = str_replace ('"','&quot;',$l1); return $l1; } function g1 ($cv,$ryv){ return str_replace ('.',',',round ($cv,$ryv)); } function e2_stripslashes_array ($cs){ return is_array ($cs)?array_map ('e2_stripslashes_array',$cs):stripslashes ($cs); } function w1 () { if(version_compare (PHP_VERSION,'7.4') >= 0) return; if(get_magic_quotes_runtime ()) { set_magic_quotes_runtime (0); } if(get_magic_quotes_gpc ()) { $_GET = e2_stripslashes_array ($_GET); $_POST = e2_stripslashes_array ($_POST); $_COOKIE = e2_stripslashes_array ($_COOKIE); $_REQUEST = e2_stripslashes_array ($_REQUEST); } } function u1 ($gi){ return sprintf ('%u',ip2long ($gi)); } function i1 ($qa){ return long2ip (sprintf ('%d',$qa)); } function e2_decline_for_number ($l1,$qa = null){ $tyv = $l1; if ($qa === null){ $qa = substr ($l1,0,strpos ($l1,' ')); $tyv = substr ($l1,strpos ($l1,' ')+1); } $jyv = strpos ($tyv,'('); $hyv = strpos ($tyv,')'); if ($hyv > $jyv)$gyv = substr ($tyv,$jyv,$hyv - $jyv + 1); $wyv = explode (',',trim (@$gyv,'()')); if(count ($wyv)==2)array_unshift ($wyv,''); $uyv = array (2,0,1,1,1,2,2,2,2,2); if ($qa%100 > 10 and $qa%100 < 20)$iyv = 2; else $iyv = $uyv[$qa%10]; $s7 = $wyv[$iyv]; $l1 = str_replace ($gyv,$s7,$l1); if(strstr ($l1,'(') and strstr ($l1,')')) { return e2_decline_for_number ($l1,$qa); } else { return $l1; } } function o1 ($oyv){ $go = glob ($oyv,GLOB_NOSORT); if(is_array ($go)) { foreach ($go as $wd){ @unlink ($wd); } } } function p1 ($nx){ $go = glob ($nx .'*',GLOB_NOSORT); if(is_array ($go)) { foreach ($go as $wd){ if(basename ($wd)!='.' and basename ($wd)!='..'){ if(is_dir ($wd)) { if (p1 ($wd .'/')) { if (!@rmdir ($wd)) { return false; } } else { return false; } } else { @unlink ($wd); } } } return true; } else { return false; } } function cq ($pyv){ $pyv = trim ($pyv,'/'); $pyv = explode ('/',$pyv); $nx = ''; foreach ($pyv as $cnv){ $nx = $nx.$cnv; if (!is_dir ($nx)) { if (@mkdir ($nx)) { @chmod ($nx,E2_NEW_FILES_RIGHTS); } else { return false; } } $nx = $nx.'/'; } return true; } function vq ($pyv){ return preg_replace ('/\/([^\/]+?)\/\.\./','',$pyv); } function bq ($c4){ $vnv = get_html_translation_table (HTML_ENTITIES); $vnv = array_flip ($vnv); return strtr ($c4,$vnv); } function yq ($bnv = NULL){ if(NULL == $bnv)$bnv = microtime (); list ($ynv,$rbv)=explode (' ',$bnv); return ((float)$ynv + (float)$rbv); } function _A ($l1){ global$_candy,$_current_url; if ( preg_match ('/\<a href\=\"(.*?)\"[^>]*\>(.*?)\<\/a\>/si',$l1,$fe) and ( $fe[1]==='' or $fe[1]===$_current_url or AeEnv::$i .'://'. AeEnv::$server . $fe[1]===$_current_url or AeEnv::$o . $fe[1]===$_current_url or $_candy == 'e2m_install' ) ) { return $fe[2]; } else { return $l1; } } function _AT ($n1){ global$_current_url; return ( $n1 === '' or $n1 === $_current_url or AeEnv::$i .'://'. AeEnv::$server . $n1 === $_current_url or AeEnv::$o . AeEnv::$u . $n1 === $_current_url ); } function _READS ($j3){ if (!empty ($j3['read-count'])) return $j3['read-count']; return AeNoteReadCountsProvider :: getReadCountForNoteID ($j3['id']); } function _IMGSRC ($wd){ return uf ($wd); } function _SVG ($wd){ return if_ ($wd); } function _COLOR ($b,$y,$nnv,$mnv = 1){ if(strlen ($b)!=3 and strlen ($b)!=6) return 'f0f'; if(strlen ($y)!=3 and strlen ($y)!=6) return 'f0f'; if(strlen ($b)==3)$b = $b[0].$b[0].$b[1].$b[1].$b[2].$b[2]; if(strlen ($y)==3)$y = $y[0].$y[0].$y[1].$y[1].$y[2].$y[2]; $sj = array ( $b[0].$b[1],$b[2].$b[3],$b[4].$b[5], $y[0].$y[1],$y[2].$y[3],$y[4].$y[5], ); foreach ($sj as $s3 => $a3){ $sj[$s3]=hexdec ($a3); } $st = array ( $sj[0]+pow ($nnv,$mnv) * ($sj[3]-$sj[0]), $sj[1]+pow ($nnv,$mnv) * ($sj[4]-$sj[1]), $sj[2]+pow ($nnv,$mnv) * ($sj[5]-$sj[2]), ); $fnv = ''; foreach ($st as $s3 => $a3){ $fnv .= str_pad (dechex ($a3),2,'0',STR_PAD_LEFT); } return $fnv; } function _DT ($q3v,$dnv){ if (!$dnv) return ''; list ($bf,$gb)=$dnv; $cb = $q3v; $en = pa ('m',$bf,$gb); $cb = str_replace ('{zone}',e2__escape_all (ta ($gb['offset'])), $cb); $cb = str_replace ('{month}',e2__escape_all (e2l_get_string ('um--month', array ('month' => $en))), $cb); $cb = str_replace ('{month-short}',e2__escape_all (e2l_get_string ('um--month-short', array ('month' => $en))), $cb); $cb = str_replace ('{month-g}',e2__escape_all (e2l_get_string ('um--month-g', array ('month' => $en))), $cb); $cb = pa ($cb,$bf,$gb); return $cb; } function _AGO ($dnv){ return xa ($dnv[0], array ('offset' => $dnv[1]['offset'],'is_dst' => $dnv[1]['is_dst']) ); } function _NUM ($l1){ return e2_decline_for_number ($l1); } function _CSS ($snv){ return jf ($snv); } function _CSS_HREF ($snv){ return of ($snv); } function _JS ($anv){ return hf ($anv); } function _LIB ($gw){ return gf ($gw); } function _T ($xw){ echo rf ($xw); } function _T_DEFER ($name){ echo kf ($name); } function _X ($xw){ echo ef ($xw); } function _T_FOR ($xw,$qnv = null){ global$content; if ($qnv === null)$qnv = $xw; if(array_key_exists ($qnv,$content)) { echo rf ($xw); } else { echo ''; } } function _FIT ($gz,$wz){ } function _GUIDES ($lnv = false){ global$_olba_guides; if(is_array ($lnv))$_olba_guides = $lnv; if (!is_array ($_olba_guides)) return; $znv = '<div style="position: fixed; width: 100%; height: 100%; z-index: -100">'; $knv = 0; $xnv = $_olba_guides; $xnv[] = 100; foreach ($xnv as $rb => $env){ if ($env == 100) break; $knv += $env; $znv .= '<div style="position: fixed; left: '. $env .'%; width: 0; height: 100%; border-left: 1px #000 dotted; opacity: .2; -webkit-opacity: .2; -moz-opacity: .2"></div>'; $rnv = 'position: absolute; padding: 2px 3px; top: 0; font-size: 9px; background: #ccc; color: #000; font-family: "Verdana", sans-serif; opacity: .8; -webkit-opacity: .8; -moz-opacity: .8'; if ($xnv[$rb+1]-$xnv[$rb]<4){ $znv .= '<div style="'. $rnv.'; right: '. (100 - $env) .'%; border-bottom-left-radius: .5em; -webkit-border-bottom-left-radius: .5em; -moz-border-bottom-left-radius: .5em;">'. $env .'%</div>'; } else { $znv .= '<div style="'. $rnv.'; left: '. $env .'%; border-bottom-right-radius: .5em; -webkit-border-bottom-right-radius: .5em; -moz-border-bottom-right-radius: .5em;">'. $env .'%</div>'; } } $znv .= '</div>'; $_olba_current_col = 0; return $znv; } function _S ($c4){ global$_strings; return$_strings[$c4]; } function _SHORTCUT ($name){ return t1 ($name); } function e2__escape_all ($c4){ $cb = ''; for ($rb = 0; $rb < mb_strlen ($c4); ++ $rb){ $cb .= '\\'. mb_substr ($c4,$rb,1); } return $cb; } function nq ($yyv){ global$_db,$_instance_config,$_strings; $tnv = 'v'. $yyv; $jnv = 'v'. E2_VERSION; $hnv = dq ($yyv); $gnv = dq (E2_VERSION); if ($hnv === $gnv){ $hnv = $tnv; $gnv = $jnv; } else { $hnv .= ' ('. $tnv. ')'; $gnv .= ' ('. $jnv .')'; } $wnv = dq (3239) .' (v3239)'; if (!$_instance_config['allow_update']) { return ['stub' => us ('update-disallowed')]; } if(E2_VERSION < $yyv and !$_instance_config['dev_ignore_version_mismatch']) { return ['stub' => us ('generic', [ 'heading' => $_strings['pt--confused'], 'text' => '<p>'. e2l_get_string ('gs--downdate-explanation', [ 'dr' => $hnv, 'rr' => $gnv, ]) .'</p>', ])]; } if ($yyv < 3239){ return ['stub' => us ('generic', [ 'heading' => $_strings['pt--multi-step-update'], 'text' => '<p>'. e2l_get_string ('gs--multi-step-update-p1', [ 'dr' => $hnv, 'rr' => $gnv, 'ur' => $wnv, ]) .'</p>'.'<p>'. e2l_get_string ('gs--multi-step-update-p2', [ 'dr' => $hnv, 'rr' => $gnv, 'ur' => $wnv, ]) .'</p>', ])]; } if (fq ()) { return ['stub' => us ('generic', [ 'heading' => $_strings['pt--updating'], 'text' => '<p>'. $_strings['gs--this-takes-seconds'] .'</p>', 'button' => $_strings['fb--retry'], ])]; } if($_instance_config['log_updates']) { Log::$a = true; if(Log::$a)dn ('update-$'); } if(Log::$a)__log ('Update from v'. $yyv .' to v'. E2_VERSION.' {'); $unv = ($yyv < 3601); $databaseConfigurationsToMigrate = []; try { if(Log::$a)__log ('Update instance'); if($_instance_config['db']!==null){ $instanceDatabaseConfiguration = new AeDatabaseConfiguration ( 'instance-config', INSTANCE_DIR . BACKUP_DIRNAME, $_instance_config['db']['server'], $_instance_config['db']['user_name'], $_instance_config['db']['passw'], $_instance_config['db']['name'], $_instance_config['db_table_prefix'] ); if($_instance_config['backup_before_update']) { if (!km ($instanceDatabaseConfiguration)) { throw new AeBackupFailedException (); } } in ($instanceDatabaseConfiguration); if(Log::$a)__log ('Instance has migrateable database table set "'. $instanceDatabaseConfiguration -> getTablesKeyString (). '"'); $inv = (mq ($instanceDatabaseConfiguration)); $instanceDatabaseConfiguration -> setSubset ($inv); if(Log::$a)__log ('Will set subset '. $inv .' for subset-zero records'); $databaseConfigurationsToMigrate[ $instanceDatabaseConfiguration -> getTablesKeyString () ] = $instanceDatabaseConfiguration; } bn (); AeFileManager::forceInstanceDirectories (); $onv = uq (); if(Log::$a)__log ('Update '. count ($onv) .' users {'); $vq = []; foreach ($onv as $oo){ $pnv = hq ($oo,$_instance_config['path_user']); $cmv = wq ($_instance_config,$pnv); $po = e2_load_settings_from_user_folder_($oo); if(count ($vmv = AeFileManager::getPathsWithNoWritePermissions ( $cmv['path_user'],$cmv['path_media'] )) > 0){ $vq = array_merge ($vq,$vmv); continue; } if(Log::$a)__log ( 'User with key "'. $pnv .'" has path "'. $cmv['path_user'] .'", '. 'media path "'. $cmv['path_media'] .'"' ); $userDatabaseConfiguration = oq ( $cmv,$po ); if ($cmv['backup_before_update']) { if (!km ($userDatabaseConfiguration)) { throw new AeBackupFailedException (); } } in ($userDatabaseConfiguration); if(Log::$a)__log ( 'User has migrateable database configuration "'. $userDatabaseConfiguration. '"' ); $databaseConfigurationsToMigrate[ $userDatabaseConfiguration -> getTablesKeyString () ] = $userDatabaseConfiguration; AeFileManager::forceUserDirectories ($cmv['path_user']); AeFileManager::forceMediaDirectories ($cmv['path_media']); o1 ($cmv['path_user'].CACHES_DIRNAME .'*'); if ($yyv < 3354){ @rename ($cmv['path_media'].'pictures/userpics/',AVATARS_DIRNAME); @unlink ($cmv['path_user'] .'password-reset.txt'); } if ($yyv < 3932){ @unlink ($cmv['path_user'] .'indexing.psa'); } foreach (p3 () as $hd){ if(is_file ($cmv['path_user'].$hd)) { rename ( $cmv['path_user'].$hd, $cmv['path_media'].USERPIC_DIRNAME . $hd ); } } if ($unv)sd ($cmv['path_user']); } if(count ($vq)>0){ return ['stub' => us ('generic', [ 'heading' => $_strings['pt--fix-permissions'], 'text' => ( '<p>'. $_strings['gs--fix-permissions'] .'</p>'. gb (array_unique ($vq)) ), 'button' => $_strings['fb--retry'], ])]; } if(Log::$a)__log ('}'); if(Log::$a)__log ('Migrate '. count ($databaseConfigurationsToMigrate) .' database table set(s), namely:'); $s3 = 0; foreach($databaseConfigurationsToMigrate as$databaseConfigurationToMigrate){ if(Log::$a)__log ((++ $s3) .'. "'. $databaseConfigurationToMigrate -> getTablesKeyString (). '"'); } $s3 = 0; foreach($databaseConfigurationsToMigrate as$databaseConfigurationToMigrate){ if(Log::$a)__log ('Prepage for migratation '. (++ $s3) .'/'. count ($databaseConfigurationsToMigrate) .':'); tn ($databaseConfigurationToMigrate); } $s3 = 0; foreach($databaseConfigurationsToMigrate as$databaseConfigurationToMigrate){ if(Log::$a)__log ('Migrate '. (++ $s3) .'/'. count ($databaseConfigurationsToMigrate) .':'); jn ($databaseConfigurationToMigrate); if ($unv){ jd ($databaseConfigurationToMigrate); } } } catch (AeBackupFailedException $e){ if(Log::$a)__log ('Aborting: cannot backup'); return ['stub' => us ('generic', [ 'heading' => $_strings['pt--update-cancelled'], 'text' => '<p>'. $_strings['gs--cannot-backup-before-update'] .'</p>', ])]; return ['stub' => us ('update-backup-failed')]; } catch (AeMySQLCannotConnectException $e){ if(Log::$a)__log ('Aborting: cannot connect'); return ['stub' => us ('generic', [ 'heading' => $_strings['pt--update-cancelled'], 'text' => '<p>'. $_strings['er--cannot-connect-to-db'] .'</p>', ])]; } catch (AeMySQLNotFoundException $e){ if(Log::$a)__log ('Aborting: database not found'); return ['stub' => us ('generic', [ 'heading' => $_strings['pt--update-cancelled'], 'text' => '<p>'. $_strings['er--cannot-find-db'] .'</p>', ])]; } catch (AeMySQLTooOldException $e){ if(Log::$a)__log ('Aborting: '. $_db['software'] .' too old'); return ['stub' => us ('generic', [ 'heading' => $_strings['pt--update-cancelled'], 'text' => '<p>'. e2l_get_string ( 'gs--dbs-version-too-old', [ 'dbs' => $_db['software'], 'dbv' => $_db['version'], 'minmysql' => E2_MINIMUM_MYSQL, 'minmariadb' => E2_MINIMUM_MARIADB, 'aegearelease' => dq (E2_VERSION) ] ) .'</p>' ])]; } catch (AeMySQLNotMigrateableException $e){ if(Log::$a)__log ('Aborting: not migrateable'); return ['stub' => us ('generic', [ 'heading' => $_strings['pt--update-cancelled'], 'text' => '<p>'. $_strings['gs--update-db-incomplete'] .'</p>', ])]; } catch (AeMySQLNoDataException $e){ if(Log::$a)__log ('Aborting: no data in database'); return ['stub' => us ('generic', [ 'heading' => $_strings['pt--update-cancelled'], 'text' => '<p>'. $_strings['gs--update-db-no-data-configure-or-reinstall'] .'</p>', ])]; } finally { @unlink (INSTANCE_DIR .'updating.psa'); } $zx = vn (E2_VERSION); return [ 'status' => 'success', 'from-release' => $hnv, 'to-release' => $gnv, 'instance' => $zx, ]; } function mq (AeDatabaseConfiguration $databaseConfiguration){ $bmv = 0; foreach(AeModel::unprefixedCoreTablesNames () as $s2){ fm ( $databaseConfiguration, "SELECT MAX(`SubsetID`) MaxSubsetID ". "FROM `". $databaseConfiguration -> getPrefix () . $s2 ."`" ); $x3 = dm (); $bmv = max ($bmv,$x3[0]['MaxSubsetID']); } return $bmv + 1; } function fq () { $ymv = ini_get ('max_execution_time')+1; $nmv = @unserialize (file_get_contents (INSTANCE_DIR .'updating.psa')); if (!is_array ($nmv))$nmv = []; if ( isset ($nmv['locktime']) and $nmv['locktime'] >= time () - $ymv ) return true; $nmv['locktime']=time (); @e3 (INSTANCE_DIR .'updating.psa',serialize ($nmv)); return false; } function dq ($a3){ $name = '2.6 or earlier'; if ($a3 >= 3119)$name = '2.6'; if ($a3 >= 3201)$name = '2.7b'; if ($a3 >= 3225)$name = '2.7b2'; if ($a3 >= 3239)$name = '2.7'; if ($a3 >= 3254)$name = '2.8a'; if ($a3 >= 3335)$name = '2.8b'; if ($a3 >= 3354)$name = '2.8b2'; if ($a3 >= 3364)$name = '2.8'; if ($a3 >= 3382)$name = '2.8 SP1'; if ($a3 >= 3386)$name = '2.8 SP2'; if ($a3 >= 3445)$name = '2.9a2'; if ($a3 >= 3492)$name = '2.9a4'; if ($a3 >= 3520)$name = '2.9b'; if ($a3 >= 3543)$name = '2.9b2'; if ($a3 >= 3553)$name = '2.9'; if ($a3 >= 3559)$name = '2.9 SP1'; if ($a3 >= 3565)$name = '2.9 SP2'; if ($a3 >= 3572)$name = '2.9 SP3'; if ($a3 >= 3576)$name = '2.9 SP4'; if ($a3 >= 3733)$name = '2.10a'; if ($a3 >= 3753)$name = '2.10a2'; if ($a3 >= 3783)$name = '2.10a3'; if ($a3 >= 3788)$name = '2.10'; if ($a3 >= 3805)$name = '2.10 SP1'; if ($a3 >= 3820)$name = '2.10 SP2'; if ($a3 >= 3831)$name = '2.10 SP3'; if ($a3 >= 3849)$name = '2.10 SP4'; if ($a3 >= 3860)$name = '2.10 SP5'; if ($a3 >= 3874)$name = '2.10 SP6'; if ($a3 >= 4034)$name = '2.11a'; if ($a3 >= E2_VERSION)$name = '2.11a'; return$name; } $_url_map = [ '@log' => 'e2://e2s_log', '@retrieve:url' => 'e2://e2s_retrieve', '@instantiate:version' => 'e2://e2s_instantiate', '@notify' => 'e2://e2s_notify', '@info' => 'e2://e2m_info', '' => 'e2://e2m_frontpage?page=1', ':page' => 'e2://e2m_frontpage', 'rss' => 'e2://e2m_rss', 'json' => 'e2://e2m_json', 'sitemap.xml' => 'e2://e2m_sitemap_xml', ':year' => 'e2://e2m_year', ':year/:month' => 'e2://e2m_month', ':year/:month/:day' => 'e2://e2m_day', 'all' => 'e2://e2m_everything', ':note' => 'e2://e2m_note?is_published=1&preview-key=0', ':note/:preview' => 'e2://e2m_note?is_published=1', ':note/edit' => 'e2://e2m_note_edit?is_published=1', ':note/favourite' => 'e2://e2s_note_flag_favourite?is_published=1&value=1', ':note/unfavourite' => 'e2://e2s_note_flag_favourite?is_published=1&value=0', ':note/show' => 'e2://e2s_note_flag?is_published=1&flag=IsVisible&value=1', ':note/hide' => 'e2://e2s_note_flag?is_published=1&flag=IsVisible&value=0', ':note/discuss' => 'e2://e2s_note_flag?is_published=1&flag=IsCommentable&value=1', ':note/quiet' => 'e2://e2s_note_flag?is_published=1&flag=IsCommentable&value=0', ':note/withdraw' => 'e2://e2m_note_withdraw?is_published=1', ':note/json' => 'e2://e2m_note_json', ':note/broadcast' => 'e2://e2m_note_broadcast', ':note/read' => 'e2://e2m_note_read', ':note/delete' => 'e2://e2m_note_delete?is_published=1', ':note/format/:formatter' => 'e2://e2m_note_use_formatter?is_published=1', ':note/:unsubscr' => 'e2://e2m_unsubscribe?is_published=1', ':note/:comnum' => 'e2://e2m_comment', ':note/:comnum/edit' => 'e2://e2m_comment_edit', ':note/:comnum/important' => 'e2://e2s_comment_flag_ajax?flag=IsFavourite&value=1', ':note/:comnum/usual' => 'e2://e2s_comment_flag_ajax?flag=IsFavourite&value=0', ':note/:comnum/replace' => 'e2://e2s_comment_flag_ajax?flag=IsVisible&value=1', ':note/:comnum/remove' => 'e2://e2s_comment_flag_ajax?flag=IsVisible&value=0', ':note/:comnum/spam' => 'e2://e2m_comment_flag?flag=IsSpamSuspect&value=1', ':note/:comnum/good' => 'e2://e2m_comment_flag?flag=IsSpamSuspect&value=0', ':note/:comnum/wipe' => 'e2://e2m_comment_delete', ':note/:comnum/reply/edit' => 'e2://e2m_comment_reply', ':note/:comnum/reply/important' => 'e2://e2s_comment_flag_ajax?flag=IsReplyFavourite&value=1', ':note/:comnum/reply/usual' => 'e2://e2s_comment_flag_ajax?flag=IsReplyFavourite&value=0', ':note/:comnum/reply/replace' => 'e2://e2s_comment_flag_ajax?flag=IsReplyVisible&value=1', ':note/:comnum/reply/remove' => 'e2://e2s_comment_flag_ajax?flag=IsReplyVisible&value=0', ':note/:comnum/reply/delete' => 'e2://e2m_comment_reply_delete', 'drafts' => 'e2://e2m_drafts?page=1', 'drafts-:page' => 'e2://e2m_drafts', 'drafts/:draft' => 'e2://e2m_note?is_published=0&preview-key=0', 'drafts/:draft/:preview' => 'e2://e2m_note?is_published=0', 'drafts/:draft/edit' => 'e2://e2m_note_edit?is_published=0', 'drafts/:draft/delete' => 'e2://e2m_note_delete?is_published=0', 'drafts/:draft/format/:formatter' => 'e2://e2m_note_use_formatter?is_published=0', 'sources' => 'e2://e2m_sources', 'sources/:source/trust' => 'e2://e2m_source_trust', 'sources/:source/premoderate' => 'e2://e2m_source_premoderate', 'sources/:source/ban' => 'e2://e2m_source_ban', 'sources/:source/forget' => 'e2://e2m_source_forget', 'tags' => 'e2://e2m_tags', 'tags/:tag' => 'e2://e2m_tag?page=1', 'tags/:tag/:page' => 'e2://e2m_tag', 'tags/:tag/rss' => 'e2://e2m_tag_rss', 'tags/:tag/json' => 'e2://e2m_tag_json', 'tags/:tag/edit' => 'e2://e2m_tag_edit', 'tags/:tag/delete' => 'e2://e2m_tag_delete', 'tags/:tag/pin' => 'e2://e2s_tag_flag_ajax?flag=IsFavourite&value=1', 'tags/:tag/unpin' => 'e2://e2s_tag_flag_ajax?flag=IsFavourite&value=0', 'selected' => 'e2://e2m_favourites?page=1', 'selected/:page' => 'e2://e2m_favourites', 'hot' => 'e2://e2m_most_commented', 'popular' => 'e2://e2m_popular', 'untagged' => 'e2://e2m_untagged?page=1', 'untagged/:page' => 'e2://e2m_untagged', 'found' => 'e2://e2m_found&query=', 'found/:query' => 'e2://e2m_found', 'new' => 'e2://e2m_write', 'settings' => 'e2://e2m_settings', 'settings/underhood' => 'e2://e2m_underhood', 'settings/underhood/build' => 'e2://e2s_post_service?service=build', 'settings/underhood/sync' => 'e2://e2s_post_service?service=sync', 'settings/underhood/checklist-reset' => 'e2://e2s_post_service?service=checklist-reset', 'settings/underhood/log' => 'e2://e2s_post_service?service=log', 'settings/underhood/unlog' => 'e2://e2s_post_service?service=unlog', 'settings/underhood/migrate' => 'e2://e2s_post_service?service=migrate', 'settings/underhood/verify' => 'e2://e2s_post_service?service=verify', 'settings/underhood/backup' => 'e2://e2s_dump', 'settings/underhood/index' => 'e2://e2s_bsi_step', 'settings/underhood/reindex' => 'e2://e2s_reindex', 'settings/database' => 'e2://e2m_database', 'settings/password' => 'e2://e2m_password?recovery-key=', 'settings/password-reset' => 'e2://e2m_password_reset', 'settings/password/:reset' => 'e2://e2m_password', 'settings/timezone' => 'e2://e2m_timezone', 'settings/sessions' => 'e2://e2m_sessions', 'settings/theme-preview' => 'e2://e2m_theme_preview?theme=', 'settings/theme-preview/:theme' => 'e2://e2m_theme_preview', 'settings/get-backup' => 'e2://e2m_get_backup', 'sign-in' => 'e2://e2m_sign_in', 'sign-out' => 'e2://e2m_sign_out', 'sign-in/:provider' => 'e2://e2m_gip_sign_in', 'sign-out/:provider' => 'e2://e2m_gip_sign_out', 'sign-in-done/:provider' => 'e2://e2m_gip_sign_in_callback', '@ajax/::' => 'e2://e2j_::', '@actions/::' => 'e2://e2s_::', ]; $_url_chunks = [ '\:page' => 'page\-(?P<page>\d+)', '\:year' => '(?P<year>\d{4})', '\:month' => '(?P<month>\d{1,2})', '\:day' => '(?P<day>\d{1,2})', '\:note' => [ 'all\/(?P<alias>[-a-zA-Z0-9]+)', '(?P<year>\d{4})\/(?P<month>\d{1,2})\/(?P<day>\d{1,2})\/(?P<day_number>\d+)', ], '\:draft' => [ '(?P<oalias2>[-a-zA-Z0-9]+)\/(?P<draft2>\d+)', '(?P<oalias>[-a-zA-Z0-9]+)', '-\/(?P<draft>\d+)', ], '\:comnum' => 'comment\-(?P<comment_number>[0-9]+)', '\:file' => '(?P<file>.*?)', '\:tag' => '(?P<tag_alias>[-a-zA-Z0-9,]+)', '\:query' => '(?P<query>.*?)', '\:provider' => '(?P<provider>.*?)', '\:version' => '\:(?P<version>\d+)', '\:source' => '\:(?P<source>.*?)', '\:picture' => '\:(?P<picture>.*?)', '\:unsubscr' => 'unsubscribe\:(?P<unsubscribe_email>.+?)\:(?P<unsubscribe_key>[0-9a-f]{32})', '\:reset' => 'reset\:(?P<recovery_key>[0-9a-f]{40})', '\:formatter' => '(?P<formatter>.*?)', '\:alias' => '(?P<newalias>[-a-zA-Z0-9]+)', '\:preview' => 'preview\:(?P<preview_key>[0-9a-f]{32})', '\:theme' => '(?P<theme>[-a-zA-Z0-9]+)', '\:source' => '(?P<source>\d+)', '\:url' => '\:(?P<url>[a-zA-Z0-9\=\/\\\+\-\_\,]+)', ]; $_url_autoredirects = [ '/^favo(?:u?)rites(\~.+)?$/i' => 'selected\\1', '/^favo(?:u?)rites\/(.+)/i' => 'selected/\\1', '/^keywords$/i' => 'tags', '/^keywords\/(.*)/i' => 'tags/\\1', '/^everything$/i' => 'all', '/^search\/(.+)/i' => 'found/\\1', '/^(\d{4}\/\d{1,2}\/\d{1,2}\/\d+)\/comments(\/?)$/i' => '\\1', '/^\~(\d+)/i' => 'page-\\1', '/\/?\~(\d+)/i' => '/page-\\1', ]; function sq ($url){ global$_url_autoredirects; $url = preg_replace (array_keys ($_url_autoredirects),array_values ($_url_autoredirects),$url); if(preg_match ('/^([0-9]+)[.-]([0-9]+)[.-]([0-9]+)(.*)/',$url,$fe)) { if(2 == strlen ($fe[3]))$fe[3]='20'.$fe[3]; return ($fe[3].'/'.$fe[2].'/'.$fe[1].$fe[4]); } if(preg_match ('/^tags\-rss\/(.*?)\/?$/',$url,$fe)) { $hv = substr ($fe[1],strrpos ($fe[1],'/')+1); return ('tags/'. $hv . '/rss/'); } return$url; } function aq () { static $mmv = false; global$__synthetic_urls,$_config; if ($mmv) return; $fmv = $_config['url_composition']; $__synthetic_urls = false; if ($fmv == 'synthetic'){ $__synthetic_urls = true; } if ($fmv == 'auto'){ if(function_exists ('apache_get_modules')) { if(in_array ('mod_rewrite',apache_get_modules ())) { $__synthetic_urls = true; } } } $mmv = true; } function qq ($candy,$parameters = []) { global$_url_map,$_url_chunks,$__synthetic_urls; $dmv = array_flip ($_url_map); $url = AeEnv::$o; $smv = 'e2://'. $candy; if(array_key_exists ('page',$parameters)) { $parameters['page'] = (int)$parameters['page']; } if(array_key_exists ('day',$parameters)) { $parameters['day']=str_pad ((int)$parameters['day'],2,'0',STR_PAD_LEFT); } if(array_key_exists ('month',$parameters)) { $parameters['month']=str_pad ((int)$parameters['month'],2,'0',STR_PAD_LEFT); } if($parameters){ $smv .= '?'; $amv = []; $qmv = []; foreach($parameters as $cn => $cv){ if ($cn == '*note'){ $qmv[] = $cn; $amv[] = kq ($cv); } if ($cn == '*tags'){ $qmv[] = $cn; $amv[] = xq ($cv); } if ($cn == '*tag'){ $qmv[] = $cn; $amv[] = xq ([$cv]); } } foreach ($qmv as $cn) unset($parameters[$cn]); foreach ($amv as $lmv){ $parameters = array_merge ($parameters,$lmv); } foreach($parameters as $cn => $cv){ if (@$cn[0]!='_'){ $smv .= $cn . ($cv? ('='. urlencode ($cv)) : '') .'&'; } } $smv = substr ($smv,0, -1); } if(array_key_exists ($smv,$dmv)) { if ($dmv[$smv]!==''){ $url .= $dmv[$smv]; if (!in_array (substr ($dmv[$smv], -4), ['.txt','.xml'])) { $url .= '/'; } } return$url; } else { $xmv = false; foreach ($dmv as $emv => $rmv){ $tmv = $emv; $tmv = preg_quote ($tmv,'/'); $jmv = parse_url ($emv); $hmv = $jmv['host']; $gmv = parse_url ($smv); if(strstr ($emv,'::')) { $wmv = $gmv['scheme'] .'://'. $gmv['host']; $tmv = str_replace ('\:\:','(.*)',$tmv); $tmv = '/^'. $tmv .'$/s'; if(preg_match ($tmv,$wmv,$fe)) { $pyv = str_replace ('::',$fe[1],$rmv); $pyv = str_replace ('_','-',$pyv); $z2 = false; if(array_key_exists ('query',$gmv)) { $z2 = $gmv['query']; } if($__synthetic_urls and $z2){ $url .= $pyv .'/?'. $z2; } elseif($__synthetic_urls){ $url .= $pyv .'/'; } elseif ($z2){ $url .= '?go='. $pyv .'/?'. $z2; } else { $url .= '?go='. $pyv .'/'; } return$url; } } $umv = false; if($candy === $hmv){ $xmv = true; if ((string) @$jmv['query']!==''){ $imv = explode ('&',$jmv['query']); foreach ($imv as $omv){ list ($cn,$cv)=explode ('=',$omv); $cv = urldecode ($cv); $cn = str_replace ('_','-',$cn); if ( array_key_exists ($cn,$parameters) and $parameters[$cn]!=$cv ) { $umv = true; break; } } } if (!$umv){ if(preg_match_all ('/\:[\-a-z]+/i',$rmv,$fe)) { foreach ($fe[0] as $pmv){ $cfv = $_url_chunks['\\'. $pmv]; if (!is_array ($cfv)) { $cfv = [$cfv]; } $vfv = $cfv[0]; foreach ($cfv as $vfv){ $bfv = '/\(\?P\<(.*?)\>.*?\)/'; $yfv = true; if (@preg_match_all ($bfv,$vfv,$fe)) { $fe = $fe[1]; $yfv = true; for ($rb = 0; $rb < count ($fe); ++ $rb){ if ( !array_key_exists (str_replace ("_","-",$fe[$rb]), $parameters) or $parameters[str_replace ("_","-",$fe[$rb])] === '' ) { $yfv = false; break; } } } if (!$yfv) continue; $nfv = @preg_replace_callback ( $bfv, function ($fe) use ($parameters){ return$parameters[str_replace ("_","-",$fe[1])]; }, $vfv ); $nfv = stripslashes ($nfv); $mfv = str_replace ($pmv,$nfv,$rmv); break; } $rmv = @$mfv; } } $ffv = []; if ($rmv){ if($__synthetic_urls){ $url .= $rmv .'/'; } else { $ffv[] = 'go='. $rmv .'/'; } } foreach($_GET as $s3 => $a3){ if(in_array ($s3, [ 'raw', 'result', 'url', 'entity', 'entity-id', 'overwrite', ], true)) { $ffv[] = $s3 . ($a3? ('='. urlencode ($a3)) : ''); } } if(count ($ffv)) { $url .= '?'. implode ('&',$ffv); } return$url; } } } if ($xmv){ return$url; } else { die ('Cannot compose url for candy '. $candy); } } } function lq ($url = null){ global$_url_map,$_url_chunks,$_current_url; if(Log::$a)__log ('Resolve request "'. $url .'" {'); aq (); $url = trim ($url,'/'); $url = sq ($url); $parameters = []; $smv = ''; foreach($_url_map as $dfv => $emv){ $sfv = $dfv; $sfv = preg_quote ($sfv,'/'); if(strstr ($dfv,'::')) { $sfv = str_replace ('\:\:','(.*)',$sfv); $sfv = '/^'. $sfv .'$/s'; if(preg_match ($sfv,$url,$fe)) { $afv = str_replace ('-','_',$fe[1]); $smv = str_replace ('::',$afv,$emv); } } elseif(strstr ($dfv,':')) { $qfv = []; foreach($_url_chunks as $s3 => $a3){ if(is_array ($a3)) { $qfv[$s3]='(?:(?:'. implode (')|(?:',$a3) .'))'; } else { $qfv[$s3]=$a3; } } $sfv = str_replace ( array_keys ($qfv), array_values ($qfv), $sfv ); $sfv = '/^'. $sfv .'$/s'; if(preg_match ($sfv,$url,$fe)) { $smv = $emv; foreach ($fe as $cn => $cv) if (!is_numeric ($cn)) { $cn = str_replace ('_','-',$cn); $parameters[$cn]=$cv; } } } else { if ($dfv == $url){ $smv = $emv; break; } } } if ($smv){ $lfv = true; } else { $lfv = false; $smv = 'e2://e2m_error404'; } if (!$smv)$smv = 'e2://e2m_error404'; $gmv = parse_url ($smv); $candy = $gmv['host']; if ((string) @$gmv['query']!==''){ $imv = explode ('&',$gmv['query']); foreach ($imv as $omv){ list ($cn,$cv)=explode ('=',$omv); $cv = urldecode ($cv); $cn = str_replace ('_','-',$cn); $parameters[$cn]=$cv; } } foreach($_GET as $cn => $cv){ if(in_array ($cn, [ 'raw', 'result', 'url', 'entity', 'entity-id', 'overwrite', ], true)) { $parameters[$cn] = (string)$cv; } } $cb = false; if ($lfv){ $_current_url = AeEnv::$h .'://'. AeEnv::$j . $_SERVER['REQUEST_URI']; rq ($candy,$parameters); if(is_callable ($candy)) { $cb = [$candy,$parameters]; } else { $cb = [null, []]; } } else { $cb = [null, []]; } if(Log::$a){ $zfv = ''; if(count ($cb[1]) > 0){ $zfv = print_r ($cb[1],true); $zfv = substr ($zfv,8, -2); $zfv = '    '. trim ($zfv); $zfv = preg_replace ('/^.*?$/smu','           $0',$zfv); $zfv = ' with parameters:'."\r\n". $zfv; } __log ( 'Resolved to candy "'. $cb[0] .'"'. $zfv ); } if(Log::$a)__log ('}'); return $cb; } function kq ($ay){ if (!isset ($ay['IsPublished'])) { throw new LogicException ('Cannot compose parameters from noterec without IsPublished'); return []; } if (!$ay['IsPublished']) { $parameters['is-published']=0; if ($ay['OriginalAlias']===''){ $parameters['draft']=$ay['ID']; } elseif (tb ($ay['OriginalAlias']) == 1){ $parameters['oalias']=$ay['OriginalAlias']; } else { $parameters['draft2']=$ay['ID']; $parameters['oalias2']=$ay['OriginalAlias']; } return$parameters; } $parameters['is-published']=1; $ny = b (); $fy = 'n'. $ay['ID']; $kfv = $ny[$fy]; if (isset ($ay['__force_ymdn']) and ((string)$ay['OriginalAlias']==='')) { $fy = 'n'. $ay['ID'] .'-ymdn'; if(array_key_exists ($fy,$ny)) { $kfv = $ny[$fy]; } } if(preg_match ( '/(?P<year>\d{4})\/(?P<month>\d{1,2})\/(?P<day>\d{1,2})\/(?P<day_number>\d+)/', $kfv,$fe )) { $parameters['year']=$fe['year']; $parameters['month']=$fe['month']; $parameters['day']=$fe['day']; $parameters['day-number']=$fe['day_number']; } else { $parameters['alias']=$kfv; } return$parameters; } function xq ($xb){ $xfv = $parameters = []; foreach ($xb as $tb){ $xfv[] = b () ['t'. $tb['ID']]; } if(count ($xfv)) { $parameters['tag-alias']=implode (',',$xfv); } return$parameters; } function eq ($parameters){ if ( (string) @$parameters['alias']!=='' or ( (string) @$parameters['year']!=='' and (string) @$parameters['month']!=='' and (string) @$parameters['day']!=='' and (string) @$parameters['day-number']!=='' ) ) { if ($r = e2_published_noterec_with_parameters_($parameters)) { if(Log::$a)__log ('Fetched note '.$r['ID'].' "'. $r['Title'] .'" as *note'); $parameters['*note']=$r; foreach (['alias','year','month','day','day-number'] as $efv){ if(array_key_exists ($efv,$parameters)) { unset($parameters[$efv]); } } } } if ( (string) @$parameters['oalias']!=='' or (string) @$parameters['draft']!=='' or (string) @$parameters['oalias2']!=='' or (string) @$parameters['draft2']!=='' ) { if ($r = e2_noterec_with_parameters_($parameters)) { if(Log::$a)__log ('Fetched note '.$r['ID'].' "'. $r['Title'] .'" as *note'); if ((string) @$parameters['oalias']!==''){ $parameters['alias']=$parameters['oalias']; } elseif ((string) @$parameters['oalias2']!==''){ $parameters['alias']=$parameters['oalias2']; } $parameters['*note']=$r; foreach (['oalias','draft','oalias2','draft2'] as $efv){ if(array_key_exists ($efv,$parameters)) { unset($parameters[$efv]); } } } } if ( (string) @$parameters['tag-alias']!=='' ) { $parameters['*tags']=e2_tagrecs_with_parameters_($parameters); if(Log::$a)__log ('Fetched '. count ($parameters['*tags']) .' tag(s) as *tag(s)'); if(count ($parameters['*tags']) == 1){ $parameters['*tag']=$parameters['*tags'][0]; unset($parameters['*tags']); if(array_key_exists ('tag-alias',$parameters)) { unset($parameters['tag-alias']); } } } return$parameters; } function rq ($candy,$parameters){ global$_config,$_current_url; if (!$_config['force_canonical_urls']) return; if($candy === 'e2m_error404') return; $rfv = qq ($candy,$parameters); if ( $_current_url != $rfv and urldecode ($_current_url)!=$rfv and $_current_url != AeEnv::$h .'://'. AeEnv::$j . AeEnv::$w . '/@notify' ) { if(Log::$a)__log ('Used URL "'. $_current_url .'"'); if(Log::$a)__log ('Redirecting to canonical URL "'. $rfv .'"'); s1 ($rfv); } } function tq ($tfv){ global$_instance_config; $pnv = str_replace ('/','--',$tfv); if(substr ($pnv,0,4)=='www.'){ $pnv = substr ($pnv,4); } if(array_key_exists ($pnv,$_instance_config['path_user_rewrites'])) { $pnv = $_instance_config['path_user_rewrites'][$pnv]; } return $pnv; } function jq () { static $jfv = null; if ($jfv !== null) return $jfv; $hfv = AeEnv::$server . AeEnv::$w; if(AeEnv::$u !== (string)''){ $hfv .= '/'. AeEnv::$u; } $jfv = tq ($hfv); return $jfv; } function hq ($oo,$gfv){ $wfv = $gfv; $wfv = preg_quote ($wfv); $wfv = str_replace ('/','\/',$wfv); $wfv = str_replace ('%USERKEY%','(.*?)',$wfv); $wfv = '/'. $wfv . '/i'; $pnv = ''; if(preg_match ($wfv,$oo,$fe) and array_key_exists (1,$fe)) { $pnv = $fe[1]; } return $pnv; } function gq ($ufv,$pnv){ foreach (['path_user','path_media'] as $ifv){ if (!array_key_exists ($ifv .'.raw', $ufv)) { $ufv[$ifv .'.raw']=$ufv[$ifv]; } if(strpos ($ufv[$ifv .'.raw'],'%USERKEY%')!==false){ $ufv[$ifv]=str_replace ( '%USERKEY%', $pnv, $ufv[$ifv .'.raw'] ); } } return $ufv; } function wq ($ofv,$pnv){ foreach (['path_user','path_media'] as $ifv){ if (!array_key_exists ($ifv .'.raw',$ofv)) { $ofv[$ifv .'.raw']=$ofv[$ifv]; } if(strpos ($ofv[$ifv .'.raw'],'%USERKEY%')!==false){ $ofv[$ifv]=str_replace ( '%USERKEY%', $pnv, $ofv[$ifv .'.raw'] ); } } $_config = $ofv; if(is_file ($yx = $ofv['path_user'] .'config.php')) { include $yx; $_config += $ofv; } return$_config; } function uq () { global$_instance_config; if(strpos ($_instance_config['path_user'],'%USERKEY%')!==false){ $pfv = str_replace ( '%USERKEY%', '*', $_instance_config['path_user'] ); return glob ($pfv); } else { return [$_instance_config['path_user']]; } } function iq () { static $databaseConfiguration = null; global$settings,$_config; if($databaseConfiguration === null){ $databaseConfiguration = oq ($_config,$settings); } return$databaseConfiguration; } function oq ($cmv,$po){ $up = null; $c2v = null; if(getenv ('E2_DB_SERVER'))$up['server']=getenv ('E2_DB_SERVER'); if(getenv ('E2_DB_USER_NAME'))$up['user_name']=getenv ('E2_DB_USER_NAME'); if(getenv ('E2_DB_PASSW'))$up['passw']=getenv ('E2_DB_PASSW'); if(getenv ('E2_DB_NAME'))$up['name']=getenv ('E2_DB_NAME'); if ($up !== null){ $c2v = 'environment'; if(Log::$a)__log ('Database configuration found in Environment, won’t look elsewhere'); } else { if(Log::$a)__log ('No database configuration found in Environment'); $up = $cmv['db']; if ($up !== null){ $c2v = 'config'; if(Log::$a)__log ('Database configuration found in Config, won’t look elsewhere'); } else { if(Log::$a)__log ('No database configuration found in Config'); if(array_key_exists ('db',$po)) { $c2v = 'settings'; if(Log::$a)__log ('Database configuration found in Settings'); $up = $po['db']; } else { if(Log::$a)__log ('No database configuration found anywhere'); } } } if ($up === null) return null; $databaseConfiguration = new AeDatabaseConfiguration ( $c2v, $cmv['path_user'].BACKUP_DIRNAME, $up['server'], $up['user_name'], $up['passw'], $up['name'], $cmv['db_table_prefix'], $cmv['db_table_subset'] ); return$databaseConfiguration; } function pq ($v2v,$b2v = false){ $y2v = ''; $nz = strlen ($v2v); for ($rb = 0; $rb < 256; ++ $rb){ $n2v[$rb]=0; $m2v = $rb; while ($m2v & 0x00000080){ $m2v <<= 1; ++ $n2v[$rb]; } } for ($rb = 0xd090; $rb <= 0xd0bf; $rb++)$f2v[$rb]=chr (($rb & 0x000000ff)+48); for ($rb = 0xd180; $rb <= 0xd18f; $rb++)$f2v[$rb]=chr (($rb & 0x000000ff)+112); $f2v[0xd081]="\xa8"; $f2v[0xd191]="\xb8"; $f2v[0xc299]="\x99"; $f2v[0xc2a9]="\xa9"; $f2v[0xc2ae]="\xae"; $f2v[0xc2ab]="\xab"; $f2v[0xc2bb]="\xbb"; $f2v[0xc2a0]="\xa0"; $rb = 0; while ($rb < $nz){ $d2v = $v2v[$rb]; $s2v = ord ($d2v); if ($n2v[$s2v]==0){ $y2v .= $d2v; ++ $rb; } elseif ($n2v[$s2v]==2){ $a2v = $f2v[($s2v << 8) | ord ($v2v[$rb+1])]; $y2v .= ($a2v != null)? $a2v : ( $b2v? (e2utf8__unformat_htmlentity ( cl (substr ($v2v,$rb,2)) )) : '?' ); $rb += 2; } else { $q2v = substr ($v2v,$rb,$n2v[$s2v]); if ($q2v == "\xe2\x84\x96")$y2v .= "\xb9"; elseif ($q2v == "\xe2\x80\x93")$y2v .= "\x96"; elseif ($q2v == "\xe2\x80\x94")$y2v .= "\x97"; elseif ($q2v == "\xe2\x80\x98")$y2v .= "\x91"; elseif ($q2v == "\xe2\x80\x99")$y2v .= "\x92"; elseif ($q2v == "\xe2\x80\x9a")$y2v .= "\x82"; elseif ($q2v == "\xe2\x80\x9c")$y2v .= "\x93"; elseif ($q2v == "\xe2\x80\x9d")$y2v .= "\x94"; elseif ($q2v == "\xe2\x80\x9e")$y2v .= "\x84"; elseif ($q2v == "\xe2\x80\xa6")$y2v .= "\x85"; elseif ($q2v == "\xe2\x80\xb9")$y2v .= "\x8b"; elseif ($q2v == "\xe2\x80\xba")$y2v .= "\x9b"; elseif ($q2v == "\xe2\x82\xac")$y2v .= "\x88"; elseif ($q2v == "\xe2\x84\xa2")$y2v .= "\x99"; else $y2v .= $b2v? (e2utf8__unformat_htmlentity ( cl ($q2v) )) : '?'; $rb += $n2v[$s2v]; } } return $y2v; } function cl ($ycv){ $l2v = ''; $nz = strlen ($ycv); for ($rb = 0; $rb < $nz; ++ $rb){ $l2v .= preg_replace ('/^1*0/','',decbin (ord ($ycv[$rb]))); } return '&#'. bindec ($l2v) .';'; } if (!BUILT) include 'builder.php'; if(version_compare (PHP_VERSION,E2_MINIMUM_PHP)<0){ die ('PHP version must be '. E2_MINIMUM_PHP .' or later, you are running '. PHP_VERSION); } if (!function_exists ('getimagesize')) { die ('Function getimagesize is not defined, php_gd not installed?'); } if (!function_exists ('mb_internal_encoding')) { die ('Function mb_internal_encoding is not defined, php_mbstring not installed?'); } if (!class_exists ('PDO')) { die ('Class PDO is not defined installed, PDO not installed?'); } if (!in_array ('mysql',PDO::getAvailableDrivers ())) { die ('Required PDO driver "mysql" not installed'); } if (!is_file ($yx = 'system/default/config.php')) { die ('File not found: '. $yx); } error_reporting (E_ALL); setlocale (LC_CTYPE,'ru_RU.UTF'); mb_internal_encoding ('UTF-8'); date_default_timezone_set ('GMT'); mysqli_report (MYSQLI_REPORT_OFF); if(version_compare (PHP_VERSION,'7.0')<0){ error_reporting (E_ALL & ~E_STRICT); } ini_set ('pcre.jit','0'); include $yx; $_system_default_config = $_config; foreach (['instance/',$_config['path_user']] as $z2v){ if(is_dir ($k2v = $z2v)) { if(is_file ($yx = $k2v .'config.php')) { include $yx; $_config += $_system_default_config; } break; } } $_instance_config = $_config; define ('INSTANCE_DIR',$k2v); AeEnv::examine ($_SERVER); $_config = wq ($_instance_config,jq ()); if (!is_dir ($_config['path_user'])) { die ('User directory not found: '. $_config['path_user']); } define ('USER_DIR',$_config['path_user']); define ('USER_URLPATH','user/'); AeEnv::setPrefersHTTPS ($_config['force_https']); AeEnv::setPreferredServer ($_config['preferred_domain_name']); AeFileManager::setInstancePath (INSTANCE_DIR); AeFileManager::setUserPath ($_config['path_user']); AeFileManager::setMediaPath ($_config['path_media']); $_stopwatch = yq ($_stopwatch); spl_autoload_register ('kd'); fn_ (); $settings = e2_load_settings_from_user_folder_(USER_DIR); $_strings = yn (); $x2v = E2_EDITION . serialize ($_config); $x2v = serialize (md5 ($x2v)); $e2v = $_config['path_user'].'config-hash.psa'; if ($x2v !== (string) @unserialize (file_get_contents ($e2v))) { if(Log::$a)__log ('Edition or configuration changed, dropping all caches'); e2_drop_all_kinds_of_cache (); if (!@e3 ($e2v,serialize ($x2v))) { die ('Cannot write file: '. $e2v); } } function e2 () { global$settings,$content, $_candy, $_lang, $_config, $_strings, $_template; if(Log::$a)__log ( 'Serving the user with key "'. jq () .'" '. 'using directory "'. $_config['path_user'] .'"' ); w1 (); set_error_handler ('wb'); set_exception_handler ('y3'); $r2v = new AeRequest ($_SERVER,$_GET); $content = []; $_candy = $r2v->candy; $zx = cn (); $t2v = true; $j2v = true; $tn = cs (); if ( $r2v -> requiresInstallation () and ( $zx === null or iq () === null or !od () ) ) { $t2v = false; if (!$_config['allow_installer'] or !$_config['allow_db_config']) { $content = us ('not-configured'); } elseif(count ( $vq = AeFileManager::getPathsWithNoWritePermissions ( $_config['path_user'],$_config['path_media'] ) ) > 0){ $content = us ('generic', [ 'heading' => $_strings['pt--fix-permissions'], 'text' => ( '<p>'. $_strings['gs--fix-permissions'] .'</p>'. gb (array_unique ($vq)) ), 'button' => $_strings['fb--retry'], ]); } else { $r2v -> replaceWith ('e2m_install'); } } if ( empty ($content) and $r2v -> requiresVersionMatch () and E2_VERSION !== $zx['version'] ) { $j2v = false; if(Log::$a)__log ('Startup: need to update first'); $h2v = nq ($zx['version']); if ($h2v['status']==='success'){ $zx = $h2v['instance']; if (cs ()) { hb (e2l_get_string ('gs--updated-successfully', [ 'from' => $h2v['from-release'], 'to' => $h2v['to-release'], ]), E2E_MESSAGE); } $j2v = true; } else { $content = $h2v['stub']; } } if ( empty ($content) and $r2v -> requiresSignIn () ) { if(Log::$a)__log ('Author signed in? '. ($tn? 'Yes' : 'No')); if (!$tn){ $r2v -> replaceWith ('e2m_sign_in'); if ($r2v -> toBeFulfilledByService ()) { s1 (qq ('e2m_sign_in')); } } } if ( empty ($content) and !$r2v -> allowedInReadOnlyMode () and $_config['read_only'] ) { $content = us ('read-only-mode'); $t2v = false; } header ('X-Powered-By: '. E2_UA_STRING); header ('Content-type: text/html; charset=UTF-8'); if (empty ($content)) { if (!is_callable ($r2v->candy)) { $r2v -> replaceWith ('e2m_error404'); } if(Log::$a)__log ('Candy after clearance: '. $r2v->candy); if ($r2v -> shouldSlowDownAJAXResponse () and $_config['dev_slow_ajax']) { sleep (1 + 2 * (rand () / getrandmax ())); } try { if ($r2v -> requiresInstallation ()) { $r2v->parameters = eq ($r2v->parameters); if(Log::$a)__log ('Call e2_force_canonical_url for the second time:'); rq ($r2v->candy,$r2v->parameters); if ( array_key_exists ('is-published',$r2v->parameters) and $r2v->parameters['is-published']=='0' and $r2v->parameters['*note']['IsPublished']=='1' ) { s1 (qq ($r2v->candy,$r2v->parameters)); } } if(Log::$a)__log ('Candy call {'); $content = call_user_func ($r2v->candy,$r2v->parameters); } catch (AeMySQLException $e){ if (!$r2v->toBeFulfilledByService ()) { v3 ($e); $r2v->parameters = []; $content['unavailable?']=true; } else { throw $e; } } if(Log::$a)__log ('}'); } if (!is_array ($content))$content = []; if (!array_key_exists ('notes',$content))$content['notes'] = []; if (!array_key_exists ('tag',$content))$content['tag'] = []; if (!array_key_exists ('drafts',$content))$content['drafts'] = []; if (!array_key_exists ('comments',$content))$content['comments'] = []; if (!array_key_exists ('notes-list',$content))$content['notes-list'] = []; $content['title']=strip_tags (dy (htmlspecialchars ($content['title'],ENT_NOQUOTES,'UTF-8'))); if (!empty ($content['heading'])) { $content['heading']=strip_tags (dy (htmlspecialchars ($content['heading'],ENT_NOQUOTES,'UTF-8'))); } $content['language']=$_lang; if (!isset ($_template))qf (); $content['template']['respond-to-dark-mode?'] = ( $_template['supports_dark_mode'] and @(bool)$settings['appearance']['respond_to_dark_mode'] ); $content['template']['use-likely-light?']=$_template['use_likely_light']; if (!array_key_exists ('class',$content)) { $content['class']=str_replace ('_','-',str_replace ('e2m_','',$r2v->candy)); } if ($t2v and $j2v){ if(Log::$a)__log ('Stuff for installed engine {'); d3 ('rss',ev (), qq ('e2m_rss')); d3 ('json',ev (), qq ('e2m_json')); $content['sign-in'] = [ 'done?' => (bool)$tn, 'required?' => (bool)$r2v->requiresSignIn (), 'necessary?' => (bool)$r2v->requiresSignIn () && !$tn, 'href' => qq ('e2m_sign_in'), 'prompt' => $_strings['gs--need-password'], 'token' => hd (), ]; $content['hrefs'] = array ( 'everything' => qq ('e2m_everything'), ); if (!array_key_exists ('tags',$content)) $content['tags']=na ($r2v->parameters); if (!array_key_exists ('main-menu',$content)) $content['main-menu']=kn ($r2v->parameters,$content['class']); $content['blog']=xv (); $content['form-search']=fd ($r2v->parameters); $content['engine']=jb (); $content['form-login']=ls (); if($content['form-login']===null) unset($content['form-login']); if (!array_key_exists ('summary',$content)) { if (!empty ($settings['meta_description'])) { $content['summary']=strip_tags (dy (htmlspecialchars ($settings['meta_description'],ENT_NOQUOTES,'UTF-8'))); } else { $content['summary'] = @trim (strip_tags ($content['blog']['subtitle'])); } } if (@$settings['appearance']['show_view_counts']) { AeNoteReadCountsProvider :: setSQLRequestTemplateToMapIDsToReadCounts ( "SELECT `ID`, `ReadCount` ". "FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `SubsetID`=". $_config['db_table_subset'] ); } foreach($content['notes'] as $r){ b2 (@$r['format-info']['links-required']); } if ($tn){ $content['admin']=c (); $content['last-modifieds-by-id']='{}'; if (@$_COOKIE[q1 ('local_copies')]) { $content['last-modifieds-by-id'] = ( gm ($_COOKIE[q1 ('local_copies')]) ); } $g2v = zs (); } if(Log::$a)__log ('}'); } $content['message']=ib (); $qw = tf (); $content['meta']=rn ( $r2v->candy, $content['notes'], $content['tag'], $content['blog'], $content['pages'] ); $content['stat']=jv (); $qw = xf ($qw); echo $qw; if ($t2v and $j2v and $_SERVER['HTTP_USER_AGENT']!==E2_UA_STRING){ if (!qd ()) { if(Log::$a)__log ('Spawn BSI step'); vv (qq ('e2s_bsi_step')); } if (!$g2v){ ks (); } } if (@$_config['dev_dump_ctree'])sn ($content); } ?>